<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Catalyst Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e17;
    --bg-card: #111827;
    --bg-card-hover: #1a2332;
    --border: #1e293b;
    --border-focus: #3b82f6;
    --text-primary: #e2e8f0;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --accent: #3b82f6;
    --accent-glow: rgba(59, 130, 246, 0.15);
    --green: #22c55e;
    --green-bg: rgba(34, 197, 94, 0.1);
    --red: #ef4444;
    --red-bg: rgba(239, 68, 68, 0.1);
    --orange: #f59e0b;
    --orange-bg: rgba(245, 158, 11, 0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: 'Outfit', sans-serif;
    min-height: 100vh;
    padding: 40px 20px;
  }

  .container { max-width: 1200px; margin: 0 auto; }
  header { text-align: center; margin-bottom: 48px; }

  header h1 {
    font-size: 2.4rem;
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(135deg, #e2e8f0 0%, #3b82f6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
  }

  header p { color: var(--text-muted); font-size: 1rem; font-weight: 300; }

  .input-row { display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap; align-items: flex-end; }
  .input-group { display: flex; flex-direction: column; gap: 6px; }

  .input-group label {
    font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
    color: var(--text-muted); font-weight: 600;
  }

  input, select {
    background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary);
    padding: 12px 16px; border-radius: 10px; font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem; transition: border-color 0.2s; outline: none;
  }

  input:focus, select:focus { border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--accent-glow); }
  input::placeholder { color: var(--text-muted); }

  #tickerInput { width: 260px; text-transform: uppercase; }
  #apiKeyInput { width: 260px; }
  #thresholdInput { width: 90px; }
  #fromDate, #toDate { width: 148px; }
  #lookbackSelect { width: 115px; }

  .ticker-hint { font-size: 0.7rem; color: var(--text-muted); }

  .scan-btn {
    background: var(--accent); color: #fff; border: none; padding: 12px 32px;
    border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 1rem;
    font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; height: 46px;
  }
  .scan-btn:hover { background: #2563eb; transform: translateY(-1px); }
  .scan-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* Progress */
  .progress-bar { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 18px 24px; margin-bottom: 24px; }
  .progress-bar .pb-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px; }
  .progress-bar .pb-track { background: var(--border); border-radius: 6px; height: 8px; overflow: hidden; }
  .progress-bar .pb-fill { background: linear-gradient(90deg, var(--accent), #06b6d4); height: 100%; border-radius: 6px; transition: width 0.3s; }

  /* Comparison table */
  .comp-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; margin-bottom: 28px; }
  .comp-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px 16px; border-bottom: 1px solid var(--border); }
  .comp-header h2 { font-size: 1.15rem; font-weight: 700; }
  .comp-header .badge { background: var(--accent-glow); color: var(--accent); padding: 4px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }

  .comp-table { width: 100%; border-collapse: collapse; }
  .comp-table thead th { text-align: left; padding: 12px 14px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .comp-table tbody tr { border-bottom: 1px solid rgba(30,41,59,0.5); transition: background 0.15s; }
  .comp-table tbody tr:hover { background: var(--bg-card-hover); }
  .comp-table tbody tr:last-child { border-bottom: none; }
  .comp-table td { padding: 14px 14px; font-size: 0.88rem; }

  .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.86rem; }
  .move-up { color: var(--green); background: var(--green-bg); padding: 3px 10px; border-radius: 6px; font-weight: 600; }
  .move-down { color: var(--red); background: var(--red-bg); padding: 3px 10px; border-radius: 6px; font-weight: 600; }
  .volume-badge { color: var(--orange); background: var(--orange-bg); padding: 3px 10px; border-radius: 6px; font-weight: 600; }

  .best-cell { background: rgba(34, 197, 94, 0.08); }
  .worst-cell { background: rgba(239, 68, 68, 0.08); }

  /* Ticker sections */
  .tk-section { margin-bottom: 28px; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
  .tk-section-hdr { display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; background: var(--bg-card); border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s; }
  .tk-section-hdr:hover { background: var(--bg-card-hover); }
  .tk-section-hdr h2 { font-size: 1.15rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .tk-section-hdr .toggle { font-size: 1.1rem; color: var(--text-muted); transition: transform 0.3s; }
  .tk-section-hdr .toggle.collapsed { transform: rotate(-90deg); }

  .tk-section-body { background: var(--bg-primary); overflow: hidden; transition: max-height 0.4s ease; }
  .tk-section-body.collapsed { max-height: 0 !important; }
  .tk-body-inner { padding: 24px; }

  /* Range stats */
  .range-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(152px, 1fr)); gap: 14px; margin-bottom: 20px; }
  .range-item { display: flex; flex-direction: column; gap: 2px; }
  .range-item .ri-lbl { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; }
  .range-item .ri-val { font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 600; }
  .range-item .ri-sub { font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

  /* Outlier stat cards */
  .o-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 14px; margin-bottom: 20px; }
  .o-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; text-align: center; }
  .o-card .o-v { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; margin-bottom: 2px; }
  .o-card .o-l { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

  /* Chart */
  .chart-wrap { margin-bottom: 20px; }
  .chart-wrap h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary); }

  /* Events table */
  .ev-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .ev-hdr { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; border-bottom: 1px solid var(--border); }
  .ev-hdr h4 { font-size: 0.9rem; font-weight: 600; }
  .ev-hdr .badge { background: var(--accent-glow); color: var(--accent); padding: 3px 10px; border-radius: 16px; font-size: 0.73rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
  .ev-table { width: 100%; border-collapse: collapse; }
  .ev-table thead th { text-align: left; padding: 10px 14px; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); }
  .ev-table tbody tr { border-bottom: 1px solid rgba(30,41,59,0.5); transition: background 0.15s; }
  .ev-table tbody tr:hover { background: var(--bg-card-hover); }
  .ev-table tbody tr:last-child { border-bottom: none; }
  .ev-table td { padding: 11px 14px; font-size: 0.85rem; }
  .news-cell { max-width: 280px; font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; }
  .news-cell a { color: var(--accent); text-decoration: none; }
  .news-cell a:hover { color: #60a5fa; text-decoration: underline; }

  .empty-state { text-align: center; padding: 80px 20px; color: var(--text-muted); }
  .empty-state .icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.4; }
  .error-msg { background: var(--red-bg); border: 1px solid rgba(239,68,68,0.3); color: var(--red); padding: 14px 20px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9rem; }

  /* Ticker color accents */
  .tk-0 { color: #3b82f6; } .tk-1 { color: #a855f7; } .tk-2 { color: #06b6d4; } .tk-3 { color: #f59e0b; }
  .tk-4 { color: #ec4899; } .tk-5 { color: #10b981; } .tk-6 { color: #f97316; } .tk-7 { color: #8b5cf6; }
  .tkb-0 { border-left: 3px solid #3b82f6; } .tkb-1 { border-left: 3px solid #a855f7; }
  .tkb-2 { border-left: 3px solid #06b6d4; } .tkb-3 { border-left: 3px solid #f59e0b; }
  .tkb-4 { border-left: 3px solid #ec4899; } .tkb-5 { border-left: 3px solid #10b981; }
  .tkb-6 { border-left: 3px solid #f97316; } .tkb-7 { border-left: 3px solid #8b5cf6; }

  .footer-note { text-align: center; color: var(--text-muted); font-size: 0.78rem; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }

  /* Export button */
  .deep-btn {
    background: linear-gradient(135deg, #7c3aed, #a855f7);
    color: #fff;
    border: none;
    padding: 12px 28px;
    border-radius: 10px;
    font-family: 'Outfit', sans-serif;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    height: 46px;
  }

  .deep-btn:hover { background: linear-gradient(135deg, #6d28d9, #9333ea); transform: translateY(-1px); }
  .deep-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .deep-btn.copied { background: linear-gradient(135deg, #059669, #10b981); }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #10b981;
    color: #fff;
    padding: 14px 28px;
    border-radius: 10px;
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
    pointer-events: none;
  }

  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Commentary section */
  .commentary {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    margin-bottom: 28px;
    overflow: hidden;
  }

  .commentary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
  }

  .commentary-header h2 {
    font-size: 1.15rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .commentary-body {
    padding: 24px;
  }

  .insight-block {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .insight-block:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .insight-title {
    font-size: 0.95rem;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .insight-title .it-icon {
    font-size: 1.1rem;
  }

  .insight-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.65;
  }

  .insight-text strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  .insight-text .hl-green { color: var(--green); font-weight: 600; }
  .insight-text .hl-red { color: var(--red); font-weight: 600; }
  .insight-text .hl-blue { color: var(--accent); font-weight: 600; }
  .insight-text .hl-orange { color: var(--orange); font-weight: 600; }
  .insight-text .hl-purple { color: #a855f7; font-weight: 600; }

  .insight-callout {
    background: rgba(59, 130, 246, 0.06);
    border-left: 3px solid var(--accent);
    padding: 12px 16px;
    margin-top: 12px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.55;
  }

  .insight-callout.warn {
    background: rgba(239, 68, 68, 0.06);
    border-left-color: var(--red);
  }

  .insight-callout.good {
    background: rgba(34, 197, 94, 0.06);
    border-left-color: var(--green);
  }

  @media (max-width: 768px) {
    .input-row { flex-direction: column; }
    #tickerInput, #apiKeyInput, #thresholdInput, #lookbackSelect, #fromDate, #toDate { width: 100%; }
    .scan-btn { width: 100%; }
    .range-grid, .o-stats { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Stock Catalyst Scanner</h1>
    <p>Compare volatility profiles and find every significant price move</p>
  </header>

  <div class="input-row">
    <div class="input-group">
      <label>Tickers</label>
      <input type="text" id="tickerInput" placeholder="AAPL, TSLA, NVDA" maxlength="60">
      <span class="ticker-hint">Comma-separated for comparison (max 8)</span>
    </div>
    <div class="input-group">
      <label>Polygon API Key</label>
      <input type="password" id="apiKeyInput" placeholder="your-polygon-api-key">
    </div>
    <div class="input-group">
      <label>Threshold</label>
      <select id="thresholdInput">
        <option value="1.5">1.5Ïƒ</option>
        <option value="2" selected>2Ïƒ</option>
        <option value="2.5">2.5Ïƒ</option>
        <option value="3">3Ïƒ</option>
      </select>
    </div>
    <div class="input-group">
      <label>From</label>
      <input type="date" id="fromDate">
    </div>
    <div class="input-group">
      <label>To</label>
      <input type="date" id="toDate">
    </div>
    <div class="input-group">
      <label>Quick</label>
      <select id="lookbackSelect" onchange="setQuickRange()">
        <option value="custom">Custom</option>
        <option value="0.5">2 Weeks</option>
        <option value="1">1 Month</option>
        <option value="3">3 Months</option>
        <option value="6">6 Months</option>
        <option value="12" selected>1 Year</option>
        <option value="24">2 Years</option>
      </select>
    </div>
    <button class="scan-btn" id="scanBtn" onclick="runScan()">Scan</button>
    <button class="deep-btn" id="exportBtn" onclick="exportBrief()" disabled>ðŸ“‹ Export Brief</button>
  </div>

  <div id="errorContainer"></div>
  <div id="progressContainer"></div>
  <div id="comparisonContainer"></div>
  <div id="commentaryContainer"></div>
  <div id="tickerSections"></div>

  <div id="emptyState">
    <div class="empty-state">
      <div class="icon">ðŸ“Š</div>
      <p>Enter one or more tickers and hit Scan<br>Use commas to compare multiple stocks side by side</p>
    </div>
  </div>

  <div class="footer-note">Powered by Polygon.io Â· Moves via Ïƒ of daily returns Â· News matched by date</div>
</div>

<script>
const API = 'https://api.polygon.io';
let lastScanResults = null;
let lastScanMeta = null;

document.addEventListener('DOMContentLoaded', () => {
  const k = localStorage.getItem('polygon_api_key');
  if (k) document.getElementById('apiKeyInput').value = k;
  setQuickRange();
  document.getElementById('tickerInput').addEventListener('keydown', e => { if (e.key === 'Enter') runScan(); });
  document.getElementById('fromDate').addEventListener('change', () => document.getElementById('lookbackSelect').value = 'custom');
  document.getElementById('toDate').addEventListener('change', () => document.getElementById('lookbackSelect').value = 'custom');
});

function setQuickRange() {
  const v = document.getElementById('lookbackSelect').value;
  if (v === 'custom') return;
  const to = new Date(), from = new Date(), m = parseFloat(v);
  if (m < 1) from.setDate(from.getDate() - Math.round(m * 30));
  else from.setMonth(from.getMonth() - m);
  document.getElementById('fromDate').value = from.toISOString().split('T')[0];
  document.getElementById('toDate').value = to.toISOString().split('T')[0];
}

function showError(msg) { document.getElementById('errorContainer').innerHTML = `<div class="error-msg">${msg}</div>`; }
function clearError() { document.getElementById('errorContainer').innerHTML = ''; }

function updateProgress(cur, total, ticker) {
  const pct = Math.round((cur / total) * 100);
  document.getElementById('progressContainer').innerHTML = `
    <div class="progress-bar">
      <div class="pb-label">Scanning <strong>${ticker}</strong> (${cur}/${total})</div>
      <div class="pb-track"><div class="pb-fill" style="width:${pct}%"></div></div>
    </div>`;
}

async function apiFetch(ep, key) {
  const sep = ep.includes('?') ? '&' : '?';
  const r = await fetch(`${API}${ep}${sep}apiKey=${key}`);
  if (!r.ok) throw new Error(`API error ${r.status} for ${ep}`);
  return r.json();
}

async function getBars(ticker, from, to, key) {
  const d = await apiFetch(`/v2/aggs/ticker/${ticker}/range/1/day/${from}/${to}?adjusted=true&sort=asc&limit=5000`, key);
  return d.results || [];
}

async function getNews(ticker, date, key) {
  try {
    const d = new Date(date);
    const a = new Date(d); a.setDate(a.getDate() - 1);
    const b = new Date(d); b.setDate(b.getDate() + 1);
    const r = await apiFetch(`/v2/reference/news?ticker=${ticker}&published_utc.gte=${iso(a)}&published_utc.lte=${iso(b)}&limit=3&sort=published_utc`, key);
    return r.results || [];
  } catch { return []; }
}

function stats(bars) {
  const rets = [];
  for (let i = 1; i < bars.length; i++) rets.push((bars[i].c - bars[i-1].c) / bars[i-1].c);
  const mean = rets.reduce((a,b) => a+b, 0) / rets.length;
  const sd = Math.sqrt(rets.reduce((s,r) => s + (r-mean)**2, 0) / rets.length);
  const avgVol = bars.reduce((s,b) => s+b.v, 0) / bars.length;
  return { rets, mean, sd, avgVol };
}

function outliers(bars, th, mean, sd, avgVol) {
  const out = [];
  for (let i = 1; i < bars.length; i++) {
    const ret = (bars[i].c - bars[i-1].c) / bars[i-1].c;
    const z = Math.abs((ret - mean) / sd);
    if (z >= th) out.push({
      date: bars[i].t, dateStr: fmtD(bars[i].t), dateISO: iso(new Date(bars[i].t)),
      o: bars[i].o, h: bars[i].h, l: bars[i].l, c: bars[i].c,
      pc: bars[i-1].c, ret, z, vol: bars[i].v,
      vr: bars[i].v / avgVol, dir: ret >= 0 ? 'up' : 'down', news: []
    });
  }
  out.sort((a,b) => Math.abs(b.ret) - Math.abs(a.ret));
  return out;
}

function rangeStats(bars, avgVol, sd) {
  const highs = bars.map(b=>b.h), lows = bars.map(b=>b.l);
  const pH = Math.max(...highs), pL = Math.min(...lows);
  const pO = bars[0].o, pC = bars[bars.length-1].c;
  const dr = bars.map(b => b.h - b.l);
  const avgDR = dr.reduce((a,b)=>a+b,0)/dr.length;
  const avgDRpct = bars.map(b=>(b.h-b.l)/b.l).reduce((a,b)=>a+b,0)/bars.length;
  let maxI=0, minI=0;
  dr.forEach((r,i) => { if(r>dr[maxI]) maxI=i; if(r<dr[minI]) minI=i; });
  return {
    pO, pC, pChg: (pC-pO)/pO,
    pH, pL, hDate: bars[highs.indexOf(pH)].t, lDate: bars[lows.indexOf(pL)].t,
    range: pH-pL, rangePct: (pH-pL)/pL,
    avgDR, avgDRpct,
    maxDR: dr[maxI], maxDRpct: (bars[maxI].h-bars[maxI].l)/bars[maxI].l, maxDRdate: bars[maxI].t,
    minDR: dr[minI], minDRpct: (bars[minI].h-bars[minI].l)/bars[minI].l, minDRdate: bars[minI].t,
    sd, avgVol, days: bars.length
  };
}

// Formatters
function fmtD(ts) { return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
function iso(d) { return (d instanceof Date ? d : new Date(d)).toISOString().split('T')[0]; }
function fmtP(v) { return (v>=0?'+':'')+(v*100).toFixed(2)+'%'; }
function fmtV(v) { return v>=1e9?(v/1e9).toFixed(1)+'B':v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v+''; }

async function runScan() {
  clearError();
  const raw = document.getElementById('tickerInput').value.trim().toUpperCase();
  const key = document.getElementById('apiKeyInput').value.trim();
  const th = parseFloat(document.getElementById('thresholdInput').value);
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;

  if (!raw) return showError('Enter at least one ticker.');
  if (!key) return showError('Enter your Polygon API key.');
  if (!from || !to) return showError('Select a date range.');
  if (from >= to) return showError('From date must be before To date.');

  localStorage.setItem('polygon_api_key', key);
  const tickers = [...new Set(raw.split(/[,\s]+/).filter(t=>t))];
  if (tickers.length > 8) return showError('Max 8 tickers.');

  const btn = document.getElementById('scanBtn');
  btn.disabled = true; btn.textContent = 'Scanning...';
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('comparisonContainer').innerHTML = '';
  document.getElementById('commentaryContainer').innerHTML = '';
  document.getElementById('tickerSections').innerHTML = '';

  const results = [];

  try {
    for (let t = 0; t < tickers.length; t++) {
      const tk = tickers[t];
      updateProgress(t+1, tickers.length, tk);

      const bars_data = await getBars(tk, from, to, key);
      if (!bars_data || bars_data.length < 5) { showError(`Skipping ${tk} â€” not enough data.`); continue; }

      const { rets, mean, sd, avgVol } = stats(bars_data);
      const outs = outliers(bars_data, th, mean, sd, avgVol);
      const rs = rangeStats(bars_data, avgVol, sd);

      // Fetch news
      for (let i = 0; i < outs.length; i++) {
        if (i > 0 || t > 0) await new Promise(r => setTimeout(r, 220));
        outs[i].news = await getNews(tk, outs[i].dateISO, key);
      }

      results.push({
        ticker: tk, bars: bars_data, outs, rs,
        up: outs.filter(o=>o.dir==='up').length,
        down: outs.filter(o=>o.dir==='down').length,
        avgMv: outs.length ? outs.reduce((s,o)=>s+Math.abs(o.ret),0)/outs.length : 0,
        estYr: bars_data.length ? (outs.length/bars_data.length*252).toFixed(1) : 'â€”',
        ci: t
      });
    }

    document.getElementById('progressContainer').innerHTML = '';

    if (!results.length) { showError('No data for any ticker.'); return; }

    if (results.length > 1) renderComparison(results, th, from, to);

    results.forEach(r => renderSection(r, th, from, to, results.length > 1));

    renderCommentary(results, th, from, to);

    // Store for export
    lastScanResults = results;
    lastScanMeta = { threshold: th, from, to };
    document.getElementById('exportBtn').disabled = false;

  } catch(e) { showError(e.message); }
  finally { document.getElementById('progressContainer').innerHTML = ''; btn.disabled = false; btn.textContent = 'Scan'; }
}

/* â”€â”€ COMMENTARY ENGINE â”€â”€ */
function renderCommentary(results, th, from, to) {
  const blocks = [];
  const multi = results.length > 1;
  const days = Math.round((new Date(to) - new Date(from)) / (1000*60*60*24));
  const period = days <= 14 ? 'short' : days <= 90 ? 'medium' : 'long';

  if (multi) {
    blocks.push(...generateComparisonInsights(results, th, period, days));
  }

  results.forEach(r => {
    blocks.push(...generateTickerInsights(r, th, period, days, multi));
  });

  if (multi) {
    blocks.push(...generateTradingImplications(results, th, period));
  }

  const html = blocks.map(b => `
    <div class="insight-block">
      <div class="insight-title"><span class="it-icon">${b.icon}</span> ${b.title}</div>
      <div class="insight-text">${b.text}</div>
      ${b.callout ? `<div class="insight-callout ${b.calloutType||''}">${b.callout}</div>` : ''}
    </div>`).join('');

  document.getElementById('commentaryContainer').innerHTML = `
    <div class="commentary">
      <div class="commentary-header">
        <h2>ðŸ§  Analysis & Insights</h2>
      </div>
      <div class="commentary-body">${html}</div>
    </div>`;
}

function generateComparisonInsights(results, th, period, days) {
  const blocks = [];

  // Sort by various metrics
  const byVol = [...results].sort((a,b) => b.rs.sd - a.rs.sd);
  const byOutliers = [...results].sort((a,b) => b.outs.length - a.outs.length);
  const byAvgMove = [...results].sort((a,b) => b.avgMv - a.avgMv);
  const byChange = [...results].sort((a,b) => b.rs.pChg - a.rs.pChg);
  const byRange = [...results].sort((a,b) => b.rs.rangePct - a.rs.rangePct);

  // Volatility ranking
  const volHigh = byVol[0];
  const volLow = byVol[byVol.length - 1];
  const volRatio = (volHigh.rs.sd / volLow.rs.sd).toFixed(1);

  blocks.push({
    icon: 'ðŸ“Š',
    title: 'Volatility Ranking',
    text: `<strong class="hl-blue">${volHigh.ticker}</strong> is the most volatile at <strong>${(volHigh.rs.sd*100).toFixed(2)}%</strong> daily Ïƒ, while <strong class="hl-blue">${volLow.ticker}</strong> is the calmest at <strong>${(volLow.rs.sd*100).toFixed(2)}%</strong>. That's a <strong>${volRatio}x</strong> volatility difference â€” meaning a $10,000 position in ${volHigh.ticker} has ${volRatio}x the daily risk exposure compared to ${volLow.ticker}.`,
    callout: `Volatility ranking (daily 1Ïƒ): ${byVol.map(r => `${r.ticker} ${(r.rs.sd*100).toFixed(2)}%`).join(' â†’ ')}`,
  });

  // Catalyst frequency comparison
  const mostEvents = byOutliers[0];
  const fewestEvents = byOutliers[byOutliers.length - 1];
  const mostFreq = parseFloat(mostEvents.estYr);
  const mostInterval = mostFreq > 0 ? Math.round(252 / mostFreq) : null;
  const fewestFreq = parseFloat(fewestEvents.estYr);
  const fewestInterval = fewestFreq > 0 ? Math.round(252 / fewestFreq) : null;

  let freqText = `<strong class="hl-blue">${mostEvents.ticker}</strong> sees the most significant moves with <strong>${mostEvents.outs.length}</strong> outlier days (~<strong>${mostEvents.estYr}/year</strong>)`;
  if (mostInterval) freqText += ` â€” that's roughly one every <strong class="hl-orange">${mostInterval} trading days</strong>`;
  freqText += `. <strong class="hl-blue">${fewestEvents.ticker}</strong> had the fewest at <strong>${fewestEvents.outs.length}</strong>`;
  if (fewestInterval) freqText += ` (once every ~${fewestInterval} days)`;
  freqText += `.`;

  blocks.push({
    icon: 'âš¡',
    title: 'Catalyst Frequency',
    text: freqText,
  });

  // Directional bias comparison
  const biasInsights = results.map(r => {
    const total = r.outs.length;
    if (total === 0) return null;
    const upPct = ((r.up / total) * 100).toFixed(0);
    const downPct = ((r.down / total) * 100).toFixed(0);
    const bias = r.up > r.down ? 'bullish' : r.down > r.up ? 'bearish' : 'neutral';
    const biasColor = bias === 'bullish' ? 'hl-green' : bias === 'bearish' ? 'hl-red' : 'hl-blue';
    return { ticker: r.ticker, bias, biasColor, up: r.up, down: r.down, upPct, downPct, total };
  }).filter(Boolean);

  if (biasInsights.length) {
    const biasText = biasInsights.map(b => {
      const skew = Math.abs(b.up - b.down);
      let desc = `<strong class="hl-blue">${b.ticker}</strong>: <span class="${b.biasColor}">${b.bias}</span> bias â€” ${b.up} up vs ${b.down} down (${b.upPct}/${b.downPct} split)`;
      if (skew >= 5) desc += ` â€” <strong>strong ${b.bias} skew</strong>`;
      return desc;
    }).join('. ');

    blocks.push({
      icon: 'ðŸŽ¯',
      title: 'Directional Bias',
      text: biasText + '.',
      callout: biasInsights.some(b => Math.abs(b.up - b.down) >= 5)
        ? 'A strong directional skew on outlier days can indicate persistent sentiment â€” watch for earnings patterns or sector trends driving the imbalance.'
        : null,
      calloutType: ''
    });
  }

  // Performance spread
  const best = byChange[0];
  const worst = byChange[byChange.length - 1];
  const spread = ((best.rs.pChg - worst.rs.pChg) * 100).toFixed(1);

  blocks.push({
    icon: 'ðŸ“ˆ',
    title: 'Performance Spread',
    text: `Biggest divergence: <strong class="hl-green">${best.ticker}</strong> returned <strong>${fmtP(best.rs.pChg)}</strong> while <strong class="hl-red">${worst.ticker}</strong> returned <strong>${fmtP(worst.rs.pChg)}</strong> â€” a <strong>${spread} percentage point</strong> spread over this period. ${byRange[0].ticker} had the widest total price range at <strong>${(byRange[0].rs.rangePct*100).toFixed(1)}%</strong> from low to high.`
  });

  return blocks;
}

function generateTickerInsights(r, th, period, days, multi) {
  const blocks = [];
  const { ticker, outs, rs, up, down, avgMv, estYr } = r;
  const total = outs.length;
  const prefix = multi ? `<strong class="hl-blue">${ticker}</strong>: ` : '';

  // Volatility profile
  let volProfile = '';
  const sdPct = rs.sd * 100;
  if (sdPct < 1.5) volProfile = 'low-volatility';
  else if (sdPct < 3) volProfile = 'moderate-volatility';
  else if (sdPct < 5) volProfile = 'high-volatility';
  else volProfile = 'extreme-volatility';

  const avgDRdollar = rs.avgDR.toFixed(2);
  const avgDRpct = (rs.avgDRpct * 100).toFixed(2);

  let rangeText = `${prefix}This is a <strong>${volProfile}</strong> name with a <strong>${avgDRpct}%</strong> average daily range ($${avgDRdollar}). `;

  // Context-aware range analysis
  if (period === 'short') {
    const bigVsAvg = (rs.maxDR / rs.avgDR).toFixed(1);
    rangeText += `Over this short window, the biggest single-day range ($${rs.maxDR.toFixed(2)} on ${fmtD(rs.maxDRdate)}) was <strong>${bigVsAvg}x</strong> the average daily range`;
    if (parseFloat(bigVsAvg) > 2) {
      rangeText += ` â€” a notable spike worth investigating for catalyst.`;
    } else {
      rangeText += ` â€” relatively contained.`;
    }
  } else {
    rangeText += `The full ${(rs.rangePct*100).toFixed(1)}% price range ($${rs.pL.toFixed(2)} â†’ $${rs.pH.toFixed(2)}) `;
    if (rs.rangePct > 1) rangeText += `is massive â€” this stock effectively doubled its price range.`;
    else if (rs.rangePct > 0.5) rangeText += `shows significant movement â€” wide swings for position traders.`;
    else if (rs.rangePct > 0.2) rangeText += `is moderate â€” typical for a name this size.`;
    else rangeText += `is relatively tight â€” a range-bound period.`;
  }

  blocks.push({ icon: multi ? 'ðŸ“‹' : 'ðŸ“Š', title: multi ? `${ticker} â€” Range Profile` : 'Range Profile', text: rangeText });

  // Outlier analysis
  if (total > 0) {
    const freq = parseFloat(estYr);
    const interval = freq > 0 ? Math.round(252 / freq) : null;
    const biggestOut = outs[0]; // already sorted by abs return
    const avgMvPct = (avgMv * 100).toFixed(2);

    let outText = `${prefix}<strong>${total}</strong> days exceeded the ${th}Ïƒ threshold`;
    if (interval) outText += ` (~once every <strong class="hl-orange">${interval} trading days</strong>, est. <strong>${estYr}/year</strong>)`;
    outText += `. Average outlier move: <strong>${avgMvPct}%</strong>. `;

    // Biggest single outlier
    const bigDir = biggestOut.dir === 'up' ? 'ripped' : 'cratered';
    const bigDirColor = biggestOut.dir === 'up' ? 'hl-green' : 'hl-red';
    outText += `The biggest was <strong class="${bigDirColor}">${fmtP(biggestOut.ret)}</strong> on ${biggestOut.dateStr} when the stock ${bigDir} from $${biggestOut.pc.toFixed(2)} to $${biggestOut.c.toFixed(2)}`;
    if (biggestOut.news?.length) {
      outText += ` â€” linked to: <em>"${biggestOut.news[0].title.length > 80 ? biggestOut.news[0].title.slice(0,77)+'...' : biggestOut.news[0].title}"</em>`;
    }
    outText += '.';

    // Up vs down bias
    if (total >= 4) {
      const upRatio = up / total;
      if (upRatio >= 0.7) {
        outText += ` <strong class="hl-green">Strong bullish skew</strong> â€” ${up} of ${total} outlier days were up moves. When this stock gets hit with news, it tends to gap up.`;
      } else if (upRatio <= 0.3) {
        outText += ` <strong class="hl-red">Strong bearish skew</strong> â€” ${down} of ${total} outlier days were down moves. News-driven moves overwhelmingly punish this stock.`;
      } else if (upRatio >= 0.55) {
        outText += ` Slight bullish lean with ${up} up vs ${down} down.`;
      } else if (upRatio <= 0.45) {
        outText += ` Slight bearish lean with ${down} down vs ${up} up.`;
      } else {
        outText += ` Balanced split â€” ${up} up vs ${down} down, no clear directional bias on catalyst days.`;
      }
    }

    // Callout for high-frequency outlier stocks
    let callout = null, calloutType = '';
    if (freq >= 30) {
      callout = `${ticker} averages roughly ${estYr} significant moves per year â€” that's extremely event-driven. Expect outsized moves about once a week. Plan position sizing accordingly and consider event-driven strategies.`;
      calloutType = 'warn';
    } else if (freq >= 20) {
      callout = `${ticker} sees a significant catalyst move roughly every 2 weeks. This is an active name for news-driven trading â€” keep it on your watchlist for earnings, product launches, and analyst actions.`;
      calloutType = '';
    } else if (total === 0) {
      callout = `Zero outlier days at ${th}Ïƒ means this stock traded within a normal distribution during this period. It was either quiet or the baseline volatility was already high. Try lowering the threshold to 1.5Ïƒ to catch borderline moves.`;
      calloutType = 'good';
    }

    blocks.push({
      icon: 'âš¡',
      title: multi ? `${ticker} â€” Catalyst Profile` : 'Catalyst Profile',
      text: outText,
      callout, calloutType
    });

    // Cluster detection - find if outlier days bunch together
    if (total >= 3) {
      const sortedDates = [...outs].sort((a,b) => a.date - b.date);
      const clusters = [];
      let cluster = [sortedDates[0]];

      for (let i = 1; i < sortedDates.length; i++) {
        const gap = (sortedDates[i].date - sortedDates[i-1].date) / (1000*60*60*24);
        if (gap <= 5) {
          cluster.push(sortedDates[i]);
        } else {
          if (cluster.length >= 2) clusters.push([...cluster]);
          cluster = [sortedDates[i]];
        }
      }
      if (cluster.length >= 2) clusters.push(cluster);

      if (clusters.length > 0) {
        const biggest = clusters.sort((a,b) => b.length - a.length)[0];
        const clusterStart = fmtD(biggest[0].date);
        const clusterEnd = fmtD(biggest[biggest.length-1].date);
        const clusterMoves = biggest.map(o => `${fmtP(o.ret)}`).join(', ');

        blocks.push({
          icon: 'ðŸ”¥',
          title: multi ? `${ticker} â€” Volatility Cluster` : 'Volatility Cluster Detected',
          text: `${prefix}Found <strong>${clusters.length} cluster${clusters.length>1?'s':''}</strong> where outlier days bunched within 5 trading days. The largest cluster had <strong>${biggest.length} consecutive outlier days</strong> between ${clusterStart} and ${clusterEnd} (moves: ${clusterMoves}). Clusters often signal earnings seasons, macro events, or sector rotation â€” the market was actively repricing this stock during that window.`,
        });
      }
    }

    // Volume analysis on outlier days
    if (total >= 2) {
      const avgVolRatio = outs.reduce((s,o) => s + o.vr, 0) / total;
      const highVolOuts = outs.filter(o => o.vr >= 2).length;
      const highVolPct = ((highVolOuts / total) * 100).toFixed(0);

      let volText = `${prefix}On outlier days, volume averaged <strong class="hl-orange">${avgVolRatio.toFixed(1)}x</strong> the daily average. `;
      if (highVolPct >= 70) {
        volText += `<strong>${highVolPct}%</strong> of outlier days had 2x+ volume â€” these moves had serious conviction behind them, not just low-liquidity noise.`;
      } else if (highVolPct >= 40) {
        volText += `${highVolPct}% had 2x+ volume â€” a mix of conviction moves and lighter-volume reactions.`;
      } else {
        volText += `Only ${highVolPct}% had 2x+ volume â€” many outlier moves happened on normal volume, suggesting gap-driven or pre-market catalyst moves rather than heavy institutional participation.`;
      }

      blocks.push({
        icon: 'ðŸ“¦',
        title: multi ? `${ticker} â€” Volume Conviction` : 'Volume Conviction',
        text: volText
      });
    }

  } else {
    blocks.push({
      icon: 'ðŸ˜´',
      title: multi ? `${ticker} â€” Quiet Period` : 'Quiet Period',
      text: `${prefix}Zero days exceeded the ${th}Ïƒ threshold. This stock stayed well within its normal distribution the entire period â€” no significant catalysts broke through. This could mean the stock is range-bound, or the baseline volatility is already baked in.`,
      callout: 'Try lowering the threshold to 1.5Ïƒ or extending the lookback period to capture more subtle moves.',
      calloutType: 'good'
    });
  }

  return blocks;
}

function generateTradingImplications(results, th, period) {
  const blocks = [];
  const activeResults = results.filter(r => r.outs.length > 0);
  if (activeResults.length < 2) return blocks;

  // Position sizing implications
  const byAvgMv = [...activeResults].sort((a,b) => b.avgMv - a.avgMv);
  const hottest = byAvgMv[0];
  const calmest = byAvgMv[byAvgMv.length - 1];
  const sizeRatio = (hottest.avgMv / calmest.avgMv).toFixed(1);

  let sizingText = `If you're trading all ${results.length} names, <strong class="hl-blue">${hottest.ticker}</strong>'s outlier moves average <strong>${(hottest.avgMv*100).toFixed(2)}%</strong> vs <strong class="hl-blue">${calmest.ticker}</strong> at <strong>${(calmest.avgMv*100).toFixed(2)}%</strong> â€” a <strong>${sizeRatio}x</strong> difference. `;
  sizingText += `To equalize risk on catalyst days, size ${hottest.ticker} positions roughly <strong>${sizeRatio}x smaller</strong> than ${calmest.ticker}. `;

  // Premium selling context
  const highFreq = activeResults.filter(r => parseFloat(r.estYr) >= 20);
  if (highFreq.length) {
    sizingText += `For premium sellers: ${highFreq.map(r=>`<strong>${r.ticker}</strong>`).join(', ')} ${highFreq.length>1?'have':'has'} 20+ estimated events/year â€” selling options around earnings on ${highFreq.length>1?'these names':'this name'} means you're frequently exposed to gap risk.`;
  }

  blocks.push({
    icon: 'ðŸ’¡',
    title: 'Trading Implications',
    text: sizingText,
  });

  // Best candidate for various strategies
  const byBias = activeResults.map(r => ({
    ticker: r.ticker,
    upRatio: r.outs.length ? r.up / r.outs.length : 0.5,
    total: r.outs.length,
    avgMv: r.avgMv,
    sd: r.rs.sd,
    estYr: parseFloat(r.estYr)
  }));

  let stratText = '<strong>Strategy fit based on this data:</strong><br>';
  const mostBullish = [...byBias].sort((a,b) => b.upRatio - a.upRatio)[0];
  const mostBearish = [...byBias].sort((a,b) => a.upRatio - b.upRatio)[0];
  const calmestVol = [...byBias].sort((a,b) => a.sd - b.sd)[0];
  const wildest = [...byBias].sort((a,b) => b.avgMv - a.avgMv)[0];

  if (mostBullish.upRatio >= 0.6) {
    stratText += `â€¢ <strong class="hl-green">${mostBullish.ticker}</strong> â€” bullish catalyst bias (${(mostBullish.upRatio*100).toFixed(0)}% up moves). Better candidate for buying dips into catalyst events.<br>`;
  }
  if (mostBearish.upRatio <= 0.4) {
    stratText += `â€¢ <strong class="hl-red">${mostBearish.ticker}</strong> â€” bearish catalyst bias (${((1-mostBearish.upRatio)*100).toFixed(0)}% down moves). Consider protective puts before known events or fade rallies into catalysts.<br>`;
  }
  stratText += `â€¢ <strong class="hl-blue">${calmestVol.ticker}</strong> â€” lowest daily volatility, best for tighter stops and smaller expected ranges.<br>`;
  stratText += `â€¢ <strong class="hl-orange">${wildest.ticker}</strong> â€” biggest avg outlier move (${(wildest.avgMv*100).toFixed(2)}%), best for momentum/breakout plays on catalyst days.`;

  blocks.push({
    icon: 'ðŸŽ²',
    title: 'Strategy Fit',
    text: stratText,
  });

  return blocks;
}

/* â”€â”€ COMPARISON TABLE â”€â”€ */
function renderComparison(results, th, from, to) {
  // Find min/max for highlighting
  const vals = {
    outliers: results.map(r=>r.outs.length),
    sd: results.map(r=>r.rs.sd),
    avgDR: results.map(r=>r.rs.avgDRpct),
    change: results.map(r=>r.rs.pChg)
  };

  const rows = results.map((r,i) => {
    const s = r.rs;
    const chgCls = s.pChg >= 0 ? 'move-up' : 'move-down';
    const chgA = s.pChg >= 0 ? 'â–²' : 'â–¼';

    // Highlight cells: lowest volatility = best, highest = worst
    const sdBest = s.sd === Math.min(...vals.sd);
    const sdWorst = s.sd === Math.max(...vals.sd);
    const outBest = r.outs.length === Math.min(...vals.outliers);
    const outWorst = r.outs.length === Math.max(...vals.outliers);

    return `<tr>
      <td style="font-family:'JetBrains Mono';font-weight:700" class="tk-${r.ci}">${r.ticker}</td>
      <td><span class="${chgCls} mono">${chgA} ${fmtP(s.pChg)}</span></td>
      <td class="mono">$${s.pH.toFixed(2)}</td>
      <td class="mono">$${s.pL.toFixed(2)}</td>
      <td class="mono">${(s.rangePct*100).toFixed(1)}%</td>
      <td class="mono">${(s.avgDRpct*100).toFixed(2)}%</td>
      <td class="mono ${sdBest?'best-cell':''} ${sdWorst?'worst-cell':''}">${(s.sd*100).toFixed(2)}%</td>
      <td class="mono ${outBest?'best-cell':''} ${outWorst?'worst-cell':''}">${r.outs.length}</td>
      <td class="mono">${r.estYr}</td>
      <td class="mono" style="color:var(--green)">${r.up}</td>
      <td class="mono" style="color:var(--red)">${r.down}</td>
      <td class="mono">${(r.avgMv*100).toFixed(2)}%</td>
      <td class="mono">${fmtV(s.avgVol)}</td>
    </tr>`;
  }).join('');

  document.getElementById('comparisonContainer').innerHTML = `
    <div class="comp-wrap">
      <div class="comp-header">
        <h2>âš¡ Side-by-Side Comparison</h2>
        <span class="badge">${results.length} tickers Â· ${th}Ïƒ Â· ${from} â†’ ${to}</span>
      </div>
      <div style="overflow-x:auto">
        <table class="comp-table">
          <thead><tr>
            <th>Ticker</th><th>Period Î”</th><th>High</th><th>Low</th><th>Range%</th>
            <th>Avg Day Range</th><th>Volatility 1Ïƒ</th><th>Outlier Days</th><th>Est/Year</th>
            <th>Up</th><th>Down</th><th>Avg Move</th><th>Avg Vol</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
}

/* â”€â”€ INDIVIDUAL TICKER SECTION â”€â”€ */
function renderSection(r, th, from, to, multi) {
  const { ticker, bars, outs, rs, up, down, avgMv, estYr, ci } = r;
  const id = `sec-${ticker}`;
  const el = document.createElement('div');
  el.className = `tk-section tkb-${ci}`;

  const chgC = rs.pChg >= 0 ? 'var(--green)' : 'var(--red)';
  const chgA = rs.pChg >= 0 ? 'â–²' : 'â–¼';

  // Events table
  let evRows = '';
  if (outs.length) {
    evRows = outs.map(o => {
      const mc = o.dir==='up' ? 'move-up' : 'move-down';
      const ar = o.dir==='up' ? 'â–²' : 'â–¼';
      let nh = '<span style="color:var(--text-muted)">â€”</span>';
      if (o.news?.length) nh = o.news.map(n => `<a href="${n.article_url}" target="_blank">${n.title.length>70?n.title.slice(0,67)+'...':n.title}</a>`).join('<br>');
      return `<tr>
        <td class="mono">${o.dateStr}</td>
        <td><span class="${mc} mono">${ar} ${fmtP(o.ret)}</span></td>
        <td class="mono">${o.z.toFixed(1)}Ïƒ</td>
        <td class="mono">$${o.pc.toFixed(2)} â†’ $${o.c.toFixed(2)}</td>
        <td><span class="volume-badge mono">${o.vr.toFixed(1)}x</span></td>
        <td class="news-cell">${nh}</td>
      </tr>`;
    }).join('');
  }

  const evTable = outs.length ? `
    <div class="ev-wrap">
      <div class="ev-hdr"><h4>Outlier Events</h4><span class="badge">${outs.length} events</span></div>
      <div style="overflow-x:auto"><table class="ev-table">
        <thead><tr><th>Date</th><th>Move</th><th>Z-Score</th><th>Price</th><th>Vol vs Avg</th><th>News</th></tr></thead>
        <tbody>${evRows}</tbody>
      </table></div>
    </div>` : `<div style="text-align:center;padding:28px;color:var(--text-muted)">No moves exceeding ${th}Ïƒ in this period</div>`;

  el.innerHTML = `
    <div class="tk-section-hdr" onclick="toggleSec('${id}')">
      <h2><span class="tk-${ci}" style="font-family:'JetBrains Mono'">${ticker}</span> â€” ${outs.length} significant move${outs.length!==1?'s':''}</h2>
      <span class="toggle ${multi?'collapsed':''}" id="ic-${id}">â–¼</span>
    </div>
    <div class="tk-section-body ${multi?'collapsed':''}" id="${id}">
      <div class="tk-body-inner">
        <div class="range-grid">
          <div class="range-item"><span class="ri-lbl">Period Change</span><span class="ri-val" style="color:${chgC}">${chgA} ${fmtP(rs.pChg)}</span><span class="ri-sub">$${rs.pO.toFixed(2)} â†’ $${rs.pC.toFixed(2)}</span></div>
          <div class="range-item"><span class="ri-lbl">Period High</span><span class="ri-val" style="color:var(--green)">$${rs.pH.toFixed(2)}</span><span class="ri-sub">${fmtD(rs.hDate)}</span></div>
          <div class="range-item"><span class="ri-lbl">Period Low</span><span class="ri-val" style="color:var(--red)">$${rs.pL.toFixed(2)}</span><span class="ri-sub">${fmtD(rs.lDate)}</span></div>
          <div class="range-item"><span class="ri-lbl">Total Range</span><span class="ri-val" style="color:var(--accent)">$${rs.range.toFixed(2)}</span><span class="ri-sub">${(rs.rangePct*100).toFixed(2)}% spread</span></div>
          <div class="range-item"><span class="ri-lbl">Avg Daily Range</span><span class="ri-val" style="color:var(--orange)">$${rs.avgDR.toFixed(2)}</span><span class="ri-sub">${(rs.avgDRpct*100).toFixed(2)}% avg</span></div>
          <div class="range-item"><span class="ri-lbl">Biggest Day Range</span><span class="ri-val">$${rs.maxDR.toFixed(2)}</span><span class="ri-sub">${(rs.maxDRpct*100).toFixed(2)}% Â· ${fmtD(rs.maxDRdate)}</span></div>
          <div class="range-item"><span class="ri-lbl">Smallest Day Range</span><span class="ri-val" style="color:var(--text-muted)">$${rs.minDR.toFixed(2)}</span><span class="ri-sub">${(rs.minDRpct*100).toFixed(2)}% Â· ${fmtD(rs.minDRdate)}</span></div>
          <div class="range-item"><span class="ri-lbl">Volatility (1Ïƒ)</span><span class="ri-val" style="color:var(--accent)">${(rs.sd*100).toFixed(2)}%</span><span class="ri-sub">${rs.days} trading days</span></div>
          <div class="range-item"><span class="ri-lbl">Avg Daily Volume</span><span class="ri-val">${fmtV(rs.avgVol)}</span></div>
        </div>

        <div class="o-stats">
          <div class="o-card"><div class="o-v" style="color:var(--accent)">${outs.length}</div><div class="o-l">Outlier Days</div></div>
          <div class="o-card"><div class="o-v" style="color:var(--green)">â–² ${up}</div><div class="o-l">Up Moves</div></div>
          <div class="o-card"><div class="o-v" style="color:var(--red)">â–¼ ${down}</div><div class="o-l">Down Moves</div></div>
          <div class="o-card"><div class="o-v" style="color:var(--orange)">${(avgMv*100).toFixed(2)}%</div><div class="o-l">Avg Move</div></div>
          <div class="o-card"><div class="o-v">${estYr}</div><div class="o-l">Est/Year</div></div>
        </div>

        <div class="chart-wrap">
          <h3>Daily Returns (outliers highlighted)</h3>
          <canvas id="ch-${ticker}" height="170"></canvas>
        </div>

        ${evTable}
      </div>
    </div>`;

  document.getElementById('tickerSections').appendChild(el);
  requestAnimationFrame(() => {
    drawChart(ticker, bars, outs, rs.sd, th);
    if (!multi) { const b = document.getElementById(id); b.style.maxHeight = b.scrollHeight + 'px'; }
  });
}

function toggleSec(id) {
  const b = document.getElementById(id), ic = document.getElementById('ic-'+id);
  if (b.classList.contains('collapsed')) {
    b.classList.remove('collapsed'); b.style.maxHeight = b.scrollHeight + 'px'; ic.classList.remove('collapsed');
  } else {
    b.classList.add('collapsed'); b.style.maxHeight = '0'; ic.classList.add('collapsed');
  }
}

function drawChart(ticker, bars, outs, sd, th) {
  const cv = document.getElementById(`ch-${ticker}`);
  if (!cv) return;
  const ctx = cv.getContext('2d');
  const W = cv.parentElement.getBoundingClientRect().width;
  cv.width = W; cv.height = 170;
  const H = 170;
  const pad = {t:14,r:14,b:20,l:52};

  const rets = [];
  for (let i=1;i<bars.length;i++) rets.push({d:bars[i].t, r:(bars[i].c-bars[i-1].c)/bars[i-1].c});
  if (!rets.length) return;

  const mx = Math.max(...rets.map(r=>Math.abs(r.r)));
  const yr = mx*1.15;
  const xs = (W-pad.l-pad.r)/Math.max(rets.length-1,1);
  const ys = (H-pad.t-pad.b)/(2*yr);
  const ym = pad.t+(H-pad.t-pad.b)/2;

  const ty = th*sd*ys;
  ctx.fillStyle = 'rgba(59,130,246,0.06)';
  ctx.fillRect(pad.l, ym-ty, W-pad.l-pad.r, ty*2);
  ctx.strokeStyle = 'rgba(59,130,246,0.25)'; ctx.setLineDash([4,4]); ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad.l,ym-ty); ctx.lineTo(W-pad.r,ym-ty);
  ctx.moveTo(pad.l,ym+ty); ctx.lineTo(W-pad.r,ym+ty); ctx.stroke(); ctx.setLineDash([]);

  ctx.strokeStyle = 'rgba(148,163,184,0.15)'; ctx.beginPath();
  ctx.moveTo(pad.l,ym); ctx.lineTo(W-pad.r,ym); ctx.stroke();

  const oSet = new Set(outs.map(o=>iso(new Date(o.date))));
  rets.forEach((r,i) => {
    const x = pad.l+i*xs, bh = Math.abs(r.r)*ys, y = r.r>=0?ym-bh:ym;
    const isO = oSet.has(new Date(r.d).toISOString().split('T')[0]);
    ctx.fillStyle = isO
      ? (r.r>=0?'rgba(34,197,94,0.9)':'rgba(239,68,68,0.9)')
      : (r.r>=0?'rgba(34,197,94,0.18)':'rgba(239,68,68,0.18)');
    const bw = Math.max(xs*0.65,1.5);
    ctx.fillRect(x-bw/2, y, bw, Math.max(bh,0.5));
  });

  ctx.fillStyle = '#64748b'; ctx.font = '10px JetBrains Mono'; ctx.textAlign = 'right';
  [-yr,-yr/2,0,yr/2,yr].forEach(v => ctx.fillText((v*100).toFixed(1)+'%', pad.l-5, ym-v*ys+3));
}

/* â”€â”€ EXPORT BRIEF â”€â”€ */
function exportBrief() {
  if (!lastScanResults) return;

  const results = lastScanResults;
  const meta = lastScanMeta;
  const tickers = results.map(r => r.ticker).join(', ');
  const today = new Date().toLocaleDateString('en-US', {month:'long',day:'numeric',year:'numeric'});
  const multi = results.length > 1;

  let brief = `STOCK CATALYST SCAN â€” ${tickers}\n`;
  brief += `Scanned: ${today} | Period: ${meta.from} to ${meta.to} | Threshold: ${meta.threshold}Ïƒ\n`;
  brief += `${'â•'.repeat(70)}\n\n`;

  if (multi) {
    brief += `COMPARISON SUMMARY\n${'â”€'.repeat(40)}\n`;
    const header = 'Ticker'.padEnd(8) + 'Change'.padEnd(12) + 'Vol(1Ïƒ)'.padEnd(10) + 'Outliers'.padEnd(10) + 'Est/Yr'.padEnd(9) + 'Up'.padEnd(5) + 'Down'.padEnd(6) + 'AvgMove'.padEnd(10) + 'AvgDayRng\n';
    brief += header;
    results.forEach(r => {
      brief += r.ticker.padEnd(8) +
        fmtP(r.rs.pChg).padEnd(12) +
        ((r.rs.sd*100).toFixed(2)+'%').padEnd(10) +
        String(r.outs.length).padEnd(10) +
        r.estYr.padEnd(9) +
        String(r.up).padEnd(5) +
        String(r.down).padEnd(6) +
        ((r.avgMv*100).toFixed(2)+'%').padEnd(10) +
        (r.rs.avgDRpct*100).toFixed(2)+'%\n';
    });
    brief += '\n';
  }

  results.forEach(r => {
    const s = r.rs;
    brief += `${'â•'.repeat(70)}\n`;
    brief += `${r.ticker}\n${'â•'.repeat(70)}\n\n`;

    brief += `RANGE ANALYSIS\n`;
    brief += `  Period Change:   ${fmtP(s.pChg)} ($${s.pO.toFixed(2)} â†’ $${s.pC.toFixed(2)})\n`;
    brief += `  Period High:     $${s.pH.toFixed(2)} (${fmtD(s.hDate)})\n`;
    brief += `  Period Low:      $${s.pL.toFixed(2)} (${fmtD(s.lDate)})\n`;
    brief += `  Total Range:     $${s.range.toFixed(2)} (${(s.rangePct*100).toFixed(2)}% spread)\n`;
    brief += `  Avg Daily Range: $${s.avgDR.toFixed(2)} (${(s.avgDRpct*100).toFixed(2)}%)\n`;
    brief += `  Biggest Day:     $${s.maxDR.toFixed(2)} (${(s.maxDRpct*100).toFixed(2)}%) on ${fmtD(s.maxDRdate)}\n`;
    brief += `  Smallest Day:    $${s.minDR.toFixed(2)} (${(s.minDRpct*100).toFixed(2)}%) on ${fmtD(s.minDRdate)}\n`;
    brief += `  Volatility (1Ïƒ): ${(s.sd*100).toFixed(2)}%\n`;
    brief += `  Avg Volume:      ${fmtV(s.avgVol)}\n`;
    brief += `  Trading Days:    ${s.days}\n\n`;

    brief += `CATALYST PROFILE\n`;
    brief += `  Outlier Days:    ${r.outs.length}\n`;
    brief += `  Up Moves:        ${r.up}\n`;
    brief += `  Down Moves:      ${r.down}\n`;
    brief += `  Avg Move Size:   ${(r.avgMv*100).toFixed(2)}%\n`;
    brief += `  Est. Per Year:   ${r.estYr}\n`;

    if (r.outs.length > 0) {
      const bias = r.up > r.down ? 'BULLISH' : r.down > r.up ? 'BEARISH' : 'NEUTRAL';
      const pct = r.outs.length ? ((r.up / r.outs.length)*100).toFixed(0) : '50';
      brief += `  Directional Bias: ${bias} (${pct}% up)\n`;
    }

    // Clusters
    if (r.outs.length >= 3) {
      const sorted = [...r.outs].sort((a,b) => a.date - b.date);
      const clusters = [];
      let cl = [sorted[0]];
      for (let i = 1; i < sorted.length; i++) {
        if ((sorted[i].date - sorted[i-1].date) / (1000*60*60*24) <= 5) cl.push(sorted[i]);
        else { if (cl.length >= 2) clusters.push([...cl]); cl = [sorted[i]]; }
      }
      if (cl.length >= 2) clusters.push(cl);
      if (clusters.length) {
        brief += `  Vol Clusters:    ${clusters.length} detected\n`;
        clusters.sort((a,b) => b.length - a.length).slice(0,3).forEach((c,i) => {
          brief += `    Cluster ${i+1}: ${fmtD(c[0].date)} â†’ ${fmtD(c[c.length-1].date)} (${c.length} days, moves: ${c.map(o=>fmtP(o.ret)).join(', ')})\n`;
        });
      }
    }

    // Volume conviction
    if (r.outs.length >= 2) {
      const avgVR = r.outs.reduce((s,o) => s + o.vr, 0) / r.outs.length;
      const highVol = r.outs.filter(o => o.vr >= 2).length;
      brief += `  Avg Outlier Vol:  ${avgVR.toFixed(1)}x avg (${highVol}/${r.outs.length} had 2x+ volume)\n`;
    }

    // Outlier events table
    if (r.outs.length > 0) {
      brief += `\n  OUTLIER EVENTS\n`;
      brief += `  ${'Date'.padEnd(18)}${'Move'.padEnd(12)}${'Z'.padEnd(8)}${'Price'.padEnd(24)}${'Vol'.padEnd(8)}News\n`;
      brief += `  ${'â”€'.repeat(90)}\n`;
      r.outs.forEach(o => {
        let newsTitle = 'â€”';
        if (o.news?.length) newsTitle = o.news[0].title.length > 50 ? o.news[0].title.slice(0,47)+'...' : o.news[0].title;
        brief += `  ${o.dateStr.padEnd(18)}${fmtP(o.ret).padEnd(12)}${(o.z.toFixed(1)+'Ïƒ').padEnd(8)}$${o.pc.toFixed(2)}â†’$${o.c.toFixed(2)}`.padEnd(26) + `${(o.vr.toFixed(1)+'x').padEnd(8)}${newsTitle}\n`;
      });
    }

    brief += `\n`;
  });

  brief += `${'â•'.repeat(70)}\n`;
  brief += `Paste this to Claude and ask for deep analysis with latest market context.\n`;

  navigator.clipboard.writeText(brief).then(() => {
    const btn = document.getElementById('exportBtn');
    btn.textContent = 'âœ“ Copied!';
    btn.classList.add('copied');
    showToast('Brief copied to clipboard â€” paste it to Claude for deep analysis');
    setTimeout(() => { btn.textContent = 'ðŸ“‹ Export Brief'; btn.classList.remove('copied'); }, 2500);
  }).catch(() => {
    // Fallback: create downloadable file
    const blob = new Blob([brief], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scan-${results.map(r=>r.ticker).join('-')}-${meta.from}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Brief downloaded as text file');
  });
}

function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.className = 'toast';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}
</script>
</body>
</html>
