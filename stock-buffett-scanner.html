<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buffett Blood Scanner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg-primary: #0f172a; --bg-card: #1a2332; --bg-card-hover: #1e293b;
    --border: #1e3348; --accent: #38bdf8; --accent-glow: rgba(56,189,248,0.1);
    --green: #22c55e; --red: #ef4444; --orange: #f59e0b;
    --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
    --blood: #dc2626; --blood-glow: rgba(220,38,38,0.08);
    --value: #16a34a; --value-glow: rgba(22,163,74,0.08);
    --purple: #a855f7;
  }
  body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Outfit','Inter',system-ui,sans-serif; line-height: 1.5; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px 60px; position: relative; }
  header { text-align: center; margin-bottom: 28px; padding-top: 20px; }
  header h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--red), var(--orange), var(--green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px; }
  header p { color: var(--text-muted); font-size: 0.9rem; }

  .back-link { position: absolute; top: 20px; left: 20px; color: var(--text-muted); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; display: flex; align-items: center; gap: 6px; }
  .back-link:hover { color: var(--text-primary); }

  /* Presets */
  .preset-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 16px; }
  .preset-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 18px; border-radius: 8px; font-family: 'Outfit',sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .preset-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
  .preset-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

  /* Input */
  .input-row { display: flex; gap: 10px; margin-bottom: 24px; align-items: stretch; }
  #tickerInput { flex: 1; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 12px 16px; border-radius: 10px; font-family: 'JetBrains Mono',monospace; font-size: 0.9rem; outline: none; transition: border 0.2s; }
  #tickerInput:focus { border-color: var(--accent); }
  .scan-btn { background: linear-gradient(135deg, #0ea5e9, #38bdf8); color: #fff; border: none; padding: 12px 28px; border-radius: 10px; font-family: 'Outfit',sans-serif; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .scan-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(56,189,248,0.3); }
  .scan-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .deep-btn { background: linear-gradient(135deg, #7c3aed, #a855f7); color: #fff; border: none; padding: 12px 28px; border-radius: 10px; font-family: 'Outfit',sans-serif; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .deep-btn:hover { background: linear-gradient(135deg, #6d28d9, #9333ea); transform: translateY(-1px); }
  .deep-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .deep-btn.copied { background: linear-gradient(135deg, #059669, #10b981); }

  /* Progress */
  .progress { text-align: center; padding: 40px; color: var(--text-muted); font-size: 0.9rem; }
  .progress .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Error */
  .error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: var(--red); padding: 12px 16px; border-radius: 10px; font-size: 0.85rem; margin-bottom: 16px; }

  /* Summary Cards */
  .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .sum-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
  .sum-card .sv { font-family: 'JetBrains Mono',monospace; font-size: 1.6rem; font-weight: 700; margin-bottom: 2px; }
  .sum-card .sl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }

  /* Results Table */
  .results-header, .result-row { display: grid; grid-template-columns: 36px 68px 1fr 82px 76px 56px 56px 56px 42px 86px; align-items: center; gap: 6px; padding: 10px 14px; font-size: 0.82rem; }
  .results-header { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px 10px 0 0; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.68rem; cursor: pointer; user-select: none; }
  .results-header span:hover { color: var(--accent); }
  .results-header .sort-active { color: var(--accent); }
  .result-row { background: var(--bg-card); border: 1px solid var(--border); border-top: none; cursor: pointer; transition: background 0.15s; }
  .result-row:last-of-type { border-radius: 0 0 10px 10px; }
  .result-row:hover { background: var(--bg-card-hover); }
  .result-row .rk { color: var(--text-muted); font-family: 'JetBrains Mono',monospace; font-size: 0.75rem; }
  .result-row .tk { font-family: 'JetBrains Mono',monospace; font-weight: 700; color: var(--accent); }
  .result-row .nm { color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .result-row .pr { font-family: 'JetBrains Mono',monospace; font-weight: 600; }
  .result-row .dd { font-family: 'JetBrains Mono',monospace; color: var(--red); font-weight: 600; }
  .result-row .sc { font-family: 'JetBrains Mono',monospace; font-weight: 700; text-align: center; }
  .result-row .gr { font-family: 'JetBrains Mono',monospace; font-weight: 700; text-align: center; }
  .signal-badge { display: inline-block; padding: 3px 10px; border-radius: 6px; font-family: 'JetBrains Mono',monospace; font-size: 0.68rem; font-weight: 700; white-space: nowrap; }
  .sig-deep { background: rgba(22,163,74,0.15); color: var(--green); }
  .sig-value { background: rgba(34,197,94,0.1); color: #4ade80; }
  .sig-fair { background: rgba(59,130,246,0.1); color: var(--accent); }
  .sig-neutral { background: rgba(100,116,139,0.15); color: var(--text-muted); }
  .sig-over { background: rgba(239,68,68,0.1); color: var(--red); }
  .sig-blood { background: rgba(245,158,11,0.12); color: var(--orange); }
  .debt-adj-badge { display: inline-block; font-size: 0.6rem; color: var(--orange); margin-left: 4px; vertical-align: super; }

  /* Detail Expansion */
  .detail-panel { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; background: var(--bg-primary); border: 1px solid var(--border); border-top: none; padding: 0 16px; }
  .detail-panel.open { padding: 20px 16px; }
  .detail-inner { display: grid; gap: 16px; }
  .detail-section h5 { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 10px; }
  .score-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
  .sc-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
  .sc-card .scv { font-family: 'JetBrains Mono',monospace; font-size: 1.3rem; font-weight: 700; }
  .sc-card .scl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.7px; margin-top: 2px; }
  .sc-card .scs { font-size: 0.72rem; color: var(--text-muted); font-family: 'JetBrains Mono',monospace; margin-top: 3px; }
  .sc-bar { height: 5px; background: var(--border); border-radius: 3px; margin-top: 6px; overflow: hidden; }
  .sc-bar div { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

  /* Range bar */
  .range-bar-wrap { margin-top: 10px; }
  .range-bar-label { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--text-muted); font-family: 'JetBrains Mono',monospace; margin-bottom: 4px; }
  .range-bar { position: relative; height: 10px; background: linear-gradient(90deg, var(--red), var(--orange), var(--green)); border-radius: 5px; }
  .range-dot { position: absolute; top: -3px; width: 16px; height: 16px; background: #fff; border: 2px solid var(--accent); border-radius: 50%; transform: translateX(-50%); box-shadow: 0 0 8px rgba(56,189,248,0.4); }

  /* Key metrics grid */
  .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .metric-row { display: flex; justify-content: space-between; padding: 6px 10px; background: var(--bg-card); border-radius: 6px; font-size: 0.8rem; }
  .metric-row .mk { color: var(--text-muted); }
  .metric-row .mv { font-family: 'JetBrains Mono',monospace; font-weight: 600; }

  /* Verdict */
  .verdict { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; font-size: 0.85rem; line-height: 1.6; color: var(--text-secondary); }
  .verdict strong { color: var(--text-primary); }

  /* Empty state */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
  .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }
  .empty-state p { font-size: 0.9rem; line-height: 1.6; }

  /* Toast */
  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #10b981; color: #fff; padding: 14px 28px; border-radius: 10px; font-family: 'Outfit',sans-serif; font-weight: 600; font-size: 0.95rem; box-shadow: 0 8px 30px rgba(16,185,129,0.3); opacity: 0; transition: all 0.3s ease; z-index: 9999; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .footer-note { text-align: center; color: var(--text-muted); font-size: 0.72rem; margin-top: 30px; }

  @media (max-width: 768px) {
    .input-row { flex-direction: column; }
    .scan-btn, .deep-btn { width: 100%; }
    .results-header, .result-row { grid-template-columns: 28px 60px 1fr 72px 60px 50px 50px; font-size: 0.75rem; }
    .results-header span:nth-child(n+9), .result-row > *:nth-child(n+9) { display: none; }
    .score-grid { grid-template-columns: 1fr 1fr; }
    .metrics-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">
  <a href="/desk" class="back-link">‚Üê Trade Desk</a>
  <header>
    <h1>ü©∏ Buffett Blood Scanner</h1>
    <p>"Be fearful when others are greedy, be greedy when others are fearful"</p>
  </header>

  <div class="preset-row">
    <button class="preset-btn" onclick="loadPreset('mega_cap',this)">Mega Cap</button>
    <button class="preset-btn" onclick="loadPreset('blue_chip',this)">Blue Chip</button>
    <button class="preset-btn" onclick="loadPreset('growth',this)">Growth</button>
    <button class="preset-btn" onclick="loadPreset('finance',this)">Finance</button>
    <button class="preset-btn" onclick="loadPreset('energy',this)">Energy</button>
    <button class="preset-btn" onclick="loadPreset('healthcare',this)">Healthcare</button>
    <button class="preset-btn" onclick="loadPreset('reits',this)">REITs</button>
  </div>

  <div class="input-row">
    <input id="tickerInput" placeholder="AAPL, MSFT, GOOGL, AMZN... (comma-separated)">
    <button class="scan-btn" id="scanBtn" onclick="runScan()">Scan</button>
    <button class="deep-btn" id="exportBtn" onclick="exportBrief()" disabled>üìã Export Brief</button>
  </div>

  <div id="errorContainer"></div>
  <div id="progressContainer"></div>
  <div id="summaryContainer"></div>
  <div id="resultsContainer"></div>

  <div id="emptyState">
    <div class="empty-state">
      <div class="icon">ü©∏</div>
      <p>Select a preset watchlist or enter tickers to scan<br>Finds quality stocks trading at beaten-down prices</p>
    </div>
  </div>

  <div class="footer-note">Powered by yfinance ¬∑ Fundamental + price cross analysis ¬∑ Buffett value model</div>
</div>

<script>
const BACKEND = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? '' : 'https://analysisgrid-production.up.railway.app';

const PRESETS = {
  mega_cap:  ['AAPL','MSFT','GOOGL','AMZN','NVDA','META','TSLA','BRK-B','JPM','V'],
  blue_chip: ['JNJ','PG','KO','PEP','WMT','MCD','HD','UNH','ABBV','MRK'],
  growth:    ['CRM','ADBE','NOW','PANW','SNOW','DDOG','NET','CRWD','ZS','SHOP'],
  finance:   ['JPM','BAC','GS','MS','WFC','C','BLK','SCHW','AXP','USB'],
  energy:    ['XOM','CVX','COP','EOG','SLB','OXY','MPC','PSX','VLO','DVN'],
  healthcare:['UNH','JNJ','LLY','ABBV','MRK','PFE','TMO','ABT','DHR','BMY'],
  reits:     ['O','AMT','PLD','CCI','SPG','EQIX','DLR','PSA','WELL','AVB'],
};

let scanResults = [];
let scanMeta = null;
let currentSort = { key: 'compositeScore', dir: 'desc' };

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('tickerInput').addEventListener('keydown', e => { if (e.key === 'Enter') runScan(); });
});

function loadPreset(key, btn) {
  const tickers = PRESETS[key];
  if (!tickers) return;
  document.getElementById('tickerInput').value = tickers.join(', ');
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function showError(msg) {
  document.getElementById('errorContainer').innerHTML = `<div class="error">‚ö†Ô∏è ${msg}</div>`;
}

async function runScan() {
  const input = document.getElementById('tickerInput').value.trim();
  if (!input) { showError('Enter at least one ticker'); return; }

  const tickers = input.split(/[,\s]+/).filter(Boolean).map(t => t.toUpperCase());
  if (tickers.length > 30) { showError('Max 30 tickers per scan'); return; }

  const btn = document.getElementById('scanBtn');
  btn.disabled = true; btn.textContent = 'Scanning...';
  document.getElementById('errorContainer').innerHTML = '';
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('summaryContainer').innerHTML = '';
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('progressContainer').innerHTML = `
    <div class="progress"><div class="spinner"></div><br>Scanning ${tickers.length} ticker${tickers.length>1?'s':''}... This may take 15-30 seconds</div>`;

  try {
    const resp = await fetch(`${BACKEND}/api/buffett-scan?tickers=${tickers.join(',')}`);
    if (!resp.ok) throw new Error(`Server error: ${resp.status}`);
    const data = await resp.json();

    scanResults = data.results || [];
    scanMeta = data.meta || {};

    if (scanResults.length === 0) {
      showError('No results returned. Check ticker symbols.');
      return;
    }

    renderSummary(data);
    renderResults();
    document.getElementById('exportBtn').disabled = false;

    if (data.errors?.length) {
      const errs = data.errors.map(e => `${e.ticker}: ${e.error}`).join(', ');
      document.getElementById('errorContainer').innerHTML = `<div class="error" style="background:rgba(245,158,11,0.1);border-color:rgba(245,158,11,0.3);color:var(--orange)">‚ö†Ô∏è Failed: ${errs}</div>`;
    }

  } catch(e) { showError(e.message); }
  finally { document.getElementById('progressContainer').innerHTML = ''; btn.disabled = false; btn.textContent = 'Scan'; }
}

/* ‚îÄ‚îÄ Summary ‚îÄ‚îÄ */
function renderSummary(data) {
  const r = data.results;
  const deep = r.filter(x => x.signal === 'DEEP VALUE').length;
  const value = r.filter(x => x.signal === 'VALUE').length;
  const blood = r.filter(x => x.signal === 'BLOOD ONLY').length;
  const avgComp = r.length ? Math.round(r.reduce((s,x) => s + x.compositeScore, 0) / r.length) : 0;
  const avgBlood = r.length ? Math.round(r.reduce((s,x) => s + x.bloodScore, 0) / r.length) : 0;
  const topGrade = r.length ? r[0].grade : '‚Äî';

  document.getElementById('summaryContainer').innerHTML = `
    <div class="summary-row">
      <div class="sum-card"><div class="sv" style="color:var(--accent)">${r.length}</div><div class="sl">Scanned</div></div>
      <div class="sum-card"><div class="sv" style="color:var(--green)">${deep}</div><div class="sl">Deep Value</div></div>
      <div class="sum-card"><div class="sv" style="color:#4ade80">${value}</div><div class="sl">Value</div></div>
      ${blood ? '<div class="sum-card"><div class="sv" style="color:var(--orange)">'+blood+'</div><div class="sl">Blood Only</div></div>' : ''}
      <div class="sum-card"><div class="sv" style="color:var(--purple)">${avgComp}</div><div class="sl">Avg Score</div></div>
      <div class="sum-card"><div class="sv" style="color:var(--red)">${avgBlood}</div><div class="sl">Avg Blood</div></div>
      <div class="sum-card"><div class="sv" style="color:${gradeColor(topGrade)}">${topGrade}</div><div class="sl">Top Grade</div></div>
    </div>`;
}

/* ‚îÄ‚îÄ Results Table ‚îÄ‚îÄ */
function renderResults() {
  const sorted = [...scanResults].sort((a, b) => {
    let va = a[currentSort.key] ?? 0, vb = b[currentSort.key] ?? 0;
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toString().toLowerCase(); return currentSort.dir === 'desc' ? vb.localeCompare(va) : va.localeCompare(vb); }
    return currentSort.dir === 'desc' ? vb - va : va - vb;
  });

  const arrow = k => currentSort.key === k ? (currentSort.dir === 'desc' ? ' ‚ñº' : ' ‚ñ≤') : '';
  const ac = k => currentSort.key === k ? ' sort-active' : '';

  let html = `<div class="results-header">
    <span>#</span>
    <span class="${ac('ticker')}" onclick="sortBy('ticker')">Ticker${arrow('ticker')}</span>
    <span>Name</span>
    <span class="${ac('price')}" onclick="sortBy('price')">Price${arrow('price')}</span>
    <span class="${ac('drawdownPct')}" onclick="sortBy('drawdownPct')">DD%${arrow('drawdownPct')}</span>
    <span class="${ac('fundamentalScore')}" onclick="sortBy('fundamentalScore')">Fund${arrow('fundamentalScore')}</span>
    <span class="${ac('bloodScore')}" onclick="sortBy('bloodScore')">Blood${arrow('bloodScore')}</span>
    <span class="${ac('compositeScore')}" onclick="sortBy('compositeScore')">Score${arrow('compositeScore')}</span>
    <span class="${ac('grade')}" onclick="sortBy('grade')">Grd${arrow('grade')}</span>
    <span>Signal</span>
  </div>`;

  sorted.forEach((r, i) => {
    const sigClass = r.signal === 'DEEP VALUE' ? 'sig-deep' : r.signal === 'VALUE' ? 'sig-value' : r.signal === 'BLOOD ONLY' ? 'sig-blood' : r.signal === 'FAIR' ? 'sig-fair' : r.signal === 'OVERVALUED' ? 'sig-over' : 'sig-neutral';
    const ddStr = (r.drawdownPct * 100).toFixed(1) + '%';

    html += `<div class="result-row" onclick="toggleDetail('${r.ticker}')">
      <span class="rk">${i+1}</span>
      <span class="tk">${r.ticker}</span>
      <span class="nm">${r.name}</span>
      <span class="pr">$${r.price.toFixed(2)}</span>
      <span class="dd">${ddStr}</span>
      <span class="sc" style="color:${scoreColor(r.fundamentalScore)}">${r.fundamentalScore}</span>
      <span class="sc" style="color:${scoreColor(r.bloodScore)}">${r.bloodScore}</span>
      <span class="sc" style="color:${scoreColor(r.compositeScore)}">${r.compositeScore}</span>
      <span class="gr" style="color:${gradeColor(r.grade)}">${r.grade}</span>
      <span><span class="signal-badge ${sigClass}">${r.signal}</span></span>
    </div>
    <div class="detail-panel" id="detail-${r.ticker}">${buildDetail(r)}</div>`;
  });

  document.getElementById('resultsContainer').innerHTML = html;
}

function sortBy(key) {
  if (currentSort.key === key) currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc';
  else { currentSort.key = key; currentSort.dir = 'desc'; }
  renderResults();
}

function toggleDetail(ticker) {
  const el = document.getElementById(`detail-${ticker}`);
  if (!el) return;
  if (el.classList.contains('open')) {
    el.classList.remove('open'); el.style.maxHeight = '0';
  } else {
    el.classList.add('open'); el.style.maxHeight = el.scrollHeight + 'px';
  }
}

/* ‚îÄ‚îÄ Detail Panel ‚îÄ‚îÄ */
function buildDetail(r) {
  // Fundamental score cards
  const fundCards = [
    { label: 'P/E Ratio', val: r.pe ? r.pe.toFixed(1)+'x' : 'N/A', score: r.peScore, sub: r.forwardPe ? 'Fwd: '+r.forwardPe.toFixed(1)+'x' : '' },
    { label: 'Price/Book', val: r.pb ? r.pb.toFixed(2)+'x' : 'N/A', score: r.pbScore, sub: '' },
    { label: 'ROE', val: r.roe != null ? (r.roe*100).toFixed(1)+'%' : 'N/A', score: r.roeScore, sub: r.roa != null ? 'ROA: '+(r.roa*100).toFixed(1)+'%' : '' },
    { label: 'Profit Margin', val: r.profitMargin != null ? (r.profitMargin*100).toFixed(1)+'%' : 'N/A', score: r.marginScore, sub: r.operatingMargin != null ? 'Op: '+(r.operatingMargin*100).toFixed(1)+'%' : '' },
    { label: 'Debt/Equity', val: r.debtEquity != null ? (r.debtEquity/100).toFixed(2)+'x' : 'N/A', score: r.debtScore, sub: r.currentRatio ? 'CR: '+r.currentRatio.toFixed(2) : '' },
    { label: 'FCF Yield', val: r.fcfYield != null ? (r.fcfYield*100).toFixed(2)+'%' : 'N/A', score: r.fcfScore, sub: r.fcfDebtAdjusted ? '‚ö†Ô∏è Debt-adjusted' : (r.dividendYield ? 'Div: '+(r.dividendYield*100).toFixed(2)+'%' : '') },
  ];

  // Blood score cards
  const bloodCards = [
    { label: 'Drawdown', val: (r.drawdownPct*100).toFixed(1)+'%', score: r.drawdownScore, sub: 'From 52w high' },
    { label: 'Momentum', val: (r.return1m*100).toFixed(1)+'% (1m)', score: r.momentumScore, sub: (r.return3m*100).toFixed(1)+'% (3m)' },
    { label: 'vs 200 SMA', val: (r.priceVsSma200*100).toFixed(1)+'%', score: r.smaScore, sub: '$'+r.sma200.toFixed(2) },
    { label: 'Vol Spike', val: r.recentVolRatio.toFixed(1)+'x avg', score: r.volScore, sub: 'Last 5 days' },
  ];

  let fundHTML = fundCards.map(c => `<div class="sc-card">
    <div class="scv" style="color:${scoreColor(c.score)}">${c.score}</div>
    <div class="scl">${c.label}</div>
    <div class="scs">${c.val}</div>
    ${c.sub ? '<div class="scs">'+c.sub+'</div>' : ''}
    <div class="sc-bar"><div style="width:${c.score}%;background:${barColor(c.score)}"></div></div>
  </div>`).join('');

  let bloodHTML = bloodCards.map(c => `<div class="sc-card" style="border-color:rgba(220,38,38,0.15)">
    <div class="scv" style="color:${scoreColor(c.score)}">${c.score}</div>
    <div class="scl">${c.label}</div>
    <div class="scs">${c.val}</div>
    ${c.sub ? '<div class="scs">'+c.sub+'</div>' : ''}
    <div class="sc-bar"><div style="width:${c.score}%;background:${barColor(c.score)}"></div></div>
  </div>`).join('');

  // 52-week range bar
  const rangePos = Math.max(0, Math.min(100, r.rangePosition * 100));
  const rangeHTML = `<div class="range-bar-wrap">
    <div class="range-bar-label"><span>$${r.low52w.toFixed(2)} (52w Low)</span><span>$${r.high52w.toFixed(2)} (52w High)</span></div>
    <div class="range-bar"><div class="range-dot" style="left:${rangePos}%"></div></div>
    <div style="text-align:center;margin-top:6px;font-size:0.75rem;color:var(--accent);font-family:'JetBrains Mono',monospace">Current: $${r.price.toFixed(2)} (${rangePos.toFixed(0)}% of range)</div>
  </div>`;

  // Key metrics
  const mets = [
    ['Sector', r.sector], ['Industry', r.industry],
    ['Market Cap', r.marketCapFmt], ['Dividend Yield', r.dividendYield ? (r.dividendYield*100).toFixed(2)+'%' : 'N/A'],
    ['Revenue Growth', r.revenueGrowth != null ? (r.revenueGrowth*100).toFixed(1)+'%' : 'N/A'],
    ['Earnings Growth', r.earningsGrowth != null ? (r.earningsGrowth*100).toFixed(1)+'%' : 'N/A'],
    ['50 SMA', '$'+r.sma50.toFixed(2)], ['200 SMA', '$'+r.sma200.toFixed(2)],
    ['6M Return', (r.return6m*100).toFixed(1)+'%'], ['Payout Ratio', r.payoutRatio ? (r.payoutRatio*100).toFixed(0)+'%' : 'N/A'],
  ];
  let metsHTML = mets.map(m => `<div class="metric-row"><span class="mk">${m[0]}</span><span class="mv">${m[1]}</span></div>`).join('');

  // Verdict
  const verdict = buildVerdict(r);

  return `<div class="detail-inner">
    <div class="detail-section"><h5>üìä Fundamental Scores (${r.fundamentalScore}/100)</h5><div class="score-grid">${fundHTML}</div></div>
    <div class="detail-section"><h5>ü©∏ Blood Scores (${r.bloodScore}/100)</h5><div class="score-grid">${bloodHTML}</div></div>
    <div class="detail-section"><h5>üìê 52-Week Range Position</h5>${rangeHTML}</div>
    <div class="detail-section"><h5>üìã Key Metrics</h5><div class="metrics-grid">${metsHTML}</div></div>
    <div class="detail-section"><h5>‚öñÔ∏è Verdict</h5><div class="verdict">${verdict}</div></div>
  </div>`;
}

function buildVerdict(r) {
  const parts = [];
  if (r.signal === 'DEEP VALUE') parts.push(`<strong>${r.ticker}</strong> scores <strong>Grade ${r.grade}</strong> ‚Äî a potential deep-value opportunity. Strong fundamentals (${r.fundamentalScore}/100) with validated valuations combined with significant price distress (${r.bloodScore}/100 blood score) suggest the market may be overreacting.`);
  else if (r.signal === 'VALUE') parts.push(`<strong>${r.ticker}</strong> scores <strong>Grade ${r.grade}</strong> ‚Äî showing value characteristics. Decent fundamentals (${r.fundamentalScore}/100) with reasonable valuation ratios and moderate price weakness (${r.bloodScore}/100) create a potential entry point.`);
  else if (r.signal === 'BLOOD ONLY') parts.push(`<strong>${r.ticker}</strong> scores <strong>Grade ${r.grade}</strong> ‚Äî beaten down but <strong>fundamentals don't justify a value label</strong>. Elevated P/E or P/B means the blood reading (${r.bloodScore}/100) is driven by price decline alone, not by genuine undervaluation. Worth monitoring if fundamentals improve.`);
  else if (r.signal === 'FAIR') parts.push(`<strong>${r.ticker}</strong> scores <strong>Grade ${r.grade}</strong> ‚Äî fairly valued at current levels. ${r.fundamentalScore >= 50 ? 'Fundamentals are solid' : 'Fundamentals need watching'}, but ${r.bloodScore >= 40 ? 'price has pulled back' : 'no significant price distress yet'}.`);
  else if (r.signal === 'OVERVALUED') parts.push(`<strong>${r.ticker}</strong> scores <strong>Grade ${r.grade}</strong> ‚Äî appears overvalued. Weak fundamental score (${r.fundamentalScore}/100) suggests paying a premium for current earnings.`);
  else parts.push(`<strong>${r.ticker}</strong> scores <strong>Grade ${r.grade}</strong> ‚Äî neutral setup. Composite score ${r.compositeScore}/100.`);

  if (Math.abs(r.drawdownPct) > 0.20) parts.push(`Down <strong>${(Math.abs(r.drawdownPct)*100).toFixed(1)}%</strong> from 52-week high ‚Äî significant capitulation detected.`);
  if (r.pe && r.pe > 0 && r.pe < 15) parts.push(`P/E of <strong>${r.pe.toFixed(1)}x</strong> is well below market average ‚Äî classic Buffett value territory.`);
  else if (r.pe && r.pe > 28) parts.push(`P/E of <strong>${r.pe.toFixed(1)}x</strong> is elevated ‚Äî valuation cap prevents a value signal regardless of blood score.`);
  if (r.pb && r.pb > 8) parts.push(`P/B of <strong>${r.pb.toFixed(2)}x</strong> is steep ‚Äî hard to justify deep value at this book multiple.`);
  if (r.roe && r.roe > 0.20) parts.push(`ROE of <strong>${(r.roe*100).toFixed(1)}%</strong> indicates a high-quality business with a durable competitive advantage.`);
  if (r.debtEquity != null && r.debtEquity < 50) parts.push(`Low debt/equity (<strong>${(r.debtEquity/100).toFixed(2)}x</strong>) ‚Äî strong balance sheet, Buffett approved.`);
  else if (r.debtEquity != null && r.debtEquity > 200) parts.push(`Debt/equity of <strong>${(r.debtEquity/100).toFixed(2)}x</strong> is dangerously high ‚Äî FCF may be debt-service inflated.`);
  if (r.fcfDebtAdjusted) parts.push(`‚ö†Ô∏è FCF score was <strong>haircut for heavy debt load</strong> ‚Äî reported free cash flow may overstate true financial health.`);
  if (r.priceVsSma200 < -0.10) parts.push(`Trading <strong>${(Math.abs(r.priceVsSma200)*100).toFixed(1)}%</strong> below 200-day SMA ‚Äî well below long-term trend.`);

  return parts.join(' ');
}

/* ‚îÄ‚îÄ Export Brief ‚îÄ‚îÄ */
function exportBrief() {
  if (!scanResults.length) return;
  const tickers = scanResults.map(r => r.ticker).join(', ');
  const today = new Date().toLocaleDateString('en-US', {month:'long',day:'numeric',year:'numeric'});
  const deep = scanResults.filter(r => r.signal === 'DEEP VALUE');
  const value = scanResults.filter(r => r.signal === 'VALUE');
  const bloodOnly = scanResults.filter(r => r.signal === 'BLOOD ONLY');

  let b = `BUFFETT BLOOD SCAN ‚Äî ${tickers}\n`;
  b += `Scanned: ${today}\n`;
  b += `${'‚ïê'.repeat(70)}\n\n`;

  b += `SUMMARY\n${'‚îÄ'.repeat(40)}\n`;
  b += `  Tickers Scanned: ${scanResults.length}\n`;
  b += `  Deep Value:      ${deep.length}${deep.length ? ' ('+deep.map(r=>r.ticker).join(', ')+')' : ''}\n`;
  b += `  Value:           ${value.length}${value.length ? ' ('+value.map(r=>r.ticker).join(', ')+')' : ''}\n`;
  b += `  Blood Only:      ${bloodOnly.length}${bloodOnly.length ? ' ('+bloodOnly.map(r=>r.ticker).join(', ')+') ‚Äî beaten down but weak fundamentals' : ''}\n`;
  const avgC = Math.round(scanResults.reduce((s,r) => s+r.compositeScore, 0) / scanResults.length);
  b += `  Avg Composite:   ${avgC}/100\n\n`;

  if (scanResults.length > 1) {
    b += `RANKING\n${'‚îÄ'.repeat(40)}\n`;
    b += 'Rank'.padEnd(6)+'Ticker'.padEnd(8)+'Price'.padEnd(10)+'DD%'.padEnd(9)+'Fund'.padEnd(6)+'Blood'.padEnd(7)+'Score'.padEnd(7)+'Grade'.padEnd(6)+'Signal\n';
    scanResults.forEach((r,i) => {
      b += String(i+1).padEnd(6)+r.ticker.padEnd(8)+('$'+r.price.toFixed(2)).padEnd(10)+((r.drawdownPct*100).toFixed(1)+'%').padEnd(9)+String(r.fundamentalScore).padEnd(6)+String(r.bloodScore).padEnd(7)+String(r.compositeScore).padEnd(7)+r.grade.padEnd(6)+r.signal+'\n';
    });
    b += '\n';
  }

  scanResults.forEach(r => {
    b += `${'‚ïê'.repeat(70)}\n`;
    b += `${r.ticker} ‚Äî ${r.name} (${r.sector})\n`;
    b += `${'‚ïê'.repeat(70)}\n\n`;
    b += `  Price: $${r.price.toFixed(2)} | Grade: ${r.grade} | Signal: ${r.signal}\n`;
    b += `  Composite: ${r.compositeScore}/100 (Fundamental: ${r.fundamentalScore} | Blood: ${r.bloodScore})\n\n`;

    b += `  FUNDAMENTALS\n`;
    b += `  P/E:           ${r.pe ? r.pe.toFixed(1)+'x' : 'N/A'}`.padEnd(32)+`‚Üí Score: ${r.peScore}/100\n`;
    b += `  Forward P/E:   ${r.forwardPe ? r.forwardPe.toFixed(1)+'x' : 'N/A'}\n`;
    b += `  P/B:           ${r.pb ? r.pb.toFixed(2)+'x' : 'N/A'}`.padEnd(32)+`‚Üí Score: ${r.pbScore}/100\n`;
    b += `  ROE:           ${r.roe != null ? (r.roe*100).toFixed(1)+'%' : 'N/A'}`.padEnd(32)+`‚Üí Score: ${r.roeScore}/100\n`;
    b += `  Profit Margin: ${r.profitMargin != null ? (r.profitMargin*100).toFixed(1)+'%' : 'N/A'}`.padEnd(32)+`‚Üí Score: ${r.marginScore}/100\n`;
    b += `  Debt/Equity:   ${r.debtEquity != null ? (r.debtEquity/100).toFixed(2)+'x' : 'N/A'}`.padEnd(32)+`‚Üí Score: ${r.debtScore}/100\n`;
    b += `  FCF Yield:     ${r.fcfYield != null ? (r.fcfYield*100).toFixed(2)+'%' : 'N/A'}`.padEnd(32)+`‚Üí Score: ${r.fcfScore}/100\n\n`;

    b += `  BLOOD METRICS\n`;
    b += `  52w Drawdown:  ${(r.drawdownPct*100).toFixed(1)}%`.padEnd(32)+`‚Üí Score: ${r.drawdownScore}/100\n`;
    b += `  1M Return:     ${(r.return1m*100).toFixed(1)}%`.padEnd(32)+`‚Üí Score: ${r.momentumScore}/100\n`;
    b += `  3M Return:     ${(r.return3m*100).toFixed(1)}%\n`;
    b += `  vs 200 SMA:    ${(r.priceVsSma200*100).toFixed(1)}%`.padEnd(32)+`‚Üí Score: ${r.smaScore}/100\n`;
    b += `  Vol Ratio:     ${r.recentVolRatio.toFixed(1)}x avg`.padEnd(32)+`‚Üí Score: ${r.volScore}/100\n\n`;

    b += `  KEY LEVELS\n`;
    b += `  52-Week High:  $${r.high52w.toFixed(2)}\n`;
    b += `  200 SMA:       $${r.sma200.toFixed(2)}\n`;
    b += `  50 SMA:        $${r.sma50.toFixed(2)}\n`;
    b += `  ‚ñ∫ CURRENT:     $${r.price.toFixed(2)}\n`;
    b += `  52-Week Low:   $${r.low52w.toFixed(2)}\n`;
    b += `  Range Position: ${(r.rangePosition*100).toFixed(0)}% (${r.rangePosition > 0.7 ? 'near highs' : r.rangePosition > 0.3 ? 'mid-range' : 'near lows'})\n`;
    b += '\n';
  });

  b += `${'‚ïê'.repeat(70)}\n`;
  b += `Paste this to Claude for deep value analysis with latest market context.\n`;

  navigator.clipboard.writeText(b).then(() => {
    const btn = document.getElementById('exportBtn');
    btn.textContent = '‚úì Copied!'; btn.classList.add('copied');
    showToast('Brief copied ‚Äî paste to Claude for deep analysis');
    setTimeout(() => { btn.textContent = 'üìã Export Brief'; btn.classList.remove('copied'); }, 2500);
  }).catch(() => {
    const blob = new Blob([b], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `buffett-scan-${scanResults.map(r=>r.ticker).join('-')}.txt`;
    a.click(); URL.revokeObjectURL(url);
    showToast('Brief downloaded as text file');
  });
}

/* ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ */
function scoreColor(v) { return v >= 70 ? 'var(--green)' : v >= 50 ? 'var(--accent)' : v >= 30 ? 'var(--orange)' : 'var(--red)'; }
function barColor(v) { return v >= 70 ? '#22c55e' : v >= 50 ? '#3b82f6' : v >= 30 ? '#f59e0b' : '#ef4444'; }
function gradeColor(g) {
  if (g === 'A+' || g === 'A') return 'var(--green)';
  if (g === 'B+' || g === 'B') return 'var(--accent)';
  if (g === 'C') return 'var(--orange)';
  return 'var(--red)';
}

function showToast(msg) {
  let t = document.getElementById('toast');
  if (!t) { t = document.createElement('div'); t.id = 'toast'; t.className = 'toast'; document.body.appendChild(t); }
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
