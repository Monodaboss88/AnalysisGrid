<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backtest Lab | SEF</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="config.js"></script>
<style>
:root {
    --bg: #0a0a0f; --bg-card: #12121a; --bg-input: #1a1a2e;
    --border: #1e1e30; --text: #e2e8f0; --text-secondary: #94a3b8;
    --text-muted: #64748b; --blue: #3b82f6; --cyan: #06b6d4;
    --green: #10b981; --red: #ef4444; --amber: #f59e0b; --purple: #8b5cf6;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

.header {
    padding: 24px 32px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
}
.header h1 { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 700; }
.header h1 span { color: var(--purple); }
.back-link { color: var(--text-muted); text-decoration: none; font-size: 13px; }
.back-link:hover { color: var(--text); }

/* CONFIG PANEL */
.config-panel {
    padding: 24px 32px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
}
.config-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
.config-group { display: flex; flex-direction: column; gap: 4px; }
.config-group label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-family: 'DM Mono', monospace; }
.config-group input, .config-group select {
    background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 12px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px;
    outline: none;
}
.config-group input:focus, .config-group select:focus { border-color: var(--purple); }
.config-group input[type="text"] { width: 280px; }
.config-group input[type="number"] { width: 80px; }

.run-btn {
    background: linear-gradient(135deg, var(--purple), #6366f1);
    color: white; border: none; border-radius: 8px; padding: 10px 24px;
    font-weight: 600; font-size: 14px; cursor: pointer; font-family: 'Outfit', sans-serif;
    transition: transform 0.1s, opacity 0.2s; margin-left: auto;
}
.run-btn:hover { transform: scale(1.02); }
.run-btn:disabled { opacity: 0.5; cursor: wait; }

.add-rule-btn {
    background: var(--bg-input); border: 1px dashed var(--border); border-radius: 6px;
    padding: 6px 14px; font-size: 12px; color: var(--purple); cursor: pointer;
    font-family: 'DM Mono', monospace; transition: all 0.2s;
}
.add-rule-btn:hover { border-color: var(--purple); background: rgba(139,92,246,0.08); }
.rule-row {
    display: flex; gap: 8px; align-items: center; margin-bottom: 6px;
    padding: 8px 10px; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 8px; flex-wrap: wrap;
}
.rule-row select, .rule-row input {
    background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    padding: 5px 8px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px;
    outline: none;
}
.rule-row select:focus, .rule-row input:focus { border-color: var(--purple); }
.rule-row input[type="number"] { width: 70px; }
.rule-row select { width: 160px; }
.rule-label { font-size: 11px; color: var(--text-secondary); min-width: 30px; text-align: center; }
.rule-remove {
    background: none; border: none; color: var(--red); cursor: pointer;
    font-size: 16px; padding: 2px 6px; opacity: 0.5; transition: opacity 0.2s;
}
.rule-remove:hover { opacity: 1; }

.ai-insight-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; border-radius: 8px; padding: 10px 20px;
    font-weight: 600; font-size: 13px; cursor: pointer; font-family: 'Outfit', sans-serif;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
}
.ai-insight-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(139,92,246,0.3); }
.ai-insight-btn:disabled { opacity: 0.5; cursor: wait; }
.ai-insight-box {
    background: var(--bg-card); border: 1px solid var(--purple); border-radius: 12px;
    padding: 20px; margin: 16px 0; font-size: 13px; line-height: 1.7;
    color: var(--text); font-family: 'Outfit', sans-serif;
}
.ai-insight-box h3 { color: var(--purple); font-size: 14px; margin-bottom: 10px; font-family: 'Space Grotesk', sans-serif; }
.ai-insight-box ul { padding-left: 18px; }
.ai-insight-box li { margin-bottom: 6px; }
.ai-insight-box strong { color: var(--cyan); }

/* OHLC ANALYSIS TABLE */
.ohlc-table { font-size: 11px; }
.ohlc-table th { font-size: 9px; white-space: nowrap; }
.ohlc-table td { padding: 6px 8px; white-space: nowrap; }
.ohlc-table .filter-hit td { background: rgba(139,92,246,0.08); }
.gap-up { color: var(--green); } .gap-down { color: var(--red); } .gap-flat { color: var(--text-muted); }
.ohlc-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
.ohlc-summary-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
.ohlc-summary-item .val { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 700; }
.ohlc-summary-item .lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 3px; font-family: 'DM Mono', monospace; }

/* CROSS ANALYSIS */
.cross-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 12px; font-family: 'DM Mono', monospace; }
.cross-date { width: 80px; color: var(--text-secondary); }
.cross-bar-bg { flex: 1; height: 22px; background: var(--bg-input); border-radius: 4px; position: relative; overflow: hidden; }
.cross-bar-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; padding-left: 6px; font-size: 10px; color: white; font-weight: 600; min-width: 20px; }
.cross-count { width: 30px; text-align: right; font-weight: 600; }
.hour-bar-row { display: flex; align-items: flex-end; gap: 2px; height: 100px; padding:8px 0; }
.hour-bar { flex: 1; background: var(--purple); border-radius: 3px 3px 0 0; min-width: 16px; position: relative; transition: all 0.2s; }
.hour-bar:hover { opacity: 0.8; }
.hour-label { font-size: 9px; color: var(--text-muted); text-align: center; margin-top: 2px; }

.mode-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.mode-tab {
    padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 500;
    cursor: pointer; background: var(--bg-input); border: 1px solid var(--border);
    color: var(--text-secondary); transition: all 0.2s;
}
.mode-tab.active { background: var(--purple); color: white; border-color: var(--purple); }

/* RESULTS */
.results { padding: 24px 32px; }
.status-bar {
    font-size: 13px; color: var(--text-muted); padding: 12px 0;
    font-family: 'DM Mono', monospace;
}
.status-bar.running { color: var(--amber); }
.status-bar.done { color: var(--green); }
.status-bar.error { color: var(--red); }

/* SCORECARD */
.scorecard {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 24px;
}
.score-tile {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px; text-align: center;
}
.score-tile .val { font-family: 'Space Grotesk', sans-serif; font-size: 24px; font-weight: 700; }
.score-tile .lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; font-family: 'DM Mono', monospace; }

/* EQUITY CURVE */
.equity-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin-bottom: 24px;
}
.equity-card h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; font-family: 'Space Grotesk', sans-serif; }
.equity-svg { width: 100%; height: 200px; }

/* TRADE TABLE */
.trades-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin-bottom: 24px; overflow-x: auto;
}
.trades-card h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; font-family: 'Space Grotesk', sans-serif; }
table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: 'DM Mono', monospace; }
th { text-align: left; padding: 8px 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; border-bottom: 1px solid var(--border); }
td { padding: 8px 10px; border-bottom: 1px solid rgba(30,30,48,0.5); }
tr:hover td { background: rgba(99,102,241,0.04); }
.win { color: var(--green); } .loss { color: var(--red); } .expired { color: var(--amber); }

/* BREAKDOWN */
.breakdown-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.breakdown-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;
}
.breakdown-card h3 { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; font-family: 'Space Grotesk', sans-serif; }
.breakdown-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 12px; border-bottom: 1px solid rgba(30,30,48,0.3); }
.breakdown-row .key { color: var(--text-secondary); }
.breakdown-row .val { font-family: 'DM Mono', monospace; }

/* LOADING */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border);
    border-top-color: var(--purple); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width: 768px) {
    .config-row { flex-direction: column; }
    .config-group input[type="text"] { width: 100%; }
    .breakdown-grid { grid-template-columns: 1fr; }
    .header, .config-panel, .results { padding-left: 16px; padding-right: 16px; }
}
</style>
</head>
<body>

<div class="header">
    <h1>üß™ Backtest <span>Lab</span></h1>
    <a href="/desk" class="back-link">‚Üê Back to Desk</a>
</div>

<div style="max-width:1200px;margin:0 auto 16px;padding:0 24px;">
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:18px 22px;font-size:12px;line-height:1.7;color:var(--text-secondary);font-family:'DM Mono',monospace;">
        <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:8px;font-family:'Space Grotesk',sans-serif;">üìñ What This Tool Does</div>
        <div style="margin-bottom:10px;">
            A quantitative price-action analysis toolkit using <strong style="color:var(--text)">applied arithmetic</strong>, <strong style="color:var(--text)">descriptive statistics</strong>, and <strong style="color:var(--text)">technical indicators</strong> over historical price bars from Polygon.io.
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px 20px;">
            <div><span style="color:var(--purple);font-weight:700;">Strategy Test</span> ‚Äî Run scanner signals over historical data, simulate entries/exits with stop &amp; target, compute win rate, expectancy, R-multiples, and equity curve.</div>
            <div><span style="color:var(--purple);font-weight:700;">Custom Rules</span> ‚Äî Define rule-based filters (% move off open, RSI range, RVOL, gap, SMA) and backtest with ATR-based stops &amp; R:R targets. Supports no-stop and no-target modes.</div>
            <div><span style="color:var(--purple);font-weight:700;">Stats Scanner</span> ‚Äî Pure probability mode. Counts every qualifying day with no cooldown, no stops ‚Äî just frequency, green/red splits, and next-day follow-through.</div>
            <div><span style="color:var(--purple);font-weight:700;">Cross Analysis</span> ‚Äî Uses 1-minute intraday bars to count how many times price crosses the opening price each day. Shows directional vs choppy days and hourly distribution.</div>
            <div><span style="color:var(--purple);font-weight:700;">OHLC Analysis</span> ‚Äî Daily OHLC breakdown with previous close, gap analysis (open vs prior close), open-to-high/low moves in $ and %, and a configurable high-off-open filter.</div>
            <div><span style="color:var(--purple);font-weight:700;">Replay Journal</span> ‚Äî Validate past trades against actual price data. Replays your entries through real bars to verify outcomes.</div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:var(--text-muted);">
            Math used: percentage change, rolling averages (SMA), RSI, ATR, R-multiples, conditional frequency, gap ratios, win rate, expectancy. Data: Polygon.io REST API (daily + 1m bars).
        </div>
    </div>
</div>

<div class="config-panel">
    <div class="mode-tabs">
        <div class="mode-tab active" onclick="setMode('strategy', this)">Strategy Test</div>
        <div class="mode-tab" onclick="setMode('custom', this)">Custom Rules</div>
        <div class="mode-tab" onclick="setMode('stats', this)">Stats Scanner</div>
        <div class="mode-tab" onclick="setMode('cross', this)">Cross Analysis</div>
        <div class="mode-tab" onclick="setMode('ohlc', this)">OHLC Analysis</div>
        <div class="mode-tab" onclick="setMode('replay', this)">Replay Journal</div>
    </div>

    <!-- Strategy Config -->
    <div id="strategy-config">
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="bt-symbols" value="AAPL, NVDA, TSLA, META, MSFT" placeholder="AAPL, NVDA, TSLA...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="bt-days" value="90" min="30" max="365">
            </div>
            <div class="config-group">
                <label>Signal Filter</label>
                <select id="bt-signal">
                    <option value="">All Signals</option>
                    <option value="GREEN" selected>GREEN Only</option>
                    <option value="RED">RED Only</option>
                    <option value="YELLOW">YELLOW Only</option>
                </select>
            </div>
            <div class="config-group">
                <label>Min Confidence</label>
                <input type="number" id="bt-confidence" value="50" min="0" max="100">
            </div>
            <div class="config-group">
                <label>Scan Every N Days</label>
                <input type="number" id="bt-interval" value="5" min="1" max="20">
            </div>
            <button class="run-btn" id="run-btn" onclick="runBacktest()">‚ñ∂ Run Backtest</button>
        </div>
    </div>

    <!-- Replay Config -->
    <div id="replay-config" style="display:none;">
        <div class="config-row">
            <div class="config-group">
                <label>Bar Interval</label>
                <select id="bt-replay-interval">
                    <option value="1d" selected>Daily</option>
                    <option value="1h">1 Hour</option>
                    <option value="15m">15 Min</option>
                    <option value="5m">5 Min</option>
                </select>
            </div>
            <div class="config-group">
                <label>Max Hold Bars</label>
                <input type="number" id="bt-replay-hold" value="60" min="10" max="500">
            </div>
            <button class="run-btn" id="replay-btn" onclick="runReplay()">‚ñ∂ Replay Journal</button>
        </div>
    </div>

    <!-- Custom Rules Config -->
    <div id="custom-config" style="display:none;">
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="cr-symbols" value="AAPL, NVDA, TSLA, META, MSFT" placeholder="AAPL, NVDA, TSLA...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="cr-days" value="90" min="30" max="365">
            </div>
            <div class="config-group">
                <label>Direction</label>
                <select id="cr-direction">
                    <option value="LONG" selected>LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
            </div>
            <div class="config-group">
                <label>R:R Ratio <span style="color:var(--text-muted);font-size:10px">(0 = no target)</span></label>
                <input type="number" id="cr-rr" value="2.0" min="0" max="10" step="0.5" placeholder="0 = ride">
            </div>
            <div class="config-group">
                <label>Stop (ATR mult) <span style="color:var(--text-muted);font-size:10px">(0 = no stop)</span></label>
                <input type="number" id="cr-stop-atr" value="1.5" min="0" max="5" step="0.25" placeholder="0 = none">
            </div>
        </div>

        <div style="margin:12px 0 6px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-family:'DM Mono',monospace;">
            Entry Rules <span style="color:var(--purple)">(all must pass)</span>
        </div>
        <div id="rules-list"></div>
        <div style="display:flex;gap:8px;margin:8px 0 12px;">
            <button class="add-rule-btn" onclick="addRule()">+ Add Rule</button>
        </div>

        <div class="config-row" style="margin-top:4px;">
            <button class="run-btn" id="custom-btn" onclick="runCustom()">‚ñ∂ Run Custom Backtest</button>
        </div>
    </div>

    <!-- Stats Scanner Config -->
    <div id="stats-config" style="display:none;">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-secondary);">
            Pure probability scanner ‚Äî counts every qualifying day, no stops or targets. Just frequency + what happened.
        </div>
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="st-symbols" value="IWM" placeholder="IWM, SPY, QQQ...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="st-days" value="30" min="10" max="365">
            </div>
            <div class="config-group">
                <label>Direction</label>
                <select id="st-direction">
                    <option value="LONG" selected>LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
            </div>
        </div>

        <div style="margin:12px 0 6px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-family:'DM Mono',monospace;">
            Filter Rules <span style="color:var(--purple)">(all must pass)</span>
        </div>
        <div id="stats-rules-list"></div>
        <div style="display:flex;gap:8px;margin:8px 0 12px;">
            <button class="add-rule-btn" onclick="addStatsRule()">+ Add Rule</button>
        </div>

        <div class="config-row" style="margin-top:4px;">
            <button class="run-btn" id="stats-btn" onclick="runStats()">‚ñ∂ Run Stats Scan</button>
        </div>
    </div>

    <!-- Cross Analysis Config -->
    <div id="cross-config" style="display:none;">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-secondary);">
            Intraday open-price cross scanner ‚Äî uses 1-minute bars to count how many times price crosses the opening price each day.
        </div>
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="cx-symbols" value="IWM" placeholder="IWM, SPY, QQQ...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="cx-days" value="20" min="5" max="60">
            </div>
        </div>
        <div class="config-row" style="margin-top:4px;">
            <button class="run-btn" id="cross-btn" onclick="runCrossAnalysis()">‚ñ∂ Run Cross Analysis</button>
        </div>
    </div>

    <!-- OHLC Analysis Config -->
    <div id="ohlc-config" style="display:none;">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-secondary);">
            Daily OHLC breakdown with previous close, gap analysis, open-to-high/low moves, and high-off-open filter.
        </div>
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="oh-symbols" value="IWM" placeholder="IWM, SPY, QQQ...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="oh-days" value="40" min="10" max="365">
            </div>
            <div class="config-group">
                <label>High-Off-Open Filter Min %</label>
                <input type="number" id="oh-filter-min" value="0.20" step="0.01" min="0">
            </div>
            <div class="config-group">
                <label>High-Off-Open Filter Max %</label>
                <input type="number" id="oh-filter-max" value="1.25" step="0.01" min="0">
            </div>
        </div>
        <div class="config-row" style="margin-top:4px;">
            <button class="run-btn" id="ohlc-btn" onclick="runOhlcAnalysis()">‚ñ∂ Run OHLC Analysis</button>
        </div>
    </div>
</div>

<div class="status-bar" id="status">Configure your backtest and hit Run.</div>
<div class="results" id="results"></div>

<script>
const API = typeof BACKEND !== 'undefined' ? BACKEND : '';
let currentMode = 'strategy';

function setMode(mode, el) {
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('strategy-config').style.display = mode === 'strategy' ? '' : 'none';
    document.getElementById('custom-config').style.display = mode === 'custom' ? '' : 'none';
    document.getElementById('stats-config').style.display = mode === 'stats' ? '' : 'none';
    document.getElementById('cross-config').style.display = mode === 'cross' ? '' : 'none';
    document.getElementById('ohlc-config').style.display = mode === 'ohlc' ? '' : 'none';
    document.getElementById('replay-config').style.display = mode === 'replay' ? '' : 'none';
}

// ‚îÄ‚îÄ Custom Rule Builder ‚îÄ‚îÄ
const RULE_DEFS = {
    move_off_open: { label: '% Move Off Open (Close)', params: [{key:'min_pct',label:'Min %',val:0.75},{key:'max_pct',label:'Max %',val:1.25}] },
    high_off_open: { label: '% High Off Open',        params: [{key:'min_pct',label:'Min %',val:0.75},{key:'max_pct',label:'Max %',val:1.25}] },
    low_off_open:  { label: '% Low Off Open',         params: [{key:'min_pct',label:'Min %',val:0.75},{key:'max_pct',label:'Max %',val:1.25}] },
    rsi_range:     { label: 'RSI Range',       params: [{key:'min_rsi',label:'Min',val:30},{key:'max_rsi',label:'Max',val:50}] },
    above_ma:      { label: 'Price Above SMA',  params: [{key:'period',label:'Period',val:20}] },
    below_ma:      { label: 'Price Below SMA',  params: [{key:'period',label:'Period',val:20}] },
    rvol_min:      { label: 'Min Rel. Volume',  params: [{key:'min_rvol',label:'Min',val:1.3}] },
    gap_up:        { label: 'Gap Up %',         params: [{key:'min_pct',label:'Min %',val:0.5}] },
    gap_down:      { label: 'Gap Down %',       params: [{key:'min_pct',label:'Min %',val:0.5}] },
    range_pct:     { label: 'Bar Range %',      params: [{key:'min_pct',label:'Min %',val:0.5},{key:'max_pct',label:'Max %',val:2.0}] },
};

let ruleCounter = 0;

function addRule(type = 'move_off_open') {
    ruleCounter++;
    const id = ruleCounter;
    const container = document.getElementById('rules-list');
    const row = document.createElement('div');
    row.className = 'rule-row';
    row.id = `rule-${id}`;

    let optionsHtml = '';
    for (const [k, v] of Object.entries(RULE_DEFS)) {
        optionsHtml += `<option value="${k}" ${k === type ? 'selected' : ''}>${v.label}</option>`;
    }

    row.innerHTML = `
        <select onchange="updateRuleParams(${id}, this.value)">${optionsHtml}</select>
        <span class="rule-params" id="rule-params-${id}"></span>
        <button class="rule-remove" onclick="removeRule(${id})">√ó</button>
    `;
    container.appendChild(row);
    updateRuleParams(id, type);
}

function updateRuleParams(id, type) {
    const def = RULE_DEFS[type];
    if (!def) return;
    const span = document.getElementById(`rule-params-${id}`);
    span.innerHTML = def.params.map(p =>
        `<span class="rule-label">${p.label}</span><input type="number" step="any" data-key="${p.key}" value="${p.val}">`
    ).join('');
}

function removeRule(id) {
    const el = document.getElementById(`rule-${id}`);
    if (el) el.remove();
}

function collectRules() {
    const rules = [];
    document.querySelectorAll('#rules-list .rule-row').forEach(row => {
        const type = row.querySelector('select').value;
        const rule = { type };
        row.querySelectorAll('input[data-key]').forEach(inp => {
            rule[inp.dataset.key] = parseFloat(inp.value) || 0;
        });
        rules.push(rule);
    });
    return rules;
}

// Seed one default rule
addRule('move_off_open');

// ‚îÄ‚îÄ Stats Scanner Rule Builder (separate rule list) ‚îÄ‚îÄ
let statsRuleCounter = 0;

function addStatsRule(type = 'high_off_open') {
    statsRuleCounter++;
    const id = statsRuleCounter;
    const container = document.getElementById('stats-rules-list');
    const row = document.createElement('div');
    row.className = 'rule-row';
    row.id = `stats-rule-${id}`;
    let optionsHtml = '';
    for (const [k, v] of Object.entries(RULE_DEFS)) {
        optionsHtml += `<option value="${k}" ${k === type ? 'selected' : ''}>${v.label}</option>`;
    }
    row.innerHTML = `
        <select onchange="updateStatsRuleParams(${id}, this.value)">${optionsHtml}</select>
        <span class="rule-params" id="stats-rule-params-${id}"></span>
        <button class="rule-remove" onclick="removeStatsRule(${id})">√ó</button>
    `;
    container.appendChild(row);
    updateStatsRuleParams(id, type);
}

function updateStatsRuleParams(id, type) {
    const def = RULE_DEFS[type];
    if (!def) return;
    const span = document.getElementById(`stats-rule-params-${id}`);
    span.innerHTML = def.params.map(p =>
        `<span class="rule-label">${p.label}</span><input type="number" step="any" data-key="${p.key}" value="${p.val}">`
    ).join('');
}

function removeStatsRule(id) {
    const el = document.getElementById(`stats-rule-${id}`);
    if (el) el.remove();
}

function collectStatsRules() {
    const rules = [];
    document.querySelectorAll('#stats-rules-list .rule-row').forEach(row => {
        const type = row.querySelector('select').value;
        const rule = { type };
        row.querySelectorAll('input[data-key]').forEach(inp => {
            rule[inp.dataset.key] = parseFloat(inp.value) || 0;
        });
        rules.push(rule);
    });
    return rules;
}

// Seed default stats rule
addStatsRule('high_off_open');

async function runStats() {
    const btn = document.getElementById('stats-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Scanning...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Scanning for qualifying days...';

    const symbols = document.getElementById('st-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const rules = collectStatsRules();
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('st-days').value),
        direction: document.getElementById('st-direction').value,
        rules,
    };

    try {
        const resp = await fetch(`${API}/api/backtest/stats`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderStatsResults(data);
        const ruleDesc = rules.map(r => r.type.replace(/_/g,' ')).join(' + ');
        status.className = 'status-bar done';
        status.textContent = `‚úÖ ${data.summary.qualifying_days} qualifying days out of ${data.summary.total_days_scanned} (${data.summary.frequency_pct}%) ‚Äî ${ruleDesc} ‚Äî ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Stats Scan';
}

function renderStatsResults(data) {
    const s = data.summary || {};
    const days = data.days || [];
    const meta = data.meta || {};
    const container = document.getElementById('results');

    let html = '';

    // Frequency scorecard
    html += '<div class="scorecard">';
    html += tile(s.qualifying_days, 'Qualifying Days', 'var(--cyan)');
    html += tile(s.total_days_scanned, 'Total Days Scanned');
    html += tile(`${s.frequency_pct}%`, 'Frequency', s.frequency_pct >= 40 ? 'var(--green)' : s.frequency_pct >= 20 ? 'var(--amber)' : 'var(--red)');
    html += tile(`${s.green_pct}%`, 'Closed Green', s.green_pct >= 55 ? 'var(--green)' : 'var(--amber)');
    html += tile(s.closed_green, 'Green Days', 'var(--green)');
    html += tile(s.closed_red, 'Red Days', 'var(--red)');
    html += tile(`${s.avg_high_off_open}%`, 'Avg High Off Open', 'var(--cyan)');
    html += tile(`${s.avg_low_off_open}%`, 'Avg Low Off Open', 'var(--amber)');
    html += tile(`${s.avg_close_vs_open}%`, 'Avg Close vs Open', s.avg_close_vs_open >= 0 ? 'var(--green)' : 'var(--red)');
    html += tile(`${s.avg_range_pct}%`, 'Avg Day Range');
    html += tile(`${s.next_day_green_pct}%`, 'Next-Day Green', s.next_day_green_pct >= 55 ? 'var(--green)' : 'var(--amber)');
    html += tile(`${s.avg_next_day_pct}%`, 'Avg Next-Day Move', s.avg_next_day_pct >= 0 ? 'var(--green)' : 'var(--red)');
    html += '</div>';

    // AI Insight button
    html += '<div style="margin:12px 0"><button class="ai-insight-btn" id="ai-insight-btn" onclick="getAiInsight()">üß† Get AI Insight</button></div>';
    html += '<div id="ai-insight-container"></div>';

    // Day-by-day breakdown table
    html += '<div class="trades-card"><h3>Qualifying Days Breakdown</h3><table>';
    html += '<tr><th>Date</th><th>Symbol</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>High Off Open</th><th>Low Off Open</th><th>Close vs Open</th><th>RSI</th><th>RVOL</th><th>Next Day</th></tr>';
    for (const d of days) {
        const cvoCls = d.close_vs_open_pct >= 0 ? 'win' : 'loss';
        const ndPct = d.next_day_pct !== undefined ? d.next_day_pct : '‚Äî';
        const ndCls = ndPct !== '‚Äî' ? (ndPct >= 0 ? 'win' : 'loss') : '';
        html += `<tr>
            <td>${d.date}</td>
            <td style="font-weight:600">${d.symbol}</td>
            <td>$${d.open.toFixed(2)}</td>
            <td>$${d.high.toFixed(2)}</td>
            <td>$${d.low.toFixed(2)}</td>
            <td>$${d.close.toFixed(2)}</td>
            <td style="color:var(--cyan)">+${d.high_off_open_pct}%</td>
            <td style="color:var(--amber)">${d.low_off_open_pct}%</td>
            <td class="${cvoCls}">${d.close_vs_open_pct >= 0 ? '+' : ''}${d.close_vs_open_pct}%</td>
            <td>${d.rsi}</td>
            <td>${d.rvol}x</td>
            <td class="${ndCls}">${ndPct !== '‚Äî' ? (ndPct >= 0 ? '+' : '') + ndPct + '%' : '‚Äî'}</td>
        </tr>`;
    }
    html += '</table></div>';

    // Meta
    html += `<div style="font-size:11px;color:var(--text-muted);padding:8px 0;font-family:'DM Mono',monospace;">`;
    html += `${meta.symbols?.length || 0} symbols ¬∑ ${meta.days_back}d lookback ¬∑ ${meta.total_bars || 0} bars scanned ¬∑ ${meta.runtime_seconds || 0}s`;
    if (meta.errors?.length) html += ` ¬∑ ${meta.errors.length} errors`;
    html += '</div>';

    container.innerHTML = html;
}

let lastStatsData = null;

const _origRenderStats = renderStatsResults;
renderStatsResults = function(data) {
    lastStatsData = data;
    _origRenderStats(data);
};

async function getAiInsight() {
    if (!lastStatsData) return;
    const btn = document.getElementById('ai-insight-btn');
    const box = document.getElementById('ai-insight-container');
    btn.disabled = true;
    btn.textContent = 'üß† Analyzing...';
    box.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;"><span class="spinner"></span> Generating AI insight...</div>';

    try {
        const resp = await fetch(`${API}/api/backtest/stats/insight`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastStatsData)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);

        // Convert markdown-ish text to HTML
        let insight = data.insight
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/^(\d+)\.\s+/gm, '<li>')
            .replace(/^[-‚Ä¢]\s+/gm, '<li>');
        if (insight.includes('<li>')) insight = '<ul>' + insight + '</ul>';
        insight = insight.replace(/\n/g, '<br>');

        box.innerHTML = `<div class="ai-insight-box"><h3>üß† AI Insight (${data.model || 'Claude'})</h3>${insight}</div>`;
    } catch (e) {
        box.innerHTML = `<div style="color:var(--red);font-size:12px;padding:8px;">‚ùå ${e.message}</div>`;
    }

    btn.disabled = false;
    btn.textContent = 'üß† Get AI Insight';
}

// ‚îÄ‚îÄ Cross Analysis ‚îÄ‚îÄ
async function runCrossAnalysis() {
    const btn = document.getElementById('cross-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Analyzing...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Fetching 1-minute bars and counting open crosses... this may take 30-90 seconds';

    const symbols = document.getElementById('cx-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('cx-days').value),
    };

    try {
        const resp = await fetch(`${API}/api/backtest/cross-analysis`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderCrossResults(data);
        status.className = 'status-bar done';
        status.textContent = `‚úÖ ${data.summary.total_days} days analyzed ¬∑ avg ${data.summary.avg_crosses} crosses/day ¬∑ ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Cross Analysis';
}

function renderCrossResults(data) {
    const s = data.summary || {};
    const days = data.days || [];
    const meta = data.meta || {};
    const byHour = data.cross_by_hour || {};
    const container = document.getElementById('results');

    let html = '';

    // Scorecard
    html += '<div class="scorecard">';
    html += tile(s.total_days, 'Days Analyzed');
    html += tile(s.avg_crosses, 'Avg Crosses/Day', 'var(--cyan)');
    html += tile(s.median_crosses, 'Median Crosses', 'var(--purple)');
    html += tile(s.max_crosses, 'Max Crosses', 'var(--red)');
    html += tile(s.min_crosses, 'Min Crosses', 'var(--green)');
    html += tile(`${s.directional_pct}%`, 'Directional (0-2)', 'var(--green)');
    html += tile(s.moderate_days, 'Moderate (3-5)', 'var(--amber)');
    html += tile(`${s.choppy_pct}%`, 'Choppy (6+)', 'var(--red)');
    html += tile(`${s.avg_pct_above_open}%`, 'Avg Time Above Open', 'var(--green)');
    html += tile(`${s.avg_pct_below_open}%`, 'Avg Time Below Open', 'var(--red)');
    html += tile(`${s.green_pct}%`, 'Closed Green', s.green_pct >= 50 ? 'var(--green)' : 'var(--red)');
    html += tile(s.total_days - s.green_days, 'Closed Red', 'var(--red)');
    html += '</div>';

    // VWAP scorecard
    if (s.avg_vwap_crosses !== undefined) {
        html += '<div class="scorecard">';
        html += tile(s.avg_vwap_crosses, 'Avg VWAP Crosses/Day', 'var(--cyan)');
        html += tile(`${s.avg_pct_above_vwap}%`, 'Avg Time Above VWAP', 'var(--green)');
        html += tile(`${s.avg_pct_below_vwap}%`, 'Avg Time Below VWAP', 'var(--red)');
        html += tile(`${s.closed_above_vwap_pct}%`, 'Closed Above VWAP', s.closed_above_vwap_pct >= 50 ? 'var(--green)' : 'var(--red)');
        html += '</div>';
    }

    // Cross-by-hour bar chart
    const hours = Object.keys(byHour);
    if (hours.length > 0) {
        const maxH = Math.max(...Object.values(byHour), 1);
        html += '<div class="equity-card"><h3>Crosses by Hour of Day (ET)</h3>';
        html += '<div class="hour-bar-row">';
        for (const h of hours) {
            const pct = (byHour[h] / maxH * 100);
            const hLabel = parseInt(h) > 12 ? (parseInt(h) - 12) + 'p' : parseInt(h) + 'a';
            html += `<div style="flex:1;text-align:center;">
                <div class="hour-bar" style="height:${Math.max(pct, 3)}%;margin:0 auto;width:80%;" title="${h}:00 ‚Äî ${byHour[h]} crosses"></div>
                <div class="hour-label">${hLabel}</div>
            </div>`;
        }
        html += '</div></div>';
    }

    // Per-day cross bars
    html += '<div class="equity-card"><h3>Crosses Per Day</h3>';
    const maxC = Math.max(...days.map(d => d.crosses), 1);
    for (const d of days) {
        const pct = (d.crosses / maxC * 100);
        const color = d.crosses <= 2 ? 'var(--green)' : d.crosses <= 5 ? 'var(--amber)' : 'var(--red)';
        const greenRed = d.closed_green ? 'üü¢' : 'üî¥';
        html += `<div class="cross-bar-row">
            <span class="cross-date">${d.date.slice(5)} ${greenRed}</span>
            <div class="cross-bar-bg">
                <div class="cross-bar-fill" style="width:${Math.max(pct, 5)}%;background:${color};">${d.crosses}</div>
            </div>
            <span class="cross-count" style="color:${color}">${d.crosses}√ó</span>
        </div>`;
    }
    html += '</div>';

    // Detail table
    html += '<div class="trades-card"><h3>Day-by-Day Detail</h3><table>';
    html += '<tr><th>Date</th><th>Symbol</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Crosses</th><th>% Above</th><th>% Below</th><th>VWAP</th><th>VWAP X</th><th>% Above VWAP</th><th>Close vs VWAP</th><th>High Off Open</th><th>Close vs Open</th></tr>';
    for (const d of days) {
        const cls = d.closed_green ? 'win' : 'loss';
        const crossColor = d.crosses <= 2 ? 'var(--green)' : d.crosses <= 5 ? 'var(--amber)' : 'var(--red)';
        const vwapCls = (d.close_vs_vwap || 0) >= 0 ? 'win' : 'loss';
        html += `<tr>
            <td>${d.date}</td>
            <td style="font-weight:600">${d.symbol}</td>
            <td>$${d.open.toFixed(2)}</td>
            <td>$${d.high.toFixed(2)}</td>
            <td>$${d.low.toFixed(2)}</td>
            <td>$${d.close.toFixed(2)}</td>
            <td style="color:${crossColor};font-weight:700">${d.crosses}</td>
            <td style="color:var(--green)">${d.pct_above_open}%</td>
            <td style="color:var(--red)">${d.pct_below_open}%</td>
            <td style="color:var(--cyan)">${d.eod_vwap ? '$' + d.eod_vwap.toFixed(2) : '‚Äî'}</td>
            <td style="color:var(--cyan);font-weight:600">${d.vwap_crosses != null ? d.vwap_crosses : '‚Äî'}</td>
            <td style="color:var(--green)">${d.pct_above_vwap != null ? d.pct_above_vwap + '%' : '‚Äî'}</td>
            <td class="${vwapCls}">${d.close_vs_vwap != null ? (d.close_vs_vwap >= 0 ? '+' : '') + d.close_vs_vwap + '%' : '‚Äî'}</td>
            <td style="color:var(--cyan)">+${d.high_off_open_pct}%</td>
            <td class="${cls}">${d.close_vs_open_pct >= 0 ? '+' : ''}${d.close_vs_open_pct}%</td>
        </tr>`;
    }
    html += '</table></div>';

    // Meta
    html += `<div style="font-size:11px;color:var(--text-muted);padding:8px 0;font-family:'DM Mono',monospace;">`;
    html += `${meta.symbols?.length || 0} symbols ¬∑ ${meta.days_back}d ¬∑ ${meta.total_minute_bars?.toLocaleString() || 0} minute bars ¬∑ ${meta.runtime_seconds || 0}s`;
    if (meta.errors?.length) html += ` ¬∑ ${meta.errors.length} errors`;
    html += '</div>';

    container.innerHTML = html;
}

// ‚îÄ‚îÄ OHLC Analysis ‚îÄ‚îÄ
async function runOhlcAnalysis() {
    const btn = document.getElementById('ohlc-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Analyzing...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Pulling daily OHLC data...';

    const symbols = document.getElementById('oh-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const filterMin = parseFloat(document.getElementById('oh-filter-min').value) / 100; // convert % ‚Üí decimal
    const filterMax = parseFloat(document.getElementById('oh-filter-max').value) / 100;
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('oh-days').value),
        filter_high_off_min: filterMin,
        filter_high_off_max: filterMax,
    };

    try {
        const resp = await fetch(`${API}/api/backtest/ohlc-analysis`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderOhlcResults(data);
        status.className = 'status-bar done';
        status.textContent = `‚úÖ ${data.summary.total_days} days ¬∑ ${data.summary.filter_hits} days in filter range (${data.summary.filter_pct}%) ¬∑ ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run OHLC Analysis';
}

function renderOhlcResults(data) {
    const s = data.summary || {};
    const rows = data.rows || [];
    const meta = data.meta || {};
    const container = document.getElementById('results');

    let html = '';

    // Summary scorecard
    html += '<div class="scorecard">';
    html += tile(s.total_days, 'Total Days');
    html += tile(s.green_days, 'Green Days', 'var(--green)');
    html += tile(s.red_days, 'Red Days', 'var(--red)');
    html += tile(`${s.green_pct}%`, 'Green %', s.green_pct >= 50 ? 'var(--green)' : 'var(--red)');
    html += tile(`${s.avg_open_to_high_pct}%`, 'Avg High Off Open', 'var(--cyan)');
    html += tile(`${s.avg_open_to_low_pct}%`, 'Avg Low Off Open', 'var(--amber)');
    html += tile(`${s.avg_gap_pct}%`, 'Avg Gap %', s.avg_gap_pct >= 0 ? 'var(--green)' : 'var(--red)');
    html += tile(s.gap_up_days, 'Gap Up Days', 'var(--green)');
    html += tile(s.gap_down_days, 'Gap Down Days', 'var(--red)');
    html += tile(s.filter_hits, 'Filter Hits', 'var(--purple)');
    html += tile(`${s.filter_pct}%`, 'Filter Hit %', 'var(--purple)');
    html += tile(s.filter_range, 'Filter Range', 'var(--text-secondary)');
    html += '</div>';

    // OHLC Table
    html += '<div class="trades-card"><h3>Daily OHLC Breakdown</h3><table class="ohlc-table">';
    html += '<tr><th>Date</th><th>Symbol</th><th>Prev Close</th><th>Open</th><th>High</th><th>Low</th><th>Close</th>';
    html += '<th>Green/Red</th><th>O‚ÜíH $</th><th>O‚ÜíH %</th><th>O‚ÜíL $</th><th>O‚ÜíL %</th>';
    html += '<th>Gap $</th><th>Gap %</th><th>Filter</th></tr>';

    for (const r of rows) {
        const intraCls = r.intraday_green ? 'win' : 'loss';
        const intraIcon = r.intraday_green ? 'üü¢' : 'üî¥';
        const gapCls = r.gap_pct > 0.01 ? 'gap-up' : r.gap_pct < -0.01 ? 'gap-down' : 'gap-flat';
        const filterMark = r.in_high_off_filter ? '‚úÖ' : '';
        const rowCls = r.in_high_off_filter ? 'filter-hit' : '';

        html += `<tr class="${rowCls}">
            <td>${r.date}</td>
            <td style="font-weight:600">${r.symbol}</td>
            <td>$${r.prev_close.toFixed(2)}</td>
            <td>$${r.open.toFixed(2)}</td>
            <td>$${r.high.toFixed(2)}</td>
            <td>$${r.low.toFixed(2)}</td>
            <td class="${intraCls}">$${r.close.toFixed(2)}</td>
            <td>${intraIcon}</td>
            <td style="color:var(--green)">+$${r.open_to_high_dollar.toFixed(2)}</td>
            <td style="color:var(--green)">+${r.open_to_high_pct}%</td>
            <td style="color:var(--red)">-$${r.open_to_low_dollar.toFixed(2)}</td>
            <td style="color:var(--red)">-${r.open_to_low_pct}%</td>
            <td class="${gapCls}">${r.gap_pct >= 0 ? '+' : ''}$${r.gap_dollar.toFixed(2)}</td>
            <td class="${gapCls}">${r.gap_pct >= 0 ? '+' : ''}${r.gap_pct}%</td>
            <td style="text-align:center">${filterMark}</td>
        </tr>`;
    }
    html += '</table></div>';

    // Filter summary callout
    if (s.filter_hits > 0) {
        html += `<div class="equity-card"><h3>üéØ Filter Results: (H-O)/O between ${s.filter_range}</h3>`;
        html += `<div style="font-size:14px;color:var(--text);margin-bottom:12px;">`;
        html += `<strong style="color:var(--purple)">${s.filter_hits}</strong> out of <strong>${s.total_days}</strong> days (${s.filter_pct}%) had a high-off-open move in the target range.</div>`;

        // Show just the filtered rows in a mini table
        const filtered = rows.filter(r => r.in_high_off_filter);
        if (filtered.length) {
            html += '<table class="ohlc-table"><tr><th>Date</th><th>Symbol</th><th>Open</th><th>High</th><th>O‚ÜíH %</th><th>Close</th><th>Green/Red</th><th>Gap %</th></tr>';
            for (const r of filtered) {
                const ic = r.intraday_green ? 'üü¢' : 'üî¥';
                html += `<tr>
                    <td>${r.date}</td>
                    <td style="font-weight:600">${r.symbol}</td>
                    <td>$${r.open.toFixed(2)}</td>
                    <td>$${r.high.toFixed(2)}</td>
                    <td style="color:var(--purple);font-weight:700">+${r.open_to_high_pct}%</td>
                    <td>$${r.close.toFixed(2)}</td>
                    <td>${ic}</td>
                    <td>${r.gap_pct >= 0 ? '+' : ''}${r.gap_pct}%</td>
                </tr>`;
            }
            html += '</table>';
        }
        html += '</div>';
    }

    // AI Insight button
    html += '<div style="margin:12px 0"><button class="ai-insight-btn" id="ohlc-ai-btn" onclick="getOhlcAiInsight()">üß† Get AI Insight</button></div>';
    html += '<div id="ohlc-ai-container"></div>';

    // Meta
    html += `<div style="font-size:11px;color:var(--text-muted);padding:8px 0;font-family:'DM Mono',monospace;">`;
    html += `${meta.symbols?.length || 0} symbols ¬∑ ${meta.days_back}d ¬∑ ${meta.total_bars || 0} bars ¬∑ ${meta.runtime_seconds || 0}s`;
    if (meta.errors?.length) html += ` ¬∑ ${meta.errors.length} errors`;
    html += '</div>';

    container.innerHTML = html;
}

let lastOhlcData = null;

const _origRenderOhlc = renderOhlcResults;
renderOhlcResults = function(data) {
    lastOhlcData = data;
    _origRenderOhlc(data);
};

async function getOhlcAiInsight() {
    if (!lastOhlcData) return;
    const btn = document.getElementById('ohlc-ai-btn');
    const box = document.getElementById('ohlc-ai-container');
    btn.disabled = true;
    btn.textContent = 'üß† Analyzing...';
    box.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;"><span class="spinner"></span> Generating AI insight...</div>';

    try {
        const resp = await fetch(`${API}/api/backtest/ohlc/insight`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastOhlcData)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);

        let insight = data.insight
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/^(\d+)\.\s+/gm, '<li>')
            .replace(/^[-‚Ä¢]\s+/gm, '<li>');
        if (insight.includes('<li>')) insight = '<ul>' + insight + '</ul>';
        insight = insight.replace(/\n/g, '<br>');

        box.innerHTML = `<div class="ai-insight-box"><h3>üß† AI Insight (${data.model || 'Claude'})</h3>${insight}</div>`;
    } catch (e) {
        box.innerHTML = `<div style="color:var(--red);font-size:12px;padding:8px;">‚ùå ${e.message}</div>`;
    }

    btn.disabled = false;
    btn.textContent = 'üß† Get AI Insight';
}

async function runCustom() {
    const btn = document.getElementById('custom-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Running...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Running custom backtest... this may take 30-60 seconds';

    const symbols = document.getElementById('cr-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const rules = collectRules();
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('cr-days').value),
        direction: document.getElementById('cr-direction').value,
        rr_ratio: parseFloat(document.getElementById('cr-rr').value),
        stop_atr_mult: parseFloat(document.getElementById('cr-stop-atr').value),
        rules,
    };

    try {
        const resp = await fetch(`${API}/api/backtest/custom`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderResults(data);
        status.className = 'status-bar done';
        const ruleDesc = rules.map(r => r.type.replace(/_/g,' ')).join(' + ');
        status.textContent = `‚úÖ Complete: ${data.summary.total_trades} trades (${ruleDesc}) in ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Custom Backtest';
}

async function runBacktest() {
    const btn = document.getElementById('run-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Running...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Running backtest... this may take 30-60 seconds';

    const symbols = document.getElementById('bt-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('bt-days').value),
        signal_filter: document.getElementById('bt-signal').value || null,
        min_confidence: parseInt(document.getElementById('bt-confidence').value),
        scan_interval: parseInt(document.getElementById('bt-interval').value),
    };

    try {
        const resp = await fetch(`${API}/api/backtest/strategy`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderResults(data);
        status.className = 'status-bar done';
        status.textContent = `‚úÖ Complete: ${data.summary.total_trades} trades in ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Backtest';
}

async function runReplay() {
    const btn = document.getElementById('replay-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Replaying...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Replaying journal trades against real prices...';

    // Get user ID from Firebase Auth if available
    let uid = '';
    if (typeof firebase !== 'undefined' && firebase.auth) {
        const user = firebase.auth().currentUser;
        if (user) uid = user.uid;
    }

    const body = {
        bar_interval: document.getElementById('bt-replay-interval').value,
        max_hold_bars: parseInt(document.getElementById('bt-replay-hold').value),
    };

    try {
        const url = `${API}/api/backtest/replay${uid ? '?user_id=' + uid : ''}`;
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);
        renderResults(data);
        status.className = 'status-bar done';
        status.textContent = `‚úÖ Replay complete: ${data.summary?.total_trades || 0} trades`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Replay Journal';
}

function renderResults(data) {
    const s = data.summary || {};
    const trades = data.trades || [];
    const analytics = data.analytics || {};
    const meta = data.meta || {};
    const container = document.getElementById('results');

    let html = '';

    // SCORECARD
    html += '<div class="scorecard">';
    html += tile(s.total_trades, 'Total Trades');
    html += tile(`${s.win_rate || 0}%`, 'Win Rate', s.win_rate >= 55 ? 'var(--green)' : s.win_rate >= 45 ? 'var(--amber)' : 'var(--red)');
    html += tile(`${s.avg_r || 0}R`, 'Avg R', s.avg_r > 0 ? 'var(--green)' : 'var(--red)');
    html += tile(`$${(s.total_pnl || 0).toFixed(0)}`, 'Total P&L', s.total_pnl > 0 ? 'var(--green)' : 'var(--red)');
    html += tile(s.profit_factor || 0, 'Profit Factor', s.profit_factor > 1.5 ? 'var(--green)' : 'var(--amber)');
    html += tile(`${s.expectancy_r || 0}R`, 'Expectancy', s.expectancy_r > 0 ? 'var(--green)' : 'var(--red)');
    html += tile(s.wins || 0, 'Wins', 'var(--green)');
    html += tile(s.losses || 0, 'Losses', 'var(--red)');
    html += tile(`${s.best_trade_r || 0}R`, 'Best Trade', 'var(--green)');
    html += tile(`${s.worst_trade_r || 0}R`, 'Worst Trade', 'var(--red)');
    html += tile(`${s.avg_bars_to_exit || 0}`, 'Avg Bars', 'var(--cyan)');
    html += tile(s.expired || 0, 'Expired', 'var(--amber)');
    html += '</div>';

    // EQUITY CURVE (SVG)
    const eqCurve = analytics.equity_curve || [];
    if (eqCurve.length > 1) {
        html += '<div class="equity-card"><h3>Equity Curve (Cumulative R)</h3>';
        html += renderEquitySVG(eqCurve);
        html += '</div>';
    }

    // BREAKDOWNS
    const bySymbol = analytics.by_symbol || {};
    const bySignal = analytics.by_signal || {};
    const byDirection = analytics.by_direction || {};
    const byDow = analytics.by_day_of_week || {};

    html += '<div class="breakdown-grid">';
    html += breakdownCard('By Symbol', bySymbol);
    html += breakdownCard('By Signal', bySignal);
    html += breakdownCard('By Direction', byDirection);
    html += breakdownCard('By Day of Week', byDow);
    html += '</div>';

    // TRADE TABLE
    html += '<div class="trades-card"><h3>All Trades</h3><table>';
    html += '<tr><th>Symbol</th><th>Dir</th><th>Signal</th><th>Entry</th><th>Target</th><th>Stop</th><th>Exit</th><th>P&L</th><th>R</th><th>Bars</th><th>Status</th></tr>';
    for (const t of trades) {
        const cls = t.status === 'WIN' ? 'win' : t.status === 'LOSS' ? 'loss' : 'expired';
        const pnl = t.pnl || 0;
        const r = t.pnl_r || 0;
        html += `<tr>
            <td style="font-weight:600">${t.symbol}</td>
            <td>${t.direction}</td>
            <td>${t.signal || '‚Äî'}</td>
            <td>${fmt(t.entry)}</td>
            <td>${fmt(t.target)}</td>
            <td>${fmt(t.stop)}</td>
            <td>${fmt(t.exit_price)}</td>
            <td class="${cls}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</td>
            <td class="${cls}">${r >= 0 ? '+' : ''}${r.toFixed(2)}R</td>
            <td>${t.bars_to_exit || '‚Äî'}</td>
            <td class="${cls}">${t.status}</td>
        </tr>`;
    }
    html += '</table></div>';

    // META
    html += `<div style="font-size:11px;color:var(--text-muted);padding:8px 0;font-family:'DM Mono',monospace;">`;
    html += `${meta.symbols_tested?.length || 0} symbols ¬∑ ${meta.total_bars || 0} bars ¬∑ ${meta.runtime_seconds || 0}s ¬∑ ${meta.bar_interval || ''} bars`;
    if (meta.errors?.length) html += ` ¬∑ ${meta.errors.length} errors`;
    html += '</div>';

    container.innerHTML = html;
}

function tile(val, label, color) {
    return `<div class="score-tile"><div class="val" style="color:${color || 'var(--text)'}">${val}</div><div class="lbl">${label}</div></div>`;
}

function fmt(n) { return n ? n.toFixed(2) : '‚Äî'; }

function breakdownCard(title, data) {
    let html = `<div class="breakdown-card"><h3>${title}</h3>`;
    const keys = Object.keys(data).sort((a, b) => (data[b].trades || 0) - (data[a].trades || 0));
    if (!keys.length) { html += '<div style="color:var(--text-muted);font-size:12px;">No data</div></div>'; return html; }
    for (const k of keys.slice(0, 10)) {
        const d = data[k];
        const wr = d.win_rate || 0;
        const wrColor = wr >= 55 ? 'var(--green)' : wr >= 45 ? 'var(--amber)' : 'var(--red)';
        html += `<div class="breakdown-row">
            <span class="key">${k}</span>
            <span class="val">${d.trades || 0}t ¬∑ <span style="color:${wrColor}">${wr.toFixed(0)}%</span> ¬∑ ${(d.avg_r || 0).toFixed(2)}R</span>
        </div>`;
    }
    html += '</div>';
    return html;
}

function renderEquitySVG(curve) {
    const W = 800, H = 180, PAD = 30;
    const points = curve.map(p => p.cum_r || 0);
    const n = points.length;
    if (n < 2) return '';
    
    const minY = Math.min(0, ...points);
    const maxY = Math.max(0, ...points);
    const rangeY = maxY - minY || 1;
    
    const x = i => PAD + (i / (n - 1)) * (W - PAD * 2);
    const y = v => PAD + (1 - (v - minY) / rangeY) * (H - PAD * 2);
    
    // Build path
    let path = `M ${x(0)} ${y(points[0])}`;
    for (let i = 1; i < n; i++) path += ` L ${x(i)} ${y(points[i])}`;
    
    // Zero line
    const zeroY = y(0);
    
    // Gradient fill
    let fill = `M ${x(0)} ${y(points[0])}`;
    for (let i = 1; i < n; i++) fill += ` L ${x(i)} ${y(points[i])}`;
    fill += ` L ${x(n - 1)} ${zeroY} L ${x(0)} ${zeroY} Z`;
    
    const finalR = points[n - 1];
    const lineColor = finalR >= 0 ? '#10b981' : '#ef4444';
    const fillColor = finalR >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)';

    return `<svg viewBox="0 0 ${W} ${H}" class="equity-svg" preserveAspectRatio="none">
        <path d="${fill}" fill="${fillColor}"/>
        <line x1="${PAD}" y1="${zeroY}" x2="${W - PAD}" y2="${zeroY}" stroke="#1e1e30" stroke-width="1" stroke-dasharray="4"/>
        <path d="${path}" fill="none" stroke="${lineColor}" stroke-width="2"/>
        <circle cx="${x(n - 1)}" cy="${y(finalR)}" r="4" fill="${lineColor}"/>
        <text x="${x(n - 1) + 8}" y="${y(finalR) + 4}" fill="${lineColor}" font-size="11" font-family="DM Mono">${finalR.toFixed(2)}R</text>
        <text x="${PAD}" y="${H - 4}" fill="#64748b" font-size="10" font-family="DM Mono">${n} trades</text>
    </svg>`;
}
</script>
</body>
</html>
