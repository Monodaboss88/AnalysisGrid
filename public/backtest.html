<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backtest Lab | SEF</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="config.js"></script>
<style>
:root {
    --bg: #0a0a0f; --bg-card: #12121a; --bg-input: #1a1a2e;
    --border: #1e1e30; --text: #e2e8f0; --text-secondary: #94a3b8;
    --text-muted: #64748b; --blue: #3b82f6; --cyan: #06b6d4;
    --green: #10b981; --red: #ef4444; --amber: #f59e0b; --purple: #8b5cf6;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

.header {
    padding: 24px 32px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
}
.header h1 { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 700; }
.header h1 span { color: var(--purple); }
.back-link { color: var(--text-muted); text-decoration: none; font-size: 13px; }
.back-link:hover { color: var(--text); }

/* CONFIG PANEL */
.config-panel {
    padding: 24px 32px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
}
.config-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
.config-group { display: flex; flex-direction: column; gap: 4px; }
.config-group label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-family: 'DM Mono', monospace; }
.config-group input, .config-group select {
    background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 12px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px;
    outline: none;
}
.config-group input:focus, .config-group select:focus { border-color: var(--purple); }
.config-group input[type="text"] { width: 280px; }
.config-group input[type="number"] { width: 80px; }

.run-btn {
    background: linear-gradient(135deg, var(--purple), #6366f1);
    color: white; border: none; border-radius: 8px; padding: 10px 24px;
    font-weight: 600; font-size: 14px; cursor: pointer; font-family: 'Outfit', sans-serif;
    transition: transform 0.1s, opacity 0.2s; margin-left: auto;
}
.run-btn:hover { transform: scale(1.02); }
.run-btn:disabled { opacity: 0.5; cursor: wait; }

.add-rule-btn {
    background: var(--bg-input); border: 1px dashed var(--border); border-radius: 6px;
    padding: 6px 14px; font-size: 12px; color: var(--purple); cursor: pointer;
    font-family: 'DM Mono', monospace; transition: all 0.2s;
}
.add-rule-btn:hover { border-color: var(--purple); background: rgba(139,92,246,0.08); }
.rule-row {
    display: flex; gap: 8px; align-items: center; margin-bottom: 6px;
    padding: 8px 10px; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 8px; flex-wrap: wrap;
}
.rule-row select, .rule-row input {
    background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    padding: 5px 8px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px;
    outline: none;
}
.rule-row select:focus, .rule-row input:focus { border-color: var(--purple); }
.rule-row input[type="number"] { width: 70px; }
.rule-row select { width: 160px; }
.rule-label { font-size: 11px; color: var(--text-secondary); min-width: 30px; text-align: center; }
.rule-remove {
    background: none; border: none; color: var(--red); cursor: pointer;
    font-size: 16px; padding: 2px 6px; opacity: 0.5; transition: opacity 0.2s;
}
.rule-remove:hover { opacity: 1; }

.ai-insight-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white; border: none; border-radius: 8px; padding: 10px 20px;
    font-weight: 600; font-size: 13px; cursor: pointer; font-family: 'Outfit', sans-serif;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
}
.ai-insight-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(139,92,246,0.3); }
.ai-insight-btn:disabled { opacity: 0.5; cursor: wait; }
.ai-insight-box {
    background: var(--bg-card); border: 1px solid var(--purple); border-radius: 12px;
    padding: 20px; margin: 16px 0; font-size: 13px; line-height: 1.7;
    color: var(--text); font-family: 'Outfit', sans-serif;
}
.ai-insight-box h3 { color: var(--purple); font-size: 14px; margin-bottom: 10px; font-family: 'Space Grotesk', sans-serif; }
.ai-insight-box ul { padding-left: 18px; }
.ai-insight-box li { margin-bottom: 6px; }
.ai-insight-box strong { color: var(--cyan); }

.mode-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.mode-tab {
    padding: 6px 16px; border-radius: 6px; font-size: 12px; font-weight: 500;
    cursor: pointer; background: var(--bg-input); border: 1px solid var(--border);
    color: var(--text-secondary); transition: all 0.2s;
}
.mode-tab.active { background: var(--purple); color: white; border-color: var(--purple); }

/* RESULTS */
.results { padding: 24px 32px; }
.status-bar {
    font-size: 13px; color: var(--text-muted); padding: 12px 0;
    font-family: 'DM Mono', monospace;
}
.status-bar.running { color: var(--amber); }
.status-bar.done { color: var(--green); }
.status-bar.error { color: var(--red); }

/* SCORECARD */
.scorecard {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 12px; margin-bottom: 24px;
}
.score-tile {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px; text-align: center;
}
.score-tile .val { font-family: 'Space Grotesk', sans-serif; font-size: 24px; font-weight: 700; }
.score-tile .lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; font-family: 'DM Mono', monospace; }

/* EQUITY CURVE */
.equity-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin-bottom: 24px;
}
.equity-card h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; font-family: 'Space Grotesk', sans-serif; }
.equity-svg { width: 100%; height: 200px; }

/* TRADE TABLE */
.trades-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px; margin-bottom: 24px; overflow-x: auto;
}
.trades-card h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; font-family: 'Space Grotesk', sans-serif; }
table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: 'DM Mono', monospace; }
th { text-align: left; padding: 8px 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-size: 10px; border-bottom: 1px solid var(--border); }
td { padding: 8px 10px; border-bottom: 1px solid rgba(30,30,48,0.5); }
tr:hover td { background: rgba(99,102,241,0.04); }
.win { color: var(--green); } .loss { color: var(--red); } .expired { color: var(--amber); }

/* BREAKDOWN */
.breakdown-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
.breakdown-card {
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;
}
.breakdown-card h3 { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; font-family: 'Space Grotesk', sans-serif; }
.breakdown-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 12px; border-bottom: 1px solid rgba(30,30,48,0.3); }
.breakdown-row .key { color: var(--text-secondary); }
.breakdown-row .val { font-family: 'DM Mono', monospace; }

/* LOADING */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border);
    border-top-color: var(--purple); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width: 768px) {
    .config-row { flex-direction: column; }
    .config-group input[type="text"] { width: 100%; }
    .breakdown-grid { grid-template-columns: 1fr; }
    .header, .config-panel, .results { padding-left: 16px; padding-right: 16px; }
}
</style>
</head>
<body>

<div class="header">
    <h1>üß™ Backtest <span>Lab</span></h1>
    <a href="/desk" class="back-link">‚Üê Back to Desk</a>
</div>

<div class="config-panel">
    <div class="mode-tabs">
        <div class="mode-tab active" onclick="setMode('strategy', this)">Strategy Test</div>
        <div class="mode-tab" onclick="setMode('custom', this)">Custom Rules</div>
        <div class="mode-tab" onclick="setMode('stats', this)">Stats Scanner</div>
        <div class="mode-tab" onclick="setMode('replay', this)">Replay Journal</div>
    </div>

    <!-- Strategy Config -->
    <div id="strategy-config">
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="bt-symbols" value="AAPL, NVDA, TSLA, META, MSFT" placeholder="AAPL, NVDA, TSLA...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="bt-days" value="90" min="30" max="365">
            </div>
            <div class="config-group">
                <label>Signal Filter</label>
                <select id="bt-signal">
                    <option value="">All Signals</option>
                    <option value="GREEN" selected>GREEN Only</option>
                    <option value="RED">RED Only</option>
                    <option value="YELLOW">YELLOW Only</option>
                </select>
            </div>
            <div class="config-group">
                <label>Min Confidence</label>
                <input type="number" id="bt-confidence" value="50" min="0" max="100">
            </div>
            <div class="config-group">
                <label>Scan Every N Days</label>
                <input type="number" id="bt-interval" value="5" min="1" max="20">
            </div>
            <button class="run-btn" id="run-btn" onclick="runBacktest()">‚ñ∂ Run Backtest</button>
        </div>
    </div>

    <!-- Replay Config -->
    <div id="replay-config" style="display:none;">
        <div class="config-row">
            <div class="config-group">
                <label>Bar Interval</label>
                <select id="bt-replay-interval">
                    <option value="1d" selected>Daily</option>
                    <option value="1h">1 Hour</option>
                    <option value="15m">15 Min</option>
                    <option value="5m">5 Min</option>
                </select>
            </div>
            <div class="config-group">
                <label>Max Hold Bars</label>
                <input type="number" id="bt-replay-hold" value="60" min="10" max="500">
            </div>
            <button class="run-btn" id="replay-btn" onclick="runReplay()">‚ñ∂ Replay Journal</button>
        </div>
    </div>

    <!-- Custom Rules Config -->
    <div id="custom-config" style="display:none;">
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="cr-symbols" value="AAPL, NVDA, TSLA, META, MSFT" placeholder="AAPL, NVDA, TSLA...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="cr-days" value="90" min="30" max="365">
            </div>
            <div class="config-group">
                <label>Direction</label>
                <select id="cr-direction">
                    <option value="LONG" selected>LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
            </div>
            <div class="config-group">
                <label>R:R Ratio <span style="color:var(--text-muted);font-size:10px">(0 = no target)</span></label>
                <input type="number" id="cr-rr" value="2.0" min="0" max="10" step="0.5" placeholder="0 = ride">
            </div>
            <div class="config-group">
                <label>Stop (ATR mult) <span style="color:var(--text-muted);font-size:10px">(0 = no stop)</span></label>
                <input type="number" id="cr-stop-atr" value="1.5" min="0" max="5" step="0.25" placeholder="0 = none">
            </div>
        </div>

        <div style="margin:12px 0 6px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-family:'DM Mono',monospace;">
            Entry Rules <span style="color:var(--purple)">(all must pass)</span>
        </div>
        <div id="rules-list"></div>
        <div style="display:flex;gap:8px;margin:8px 0 12px;">
            <button class="add-rule-btn" onclick="addRule()">+ Add Rule</button>
        </div>

        <div class="config-row" style="margin-top:4px;">
            <button class="run-btn" id="custom-btn" onclick="runCustom()">‚ñ∂ Run Custom Backtest</button>
        </div>
    </div>

    <!-- Stats Scanner Config -->
    <div id="stats-config" style="display:none;">
        <div style="margin-bottom:8px;font-size:12px;color:var(--text-secondary);">
            Pure probability scanner ‚Äî counts every qualifying day, no stops or targets. Just frequency + what happened.
        </div>
        <div class="config-row">
            <div class="config-group">
                <label>Symbols (comma-separated)</label>
                <input type="text" id="st-symbols" value="IWM" placeholder="IWM, SPY, QQQ...">
            </div>
            <div class="config-group">
                <label>Days Back</label>
                <input type="number" id="st-days" value="30" min="10" max="365">
            </div>
            <div class="config-group">
                <label>Direction</label>
                <select id="st-direction">
                    <option value="LONG" selected>LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
            </div>
        </div>

        <div style="margin:12px 0 6px;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);font-family:'DM Mono',monospace;">
            Filter Rules <span style="color:var(--purple)">(all must pass)</span>
        </div>
        <div id="stats-rules-list"></div>
        <div style="display:flex;gap:8px;margin:8px 0 12px;">
            <button class="add-rule-btn" onclick="addStatsRule()">+ Add Rule</button>
        </div>

        <div class="config-row" style="margin-top:4px;">
            <button class="run-btn" id="stats-btn" onclick="runStats()">‚ñ∂ Run Stats Scan</button>
        </div>
    </div>
</div>

<div class="status-bar" id="status">Configure your backtest and hit Run.</div>
<div class="results" id="results"></div>

<script>
const API = typeof BACKEND !== 'undefined' ? BACKEND : '';
let currentMode = 'strategy';

function setMode(mode, el) {
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('strategy-config').style.display = mode === 'strategy' ? '' : 'none';
    document.getElementById('custom-config').style.display = mode === 'custom' ? '' : 'none';
    document.getElementById('stats-config').style.display = mode === 'stats' ? '' : 'none';
    document.getElementById('replay-config').style.display = mode === 'replay' ? '' : 'none';
}

// ‚îÄ‚îÄ Custom Rule Builder ‚îÄ‚îÄ
const RULE_DEFS = {
    move_off_open: { label: '% Move Off Open (Close)', params: [{key:'min_pct',label:'Min %',val:0.75},{key:'max_pct',label:'Max %',val:1.25}] },
    high_off_open: { label: '% High Off Open',        params: [{key:'min_pct',label:'Min %',val:0.75},{key:'max_pct',label:'Max %',val:1.25}] },
    low_off_open:  { label: '% Low Off Open',         params: [{key:'min_pct',label:'Min %',val:0.75},{key:'max_pct',label:'Max %',val:1.25}] },
    rsi_range:     { label: 'RSI Range',       params: [{key:'min_rsi',label:'Min',val:30},{key:'max_rsi',label:'Max',val:50}] },
    above_ma:      { label: 'Price Above SMA',  params: [{key:'period',label:'Period',val:20}] },
    below_ma:      { label: 'Price Below SMA',  params: [{key:'period',label:'Period',val:20}] },
    rvol_min:      { label: 'Min Rel. Volume',  params: [{key:'min_rvol',label:'Min',val:1.3}] },
    gap_up:        { label: 'Gap Up %',         params: [{key:'min_pct',label:'Min %',val:0.5}] },
    gap_down:      { label: 'Gap Down %',       params: [{key:'min_pct',label:'Min %',val:0.5}] },
    range_pct:     { label: 'Bar Range %',      params: [{key:'min_pct',label:'Min %',val:0.5},{key:'max_pct',label:'Max %',val:2.0}] },
};

let ruleCounter = 0;

function addRule(type = 'move_off_open') {
    ruleCounter++;
    const id = ruleCounter;
    const container = document.getElementById('rules-list');
    const row = document.createElement('div');
    row.className = 'rule-row';
    row.id = `rule-${id}`;

    let optionsHtml = '';
    for (const [k, v] of Object.entries(RULE_DEFS)) {
        optionsHtml += `<option value="${k}" ${k === type ? 'selected' : ''}>${v.label}</option>`;
    }

    row.innerHTML = `
        <select onchange="updateRuleParams(${id}, this.value)">${optionsHtml}</select>
        <span class="rule-params" id="rule-params-${id}"></span>
        <button class="rule-remove" onclick="removeRule(${id})">√ó</button>
    `;
    container.appendChild(row);
    updateRuleParams(id, type);
}

function updateRuleParams(id, type) {
    const def = RULE_DEFS[type];
    if (!def) return;
    const span = document.getElementById(`rule-params-${id}`);
    span.innerHTML = def.params.map(p =>
        `<span class="rule-label">${p.label}</span><input type="number" step="any" data-key="${p.key}" value="${p.val}">`
    ).join('');
}

function removeRule(id) {
    const el = document.getElementById(`rule-${id}`);
    if (el) el.remove();
}

function collectRules() {
    const rules = [];
    document.querySelectorAll('#rules-list .rule-row').forEach(row => {
        const type = row.querySelector('select').value;
        const rule = { type };
        row.querySelectorAll('input[data-key]').forEach(inp => {
            rule[inp.dataset.key] = parseFloat(inp.value) || 0;
        });
        rules.push(rule);
    });
    return rules;
}

// Seed one default rule
addRule('move_off_open');

// ‚îÄ‚îÄ Stats Scanner Rule Builder (separate rule list) ‚îÄ‚îÄ
let statsRuleCounter = 0;

function addStatsRule(type = 'high_off_open') {
    statsRuleCounter++;
    const id = statsRuleCounter;
    const container = document.getElementById('stats-rules-list');
    const row = document.createElement('div');
    row.className = 'rule-row';
    row.id = `stats-rule-${id}`;
    let optionsHtml = '';
    for (const [k, v] of Object.entries(RULE_DEFS)) {
        optionsHtml += `<option value="${k}" ${k === type ? 'selected' : ''}>${v.label}</option>`;
    }
    row.innerHTML = `
        <select onchange="updateStatsRuleParams(${id}, this.value)">${optionsHtml}</select>
        <span class="rule-params" id="stats-rule-params-${id}"></span>
        <button class="rule-remove" onclick="removeStatsRule(${id})">√ó</button>
    `;
    container.appendChild(row);
    updateStatsRuleParams(id, type);
}

function updateStatsRuleParams(id, type) {
    const def = RULE_DEFS[type];
    if (!def) return;
    const span = document.getElementById(`stats-rule-params-${id}`);
    span.innerHTML = def.params.map(p =>
        `<span class="rule-label">${p.label}</span><input type="number" step="any" data-key="${p.key}" value="${p.val}">`
    ).join('');
}

function removeStatsRule(id) {
    const el = document.getElementById(`stats-rule-${id}`);
    if (el) el.remove();
}

function collectStatsRules() {
    const rules = [];
    document.querySelectorAll('#stats-rules-list .rule-row').forEach(row => {
        const type = row.querySelector('select').value;
        const rule = { type };
        row.querySelectorAll('input[data-key]').forEach(inp => {
            rule[inp.dataset.key] = parseFloat(inp.value) || 0;
        });
        rules.push(rule);
    });
    return rules;
}

// Seed default stats rule
addStatsRule('high_off_open');

async function runStats() {
    const btn = document.getElementById('stats-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Scanning...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Scanning for qualifying days...';

    const symbols = document.getElementById('st-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const rules = collectStatsRules();
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('st-days').value),
        direction: document.getElementById('st-direction').value,
        rules,
    };

    try {
        const resp = await fetch(`${API}/api/backtest/stats`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderStatsResults(data);
        const ruleDesc = rules.map(r => r.type.replace(/_/g,' ')).join(' + ');
        status.className = 'status-bar done';
        status.textContent = `‚úÖ ${data.summary.qualifying_days} qualifying days out of ${data.summary.total_days_scanned} (${data.summary.frequency_pct}%) ‚Äî ${ruleDesc} ‚Äî ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Stats Scan';
}

function renderStatsResults(data) {
    const s = data.summary || {};
    const days = data.days || [];
    const meta = data.meta || {};
    const container = document.getElementById('results');

    let html = '';

    // Frequency scorecard
    html += '<div class="scorecard">';
    html += tile(s.qualifying_days, 'Qualifying Days', 'var(--cyan)');
    html += tile(s.total_days_scanned, 'Total Days Scanned');
    html += tile(`${s.frequency_pct}%`, 'Frequency', s.frequency_pct >= 40 ? 'var(--green)' : s.frequency_pct >= 20 ? 'var(--amber)' : 'var(--red)');
    html += tile(`${s.green_pct}%`, 'Closed Green', s.green_pct >= 55 ? 'var(--green)' : 'var(--amber)');
    html += tile(s.closed_green, 'Green Days', 'var(--green)');
    html += tile(s.closed_red, 'Red Days', 'var(--red)');
    html += tile(`${s.avg_high_off_open}%`, 'Avg High Off Open', 'var(--cyan)');
    html += tile(`${s.avg_low_off_open}%`, 'Avg Low Off Open', 'var(--amber)');
    html += tile(`${s.avg_close_vs_open}%`, 'Avg Close vs Open', s.avg_close_vs_open >= 0 ? 'var(--green)' : 'var(--red)');
    html += tile(`${s.avg_range_pct}%`, 'Avg Day Range');
    html += tile(`${s.next_day_green_pct}%`, 'Next-Day Green', s.next_day_green_pct >= 55 ? 'var(--green)' : 'var(--amber)');
    html += tile(`${s.avg_next_day_pct}%`, 'Avg Next-Day Move', s.avg_next_day_pct >= 0 ? 'var(--green)' : 'var(--red)');
    html += '</div>';

    // AI Insight button
    html += '<div style="margin:12px 0"><button class="ai-insight-btn" id="ai-insight-btn" onclick="getAiInsight()">üß† Get AI Insight</button></div>';
    html += '<div id="ai-insight-container"></div>';

    // Day-by-day breakdown table
    html += '<div class="trades-card"><h3>Qualifying Days Breakdown</h3><table>';
    html += '<tr><th>Date</th><th>Symbol</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>High Off Open</th><th>Low Off Open</th><th>Close vs Open</th><th>RSI</th><th>RVOL</th><th>Next Day</th></tr>';
    for (const d of days) {
        const cvoCls = d.close_vs_open_pct >= 0 ? 'win' : 'loss';
        const ndPct = d.next_day_pct !== undefined ? d.next_day_pct : '‚Äî';
        const ndCls = ndPct !== '‚Äî' ? (ndPct >= 0 ? 'win' : 'loss') : '';
        html += `<tr>
            <td>${d.date}</td>
            <td style="font-weight:600">${d.symbol}</td>
            <td>$${d.open.toFixed(2)}</td>
            <td>$${d.high.toFixed(2)}</td>
            <td>$${d.low.toFixed(2)}</td>
            <td>$${d.close.toFixed(2)}</td>
            <td style="color:var(--cyan)">+${d.high_off_open_pct}%</td>
            <td style="color:var(--amber)">${d.low_off_open_pct}%</td>
            <td class="${cvoCls}">${d.close_vs_open_pct >= 0 ? '+' : ''}${d.close_vs_open_pct}%</td>
            <td>${d.rsi}</td>
            <td>${d.rvol}x</td>
            <td class="${ndCls}">${ndPct !== '‚Äî' ? (ndPct >= 0 ? '+' : '') + ndPct + '%' : '‚Äî'}</td>
        </tr>`;
    }
    html += '</table></div>';

    // Meta
    html += `<div style="font-size:11px;color:var(--text-muted);padding:8px 0;font-family:'DM Mono',monospace;">`;
    html += `${meta.symbols?.length || 0} symbols ¬∑ ${meta.days_back}d lookback ¬∑ ${meta.total_bars || 0} bars scanned ¬∑ ${meta.runtime_seconds || 0}s`;
    if (meta.errors?.length) html += ` ¬∑ ${meta.errors.length} errors`;
    html += '</div>';

    container.innerHTML = html;
}

let lastStatsData = null;

const _origRenderStats = renderStatsResults;
renderStatsResults = function(data) {
    lastStatsData = data;
    _origRenderStats(data);
};

async function getAiInsight() {
    if (!lastStatsData) return;
    const btn = document.getElementById('ai-insight-btn');
    const box = document.getElementById('ai-insight-container');
    btn.disabled = true;
    btn.textContent = 'üß† Analyzing...';
    box.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;"><span class="spinner"></span> Generating AI insight...</div>';

    try {
        const resp = await fetch(`${API}/api/backtest/stats/insight`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastStatsData)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);

        // Convert markdown-ish text to HTML
        let insight = data.insight
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/^(\d+)\.\s+/gm, '<li>')
            .replace(/^[-‚Ä¢]\s+/gm, '<li>');
        if (insight.includes('<li>')) insight = '<ul>' + insight + '</ul>';
        insight = insight.replace(/\n/g, '<br>');

        box.innerHTML = `<div class="ai-insight-box"><h3>üß† AI Insight (${data.model || 'Claude'})</h3>${insight}</div>`;
    } catch (e) {
        box.innerHTML = `<div style="color:var(--red);font-size:12px;padding:8px;">‚ùå ${e.message}</div>`;
    }

    btn.disabled = false;
    btn.textContent = 'üß† Get AI Insight';
}

async function runCustom() {
    const btn = document.getElementById('custom-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Running...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Running custom backtest... this may take 30-60 seconds';

    const symbols = document.getElementById('cr-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const rules = collectRules();
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('cr-days').value),
        direction: document.getElementById('cr-direction').value,
        rr_ratio: parseFloat(document.getElementById('cr-rr').value),
        stop_atr_mult: parseFloat(document.getElementById('cr-stop-atr').value),
        rules,
    };

    try {
        const resp = await fetch(`${API}/api/backtest/custom`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderResults(data);
        status.className = 'status-bar done';
        const ruleDesc = rules.map(r => r.type.replace(/_/g,' ')).join(' + ');
        status.textContent = `‚úÖ Complete: ${data.summary.total_trades} trades (${ruleDesc}) in ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Custom Backtest';
}

async function runBacktest() {
    const btn = document.getElementById('run-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Running...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Running backtest... this may take 30-60 seconds';

    const symbols = document.getElementById('bt-symbols').value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
    const body = {
        symbols,
        days_back: parseInt(document.getElementById('bt-days').value),
        signal_filter: document.getElementById('bt-signal').value || null,
        min_confidence: parseInt(document.getElementById('bt-confidence').value),
        scan_interval: parseInt(document.getElementById('bt-interval').value),
    };

    try {
        const resp = await fetch(`${API}/api/backtest/strategy`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error || data.detail) throw new Error(data.error || data.detail);
        renderResults(data);
        status.className = 'status-bar done';
        status.textContent = `‚úÖ Complete: ${data.summary.total_trades} trades in ${data.meta.runtime_seconds}s`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Run Backtest';
}

async function runReplay() {
    const btn = document.getElementById('replay-btn');
    const status = document.getElementById('status');
    btn.disabled = true;
    btn.textContent = '‚è≥ Replaying...';
    status.className = 'status-bar running';
    status.innerHTML = '<span class="spinner"></span> Replaying journal trades against real prices...';

    // Get user ID from Firebase Auth if available
    let uid = '';
    if (typeof firebase !== 'undefined' && firebase.auth) {
        const user = firebase.auth().currentUser;
        if (user) uid = user.uid;
    }

    const body = {
        bar_interval: document.getElementById('bt-replay-interval').value,
        max_hold_bars: parseInt(document.getElementById('bt-replay-hold').value),
    };

    try {
        const url = `${API}/api/backtest/replay${uid ? '?user_id=' + uid : ''}`;
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);
        renderResults(data);
        status.className = 'status-bar done';
        status.textContent = `‚úÖ Replay complete: ${data.summary?.total_trades || 0} trades`;
    } catch (e) {
        status.className = 'status-bar error';
        status.textContent = `‚ùå Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = '‚ñ∂ Replay Journal';
}

function renderResults(data) {
    const s = data.summary || {};
    const trades = data.trades || [];
    const analytics = data.analytics || {};
    const meta = data.meta || {};
    const container = document.getElementById('results');

    let html = '';

    // SCORECARD
    html += '<div class="scorecard">';
    html += tile(s.total_trades, 'Total Trades');
    html += tile(`${s.win_rate || 0}%`, 'Win Rate', s.win_rate >= 55 ? 'var(--green)' : s.win_rate >= 45 ? 'var(--amber)' : 'var(--red)');
    html += tile(`${s.avg_r || 0}R`, 'Avg R', s.avg_r > 0 ? 'var(--green)' : 'var(--red)');
    html += tile(`$${(s.total_pnl || 0).toFixed(0)}`, 'Total P&L', s.total_pnl > 0 ? 'var(--green)' : 'var(--red)');
    html += tile(s.profit_factor || 0, 'Profit Factor', s.profit_factor > 1.5 ? 'var(--green)' : 'var(--amber)');
    html += tile(`${s.expectancy_r || 0}R`, 'Expectancy', s.expectancy_r > 0 ? 'var(--green)' : 'var(--red)');
    html += tile(s.wins || 0, 'Wins', 'var(--green)');
    html += tile(s.losses || 0, 'Losses', 'var(--red)');
    html += tile(`${s.best_trade_r || 0}R`, 'Best Trade', 'var(--green)');
    html += tile(`${s.worst_trade_r || 0}R`, 'Worst Trade', 'var(--red)');
    html += tile(`${s.avg_bars_to_exit || 0}`, 'Avg Bars', 'var(--cyan)');
    html += tile(s.expired || 0, 'Expired', 'var(--amber)');
    html += '</div>';

    // EQUITY CURVE (SVG)
    const eqCurve = analytics.equity_curve || [];
    if (eqCurve.length > 1) {
        html += '<div class="equity-card"><h3>Equity Curve (Cumulative R)</h3>';
        html += renderEquitySVG(eqCurve);
        html += '</div>';
    }

    // BREAKDOWNS
    const bySymbol = analytics.by_symbol || {};
    const bySignal = analytics.by_signal || {};
    const byDirection = analytics.by_direction || {};
    const byDow = analytics.by_day_of_week || {};

    html += '<div class="breakdown-grid">';
    html += breakdownCard('By Symbol', bySymbol);
    html += breakdownCard('By Signal', bySignal);
    html += breakdownCard('By Direction', byDirection);
    html += breakdownCard('By Day of Week', byDow);
    html += '</div>';

    // TRADE TABLE
    html += '<div class="trades-card"><h3>All Trades</h3><table>';
    html += '<tr><th>Symbol</th><th>Dir</th><th>Signal</th><th>Entry</th><th>Target</th><th>Stop</th><th>Exit</th><th>P&L</th><th>R</th><th>Bars</th><th>Status</th></tr>';
    for (const t of trades) {
        const cls = t.status === 'WIN' ? 'win' : t.status === 'LOSS' ? 'loss' : 'expired';
        const pnl = t.pnl || 0;
        const r = t.pnl_r || 0;
        html += `<tr>
            <td style="font-weight:600">${t.symbol}</td>
            <td>${t.direction}</td>
            <td>${t.signal || '‚Äî'}</td>
            <td>${fmt(t.entry)}</td>
            <td>${fmt(t.target)}</td>
            <td>${fmt(t.stop)}</td>
            <td>${fmt(t.exit_price)}</td>
            <td class="${cls}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</td>
            <td class="${cls}">${r >= 0 ? '+' : ''}${r.toFixed(2)}R</td>
            <td>${t.bars_to_exit || '‚Äî'}</td>
            <td class="${cls}">${t.status}</td>
        </tr>`;
    }
    html += '</table></div>';

    // META
    html += `<div style="font-size:11px;color:var(--text-muted);padding:8px 0;font-family:'DM Mono',monospace;">`;
    html += `${meta.symbols_tested?.length || 0} symbols ¬∑ ${meta.total_bars || 0} bars ¬∑ ${meta.runtime_seconds || 0}s ¬∑ ${meta.bar_interval || ''} bars`;
    if (meta.errors?.length) html += ` ¬∑ ${meta.errors.length} errors`;
    html += '</div>';

    container.innerHTML = html;
}

function tile(val, label, color) {
    return `<div class="score-tile"><div class="val" style="color:${color || 'var(--text)'}">${val}</div><div class="lbl">${label}</div></div>`;
}

function fmt(n) { return n ? n.toFixed(2) : '‚Äî'; }

function breakdownCard(title, data) {
    let html = `<div class="breakdown-card"><h3>${title}</h3>`;
    const keys = Object.keys(data).sort((a, b) => (data[b].trades || 0) - (data[a].trades || 0));
    if (!keys.length) { html += '<div style="color:var(--text-muted);font-size:12px;">No data</div></div>'; return html; }
    for (const k of keys.slice(0, 10)) {
        const d = data[k];
        const wr = d.win_rate || 0;
        const wrColor = wr >= 55 ? 'var(--green)' : wr >= 45 ? 'var(--amber)' : 'var(--red)';
        html += `<div class="breakdown-row">
            <span class="key">${k}</span>
            <span class="val">${d.trades || 0}t ¬∑ <span style="color:${wrColor}">${wr.toFixed(0)}%</span> ¬∑ ${(d.avg_r || 0).toFixed(2)}R</span>
        </div>`;
    }
    html += '</div>';
    return html;
}

function renderEquitySVG(curve) {
    const W = 800, H = 180, PAD = 30;
    const points = curve.map(p => p.cum_r || 0);
    const n = points.length;
    if (n < 2) return '';
    
    const minY = Math.min(0, ...points);
    const maxY = Math.max(0, ...points);
    const rangeY = maxY - minY || 1;
    
    const x = i => PAD + (i / (n - 1)) * (W - PAD * 2);
    const y = v => PAD + (1 - (v - minY) / rangeY) * (H - PAD * 2);
    
    // Build path
    let path = `M ${x(0)} ${y(points[0])}`;
    for (let i = 1; i < n; i++) path += ` L ${x(i)} ${y(points[i])}`;
    
    // Zero line
    const zeroY = y(0);
    
    // Gradient fill
    let fill = `M ${x(0)} ${y(points[0])}`;
    for (let i = 1; i < n; i++) fill += ` L ${x(i)} ${y(points[i])}`;
    fill += ` L ${x(n - 1)} ${zeroY} L ${x(0)} ${zeroY} Z`;
    
    const finalR = points[n - 1];
    const lineColor = finalR >= 0 ? '#10b981' : '#ef4444';
    const fillColor = finalR >= 0 ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)';

    return `<svg viewBox="0 0 ${W} ${H}" class="equity-svg" preserveAspectRatio="none">
        <path d="${fill}" fill="${fillColor}"/>
        <line x1="${PAD}" y1="${zeroY}" x2="${W - PAD}" y2="${zeroY}" stroke="#1e1e30" stroke-width="1" stroke-dasharray="4"/>
        <path d="${path}" fill="none" stroke="${lineColor}" stroke-width="2"/>
        <circle cx="${x(n - 1)}" cy="${y(finalR)}" r="4" fill="${lineColor}"/>
        <text x="${x(n - 1) + 8}" y="${y(finalR) + 4}" fill="${lineColor}" font-size="11" font-family="DM Mono">${finalR.toFixed(2)}R</text>
        <text x="${PAD}" y="${H - 4}" fill="#64748b" font-size="10" font-family="DM Mono">${n} trades</text>
    </svg>`;
}
</script>
</body>
</html>
