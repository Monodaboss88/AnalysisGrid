<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DP_MTF | Auction Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs for Authentication and Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            /* Core palette — matched to SVG chart background */
            --bg-primary: #0a0e17;
            --bg-secondary: #0d1322;
            --bg-tertiary: #131b2e;
            --bg-card: #101828;
            --bg-elevated: #182236;
            
            /* Text */
            --text-primary: #cbd5e1;
            --text-secondary: #64748b;
            --text-muted: #475569;
            
            /* Accent colors — cyan from chart line */
            --accent-cyan: #00d4ff;
            --accent-cyan-glow: rgba(0, 212, 255, 0.25);
            --accent-green: #10b981;
            --accent-green-glow: rgba(16, 185, 129, 0.25);
            --accent-red: #ef4444;
            --accent-red-glow: rgba(239, 68, 68, 0.25);
            --accent-yellow: #f59e0b;
            --accent-yellow-glow: rgba(245, 158, 11, 0.25);
            --accent-purple: #8b5cf6;
            
            /* Borders — from SVG grid lines */
            --border-subtle: rgba(30, 41, 59, 0.6);
            --border-default: #1e293b;
            
            /* Gradients */
            --gradient-card: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(10, 14, 23, 0.9) 100%);
            --gradient-green: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --gradient-yellow: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-cyan: linear-gradient(135deg, #00d4ff 0%, #0891b2 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.6);
            --shadow-glow-cyan: 0 0 20px rgba(0, 212, 255, 0.15);
            --shadow-glow-green: 0 0 20px rgba(16, 185, 129, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1400' height='800' viewBox='0 0 1400 800'%3E%3Crect width='1400' height='800' fill='%230f172a'/%3E%3Cdefs%3E%3ClinearGradient id='glow' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%2300d4ff' stop-opacity='0.25'/%3E%3Cstop offset='100%25' stop-color='%2300d4ff' stop-opacity='0'/%3E%3C/linearGradient%3E%3ClinearGradient id='fade' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%230a0e17' stop-opacity='0.6'/%3E%3Cstop offset='15%25' stop-color='%230a0e17' stop-opacity='0'/%3E%3Cstop offset='85%25' stop-color='%230a0e17' stop-opacity='0'/%3E%3Cstop offset='100%25' stop-color='%230a0e17' stop-opacity='0.9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cg stroke='%231e293b' stroke-width='0.5' opacity='0.6'%3E%3Cline x1='0' y1='160' x2='1400' y2='160'/%3E%3Cline x1='0' y1='300' x2='1400' y2='300'/%3E%3Cline x1='0' y1='440' x2='1400' y2='440'/%3E%3Cline x1='0' y1='580' x2='1400' y2='580'/%3E%3Cline x1='200' y1='80' x2='200' y2='720'/%3E%3Cline x1='400' y1='80' x2='400' y2='720'/%3E%3Cline x1='600' y1='80' x2='600' y2='720'/%3E%3Cline x1='800' y1='80' x2='800' y2='720'/%3E%3Cline x1='1000' y1='80' x2='1000' y2='720'/%3E%3Cline x1='1200' y1='80' x2='1200' y2='720'/%3E%3C/g%3E%3Cpath d='M0 650 Q70 640,140 620 T280 580 T380 560 T450 530 T520 550 T600 520 T680 480 T750 440 T820 460 T900 420 T980 380 T1050 340 T1120 360 T1200 310 T1280 260 T1350 220 L1400 200 L1400 800 L0 800 Z' fill='url(%23glow)' opacity='0.4'/%3E%3Cpath d='M0 650 Q70 640,140 620 T280 580 T380 560 T450 530 T520 550 T600 520 T680 480 T750 440 T820 460 T900 420 T980 380 T1050 340 T1120 360 T1200 310 T1280 260 T1350 220 L1400 200' fill='none' stroke='%2300d4ff' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M0 660 Q100 650,200 630 T400 580 T600 540 T800 470 T1000 400 T1200 340 T1400 250' fill='none' stroke='%23f59e0b' stroke-width='1.5' stroke-dasharray='8 4' opacity='0.5'/%3E%3Ccircle cx='520' cy='550' r='3' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='820' cy='460' r='3' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='1120' cy='360' r='3' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='1400' cy='200' r='4' fill='%2300d4ff' opacity='0.9'/%3E%3Ctext x='1370' y='195' fill='%2300d4ff' font-size='11' font-family='monospace' opacity='0.5'%3E$485%3C/text%3E%3Ctext x='15' y='655' fill='%23475569' font-size='10' font-family='monospace' opacity='0.4'%3E$420%3C/text%3E%3Crect width='1400' height='800' fill='url(%23fade)'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #0a0e17 0%, #0f1d32 100%);
            background-size: 100% auto, 100% 100%;
            background-position: center top, center center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        header {
            position: relative;
            z-index: 100;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1.25rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-cyan);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-glow-cyan);
        }

        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .logo-text span {
            color: var(--accent-cyan);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .market-clock {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clock-time {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .market-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.25);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .market-status.closed {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.25);
            color: var(--accent-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        .market-status.closed .status-dot {
            background: var(--accent-red);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .simple-scanner-link {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-decoration: none;
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            transition: all 0.2s;
        }

        .simple-scanner-link:hover {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255,0.1);
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .connection-badge.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }

        .connection-badge.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        /* ===== NOTIFICATION BELL ===== */
        .notification-bell {
            position: relative;
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
            transition: transform 0.2s ease;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent-red);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .modal-close:hover {
            color: var(--accent-red);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* ===== NAVIGATION ===== */
        nav {
            position: relative;
            z-index: 100;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 1.5rem;
            display: flex;
            gap: 0.25rem;
        }

        nav button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            position: relative;
            border-bottom: 2px solid transparent;
        }

        nav button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        nav button.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.05);
        }

        nav button .nav-icon {
            font-size: 1rem;
        }

        /* ===== MAIN CONTENT ===== */
        main {
            position: relative;
            z-index: 10;
            padding: 1.5rem;
            min-height: calc(100vh - 120px);
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 212, 255, 0.2);
            box-shadow: var(--shadow-md), 0 0 40px rgba(0, 212, 255, 0.05);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .card-title-icon.cyan { background: rgba(0, 212, 255, 0.15); }
        .card-title-icon.green { background: rgba(16, 185, 129, 0.15); }
        .card-title-icon.yellow { background: rgba(245, 158, 11, 0.15); }
        .card-title-icon.red { background: rgba(239, 68, 68, 0.15); }
        .card-title-icon.purple { background: rgba(157, 78, 221, 0.15); }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* ===== GRID LAYOUTS ===== */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .ai-scenarios-grid { grid-template-columns: 1fr !important; }
        }

        /* ===== DASHBOARD STATS ===== */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 900px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.cyan::before { background: var(--gradient-cyan); }
        .stat-card.green::before { background: var(--gradient-green); }
        .stat-card.yellow::before { background: var(--gradient-yellow); }
        .stat-card.red::before { background: var(--gradient-red); }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.cyan { color: var(--accent-cyan); }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive { color: var(--accent-green); }
        .stat-change.negative { color: var(--accent-red); }

        /* ===== FORM ELEMENTS ===== */
        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        input, select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b95a5' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .btn-primary {
            background: #1a2a2a;
            color: #00d4ff;
            border: 1px solid #00d4ff;
            border-radius: 6px;
            box-shadow: none;
        }

        .btn-primary:hover {
            background: #1f3333;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-cyan);
        }

        .btn-success {
            background: var(--gradient-green);
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-red);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-yellow);
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 0.95rem;
        }

        .btn-block {
            width: 100%;
        }

        /* ===== ACTION BUTTONS (Clean Dark Style) ===== */
        .action-btn {
            width: auto;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .action-btn-dark {
            background: #1e2433;
            border: 1px solid #2a3244;
            border-right: 3px solid #3b82f6;
        }

        .action-btn-dark:hover {
            background: #252d3f;
            border-color: #3b82f6;
        }

        .action-btn-primary {
            background: #0d9488;
            border: 1px solid #14b8a6;
            border-right: 3px solid #2dd4bf;
        }

        .action-btn-primary:hover {
            background: #0f766e;
            border-color: #2dd4bf;
        }

        .action-btn-icon {
            font-size: 0.75rem;
        }

        .action-btn-text {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .action-btn-primary .action-btn-text {
            color: white;
        }

        .action-btn-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .trade-tf-btn {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trade-tf-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .trade-tf-btn.selected {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }

        /* ===== FILTER BUTTONS ===== */
        .filter-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }

        /* ===== COLLAPSIBLE SECTIONS ===== */
        .collapsible-section .collapse-icon {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .collapsible-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        .collapsible-section.collapsed .collapsible-content {
            max-height: 0;
            opacity: 0;
        }

        /* ===== SCAN RESULT ROWS ===== */
        .scan-result-row {
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .scan-result-row:hover {
            background: var(--bg-tertiary);
        }
        .scan-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-cyan);
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* ===== UNIVERSE BUTTONS ===== */
        .universe-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.7rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .universe-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        /* ===== SCAN TYPE TOGGLES ===== */
        .scan-type-toggles {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .scan-type-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scan-type-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .scan-type-btn.active {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
            background: rgba(0, 212, 255, 0.1);
        }

        .scan-type-btn.active[data-type="bullish"] {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .scan-type-btn.active[data-type="bearish"] {
            border-color: var(--accent-red);
            background: rgba(255, 71, 87, 0.1);
        }

        .scan-type-btn.active[data-type="compression"] {
            border-color: var(--accent-yellow);
            background: rgba(255, 215, 0, 0.1);
        }

        .scan-type-btn.active[data-type="extension"] {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .scan-type-btn.active[data-type="structure"] {
            border-color: var(--accent-purple);
            background: rgba(187, 134, 252, 0.1);
        }

        .scan-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0.5;
        }

        .scan-type-btn.active .scan-dot {
            opacity: 1;
        }

        .scan-dot.green { background: var(--accent-green); }
        .scan-dot.red { background: var(--accent-red); }
        .scan-dot.yellow { background: var(--accent-yellow); }
        .scan-dot.cyan { background: var(--accent-cyan); }
        .scan-dot.purple { background: var(--accent-purple); }

        /* ===== TIMEFRAME TOGGLES ===== */
        .tf-toggle-group {
            display: flex;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            overflow: hidden;
        }

        .tf-toggle {
            padding: 0.6rem 0.9rem;
            font-size: 0.8rem;
            background: var(--bg-primary);
            border: none;
            border-right: 1px solid var(--border-default);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tf-toggle:last-child {
            border-right: none;
        }

        .tf-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tf-toggle.active {
            background: var(--accent-cyan);
            color: #000;
            font-weight: 600;
        }

        /* ===== VP PERIOD TOGGLES ===== */
        .vp-toggle-group {
            display: flex;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            overflow: hidden;
        }

        .vp-toggle {
            padding: 0.6rem 0.7rem;
            font-size: 0.85rem;
            background: var(--bg-primary);
            border: none;
            border-right: 1px solid var(--border-default);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vp-toggle:last-child {
            border-right: none;
        }

        .vp-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .vp-toggle.active {
            background: var(--accent-purple);
            color: #fff;
            font-weight: 600;
        }

        /* ===== RESULT FILTER TABS ===== */
        .result-filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .filter-tab.active {
            background: var(--accent-cyan);
            color: #000;
            border-color: var(--accent-cyan);
            font-weight: 600;
        }

        /* ===== SIGNAL BADGES ===== */
        .signal {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .signal-long {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }

        .signal-short {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.1);
        }

        .signal-yellow {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-yellow);
            border: 1px solid rgba(245, 158, 11, 0.3);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);
        }

        .signal-neutral {
            background: rgba(139, 149, 165, 0.15);
            color: var(--text-secondary);
            border: 1px solid rgba(139, 149, 165, 0.3);
        }

        /* ===== SCORE BARS ===== */
        .score-container {
            margin: 1rem 0;
        }

        .score-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .score-label {
            width: 60px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .score-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
        }

        .score-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .score-fill.bull {
            background: var(--gradient-green);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .score-fill.bear {
            background: var(--gradient-red);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .score-value {
            width: 50px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ===== DATA TABLE ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-primary);
        }

        .data-table td {
            padding: 0.875rem 1rem;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table tr:hover td {
            background: rgba(0, 212, 255, 0.03);
        }

        .data-table .symbol-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .data-table .number-cell {
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== WATCHLIST PILLS ===== */
        .watchlist-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .watchlist-pill {
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .watchlist-pill:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .watchlist-pill.active {
            background: rgba(0, 212, 255, 0.15);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* ===== ITEM CARDS (Alerts/Trades) ===== */
        .item-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .item-card:hover {
            border-color: var(--border-default);
            background: var(--bg-tertiary);
        }

        .item-card .details {
            flex: 1;
        }

        .item-card .symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 0.95rem;
        }

        .item-card .meta {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .item-card .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== MTF GRID ===== */
        .mtf-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .mtf-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .mtf-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .mtf-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .mtf-card .tf-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }

        .mtf-card .signal-display {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .mtf-card .signal-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .mtf-card .signal-text.long { color: var(--accent-green); }
        .mtf-card .signal-text.short { color: var(--accent-red); }
        .mtf-card .signal-text.yellow { color: var(--accent-yellow); }
        .mtf-card .signal-text.neutral { color: var(--text-muted); }

        .mtf-card .confidence {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* ===== QUICK ANALYZE ROW ===== */
        .analyze-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .analyze-row .input-group {
            flex: 0 0 auto;
            margin-bottom: 0;
        }

        .analyze-row .input-group:first-child {
            width: 120px;
        }

        .analyze-row .input-group:nth-child(2) {
            width: 100px;
        }

        .analyze-row .btn {
            height: 44px;
            padding: 0 1rem;
        }

        .analyze-row .action-btn {
            height: 44px;
            padding: 0 1rem;
        }

        /* ===== RESULTS DISPLAY ===== */
        #results-card {
            background: var(--gradient-card);
            border: 1px solid var(--border-default);
        }
        #results-card:hover {
            border-color: rgba(0, 212, 255, 0.2);
            box-shadow: var(--shadow-md), 0 0 40px rgba(0, 212, 255, 0.05);
        }
        
        .results-header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .results-symbol {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .results-symbol h3 {
            font-family: 'Inter', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .results-symbol .price {
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .results-ohlc {
            display: flex;
            gap: 1.25rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .results-ohlc span b {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        @media (max-width: 768px) {
            .level-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .level-box {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }

        .level-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .level-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .level-value.vah { color: var(--accent-green); }
        .level-value.poc { color: var(--accent-yellow); }
        .level-value.val { color: var(--accent-red); }
        .level-value.vwap { color: var(--accent-cyan); }

        /* ===== LOADING STATE ===== */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Entry Diagram Styles */
        .entry-diagram-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid var(--border-default);
        }
        .entry-diagram-container h4 {
            color: var(--accent-green);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .entry-diagram-container svg {
            width: 100%;
            max-width: 300px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .diagram-description {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0.75rem;
            text-align: center;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 3rem;
            color: var(--text-muted);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 0.9rem;
        }

        /* ===== RANGE WATCHER SPECIFIC ===== */
        .range-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .range-table th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-subtle);
        }

        .range-table td {
            padding: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .structure-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .structure-badge.bullish {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .structure-badge.bearish {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .structure-badge.neutral {
            background: rgba(139, 149, 165, 0.15);
            color: var(--text-muted);
        }

        /* ===== POSITION GAUGE ===== */
        .position-gauge {
            height: 6px;
            background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow), var(--accent-green));
            border-radius: 3px;
            position: relative;
            margin: 0.5rem 0;
        }

        .position-marker {
            position: absolute;
            top: -4px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* ===== SETTINGS SECTION ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .settings-grid { grid-template-columns: 1fr; }
        }

        .api-key-input {
            display: flex;
            gap: 0.5rem;
        }

        .api-key-input input {
            flex: 1;
        }

        /* ===== WORKFLOW SECTION ===== */
        .workflow-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .workflow-stat {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
        }

        .workflow-stat .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .workflow-stat .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .mental-state-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .mental-state-indicator.green {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .mental-state-indicator.yellow {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .mental-state-indicator.red {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .mental-state-text {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .mental-state-indicator.green .mental-state-text { color: var(--accent-green); }
        .mental-state-indicator.yellow .mental-state-text { color: var(--accent-yellow); }
        .mental-state-indicator.red .mental-state-text { color: var(--accent-red); }

        /* ===== FOOTER ===== */
        footer {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
        }

        footer span {
            color: var(--accent-cyan);
        }

        /* ===== HIDDEN BY DEFAULT ===== */
        .hidden {
            display: none !important;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-tertiary);
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="logo-section">
            <div class="logo">
                <div class="logo-text"><span>DP</span> _MTF</div>
            </div>
        </div>
        
        <div class="header-center">
            <div class="market-clock">
                <span>Market:</span>
                <span class="clock-time" id="market-time">--:--:--</span>
            </div>
            <div class="market-status" id="market-status">
                <div class="status-dot"></div>
                <span>CHECKING...</span>
            </div>
        </div>
        
        <div class="header-right">
            <!-- Trade Desk Link -->
            <a href="/desk" class="simple-scanner-link" title="Trade Desk - Command Center" style="background: linear-gradient(135deg, #1e1b4b, #3730a3); border-color: #6366f1;">
                🏠 Desk
            </a>
            <!-- Simple Scanner Link -->
            <a href="/simple.html" class="simple-scanner-link" title="Simple Scanner for Beginners">
                🎯 Simple
            </a>
            
            <!-- Shared Trades Notification Bell -->
            <button class="notification-bell" id="shared-trades-bell" onclick="showSharedTrades()" title="Shared Trade Ideas">
                🔔
                <span class="notification-badge" id="shared-trades-count" style="display: none;">0</span>
            </button>
            
            <div class="user-info" id="user-info" style="display: none; margin-right: 1rem; font-size: 0.8rem;">
                <span id="user-tier" style="background: var(--accent-cyan); color: var(--bg-primary); padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600; margin-right: 0.5rem;">FREE</span>
                <span id="user-name" style="color: var(--text-secondary);"></span>
                <button onclick="logout()" style="margin-left: 0.75rem; background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Logout</button>
            </div>
            
            <!-- Streaming Toggle -->
            <div id="streaming-toggle" style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem;">
                <span style="font-size: 0.7rem; color: var(--text-secondary);">LIVE</span>
                <label style="position: relative; display: inline-block; width: 40px; height: 20px; cursor: pointer;">
                    <input type="checkbox" id="streaming-switch" onchange="toggleStreaming()" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-tertiary); border-radius: 20px; border: 1px solid var(--border-default); transition: 0.3s;"></span>
                    <span id="streaming-knob" style="position: absolute; height: 16px; width: 16px; left: 2px; bottom: 2px; background: var(--text-muted); border-radius: 50%; transition: 0.3s;"></span>
                </label>
                <span id="streaming-status-text" style="font-size: 0.65rem; color: var(--text-muted); min-width: 60px;">OFF</span>
            </div>
            
            <div class="connection-badge disconnected" id="connection-badge">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav>
        <button class="active" onclick="showSection('scanner')" data-shortcut="1">
            <span class="nav-icon">📊</span>
            Scanner
        </button>
        <button onclick="showSection('rangewatcher')" data-shortcut="2">
            <span class="nav-icon">⚡</span>
            Tools
        </button>
        <button onclick="showSection('watchlists')" data-shortcut="3">
            <span class="nav-icon">📋</span>
            Watchlists
        </button>
        <button onclick="showSection('journal')" data-shortcut="4">
            <span class="nav-icon">🏆</span>
            Seasons
        </button>
        <button onclick="showSection('history')" data-shortcut="5">
            <span class="nav-icon">📜</span>
            History
        </button>
        <!-- Settings tab hidden
        <button onclick="showSection('settings')" data-shortcut="6">
            <span class="nav-icon">⚙️</span>
            Settings
        </button>
        -->
    </nav>

    <!-- MAIN CONTENT -->
    <main>
        <!-- ===== SCANNER SECTION ===== -->
        <section id="scanner" class="section active">
            <!-- Workflow Status Bar -->
            <div id="scanner-workflow-bar" style="display: flex; gap: 1rem; align-items: center; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--accent-green);">
                <div id="scanner-mental-indicator" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;" onclick="runMentalCheck()">
                    <span style="font-size: 1.25rem;">🟢</span>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Mental: <strong style="color: var(--accent-green);">GREEN</strong></span>
                </div>
                <div style="width: 1px; height: 20px; background: var(--border-subtle);"></div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                    Trades: <strong id="scanner-trades-today">0</strong>/4
                </div>
                <div style="width: 1px; height: 20px; background: var(--border-subtle);"></div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                    P&L: <strong id="scanner-daily-pnl" style="color: var(--accent-green);">+0.0R</strong>
                </div>
                <div style="flex: 1;"></div>
                <button class="btn btn-sm" onclick="runPreTradeCheck()" style="font-size: 0.75rem;">🚦 Gate Check</button>
            </div>
            
            <!-- Quick Stats Row -->
            <div class="stats-row" id="quick-stats">
                <div class="stat-card cyan">
                    <div class="stat-label">Data Source</div>
                    <div class="stat-value cyan" id="stat-source">--</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Active Alerts</div>
                    <div class="stat-value" id="stat-alerts">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">Pending Trades</div>
                    <div class="stat-value" id="stat-trades">0</div>
                </div>
                <div class="stat-card purple" style="--before-color: var(--accent-purple);">
                    <div class="stat-label">Watchlists</div>
                    <div class="stat-value" id="stat-watchlists">0</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Quick Analyze Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">⚡</div>
                            <div>
                                Quick Analyze
                                <div class="card-subtitle">Real-time data analysis</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analyze-row">
                        <div class="input-group">
                            <label class="input-label">Symbol</label>
                            <input type="text" id="quick-symbol" placeholder="AAPL...">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Timeframe</label>
                            <select id="quick-tf">
                                <option value="5MIN">5m</option>
                                <option value="15MIN">15m</option>
                                <option value="30MIN">30m</option>
                                <option value="1HR" selected>1hr</option>
                                <option value="2HR">2hr</option>
                                <option value="4HR">4hr</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Lookback</label>
                            <select id="quick-vp-period" onchange="syncVPPeriodFromDropdown(this.value)">
                                <option value="day">📅 Day</option>
                                <option value="swing" selected>📊 Swing</option>
                                <option value="position">📈 Position</option>
                                <option value="investment">💼 Invest</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="quickAnalyze()">
                            <span style="display: inline-block; width: 8px; height: 8px; background: #00d4ff; border-radius: 50%; margin-right: 6px;"></span>ANALYZE
                        </button>
                        <button class="action-btn action-btn-primary" onclick="fullAnalysis()">
                            <span class="action-btn-icon">🎯</span>
                            <span class="action-btn-text">COMPLETE</span>
                        </button>
                    </div>
                </div>

                <!-- Manual Input Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon purple">✏️</div>
                            <div>
                                Manual Chart Input
                                <div class="card-subtitle">Enter values from your charting platform</div>
                            </div>
                        </div>
                    </div>
                    
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                        Input values directly from TradingView, ToS, or any charting platform for instant analysis.
                    </p>
                    
                    <button class="btn btn-secondary btn-block" onclick="showManualInput()">
                        Open Input Form
                    </button>
                </div>
            </div>

            <!-- Results Display -->
            <div class="card hidden" id="results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon green">📊</div>
                        <div>Analysis Results</div>
                    </div>
                </div>
                <div id="results-container"></div>
            </div>

            <!-- MTF Results -->
            <div class="card hidden" id="mtf-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon cyan">🔄</div>
                        <div>Multi-Timeframe Analysis</div>
                    </div>
                </div>
                <div id="mtf-results-container"></div>
            </div>
            
            <!-- Full Analysis Results -->
            <div class="card hidden" id="full-analysis-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));">🧠</div>
                        <div>Complete Analysis</div>
                    </div>
                </div>
                <div id="full-analysis-container"></div>
            </div>
        </section>

        <!-- ===== UNIFIED SCANNER SECTION ===== -->
        <section id="rangewatcher" class="section">
            <!-- UNIFIED SCANNER -->
            <div class="card" style="border: 1px solid var(--accent-cyan);">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));">⚡</div>
                        <div>
                            <span style="font-weight: 700; font-size: 1.1rem;">UNIFIED SCANNER</span>
                            <div class="card-subtitle">Run multiple scan types at once</div>
                        </div>
                    </div>
                    <button class="universe-btn" onclick="selectAllScanTypes()" style="font-size: 0.75rem;">Select All</button>
                </div>
                
                <!-- SCAN TYPES -->
                <div style="margin-bottom: 1.25rem;">
                    <label class="input-label" style="margin-bottom: 0.5rem; display: block;">SCAN TYPES</label>
                    <div class="scan-type-toggles">
                        <button class="scan-type-btn active" data-type="bullish" onclick="toggleScanType(this)">
                            <span class="scan-dot green"></span>Bullish
                        </button>
                        <button class="scan-type-btn active" data-type="bearish" onclick="toggleScanType(this)">
                            <span class="scan-dot red"></span>Bearish
                        </button>
                        <button class="scan-type-btn" data-type="compression" onclick="toggleScanType(this)">
                            <span class="scan-dot yellow"></span>Compression
                        </button>
                        <button class="scan-type-btn" data-type="extension" onclick="toggleScanType(this)">
                            <span class="scan-dot cyan"></span>Extension
                        </button>
                        <button class="scan-type-btn" data-type="structure" onclick="toggleScanType(this)">
                            <span class="scan-dot purple"></span>Structure
                        </button>
                        <button class="scan-type-btn" data-type="entry" onclick="toggleScanType(this)">
                            <span class="scan-dot" style="background: #ff6b9d;"></span>Entry
                        </button>
                    </div>
                </div>
                
                <!-- SYMBOLS INPUT -->
                <div style="margin-bottom: 1rem;">
                    <label class="input-label" style="margin-bottom: 0.5rem; display: block;">SYMBOLS</label>
                    <input type="text" id="unified-symbols" placeholder="AAPL, TSLA, META, NVDA..." style="width: 100%;">
                </div>
                
                <!-- QUICK LOAD -->
                <div style="margin-bottom: 1.25rem;">
                    <label class="input-label" style="margin-bottom: 0.5rem; display: block;">QUICK LOAD</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="universe-btn" onclick="loadUnifiedUniverse('mag7')">MAG 7 <span style="opacity: 0.6; font-size: 0.7rem;">7</span></button>
                        <button class="universe-btn" onclick="loadUnifiedUniverse('tech20')">TECH 20 <span style="opacity: 0.6; font-size: 0.7rem;">20</span></button>
                        <button class="universe-btn" onclick="loadUnifiedUniverse('sp50')">S&P 50 <span style="opacity: 0.6; font-size: 0.7rem;">50</span></button>
                        <button class="universe-btn" onclick="loadUnifiedUniverse('etfs')">ETFs <span style="opacity: 0.6; font-size: 0.7rem;">15</span></button>
                        <button class="universe-btn" onclick="loadUnifiedUniverse('meme')">MEME <span style="opacity: 0.6; font-size: 0.7rem;">12</span></button>
                        <button class="universe-btn" onclick="loadUnifiedFromWatchlists()" style="background: var(--bg-tertiary);">📁 My Watchlists</button>
                    </div>
                </div>
                
                <!-- TIMEFRAME + LOOKBACK + RUN BUTTON -->
                <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                    <div>
                        <label class="input-label" style="margin-bottom: 0.5rem; display: block;">TIMEFRAME</label>
                        <div class="tf-toggle-group">
                            <button class="tf-toggle" data-tf="5MIN" onclick="selectTimeframe(this)">5m</button>
                            <button class="tf-toggle" data-tf="15MIN" onclick="selectTimeframe(this)">15m</button>
                            <button class="tf-toggle active" data-tf="1HR" onclick="selectTimeframe(this)">1H</button>
                            <button class="tf-toggle" data-tf="4HR" onclick="selectTimeframe(this)">4H</button>
                            <button class="tf-toggle" data-tf="1D" onclick="selectTimeframe(this)">D</button>
                        </div>
                    </div>
                    <div>
                        <label class="input-label" style="margin-bottom: 0.5rem; display: block;">LOOKBACK</label>
                        <div class="vp-toggle-group">
                            <button class="vp-toggle" data-period="day" onclick="selectVPPeriod(this)" title="1 week">📅 Day</button>
                            <button class="vp-toggle active" data-period="swing" onclick="selectVPPeriod(this)" title="~1 month">📊 Swing</button>
                            <button class="vp-toggle" data-period="position" onclick="selectVPPeriod(this)" title="~3 months">📈 Position</button>
                            <button class="vp-toggle" data-period="investment" onclick="selectVPPeriod(this)" title="~6 months">💼 Invest</button>
                        </div>
                    </div>
                    <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-default); font-weight: 600; padding: 0.75rem 2rem; flex: 1;" onclick="runUnifiedScan()">
                        🔍 RUN SCAN
                    </button>
                </div>
                
                <!-- SCAN PROGRESS -->
                <div id="unified-scan-progress" style="margin-top: 1rem; display: none;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                        <div class="scanning-pulse" style="width: 12px; height: 12px; background: var(--accent-cyan); border-radius: 50%; animation: pulse 1s ease-in-out infinite;"></div>
                        <span id="unified-scan-status" style="font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan);">Scanning 0 / 0 symbols...</span>
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 8px; height: 6px; overflow: hidden; margin-bottom: 0.75rem;">
                        <div id="unified-scan-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green)); transition: width 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-muted);">
                        <span id="unified-bullish-status">🟢 Bullish: ⏳</span>
                        <span id="unified-bearish-status">🔴 Bearish: ⏳</span>
                        <span id="unified-extension-status">⏱️ Extension: ⏳</span>
                        <span id="unified-compression-status">⚡ Compression: ⏳</span>
                        <span id="unified-structure-status">📈 Structure: ⏳</span>
                        <span id="unified-entry-status">🎯 Entry: ⏳</span>
                    </div>
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.5; transform: scale(1.2); }
                    }
                </style>
            </div>
            
            <!-- UNIFIED RESULTS -->
            <div class="card hidden" id="unified-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));">🎯</div>
                        <div>
                            Results
                            <div class="card-subtitle" id="unified-results-summary">0 matches found</div>
                        </div>
                    </div>
                </div>
                
                <!-- FILTER TABS -->
                <div class="result-filter-tabs" style="margin-bottom: 1rem;">
                    <button class="filter-tab active" data-filter="all" onclick="filterUnifiedResults('all')">All</button>
                    <button class="filter-tab" data-filter="bullish" onclick="filterUnifiedResults('bullish')">🟢 Long</button>
                    <button class="filter-tab" data-filter="bearish" onclick="filterUnifiedResults('bearish')">🔴 Short</button>
                    <button class="filter-tab" data-filter="compression" onclick="filterUnifiedResults('compression')">⚡ Comp</button>
                    <button class="filter-tab" data-filter="extension" onclick="filterUnifiedResults('extension')">⏱️ Ext</button>
                    <button class="filter-tab" data-filter="structure" onclick="filterUnifiedResults('structure')">📈 Struct</button>
                    <button class="filter-tab" data-filter="entry" onclick="filterUnifiedResults('entry')">🎯 Entry</button>
                </div>
                
                <div id="unified-results-container" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
            
            <!-- Keep hidden result containers for backward compatibility -->
            <div class="card hidden" id="range-results-card">
                <div id="range-results-container"></div>
            </div>
            <div class="card hidden" id="compression-results-card">
                <div id="compression-results-container"></div>
            </div>
            <div class="card hidden" id="bullish-results-card">
                <div id="bullish-results-container"></div>
            </div>
            <div class="card hidden" id="bearish-results-card">
                <div id="bearish-results-container"></div>
            </div>
            <div id="extension-scan-results" style="display: none;"></div>
            
            <!-- Hidden inputs for backward compatibility -->
            <input type="hidden" id="range-symbol">
            <input type="hidden" id="compression-symbols">
            <input type="hidden" id="bullish-symbols">
            <input type="hidden" id="bearish-symbols">
            <input type="hidden" id="extension-symbols">
            <input type="hidden" id="ultimate-symbols">
            <select id="bullish-tf" style="display: none;"><option value="1HR" selected></option></select>
            <select id="bearish-tf" style="display: none;"><option value="1HR" selected></option></select>
            <select id="ultimate-tf" style="display: none;"><option value="1HR" selected></option></select>
        </section>

        <!-- Gate Check Results (hidden, shown when gate check runs) -->
        <div class="card hidden" id="workflow-results-card" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div class="card-header">
                <div class="card-title">
                    <div class="card-title-icon cyan">📋</div>
                    <div>Gate Check Results</div>
                </div>
                <button onclick="document.getElementById('workflow-results-card').classList.add('hidden')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">×</button>
            </div>
            <div id="workflow-results-container"></div>
        </div>

        <!-- ===== WATCHLISTS SECTION ===== -->
        <section id="watchlists" class="section">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">📋</div>
                            <div>My Watchlists</div>
                        </div>
                    </div>
                    
                    <div id="watchlist-pills" class="watchlist-pills"></div>
                    
                    <div id="watchlist-symbols" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 1rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;"></div>
                    
                    <div class="analyze-row" style="margin-top: 1rem;">
                        <div class="input-group" style="width: 140px;">
                            <label class="input-label">Timeframe</label>
                            <select id="scan-tf">
                                <option value="30MIN">30 min</option>
                                <option value="1HR" selected>1 hour</option>
                                <option value="2HR">2 hour</option>
                                <option value="4HR">4 hour</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="scanWatchlist()">
                            <span style="display: inline-block; width: 8px; height: 8px; background: #00d4ff; border-radius: 50%; margin-right: 6px;"></span>SCAN
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">➕</div>
                            <div>Manage Watchlists</div>
                        </div>
                    </div>
                    
                    <!-- Create New Watchlist -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Create New Watchlist</div>
                        <div class="analyze-row">
                            <div class="input-group" style="flex: 1;">
                                <input type="text" id="new-watchlist-name" placeholder="My Favorites">
                            </div>
                            <button class="btn btn-secondary" onclick="createWatchlist()">Create</button>
                        </div>
                    </div>
                    
                    <!-- Add Symbol to Watchlist -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Add Symbol</div>
                        <div class="analyze-row">
                            <div class="input-group" style="flex: 1;">
                                <input type="text" id="add-symbol-input" placeholder="AAPL, META, NVDA">
                            </div>
                            <button class="btn btn-secondary" onclick="addSymbolToWatchlist()">+ Add</button>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">Adds to: <span id="add-to-watchlist-name" style="color: var(--accent-cyan);">-</span></div>
                    </div>
                    
                    <!-- Remove Symbol -->
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Remove Symbol</div>
                        <div class="analyze-row">
                            <div class="input-group" style="flex: 1;">
                                <input type="text" id="remove-symbol-input" placeholder="AAPL">
                            </div>
                            <button class="btn btn-secondary" style="border-color: var(--accent-red); color: var(--accent-red);" onclick="removeSymbolFromWatchlist()">− Remove</button>
                        </div>
                    </div>
                    
                    <!-- Delete Watchlist -->
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle);">
                        <button class="btn btn-block" style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--accent-red); color: var(--accent-red);" onclick="deleteWatchlist()">
                            🗑️ Delete Selected Watchlist
                        </button>
                    </div>
                </div>
            </div>

            <div class="card hidden" id="scan-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon green">🔍</div>
                        <div>Scan Results</div>
                    </div>
                </div>
                
                <!-- Filter Controls -->
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Signal:</span>
                        <button class="filter-btn active" data-filter="all" onclick="filterScanResults('all')">All</button>
                        <button class="filter-btn" data-filter="GREEN" onclick="filterScanResults('GREEN')" style="border-color: var(--accent-green);">🟢</button>
                        <button class="filter-btn" data-filter="YELLOW" onclick="filterScanResults('YELLOW')" style="border-color: var(--accent-yellow);">🟡</button>
                        <button class="filter-btn" data-filter="RED" onclick="filterScanResults('RED')" style="border-color: var(--accent-red);">🔴</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Min Conf:</span>
                        <select id="min-confidence-filter" onchange="filterScanResults()" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 4px; color: var(--text-primary);">
                            <option value="0">0%</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                        </select>
                    </div>
                    <div id="scan-filter-count" style="font-size: 0.7rem; color: var(--text-muted); margin-left: auto;"></div>
                </div>
                
                <div id="scan-results-container"></div>
            </div>
            
            <!-- Alerts Section (Collapsible) -->
            <div class="card collapsible-section">
                <div class="card-header" onclick="toggleSection('alerts-section')" style="cursor: pointer;">
                    <div class="card-title">
                        <div class="card-title-icon red">🚨</div>
                        <div>Price Alerts</div>
                    </div>
                    <span class="collapse-icon" id="alerts-section-icon">▼</span>
                </div>
                <div id="alerts-section" class="collapsible-content">
                    <div class="grid-2" style="margin-top: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Create Alert</div>
                            <div class="input-group" style="margin-bottom: 0.5rem;">
                                <input type="text" id="alert-symbol" placeholder="META">
                            </div>
                            <div class="grid-2" style="gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="number" id="alert-level" placeholder="Price" step="0.01">
                                <select id="alert-direction">
                                    <option value="below">Below</option>
                                    <option value="above">Above</option>
                                </select>
                            </div>
                            <div class="grid-2" style="gap: 0.5rem; margin-bottom: 0.5rem;">
                                <select id="alert-action">
                                    <option value="SHORT">SHORT</option>
                                    <option value="LONG">LONG</option>
                                    <option value="ALERT">Alert</option>
                                </select>
                                <button class="btn btn-primary btn-sm" onclick="createAlert()">+ Add</button>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Active Alerts</div>
                            <div id="alerts-list" style="max-height: 200px; overflow-y: auto;">
                                <div class="empty-state" style="padding: 1rem;">
                                    <div class="empty-state-icon" style="font-size: 1.5rem;">🔔</div>
                                    <div class="empty-state-text" style="font-size: 0.8rem;">No alerts</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== JOURNAL SECTION (Merged Trades + Seasons + Workflow) ===== -->
        <section id="journal" class="section">
            <!-- Trade Stats Row -->
            <div class="stats-row" id="trade-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                <div class="stat-card cyan">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="ts-total">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Wins</div>
                    <div class="stat-value green" id="ts-wins">0</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Losses</div>
                    <div class="stat-value red" id="ts-losses">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value yellow" id="ts-winrate">0%</div>
                </div>
            </div>

            
            <!-- Season Stats -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon yellow">🏆</div>
                        <div>Season Performance</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-sm" onclick="createNewSeason()">+ New</button>
                        <button class="btn btn-primary btn-sm" onclick="loadSeasons()">🔄</button>
                    </div>
                </div>
                
                <!-- Season Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                    <div class="stat-card green">
                        <div class="stat-value" id="season-total-r">0R</div>
                        <div class="stat-label">Total R</div>
                    </div>
                    <div class="stat-card cyan">
                        <div class="stat-value" id="season-total-pct">0%</div>
                        <div class="stat-label">Total %</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-value" id="season-wins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-value" id="season-losses">0</div>
                        <div class="stat-label">Losses</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-value" id="season-r-recover">0R</div>
                        <div class="stat-label">To Recover</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="season-status">✅</div>
                        <div class="stat-label">Status</div>
                    </div>
                </div>
            </div>
            
            <!-- Goal Tracker with Progress Bar -->
            <div class="card" style="border-left: 3px solid var(--accent-yellow);">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon yellow">🎯</div>
                        <div>Season Goal Tracker</div>
                    </div>
                    <button class="btn btn-sm" onclick="setSeasonGoal()">📝 Set Goal</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; text-align: center; margin-bottom: 0.75rem;">
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-size: 0.65rem; color: var(--text-muted);">Goal</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-yellow);" id="goal-target">$0</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-size: 0.65rem; color: var(--text-muted);">Earned</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green);" id="goal-earned">$0</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-size: 0.65rem; color: var(--text-muted);">Remaining</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-red);" id="goal-remaining">$0</div>
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 6px;">
                        <div style="font-size: 0.65rem; color: var(--text-muted);">Progress</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-cyan);" id="goal-pct">0%</div>
                    </div>
                </div>
                <div style="background: var(--bg-tertiary); border-radius: 8px; height: 32px; position: relative; overflow: hidden;">
                    <div id="goal-progress-fill" style="height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan), var(--accent-yellow)); border-radius: 8px; transition: width 0.5s ease; width: 0%;"></div>
                    <div id="goal-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; font-weight: 700; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.7);">Set a goal to start tracking!</div>
                </div>
                <div id="goal-breakdown" style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-muted); text-align: center;"></div>
            </div>
            
            <!-- Milestone Achievement Tracker -->
            <div id="season-milestones" class="card" style="border-left: 3px solid var(--accent-yellow);">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent-yellow); margin-bottom: 0.75rem;">🎯 Milestone Progress</div>
                <div id="milestone-badges" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;"></div>
                <div id="milestone-progress-bar" style="background: var(--bg-tertiary); border-radius: 6px; height: 24px; position: relative; overflow: hidden;">
                    <div id="milestone-fill" style="height: 100%; background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan)); border-radius: 6px; transition: width 0.5s ease;"></div>
                    <div id="milestone-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);"></div>
                </div>
            </div>

            <!-- Pending Trades (Collapsible) -->
            <div class="card collapsible-section">
                <div class="card-header" onclick="toggleSection('pending-trades-section')" style="cursor: pointer;">
                    <div class="card-title">
                        <div class="card-title-icon cyan">📈</div>
                        <div>Pending Trades</div>
                    </div>
                    <span class="collapse-icon" id="pending-trades-section-icon">▼</span>
                </div>
                <div id="pending-trades-section" class="collapsible-content">
                    <div id="trades-list" style="margin-top: 1rem;">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <div class="empty-state-text">No pending trades</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Season Bracket -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon purple">📊</div>
                        <div>Season Trades</div>
                    </div>
                </div>
                <div id="season-bracket" style="min-height: 200px;">
                    <div class="empty-state">
                        <div class="empty-state-icon">🏆</div>
                        <div class="empty-state-text">No seasons yet</div>
                    </div>
                </div>
            </div>
            
            <!-- Trading Challenges (Collapsible) -->
            <div class="card collapsible-section" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.03), rgba(139, 92, 246, 0.03)); border: 1px solid var(--accent-cyan);">
                <div class="card-header" onclick="toggleSection('challenges-section')" style="cursor: pointer;">
                    <div class="card-title">
                        <div class="card-title-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));">🏁</div>
                        <div>
                            Trading Challenges
                            <div class="card-subtitle">Compete with other traders</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-sm" onclick="event.stopPropagation(); showCreateChallenge()">+ Create</button>
                        <button class="btn btn-sm" onclick="event.stopPropagation(); showJoinChallenge()">Join</button>
                        <span class="collapse-icon" id="challenges-section-icon">▼</span>
                    </div>
                </div>
                <div id="challenges-section" class="collapsible-content">
                    <div id="challenges-list" style="margin-top: 1rem;">
                        <div class="empty-state">
                            <div class="empty-state-icon">🏆</div>
                            <div class="empty-state-text">No active challenges</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== HISTORY SECTION ===== -->
        <section id="history" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon cyan">📜</div>
                        <div>Analysis History</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="history-filter" onchange="loadHistory()" style="padding: 0.4rem; font-size: 0.8rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                            <option value="all">All Analyses</option>
                            <option value="confirmed">✅ Confirmed Only</option>
                            <option value="long">🟢 Long Setups</option>
                            <option value="short">🔴 Short Setups</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadHistory()">🔄 Refresh</button>
                    </div>
                </div>
                <div id="history-list" style="max-height: 600px; overflow-y: auto;">
                    <div class="empty-state">
                        <div class="empty-state-icon">📜</div>
                        <div class="empty-state-text">No analysis history yet</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== SETTINGS SECTION ===== -->
        <section id="settings" class="section">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">🔑</div>
                            <div>API Configuration</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Finnhub API Key</label>
                        <div class="api-key-input">
                            <input type="password" id="finnhub-key" placeholder="Enter Finnhub API key">
                            <button class="btn btn-primary" onclick="setFinnhubKey()">Set</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">OpenAI API Key (for AI Commentary)</label>
                        <div class="api-key-input">
                            <input type="password" id="openai-key" placeholder="Enter OpenAI API key">
                            <button class="btn btn-primary" onclick="setOpenAIKey()">Set</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">📡</div>
                            <div>Connection Status</div>
                        </div>
                    </div>
                    
                    <div id="connection-details" style="font-size: 0.85rem; color: var(--text-secondary);">
                        <p>Checking connection status...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer>
        <span>Decision Point</span> Trading Terminal v2.0 • 
        <span id="footer-time"></span>
    </footer>

    <!-- ===== JAVASCRIPT ===== -->
    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? '' 
            : 'https://analysisgrid-production.up.railway.app';
        let selectedWatchlist = 'mag7_tech';
        
        // =====================================================================
        // ENTRY DIAGRAMS - SVG visual entry patterns
        // =====================================================================
        const ENTRY_DIAGRAMS = {
            'val_touch_rejection': {
                title: 'VAL Touch + Rejection', direction: 'LONG',
                description: 'First touch of VAL with rejection candle \u2192 Target POC/VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="75" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="45" x2="150" y2="45" stroke="#10b981" stroke-width="1.5"/><text x="155" y="48" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="105" x2="150" y2="105" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="108" fill="#ff6b6b" font-size="9">VAL</text><path d="M 80 35 L 85 55 L 80 80 L 90 100" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="100" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="109" text-anchor="middle" fill="#10b981" font-size="8" font-weight="bold">ENTRY</text><line x1="50" y1="125" x2="150" y2="125" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="128" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="75" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="100" y="67" text-anchor="middle" fill="#10b981" font-size="8">T1</text><path d="M 95 100 L 100 80" stroke="#10b981" stroke-width="2" marker-end="url(#arrowG)"/><defs><marker id="arrowG" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#10b981"/></marker></defs></svg>`
            },
            'poc_reclaim': {
                title: 'POC Reclaim', direction: 'LONG',
                description: 'Price dips below POC then reclaims \u2192 Enter on reclaim, target VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="75" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="45" x2="150" y2="45" stroke="#10b981" stroke-width="1.5"/><text x="155" y="48" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="105" x2="150" y2="105" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="108" fill="#ff6b6b" font-size="9">VAL</text><path d="M 70 55 L 75 75 L 80 90 L 90 85 L 95 75" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="70" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="79" text-anchor="middle" fill="#10b981" font-size="7" font-weight="bold">ENTRY RECLAIM</text><line x1="50" y1="125" x2="150" y2="125" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="128" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="45" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="100" y="37" text-anchor="middle" fill="#10b981" font-size="8">T1</text><path d="M 100 68 L 100 52" stroke="#10b981" stroke-width="2" marker-end="url(#arrowG2)"/><defs><marker id="arrowG2" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#10b981"/></marker></defs></svg>`
            },
            'failed_breakdown': {
                title: 'Failed Breakdown (Bear Trap)', direction: 'LONG',
                description: 'Price breaks VAL then quickly reverses back \u2192 Bears trapped = fuel for longs',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="75" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="45" x2="150" y2="45" stroke="#10b981" stroke-width="1.5"/><text x="155" y="48" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="105" x2="150" y2="105" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="108" fill="#ff6b6b" font-size="9">VAL</text><rect x="50" y="105" width="100" height="25" fill="#ff6b6b" fill-opacity="0.2"/><text x="100" y="120" text-anchor="middle" fill="#ff6b6b" font-size="7">TRAP ZONE</text><path d="M 70 75 L 75 95 L 85 115 L 95 125 L 105 120 L 110 105 L 115 90" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="98" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="107" text-anchor="middle" fill="#10b981" font-size="7" font-weight="bold">ENTRY RECLAIM</text><line x1="50" y1="140" x2="150" y2="140" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="143" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="45" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="100" y="37" text-anchor="middle" fill="#10b981" font-size="8">T1</text><path d="M 118 88 L 108 52" stroke="#10b981" stroke-width="2" marker-end="url(#arrowG3)"/><defs><marker id="arrowG3" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#10b981"/></marker></defs></svg>`
            },
            'vah_touch_rejection': {
                title: 'VAH Touch + Rejection', direction: 'SHORT',
                description: 'First touch of VAH with rejection candle \u2192 Target POC/VAL',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="90" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="60" x2="150" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="155" y="63" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="93" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text><path d="M 80 135 L 85 110 L 80 80 L 90 65" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="55" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="64" text-anchor="middle" fill="#ff6b6b" font-size="8" font-weight="bold">ENTRY</text><line x1="50" y1="40" x2="150" y2="40" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="43" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="90" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="102" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text><path d="M 95 67 L 100 84" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowR)"/><defs><marker id="arrowR" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs></svg>`
            },
            'poc_rejection': {
                title: 'POC Rejection', direction: 'SHORT',
                description: 'Price rallies to POC from below, fails to hold \u2192 Short on rejection',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="90" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="60" x2="150" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="155" y="63" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="93" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text><path d="M 70 140 L 80 115 L 90 95 L 100 85 L 105 95" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="85" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="94" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">ENTRY REJECT</text><line x1="50" y1="50" x2="150" y2="50" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="53" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="120" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="132" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text><path d="M 108 97 L 105 114" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowR2)"/><defs><marker id="arrowR2" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs></svg>`
            },
            'failed_breakout': {
                title: 'Failed Breakout (Bull Trap)', direction: 'SHORT',
                description: 'Price breaks VAH then quickly reverses back \u2192 Bulls trapped = fuel for shorts',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="90" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="60" x2="150" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="155" y="63" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="93" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text><rect x="50" y="35" width="100" height="25" fill="#10b981" fill-opacity="0.2"/><text x="100" y="50" text-anchor="middle" fill="#10b981" font-size="7">TRAP ZONE</text><path d="M 70 100 L 80 75 L 90 50 L 100 35 L 110 40 L 115 60 L 120 80" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="55" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="64" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">ENTRY ON FAIL</text><line x1="50" y1="25" x2="150" y2="25" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="28" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="120" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="132" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text><path d="M 123 82 L 110 114" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowR3)"/><defs><marker id="arrowR3" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs></svg>`
            },
            'breakout_retest_long': {
                title: 'Breakout + Retest (Long)', direction: 'LONG',
                description: 'Clean break above VAH, enter on retest \u2192 Target 1x extension',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="45" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><ellipse cx="100" cy="105" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><rect x="80" y="45" width="40" height="60" fill="#5a3d3d"/><line x1="80" y1="45" x2="80" y2="105" stroke="#ff6b6b" stroke-width="2"/><line x1="120" y1="45" x2="120" y2="105" stroke="#ff6b6b" stroke-width="2"/><line x1="50" y1="50" x2="150" y2="50" stroke="#10b981" stroke-width="1.5"/><text x="155" y="53" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="8">LVN</text><line x1="50" y1="100" x2="150" y2="100" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="103" fill="#ff6b6b" font-size="9">VAL</text><path d="M 75 85 L 80 65 L 90 45 L 100 30 L 108 35 L 112 50 L 116 40" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="45" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="54" text-anchor="middle" fill="#10b981" font-size="7" font-weight="bold">ENTRY RETEST</text><line x1="50" y1="65" x2="150" y2="65" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="68" fill="#ff0000" font-size="8">STOP</text><line x1="50" y1="20" x2="150" y2="20" stroke="#66ccff" stroke-width="1"/><circle cx="100" cy="20" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="100" y="14" text-anchor="middle" fill="#10b981" font-size="7">T1 +1x</text></svg>`
            },
            'breakout_retest_short': {
                title: 'Breakout + Retest (Short)', direction: 'SHORT',
                description: 'Clean break below VAL, enter on retest \u2192 Target 1x extension',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="55" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><ellipse cx="100" cy="115" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><rect x="80" y="55" width="40" height="60" fill="#5a3d3d"/><line x1="80" y1="55" x2="80" y2="115" stroke="#ff6b6b" stroke-width="2"/><line x1="120" y1="55" x2="120" y2="115" stroke="#ff6b6b" stroke-width="2"/><line x1="50" y1="60" x2="150" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="155" y="63" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="85" x2="150" y2="85" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="88" fill="#ffcc00" font-size="8">LVN</text><line x1="50" y1="110" x2="150" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="113" fill="#ff6b6b" font-size="9">VAL</text><path d="M 75 75 L 80 95 L 90 115 L 100 135 L 108 130 L 112 115 L 118 125" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="105" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="114" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">ENTRY RETEST</text><line x1="50" y1="95" x2="150" y2="95" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="98" fill="#ff0000" font-size="8">STOP</text><line x1="50" y1="160" x2="150" y2="160" stroke="#ff9966" stroke-width="1"/><circle cx="100" cy="160" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="172" text-anchor="middle" fill="#ff6b6b" font-size="7">T1 +1x</text></svg>`
            },
            'lvn_rejection_long': {
                title: 'LVN Speed Zone (Long)', direction: 'LONG',
                description: 'Price enters LVN from below, rejected back \u2192 Trade rejection back to HVN',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="45" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><ellipse cx="100" cy="115" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><rect x="80" y="45" width="40" height="70" fill="#5a3d3d"/><rect x="50" y="60" width="100" height="35" fill="#ffcc00" fill-opacity="0.15"/><text x="155" y="82" fill="#ffcc00" font-size="7">LVN</text><line x1="50" y1="50" x2="150" y2="50" stroke="#10b981" stroke-width="1.5"/><text x="155" y="53" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="80" x2="150" y2="80" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><line x1="50" y1="110" x2="150" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="113" fill="#ff6b6b" font-size="9">VAL</text><path d="M 75 130 L 80 110 L 90 85 L 95 75 L 100 85 L 105 100" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="100" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="109" text-anchor="middle" fill="#10b981" font-size="7" font-weight="bold">LONG REJECT</text><line x1="50" y1="65" x2="150" y2="65" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="68" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="140" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="100" y="152" text-anchor="middle" fill="#10b981" font-size="8">T1</text></svg>`
            },
            'lvn_rejection_short': {
                title: 'LVN Speed Zone (Short)', direction: 'SHORT',
                description: 'Price enters LVN from above, rejected back \u2192 Trade rejection back to HVN',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="55" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><ellipse cx="100" cy="125" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><rect x="80" y="55" width="40" height="70" fill="#5a3d3d"/><rect x="50" y="75" width="100" height="35" fill="#ffcc00" fill-opacity="0.15"/><text x="155" y="97" fill="#ffcc00" font-size="7">LVN</text><line x1="50" y1="60" x2="150" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="155" y="63" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text><path d="M 75 40 L 80 60 L 90 85 L 95 95 L 100 85 L 105 70" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="78" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="87" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">SHORT REJECT</text><line x1="50" y1="105" x2="150" y2="105" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="108" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="30" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="22" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text></svg>`
            },
            'volume_break_long': {
                title: 'Volume Confirmation Break (Long)', direction: 'LONG',
                description: 'Breakout with 2x+ avg volume \u2192 Confirms conviction, no retest needed',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="90" cy="55" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><ellipse cx="90" cy="115" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><rect x="75" y="55" width="30" height="60" fill="#5a3d3d"/><line x1="45" y1="60" x2="135" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="140" y="63" fill="#10b981" font-size="8">VAH</text><line x1="45" y1="85" x2="135" y2="85" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="140" y="88" fill="#ffcc00" font-size="8">POC</text><line x1="45" y1="110" x2="135" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="140" y="113" fill="#ff6b6b" font-size="8">VAL</text><path d="M 65 105 L 70 85 L 80 60 L 90 40 L 100 25" stroke="#fff" stroke-width="2.5" fill="none"/><rect x="155" y="130" width="8" height="20" fill="#4a9eff" opacity="0.5"/><rect x="165" y="115" width="8" height="35" fill="#4a9eff" opacity="0.6"/><rect x="175" y="85" width="8" height="65" fill="#10b981" opacity="0.9"/><text x="170" y="160" text-anchor="middle" fill="#aaa" font-size="6">VOL</text><rect x="45" y="50" width="90" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="90" y="59" text-anchor="middle" fill="#10b981" font-size="6" font-weight="bold">ENTRY W/ VOLUME</text><line x1="45" y1="75" x2="135" y2="75" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="140" y="78" fill="#ff0000" font-size="7">STOP</text><circle cx="90" cy="20" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="90" y="12" text-anchor="middle" fill="#10b981" font-size="7">T1</text></svg>`
            },
            'volume_break_short': {
                title: 'Volume Confirmation Break (Short)', direction: 'SHORT',
                description: 'Breakdown with 2x+ avg volume \u2192 Confirms conviction, no retest needed',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="90" cy="55" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><ellipse cx="90" cy="115" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/><rect x="75" y="55" width="30" height="60" fill="#5a3d3d"/><line x1="45" y1="60" x2="135" y2="60" stroke="#10b981" stroke-width="1.5"/><text x="140" y="63" fill="#10b981" font-size="8">VAH</text><line x1="45" y1="85" x2="135" y2="85" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="140" y="88" fill="#ffcc00" font-size="8">POC</text><line x1="45" y1="110" x2="135" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="140" y="113" fill="#ff6b6b" font-size="8">VAL</text><path d="M 65 65 L 70 85 L 80 110 L 90 130 L 100 150" stroke="#fff" stroke-width="2.5" fill="none"/><rect x="155" y="130" width="8" height="20" fill="#4a9eff" opacity="0.5"/><rect x="165" y="115" width="8" height="35" fill="#4a9eff" opacity="0.6"/><rect x="175" y="85" width="8" height="65" fill="#ff6b6b" opacity="0.9"/><text x="170" y="160" text-anchor="middle" fill="#aaa" font-size="6">VOL</text><rect x="45" y="105" width="90" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="90" y="114" text-anchor="middle" fill="#ff6b6b" font-size="6" font-weight="bold">ENTRY W/ VOLUME</text><line x1="45" y1="95" x2="135" y2="95" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="140" y="98" fill="#ff0000" font-size="7">STOP</text><circle cx="90" cy="160" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="90" y="172" text-anchor="middle" fill="#ff6b6b" font-size="7">T1</text></svg>`
            },
            'long_mr': {
                title: 'Mean Reversion Long', direction: 'LONG',
                description: 'Extended 1.5+ ATR below value \u2192 Fade back to POC/VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="60" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="35" x2="150" y2="35" stroke="#10b981" stroke-width="1.5"/><text x="155" y="38" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="60" x2="150" y2="60" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="63" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="85" x2="150" y2="85" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="88" fill="#ff6b6b" font-size="9">VAL</text><rect x="50" y="110" width="100" height="30" fill="#4ade80" fill-opacity="0.15"/><text x="100" y="128" text-anchor="middle" fill="#4ade80" font-size="8">EXTENDED 1.5+ ATR</text><path d="M 70 50 L 75 70 L 85 95 L 95 115 L 100 125 L 108 120 L 112 100" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="115" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="124" text-anchor="middle" fill="#10b981" font-size="7" font-weight="bold">MR LONG</text><line x1="50" y1="145" x2="150" y2="145" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="148" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="60" r="6" fill="none" stroke="#10b981" stroke-width="2"/><text x="100" y="52" text-anchor="middle" fill="#10b981" font-size="8">T1</text><path d="M 115 98 L 105 68" stroke="#10b981" stroke-width="2" marker-end="url(#arrowMR)"/><defs><marker id="arrowMR" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#10b981"/></marker></defs></svg>`
            },
            'short_mr': {
                title: 'Mean Reversion Short', direction: 'SHORT',
                description: 'Extended 1.5+ ATR above value \u2192 Fade back to POC/VAL',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="100" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="75" x2="150" y2="75" stroke="#10b981" stroke-width="1.5"/><text x="155" y="78" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="100" x2="150" y2="100" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="103" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="125" x2="150" y2="125" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="128" fill="#ff6b6b" font-size="9">VAL</text><rect x="50" y="30" width="100" height="30" fill="#f87171" fill-opacity="0.15"/><text x="100" y="48" text-anchor="middle" fill="#f87171" font-size="8">EXTENDED 1.5+ ATR</text><path d="M 70 115 L 75 90 L 85 65 L 95 45 L 100 35 L 108 40 L 112 60" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="38" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="47" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">MR SHORT</text><line x1="50" y1="20" x2="150" y2="20" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="23" fill="#ff0000" font-size="8">STOP</text><circle cx="100" cy="100" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="112" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text><path d="M 115 62 L 105 92" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowMRS)"/><defs><marker id="arrowMRS" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs></svg>`
            },
            'long_trend': {
                title: 'Trend Continuation Long', direction: 'LONG',
                description: 'Holding above value area \u2192 Trend continuation, buy dips to VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="120" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="95" x2="150" y2="95" stroke="#10b981" stroke-width="1.5"/><text x="155" y="98" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="120" x2="150" y2="120" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="123" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="145" x2="150" y2="145" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="148" fill="#ff6b6b" font-size="9">VAL</text><rect x="50" y="30" width="100" height="60" fill="#10b981" fill-opacity="0.1"/><text x="100" y="55" text-anchor="middle" fill="#10b981" font-size="8">ABOVE VALUE</text><path d="M 60 130 L 70 105 L 85 75 L 95 55 L 105 45 L 115 55 L 120 70 L 130 50 L 140 35" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="60" width="100" height="12" fill="#10b981" fill-opacity="0.3" stroke="#10b981"/><text x="100" y="69" text-anchor="middle" fill="#10b981" font-size="7" font-weight="bold">BUY DIPS</text><line x1="50" y1="85" x2="150" y2="85" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="88" fill="#ff0000" font-size="8">STOP</text><text x="100" y="25" text-anchor="middle" fill="#10b981" font-size="9">\u2191 TREND \u2191</text></svg>`
            },
            'short_trend': {
                title: 'Trend Continuation Short', direction: 'SHORT',
                description: 'Holding below value area \u2192 Trend continuation, sell rips to VAL',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg"><rect width="200" height="180" fill="#1a1a2e"/><ellipse cx="100" cy="50" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/><line x1="50" y1="25" x2="150" y2="25" stroke="#10b981" stroke-width="1.5"/><text x="155" y="28" fill="#10b981" font-size="9">VAH</text><line x1="50" y1="50" x2="150" y2="50" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="53" fill="#ffcc00" font-size="9">POC</text><line x1="50" y1="75" x2="150" y2="75" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="78" fill="#ff6b6b" font-size="9">VAL</text><rect x="50" y="90" width="100" height="60" fill="#ff6b6b" fill-opacity="0.1"/><text x="100" y="125" text-anchor="middle" fill="#ff6b6b" font-size="8">BELOW VALUE</text><path d="M 60 40 L 70 65 L 85 95 L 95 115 L 105 125 L 115 115 L 120 100 L 130 120 L 140 140" stroke="#fff" stroke-width="2" fill="none"/><rect x="50" y="100" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="109" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">SELL RIPS</text><line x1="50" y1="85" x2="150" y2="85" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="88" fill="#ff0000" font-size="8">STOP</text><text x="100" y="165" text-anchor="middle" fill="#ff6b6b" font-size="9">\u2193 TREND \u2193</text></svg>`
            }
        };

        function getEntryDiagram(signalType, entrySignal) {
            let key = null;
            if (entrySignal) {
                const parts = entrySignal.split(':');
                key = parts[0].toLowerCase();
            }
            if (!key || !ENTRY_DIAGRAMS[key]) {
                if (signalType) {
                    // Map chart_input_analyzer signal_type values to diagram keys
                    const sigMap = {
                        'long_mean_reversion': 'long_mr',
                        'short_mean_reversion': 'short_mr',
                        'long_trend': 'long_trend',
                        'short_trend': 'short_trend',
                        'long_setup': 'long_mr',
                        'short_setup': 'short_mr'
                    };
                    key = sigMap[signalType.toLowerCase()] || signalType.toLowerCase();
                }
            }
            const diagram = ENTRY_DIAGRAMS[key];
            if (!diagram) return '';
            const dirColor = diagram.direction === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)';
            return `
                <div class="entry-diagram-container">
                    <h4>
                        <span style="font-size: 1.2rem;">\ud83d\udcca</span>
                        ${diagram.title}
                        <span style="color: ${dirColor}; font-size: 0.85rem; margin-left: auto;">${diagram.direction}</span>
                    </h4>
                    ${diagram.svg}
                    <div class="diagram-description">${diagram.description}</div>
                </div>
            `;
        }
        
        // =====================================================================
        // FIREBASE CONFIG - Replace with your Firebase project config
        // =====================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB4oBeoFzFV2oS5ZxEvQ4TIRRVJFC3nl-w",
            authDomain: "analysis-grid.firebaseapp.com",
            projectId: "analysis-grid",
            storageBucket: "analysis-grid.firebasestorage.app",
            messagingSenderId: "633207767657",
            appId: "1:633207767657:web:e623871eca352a268b58f8",
            measurementId: "G-DNWVRX4990"
        };
        
        // Initialize Firebase
        let auth = null;
        let db = null;  // Firestore
        let currentUser = null;
        let authToken = null;
        
        // Set to false to disable auth requirement (for testing)
        const AUTH_REQUIRED = false;
        
        if (firebaseConfig.apiKey !== "YOUR_FIREBASE_API_KEY") {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();  // Initialize Firestore
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    authToken = await user.getIdToken();
                    localStorage.setItem('authToken', authToken);
                    showUserInfo(user);
                    loadSubscriptionStatus();
                    updateSharedTradesBadge(); // Check for shared trades
                    loadSeasons(); // Load seasons on login
                    loadChallenges(); // Load challenges on login
                } else if (AUTH_REQUIRED) {
                    // Redirect to login
                    window.location.href = 'login.html';
                }
            });
        } else {
            console.log('🔓 Auth not configured - running in open mode');
        }
        
        function showUserInfo(user) {
            const el = document.getElementById('user-info');
            if (el) {
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
            }
        }
        
        async function loadSubscriptionStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/payments/subscription`, {
                    headers: { 'uid': currentUser.uid }
                });
                const data = await res.json();
                
                const tierEl = document.getElementById('user-tier');
                if (tierEl) {
                    tierEl.textContent = data.tier.toUpperCase();
                    if (data.tier === 'premium') tierEl.style.background = 'var(--accent-purple)';
                    else if (data.tier === 'pro') tierEl.style.background = 'var(--accent-cyan)';
                    else if (data.tier === 'basic') tierEl.style.background = 'var(--accent-green)';
                    else tierEl.style.background = 'var(--text-muted)';
                }
            } catch (e) {
                console.log('Subscription check skipped');
            }
        }
        
        function logout() {
            if (auth) {
                auth.signOut();
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userUid');
            window.location.href = 'login.html';
        }
        
        // Get auth headers for API calls
        function getAuthHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (currentUser) {
                headers['Authorization'] = `Bearer ${authToken}`;
                headers['uid'] = currentUser.uid;
            }
            return headers;
        }
        
        // Get user ID query param for Firestore storage
        function getUserParam() {
            return currentUser ? `user_id=${currentUser.uid}` : '';
        }
        
        // Build URL with user param
        function withUser(url) {
            if (!currentUser) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}user_id=${currentUser.uid}`;
        }

        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================
        
        function fmtMoney(val, decimals = 2) {
            const num = Number(val);
            if (isNaN(num) || val === null || val === undefined) return '-';
            return '$' + num.toFixed(decimals);
        }
        
        function fmtPercent(val, decimals = 1) {
            const num = Number(val);
            if (isNaN(num) || val === null || val === undefined) return '-';
            return num.toFixed(decimals) + '%';
        }
        
        // =====================================================================
        // EXTENSION DURATION PREDICTOR (THE EDGE)
        // =====================================================================
        
        function renderExtensionPanel(data) {
            if (!data.extension || !data.extension.hottest_setup) {
                return ''; // No extension data
            }
            
            const ext = data.extension;
            const hottest = ext.hottest_setup;
            
            if (!hottest || hottest.candles < 2) {
                return ''; // Not actionable yet
            }
            
            const triggerColors = {
                'WATCHING': 'var(--text-muted)',
                'ALERT': 'var(--accent-yellow)',
                'HIGH_PROB': 'var(--accent-green)',
                'EXTREME': 'var(--accent-cyan)'
            };
            
            const triggerColor = triggerColors[hottest.trigger] || 'var(--text-muted)';
            const tradeDirection = hottest.direction === 'above' ? 'SHORT' : 'LONG';
            const tradeColor = tradeDirection === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)';
            
            return `
                <div style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.05) 0%, rgba(0, 0, 0, 0) 100%); border: 1px solid ${triggerColor}; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;">
                            ⏱️ Extension Duration Predictor
                        </div>
                        <div style="font-size: 1.2rem;">
                            ${hottest.trigger_emoji || '🔥'}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; text-align: center;">
                        <div>
                            <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Level</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--text-primary);">
                                ${hottest.level?.toUpperCase() || '-'} ${hottest.direction === 'above' ? '▲' : '▼'}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Duration</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: ${triggerColor}; font-weight: 700;">
                                ${hottest.candles} candles (${hottest.hours}h)
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Snap-Back</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-cyan); font-weight: 700;">
                                ${hottest.snap_back_prob || 0}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            <span style="color: ${triggerColor}; font-weight: 600;">${hottest.trigger}</span> - 
                            ${hottest.has_rejection ? '✓ Rejection candle' : 'Waiting for rejection'}
                        </div>
                        <div style="background: ${tradeColor}; color: var(--bg-primary); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">
                            ${tradeDirection} SETUP
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Order Flow Analysis Panel (Lite - candle-based)
        function renderOrderFlowPanel(data) {
            const of = data.order_flow;
            if (!of) return '';
            
            const biasColor = of.flow_bias === 'BULLISH' ? 'var(--accent-green)' : of.flow_bias === 'BEARISH' ? 'var(--accent-red)' : 'var(--text-muted)';
            const biasBg = of.flow_bias === 'BULLISH' ? 'rgba(16, 185, 129,0.15)' : of.flow_bias === 'BEARISH' ? 'rgba(255,68,68,0.15)' : 'rgba(255,255,255,0.1)';
            
            return `
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(0,191,255,0.05); border: 1px solid rgba(0,191,255,0.3); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;">
                            📊 Order Flow Analysis
                        </div>
                        <div style="background: ${biasBg}; color: ${biasColor}; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">
                            ${of.flow_bias}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Buy Pressure:</span>
                                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--accent-green);">${of.buy_pressure}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Sell Pressure:</span>
                                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--accent-red);">${of.sell_pressure}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Bars Analyzed:</span>
                                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--accent-cyan);">${of.total_trades_analyzed}</span>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">High Vol Bars:</span>
                                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--accent-yellow);">${of.large_block_trades}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Green/Red:</span>
                                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem;"><span style="color: var(--accent-green);">${of.large_buys}</span> / <span style="color: var(--accent-red);">${of.large_sells}</span></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.75rem; color: var(--text-muted);">Vol vs Prev:</span>
                                <span style="font-family: 'JetBrains Mono'; font-size: 0.8rem; color: ${of.volume_spike ? 'var(--accent-yellow)' : 'var(--text-secondary)'};">${of.volume_ratio}x ${of.volume_spike ? '🔥' : ''}</span>
                            </div>
                        </div>
                    </div>
                    ${of.momentum ? `
                        <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle); text-align: center; font-size: 0.8rem;">
                            <span style="color: var(--text-muted);">Recent Momentum:</span>
                            <span style="color: ${of.momentum.includes('BUY') ? 'var(--accent-green)' : of.momentum.includes('SELL') ? 'var(--accent-red)' : 'var(--text-secondary)'}; font-weight: 600; margin-left: 0.5rem;">${of.momentum}</span>
                        </div>
                    ` : ''}
                    ${of.volume_spike ? `<div style="font-size: 0.7rem; color: var(--accent-yellow); margin-top: 0.5rem; text-align: center;">⚠️ VOLUME SPIKE - Increased activity</div>` : ''}
                </div>
            `;
        }
        
        async function scanExtensions() {
            const container = document.getElementById('extension-scan-results');
            if (!container) return;
            
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Scanning for extension setups... (scanning watchlists)</div>';
            
            // Get symbols from input or use empty for watchlist scan
            const symbolsInput = document.getElementById('extension-symbols')?.value || '';
            const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            
            try {
                const data = await fetchJson(`${API_BASE}/api/extension/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(symbols.length > 0 ? symbols : [])
                });
                
                if (!data.results || data.results.length === 0) {
                    container.innerHTML = `<div style="color: var(--text-muted); padding: 1rem; text-align: center;">
                        No extension setups found (scanned ${data.scanned || 0} symbols)
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Try again when market is more extended from value</div>
                    </div>`;
                    return;
                }
                
                container.innerHTML = `
                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.5rem;">
                        Found ${data.count} extension setups from ${data.scanned} symbols scanned
                    </div>
                ` + data.results.map(r => `
                    <div onclick="quickAnalyzeSymbol('${r.symbol}')" style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid ${r.setup.direction === 'above' ? 'var(--accent-red)' : 'var(--accent-green)'};">
                        <div>
                            <span style="font-weight: 600; color: var(--accent-cyan);">${r.symbol}</span>
                            <span style="margin-left: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">$${r.price}</span>
                            <span style="margin-left: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">${r.setup.level?.toUpperCase()} ${r.setup.direction === 'above' ? '▲' : '▼'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">${r.setup.trigger_emoji}</span>
                            <div style="text-align: right;">
                                <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-yellow);">
                                    ${r.setup.candles} candles (${r.setup.hours}h)
                                </div>
                                <div style="font-size: 0.7rem; color: var(--accent-cyan);">
                                    ${r.setup.snap_back_prob}% snap-back
                                </div>
                            </div>
                            <span style="background: ${r.setup.direction === 'above' ? 'var(--accent-red)' : 'var(--accent-green)'}; color: var(--bg-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">
                                ${r.setup.direction === 'above' ? 'SHORT' : 'LONG'}
                            </span>
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function fetchJson(url, options = {}) {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }
        
        function showToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const colors = {
                success: 'var(--accent-green)',
                error: 'var(--accent-red)',
                info: 'var(--accent-cyan)'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                padding: 0.75rem 1.25rem;
                background: var(--bg-elevated);
                border: 1px solid ${colors[type] || colors.info};
                border-left: 3px solid ${colors[type] || colors.info};
                border-radius: 6px;
                color: var(--text-primary);
                font-size: 0.85rem;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            // Show selected
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('active');
            // Update nav
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            const navBtn = document.querySelector(`nav button[onclick*="${sectionId}"]`);
            if (navBtn) navBtn.classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'watchlists') { loadWatchlists(); loadAlerts(); }
            if (sectionId === 'journal') { loadSeasons(); loadTrades(); loadChallenges(); updateScannerWorkflowBar(); }
            if (sectionId === 'scanner') updateScannerWorkflowBar();
            if (sectionId === 'tools') populateExtensionWatchlistSelect();
        }
        
        function toggleSection(sectionId) {
            const card = document.getElementById(sectionId).closest('.collapsible-section');
            if (card) card.classList.toggle('collapsed');
        }
        
        function updateScannerWorkflowBar() {
            // Update scanner workflow bar with season data
            let todayTrades = 0;
            let todayR = 0;
            
            if (currentSeason && currentSeason.trades) {
                const today = new Date().toISOString().split('T')[0];
                const todaysTradesList = currentSeason.trades.filter(t => 
                    (t.closed_at || t.created_at || '').startsWith(today)
                );
                todayTrades = todaysTradesList.length;
                todayR = todaysTradesList.reduce((sum, t) => sum + (t.r_multiple || 0), 0);
            }
            
            const tradesTodayEl = document.getElementById('scanner-trades-today');
            const dailyPnlEl = document.getElementById('scanner-daily-pnl');
            
            if (tradesTodayEl) tradesTodayEl.textContent = todayTrades;
            if (dailyPnlEl) {
                dailyPnlEl.textContent = `${todayR >= 0 ? '+' : ''}${todayR.toFixed(1)}R`;
                dailyPnlEl.style.color = todayR >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Only if not in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            
            // Ctrl/Cmd + number for navigation
            if (e.ctrlKey || e.metaKey) {
                const sections = ['scanner', 'rangewatcher', 'watchlists', 'journal', 'history', 'settings'];
                const num = parseInt(e.key);
                if (num >= 1 && num <= 6) {
                    e.preventDefault();
                    const sectionId = sections[num - 1];
                    showSection(sectionId);
                }
            }
            
            // Quick shortcuts without Ctrl
            if (e.key === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                document.getElementById('workflow-results-card')?.classList.add('hidden');
            }
        });

        function getSignalClass(signal) {
            if (signal.includes('LONG')) return 'signal-long';
            if (signal.includes('SHORT')) return 'signal-short';
            // Everything else (YELLOW, NEUTRAL, etc.) is treated as YELLOW
            return 'signal-yellow';
        }

        function buildScenarioGauge(highProb, lowProb) {
            const h = highProb || 0;
            const l = lowProb || 0;
            const spread = h - l;
            const absSpread = Math.abs(spread);
            let label, labelColor, emoji;
            if (absSpread < 10) { label = 'NEUTRAL'; labelColor = 'var(--accent-yellow)'; emoji = '⚖️'; }
            else if (spread >= 10 && spread < 25) { label = 'LEAN BULL'; labelColor = 'var(--accent-green)'; emoji = '🟢'; }
            else if (spread >= 25) { label = 'STRONG BULL'; labelColor = 'var(--accent-green)'; emoji = '🟢🟢'; }
            else if (spread <= -10 && spread > -25) { label = 'LEAN BEAR'; labelColor = 'var(--accent-red)'; emoji = '🔴'; }
            else { label = 'STRONG BEAR'; labelColor = 'var(--accent-red)'; emoji = '🔴🔴'; }
            const barGreen = `rgba(16, 185, 129,${Math.min(h/100, 0.9).toFixed(2)})`;
            const barRed = `rgba(239, 68, 68,${Math.min(l/100, 0.9).toFixed(2)})`;
            return `
            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Scenario Bias</span>
                    <span style="font-size: 0.85rem; font-weight: 700; color: ${labelColor}; letter-spacing: 0.5px;">${emoji} ${label}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-green); min-width: 36px; text-align: right;">${h.toFixed(0)}%</span>
                    <div style="flex: 1; height: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; overflow: hidden; position: relative;">
                        <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${h}%; background: linear-gradient(90deg, ${barGreen}, rgba(16, 185, 129,0.3)); border-radius: 5px 0 0 5px; transition: width 0.5s;"></div>
                        <div style="position: absolute; right: 0; top: 0; height: 100%; width: ${l}%; background: linear-gradient(-90deg, ${barRed}, rgba(239, 68, 68,0.3)); border-radius: 0 5px 5px 0; transition: width 0.5s;"></div>
                        <div style="position: absolute; left: 50%; top: -2px; width: 2px; height: 14px; background: rgba(255,255,255,0.3); transform: translateX(-50%);"></div>
                    </div>
                    <span style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-red); min-width: 36px;">${l.toFixed(0)}%</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 0.35rem;">
                    <span style="font-size: 0.6rem; color: var(--text-muted);">HIGH ▲</span>
                    <span style="font-size: 0.6rem; color: var(--text-muted);">▼ LOW</span>
                </div>
            </div>`;
        }

        function getSignalEmoji(signal) {
            if (signal.includes('LONG')) return '🟢';
            if (signal.includes('SHORT')) return '🔴';
            // Everything else shows as YELLOW (stoplight system)
            return '🟡';
        }
        
        function getLeanArrow(bullScore, bearScore) {
            // Show directional lean for YELLOW/NEUTRAL signals
            const diff = (bullScore || 0) - (bearScore || 0);
            if (diff > 5) {
                return '<span style="color: var(--accent-green); font-weight: bold; margin-left: 4px;">↑</span>';
            } else if (diff < -5) {
                return '<span style="color: var(--accent-red); font-weight: bold; margin-left: 4px;">↓</span>';
            }
            return '<span style="color: var(--text-muted); font-weight: bold; margin-left: 4px;">→</span>';
        }
        
        function getSignalWithLean(signal, bullScore, bearScore) {
            const emoji = getSignalEmoji(signal);
            const signalClass = getSignalClass(signal);
            
            // Normalize signal name - treat NEUTRAL as YELLOW
            let displaySignal = signal;
            if (signal === 'NEUTRAL' || (!signal.includes('LONG') && !signal.includes('SHORT') && !signal.includes('YELLOW'))) {
                displaySignal = 'YELLOW';
            }
            
            // For YELLOW signals, add lean arrow
            if (!signal.includes('LONG') && !signal.includes('SHORT')) {
                const arrow = getLeanArrow(bullScore, bearScore);
                return `<span class="signal ${signalClass}">${emoji} ${displaySignal}${arrow}</span>`;
            }
            
            return `<span class="signal ${signalClass}">${emoji} ${displaySignal}</span>`;
        }

        // =====================================================================
        // CLOCK & STATUS
        // =====================================================================
        
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
            document.getElementById('market-time').textContent = timeStr;
            document.getElementById('footer-time').textContent = now.toLocaleString();
            
            // Check if market is open (simplified - EST 9:30-16:00)
            const hour = now.getHours();
            const isOpen = hour >= 9 && hour < 16;
            const statusEl = document.getElementById('market-status');
            
            if (isOpen) {
                statusEl.classList.remove('closed');
                statusEl.innerHTML = '<div class="status-dot"></div><span>MARKET OPEN</span>';
            } else {
                statusEl.classList.add('closed');
                statusEl.innerHTML = '<div class="status-dot"></div><span>MARKET CLOSED</span>';
            }
        }
        
        setInterval(updateClock, 1000);
        updateClock();

        async function checkStatus() {
            try {
                const data = await fetchJson(`${API_BASE}/api/status`);
                
                const badge = document.getElementById('connection-badge');
                if (data.finnhub_connected || data.polygon_connected || data.alpaca_connected) {
                    badge.className = 'connection-badge connected';
                    badge.innerHTML = '<div class="status-dot"></div><span>Connected</span>';
                } else {
                    badge.className = 'connection-badge disconnected';
                    badge.innerHTML = '<div class="status-dot"></div><span>Disconnected</span>';
                }
                
                // Update stats
                document.getElementById('stat-source').textContent = data.data_source || 'None';
                document.getElementById('stat-alerts').textContent = data.active_alerts || 0;
                document.getElementById('stat-trades').textContent = data.pending_trades || 0;
                document.getElementById('stat-watchlists').textContent = data.watchlists || 0;
                
                // Update streaming status indicator
                updateStreamingIndicator(data.streaming);
                
                // Update connection details
                const streamingInfo = data.streaming 
                    ? `<p><strong>Streaming:</strong> ${data.streaming.connected ? '📡 LIVE' : '⏸️ Stopped'} (${data.streaming.subscribed_count || 0} symbols)</p>`
                    : '<p><strong>Streaming:</strong> Not available</p>';
                    
                document.getElementById('connection-details').innerHTML = `
                    <p><strong>Data Source:</strong> ${data.data_source || 'None'}</p>
                    <p><strong>Finnhub:</strong> ${data.finnhub_connected ? '✅ Connected' : '❌ Not connected'}</p>
                    <p><strong>ChatGPT:</strong> ${data.chatgpt_enabled ? '✅ Enabled' : '❌ Not enabled'}</p>
                    <p><strong>Watchlists:</strong> ${data.watchlists} lists, ${data.total_symbols} symbols</p>
                    ${streamingInfo}
                `;
                
            } catch (e) {
                console.error('Status check failed:', e);
                document.getElementById('connection-badge').className = 'connection-badge disconnected';
                document.getElementById('connection-badge').innerHTML = '<div class="status-dot"></div><span>Offline</span>';
            }
        }
        
        // =====================================================================
        // WEBSOCKET STREAMING
        // =====================================================================
        
        let streamingEnabled = false;
        
        function updateStreamingIndicator(streaming) {
            const switchEl = document.getElementById('streaming-switch');
            const knob = document.getElementById('streaming-knob');
            const statusText = document.getElementById('streaming-status-text');
            
            if (!streaming) {
                statusText.textContent = 'N/A';
                statusText.style.color = 'var(--text-muted)';
                return;
            }
            
            if (streaming.connected && streaming.authenticated) {
                streamingEnabled = true;
                switchEl.checked = true;
                knob.style.transform = 'translateX(20px)';
                knob.style.background = 'var(--accent-cyan)';
                knob.style.boxShadow = '0 0 10px var(--accent-cyan)';
                statusText.textContent = `📡 ${streaming.subscribed_count || 0}`;
                statusText.style.color = 'var(--accent-cyan)';
            } else if (streaming.connected) {
                statusText.textContent = 'AUTH...';
                statusText.style.color = 'var(--accent-yellow)';
            } else {
                streamingEnabled = false;
                switchEl.checked = false;
                knob.style.transform = 'translateX(0)';
                knob.style.background = 'var(--text-muted)';
                knob.style.boxShadow = 'none';
                statusText.textContent = 'OFF';
                statusText.style.color = 'var(--text-muted)';
            }
        }
        
        async function toggleStreaming() {
            const switchEl = document.getElementById('streaming-switch');
            const statusText = document.getElementById('streaming-status-text');
            
            if (switchEl.checked) {
                // Start streaming
                statusText.textContent = 'Starting...';
                statusText.style.color = 'var(--accent-yellow)';
                
                try {
                    const result = await fetchJson(`${API_BASE}/api/streaming/start`, {
                        method: 'POST'
                    });
                    
                    if (result.status === 'ok') {
                        showToast('📡 WebSocket streaming started!', 'success');
                        
                        // Auto-subscribe to watchlist symbols
                        setTimeout(() => subscribeWatchlistSymbols(), 2000);
                    }
                } catch (e) {
                    showToast('Failed to start streaming: ' + e.message, 'error');
                    switchEl.checked = false;
                }
            } else {
                // Stop streaming
                try {
                    await fetchJson(`${API_BASE}/api/streaming/stop`, {
                        method: 'POST'
                    });
                    showToast('Streaming stopped', 'info');
                } catch (e) {
                    console.error('Stop streaming error:', e);
                }
            }
            
            // Refresh status
            setTimeout(checkStatus, 1000);
        }
        
        async function subscribeWatchlistSymbols() {
            try {
                // Get all symbols from watchlists
                const wlData = await fetchJson(`${API_BASE}/api/watchlist`);
                const allSymbols = [];
                
                if (wlData && wlData.watchlists) {
                    wlData.watchlists.forEach(wl => {
                        if (wl.symbols) {
                            allSymbols.push(...wl.symbols.map(s => typeof s === 'string' ? s : s.symbol));
                        }
                    });
                }
                
                if (allSymbols.length > 0) {
                    // Subscribe to first 100 symbols (API limit)
                    const toSubscribe = [...new Set(allSymbols)].slice(0, 100);
                    
                    await fetchJson(`${API_BASE}/api/streaming/subscribe`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(toSubscribe)
                    });
                    
                    showToast(`📊 Subscribed to ${toSubscribe.length} symbols for live data`, 'success');
                }
            } catch (e) {
                console.error('Subscribe error:', e);
            }
        }

        // =====================================================================
        // SCANNER
        // =====================================================================
        
        // Derive VP period from timeframe (for order flow consistency)
        function getVPPeriodFromTimeframe(tf) {
            const map = {
                '5MIN': 'day',
                '15MIN': 'day', 
                '30MIN': 'swing',
                '1HR': 'swing',
                '2HR': 'position',
                '4HR': 'position',
                'DAILY': 'position'
            };
            return map[tf?.toUpperCase()] || 'swing';
        }
        
        async function quickAnalyze() {
            const symbol = document.getElementById('quick-symbol').value.trim().toUpperCase();
            const tf = document.getElementById('quick-tf').value;
            
            if (!symbol) return alert('Enter a symbol');
            
            // Capture and clear any pending entry signal from scanner click
            const entrySignal = window.pendingEntrySignal || null;
            window.pendingEntrySignal = null;
            
            const card = document.getElementById('results-card');
            const container = document.getElementById('results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Analyzing...</div>';
            
            try {
                const vpPeriod = selectedVPPeriod || 'swing';
                let apiUrl = `${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&vp_period=${vpPeriod}`;
                if (entrySignal) apiUrl += `&entry_signal=${encodeURIComponent(entrySignal)}`;
                const data = await fetchJson(apiUrl);
                // Attach entry_signal so diagram can use it
                if (entrySignal) data.entry_signal = entrySignal;
                
                container.innerHTML = `
                    <div class="results-header">
                        <div class="results-symbol">
                            <h3>${data.symbol}</h3>
                            <span class="price">${fmtMoney(data.current_price || 0)}</span>
                            ${getSignalWithLean(data.signal, data.bull_score, data.bear_score)}
                        </div>
                        <div class="results-ohlc">
                            <span><b>O:</b> ${fmtMoney(data.day_open || 0)}</span>
                            <span><b>H:</b> ${fmtMoney(data.day_high || 0)}</span>
                            <span><b>L:</b> ${fmtMoney(data.day_low || 0)}</span>
                            <span><b>PC:</b> ${fmtMoney(data.prev_close || 0)}</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">Confidence</div>
                        <div style="font-family: 'Inter', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--text-primary);">${data.confidence?.toFixed(0) || 0}%</div>
                    </div>
                    
                    <div class="level-grid">
                        <div class="level-box">
                            <div class="level-label">VAH</div>
                            <div class="level-value vah">${fmtMoney(data.vah)}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">POC</div>
                            <div class="level-value poc">${fmtMoney(data.poc)}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">VAL</div>
                            <div class="level-value val">${fmtMoney(data.val)}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">VWAP</div>
                            <div class="level-value vwap">${fmtMoney(data.vwap)}</div>
                        </div>
                    </div>
                    
                    <div class="score-container">
                        <div class="score-row">
                            <span class="score-label">Bull</span>
                            <div class="score-bar">
                                <div class="score-fill bull" style="width: ${data.bull_score || 0}%"></div>
                            </div>
                            <span class="score-value" style="color: var(--accent-green);">${data.bull_score?.toFixed(0) || 0}</span>
                        </div>
                        <div class="score-row">
                            <span class="score-label">Bear</span>
                            <div class="score-bar">
                                <div class="score-fill bear" style="width: ${data.bear_score || 0}%"></div>
                            </div>
                            <span class="score-value" style="color: var(--accent-red);">${data.bear_score?.toFixed(0) || 0}</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div class="level-box">
                            <div class="level-label">Position</div>
                            <div style="font-size: 0.85rem; color: var(--text-primary);">${data.position || '-'}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">RSI</div>
                            <div style="font-family: 'JetBrains Mono'; color: var(--text-primary);">${data.rsi?.toFixed(1) || '-'}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">VWAP Zone</div>
                            <div style="font-size: 0.85rem; color: var(--text-primary);">${data.vwap_zone || '-'}</div>
                        </div>
                    </div>
                    
                    ${renderExtensionPanel(data)}
                    
                    ${renderOrderFlowPanel(data)}
                    
                    ${data.notes && data.notes.length > 0 ? `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Notes</div>
                            ${data.notes.map(n => `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">• ${n}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="getAICommentary('${data.symbol}', '${tf}')">
                            🤖 Get AI Trade Plan
                        </button>
                    </div>
                    
                    ${getEntryDiagram(data.signal_type, data.entry_signal)}
                    
                    <div id="ai-commentary-container"></div>
                `;
                
                // Save to history
                if (currentUser && db) {
                    try {
                        await db.collection('users').doc(currentUser.uid).collection('analyses').add({
                            symbol: data.symbol,
                            timeframe: tf,
                            algo_signal: data.signal || 'WAIT',
                            price: data.current_price || 0,
                            vah: data.vah || 0,
                            poc: data.poc || 0,
                            val: data.val || 0,
                            vwap: data.vwap || 0,
                            rsi: data.rsi || 0,
                            bull_score: data.bull_score || 0,
                            bear_score: data.bear_score || 0,
                            confidence: data.confidence || 0,
                            position: data.position || '',
                            analysis_type: 'quick',
                            created_at: new Date().toISOString()
                        });
                    } catch (saveErr) {
                        console.log('History save error:', saveErr);
                    }
                }
                
                // Store current result for potential use
                window.currentResult = data;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function getAICommentary(symbol, timeframe) {
            const container = document.getElementById('ai-commentary-container');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Getting AI trade plan with MTF confluence...</div>';
            
            // Map timeframe to trade_tf for MTF endpoint
            const tfMap = {
                '5min': 'intraday',
                '15min': 'intraday', 
                '1h': 'swing',
                '4h': 'position',
                '1d': 'longterm'
            };
            const tradeTF = tfMap[timeframe] || 'swing';
            
            // Check for pending entry signal from Entry Scanner
            const entrySignal = window.pendingEntrySignal || null;
            window.pendingEntrySignal = null; // Clear after use
            
            try {
                // Build URL with optional entry_signal parameter
                let url = `${API_BASE}/api/analyze/live/mtf/${symbol}/ai?trade_tf=${tradeTF}`;
                if (entrySignal) {
                    url += `&entry_signal=${encodeURIComponent(entrySignal)}`;
                }
                
                // Use MTF endpoint for consistent AI analysis across all views
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'AI request failed');
                }
                
                const data = await response.json();
                
                // Store for Log Trade / Set Alerts
                window.lastAIPlan = data;
                
                if (data.ai_commentary) {
                    // Parse for buttons
                    const entryMatch = data.ai_commentary.match(/ENTRY(?:\s*ZONE)?[:\s]*\$?([\d.]+)/i);
                    const stopMatch = data.ai_commentary.match(/STOP(?:\s*LOSS)?[:\s]*\$?([\d.]+)/i);
                    const biasMatch = data.ai_commentary.match(/(?:TRADE\s*)?BIAS[:\s]*(LONG|SHORT|NO\s*TRADE)/i);
                    
                    const parsed = {
                        bias: biasMatch ? biasMatch[1].replace(/\s+/g, '') : 'NOTRADE',
                        entry: entryMatch ? parseFloat(entryMatch[1]) : 0,
                        stop: stopMatch ? parseFloat(stopMatch[1]) : 0
                    };
                    window.lastAIPlan.parsed = parsed;
                    
                    const showButtons = parsed.bias !== 'NOTRADE' && parsed.entry > 0;
                    
                    // Build leading direction badge
                    const leadingDir = data.leading_direction || '';
                    const leadingReason = data.leading_reason || '';
                    const leadingBadge = leadingDir 
                        ? `<span style="background: ${leadingDir === 'LONG' ? 'rgba(16, 185, 129,0.2)' : 'rgba(255,71,87,0.2)'}; color: ${leadingDir === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">Leading: ${leadingDir}</span>`
                        : '';
                    
                    // Parse AI commentary into structured sections
                    const commentary = data.ai_commentary || '';
                    const preferredDir = data.leading_direction || '';
                    
                    // Split into Long scenario, Short scenario, Verdict
                    // Look for scenario markers: "🟢 SCENARIO 1" or "🟢 LONG" and "🔴 SCENARIO 2" or "🔴 SHORT"
                    const longStartMatch = commentary.match(/(🟢\s*(?:SCENARIO\s*1[:\s]*)?LONG\s*SETUP)/i);
                    const shortStartMatch = commentary.match(/(🔴\s*(?:SCENARIO\s*2[:\s]*)?SHORT\s*SETUP)/i);
                    const verdictMatch = commentary.match(/(⚖️\s*VERDICT)/i);
                    
                    let longSection = '', shortSection = '', verdictSection = '', preSection = '';
                    
                    if (longStartMatch && shortStartMatch && verdictMatch) {
                        const longIdx = commentary.indexOf(longStartMatch[0]);
                        const shortIdx = commentary.indexOf(shortStartMatch[0]);
                        const verdictIdx = commentary.indexOf(verdictMatch[0]);
                        
                        // Content before first scenario
                        preSection = commentary.substring(0, Math.min(longIdx, shortIdx)).trim();
                        
                        // Determine ordering in the text
                        if (longIdx < shortIdx) {
                            longSection = commentary.substring(longIdx, shortIdx).trim();
                            shortSection = commentary.substring(shortIdx, verdictIdx).trim();
                        } else {
                            shortSection = commentary.substring(shortIdx, longIdx).trim();
                            longSection = commentary.substring(longIdx, verdictIdx).trim();
                        }
                        verdictSection = commentary.substring(verdictIdx).trim();
                    }
                    
                    // Extract grades from each section
                    const longGradeMatch = longSection.match(/GRADE:\s*([A-F][+\-]?)/i);
                    const shortGradeMatch = shortSection.match(/GRADE:\s*([A-F][+\-]?)/i);
                    const longGrade = longGradeMatch ? longGradeMatch[1] : '?';
                    const shortGrade = shortGradeMatch ? shortGradeMatch[1] : '?';
                    
                    // Extract conviction
                    const longConvMatch = longSection.match(/CONVICTION:\s*(\d+)\/10/i);
                    const shortConvMatch = shortSection.match(/CONVICTION:\s*(\d+)\/10/i);
                    const longConv = longConvMatch ? longConvMatch[1] : '?';
                    const shortConv = shortConvMatch ? shortConvMatch[1] : '?';
                    
                    // Determine which is preferred from verdict text
                    const prefMatch = verdictSection.match(/PREFERRED:\s*(LONG|SHORT)/i);
                    const preferred = prefMatch ? prefMatch[1].toUpperCase() : preferredDir;
                    const isLongPreferred = preferred === 'LONG';
                    
                    // Extract verdict reason 
                    const verdictReasonMatch = verdictSection.match(/PREFERRED:\s*(?:LONG|SHORT)\s*because\s*(.+?)(?:\n|$)/i);
                    const verdictReason = verdictReasonMatch ? verdictReasonMatch[1].trim() : '';
                    
                    // Extract key level from verdict
                    const keyLevelMatch = verdictSection.match(/KEY\s*LEVEL:\s*\$?([\d.]+)/i);
                    const keyLevel = keyLevelMatch ? keyLevelMatch[1] : '';

                    // Format scenario card content (strip header line, remove separator bars)
                    function formatScenarioBody(text) {
                        return text
                            .replace(/^.*?(LONG|SHORT)\s*SETUP.*?\n/i, '')  // Remove header line
                            .replace(/━+/g, '')  // Remove separator bars
                            .trim();
                    }
                    
                    // Build side-by-side or fallback to raw text
                    let aiContentHTML = '';
                    
                    if (longSection && shortSection && verdictSection) {
                        // Determine card order: non-preferred LEFT, preferred RIGHT
                        const leftSection = isLongPreferred ? shortSection : longSection;
                        const rightSection = isLongPreferred ? longSection : shortSection;
                        const leftDir = isLongPreferred ? 'SHORT' : 'LONG';
                        const rightDir = isLongPreferred ? 'LONG' : 'SHORT';
                        const leftGrade = isLongPreferred ? shortGrade : longGrade;
                        const rightGrade = isLongPreferred ? longGrade : shortGrade;
                        const leftConv = isLongPreferred ? shortConv : longConv;
                        const rightConv = isLongPreferred ? longConv : shortConv;
                        const leftColor = leftDir === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)';
                        const rightColor = rightDir === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)';
                        const leftArrow = leftDir === 'LONG' ? '▲' : '▼';
                        const rightArrow = rightDir === 'LONG' ? '▲' : '▼';
                        const leftBgColor = leftDir === 'LONG' ? 'rgba(16,185,129,0.06)' : 'rgba(239,68,68,0.06)';
                        const rightBgColor = rightDir === 'LONG' ? 'rgba(16,185,129,0.08)' : 'rgba(239,68,68,0.08)';
                        
                        aiContentHTML = `
                            ${preSection ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; white-space: pre-line;">${preSection}</div>` : ''}
                            
                            <!-- Side-by-side scenario cards -->
                            <div class="ai-scenarios-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <!-- LEFT card (non-preferred) -->
                                <div style="background: ${leftBgColor}; border: 1px solid var(--border-default); border-top: 3px solid ${leftColor}; border-radius: 10px; padding: 1rem; opacity: 0.85;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-default);">
                                        <span style="font-weight: 700; font-size: 0.85rem; color: ${leftColor}; display: flex; align-items: center; gap: 0.4rem;">
                                            <span>${leftArrow}</span> ${leftDir} SETUP
                                        </span>
                                        <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; background: rgba(100,100,100,0.15); color: var(--text-muted);">${leftGrade} | ${leftConv}/10</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.65; white-space: pre-line; font-family: 'JetBrains Mono', monospace;">${formatScenarioBody(leftSection)}</div>
                                </div>
                                
                                <!-- RIGHT card (PREFERRED) -->
                                <div style="background: ${rightBgColor}; border: 1px solid ${rightColor}; border-top: 3px solid ${rightColor}; border-radius: 10px; padding: 1rem; box-shadow: 0 0 20px ${rightDir === 'LONG' ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'}; position: relative;">
                                    <div style="position: absolute; top: -10px; right: 12px; background: ${rightColor}; color: #0a0e17; font-size: 0.65rem; font-weight: 700; padding: 2px 10px; border-radius: 4px; letter-spacing: 0.5px;">★ PREFERRED</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid ${rightColor}40;">
                                        <span style="font-weight: 700; font-size: 0.85rem; color: ${rightColor}; display: flex; align-items: center; gap: 0.4rem;">
                                            <span>${rightArrow}</span> ${rightDir} SETUP
                                        </span>
                                        <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; background: ${rightColor}20; color: ${rightColor};">${rightGrade} | ${rightConv}/10</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: var(--text-primary); line-height: 1.65; white-space: pre-line; font-family: 'JetBrains Mono', monospace;">${formatScenarioBody(rightSection)}</div>
                                </div>
                            </div>
                            
                            <!-- Verdict bar -->
                            <div style="background: var(--bg-tertiary); border: 1px solid ${preferred === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}40; border-left: 4px solid ${preferred === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}; border-radius: 8px; padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                                <span style="font-size: 1.1rem;">⚖️</span>
                                <span style="font-weight: 700; font-size: 0.95rem; color: ${preferred === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'};">${preferred}</span>
                                <span style="flex: 1; font-size: 0.8rem; color: var(--text-muted);">${verdictReason || 'Preferred direction based on MTF analysis'}</span>
                                ${keyLevel ? `<span style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent-cyan); background: var(--bg-card); padding: 3px 8px; border-radius: 4px;">Key: $${keyLevel}</span>` : ''}
                            </div>
                        `;
                    } else {
                        // Fallback: raw text display (if parsing failed)
                        aiContentHTML = `<div style="font-size: 0.9rem; color: var(--text-primary); line-height: 1.7; white-space: pre-line;">${commentary}</div>`;
                    }
                    
                    container.innerHTML = `
                        <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(0, 212, 255, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.25rem;">🤖</span>
                                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--accent-green);">AI TRADE PLAN (MTF)</span>
                                    ${leadingBadge}
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${data.high_prob?.toFixed(0) || 50}% High / ${data.low_prob?.toFixed(0) || 50}% Low</div>
                            </div>
                            ${leadingReason ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px;">📍 ${leadingReason}</div>` : ''}
                            ${aiContentHTML}
                            ${showButtons ? `
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); flex-wrap: wrap;">
                                <button class="btn" style="background: var(--accent-green); color: var(--bg-primary);" onclick="logAITrade()">📋 Log Trade</button>
                                <button class="btn" style="background: var(--accent-purple); color: white;" onclick="setAIAlerts()">🔔 Set Alerts</button>
                                <button class="btn" style="background: var(--accent-cyan); color: var(--bg-primary);" onclick="shareTrade()">📤 Share Trade</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem;">No AI commentary available. Check if OpenAI API key is set.</div>';
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function fullAnalysis() {
            const symbol = document.getElementById('quick-symbol').value.trim().toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('full-analysis-card');
            const container = document.getElementById('full-analysis-container');
            
            // Hide other result cards
            document.getElementById('results-card').classList.add('hidden');
            document.getElementById('mtf-results-card').classList.add('hidden');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Running complete analysis (MTF + Range + AI)...</div>';
            
            try {
                // Fetch MTF, Range, and Single-TF data in parallel for complete coverage
                const [mtfData, rangeData, singleTfData] = await Promise.all([
                    fetchJson(`${API_BASE}/api/analyze/live/mtf/${symbol}`),
                    fetchJson(`${API_BASE}/api/range/analyze/${symbol}/ai`),
                    fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=1HR&vp_period=swing`)
                ]);
                
                // Build MTF cards
                const tfCards = Object.entries(mtfData.timeframes || {}).map(([tf, result]) => `
                    <div class="mtf-card">
                        <div class="tf-label">${tf}</div>
                        <div class="signal-display">${getSignalEmoji(result.signal)}</div>
                        <div class="signal-text ${result.signal.toLowerCase().includes('long') ? 'long' : result.signal.toLowerCase().includes('short') ? 'short' : 'yellow'}">${result.signal}</div>
                        <div class="confidence">${result.confidence?.toFixed(0) || 0}%</div>
                    </div>
                `).join('');
                
                // Build period rows for range
                const periodRows = Object.entries(rangeData.periods || {}).map(([period, p]) => {
                    // Directional change (period start to current)
                    const change = p.period_change_pct || 0;
                    const changeArrow = change >= 0 ? '↑' : '↓';
                    const changeColor = change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    const changeSign = change >= 0 ? '+' : '';
                    
                    return `
                    <tr>
                        <td>${period}D</td>
                        <td>${fmtMoney(p.high)}</td>
                        <td>${fmtMoney(p.low)}</td>
                        <td>
                            <span style="color: ${changeColor}; font-weight: 600;">
                                ${changeArrow} ${changeSign}${change.toFixed(1)}%
                            </span>
                        </td>
                        <td>
                            <span class="structure-badge ${p.structure?.includes('HH') || p.structure?.includes('HL') ? 'bullish' : p.structure?.includes('LH') || p.structure?.includes('LL') ? 'bearish' : 'neutral'}">
                                ${p.structure || '-'}
                            </span>
                        </td>
                    </tr>
                `}).join('');
                
                // Format AI context
                const formattedContext = rangeData.ai_context
                    ? rangeData.ai_context
                        .replace(/•/g, '<span style="color: var(--accent-cyan);">•</span>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary);">$1</strong>')
                        .replace(/\n/g, '<br>')
                    : 'AI context not available';
                
                container.innerHTML = `
                    <!-- Header -->
                    <div class="results-header" style="margin-bottom: 1.5rem;">
                        <div class="results-symbol">
                            <h2 style="font-size: 2rem; margin: 0;">${mtfData.symbol}</h2>
                            ${getSignalWithLean(mtfData.dominant_signal, mtfData.weighted_bull, mtfData.weighted_bear)}
                        </div>
                        <div style="display: flex; align-items: center; gap: 2rem;">
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">
                                <div style="font-family: 'Orbitron', monospace; font-size: 1.75rem; font-weight: 700; color: var(--text-primary);">${fmtMoney(singleTfData.current_price)}</div>
                                ${singleTfData.prev_close ? `<div style="font-size: 0.8rem; color: ${singleTfData.current_price >= singleTfData.prev_close ? 'var(--accent-green)' : 'var(--accent-red)'}; font-family: 'JetBrains Mono';">${singleTfData.current_price >= singleTfData.prev_close ? '▲' : '▼'} ${((singleTfData.current_price - singleTfData.prev_close) / singleTfData.prev_close * 100).toFixed(2)}%</div>` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, auto); gap: 0.5rem 1rem; font-size: 0.75rem;">
                                <div style="text-align: center;"><div style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6rem;">Open</div><div style="font-family: 'JetBrains Mono'; color: var(--text-secondary);">${fmtMoney(singleTfData.day_open)}</div></div>
                                <div style="text-align: center;"><div style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6rem;">High</div><div style="font-family: 'JetBrains Mono'; color: var(--accent-green);">${fmtMoney(singleTfData.day_high)}</div></div>
                                <div style="text-align: center;"><div style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6rem;">Low</div><div style="font-family: 'JetBrains Mono'; color: var(--accent-red);">${fmtMoney(singleTfData.day_low)}</div></div>
                                <div style="text-align: center;"><div style="color: var(--text-muted); text-transform: uppercase; font-size: 0.6rem;">Prev Close</div><div style="font-family: 'JetBrains Mono'; color: var(--text-secondary);">${fmtMoney(singleTfData.prev_close)}</div></div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; color: var(--text-muted);">MTF Confluence</div>
                                <div style="font-family: 'Orbitron', monospace; font-size: 2rem; font-weight: 700; color: ${mtfData.confluence_pct > 70 ? 'var(--accent-green)' : mtfData.confluence_pct > 50 ? 'var(--accent-yellow)' : 'var(--text-muted)'};">${mtfData.confluence_pct?.toFixed(0) || 0}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Volume Profile Levels -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-green); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">📊 Volume Profile Levels (1HR)</div>
                        <div class="level-grid">
                            <div class="level-box">
                                <div class="level-label">VAH</div>
                                <div class="level-value vah">${fmtMoney(singleTfData.vah)}</div>
                            </div>
                            <div class="level-box">
                                <div class="level-label">POC</div>
                                <div class="level-value poc">${fmtMoney(singleTfData.poc)}</div>
                            </div>
                            <div class="level-box">
                                <div class="level-label">VAL</div>
                                <div class="level-value val">${fmtMoney(singleTfData.val)}</div>
                            </div>
                            <div class="level-box">
                                <div class="level-label">VWAP</div>
                                <div class="level-value vwap">${fmtMoney(singleTfData.vwap)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.75rem;">
                            <div class="level-box">
                                <div class="level-label">Position</div>
                                <div style="font-size: 0.85rem; color: var(--text-primary);">${singleTfData.position || '-'}</div>
                            </div>
                            <div class="level-box">
                                <div class="level-label">RSI</div>
                                <div style="font-family: 'JetBrains Mono'; color: ${singleTfData.rsi > 70 ? 'var(--accent-red)' : singleTfData.rsi < 30 ? 'var(--accent-green)' : 'var(--text-primary)'};">${singleTfData.rsi?.toFixed(1) || '-'}</div>
                            </div>
                            <div class="level-box">
                                <div class="level-label">VWAP Zone</div>
                                <div style="font-size: 0.85rem; color: var(--text-primary);">${singleTfData.vwap_zone || '-'}</div>
                            </div>
                        </div>
                        ${renderExtensionPanel(singleTfData)}
                        ${getEntryDiagram(singleTfData.signal_type, singleTfData.entry_signal)}
                    </div>
                    
                    <!-- MTF Grid -->
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-cyan); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">📊 Multi-Timeframe Signals</div>
                        <div class="mtf-grid">${tfCards}</div>
                        
                        ${buildScenarioGauge(mtfData.high_prob, mtfData.low_prob)}
                    </div>
                    
                    <!-- Range Structure -->
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-purple); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">📈 Range Structure</div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div style="flex: 1; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Current Price</div>
                                <div style="font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: 700;">${fmtMoney(rangeData.current_price)}</div>
                            </div>
                            <div style="flex: 1; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Trend</div>
                                <div style="font-size: 1.25rem;">${rangeData.trend_emoji} ${rangeData.trend_structure}</div>
                            </div>
                            <div style="flex: 1; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Range State</div>
                                <div style="font-size: 0.9rem; color: ${rangeData.range_state?.includes('COMPRESSION') ? 'var(--accent-yellow)' : 'var(--text-secondary)'};">${rangeData.range_state}</div>
                            </div>
                        </div>
                        
                        <table class="range-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Change</th>
                                    <th>Structure</th>
                                </tr>
                            </thead>
                            <tbody>${periodRows}</tbody>
                        </table>
                        
                        ${rangeData.weekly_structure ? `
                        <div style="margin-top: 1.25rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(138,43,226,0.1), rgba(100,100,255,0.08)); border: 1px solid rgba(138,43,226,0.3); border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: #9d4edd; text-transform: uppercase; letter-spacing: 1px;">📊 Weekly Macro Structure</div>
                                <div class="signal ${rangeData.weekly_structure.trend?.includes('UPTREND') ? 'signal-long' : rangeData.weekly_structure.trend?.includes('DOWNTREND') ? 'signal-short' : 'signal-yellow'}">
                                    ${rangeData.weekly_structure.trend || 'NEUTRAL'}
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                                <div style="text-align: center; padding: 0.75rem; background: rgba(16, 185, 129,0.1); border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${rangeData.weekly_structure.hh_count || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Higher Highs</div>
                                </div>
                                <div style="text-align: center; padding: 0.75rem; background: rgba(16, 185, 129,0.1); border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${rangeData.weekly_structure.hl_count || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Higher Lows</div>
                                </div>
                                <div style="text-align: center; padding: 0.75rem; background: rgba(255,107,107,0.1); border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-red);">${rangeData.weekly_structure.lh_count || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Lower Highs</div>
                                </div>
                                <div style="text-align: center; padding: 0.75rem; background: rgba(255,107,107,0.1); border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-red);">${rangeData.weekly_structure.ll_count || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Lower Lows</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem;">
                                <div style="flex: 1; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                                    <span style="color: var(--text-muted);">State:</span>
                                    <span style="color: ${rangeData.weekly_structure.range_state === 'COMPRESSED' ? 'var(--accent-cyan)' : rangeData.weekly_structure.range_state === 'TRENDING' ? 'var(--accent-green)' : 'var(--text-secondary)'}; font-weight: 500;">
                                        ${rangeData.weekly_structure.range_state || 'N/A'}
                                    </span>
                                </div>
                                <div style="flex: 1; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                                    <span style="color: var(--text-muted);">Weekly Close:</span>
                                    <span style="color: ${rangeData.weekly_structure.weekly_close_signal?.includes('BULL') ? 'var(--accent-green)' : rangeData.weekly_structure.weekly_close_signal?.includes('BEAR') ? 'var(--accent-red)' : 'var(--text-secondary)'}; font-weight: 500;">
                                        ${((rangeData.weekly_structure.weekly_close_position || 0) * 100).toFixed(0)}% ${rangeData.weekly_structure.weekly_close_signal?.replace(/_/g, ' ') || ''}
                                    </span>
                                </div>
                            </div>
                            ${rangeData.weekly_structure.last_week_structure ? `
                            <div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-muted);">
                                Last week: <span style="color: var(--text-secondary); font-weight: 500;">${rangeData.weekly_structure.last_week_structure}</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Key Levels -->
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-yellow); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">🎯 Key Levels</div>
                        <div class="grid-2">
                            <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--accent-red); text-transform: uppercase; margin-bottom: 0.5rem;">Resistance</div>
                                ${(rangeData.resistance_levels || []).slice(0, 3).map(r => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                        <span style="color: var(--accent-red);">${fmtMoney(r.price)}</span>
                                        <span style="color: var(--text-muted);">${r.description}</span>
                                    </div>
                                `).join('')}
                                ${rangeData.breakout_watch ? `
                                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">Breakout Watch:</span>
                                        <span style="font-family: 'JetBrains Mono'; color: var(--accent-green);"> ${fmtMoney(rangeData.breakout_watch)}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--accent-green); text-transform: uppercase; margin-bottom: 0.5rem;">Support</div>
                                ${(rangeData.support_levels || []).slice(0, 3).map(s => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                        <span style="color: var(--accent-green);">${fmtMoney(s.price)}</span>
                                        <span style="color: var(--text-muted);">${s.description}</span>
                                    </div>
                                `).join('')}
                                ${rangeData.breakdown_watch ? `
                                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">Breakdown Watch:</span>
                                        <span style="font-family: 'JetBrains Mono'; color: var(--accent-red);"> ${fmtMoney(rangeData.breakdown_watch)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Context -->
                    <div style="padding: 1.25rem; background: linear-gradient(135deg, rgba(0,255,200,0.05), rgba(100,100,255,0.05)); border: 1px solid var(--border-color); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.25rem;">🧠</span>
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px;">AI Technical Context</span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;">
                            ${formattedContext}
                        </div>
                        <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
                            ⚠️ Technical observations only - not trade advice
                        </div>
                    </div>
                    
                    <!-- Trade Scenarios -->
                    ${rangeData.trade_scenarios ? `
                    <div style="margin-top: 1.5rem; padding: 1.25rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.25rem;">⚖️</span>
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px;">Trade Scenarios (Non-Bias)</span>
                        </div>
                        
                        <!-- Decision Point -->
                        ${rangeData.trade_scenarios.decision_point ? `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--accent-yellow); margin-bottom: 0.5rem; font-weight: 600;">📍 DECISION POINT</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; font-size: 0.8rem;">
                                <div><span style="color: var(--text-muted);">Current:</span> <span style="color: var(--text-primary); font-family: 'JetBrains Mono';">$${rangeData.trade_scenarios.decision_point.current_price?.toFixed(2)}</span></div>
                                <div><span style="color: var(--text-muted);">Bull Above:</span> <span style="color: var(--accent-green); font-family: 'JetBrains Mono';">$${rangeData.trade_scenarios.decision_point.bull_trigger?.toFixed(2)}</span></div>
                                <div><span style="color: var(--text-muted);">Bear Below:</span> <span style="color: var(--accent-red); font-family: 'JetBrains Mono';">$${rangeData.trade_scenarios.decision_point.bear_trigger?.toFixed(2)}</span></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Long Scenario -->
                            <div style="background: rgba(16, 185, 129,0.05); border: 1px solid rgba(16, 185, 129,0.2); border-radius: 8px; padding: 1rem;">
                                <div style="font-weight: 600; color: var(--accent-green); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>🟢</span> LONG SETUP
                                </div>
                                
                                <!-- Conservative -->
                                ${rangeData.trade_scenarios.long?.conservative ? `
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Conservative (Wait for Pullback)</div>
                                    <div style="font-size: 0.8rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Entry Zone:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-cyan);">$${rangeData.trade_scenarios.long.conservative.entry_zone?.join(' - $')}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Stop Loss:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-red);">$${rangeData.trade_scenarios.long.conservative.stop_loss?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Target:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-green);">$${rangeData.trade_scenarios.long.conservative.target?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">R:R Ratio:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-yellow);">${rangeData.trade_scenarios.long.conservative.r_r_ratio}</span>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Aggressive (smart: hidden when price is in/near conservative entry zone) -->
                                ${(() => {
                                    const lc = rangeData.trade_scenarios.long?.conservative;
                                    const la = rangeData.trade_scenarios.long?.aggressive;
                                    if (!la) return '';
                                    const eLow = parseFloat(lc?.entry_zone?.[0] || 0);
                                    const eHigh = parseFloat(lc?.entry_zone?.[1] || 0);
                                    const aEntry = la.entry || 0;
                                    const margin = (eHigh - eLow) * 0.5 || aEntry * 0.01;
                                    const isNearZone = aEntry >= (eLow - margin) && aEntry <= (eHigh + margin);
                                    if (isNearZone) return `
                                    <div style="padding-top: 0.5rem; border-top: 1px dashed rgba(16, 185, 129,0.2);">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(16, 185, 129,0.08); border-radius: 6px; border-left: 3px solid var(--accent-green);">
                                            <span style="font-size: 0.8rem;">✅</span>
                                            <span style="font-size: 0.75rem; color: var(--accent-green); font-weight: 600;">Price is in the entry zone — use conservative parameters above</span>
                                        </div>
                                    </div>`;
                                    return `
                                <div style="padding-top: 0.5rem; border-top: 1px dashed rgba(16, 185, 129,0.2);">
                                    <div style="font-size: 0.7rem; color: var(--accent-red); text-transform: uppercase; margin-bottom: 0.25rem;">⚡ Aggressive (Enter Now)</div>
                                    <div style="font-size: 0.8rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Entry:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-cyan);">$${la.entry?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Tight Stop:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-red);">$${la.stop_loss?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Risk:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-orange);">${la.risk_pct}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">R:R Ratio:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-yellow);">${la.r_r_ratio}</span>
                                        </div>
                                    </div>
                                </div>`;
                                })()}
                            </div>
                            
                            <!-- Short Scenario -->
                            <div style="background: rgba(255,68,68,0.05); border: 1px solid rgba(255,68,68,0.2); border-radius: 8px; padding: 1rem;">
                                <div style="font-weight: 600; color: var(--accent-red); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>🔴</span> SHORT SETUP
                                </div>
                                
                                <!-- Conservative -->
                                ${rangeData.trade_scenarios.short?.conservative ? `
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem;">Conservative (Wait for Rally)</div>
                                    <div style="font-size: 0.8rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Entry Zone:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-cyan);">$${rangeData.trade_scenarios.short.conservative.entry_zone?.join(' - $')}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Stop Loss:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-red);">$${rangeData.trade_scenarios.short.conservative.stop_loss?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Target:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-green);">$${rangeData.trade_scenarios.short.conservative.target?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">R:R Ratio:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-yellow);">${rangeData.trade_scenarios.short.conservative.r_r_ratio}</span>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Aggressive (smart: hidden when price is in/near conservative entry zone) -->
                                ${(() => {
                                    const sc = rangeData.trade_scenarios.short?.conservative;
                                    const sa = rangeData.trade_scenarios.short?.aggressive;
                                    if (!sa) return '';
                                    const eLow = parseFloat(sc?.entry_zone?.[0] || 0);
                                    const eHigh = parseFloat(sc?.entry_zone?.[1] || 0);
                                    const aEntry = sa.entry || 0;
                                    const margin = (eHigh - eLow) * 0.5 || aEntry * 0.01;
                                    const isNearZone = aEntry >= (eLow - margin) && aEntry <= (eHigh + margin);
                                    if (isNearZone) return `
                                    <div style="padding-top: 0.5rem; border-top: 1px dashed rgba(255,68,68,0.2);">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(255,68,68,0.08); border-radius: 6px; border-left: 3px solid var(--accent-red);">
                                            <span style="font-size: 0.8rem;">✅</span>
                                            <span style="font-size: 0.75rem; color: var(--accent-red); font-weight: 600;">Price is in the entry zone — use conservative parameters above</span>
                                        </div>
                                    </div>`;
                                    return `
                                <div style="padding-top: 0.5rem; border-top: 1px dashed rgba(255,68,68,0.2);">
                                    <div style="font-size: 0.7rem; color: var(--accent-red); text-transform: uppercase; margin-bottom: 0.25rem;">⚡ Aggressive (Enter Now)</div>
                                    <div style="font-size: 0.8rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Entry:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-cyan);">$${sa.entry?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Tight Stop:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-red);">$${sa.stop_loss?.toFixed(2)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">Risk:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-orange);">${sa.risk_pct}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-muted);">R:R Ratio:</span>
                                            <span style="font-family: 'JetBrains Mono'; color: var(--accent-yellow);">${sa.r_r_ratio}</span>
                                        </div>
                                    </div>
                                </div>`;
                                })()}
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.7rem; color: var(--text-muted);">
                            ⚡ Aggressive entries shown only when price is meaningfully away from the entry zone. When price is near/in the zone, conservative parameters apply directly.
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Trade Planning -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--accent-cyan); margin-bottom: 0.75rem; text-transform: uppercase; font-weight: 600;">Ready to Trade? Get AI Trade Plan</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="trade-tf-btn" data-tf="intraday" onclick="selectTradeTF(this, '${mtfData.symbol}')">📅 Same Day</button>
                            <button class="trade-tf-btn" data-tf="swing" onclick="selectTradeTF(this, '${mtfData.symbol}')">📊 3-5 Days</button>
                            <button class="trade-tf-btn" data-tf="position" onclick="selectTradeTF(this, '${mtfData.symbol}')">📈 2-4 Weeks</button>
                            <button class="trade-tf-btn" data-tf="longterm" onclick="selectTradeTF(this, '${mtfData.symbol}')">🎯 1-3 Months</button>
                            <button class="trade-tf-btn" data-tf="investment" onclick="selectTradeTF(this, '${mtfData.symbol}')">💼 6+ Months</button>
                        </div>
                    </div>
                    
                    <div id="full-ai-container" style="margin-top: 1rem;"></div>
                    
                    <!-- TradingView Link -->
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <a href="https://www.tradingview.com/chart/?symbol=${mtfData.symbol}" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                            📺 Open in TradingView
                        </a>
                    </div>
                `;
                
                // Save to history
                if (currentUser && db) {
                    try {
                        await db.collection('users').doc(currentUser.uid).collection('analyses').add({
                            symbol: mtfData.symbol,
                            timeframe: 'MTF',
                            algo_signal: mtfData.dominant_signal || 'WAIT',
                            price: rangeData.current_price || 0,
                            confluence: mtfData.confluence_pct || 0,
                            high_prob: mtfData.high_prob || 0,
                            low_prob: mtfData.low_prob || 0,
                            trend_structure: rangeData.trend_structure || '',
                            range_state: rangeData.range_state || '',
                            weighted_bull: mtfData.weighted_bull || 0,
                            weighted_bear: mtfData.weighted_bear || 0,
                            analysis_type: 'complete',
                            created_at: new Date().toISOString()
                        });
                    } catch (saveErr) {
                        console.log('History save error:', saveErr);
                    }
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function quickMTF() {
            const symbol = document.getElementById('quick-symbol').value.trim().toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('mtf-results-card');
            const container = document.getElementById('mtf-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Running MTF analysis...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/mtf/${symbol}`);
                
                const tfCards = Object.entries(data.timeframes || {}).map(([tf, result]) => `
                    <div class="mtf-card">
                        <div class="tf-label">${tf}</div>
                        <div class="signal-display">${getSignalEmoji(result.signal)}</div>
                        <div class="signal-text ${result.signal.toLowerCase().includes('long') ? 'long' : result.signal.toLowerCase().includes('short') ? 'short' : result.signal.toLowerCase().includes('yellow') ? 'yellow' : 'neutral'}">${result.signal}</div>
                        <div class="confidence">${result.confidence?.toFixed(0) || 0}% confidence</div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="results-header">
                        <div class="results-symbol">
                            <h3>${data.symbol}</h3>
                            ${getSignalWithLean(data.dominant_signal, data.weighted_bull, data.weighted_bear)}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Confluence</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: 700;">${data.confluence?.toFixed(0) || 0}%</div>
                        </div>
                    </div>
                    
                    <div class="mtf-grid">${tfCards}</div>
                    
                    ${buildScenarioGauge(data.high_prob, data.low_prob)}
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--accent-cyan); margin-bottom: 0.75rem; text-transform: uppercase; font-weight: 600;">Select Trade Timeframe for AI Analysis</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="trade-tf-btn" data-tf="intraday" onclick="selectTradeTF(this, '${data.symbol}')">📅 Same Day</button>
                            <button class="trade-tf-btn" data-tf="swing" onclick="selectTradeTF(this, '${data.symbol}')">📊 3-5 Days</button>
                            <button class="trade-tf-btn" data-tf="position" onclick="selectTradeTF(this, '${data.symbol}')">📈 2 Weeks</button>
                            <button class="trade-tf-btn" data-tf="longterm" onclick="selectTradeTF(this, '${data.symbol}')">🎯 30+ Days</button>
                        </div>
                    </div>
                    
                    <div id="mtf-ai-container" style="margin-top: 1rem;"></div>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }

        function selectTradeTF(btn, symbol) {
            console.log('selectTradeTF called with symbol:', symbol);
            
            // Update button styles
            document.querySelectorAll('.trade-tf-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Get selected timeframe and call AI
            const tradeTF = btn.getAttribute('data-tf');
            console.log('Trade TF:', tradeTF);
            getMTFAICommentary(symbol, tradeTF);
        }

        async function getMTFAICommentary(symbol, tradeTF = 'swing') {
            console.log('getMTFAICommentary called:', symbol, tradeTF);
            
            // Try both possible container IDs (MTF view and Full Analysis view)
            let container = document.getElementById('mtf-ai-container') || document.getElementById('full-ai-container');
            
            console.log('Container found:', container ? container.id : 'NONE');
            
            if (!container) {
                console.error('No AI container found');
                return;
            }
            
            const tfLabels = {
                'intraday': 'Same Day (Intraday)',
                'swing': '3-5 Day Swing',
                'position': '2 Week Position',
                'longterm': '30+ Day Setup'
            };
            
            container.innerHTML = `<div class="loading-spinner" style="margin: 1rem auto;"></div><div style="text-align: center; color: var(--text-muted);">Generating ${tfLabels[tradeTF]} AI trade plan...</div>`;
            
            try {
                // Use the new MTF AI endpoint with trade timeframe
                const response = await fetch(`${API_BASE}/api/analyze/live/mtf/${symbol}/ai?trade_tf=${tradeTF}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'AI request failed');
                }
                
                const data = await response.json();
                
                // Store the AI plan data for logging
                window.lastAIPlan = data;
                
                if (data.ai_commentary) {
                    // Parse entry/stop/targets from AI commentary (handle emojis and various formats)
                    const entryMatch = data.ai_commentary.match(/ENTRY(?:\s*ZONE)?[:\s]*\$?([\d.]+)\s*-?\s*\$?([\d.]+)?/i);
                    const stopMatch = data.ai_commentary.match(/STOP(?:\s*LOSS)?[:\s]*\$?([\d.]+)/i);
                    const t1Match = data.ai_commentary.match(/TARGET\s*1[:\s]*\$?([\d.]+)/i);
                    const t2Match = data.ai_commentary.match(/TARGET\s*2[:\s]*\$?([\d.]+)/i);
                    const biasMatch = data.ai_commentary.match(/(?:TRADE\s*)?BIAS[:\s]*(LONG|SHORT|NO\s*TRADE)/i);
                    
                    const parsed = {
                        bias: biasMatch ? biasMatch[1].replace(/\s+/g, '') : 'NOTRADE',
                        entry: entryMatch ? parseFloat(entryMatch[1]) : 0,
                        stop: stopMatch ? parseFloat(stopMatch[1]) : 0,
                        target1: t1Match ? parseFloat(t1Match[1]) : 0,
                        target2: t2Match ? parseFloat(t2Match[1]) : 0
                    };
                    
                    window.lastAIPlan.parsed = parsed;
                    console.log('Parsed AI Plan:', parsed);
                    
                    const showButtons = parsed.bias !== 'NOTRADE' && parsed.entry > 0;
                    
                    container.innerHTML = `
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; border-left: 3px solid var(--accent-cyan);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.75rem; color: var(--accent-cyan); font-weight: 600;">🤖 ${data.trade_timeframe || 'MTF'} AI TRADE PLAN</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${data.high_prob?.toFixed(0)}% High / ${data.low_prob?.toFixed(0)}% Low</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">PRICE</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--text-primary);">$${data.current_price?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">VAH</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-green);">$${data.vah?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">POC</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-yellow);">$${data.poc?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">VAL</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-red);">$${data.val?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">RSI</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: ${data.rsi < 30 ? 'var(--accent-green)' : data.rsi > 70 ? 'var(--accent-red)' : 'var(--text-primary)'};">${data.rsi?.toFixed(1) || '50.0'}</div>
                                </div>
                            </div>
                            
                            <div style="white-space: pre-wrap; font-size: 0.85rem; line-height: 1.6; color: var(--text-primary);">${data.ai_commentary}</div>
                            
                            ${showButtons ? `
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); flex-wrap: wrap;">
                                <button class="btn" style="background: var(--accent-green); color: var(--bg-primary);" onclick="logAITrade()">📋 Log Trade</button>
                                <button class="btn" style="background: var(--accent-purple); color: white;" onclick="setAIAlerts()">🔔 Set Alerts</button>
                                <button class="btn" style="background: var(--accent-cyan); color: var(--bg-primary);" onclick="shareTrade()">📤 Share Trade</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    console.log('✅ AI container innerHTML SET - check if visible');
                    console.log('Container element:', container);
                    console.log('Container offsetHeight:', container.offsetHeight);
                } else {
                    container.innerHTML = '<div style="color: var(--accent-yellow); padding: 0.5rem;">No AI commentary available. Check if OpenAI API key is set.</div>';
                    console.log('⚠️ No AI commentary in response');
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 0.5rem;">AI Error: ${e.message}</div>`;
            }
        }
        
        async function logAITrade() {
            if (!window.lastAIPlan || !window.lastAIPlan.parsed) {
                alert('No trade plan to log');
                return;
            }
            
            const plan = window.lastAIPlan;
            const parsed = plan.parsed;
            
            try {
                const tradeData = {
                    symbol: plan.symbol.toUpperCase(),
                    direction: parsed.bias,
                    timeframe: plan.trade_timeframe || 'SWING',
                    entry: parsed.entry,
                    stop: parsed.stop,
                    target: parsed.target1,
                    target2: parsed.target2,
                    signal: plan.dominant_signal || '',
                    confidence: plan.confluence_pct || plan.confluence || 0,
                    ai_commentary: plan.ai_commentary || '',
                    vah: plan.vah || 0,
                    poc: plan.poc || 0,
                    val: plan.val || 0,
                    rsi: plan.rsi || 0,
                    notes: `AI Trade Plan - ${plan.trade_timeframe || 'SWING'}`,
                    status: 'pending',
                    pnl: 0,
                    created_at: new Date().toISOString()
                };
                
                console.log('Logging trade to Firestore:', tradeData);
                console.log('currentUser:', currentUser?.uid);
                console.log('db available:', !!db);
                
                // Use Firestore if logged in
                if (currentUser && db) {
                    try {
                        const docRef = await db.collection('users').doc(currentUser.uid).collection('trades').add(tradeData);
                        console.log('✅ Trade saved with ID:', docRef.id);
                        showToast(`✅ Trade logged! ID: ${docRef.id}`, 'success');
                        loadTrades();
                    } catch (fsErr) {
                        console.error('Firestore write error:', fsErr);
                        const errMsg = fsErr?.message || fsErr?.code || JSON.stringify(fsErr) || 'Unknown error';
                        showToast(`❌ Firestore error: ${errMsg}`, 'error');
                    }
                } else {
                    console.log('Not logged in - using API fallback');
                    // Fallback to API
                    const response = await fetch(`${API_BASE}/api/journal/log`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tradeData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`✅ Trade logged! ID: ${result.id}`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }
            } catch (e) {
                console.error('Log trade error:', e);
                alert(`❌ Error logging trade: ${e.message}`);
            }
        }
        
        async function setAIAlerts() {
            if (!window.lastAIPlan || !window.lastAIPlan.parsed) {
                alert('No trade plan for alerts');
                return;
            }
            
            const plan = window.lastAIPlan;
            const parsed = plan.parsed;
            
            try {
                const symbol = plan.symbol.toUpperCase();
                const is_long = parsed.bias.toUpperCase() === 'LONG';
                const tf = plan.trade_timeframe || 'SWING';
                let alertsCreated = 0;
                
                // Use Firestore if logged in
                if (currentUser && db) {
                    const alertsRef = db.collection('users').doc(currentUser.uid).collection('alerts');
                    const now = new Date().toISOString();
                    
                    // Entry alert
                    if (parsed.entry > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.entry,
                            direction: is_long ? 'below' : 'above',
                            action: is_long ? 'LONG' : 'SHORT',
                            note: `📍 ${tf} Entry Zone`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    // Stop loss alert
                    if (parsed.stop > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.stop,
                            direction: is_long ? 'below' : 'above',
                            action: 'EXIT',
                            note: `🛑 ${tf} Stop Loss`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    // Target 1 alert
                    if (parsed.target1 > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.target1,
                            direction: is_long ? 'above' : 'below',
                            action: 'ALERT',
                            note: `🎯 ${tf} Target 1`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    // Target 2 alert
                    if (parsed.target2 > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.target2,
                            direction: is_long ? 'above' : 'below',
                            action: 'ALERT',
                            note: `🎯 ${tf} Target 2`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    alert(`🔔 ${alertsCreated} Alerts set!\n• Entry: $${parsed.entry.toFixed(2)}\n• Stop: $${parsed.stop.toFixed(2)}\n• T1: $${parsed.target1.toFixed(2)}\n• T2: $${parsed.target2.toFixed(2)}`);
                    loadAlerts();
                } else {
                    // Fallback to API
                    const payload = {
                        symbol: symbol,
                        direction: parsed.bias,
                        entry: parsed.entry,
                        stop: parsed.stop,
                        target1: parsed.target1,
                        target2: parsed.target2,
                        trade_timeframe: tf
                    };
                    
                    const response = await fetch(`${API_BASE}/api/alerts/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`🔔 ${result.alerts_created} Alerts set!\n• Entry: $${parsed.entry.toFixed(2)}\n• Stop: $${parsed.stop.toFixed(2)}\n• T1: $${parsed.target1.toFixed(2)}\n• T2: $${parsed.target2.toFixed(2)}`);
                        loadAlerts();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }
            } catch (e) {
                console.error('Set alerts error:', e);
                alert(`❌ Error setting alerts: ${e.message}`);
            }
        }

        function showManualInput() {
            alert('Manual input form - implement modal or expand card');
        }

        // =====================================================================
        // RANGE WATCHER
        // =====================================================================
        
        async function analyzeRange() {
            const symbol = document.getElementById('range-symbol').value.trim().toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('range-results-card');
            const container = document.getElementById('range-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Analyzing structure...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/analyze/${symbol}`);
                console.log('Range data received:', data);
                console.log('weekly_structure:', data.weekly_structure);
                
                const periodRows = Object.entries(data.periods || {}).map(([period, p]) => `
                    <tr>
                        <td>${period}D</td>
                        <td>${fmtMoney(p.high)}</td>
                        <td>${fmtMoney(p.low)}</td>
                        <td>${p.range_pct?.toFixed(1)}%</td>
                        <td>
                            <div class="position-gauge">
                                <div class="position-marker" style="left: ${(p.position_in_range * 100).toFixed(0)}%"></div>
                            </div>
                        </td>
                        <td>
                            <span class="structure-badge ${p.structure?.includes('HH') || p.structure?.includes('HL') ? 'bullish' : p.structure?.includes('LH') || p.structure?.includes('LL') ? 'bearish' : 'neutral'}">
                                ${p.structure || '-'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div class="results-header">
                        <div class="results-symbol">
                            <h3>${data.symbol}</h3>
                            <span class="price">${fmtMoney(data.current_price)}</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="signal ${data.trend_bias === 'BULLISH' ? 'signal-long' : data.trend_bias === 'BEARISH' ? 'signal-short' : 'signal-yellow'}">
                                ${data.trend_emoji || ''} ${data.trend_structure}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                Strength: ${data.trend_strength?.toFixed(0) || 0}
                            </div>
                        </div>
                    </div>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>High</th>
                                <th>Low</th>
                                <th>Range</th>
                                <th>Position</th>
                                <th>Structure</th>
                            </tr>
                        </thead>
                        <tbody>${periodRows}</tbody>
                    </table>
                    
                    ${data.weekly_structure ? `
                    <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(138,43,226,0.1), rgba(100,100,255,0.08)); border: 1px solid rgba(138,43,226,0.3); border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: #9d4edd; text-transform: uppercase; letter-spacing: 1px;">📊 Weekly Macro Structure</div>
                            <div class="signal ${data.weekly_structure.trend?.includes('UPTREND') ? 'signal-long' : data.weekly_structure.trend?.includes('DOWNTREND') ? 'signal-short' : 'signal-yellow'}">
                                ${data.weekly_structure.trend || 'NEUTRAL'}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: rgba(16, 185, 129,0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${data.weekly_structure.hh_count || 0}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Higher Highs</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(16, 185, 129,0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">${data.weekly_structure.hl_count || 0}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Higher Lows</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255,107,107,0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-red);">${data.weekly_structure.lh_count || 0}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Lower Highs</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255,107,107,0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-red);">${data.weekly_structure.ll_count || 0}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Lower Lows</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.8rem;">
                            <div style="flex: 1; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                                <span style="color: var(--text-muted);">State:</span>
                                <span style="color: ${data.weekly_structure.range_state === 'COMPRESSED' ? 'var(--accent-cyan)' : data.weekly_structure.range_state === 'TRENDING' ? 'var(--accent-green)' : 'var(--text-secondary)'}; font-weight: 500;">
                                    ${data.weekly_structure.range_state || 'N/A'}
                                </span>
                            </div>
                            <div style="flex: 1; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;">
                                <span style="color: var(--text-muted);">Compression:</span>
                                <span style="color: var(--text-secondary); font-weight: 500;">
                                    ${data.weekly_structure.compression_ratio ? (data.weekly_structure.compression_ratio * 100).toFixed(0) : 0}%
                                </span>
                            </div>
                        </div>
                        
                        ${data.weekly_structure.weekly_close_signal ? `
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: ${
                            data.weekly_structure.weekly_close_signal.includes('BULLISH') || data.weekly_structure.weekly_close_signal === 'STRONG_BULL_CLOSE' || data.weekly_structure.weekly_close_signal === 'STRONG_CLOSE' 
                            ? 'rgba(16, 185, 129,0.15)' 
                            : data.weekly_structure.weekly_close_signal.includes('BEARISH') || data.weekly_structure.weekly_close_signal === 'STRONG_BEAR_CLOSE' || data.weekly_structure.weekly_close_signal === 'WEAK_CLOSE'
                            ? 'rgba(255,107,107,0.15)'
                            : 'var(--bg-primary)'
                        }; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Weekly Close</div>
                                    <div style="font-size: 0.9rem; font-weight: 600; color: ${
                                        data.weekly_structure.weekly_close_signal.includes('BULLISH') || data.weekly_structure.weekly_close_signal === 'STRONG_BULL_CLOSE' || data.weekly_structure.weekly_close_signal === 'STRONG_CLOSE'
                                        ? 'var(--accent-green)'
                                        : data.weekly_structure.weekly_close_signal.includes('BEARISH') || data.weekly_structure.weekly_close_signal === 'STRONG_BEAR_CLOSE' || data.weekly_structure.weekly_close_signal === 'WEAK_CLOSE'
                                        ? 'var(--accent-red)'
                                        : 'var(--text-secondary)'
                                    };">
                                        ${data.weekly_structure.weekly_close_signal.replace(/_/g, ' ')}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Close Position</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                                        ${((data.weekly_structure.weekly_close_position || 0) * 100).toFixed(0)}%
                                    </div>
                                </div>
                            </div>
                            ${data.weekly_structure.last_week_structure ? `
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                                    Last week: <span style="color: var(--text-secondary); font-weight: 500;">${data.weekly_structure.last_week_structure}</span>
                                </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        ${data.weekly_structure.near_support || data.weekly_structure.near_resistance ? `
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255,193,7,0.1); border-radius: 6px; font-size: 0.8rem;">
                                ${data.weekly_structure.near_support ? '<span style="color: var(--accent-green);">📍 Near weekly support</span>' : ''}
                                ${data.weekly_structure.near_resistance ? '<span style="color: var(--accent-red);">📍 Near weekly resistance</span>' : ''}
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="grid-2" style="margin-top: 1.5rem;">
                        <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Resistance Levels</div>
                            ${(data.resistance_levels || []).slice(0, 3).map(r => `
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--accent-red); margin-bottom: 0.25rem;">
                                    <span>${fmtMoney(r.price)}</span>
                                    <span style="color: var(--text-muted);">${r.description}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Support Levels</div>
                            ${(data.support_levels || []).slice(0, 3).map(s => `
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--accent-green); margin-bottom: 0.25rem;">
                                    <span>${fmtMoney(s.price)}</span>
                                    <span style="color: var(--text-muted);">${s.description}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${data.notes && data.notes.length > 0 ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Notes</div>
                            ${data.notes.map(n => `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">• ${n}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-primary" onclick="getRangeAIContext('${data.symbol}')">
                            🧠 Get AI Technical Context
                        </button>
                    </div>
                    
                    <div id="range-ai-container" style="margin-top: 1rem;"></div>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function getRangeAIContext(symbol) {
            const container = document.getElementById('range-ai-container');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Generating AI technical context...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/analyze/${symbol}/ai`);
                
                if (data.ai_context) {
                    // Convert markdown-style bullets to HTML
                    const formattedContext = data.ai_context
                        .replace(/•/g, '<span style="color: var(--accent-cyan);">•</span>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary);">$1</strong>')
                        .replace(/\n/g, '<br>');
                    
                    container.innerHTML = `
                        <div style="padding: 1.25rem; background: linear-gradient(135deg, rgba(0,255,200,0.05), rgba(100,100,255,0.05)); border: 1px solid var(--border-color); border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.25rem;">🧠</span>
                                <span style="font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px;">AI Technical Context</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;">
                                ${formattedContext}
                            </div>
                            <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
                                ⚠️ Technical observations only - not trade advice
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem;">AI context not available</div>';
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">AI Error: ${e.message}</div>`;
            }
        }
        
        async function scanCompression() {
            const symbols = document.getElementById('compression-symbols').value.trim();
            if (!symbols) return alert('Enter symbols');
            
            const card = document.getElementById('compression-results-card');
            const container = document.getElementById('compression-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Scanning for compression...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/compression-scan?symbols=${encodeURIComponent(symbols)}`);
                
                const rows = (data.most_compressed || []).map(r => `
                    <tr>
                        <td class="symbol-cell">${r.symbol}</td>
                        <td class="number-cell">${(r.compression_ratio * 100).toFixed(0)}%</td>
                        <td>${r.range_state}</td>
                        <td>
                            <span class="structure-badge ${r.bias === 'BULLISH' ? 'bullish' : r.bias === 'BEARISH' ? 'bearish' : 'neutral'}">
                                ${r.trend}
                            </span>
                        </td>
                        <td class="number-cell">${r.breakout_watch ? fmtMoney(r.breakout_watch) : '-'}</td>
                        <td class="number-cell">${r.breakdown_watch ? fmtMoney(r.breakdown_watch) : '-'}</td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Compression</th>
                                <th>Range State</th>
                                <th>Trend</th>
                                <th>Breakout</th>
                                <th>Breakdown</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function scanBullish() {
            const symbols = document.getElementById('bullish-symbols').value.trim();
            const tf = document.getElementById('bullish-tf').value;
            if (!symbols) return alert('Enter symbols to scan - use the quick-load buttons above!');
            
            const card = document.getElementById('bullish-results-card');
            const container = document.getElementById('bullish-results-container');
            
            card.classList.remove('hidden');
            const symbolList = symbols.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            container.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Scanning ${symbolList.length} symbols for LONG setups...<div id="bullish-progress" style="margin-top: 0.5rem; font-size: 0.8rem;">0/${symbolList.length}</div></div>`;
            
            try {
                const results = [];
                let scanned = 0;
                let skipped = 0;
                const BATCH_SIZE = 5; // Process 5 symbols in parallel
                const BATCH_DELAY = 800; // Wait 800ms between batches to avoid rate limits
                
                // Process in batches for speed
                for (let i = 0; i < symbolList.length; i += BATCH_SIZE) {
                    const batch = symbolList.slice(i, i + BATCH_SIZE);
                    
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&vp_period=${selectedVPPeriod}&with_ai=false`);
                            
                            // Include bullish signals OR strong yellow with clear bullish lean
                            const isBullish = data.signal && data.signal.includes('LONG');
                            const scoreGap = (data.bull_score || 0) - (data.bear_score || 0);
                            const isBullishLean = scoreGap >= 15 && data.bull_score >= 45;
                            
                            if (isBullish || isBullishLean) {
                                return {
                                    symbol,
                                    signal: data.signal,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    position: data.position || '-',
                                    vwap_zone: data.vwap_zone || '-'
                                };
                            }
                            return null;
                        } catch (e) {
                            skipped++;
                            return null;
                        }
                    });
                    
                    const batchResults = await Promise.all(batchPromises);
                    batchResults.forEach(r => { if (r) results.push(r); });
                    
                    scanned += batch.length;
                    document.getElementById('bullish-progress').textContent = `${scanned}/${symbolList.length}${skipped ? ` (${skipped} skipped)` : ''}`;
                    
                    // Delay between batches to avoid rate limiting
                    if (i + BATCH_SIZE < symbolList.length) {
                        await new Promise(resolve => setTimeout(resolve, BATCH_DELAY));
                    }
                }
                
                // Sort by confidence descending
                results.sort((a, b) => b.confidence - a.confidence);
                
                if (results.length === 0) {
                    container.innerHTML = `<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No bullish setups found in ${symbolList.length} symbols scanned</div>`;
                    return;
                }
                
                const rows = results.map(r => `
                    <tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor: pointer;">
                        <td class="symbol-cell">${r.symbol}</td>
                        <td>${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}</td>
                        <td class="number-cell">${r.confidence.toFixed(0)}%</td>
                        <td>${r.position}</td>
                        <td>${r.vwap_zone}</td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div style="color: var(--accent-green); font-size: 0.85rem; margin-bottom: 0.75rem;">Found ${results.length} bullish setup(s) in ${symbolList.length} scanned - click row to analyze</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Position</th>
                                <th>VWAP Zone</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function scanBearish() {
            const symbols = document.getElementById('bearish-symbols').value.trim();
            const tf = document.getElementById('bearish-tf').value;
            if (!symbols) return alert('Enter symbols to scan - use the quick-load buttons above!');
            
            const card = document.getElementById('bearish-results-card');
            const container = document.getElementById('bearish-results-container');
            
            card.classList.remove('hidden');
            const symbolList = symbols.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            container.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Scanning ${symbolList.length} symbols for SHORT setups...<div id="bearish-progress" style="margin-top: 0.5rem; font-size: 0.8rem;">0/${symbolList.length}</div></div>`;
            
            try {
                const results = [];
                let scanned = 0;
                let skipped = 0;
                const BATCH_SIZE = 5; // Process 5 symbols in parallel to avoid rate limits
                const BATCH_DELAY = 800; // Wait 800ms between batches to avoid rate limits
                
                // Process in batches for speed
                for (let i = 0; i < symbolList.length; i += BATCH_SIZE) {
                    const batch = symbolList.slice(i, i + BATCH_SIZE);
                    
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&vp_period=${selectedVPPeriod}&with_ai=false`);
                            
                            // Include bearish signals OR strong yellow with clear bearish lean
                            const isBearish = data.signal && data.signal.includes('SHORT');
                            const scoreGap = (data.bear_score || 0) - (data.bull_score || 0);
                            const isBearishLean = scoreGap >= 15 && data.bear_score >= 45;
                            
                            if (isBearish || isBearishLean) {
                                return {
                                    symbol,
                                    signal: data.signal,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    position: data.position || '-',
                                    vwap_zone: data.vwap_zone || '-'
                                };
                            }
                            return null;
                        } catch (e) {
                            skipped++;
                            return null;
                        }
                    });
                    
                    const batchResults = await Promise.all(batchPromises);
                    batchResults.forEach(r => { if (r) results.push(r); });
                    
                    scanned += batch.length;
                    document.getElementById('bearish-progress').textContent = `${scanned}/${symbolList.length}${skipped ? ` (${skipped} skipped)` : ''}`;
                    
                    // Delay between batches to avoid rate limiting
                    if (i + BATCH_SIZE < symbolList.length) {
                        await new Promise(resolve => setTimeout(resolve, BATCH_DELAY));
                    }
                }
                
                // Sort by confidence descending
                results.sort((a, b) => b.confidence - a.confidence);
                
                if (results.length === 0) {
                    container.innerHTML = `<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No bearish setups found in ${symbolList.length} symbols scanned</div>`;
                    return;
                }
                
                const rows = results.map(r => `
                    <tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor: pointer;">
                        <td class="symbol-cell">${r.symbol}</td>
                        <td>${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}</td>
                        <td class="number-cell">${r.confidence.toFixed(0)}%</td>
                        <td>${r.position}</td>
                        <td>${r.vwap_zone}</td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div style="color: var(--accent-red); font-size: 0.85rem; margin-bottom: 0.75rem;">Found ${results.length} bearish setup(s) in ${symbolList.length} scanned - click row to analyze</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Position</th>
                                <th>VWAP Zone</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        // Pre-built stock universes
        const STOCK_UNIVERSES = {
            mag7: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA'],
            tech20: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'AMD', 'INTC', 'CRM', 
                     'ORCL', 'ADBE', 'NFLX', 'AVGO', 'CSCO', 'IBM', 'QCOM', 'TXN', 'NOW', 'SNOW'],
            sp50: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'BRK.B', 'UNH', 'JNJ',
                   'XOM', 'JPM', 'V', 'PG', 'MA', 'HD', 'CVX', 'MRK', 'ABBV', 'LLY',
                   'PFE', 'KO', 'PEP', 'COST', 'AVGO', 'TMO', 'MCD', 'WMT', 'CSCO', 'ABT',
                   'ACN', 'DHR', 'NEE', 'VZ', 'ADBE', 'TXN', 'CRM', 'NKE', 'BMY', 'CMCSA',
                   'UPS', 'PM', 'ORCL', 'RTX', 'HON', 'QCOM', 'T', 'IBM', 'LOW', 'SPGI'],
            etfs: ['SPY', 'QQQ', 'IWM', 'DIA', 'VTI', 'XLF', 'XLK', 'XLE', 'XLV', 'XLI',
                   'XLP', 'XLY', 'XLB', 'XLU', 'XLRE', 'GLD', 'SLV', 'TLT', 'HYG', 'SMH',
                   'ARKK', 'SOXX', 'XBI', 'KRE', 'EEM', 'VXX', 'SQQQ', 'TQQQ'],
            meme: ['GME', 'AMC', 'BBBY', 'BB', 'NOK', 'PLTR', 'SOFI', 'RIVN', 'LCID', 'NIO',
                   'HOOD', 'COIN', 'MARA', 'RIOT', 'DKNG', 'WISH', 'CLOV', 'SPCE', 'TLRY', 'SNDL']
        };
        
        // =====================================================================
        // UNIFIED SCANNER - New consolidated interface
        // =====================================================================
        
        let unifiedResults = { bullish: [], bearish: [], extension: [], compression: [], structure: [], entry: [] };
        let selectedTimeframe = '1HR';
        let selectedVPPeriod = 'swing';
        
        function toggleScanType(btn) {
            btn.classList.toggle('active');
        }
        
        function selectAllScanTypes() {
            document.querySelectorAll('.scan-type-btn').forEach(btn => {
                btn.classList.add('active');
            });
        }
        
        function selectTimeframe(btn) {
            document.querySelectorAll('.tf-toggle').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedTimeframe = btn.dataset.tf;
            // Update hidden selects for backward compatibility
            document.getElementById('bullish-tf').value = selectedTimeframe;
            document.getElementById('bearish-tf').value = selectedTimeframe;
            document.getElementById('ultimate-tf').value = selectedTimeframe;
        }

        function selectVPPeriod(btn) {
            document.querySelectorAll('.vp-toggle').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedVPPeriod = btn.dataset.period;
            // Sync the dropdown
            const dropdown = document.getElementById('quick-vp-period');
            if (dropdown) dropdown.value = selectedVPPeriod;
        }
        
        function syncVPPeriodFromDropdown(value) {
            selectedVPPeriod = value;
            // Sync the toggle buttons
            document.querySelectorAll('.vp-toggle').forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`.vp-toggle[data-period="${value}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }
        
        function loadUnifiedUniverse(universe) {
            const symbols = STOCK_UNIVERSES[universe] || [];
            document.getElementById('unified-symbols').value = symbols.join(', ');
            showToast(`Loaded ${symbols.length} symbols from ${universe.toUpperCase()}`, 'info');
        }
        
        async function loadUnifiedFromWatchlists() {
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                const allSymbols = new Set();
                (data.watchlists || []).forEach(w => {
                    (w.symbols || []).forEach(s => allSymbols.add(s));
                });
                const symbolsArray = Array.from(allSymbols);
                document.getElementById('unified-symbols').value = symbolsArray.join(', ');
                showToast(`Loaded ${symbolsArray.length} symbols from all watchlists`, 'info');
            } catch (e) {
                showToast('Failed to load watchlists', 'error');
            }
        }
        
        // Track scan progress globally
        let scanProgress = { completed: 0, total: 0 };
        
        function updateScanProgress() {
            const statusEl = document.getElementById('unified-scan-status');
            const barEl = document.getElementById('unified-scan-bar');
            if (statusEl) {
                statusEl.textContent = `Scanning ${scanProgress.completed} / ${scanProgress.total} symbols...`;
            }
            if (barEl && scanProgress.total > 0) {
                barEl.style.width = `${(scanProgress.completed / scanProgress.total) * 100}%`;
            }
        }
        
        async function runUnifiedScan() {
            const symbolsInput = document.getElementById('unified-symbols').value.trim();
            if (!symbolsInput) return alert('Load a universe or enter symbols to scan!');
            
            const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            const selectedTypes = Array.from(document.querySelectorAll('.scan-type-btn.active'))
                .map(btn => btn.dataset.type);
            
            if (selectedTypes.length === 0) return alert('Select at least one scan type!');
            
            // Reset results
            unifiedResults = { bullish: [], bearish: [], extension: [], compression: [], structure: [], entry: [] };
            
            // Reset and show progress
            scanProgress = { completed: 0, total: symbols.length * selectedTypes.length };
            const progressDiv = document.getElementById('unified-scan-progress');
            progressDiv.style.display = 'block';
            updateScanProgress();
            
            // Update status indicators
            const statusIds = ['unified-bullish-status', 'unified-bearish-status', 'unified-extension-status', 'unified-compression-status', 'unified-structure-status', 'unified-entry-status'];
            statusIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.opacity = '0.5';
            });
            
            const BATCH_SIZE = 5;
            const BATCH_DELAY = 800;
            
            // Run selected scans in parallel
            const scanPromises = [];
            
            if (selectedTypes.includes('bullish')) {
                scanPromises.push(runBullishScanUnified(symbols, selectedTimeframe));
            }
            if (selectedTypes.includes('bearish')) {
                scanPromises.push(runBearishScanUnified(symbols, selectedTimeframe));
            }
            if (selectedTypes.includes('compression')) {
                scanPromises.push(runCompressionScanUnified(symbols));
            }
            if (selectedTypes.includes('extension')) {
                scanPromises.push(runExtensionScanUnified(symbols));
            }
            if (selectedTypes.includes('structure')) {
                scanPromises.push(runStructureScanUnified(symbols));
            }
            if (selectedTypes.includes('entry')) {
                scanPromises.push(runEntryScanUnified(symbols));
            }
            
            await Promise.all(scanPromises);
            
            // Update progress to show complete
            const statusEl = document.getElementById('unified-scan-status');
            if (statusEl) {
                statusEl.textContent = '✅ Scan complete!';
                statusEl.style.color = 'var(--accent-green)';
            }
            const barEl = document.getElementById('unified-scan-bar');
            if (barEl) barEl.style.width = '100%';
            
            // Display results
            displayUnifiedResults();
        }
        
        async function runBullishScanUnified(symbols, tf) {
            const statusEl = document.getElementById('unified-bullish-status');
            try {
                for (let i = 0; i < symbols.length; i += 5) {
                    const batch = symbols.slice(i, i + 5);
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&vp_period=${selectedVPPeriod}&with_ai=false`);
                            const isBullish = data.signal && data.signal.includes('LONG');
                            const scoreGap = (data.bull_score || 0) - (data.bear_score || 0);
                            const isBullishLean = scoreGap >= 15 && data.bull_score >= 45;
                            if (isBullish || isBullishLean) {
                                unifiedResults.bullish.push({
                                    symbol, signal: data.signal, confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0, bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0, volume_trend: data.volume_trend || 'neutral',
                                    type: 'bullish'
                                });
                            }
                        } catch (e) {}
                        scanProgress.completed++;
                        updateScanProgress();
                    });
                    await Promise.all(batchPromises);
                    if (i + 5 < symbols.length) await new Promise(r => setTimeout(r, 800));
                }
                if (statusEl) { statusEl.textContent = `🟢 Bullish: ✅ ${unifiedResults.bullish.length}`; statusEl.style.opacity = '1'; }
            } catch (e) {
                if (statusEl) statusEl.textContent = '🟢 Bullish: ❌';
            }
        }
        
        async function runBearishScanUnified(symbols, tf) {
            const statusEl = document.getElementById('unified-bearish-status');
            try {
                for (let i = 0; i < symbols.length; i += 5) {
                    const batch = symbols.slice(i, i + 5);
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&vp_period=${selectedVPPeriod}&with_ai=false`);
                            const isBearish = data.signal && data.signal.includes('SHORT');
                            const scoreGap = (data.bear_score || 0) - (data.bull_score || 0);
                            const isBearishLean = scoreGap >= 15 && data.bear_score >= 45;
                            if (isBearish || isBearishLean) {
                                unifiedResults.bearish.push({
                                    symbol, signal: data.signal, confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0, bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0, volume_trend: data.volume_trend || 'neutral',
                                    type: 'bearish'
                                });
                            }
                        } catch (e) {}
                        scanProgress.completed++;
                        updateScanProgress();
                    });
                    await Promise.all(batchPromises);
                    if (i + 5 < symbols.length) await new Promise(r => setTimeout(r, 800));
                }
                if (statusEl) { statusEl.textContent = `🔴 Bearish: ✅ ${unifiedResults.bearish.length}`; statusEl.style.opacity = '1'; }
            } catch (e) {
                if (statusEl) statusEl.textContent = '🔴 Bearish: ❌';
            }
        }
        
        async function runCompressionScanUnified(symbols) {
            const statusEl = document.getElementById('unified-compression-status');
            try {
                for (const symbol of symbols) {
                    try {
                        const data = await fetchJson(`${API_BASE}/api/compression/${symbol}`);
                        if (data.squeeze_on || (data.bb_width && data.bb_width < 0.05)) {
                            unifiedResults.compression.push({
                                symbol, squeeze: data.squeeze_on, bb_width: data.bb_width,
                                type: 'compression'
                            });
                        }
                    } catch (e) {}
                    scanProgress.completed++;
                    updateScanProgress();
                    await new Promise(r => setTimeout(r, 200));
                }
                if (statusEl) { statusEl.textContent = `⚡ Compression: ✅ ${unifiedResults.compression.length}`; statusEl.style.opacity = '1'; }
            } catch (e) {
                if (statusEl) statusEl.textContent = '⚡ Compression: ❌';
            }
        }
        
        async function runExtensionScanUnified(symbols) {
            const statusEl = document.getElementById('unified-extension-status');
            try {
                for (let i = 0; i < symbols.length; i += 5) {
                    const batch = symbols.slice(i, i + 5);
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/extension/analyze/${symbol}`);
                            // Check for hottest setup with meaningful extension
                            const hottest = data.extension?.hottest_setup;
                            if (hottest && hottest.candles >= 2) {
                                unifiedResults.extension.push({
                                    symbol, 
                                    candles: hottest.candles, 
                                    direction: hottest.direction,
                                    probability: hottest.snap_back_prob,
                                    trigger: hottest.trigger,
                                    level: hottest.level,
                                    type: 'extension'
                                });
                            }
                        } catch (e) {}
                        scanProgress.completed++;
                        updateScanProgress();
                    });
                    await Promise.all(batchPromises);
                    if (i + 5 < symbols.length) await new Promise(r => setTimeout(r, 800));
                }
                if (statusEl) { statusEl.textContent = `⏱️ Extension: ✅ ${unifiedResults.extension.length}`; statusEl.style.opacity = '1'; }
            } catch (e) {
                if (statusEl) statusEl.textContent = '⏱️ Extension: ❌';
            }
        }
        
        async function runStructureScanUnified(symbols) {
            const statusEl = document.getElementById('unified-structure-status');
            try {
                for (const symbol of symbols.slice(0, 10)) { // Limit structure analysis
                    try {
                        const data = await fetchJson(`${API_BASE}/api/range/analyze/${symbol}`);
                        if (data.structure) {
                            unifiedResults.structure.push({
                                symbol, structure: data.structure, trend: data.trend_direction,
                                type: 'structure'
                            });
                        }
                    } catch (e) {}
                    scanProgress.completed++;
                    updateScanProgress();
                    await new Promise(r => setTimeout(r, 300));
                }
                if (statusEl) { statusEl.textContent = `📈 Structure: ✅ ${unifiedResults.structure.length}`; statusEl.style.opacity = '1'; }
            } catch (e) {
                if (statusEl) statusEl.textContent = '📈 Structure: ❌';
            }
        }
        
        async function runEntryScanUnified(symbols) {
            const statusEl = document.getElementById('unified-entry-status');
            try {
                for (let i = 0; i < symbols.length; i += 5) {
                    const batch = symbols.slice(i, i + 5);
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/entry-scan/scan/${symbol}?resolution=60&days=5&mtf_filter=true&require_alignment=false`);
                            if (data.signals && data.signals.length > 0) {
                                for (const sig of data.signals) {
                                    unifiedResults.entry.push({
                                        symbol,
                                        entry_type: sig.entry_type,
                                        direction: sig.direction,
                                        entry_price: sig.entry_price,
                                        stop_price: sig.stop_price,
                                        target_1: sig.target_1,
                                        rr_ratio: sig.rr_ratio,
                                        confidence: sig.confidence,
                                        htf_aligned: sig.htf_aligned,
                                        htf_bonus: sig.htf_bonus,
                                        notes: sig.notes,
                                        levels: data.levels,
                                        htf_context: data.htf_context,
                                        rvol: data.rvol || 1.0,
                                        type: 'entry'
                                    });
                                }
                            }
                        } catch (e) {}
                        scanProgress.completed++;
                        updateScanProgress();
                    });
                    await Promise.all(batchPromises);
                    if (i + 5 < symbols.length) await new Promise(r => setTimeout(r, 800));
                }
                if (statusEl) { statusEl.textContent = `🎯 Entry: ✅ ${unifiedResults.entry.length}`; statusEl.style.opacity = '1'; }
            } catch (e) {
                if (statusEl) statusEl.textContent = '🎯 Entry: ❌';
            }
        }
        
        function displayUnifiedResults(filter = 'all') {
            const card = document.getElementById('unified-results-card');
            const container = document.getElementById('unified-results-container');
            const summary = document.getElementById('unified-results-summary');
            
            card.classList.remove('hidden');
            
            // Combine all results
            let allResults = [];
            if (filter === 'all' || filter === 'bullish') allResults = allResults.concat(unifiedResults.bullish);
            if (filter === 'all' || filter === 'bearish') allResults = allResults.concat(unifiedResults.bearish);
            if (filter === 'all' || filter === 'compression') allResults = allResults.concat(unifiedResults.compression);
            if (filter === 'all' || filter === 'extension') allResults = allResults.concat(unifiedResults.extension);
            if (filter === 'all' || filter === 'structure') allResults = allResults.concat(unifiedResults.structure);
            if (filter === 'all' || filter === 'entry') allResults = allResults.concat(unifiedResults.entry);
            
            const total = unifiedResults.bullish.length + unifiedResults.bearish.length + 
                          unifiedResults.compression.length + unifiedResults.extension.length + 
                          unifiedResults.structure.length + unifiedResults.entry.length;
            summary.textContent = `${total} matches found`;
            
            // Update filter tab counts
            document.querySelectorAll('.filter-tab').forEach(tab => {
                const f = tab.dataset.filter;
                let count = 0;
                if (f === 'all') count = total;
                else if (unifiedResults[f]) count = unifiedResults[f].length;
                tab.textContent = tab.textContent.replace(/\d+/, '') + (f === 'all' ? `All (${count})` : ` (${count})`);
            });
            
            if (allResults.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No results found</div>';
                return;
            }
            
            // Sort by confidence/probability
            allResults.sort((a, b) => (b.confidence || b.probability || 0) - (a.confidence || a.probability || 0));
            
            const rows = allResults.map(r => {
                let signalHtml = '';
                let typeLabel = '';
                
                if (r.type === 'bullish') {
                    signalHtml = `<span style="color: var(--accent-green);">${r.signal || 'LONG'}</span>`;
                    typeLabel = '<span style="background: rgba(16, 185, 129,0.2); color: var(--accent-green); padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">LONG</span>';
                } else if (r.type === 'bearish') {
                    signalHtml = `<span style="color: var(--accent-red);">${r.signal || 'SHORT'}</span>`;
                    typeLabel = '<span style="background: rgba(255,71,87,0.2); color: var(--accent-red); padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">SHORT</span>';
                } else if (r.type === 'compression') {
                    signalHtml = `<span style="color: var(--accent-yellow);">Squeeze ${r.squeeze ? 'ON' : 'Building'}</span>`;
                    typeLabel = '<span style="background: rgba(255,215,0,0.2); color: var(--accent-yellow); padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">COMP</span>';
                } else if (r.type === 'extension') {
                    const triggerColors = { 'EXTREME': 'var(--accent-red)', 'HIGH_PROB': 'var(--accent-yellow)', 'MODERATE': 'var(--accent-cyan)' };
                    const triggerColor = triggerColors[r.trigger] || 'var(--accent-cyan)';
                    signalHtml = `<span style="color: ${triggerColor};">${r.trigger || 'EXT'}: ${r.candles} candles ${r.direction || ''}</span>`;
                    typeLabel = `<span style="background: rgba(0, 212, 255,0.2); color: var(--accent-cyan); padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">${r.probability || 0}% snap</span>`;
                } else if (r.type === 'structure') {
                    signalHtml = `<span style="color: var(--accent-purple);">${r.structure} (${r.trend})</span>`;
                    typeLabel = '<span style="background: rgba(187,134,252,0.2); color: var(--accent-purple); padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">STRUCT</span>';
                } else if (r.type === 'entry') {
                    const dirColor = r.direction === 'long' ? 'var(--accent-green)' : 'var(--accent-red)';
                    const entryName = r.entry_type.replace(/_/g, ' ').toUpperCase();
                    const htfIcon = r.htf_aligned ? '✓' : r.htf_bonus < 0 ? '⚠️' : '';
                    signalHtml = `<span style="color: ${dirColor};">${entryName}</span>${htfIcon ? ` <span style="font-size: 0.7rem;">${htfIcon}</span>` : ''}`;
                    typeLabel = `<span style="background: rgba(255,107,157,0.2); color: #ff6b9d; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">${r.direction.toUpperCase()}</span>`;
                    // Build entry diagram for expandable detail
                    r._entryDiagramHtml = getEntryDiagram(r.entry_type, `${r.entry_type}:${r.direction}`);
                }
                
                // Build analyze call - pass entry signal if available
                const entrySignal = r.type === 'entry' ? `${r.entry_type}:${r.direction}` : null;
                const analyzeCall = entrySignal 
                    ? `quickAnalyzeSymbol('${r.symbol}', '${entrySignal}')`
                    : `quickAnalyzeSymbol('${r.symbol}')`;
                
                // Build AI plan call
                const aiPlanCall = entrySignal
                    ? `getQuickAIPlan('${r.symbol}', '${entrySignal}')`
                    : `getQuickAIPlan('${r.symbol}')`;
                
                // Build RVOL badge
                const rvol = r.rvol || 1.0;
                let rvolBadge = '';
                if (rvol >= 2.0) {
                    rvolBadge = `<span style="background: rgba(239, 68, 68,0.3); color: var(--accent-red); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 700;">🔥${rvol.toFixed(1)}x</span>`;
                } else if (rvol >= 1.5) {
                    rvolBadge = `<span style="background: rgba(0, 212, 255,0.2); color: var(--accent-cyan); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 700;">📈${rvol.toFixed(1)}x</span>`;
                } else if (rvol <= 0.5) {
                    rvolBadge = `<span style="background: rgba(245, 158, 11,0.2); color: var(--accent-yellow); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">⚠️${rvol.toFixed(1)}x</span>`;
                } else {
                    rvolBadge = `<span style="color: var(--text-secondary); font-size: 0.85rem; font-weight: 500;">${rvol.toFixed(1)}x</span>`;
                }
                
                const diagramId = `diagram-${r.symbol}-${r.type}-${Math.random().toString(36).substr(2,5)}`;
                const diagramRow = r._entryDiagramHtml ? `
                    <tr id="${diagramId}" style="display: none;">
                        <td colspan="6" style="padding: 0.5rem 1rem;">${r._entryDiagramHtml}</td>
                    </tr>` : '';
                const toggleDiagram = r._entryDiagramHtml ? `event.stopPropagation(); var el=document.getElementById('${diagramId}'); el.style.display=el.style.display==='none'?'table-row':'none';` : '';
                
                return `
                    <tr onclick="${analyzeCall}" style="cursor: pointer;">
                        <td style="font-weight: 600; color: var(--text-primary);">${r.symbol}</td>
                        <td>${signalHtml}</td>
                        <td>${r.confidence ? r.confidence.toFixed(0) + '%' : r.probability ? r.probability + '%' : '-'}</td>
                        <td>${typeLabel}</td>
                        <td style="text-align: center;">${rvolBadge}</td>
                        <td style="display: flex; gap: 0.25rem;">
                            ${r._entryDiagramHtml ? `<button class="universe-btn" onclick="${toggleDiagram}" title="Entry Diagram" style="background: rgba(138,43,226,0.2); border-color: var(--accent-purple);">📐</button>` : ''}
                            <button class="universe-btn" onclick="event.stopPropagation(); ${analyzeCall}" title="Quick Analysis">📊</button>
                            <button class="universe-btn" style="background: linear-gradient(135deg, rgba(16, 185, 129,0.2), rgba(0, 212, 255,0.2)); border-color: var(--accent-green);" onclick="event.stopPropagation(); ${aiPlanCall}" title="AI Trade Plan">🤖</button>
                        </td>
                    </tr>
                    ${diagramRow}
                `;
            }).join('');
            
            container.innerHTML = `
                <table class="results-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Signal</th>
                            <th>Conf</th>
                            <th>Type</th>
                            <th style="text-align: center;">Vol</th>
                            <th style="text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }
        
        function filterUnifiedResults(filter) {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            displayUnifiedResults(filter);
        }
        
        function loadUniverse(universe, scannerType) {
            const symbols = STOCK_UNIVERSES[universe] || [];
            let inputId;
            if (scannerType === 'bullish') inputId = 'bullish-symbols';
            else if (scannerType === 'bearish') inputId = 'bearish-symbols';
            else if (scannerType === 'extension') inputId = 'extension-symbols';
            else inputId = 'bullish-symbols';
            
            // Also update unified scanner input
            document.getElementById('unified-symbols').value = symbols.join(', ');
            
            if (document.getElementById(inputId)) {
                document.getElementById(inputId).value = symbols.join(', ');
            }
            showToast(`Loaded ${symbols.length} symbols from ${universe.toUpperCase()}`, 'info');
        }
        
        // Load Extension Scanner watchlist dropdown
        async function populateExtensionWatchlistSelect() {
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                const select = document.getElementById('extension-watchlist-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Watchlist...</option>';
                (data.watchlists || []).forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.name;
                    option.textContent = `${w.name} (${w.symbol_count})`;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Error loading watchlists for extension scanner:', e);
            }
        }
        
        async function loadExtensionWatchlist(watchlistName) {
            const input = document.getElementById('extension-symbols');
            const select = document.getElementById('extension-watchlist-select');
            
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                const watchlists = data.watchlists || [];
                
                if (watchlistName === 'all') {
                    // Load all symbols from all watchlists
                    const allSymbols = new Set();
                    watchlists.forEach(w => {
                        (w.symbols || []).forEach(s => allSymbols.add(s));
                    });
                    const symbolsArray = Array.from(allSymbols);
                    input.value = symbolsArray.join(', ');
                    showToast(`Loaded ${symbolsArray.length} symbols from all watchlists`, 'info');
                } else if (watchlistName) {
                    // Load symbols from specific watchlist
                    const wl = watchlists.find(w => w.name === watchlistName);
                    if (wl && wl.symbols) {
                        input.value = wl.symbols.join(', ');
                        showToast(`Loaded ${wl.symbols.length} symbols from ${watchlistName}`, 'info');
                    }
                }
                
                // Reset select dropdown
                if (select) select.value = '';
            } catch (e) {
                console.error('Error loading watchlist:', e);
                showToast('Failed to load watchlist', 'error');
            }
        }
        
        // =====================================================================
        // ULTIMATE SCANNER - Run all 5 scanners at once
        // =====================================================================
        
        let ultimateResults = { bullish: [], bearish: [], extension: [], compression: [], structure: [] };
        
        async function loadUltimateUniverse(universe) {
            const input = document.getElementById('ultimate-symbols');
            
            if (universe === 'all') {
                // Load from all watchlists
                try {
                    const data = await fetchJson(`${API_BASE}/api/watchlists`);
                    const allSymbols = new Set();
                    (data.watchlists || []).forEach(w => {
                        (w.symbols || []).forEach(s => allSymbols.add(s));
                    });
                    const symbolsArray = Array.from(allSymbols);
                    input.value = symbolsArray.join(', ');
                    showToast(`Loaded ${symbolsArray.length} symbols from all watchlists`, 'info');
                } catch (e) {
                    showToast('Failed to load watchlists', 'error');
                }
            } else {
                const symbols = STOCK_UNIVERSES[universe] || [];
                input.value = symbols.join(', ');
                showToast(`Loaded ${symbols.length} symbols from ${universe.toUpperCase()}`, 'info');
            }
        }
        
        async function runUltimateScan() {
            const symbolsInput = document.getElementById('ultimate-symbols').value.trim();
            if (!symbolsInput) return alert('Load a universe or enter symbols to scan!');
            
            const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            const tf = document.getElementById('ultimate-tf').value;
            
            // Show progress panel
            const progressDiv = document.getElementById('ultimate-scan-progress');
            progressDiv.style.display = 'block';
            
            // Reset results
            ultimateResults = { bullish: [], bearish: [], extension: [], compression: [], structure: [] };
            
            const updateStatus = (scanner, status, count = null) => {
                const el = document.getElementById(`ult-${scanner}-status`);
                const icons = { bullish: '🟢', bearish: '🔴', extension: '⏱️', compression: '⚡', structure: '📈' };
                const names = { bullish: 'Bullish', bearish: 'Bearish', extension: 'Extension', compression: 'Compression', structure: 'Structure' };
                if (status === 'running') {
                    el.innerHTML = `${icons[scanner]} ${names[scanner]}: <span style="color: var(--accent-cyan);">⏳ Scanning...</span>`;
                } else if (status === 'done') {
                    el.innerHTML = `${icons[scanner]} ${names[scanner]}: <span style="color: var(--accent-green);">✅ ${count} found</span>`;
                } else if (status === 'error') {
                    el.innerHTML = `${icons[scanner]} ${names[scanner]}: <span style="color: var(--accent-red);">❌ Error</span>`;
                }
            };
            
            // Run all 5 scanners in parallel using batch endpoints for speed
            const scanPromises = [];
            
            // 1-4. Batch scan for Bullish, Bearish, Compression, Structure (single API call!)
            scanPromises.push((async () => {
                updateStatus('bullish', 'running');
                updateStatus('bearish', 'running');
                updateStatus('compression', 'running');
                updateStatus('structure', 'running');
                try {
                    const resp = await fetch(`${API_BASE}/api/scan/batch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols: symbols, timeframe: tf, scan_type: 'all' })
                    });
                    const data = await resp.json();
                    console.log('Batch scan response:', data);
                    
                    // Process bullish results
                    (data.bullish?.results || []).forEach(r => {
                        ultimateResults.bullish.push({
                            symbol: r.symbol, signal: r.signal, confidence: r.confidence || 0,
                            bull_score: r.bull_score || 0, bear_score: r.bear_score || 0,
                            position: r.position || '-', type: 'bullish'
                        });
                    });
                    updateStatus('bullish', 'done', ultimateResults.bullish.length);
                    
                    // Process bearish results
                    (data.bearish?.results || []).forEach(r => {
                        ultimateResults.bearish.push({
                            symbol: r.symbol, signal: r.signal, confidence: r.confidence || 0,
                            bull_score: r.bull_score || 0, bear_score: r.bear_score || 0,
                            position: r.position || '-', type: 'bearish'
                        });
                    });
                    updateStatus('bearish', 'done', ultimateResults.bearish.length);
                    
                    // Process compression results
                    (data.compression?.results || []).forEach(r => {
                        ultimateResults.compression.push({
                            symbol: r.symbol,
                            compression: r.compression_detected,
                            squeeze: r.squeeze_detected,
                            compression_score: r.compression_score || 0,
                            type: 'compression'
                        });
                    });
                    updateStatus('compression', 'done', ultimateResults.compression.length);
                    
                    // Process structure results
                    (data.structure?.results || []).forEach(r => {
                        ultimateResults.structure.push({
                            symbol: r.symbol,
                            structure: r.structure,
                            trend: r.trend || '-',
                            swings: r.swings || [],
                            type: 'structure'
                        });
                    });
                    updateStatus('structure', 'done', ultimateResults.structure.length);
                    
                } catch (e) {
                    console.error('Batch scan error:', e);
                    updateStatus('bullish', 'error');
                    updateStatus('bearish', 'error');
                    updateStatus('compression', 'error');
                    updateStatus('structure', 'error');
                }
            })());
            
            // 5. Extension Scanner (already batch)
            scanPromises.push((async () => {
                updateStatus('extension', 'running');
                try {
                    const resp = await fetch(`${API_BASE}/api/extension/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(symbols)
                    });
                    const data = await resp.json();
                    console.log('Extension scan response:', data);
                    (data.results || []).forEach(r => {
                        const setup = r.setup || {};
                        const triggerLevel = setup.trigger || 'NONE';
                        if (triggerLevel !== 'NONE' && triggerLevel !== 'WATCHING') {
                            ultimateResults.extension.push({
                                symbol: r.symbol,
                                trigger_level: triggerLevel,
                                snap_back_probability: setup.snap_back_prob || 0,
                                candles_extended: setup.candles || 0,
                                direction: setup.direction || 'N/A',
                                level: setup.level || 'N/A',
                                type: 'extension'
                            });
                        }
                    });
                    updateStatus('extension', 'done', ultimateResults.extension.length);
                } catch (e) { 
                    console.error('Extension scan error:', e);
                    updateStatus('extension', 'error'); 
                }
            })());
            
            // Wait for all scanners to complete
            await Promise.all(scanPromises);
            
            // Render combined results
            renderUltimateResults();
        }
        
        function renderUltimateResults(filter = 'all') {
            const card = document.getElementById('ultimate-results-card');
            const container = document.getElementById('ultimate-results-container');
            const summary = document.getElementById('ultimate-results-summary');
            
            card.classList.remove('hidden');
            
            // Count totals
            const totalBullish = ultimateResults.bullish.length;
            const totalBearish = ultimateResults.bearish.length;
            const totalExtension = ultimateResults.extension.length;
            const totalCompression = ultimateResults.compression.length;
            const totalStructure = ultimateResults.structure.length;
            const grandTotal = totalBullish + totalBearish + totalExtension + totalCompression + totalStructure;
            
            summary.textContent = `🟢 ${totalBullish} Longs | 🔴 ${totalBearish} Shorts | ⏱️ ${totalExtension} Snap-backs | ⚡ ${totalCompression} Breakouts | 📈 ${totalStructure} Structure`;
            
            // Build results based on filter
            let html = '';
            
            // Bullish results
            if ((filter === 'all' || filter === 'bullish') && totalBullish > 0) {
                html += `<div style="margin-bottom: 1rem;"><div style="color: var(--accent-green); font-weight: 600; margin-bottom: 0.5rem;">🟢 BULLISH SETUPS (${totalBullish})</div>`;
                html += `<table class="data-table"><thead><tr><th>Symbol</th><th>Signal</th><th>Confidence</th><th>Position</th></tr></thead><tbody>`;
                ultimateResults.bullish.sort((a,b) => b.confidence - a.confidence).forEach(r => {
                    html += `<tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor:pointer;"><td class="symbol-cell">${r.symbol}</td><td>${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}</td><td class="number-cell">${r.confidence.toFixed(0)}%</td><td>${r.position}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            // Bearish results
            if ((filter === 'all' || filter === 'bearish') && totalBearish > 0) {
                html += `<div style="margin-bottom: 1rem;"><div style="color: var(--accent-red); font-weight: 600; margin-bottom: 0.5rem;">🔴 BEARISH SETUPS (${totalBearish})</div>`;
                html += `<table class="data-table"><thead><tr><th>Symbol</th><th>Signal</th><th>Confidence</th><th>Position</th></tr></thead><tbody>`;
                ultimateResults.bearish.sort((a,b) => b.confidence - a.confidence).forEach(r => {
                    html += `<tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor:pointer;"><td class="symbol-cell">${r.symbol}</td><td>${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}</td><td class="number-cell">${r.confidence.toFixed(0)}%</td><td>${r.position}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            // Extension results
            if ((filter === 'all' || filter === 'extension') && totalExtension > 0) {
                html += `<div style="margin-bottom: 1rem;"><div style="color: var(--accent-cyan); font-weight: 600; margin-bottom: 0.5rem;">⏱️ SNAP-BACK CANDIDATES (${totalExtension})</div>`;
                html += `<table class="data-table"><thead><tr><th>Symbol</th><th>Trigger</th><th>Probability</th><th>Duration</th><th>Direction</th></tr></thead><tbody>`;
                ultimateResults.extension.sort((a,b) => b.snap_back_probability - a.snap_back_probability).forEach(r => {
                    const triggerColors = { ALERT: 'var(--accent-yellow)', HIGH_PROB: 'var(--accent-green)', EXTREME: 'var(--accent-cyan)' };
                    const triggerEmoji = { ALERT: '⚠️', HIGH_PROB: '🔥', EXTREME: '💥' };
                    html += `<tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor:pointer;"><td class="symbol-cell">${r.symbol}</td><td style="color:${triggerColors[r.trigger_level] || 'inherit'};">${triggerEmoji[r.trigger_level] || ''} ${r.trigger_level}</td><td class="number-cell">${r.snap_back_probability}%</td><td>${r.candles_extended} candles</td><td>${r.direction}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            // Compression results
            if ((filter === 'all' || filter === 'compression') && totalCompression > 0) {
                html += `<div style="margin-bottom: 1rem;"><div style="color: var(--accent-yellow); font-weight: 600; margin-bottom: 0.5rem;">⚡ BREAKOUT CANDIDATES (${totalCompression})</div>`;
                html += `<table class="data-table"><thead><tr><th>Symbol</th><th>Compression</th><th>Squeeze</th><th>Score</th></tr></thead><tbody>`;
                ultimateResults.compression.sort((a,b) => b.compression_score - a.compression_score).forEach(r => {
                    html += `<tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor:pointer;"><td class="symbol-cell">${r.symbol}</td><td>${r.compression ? '✅' : '❌'}</td><td>${r.squeeze ? '🔥 YES' : '-'}</td><td class="number-cell">${r.compression_score.toFixed(0)}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            // Structure results
            if ((filter === 'all' || filter === 'structure') && totalStructure > 0) {
                html += `<div style="margin-bottom: 1rem;"><div style="color: var(--accent-purple); font-weight: 600; margin-bottom: 0.5rem;">📈 STRUCTURE PLAYS (${totalStructure})</div>`;
                html += `<table class="data-table"><thead><tr><th>Symbol</th><th>Structure</th><th>Trend</th></tr></thead><tbody>`;
                ultimateResults.structure.forEach(r => {
                    html += `<tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor:pointer;"><td class="symbol-cell">${r.symbol}</td><td>${r.structure}</td><td>${r.trend}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            if (!html) {
                html = `<div style="color: var(--text-muted); text-align: center; padding: 2rem;">No opportunities found. Try a different universe or timeframe.</div>`;
            }
            
            container.innerHTML = html;
            
            // Update filter button styles
            ['all', 'bullish', 'bearish', 'extension', 'compression'].forEach(f => {
                const btn = document.getElementById(`ult-filter-${f}`);
                if (btn) {
                    btn.style.background = (f === filter) ? 'var(--accent-cyan)' : '';
                    btn.style.color = (f === filter) ? 'var(--bg-primary)' : '';
                }
            });
        }
        
        function filterUltimateResults(filter) {
            renderUltimateResults(filter);
        }
        
        function quickAnalyzeSymbol(symbol, entrySignal = null) {
            // Store entry signal for AI analysis
            window.pendingEntrySignal = entrySignal;
            
            // Switch to Scanner tab and run analysis
            document.getElementById('quick-symbol').value = symbol;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('scanner').classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelector('nav button').classList.add('active');
            quickAnalyze();
        }
        
        async function getQuickAIPlan(symbol, entrySignal = null) {
            // Show AI Plan in a modal popup
            const modal = document.createElement('div');
            modal.id = 'quick-ai-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 1rem;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-default);">
                    <div style="padding: 1.25rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">🤖</span>
                            <div>
                                <div style="font-weight: 700; font-size: 1.1rem;">${symbol} AI Trade Plan</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${entrySignal ? entrySignal.replace(':', ' → ').toUpperCase() : 'MTF Analysis'}</div>
                            </div>
                        </div>
                        <button onclick="document.getElementById('quick-ai-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <div id="quick-ai-content" style="padding: 1.25rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; color: var(--accent-cyan);">
                            <div class="loading-spinner"></div>
                            <span>Generating dual-direction trade plan...</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Build URL with entry signal if provided
            let url = `${API_BASE}/api/analyze/live/mtf/${symbol}/ai?trade_tf=swing`;
            if (entrySignal) {
                url += `&entry_signal=${encodeURIComponent(entrySignal)}`;
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'AI request failed');
                }
                
                const data = await response.json();
                
                // Store for trade log
                window.lastQuickAIPlan = {
                    symbol: symbol,
                    direction: data.leading_direction || 'LONG',
                    entry_signal: entrySignal,
                    vah: data.vah,
                    poc: data.poc,
                    val: data.val,
                    current_price: data.current_price,
                    ai_commentary: data.ai_commentary
                };
                
                // Parse entry/stop from AI commentary
                const entryMatch = data.ai_commentary?.match(/ENTRY[:\s]*\$?([\d.]+)/i);
                const stopMatch = data.ai_commentary?.match(/STOP[:\s]*\$?([\d.]+)/i);
                const t1Match = data.ai_commentary?.match(/T1[:\s]*\$?([\d.]+)/i);
                if (entryMatch) window.lastQuickAIPlan.entry = parseFloat(entryMatch[1]);
                if (stopMatch) window.lastQuickAIPlan.stop = parseFloat(stopMatch[1]);
                if (t1Match) window.lastQuickAIPlan.target = parseFloat(t1Match[1]);
                
                const leadingDir = data.leading_direction || '';
                const leadingBadge = leadingDir 
                    ? `<span style="background: ${leadingDir === 'LONG' ? 'rgba(16, 185, 129,0.2)' : 'rgba(255,71,87,0.2)'}; color: ${leadingDir === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">Leading: ${leadingDir}</span>`
                    : '';
                
                document.getElementById('quick-ai-content').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                        ${leadingBadge}
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${data.leading_reason || ''}</span>
                    </div>
                    <div style="font-size: 0.9rem; line-height: 1.7; white-space: pre-line;">${data.ai_commentary || 'No AI plan generated'}</div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn" style="background: var(--accent-green); color: var(--bg-primary); font-size: 0.8rem;" onclick="addQuickAIToTradeLog()">📋 Add to Trade Log</button>
                        <button class="btn" style="background: var(--accent-purple); color: white; font-size: 0.8rem;" onclick="document.getElementById('quick-ai-modal').remove(); quickAnalyzeSymbol('${symbol}', ${entrySignal ? `'${entrySignal}'` : 'null'})">📊 Full Analysis</button>
                        <button class="btn" style="background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.8rem;" onclick="document.getElementById('quick-ai-modal').remove()">Close</button>
                    </div>
                `;
            } catch (e) {
                document.getElementById('quick-ai-content').innerHTML = `
                    <div style="color: var(--accent-red);">Error: ${e.message}</div>
                    <button class="btn" style="margin-top: 1rem; background: var(--bg-tertiary);" onclick="document.getElementById('quick-ai-modal').remove()">Close</button>
                `;
            }
        }
        
        async function addQuickAIToTradeLog() {
            const plan = window.lastQuickAIPlan;
            if (!plan) {
                showToast('No AI plan to log', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('Please log in to save trades', 'error');
                return;
            }
            
            // Create trade entry
            const trade = {
                symbol: plan.symbol,
                direction: plan.direction?.toLowerCase() || 'long',
                entry_price: plan.entry || plan.current_price || 0,
                stop_price: plan.stop || 0,
                target_price: plan.target || 0,
                status: 'planned',
                notes: plan.entry_signal ? `AI Plan: ${plan.entry_signal.replace(':', ' → ')}` : 'AI Generated Plan',
                ai_plan: plan.ai_commentary?.substring(0, 500) || '',
                vah: plan.vah || 0,
                poc: plan.poc || 0,
                val: plan.val || 0,
                created_at: new Date().toISOString()
            };
            
            // Calculate R:R if we have entry and stop
            if (trade.entry_price && trade.stop_price && trade.target_price) {
                const risk = Math.abs(trade.entry_price - trade.stop_price);
                const reward = Math.abs(trade.target_price - trade.entry_price);
                trade.rr_ratio = risk > 0 ? (reward / risk).toFixed(2) : 0;
            }
            
            try {
                // Add to current season trades
                if (!currentSeason) {
                    currentSeason = { trades: [] };
                }
                if (!currentSeason.trades) {
                    currentSeason.trades = [];
                }
                
                trade.id = 'trade_' + Date.now();
                currentSeason.trades.push(trade);
                
                // Save to localStorage
                localStorage.setItem('current_season', JSON.stringify(currentSeason));
                
                // Try to save to Firestore if available
                if (db) {
                    try {
                        await db.collection('users').doc(currentUser.uid).collection('trades').add(trade);
                    } catch (e) {
                        console.log('Firestore save failed, using local storage');
                    }
                }
                
                showToast(`✅ ${plan.symbol} added to trade log!`, 'success');
                
                // Change button to show it was added (but keep modal open)
                const addBtn = document.querySelector('#quick-ai-modal .btn[onclick*="addQuickAIToTradeLog"]');
                if (addBtn) {
                    addBtn.innerHTML = '✅ Added!';
                    addBtn.style.background = 'var(--accent-cyan)';
                    addBtn.disabled = true;
                    addBtn.style.opacity = '0.7';
                }
                
                // Refresh journal if visible
                if (typeof loadSeasonData === 'function') {
                    loadSeasonData();
                }
                
            } catch (e) {
                showToast('Error saving trade: ' + e.message, 'error');
            }
        }

        // =====================================================================
        // WORKFLOW
        // =====================================================================
        
        async function loadWorkflowStatus() {
            try {
                // Calculate from local season data
                let todayTrades = 0;
                let todayR = 0;
                let consecutiveLosses = 0;
                
                if (currentSeason && currentSeason.trades) {
                    const today = new Date().toISOString().split('T')[0];
                    const todaysTradesList = currentSeason.trades.filter(t => 
                        (t.closed_at || t.created_at || '').startsWith(today)
                    );
                    todayTrades = todaysTradesList.length;
                    todayR = todaysTradesList.reduce((sum, t) => sum + (t.r_multiple || 0), 0);
                    
                    // Count consecutive losses (most recent first)
                    const sorted = [...currentSeason.trades].sort((a, b) => 
                        (b.closed_at || b.created_at || '').localeCompare(a.closed_at || a.created_at || '')
                    );
                    for (const t of sorted) {
                        if ((t.r_multiple || 0) < 0) consecutiveLosses++;
                        else break;
                    }
                }
                
                // Update workflow displays (with null checks since elements may not exist)
                const wfTrades = document.getElementById('wf-trades');
                const wfPnl = document.getElementById('wf-pnl');
                const wfConsec = document.getElementById('wf-consec');
                
                if (wfTrades) wfTrades.textContent = `${todayTrades}/4`;
                if (wfPnl) {
                    wfPnl.textContent = `${todayR >= 0 ? '+' : ''}${todayR.toFixed(1)}R`;
                    wfPnl.style.color = todayR >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                }
                if (wfConsec) wfConsec.textContent = consecutiveLosses;
                
                // Also update scanner workflow bar
                updateScannerWorkflowBar();
                
            } catch (e) {
                console.error('Workflow status error:', e);
            }
        }
        
        const MENTAL_CHECK_QUESTIONS = [
            { id: "sleep", question: "Did you get 7+ hours of quality sleep?", red_if: false },
            { id: "revenge", question: "Are you trying to recover losses from yesterday?", red_if: true },
            { id: "fomo", question: "Are you feeling FOMO about missing moves?", red_if: true },
            { id: "distracted", question: "Are you distracted or multitasking?", red_if: true },
            { id: "plan", question: "Do you have a clear plan with defined R:R?", red_if: false },
            { id: "stressed", question: "Are you stressed about money/life situations?", red_if: true },
            { id: "forcing", question: "Do you feel like you MUST take a trade today?", red_if: true },
            { id: "prepared", question: "Have you done your pre-market prep?", red_if: false }
        ];
        
        function runMentalCheck() {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'mental-check-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            let questionsHtml = MENTAL_CHECK_QUESTIONS.map((q, i) => `
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.75rem;">
                    <div style="margin-bottom: 0.75rem; font-size: 0.95rem;">${i + 1}. ${q.question}</div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-sm mental-answer" data-q="${q.id}" data-val="true" 
                                onclick="selectMentalAnswer('${q.id}', true, this)" 
                                style="flex: 1; background: var(--bg-tertiary);">Yes</button>
                        <button class="btn btn-sm mental-answer" data-q="${q.id}" data-val="false" 
                                onclick="selectMentalAnswer('${q.id}', false, this)"
                                style="flex: 1; background: var(--bg-tertiary);">No</button>
                    </div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--accent-cyan);">🧠 Mental State Check</h3>
                        <button onclick="document.getElementById('mental-check-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">×</button>
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.85rem;">
                        Answer honestly. This protects your capital from emotional trading.
                    </p>
                    <div id="mental-questions">${questionsHtml}</div>
                    <button class="btn btn-primary btn-block" onclick="submitMentalCheck()" style="margin-top: 1rem;">
                        Submit Check
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.mentalAnswers = {};
        }
        
        function selectMentalAnswer(questionId, value, btn) {
            window.mentalAnswers[questionId] = value;
            
            // Update button styles
            const container = btn.parentElement;
            container.querySelectorAll('.mental-answer').forEach(b => {
                b.style.background = 'var(--bg-tertiary)';
                b.style.borderColor = 'transparent';
            });
            btn.style.background = value ? 'var(--accent-green)' : 'var(--accent-red)';
        }
        
        async function submitMentalCheck() {
            const answers = window.mentalAnswers || {};
            
            // Count how many questions answered
            if (Object.keys(answers).length < MENTAL_CHECK_QUESTIONS.length) {
                showToast('Please answer all questions', 'error');
                return;
            }
            
            // Calculate state locally
            let redFlags = 0;
            MENTAL_CHECK_QUESTIONS.forEach(q => {
                if (answers[q.id] === q.red_if) {
                    redFlags++;
                }
            });
            
            let state, description;
            if (redFlags === 0) {
                state = 'GREEN';
                description = 'Clear, patient, process-focused';
            } else if (redFlags <= 2) {
                state = 'YELLOW';
                description = 'Caution - some concerns. Reduce size.';
            } else {
                state = 'RED';
                description = 'Do not trade today. Step away.';
            }
            
            // Save to backend
            try {
                const res = await fetch(`${API_BASE}/api/workflow/mental-check`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ state, answers })
                });
            } catch (e) {
                console.log('Mental check save error:', e);
            }
            
            // Update display
            const stateDisplay = document.getElementById('mental-state-display');
            const emoji = state === 'GREEN' ? '🟢' : state === 'YELLOW' ? '🟡' : '🔴';
            stateDisplay.className = `mental-state-indicator ${state.toLowerCase()}`;
            stateDisplay.innerHTML = `
                <span style="font-size: 2rem;">${emoji}</span>
                <div>
                    <div class="mental-state-text">MENTAL STATE: ${state}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${description}</div>
                </div>
            `;
            
            // Close modal
            document.getElementById('mental-check-modal').remove();
            
            // Show result
            showToast(`Mental state: ${state} - ${description}`, state === 'GREEN' ? 'success' : state === 'YELLOW' ? 'warning' : 'error');
        }
        
        async function runPreTradeCheck() {
            const card = document.getElementById('workflow-results-card');
            const container = document.getElementById('workflow-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Running gate checks...</div>';
            
            try {
                // Get today's stats from season trades
                let todayTrades = 0;
                let todayR = 0;
                let consecutiveLosses = 0;
                
                if (currentSeason && currentSeason.trades) {
                    const today = new Date().toISOString().split('T')[0];
                    const todaysTradesList = currentSeason.trades.filter(t => 
                        (t.closed_at || t.created_at || '').startsWith(today)
                    );
                    todayTrades = todaysTradesList.length;
                    todayR = todaysTradesList.reduce((sum, t) => sum + (t.r_multiple || 0), 0);
                    
                    // Count consecutive losses (most recent first)
                    const sorted = [...currentSeason.trades].sort((a, b) => 
                        (b.closed_at || b.created_at || '').localeCompare(a.closed_at || a.created_at || '')
                    );
                    for (const t of sorted) {
                        if ((t.r_multiple || 0) < 0) consecutiveLosses++;
                        else break;
                    }
                }
                
                // Build gate check results locally
                const results = [];
                
                // Gate 1: Mental State
                const mentalEl = document.querySelector('.mental-state-text');
                const mentalState = mentalEl?.textContent?.includes('GREEN') ? 'GREEN' : 
                                   mentalEl?.textContent?.includes('YELLOW') ? 'YELLOW' : 'RED';
                results.push({
                    gate: 'Mental State',
                    passed: mentalState !== 'RED',
                    message: mentalState === 'GREEN' ? 'Clear to trade' : 
                             mentalState === 'YELLOW' ? 'Trade with reduced size' : 'Do not trade!',
                    severity: mentalState === 'RED' ? 'blocker' : mentalState === 'YELLOW' ? 'warning' : 'info'
                });
                
                // Gate 2: Daily Trade Limit
                const maxTrades = 4;
                results.push({
                    gate: 'Daily Trade Limit',
                    passed: todayTrades < maxTrades,
                    message: todayTrades >= maxTrades ? `Already taken ${todayTrades}/${maxTrades} trades. STOP.` :
                             `Trade ${todayTrades + 1}/${maxTrades} for today`,
                    severity: todayTrades >= maxTrades ? 'blocker' : todayTrades >= maxTrades - 1 ? 'warning' : 'info'
                });
                
                // Gate 3: Consecutive Losses
                const maxConsec = 2;
                results.push({
                    gate: 'Loss Streak Protection',
                    passed: consecutiveLosses < maxConsec,
                    message: consecutiveLosses >= maxConsec ? `${consecutiveLosses} consecutive losses. Take a break!` :
                             consecutiveLosses === 1 ? '1 loss in a row. Stay focused.' : 'No consecutive losses',
                    severity: consecutiveLosses >= maxConsec ? 'blocker' : consecutiveLosses === 1 ? 'warning' : 'info'
                });
                
                // Gate 4: Daily Drawdown
                const maxDrawdown = -3.0;
                results.push({
                    gate: 'Daily Drawdown Limit',
                    passed: todayR > maxDrawdown,
                    message: todayR <= maxDrawdown ? `Down ${todayR.toFixed(1)}R today. Max loss reached. STOP.` :
                             `Daily P&L: ${todayR >= 0 ? '+' : ''}${todayR.toFixed(1)}R`,
                    severity: todayR <= maxDrawdown ? 'blocker' : todayR <= maxDrawdown / 2 ? 'warning' : 'info'
                });
                
                // Gate 5: Time of Day
                const hour = new Date().getHours();
                const minute = new Date().getMinutes();
                let timeGate = { passed: true, message: 'Good trading hours', severity: 'info' };
                if (hour < 9 || (hour === 9 && minute < 30)) {
                    timeGate = { passed: false, message: 'Pre-market. Wait for the open.', severity: 'warning' };
                } else if (hour >= 16) {
                    timeGate = { passed: false, message: 'After hours. Market is closed.', severity: 'blocker' };
                } else if (hour >= 11 && hour < 14) {
                    timeGate = { passed: true, message: 'Lunch chop zone (11-2). Be extra selective.', severity: 'warning' };
                }
                results.push({ gate: 'Time of Day', ...timeGate });
                
                // Determine approval
                const blockers = results.filter(r => !r.passed && r.severity === 'blocker');
                const warnings = results.filter(r => r.severity === 'warning');
                const approved = blockers.length === 0;
                
                let positionSize = 1.0;
                if (mentalState === 'YELLOW') positionSize *= 0.5;
                if (warnings.length >= 2) positionSize *= 0.75;
                
                const data = { approved, position_size_multiplier: positionSize, results };
                
                const gateResults = (data.results || []).map(g => `
                    <div class="item-card">
                        <div class="details">
                            <div class="symbol">${g.passed ? '✅' : '❌'} ${g.gate}</div>
                            <div class="meta">${g.message}</div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; margin-bottom: 1rem; border-radius: 10px; ${data.approved ? 'background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);' : 'background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);'}">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${data.approved ? '✅' : '⛔'}</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: ${data.approved ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${data.approved ? 'TRADE APPROVED' : 'TRADE BLOCKED'}
                        </div>
                        ${data.approved ? `<div style="color: var(--text-muted); margin-top: 0.25rem;">Position size: ${(data.position_size_multiplier * 100).toFixed(0)}%</div>` : ''}
                    </div>
                    ${gateResults}
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }

        // =====================================================================
        // WATCHLISTS
        // =====================================================================
        
        let selectedWatchlists = []; // Array for multi-selection
        
        async function loadWatchlists() {
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                window.allWatchlists = data.watchlists || [];
                
                const pills = (data.watchlists || []).map(w => `
                    <div class="watchlist-pill ${selectedWatchlists.includes(w.name) ? 'active' : ''}" 
                         onclick="toggleWatchlistSelection('${w.name}')">
                        ${w.name} (${w.symbol_count})
                    </div>
                `).join('');
                
                document.getElementById('watchlist-pills').innerHTML = pills || '<span style="color: var(--text-muted);">No watchlists yet. Create one!</span>';
                
                // Show combined symbols for all selected watchlists
                updateSelectedWatchlistSymbols();
            } catch (e) {
                console.error('Watchlists error:', e);
                document.getElementById('watchlist-pills').innerHTML = '<span style="color: var(--accent-red);">Error loading watchlists</span>';
            }
        }
        
        function toggleWatchlistSelection(name) {
            const index = selectedWatchlists.indexOf(name);
            if (index === -1) {
                selectedWatchlists.push(name);
            } else {
                selectedWatchlists.splice(index, 1);
            }
            // Also update single selection for add/remove operations
            selectedWatchlist = selectedWatchlists.length > 0 ? selectedWatchlists[selectedWatchlists.length - 1] : '';
            loadWatchlists();
        }
        
        function selectWatchlist(name) {
            selectedWatchlists = [name];
            selectedWatchlist = name;
            loadWatchlists();
        }
        
        function updateSelectedWatchlistSymbols() {
            const allWatchlists = window.allWatchlists || [];
            const selectedData = allWatchlists.filter(w => selectedWatchlists.includes(w.name));
            
            // Combine all symbols from selected watchlists (deduplicated)
            const allSymbols = [...new Set(selectedData.flatMap(w => w.symbols || []))];
            
            if (selectedData.length > 0) {
                const namesLabel = selectedWatchlists.length > 1 
                    ? `${selectedWatchlists.length} watchlists selected` 
                    : selectedWatchlists[0];
                document.getElementById('watchlist-symbols').innerHTML = 
                    `<strong>Symbols (${allSymbols.length}):</strong> ${allSymbols.join(', ') || '<em>Empty</em>'}`;
                document.getElementById('add-to-watchlist-name').textContent = namesLabel;
            } else {
                document.getElementById('watchlist-symbols').innerHTML = '<em>Select watchlist(s) - click multiple to combine</em>';
                document.getElementById('add-to-watchlist-name').textContent = '-';
            }
        }
        
        async function createWatchlist() {
            const name = document.getElementById('new-watchlist-name').value.trim();
            if (!name) {
                alert('Please enter a watchlist name');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, symbols: [] })
                });
                
                document.getElementById('new-watchlist-name').value = '';
                selectedWatchlist = name;
                loadWatchlists();
                showToast(`Watchlist "${name}" created!`, 'success');
            } catch (e) {
                showToast('Error creating watchlist: ' + e.message, 'error');
            }
        }
        
        async function addSymbolToWatchlist() {
            if (!selectedWatchlist) {
                alert('Please select a watchlist first');
                return;
            }
            
            const input = document.getElementById('add-symbol-input').value.trim().toUpperCase();
            if (!input) {
                alert('Please enter symbol(s) to add');
                return;
            }
            
            // Support comma-separated symbols
            const symbols = input.split(',').map(s => s.trim()).filter(s => s);
            
            try {
                for (const symbol of symbols) {
                    await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}/symbols`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol })
                    });
                }
                
                document.getElementById('add-symbol-input').value = '';
                loadWatchlists();
                showToast(`Added ${symbols.join(', ')} to ${selectedWatchlist}`, 'success');
            } catch (e) {
                showToast('Error adding symbol: ' + e.message, 'error');
            }
        }
        
        async function addToWatchlistQuick(symbol) {
            if (!selectedWatchlist) {
                showToast('Select a watchlist first', 'error');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}/symbols`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                
                loadWatchlists();
                showToast(`Added ${symbol} to ${selectedWatchlist}`, 'success');
            } catch (e) {
                showToast('Error adding symbol: ' + e.message, 'error');
            }
        }
        
        async function addSelectedToWatchlist() {
            const checked = document.querySelectorAll('.scan-checkbox:checked');
            if (checked.length === 0) {
                showToast('Select at least one symbol', 'error');
                return;
            }
            
            const symbols = Array.from(checked).map(cb => cb.dataset.symbol);
            
            // Show watchlist picker modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'watchlist-picker-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <div class="modal-title">📋 Add ${symbols.length} symbols to watchlist</div>
                        <button class="modal-close" onclick="document.getElementById('watchlist-picker-modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
                            Symbols: ${symbols.join(', ')}
                        </div>
                        <div class="input-group">
                            <label class="input-label">Select Watchlist</label>
                            <select id="watchlist-picker-select" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-top: 1rem;">
                            <label class="input-label">Or create new watchlist</label>
                            <input type="text" id="new-watchlist-name" placeholder="New watchlist name" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                        </div>
                        <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="confirmAddToWatchlist(['${symbols.join("','")}']])">Add to Watchlist</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load watchlists into picker
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                const select = document.getElementById('watchlist-picker-select');
                select.innerHTML = (data.watchlists || []).map(w => 
                    `<option value="${w.name}">${w.name} (${w.symbols?.length || 0} symbols)</option>`
                ).join('');
                if (select.options.length === 0) {
                    select.innerHTML = '<option value="">No watchlists - create one below</option>';
                }
            } catch (e) {
                console.error('Error loading watchlists:', e);
            }
        }
        
        async function confirmAddToWatchlist(symbols) {
            const selectEl = document.getElementById('watchlist-picker-select');
            const newName = document.getElementById('new-watchlist-name').value.trim();
            
            let watchlistName = newName || selectEl.value;
            
            if (!watchlistName) {
                showToast('Select or create a watchlist', 'error');
                return;
            }
            
            try {
                // Create watchlist if new name provided
                if (newName) {
                    await fetch(`${API_BASE}/api/watchlists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });
                }
                
                // Add symbols one by one
                let added = 0;
                for (const symbol of symbols) {
                    try {
                        await fetch(`${API_BASE}/api/watchlists/${watchlistName}/symbols`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol })
                        });
                        added++;
                    } catch (e) {
                        console.error(`Error adding ${symbol}:`, e);
                    }
                }
                
                document.getElementById('watchlist-picker-modal').remove();
                showToast(`✅ Added ${added} symbols to ${watchlistName}`, 'success');
                loadWatchlists();
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }
        
        async function removeSymbolFromWatchlist() {
            if (!selectedWatchlist) {
                alert('Please select a watchlist first');
                return;
            }
            
            const symbol = document.getElementById('remove-symbol-input').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a symbol to remove');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}/symbols/${symbol}`, {
                    method: 'DELETE'
                });
                
                document.getElementById('remove-symbol-input').value = '';
                loadWatchlists();
                showToast(`Removed ${symbol} from ${selectedWatchlist}`, 'success');
            } catch (e) {
                showToast('Error removing symbol: ' + e.message, 'error');
            }
        }
        
        async function deleteWatchlist() {
            if (!selectedWatchlist) {
                alert('Please select a watchlist first');
                return;
            }
            
            if (!confirm(`Delete watchlist "${selectedWatchlist}"? This cannot be undone.`)) {
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}`, {
                    method: 'DELETE'
                });
                
                showToast(`Watchlist "${selectedWatchlist}" deleted`, 'success');
                selectedWatchlist = 'default';
                loadWatchlists();
            } catch (e) {
                showToast('Error deleting watchlist: ' + e.message, 'error');
            }
        }
        
        async function scanWatchlist() {
            const tf = document.getElementById('scan-tf').value;
            const card = document.getElementById('scan-results-card');
            const container = document.getElementById('scan-results-container');
            
            if (selectedWatchlists.length === 0) {
                showToast('Select at least one watchlist', 'error');
                return;
            }
            
            card.classList.remove('hidden');
            const watchlistLabel = selectedWatchlists.length > 1 
                ? `${selectedWatchlists.length} watchlists` 
                : selectedWatchlists[0];
            container.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Scanning ${watchlistLabel}...</div>`;
            
            try {
                // Combine symbols from all selected watchlists
                const allWatchlists = window.allWatchlists || [];
                const selectedData = allWatchlists.filter(w => selectedWatchlists.includes(w.name));
                const allSymbols = [...new Set(selectedData.flatMap(w => w.symbols || []))];
                
                if (allSymbols.length === 0) {
                    container.innerHTML = '<div style="color: var(--accent-yellow); padding: 1rem;">No symbols in selected watchlist(s)</div>';
                    return;
                }
                
                // Scan all symbols
                const symbolsParam = allSymbols.join(',');
                const data = await fetchJson(`${API_BASE}/api/scan/live?symbols=${symbolsParam}&timeframe=${tf}`);
                
                // Store results for filtering
                window.scanResults = data.results || [];
                window.currentSignalFilter = 'all';
                
                // Reset filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                document.getElementById('min-confidence-filter').value = '0';
                
                renderScanResults();
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        function filterScanResults(signalFilter) {
            // Update signal filter if provided
            if (signalFilter) {
                window.currentSignalFilter = signalFilter;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === signalFilter);
                });
            }
            renderScanResults();
        }
        
        function renderScanResults() {
            const container = document.getElementById('scan-results-container');
            const results = window.scanResults || [];
            const signalFilter = window.currentSignalFilter || 'all';
            const minConfidence = parseInt(document.getElementById('min-confidence-filter').value) || 0;
            
            // Apply filters
            const filtered = results.filter(r => {
                // Signal filter
                if (signalFilter !== 'all') {
                    const signalType = r.signal?.includes('LONG') ? 'GREEN' : 
                                      r.signal?.includes('SHORT') ? 'RED' : 'YELLOW';
                    if (signalType !== signalFilter) return false;
                }
                // Confidence filter
                if ((r.confidence || 0) < minConfidence) return false;
                return true;
            });
            
            // Update count
            document.getElementById('scan-filter-count').textContent = `${filtered.length} of ${results.length} shown`;
            
            if (filtered.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No results match filters</div>';
                return;
            }
            
            const rows = filtered.map((r, idx) => {
                const diagramHtml = getEntryDiagram(r.signal_type, null);
                const diagId = `wl-diagram-${r.symbol}-${idx}`;
                const toggleDiag = diagramHtml ? `event.stopPropagation(); var el=document.getElementById('${diagId}'); el.style.display=el.style.display==='none'?'table-row':'none';` : '';
                return `
                <tr class="scan-result-row" data-symbol="${r.symbol}" onclick="selectScanResult(this, '${r.symbol}')">
                    <td><input type="checkbox" class="scan-checkbox" data-symbol="${r.symbol}" onclick="event.stopPropagation(); updateSelectedCount()"></td>
                    <td class="symbol-cell">${r.symbol}</td>
                    <td>
                        ${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}
                    </td>
                    <td class="number-cell">${r.confidence?.toFixed(0) || 0}%</td>
                    <td>${r.position || '-'}</td>
                    <td style="display: flex; gap: 0.25rem;">
                        ${diagramHtml ? `<button class="btn btn-sm" onclick="${toggleDiag}" title="Entry Diagram" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: rgba(138,43,226,0.2); border-color: var(--accent-purple);">📐</button>` : ''}
                        <button class="btn btn-sm" onclick="event.stopPropagation(); runAIOnSymbol('${r.symbol}')" title="AI Analysis" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                            🤖
                        </button>
                        <button class="btn btn-sm" onclick="event.stopPropagation(); addToWatchlistQuick('${r.symbol}')" title="Add to Watchlist" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                            ➕
                        </button>
                    </td>
                </tr>
                ${diagramHtml ? `<tr id="${diagId}" style="display: none;"><td colspan="6" style="padding: 0.5rem 1rem;">${diagramHtml}</td></tr>` : ''}
            `}).join('');
            
            container.innerHTML = `
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-sm" onclick="selectAllScanResults()" style="font-size: 0.7rem;">Select All</button>
                    <button class="btn btn-sm" onclick="deselectAllScanResults()" style="font-size: 0.7rem;">Clear</button>
                    <button class="btn btn-primary btn-sm" onclick="runAIOnSelected()" style="font-size: 0.7rem;">
                        🤖 AI Analyze Selected (<span id="selected-count">0</span>)
                    </button>
                    <button class="btn btn-sm" onclick="addSelectedToWatchlist()" style="font-size: 0.7rem; background: var(--accent-purple)20; border-color: var(--accent-purple); color: var(--accent-purple);">
                        📋 Add Selected to Watchlist
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Symbol</th>
                            <th>Signal</th>
                            <th>Confidence</th>
                            <th>Position</th>
                            <th style="width: 70px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            updateSelectedCount();
        }
        
        function selectScanResult(row, symbol) {
            const checkbox = row.querySelector('.scan-checkbox');
            checkbox.checked = !checkbox.checked;
            updateSelectedCount();
        }
        
        function selectAllScanResults() {
            document.querySelectorAll('.scan-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        function deselectAllScanResults() {
            document.querySelectorAll('.scan-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = document.querySelectorAll('.scan-checkbox:checked').length;
            const countEl = document.getElementById('selected-count');
            if (countEl) countEl.textContent = count;
        }
        
        async function runAIOnSymbol(symbol) {
            // Switch to Scanner tab and run AI
            showSection('scanner');
            document.getElementById('quick-symbol').value = symbol;
            
            // Run MTF analysis with AI
            showToast(`Running AI analysis on ${symbol}...`, 'info');
            await quickAnalyze();
        }
        
        async function runAIOnSelected() {
            const checked = document.querySelectorAll('.scan-checkbox:checked');
            if (checked.length === 0) {
                showToast('Select at least one symbol', 'error');
                return;
            }
            
            const symbols = Array.from(checked).map(cb => cb.dataset.symbol);
            
            if (symbols.length === 1) {
                // Single symbol - just run normal analysis
                await runAIOnSymbol(symbols[0]);
                return;
            }
            
            // Multiple symbols - show batch results modal
            await runBatchAIAnalysis(symbols);
        }
        
        async function runBatchAIAnalysis(symbols) {
            // Create modal for batch results
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'batch-ai-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
                    <div class="modal-header">
                        <div class="modal-title">🤖 Batch AI Analysis (${symbols.length} symbols)</div>
                        <button class="modal-close" onclick="closeBatchModal()">&times;</button>
                    </div>
                    <div style="padding: 0.75rem 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-default); font-size: 0.75rem; color: var(--text-muted);">
                        <div style="margin-bottom: 0.3rem;"><strong style="color: var(--accent-cyan);">ℹ️ Two Analysis Systems:</strong></div>
                        <div>• <span style="color: var(--accent-yellow);">Algorithm</span> = Scored by price position, VWAP, RSI (scan results)</div>
                        <div>• <span style="color: var(--accent-cyan);">AI</span> = GPT-4o independent assessment with reasoning</div>
                        <div style="margin-top: 0.3rem; color: var(--accent-green);">✅ <strong>CONFIRMED</strong> = Both systems agree → Higher conviction trade</div>
                    </div>
                    <div id="batch-ai-results" style="padding: 1rem;">
                        <div class="loading-overlay"><div class="loading-spinner"></div>Analyzing ${symbols.join(', ')}...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const resultsContainer = document.getElementById('batch-ai-results');
            let resultsHtml = '';
            
            // Analyze each symbol sequentially
            for (let i = 0; i < symbols.length; i++) {
                const symbol = symbols[i];
                resultsContainer.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Analyzing ${symbol} (${i + 1}/${symbols.length})...</div>` + resultsHtml;
                
                try {
                    const tf = document.getElementById('scan-tf').value || '1HR';
                    const vpPeriod = selectedVPPeriod || 'swing';
                    const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&vp_period=${vpPeriod}&with_ai=true`);
                    
                    // Get the original algorithm signal from scan results
                    const scanResult = (window.scanResults || []).find(r => r.symbol === symbol);
                    const algoSignal = scanResult?.signal || data.signal;
                    
                    // Determine AI bias from commentary
                    const ai = data.ai_commentary || '';
                    const aiBiasMatch = ai.match(/TRADE BIAS:\s*(\w+)/i);
                    const aiBias = aiBiasMatch ? aiBiasMatch[1].toUpperCase() : 'NEUTRAL';
                    
                    // Check if they agree
                    const algoIsLong = algoSignal?.includes('LONG');
                    const algoIsShort = algoSignal?.includes('SHORT');
                    const aiIsLong = aiBias === 'LONG' || aiBias === 'BULLISH';
                    const aiIsShort = aiBias === 'SHORT' || aiBias === 'BEARISH';
                    const confirmed = (algoIsLong && aiIsLong) || (algoIsShort && aiIsShort);
                    
                    const signalColor = data.signal?.includes('LONG') ? 'var(--accent-green)' : 
                                       data.signal?.includes('SHORT') ? 'var(--accent-red)' : 'var(--accent-yellow)';
                    
                    // Parse AI commentary for entry/stop/target
                    const entryMatch = ai.match(/ENTRY ZONE:\s*\$?([\d.]+)/i);
                    const stopMatch = ai.match(/STOP LOSS:\s*\$?([\d.]+)/i);
                    const t1Match = ai.match(/TARGET 1:\s*\$?([\d.]+)/i);
                    
                    const entry = entryMatch ? parseFloat(entryMatch[1]) : data.current_price;
                    const stop = stopMatch ? parseFloat(stopMatch[1]) : (data.signal?.includes('LONG') ? data.val : data.vah);
                    const t1 = t1Match ? parseFloat(t1Match[1]) : (data.signal?.includes('LONG') ? data.vah : data.val);
                    
                    // Save to Firestore for historical data
                    if (currentUser && db) {
                        const analysisRecord = {
                            symbol: symbol,
                            timeframe: tf,
                            algo_signal: algoSignal,
                            ai_bias: aiBias,
                            confirmed: confirmed,
                            price: data.current_price || 0,
                            vah: data.vah || 0,
                            poc: data.poc || 0,
                            val: data.val || 0,
                            vwap: data.vwap || 0,
                            rsi: data.rsi || 0,
                            entry: entry,
                            stop: stop,
                            target1: t1,
                            confidence: data.confidence || 0,
                            ai_commentary: data.ai_commentary || '',
                            created_at: new Date().toISOString()
                        };
                        await db.collection('users').doc(currentUser.uid).collection('analyses').add(analysisRecord);
                    }
                    
                    resultsHtml = `
                        <div class="card" style="margin-bottom: 1rem; background: var(--bg-primary); ${confirmed ? 'border: 2px solid var(--accent-green); box-shadow: 0 0 10px rgba(74, 222, 128, 0.2);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div style="font-size: 1.1rem; font-weight: 600;">
                                    ${symbol}
                                    ${confirmed ? '<span style="margin-left: 0.5rem; background: var(--accent-green); color: var(--bg-primary); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">✅ CONFIRMED</span>' : ''}
                                </div>
                                <div style="padding: 0.3rem 0.75rem; background: ${signalColor}20; border: 1px solid ${signalColor}; border-radius: 6px; color: ${signalColor}; font-size: 0.8rem;">
                                    ${data.signal || 'WAIT'}
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; font-size: 0.75rem; margin-bottom: 0.75rem;">
                                <div><span style="color: var(--text-muted);">Entry:</span> $${entry?.toFixed(2) || '-'}</div>
                                <div><span style="color: var(--text-muted);">Stop:</span> $${stop?.toFixed(2) || '-'}</div>
                                <div><span style="color: var(--text-muted);">T1:</span> $${t1?.toFixed(2) || '-'}</div>
                                <div><span style="color: var(--text-muted);">Conf:</span> ${data.confidence?.toFixed(0) || 0}%</div>
                            </div>
                            ${data.ai_commentary ? `
                                <div style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${confirmed ? 'var(--accent-green)' : 'var(--accent-cyan)'};">
                                    ${data.ai_commentary.substring(0, 300)}${data.ai_commentary.length > 300 ? '...' : ''}
                                </div>
                            ` : ''}
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm" onclick="closeBatchModal(); runAIOnSymbol('${symbol}')" style="font-size: 0.7rem;">View Full Analysis</button>
                                <button class="btn btn-sm" onclick="quickLogTrade('${symbol}', '${data.signal}', ${entry || 0}, ${stop || 0})" style="font-size: 0.7rem;">📝 Log Trade</button>
                            </div>
                        </div>
                    ` + resultsHtml;
                    
                } catch (e) {
                    resultsHtml = `
                        <div class="card" style="margin-bottom: 1rem; background: var(--bg-primary); border-color: var(--accent-red);">
                            <div style="font-size: 1.1rem; font-weight: 600;">${symbol}</div>
                            <div style="color: var(--accent-red); font-size: 0.8rem;">Error: ${e.message}</div>
                        </div>
                    ` + resultsHtml;
                }
            }
            
            resultsContainer.innerHTML = resultsHtml;
        }
        
        function closeBatchModal() {
            document.getElementById('batch-ai-modal')?.remove();
        }
        
        async function quickLogTrade(symbol, signal, entry, stop) {
            // Quick log a trade directly from batch results without navigating
            if (!symbol) {
                showToast('No symbol provided', 'error');
                return;
            }
            
            const data = {
                symbol: symbol.toUpperCase(),
                timeframe: '1HR',
                direction: signal?.includes('LONG') ? 'LONG' : 'SHORT',
                entry: entry || 0,
                stop: stop || 0,
                target: 0,
                notes: 'Logged from AI analysis',
                status: 'pending',
                pnl: 0,
                created_at: new Date().toISOString()
            };
            
            try {
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('trades').add(data);
                    showToast(`✅ ${symbol} ${data.direction} trade logged!`, 'success');
                } else {
                    await fetch(`${API_BASE}/api/trades`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    showToast(`✅ ${symbol} ${data.direction} trade logged!`, 'success');
                }
            } catch (e) {
                showToast('Error logging trade: ' + e.message, 'error');
            }
        }

        // =====================================================================
        // ALERTS - Using Firestore for authenticated users
        // =====================================================================
        
        async function loadAlerts() {
            try {
                let alerts = [];
                
                // Use Firestore if user is logged in
                if (currentUser && db) {
                    const snapshot = await db.collection('users').doc(currentUser.uid).collection('alerts').get();
                    snapshot.forEach(doc => {
                        alerts.push({ id: doc.id, ...doc.data() });
                    });
                } else {
                    // Fallback to API
                    const data = await fetchJson(`${API_BASE}/api/alerts`);
                    alerts = data.alerts || [];
                }
                
                if (alerts.length === 0) {
                    document.getElementById('alerts-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🔔</div>
                            <div class="empty-state-text">No active alerts</div>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table" style="font-size: 0.75rem;">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">SYMBOL</th>
                                    <th style="width: 50px;">DIR</th>
                                    <th style="width: 80px;">LEVEL</th>
                                    <th style="width: 80px;">ACTION</th>
                                    <th>NOTE</th>
                                    <th style="width: 40px;"></th>
                                    <th style="width: 40px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                alerts.forEach(a => {
                    const dirColor = (a.direction || '').toLowerCase() === 'above' ? 'var(--accent-green)' : 'var(--accent-red)';
                    const dirIcon = (a.direction || '').toLowerCase() === 'above' ? '↑' : '↓';
                    const alertId = a.id || `${a.symbol}_${a.level}`;
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                            <td style="font-weight: 600; color: var(--accent-cyan);">${a.symbol}</td>
                            <td style="color: ${dirColor};">${dirIcon} ${(a.direction || '').toUpperCase().slice(0,3)}</td>
                            <td style="font-family: 'JetBrains Mono'; color: var(--text-primary);">${fmtMoney(a.level)}</td>
                            <td style="font-size: 0.7rem; color: var(--text-secondary);">${a.action || '-'}</td>
                            <td style="font-size: 0.7rem; color: var(--text-muted); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${a.note || ''}">${a.note || '-'}</td>
                            <td>
                                <button style="background: var(--bg-tertiary); border: 1px solid var(--accent-cyan); color: var(--accent-cyan); width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;" onclick="shareAlert('${a.symbol}', ${a.level}, '${a.direction}', '${a.action}', '${(a.note || '').replace(/'/g, "\\'")}')">📤</button>
                            </td>
                            <td>
                                <button style="background: var(--accent-red); border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;" onclick="deleteAlert('${alertId}')">✕</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>
                    <div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem; border-top: 1px solid var(--border-subtle);">
                        ${alerts.length} active alert${alerts.length !== 1 ? 's' : ''} ${currentUser ? '(synced)' : '(local)'}
                    </div>
                `;
                
                document.getElementById('alerts-list').innerHTML = html;
            } catch (e) {
                console.error('Alerts error:', e);
            }
        }
        
        async function createAlert() {
            const data = {
                symbol: document.getElementById('alert-symbol').value.toUpperCase(),
                level: parseFloat(document.getElementById('alert-level').value),
                direction: document.getElementById('alert-direction').value,
                action: document.getElementById('alert-action').value,
                note: document.getElementById('alert-note').value,
                created_at: new Date().toISOString(),
                triggered: false
            };
            
            if (!data.symbol || !data.level) return alert('Fill in required fields');
            
            try {
                // Use Firestore if logged in
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('alerts').add(data);
                } else {
                    // Fallback to API
                    await fetch(`${API_BASE}/api/alerts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                document.getElementById('alert-symbol').value = '';
                document.getElementById('alert-level').value = '';
                document.getElementById('alert-note').value = '';
                
                loadAlerts();
            } catch (e) {
                console.error('Create alert error:', e);
                alert('Error creating alert');
            }
        }
        
        async function deleteAlert(alertId) {
            try {
                // Use Firestore if logged in
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('alerts').doc(alertId).delete();
                } else {
                    // Fallback - alertId might be "symbol_level" format
                    const [symbol, level] = alertId.split('_');
                    await fetch(`${API_BASE}/api/alerts?symbol=${symbol}&level=${level}`, { method: 'DELETE' });
                }
                loadAlerts();
            } catch (e) {
                console.error('Delete alert error:', e);
                alert('Error deleting alert');
            }
        }
        
        async function createAlertsFromTrade(symbol, direction, entry, stop, target) {
            if (!currentUser || !db) {
                showToast('Please sign in to create alerts', 'error');
                return;
            }
            
            const alerts = [];
            const isLong = direction === 'LONG';
            
            // Entry alert
            if (entry && entry > 0) {
                alerts.push({
                    symbol: symbol.toUpperCase(),
                    level: entry,
                    direction: isLong ? 'above' : 'below',
                    action: 'Entry zone reached',
                    note: `${direction} entry at $${entry.toFixed(2)}`,
                    created_at: new Date().toISOString(),
                    triggered: false
                });
            }
            
            // Stop loss alert
            if (stop && stop > 0) {
                alerts.push({
                    symbol: symbol.toUpperCase(),
                    level: stop,
                    direction: isLong ? 'below' : 'above',
                    action: 'Stop loss hit',
                    note: `${direction} stop at $${stop.toFixed(2)}`,
                    created_at: new Date().toISOString(),
                    triggered: false
                });
            }
            
            // Target alert
            if (target && target > 0) {
                alerts.push({
                    symbol: symbol.toUpperCase(),
                    level: target,
                    direction: isLong ? 'above' : 'below',
                    action: 'Target reached',
                    note: `${direction} target at $${target.toFixed(2)}`,
                    created_at: new Date().toISOString(),
                    triggered: false
                });
            }
            
            if (alerts.length === 0) {
                showToast('No valid price levels to create alerts', 'error');
                return;
            }
            
            try {
                let created = 0;
                for (const alert of alerts) {
                    await db.collection('users').doc(currentUser.uid).collection('alerts').add(alert);
                    created++;
                }
                showToast(`✅ Created ${created} alerts for ${symbol}`, 'success');
                loadAlerts();
            } catch (e) {
                showToast('Error creating alerts: ' + e.message, 'error');
            }
        }
        
        async function quickViewAnalysis(symbol) {
            // Try to get from localStorage cache first
            const cacheKey = `analysis_${symbol.toUpperCase()}`;
            let analysis = null;
            
            // Check localStorage first
            try {
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const parsed = JSON.parse(cached);
                    // Use if less than 24 hours old
                    if (parsed.timestamp && (Date.now() - parsed.timestamp) < 24 * 60 * 60 * 1000) {
                        analysis = parsed;
                    }
                }
            } catch (e) {
                console.log('LocalStorage cache miss');
            }
            
            // Check Firebase history if not in cache
            if (!analysis && currentUser && db) {
                try {
                    const snapshot = await db.collection('users').doc(currentUser.uid)
                        .collection('analyses')
                        .where('symbol', '==', symbol.toUpperCase())
                        .limit(5)
                        .get();
                    
                    if (!snapshot.empty) {
                        // Get most recent
                        let analyses = [];
                        snapshot.forEach(doc => analyses.push({ id: doc.id, ...doc.data() }));
                        analyses.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                        analysis = analyses[0];
                        
                        // Cache it
                        localStorage.setItem(cacheKey, JSON.stringify({ ...analysis, timestamp: Date.now() }));
                    }
                } catch (e) {
                    console.error('Firebase history lookup error:', e);
                }
            }
            
            // Show modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'quick-view-modal';
            
            if (!analysis) {
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <div class="modal-title">📝 ${symbol} - No History</div>
                            <button class="modal-close" onclick="document.getElementById('quick-view-modal').remove()">&times;</button>
                        </div>
                        <div style="padding: 1.5rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">No trade plan found for ${symbol}</p>
                            <button class="btn btn-primary" onclick="document.getElementById('quick-view-modal').remove(); runAIOnSymbol('${symbol}')">🤖 Generate Trade Plan</button>
                        </div>
                    </div>
                `;
            } else {
                const date = analysis.created_at ? new Date(analysis.created_at).toLocaleString() : 'Unknown';
                const signalColor = analysis.algo_signal?.includes('LONG') ? 'var(--accent-green)' : 
                                   analysis.algo_signal?.includes('SHORT') ? 'var(--accent-red)' : 'var(--accent-yellow)';
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <div class="modal-title">� ${symbol} - Trade Plan</div>
                            <button class="modal-close" onclick="document.getElementById('quick-view-modal').remove()">&times;</button>
                        </div>
                        <div style="padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">Last analyzed: ${date}</span>
                                    ${analysis.confirmed ? '<span style="margin-left: 0.5rem; background: var(--accent-green); color: var(--bg-primary); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">✅ CONFIRMED</span>' : ''}
                                </div>
                                <div style="padding: 0.3rem 0.75rem; background: ${signalColor}20; border: 1px solid ${signalColor}; border-radius: 6px; color: ${signalColor}; font-size: 0.8rem;">
                                    ${analysis.algo_signal || 'WAIT'}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">ENTRY</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-cyan);">$${analysis.entry?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">STOP</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-red);">$${analysis.stop?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">TARGET</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-green);">$${analysis.target1?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">CONF</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem;">${analysis.confidence?.toFixed(0) || '-'}%</div>
                                </div>
                            </div>
                            
                            ${analysis.ai_commentary ? `
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">AI Commentary:</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 1rem; border-radius: 6px; border-left: 3px solid var(--accent-cyan); white-space: pre-wrap; max-height: 300px; overflow-y: auto;">${analysis.ai_commentary}</div>
                            ` : '<div style="color: var(--text-muted); text-align: center; padding: 1rem;">No AI commentary available</div>'}
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn" style="flex: 1; background: var(--accent-cyan)20; border: 1px solid var(--accent-cyan); color: var(--accent-cyan);" onclick="document.getElementById('quick-view-modal').remove(); runAIOnSymbol('${symbol}')">🤖 Generate Fresh Plan</button>
                                <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('quick-view-modal').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.body.appendChild(modal);
        }

        // =====================================================================
        // TRADES - Using Firestore for authenticated users
        // =====================================================================
        
        async function loadTrades() {
            try {
                let stats = { total: 0, wins: 0, losses: 0, win_rate: 0 };
                let trades = [];
                
                console.log('loadTrades - currentUser:', currentUser?.uid, 'db:', !!db);
                
                // Use Firestore if logged in
                if (currentUser && db) {
                    try {
                        // Simple query without orderBy to avoid index requirement
                        const snapshot = await db.collection('users').doc(currentUser.uid)
                            .collection('trades')
                            .get();
                        
                        snapshot.forEach(doc => {
                            trades.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Sort in JavaScript instead
                        trades.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                        
                        console.log('Loaded trades from Firestore:', trades.length, trades);
                    } catch (fsError) {
                        console.error('Firestore trades error:', fsError);
                    }
                    
                    // Calculate stats from trades
                    const closed = trades.filter(t => t.status === 'closed');
                    const wins = closed.filter(t => t.pnl > 0);
                    const losses = closed.filter(t => t.pnl < 0);
                    stats = {
                        total: closed.length,
                        wins: wins.length,
                        losses: losses.length,
                        win_rate: closed.length > 0 ? (wins.length / closed.length * 100) : 0
                    };
                } else {
                    // Fallback to API
                    const statsData = await fetchJson(`${API_BASE}/api/trades/stats`);
                    stats = statsData;
                    const tradesData = await fetchJson(`${API_BASE}/api/trades?status=pending`);
                    trades = tradesData.trades || [];
                }
                
                const tsTotal = document.getElementById('ts-total');
                const tsWins = document.getElementById('ts-wins');
                const tsLosses = document.getElementById('ts-losses');
                const tsWinrate = document.getElementById('ts-winrate');
                if (tsTotal) tsTotal.textContent = stats.total || stats.total_trades || 0;
                if (tsWins) tsWins.textContent = stats.wins || 0;
                if (tsLosses) tsLosses.textContent = stats.losses || 0;
                if (tsWinrate) tsWinrate.textContent = fmtPercent(stats.win_rate || 0, 0);
                
                // Filter to pending trades for display
                const pendingTrades = trades.filter(t => t.status === 'pending' || !t.status);
                
                if (pendingTrades.length === 0) {
                    document.getElementById('trades-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <div class="empty-state-text">No pending trades</div>
                        </div>
                    `;
                    return;
                }
                
                const html = pendingTrades.map(t => `
                    <div class="item-card">
                        <div class="details">
                            <div class="symbol">${t.symbol} ${t.direction}</div>
                            <div class="meta">
                                Entry: ${fmtMoney(t.entry || t.entry_price)} • Stop: ${fmtMoney(t.stop || t.stop_loss)} • Target: ${fmtMoney(t.target || t.target_1)}
                            </div>
                        </div>
                        <div class="actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-sm" style="background: var(--accent-purple)20; border: 1px solid var(--accent-purple); color: var(--accent-purple);" onclick="quickViewAnalysis('${t.symbol}')" title="View Trade Plan">📋</button>
                            <button class="btn btn-sm" style="background: var(--accent-cyan)20; border: 1px solid var(--accent-cyan); color: var(--accent-cyan);" onclick="runAIOnSymbol('${t.symbol}')" title="Run AI Analysis">🤖</button>
                            <button class="btn btn-sm" style="background: var(--accent-yellow)20; border: 1px solid var(--accent-yellow); color: var(--accent-yellow);" onclick="createAlertsFromTrade('${t.symbol}', '${t.direction}', ${t.entry || t.entry_price || 0}, ${t.stop || t.stop_loss || 0}, ${t.target || t.target_1 || 0})" title="Create Alerts">🔔</button>
                            <button class="btn btn-success btn-sm" onclick="closeTrade('${t.id}', 'win')" title="Mark as Win">✓</button>
                            <button class="btn btn-danger btn-sm" onclick="closeTrade('${t.id}', 'loss')" title="Mark as Loss">✕</button>
                            <button class="btn btn-sm" style="background: var(--text-muted); color: white;" onclick="cancelTrade('${t.id}')" title="Cancel/Remove">🚫</button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('trades-list').innerHTML = html;
            } catch (e) {
                console.error('Trades error:', e);
            }
        }
        
        async function logTrade() {
            const data = {
                symbol: document.getElementById('trade-symbol').value.toUpperCase(),
                timeframe: '1HR',
                direction: document.getElementById('trade-direction').value,
                entry: parseFloat(document.getElementById('trade-entry').value),
                stop: parseFloat(document.getElementById('trade-stop').value),
                target: parseFloat(document.getElementById('trade-target').value),
                notes: document.getElementById('trade-notes').value,
                status: 'pending',
                pnl: 0,
                created_at: new Date().toISOString()
            };
            
            if (!data.symbol || !data.entry) return alert('Fill in required fields');
            
            try {
                // Use Firestore if logged in
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('trades').add(data);
                } else {
                    // Fallback to API
                    await fetch(`${API_BASE}/api/trades`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                document.getElementById('trade-symbol').value = '';
                document.getElementById('trade-entry').value = '';
                document.getElementById('trade-stop').value = '';
                document.getElementById('trade-target').value = '';
                document.getElementById('trade-notes').value = '';
                
                loadTrades();
            } catch (e) {
                alert('Error logging trade');
            }
        }
        
        async function logTradeToSeason() {
            if (!currentSeason || !currentUser || !db) {
                showToast('Please create a season first', 'error');
                return;
            }
            
            const symbol = document.getElementById('trade-symbol').value.toUpperCase();
            const direction = document.getElementById('trade-direction').value;
            const rMultiple = parseFloat(document.getElementById('trade-r-result')?.value) || 0;
            const entry = parseFloat(document.getElementById('trade-entry').value) || 0;
            const stop = parseFloat(document.getElementById('trade-stop').value) || 0;
            const notes = document.getElementById('trade-notes').value;
            
            if (!symbol) {
                showToast('Enter a symbol', 'error');
                return;
            }
            
            // Calculate % gain if entry and stop provided
            const risk = Math.abs(entry - stop);
            const pctGain = entry > 0 && risk > 0 ? (rMultiple * risk / entry) * 100 : rMultiple;
            const grossPnl = 0; // User can add later
            
            const trade = {
                symbol,
                direction,
                r_multiple: rMultiple,
                pct_gain: pctGain,
                gross_pnl: grossPnl,
                notes: notes,
                closed_at: new Date().toISOString(),
                created_at: new Date().toISOString()
            };
            
            try {
                const trades = currentSeason.trades || [];
                trades.push(trade);
                
                await db.collection('users').doc(currentUser.uid).collection('seasons').doc(currentSeason.id).update({
                    trades: trades
                });
                
                // Clear form
                document.getElementById('trade-symbol').value = '';
                document.getElementById('trade-entry').value = '';
                document.getElementById('trade-stop').value = '';
                document.getElementById('trade-target').value = '';
                document.getElementById('trade-r-result').value = '';
                document.getElementById('trade-notes').value = '';
                
                showToast(`${symbol} ${rMultiple >= 0 ? '+' : ''}${rMultiple.toFixed(1)}R added!`, 'success');
                loadSeasons();
                updateScannerWorkflowBar();
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }
        
        // =====================================================================
        // TRADING CHALLENGES - Compete with other traders
        // =====================================================================
        
        let activeChallenges = [];
        let currentChallengeId = null;
        
        function generateChallengeCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function showCreateChallenge() {
            document.getElementById('create-challenge-modal').style.display = 'flex';
        }
        
        function showJoinChallenge() {
            document.getElementById('join-challenge-modal').style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        async function createChallenge() {
            if (!currentUser || !db) {
                showToast('Please sign in first', 'error');
                return;
            }
            
            const name = document.getElementById('challenge-name').value.trim();
            const type = document.getElementById('challenge-type').value;
            const target = parseFloat(document.getElementById('challenge-target').value) || 10;
            const duration = parseInt(document.getElementById('challenge-duration').value);
            const buyin = document.getElementById('challenge-buyin').value;
            
            if (!name) {
                showToast('Please enter a challenge name', 'error');
                return;
            }
            
            const code = generateChallengeCode();
            const startDate = new Date();
            const endDate = new Date(startDate.getTime() + duration * 24 * 60 * 60 * 1000);
            
            const challenge = {
                code: code,
                name: name,
                type: type,
                target: target,
                buyin: buyin,
                duration: duration,
                start_date: startDate.toISOString(),
                end_date: endDate.toISOString(),
                created_by: currentUser.uid,
                creator_id: currentUser.uid,
                created_by_name: currentUser.displayName || currentUser.email.split('@')[0],
                participants: [{
                    uid: currentUser.uid,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    score: 0,
                    trades: 0,
                    joined_at: startDate.toISOString()
                }],
                status: 'active',
                created_at: startDate.toISOString()
            };
            
            try {
                // Store in shared challenges collection
                await db.collection('challenges').doc(code).set(challenge);
                
                // Also store reference in user's challenges
                await db.collection('users').doc(currentUser.uid).collection('my_challenges').doc(code).set({
                    code: code,
                    name: name,
                    role: 'creator',
                    joined_at: startDate.toISOString()
                });
                
                closeModal('create-challenge-modal');
                showToast(`Challenge created! Code: ${code}`, 'success');
                
                // Show the code prominently
                alert(`🎮 Challenge Created!\n\nShare this code with friends:\n\n${code}\n\nThey can join using this code in the Seasons tab.`);
                
                loadChallenges();
            } catch (e) {
                console.error('Create challenge error:', e);
                showToast('Failed to create challenge', 'error');
            }
        }
        
        async function joinChallenge() {
            if (!currentUser || !db) {
                showToast('Please sign in first', 'error');
                return;
            }
            
            const code = document.getElementById('join-challenge-code').value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                showToast('Please enter a valid 6-character code', 'error');
                return;
            }
            
            try {
                // Find the challenge
                const doc = await db.collection('challenges').doc(code).get();
                
                if (!doc.exists) {
                    showToast('Challenge not found. Check the code.', 'error');
                    return;
                }
                
                const challenge = doc.data();
                
                // Check if already joined
                if (challenge.participants.some(p => p.uid === currentUser.uid)) {
                    showToast('You already joined this challenge!', 'info');
                    closeModal('join-challenge-modal');
                    loadChallenges();
                    return;
                }
                
                // Check if challenge is still active
                if (new Date(challenge.end_date) < new Date()) {
                    showToast('This challenge has ended', 'error');
                    return;
                }
                
                // Add participant
                challenge.participants.push({
                    uid: currentUser.uid,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    score: 0,
                    trades: 0,
                    joined_at: new Date().toISOString()
                });
                
                await db.collection('challenges').doc(code).update({
                    participants: challenge.participants
                });
                
                // Store reference in user's challenges
                await db.collection('users').doc(currentUser.uid).collection('my_challenges').doc(code).set({
                    code: code,
                    name: challenge.name,
                    role: 'participant',
                    joined_at: new Date().toISOString()
                });
                
                closeModal('join-challenge-modal');
                showToast(`Joined "${challenge.name}"! 🎮`, 'success');
                loadChallenges();
                
            } catch (e) {
                console.error('Join challenge error:', e);
                showToast('Failed to join challenge', 'error');
            }
        }
        
        async function loadChallenges() {
            const container = document.getElementById('active-challenges') || document.getElementById('challenges-list');
            
            if (!container) {
                console.log('Challenges container not found');
                return;
            }
            
            if (!currentUser || !db) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.85rem;">
                        🔒 Sign in to participate in challenges
                    </div>
                `;
                return;
            }
            
            try {
                // Get user's challenges
                const myChallengeDocs = await db.collection('users').doc(currentUser.uid).collection('my_challenges').get();
                const myChallenges = [];
                myChallengeDocs.forEach(doc => myChallenges.push(doc.data()));
                
                if (myChallenges.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 1.5rem; color: var(--text-muted); font-size: 0.85rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🏁</div>
                            No active challenges. Create one or join with a code!
                        </div>
                    `;
                    return;
                }
                
                // Fetch full challenge data
                activeChallenges = [];
                for (const ref of myChallenges) {
                    const challengeDoc = await db.collection('challenges').doc(ref.code).get();
                    if (challengeDoc.exists) {
                        activeChallenges.push({ id: ref.code, ...challengeDoc.data() });
                    }
                }
                
                // Render challenges
                container.innerHTML = activeChallenges.map(c => renderChallengeCard(c)).join('');
                
            } catch (e) {
                console.error('Load challenges error:', e);
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error loading challenges</div>`;
            }
        }
        
        function renderChallengeCard(challenge) {
            const now = new Date();
            const end = new Date(challenge.end_date);
            const start = new Date(challenge.start_date);
            const isActive = end > now;
            const daysLeft = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
            
            // Sort participants by score
            const sorted = [...challenge.participants].sort((a, b) => b.score - a.score);
            const myRank = sorted.findIndex(p => p.uid === currentUser.uid) + 1;
            const myScore = sorted.find(p => p.uid === currentUser.uid)?.score || 0;
            const leader = sorted[0];
            
            const typeLabels = {
                'percentage': '📈 % Gain',
                'r-multiple': '📊 R-Multiple',
                'win-streak': '🔥 Win Streak',
                'trade-count': '🎯 Trades'
            };
            
            const statusBadge = isActive 
                ? `<span style="background: var(--accent-green); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">${daysLeft}d left</span>`
                : `<span style="background: var(--accent-red); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600;">ENDED</span>`;
            
            return `
                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 0.75rem; border-left: 3px solid ${isActive ? 'var(--accent-yellow)' : 'var(--text-muted)'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${challenge.name}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">${typeLabels[challenge.type]} • Target: ${challenge.target} • ${challenge.participants.length} players</div>
                        </div>
                        ${statusBadge}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="background: var(--bg-secondary); padding: 0.4rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.6rem; color: var(--text-muted);">Your Rank</div>
                            <div style="font-size: 1rem; font-weight: 700; color: ${myRank === 1 ? 'var(--accent-yellow)' : 'var(--text-primary)'};">#${myRank}</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 0.4rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.6rem; color: var(--text-muted);">Your Score</div>
                            <div style="font-size: 1rem; font-weight: 700; color: var(--accent-cyan);">${myScore.toFixed(1)}</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 0.4rem; border-radius: 4px; text-align: center;">
                            <div style="font-size: 0.6rem; color: var(--text-muted);">Leader</div>
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--accent-yellow);">👑 ${leader.name.split(' ')[0]}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="universe-btn" onclick="showLeaderboard('${challenge.code}')" style="flex: 1;">🏆 Leaderboard</button>
                        <button class="universe-btn" onclick="updateMyScore('${challenge.code}')" style="flex: 1;">📊 Update Score</button>
                    </div>
                </div>
            `;
        }
        
        async function showLeaderboard(code) {
            currentChallengeId = code;
            const challenge = activeChallenges.find(c => c.id === code);
            if (!challenge) return;
            
            document.getElementById('leaderboard-title').textContent = `🏆 ${challenge.name}`;
            document.getElementById('share-code-btn').dataset.code = code;
            
            const typeLabels = {
                'percentage': '% Gain',
                'r-multiple': 'R-Multiple',
                'win-streak': 'Win Streak',
                'trade-count': 'Trades'
            };
            
            const end = new Date(challenge.end_date);
            const daysLeft = Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24));
            
            document.getElementById('challenge-info').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="color: var(--text-muted);">Type:</span> ${typeLabels[challenge.type]} 
                        <span style="margin-left: 1rem; color: var(--text-muted);">Target:</span> ${challenge.target}
                        <span style="margin-left: 1rem; color: var(--text-muted);">Stakes:</span> ${challenge.buyin === '0' ? 'Free' : challenge.buyin}
                    </div>
                    <div style="font-size: 0.8rem; color: ${daysLeft > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                        ${daysLeft > 0 ? `${daysLeft} days left` : 'Challenge ended'}
                    </div>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">
                    Share code: <span style="font-family: monospace; background: var(--bg-secondary); padding: 2px 6px; border-radius: 3px;">${code}</span>
                </div>
            `;
            
            // Sort and render leaderboard
            const sorted = [...challenge.participants].sort((a, b) => b.score - a.score);
            
            const rows = sorted.map((p, i) => {
                const rank = i + 1;
                const isMe = p.uid === currentUser.uid;
                const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
                
                return `
                    <tr style="${isMe ? 'background: rgba(0, 212, 255, 0.1);' : ''}">
                        <td style="font-size: 1.1rem; text-align: center;">${medal}</td>
                        <td style="font-weight: ${isMe ? '700' : '400'}; color: ${isMe ? 'var(--accent-cyan)' : 'var(--text-primary)'};">
                            ${p.name} ${isMe ? '(You)' : ''}
                        </td>
                        <td style="text-align: right; font-weight: 600; color: ${p.score >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${p.score >= 0 ? '+' : ''}${p.score.toFixed(2)}
                        </td>
                        <td style="text-align: right; color: var(--text-muted);">${p.trades || 0} trades</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('leaderboard-container').innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-default);">
                            <th style="padding: 0.5rem; text-align: center; width: 50px;">Rank</th>
                            <th style="padding: 0.5rem; text-align: left;">Trader</th>
                            <th style="padding: 0.5rem; text-align: right;">Score</th>
                            <th style="padding: 0.5rem; text-align: right;">Activity</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            
            document.getElementById('challenge-leaderboard-modal').style.display = 'flex';
        }
        
        function copyShareCode() {
            const btn = document.getElementById('share-code-btn');
            const code = btn.dataset.code;
            navigator.clipboard.writeText(code);
            showToast(`Code "${code}" copied!`, 'success');
        }
        
        async function updateMyScore(code) {
            if (!currentUser || !db || !currentSeason) {
                showToast('Load a season first to calculate your score', 'info');
                return;
            }
            
            const challenge = activeChallenges.find(c => c.id === code);
            if (!challenge) return;
            
            // Calculate score based on challenge type
            const trades = currentSeason.trades || [];
            let score = 0;
            let tradeCount = trades.length;
            
            switch (challenge.type) {
                case 'percentage':
                    score = trades.reduce((sum, t) => sum + (t.pct_gain || 0), 0);
                    break;
                case 'r-multiple':
                    score = trades.reduce((sum, t) => sum + (t.r_result || 0), 0);
                    break;
                case 'win-streak':
                    let currentStreak = 0;
                    let maxStreak = 0;
                    trades.forEach(t => {
                        if ((t.r_result || 0) > 0) {
                            currentStreak++;
                            maxStreak = Math.max(maxStreak, currentStreak);
                        } else {
                            currentStreak = 0;
                        }
                    });
                    score = maxStreak;
                    break;
                case 'trade-count':
                    score = tradeCount;
                    break;
            }
            
            // Update in Firestore
            try {
                const participants = challenge.participants.map(p => {
                    if (p.uid === currentUser.uid) {
                        return { ...p, score: score, trades: tradeCount };
                    }
                    return p;
                });
                
                await db.collection('challenges').doc(code).update({ participants });
                
                showToast(`Score updated: ${score.toFixed(2)}`, 'success');
                loadChallenges();
                
                if (document.getElementById('challenge-leaderboard-modal').style.display === 'flex') {
                    showLeaderboard(code);
                }
            } catch (e) {
                console.error('Update score error:', e);
                showToast('Failed to update score', 'error');
            }
        }
        
        async function submitChallengeUpdate() {
            if (currentChallengeId) {
                await updateMyScore(currentChallengeId);
            }
        }
        
        // =====================================================================
        // SEASONS - Visual Trade Bracket System
        // =====================================================================
        
        let currentSeason = null;
        
        async function loadSeasons() {
            const container = document.getElementById('season-bracket');
            
            if (!currentUser || !db) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔒</div>
                        <div class="empty-state-text">Sign in to track seasons</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Loading seasons...</div>';
            
            try {
                // Get all seasons
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('seasons').get();
                
                let seasons = [];
                snapshot.forEach(doc => seasons.push({ id: doc.id, ...doc.data() }));
                seasons.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                
                if (seasons.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🏆</div>
                            <div class="empty-state-text">No seasons yet. Create your first season!</div>
                        </div>
                    `;
                    resetSeasonStats();
                    return;
                }
                
                // Use most recent season
                currentSeason = seasons[0];
                
                // Calculate stats
                const trades = currentSeason.trades || [];
                const stats = calculateSeasonStats(trades);
                updateSeasonStats(stats);
                
                // Update milestone tracker
                updateMilestoneTracker(stats.totalPct);
                
                // Render bracket view
                renderSeasonBracket(currentSeason, seasons);
                
            } catch (e) {
                console.error('Load seasons error:', e);
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        function calculateSeasonStats(trades) {
            let totalR = 0;
            let totalPct = 0;
            let totalGross = 0;
            let wins = 0;
            let losses = 0;
            let drawdown = 0;
            let maxDrawdown = 0;
            let totalWinR = 0;
            let totalLossR = 0;
            let equityCurve = [0]; // Start at 0
            let runningR = 0;
            let peakR = 0;
            
            trades.forEach(t => {
                const r = t.r_multiple || 0;
                const pct = t.pct_gain || 0;
                const gross = t.gross_pnl || 0;
                
                totalR += r;
                totalPct += pct;
                totalGross += gross;
                runningR += r;
                equityCurve.push(runningR);
                
                if (r > 0) {
                    wins++;
                    totalWinR += r;
                    peakR = Math.max(peakR, runningR);
                } else if (r < 0) {
                    losses++;
                    totalLossR += Math.abs(r);
                }
                
                // Track drawdown from peak
                const currentDrawdown = peakR - runningR;
                if (currentDrawdown > maxDrawdown) maxDrawdown = currentDrawdown;
            });
            
            const toRecover = Math.max(0, peakR - runningR);
            const status = toRecover <= 0 ? 'peak' : toRecover < 2 ? 'recovering' : 'drawdown';
            const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;
            const avgWin = wins > 0 ? totalWinR / wins : 0;
            const avgLoss = losses > 0 ? totalLossR / losses : 0;
            
            return { 
                totalR, totalPct, totalGross, wins, losses, toRecover, status, maxDrawdown,
                winRate, avgWin, avgLoss, equityCurve, peakR
            };
        }
        
        function updateSeasonStats(stats) {
            const rColor = stats.totalR >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const pctColor = stats.totalPct >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            document.getElementById('season-total-r').textContent = `${stats.totalR >= 0 ? '+' : ''}${stats.totalR.toFixed(1)}R`;
            document.getElementById('season-total-r').style.color = rColor;
            
            document.getElementById('season-total-pct').textContent = `${stats.totalPct >= 0 ? '+' : ''}${stats.totalPct.toFixed(1)}%`;
            document.getElementById('season-total-pct').style.color = pctColor;
            
            document.getElementById('season-wins').textContent = stats.wins;
            document.getElementById('season-losses').textContent = stats.losses;
            const recoveryEl = document.getElementById('season-recovery') || document.getElementById('season-r-recover');
            if (recoveryEl) recoveryEl.textContent = stats.toRecover > 0 ? `${stats.toRecover.toFixed(1)}R` : '✅';
            
            const statusEl = document.getElementById('season-status');
            if (stats.status === 'peak') {
                statusEl.textContent = '🟢';
                statusEl.title = 'At or above peak';
            } else if (stats.status === 'recovering') {
                statusEl.textContent = '🟡';
                statusEl.title = 'Recovering from drawdown';
            } else {
                statusEl.textContent = '🔴';
                statusEl.title = 'In drawdown';
            }
            
            // Update R-Compensation Calculator
            updateRCompensationCalc(stats);
            
            // Update Equity Curve
            renderEquityCurve(stats.equityCurve || [0], stats.peakR || 0);
            
            // Update Goal Tracker
            updateGoalTracker(stats.totalGross || 0);
        }
        
        function updateRCompensationCalc(stats) {
            const maxDdEl = document.getElementById('r-max-dd');
            const winRateEl = document.getElementById('r-win-rate');
            const avgWinEl = document.getElementById('r-avg-win');
            const avgLossEl = document.getElementById('r-avg-loss');
            const recoveryPlan = document.getElementById('r-recovery-plan');
            
            // Only update if elements exist
            if (maxDdEl) maxDdEl.textContent = `${stats.maxDrawdown.toFixed(1)}R`;
            if (winRateEl) winRateEl.textContent = `${stats.winRate.toFixed(0)}%`;
            if (avgWinEl) avgWinEl.textContent = `+${stats.avgWin.toFixed(2)}R`;
            if (avgLossEl) avgLossEl.textContent = `-${stats.avgLoss.toFixed(2)}R`;
            
            if (!recoveryPlan) return;
            
            // Calculate recovery plan
            if (stats.toRecover > 0) {
                // Calculate wins needed based on avg win
                const winsNeeded = stats.avgWin > 0 ? Math.ceil(stats.toRecover / stats.avgWin) : '?';
                const expectancy = stats.avgWin * (stats.winRate / 100) - stats.avgLoss * (1 - stats.winRate / 100);
                const tradesNeeded = expectancy > 0 ? Math.ceil(stats.toRecover / expectancy) : '?';
                
                recoveryPlan.innerHTML = `
                    <div style="color: var(--accent-yellow); font-weight: 600; margin-bottom: 0.5rem;">🚨 Recovery Needed: ${stats.toRecover.toFixed(1)}R to peak</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                        <div>
                            <div style="color: var(--accent-green); font-size: 1.2rem; font-weight: 600;">${winsNeeded}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Wins Needed<br>(at avg)</div>
                        </div>
                        <div>
                            <div style="color: var(--accent-cyan); font-size: 1.2rem; font-weight: 600;">${tradesNeeded}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Expected Trades<br>(at current rate)</div>
                        </div>
                        <div>
                            <div style="color: var(--accent-purple); font-size: 1.2rem; font-weight: 600;">${expectancy > 0 ? '+' : ''}${expectancy.toFixed(2)}R</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Expectancy<br>(per trade)</div>
                        </div>
                    </div>
                `;
            } else {
                const expectancy = stats.avgWin * (stats.winRate / 100) - stats.avgLoss * (1 - stats.winRate / 100);
                recoveryPlan.innerHTML = `
                    <div style="color: var(--accent-green); font-weight: 600;">✅ At Peak! No recovery needed</div>
                    <div style="margin-top: 0.5rem;">Expectancy: <span style="color: ${expectancy >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${expectancy >= 0 ? '+' : ''}${expectancy.toFixed(2)}R</span> per trade</div>
                `;
            }
        }
        
        function renderEquityCurve(curve, peakR) {
            const container = document.getElementById('equity-curve');
            const legend = document.getElementById('equity-legend');
            
            // Early return if elements don't exist
            if (!container) return;
            
            if (curve.length < 2) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Add trades to see equity curve</div>';
                if (legend) legend.innerHTML = '';
                return;
            }
            
            const width = container.clientWidth || 400;
            const height = 120;
            const padding = 10;
            
            const minR = Math.min(...curve, 0);
            const maxR = Math.max(...curve, peakR, 1);
            const range = maxR - minR || 1;
            
            // Build SVG path
            let pathD = '';
            let areaD = '';
            const points = [];
            
            curve.forEach((r, i) => {
                const x = padding + (i / (curve.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((r - minR) / range) * (height - 2 * padding);
                points.push({ x, y, r });
                
                if (i === 0) {
                    pathD += `M ${x} ${y}`;
                    areaD += `M ${x} ${height - padding}`;
                    areaD += ` L ${x} ${y}`;
                } else {
                    pathD += ` L ${x} ${y}`;
                    areaD += ` L ${x} ${y}`;
                }
            });
            
            // Close area
            areaD += ` L ${points[points.length - 1].x} ${height - padding} Z`;
            
            // Determine final color based on current equity
            const finalR = curve[curve.length - 1];
            const lineColor = finalR >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            const areaColor = finalR >= 0 ? 'rgba(74, 222, 128, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            
            // Create SVG with color-coded segments
            let segmentPaths = '';
            for (let i = 1; i < points.length; i++) {
                const prev = points[i - 1];
                const curr = points[i];
                const segColor = curr.r >= prev.r ? 'var(--accent-green)' : 'var(--accent-red)';
                segmentPaths += `<line x1="${prev.x}" y1="${prev.y}" x2="${curr.x}" y2="${curr.y}" stroke="${segColor}" stroke-width="2.5" stroke-linecap="round"/>`;
            }
            
            // Zero line
            const zeroY = height - padding - ((0 - minR) / range) * (height - 2 * padding);
            
            // Peak line
            const peakY = height - padding - ((peakR - minR) / range) * (height - 2 * padding);
            
            container.innerHTML = `
                <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                    <!-- Zero line -->
                    <line x1="${padding}" y1="${zeroY}" x2="${width - padding}" y2="${zeroY}" stroke="var(--border-subtle)" stroke-width="1" stroke-dasharray="4,4"/>
                    <!-- Peak line -->
                    ${peakR > 0 ? `<line x1="${padding}" y1="${peakY}" x2="${width - padding}" y2="${peakY}" stroke="var(--accent-cyan)" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>` : ''}
                    <!-- Area fill -->
                    <path d="${areaD}" fill="${areaColor}"/>
                    <!-- Color-coded line segments -->
                    ${segmentPaths}
                    <!-- Points -->
                    ${points.map((p, i) => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="${p.r >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}" stroke="var(--bg-primary)" stroke-width="1"/>`).join('')}
                </svg>
            `;
            
            legend.innerHTML = `
                <span><span style="color: var(--accent-green);">●</span> Winning trade</span>
                <span><span style="color: var(--accent-red);">●</span> Losing trade</span>
                <span><span style="color: var(--accent-cyan);">---</span> Peak: ${peakR.toFixed(1)}R</span>
                <span>Current: <span style="color: ${finalR >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${finalR >= 0 ? '+' : ''}${finalR.toFixed(1)}R</span></span>
            `;
        }
        
        function resetSeasonStats() {
            const el = (id) => document.getElementById(id);
            if (el('season-total-r')) el('season-total-r').textContent = '0R';
            if (el('season-total-pct')) el('season-total-pct').textContent = '0%';
            if (el('season-wins')) el('season-wins').textContent = '0';
            if (el('season-losses')) el('season-losses').textContent = '0';
            const recoveryEl = el('season-recovery') || el('season-r-recover');
            if (recoveryEl) recoveryEl.textContent = '0R';
            if (el('season-status')) el('season-status').textContent = '➖';
            updateMilestoneTracker(0);
            updateGoalTracker(0);
        }
        
        // =====================================================================
        // GOAL TRACKER - Track gross profit toward a season goal
        // =====================================================================
        
        async function setSeasonGoal() {
            if (!currentSeason || !currentUser || !db) {
                showToast('Please create a season first', 'error');
                return;
            }
            
            const currentGoal = currentSeason.goal || 0;
            const input = prompt(`Enter your gross profit goal for this season (current: $${currentGoal.toLocaleString()}):`, currentGoal || 10000);
            
            if (input === null) return;
            
            const goal = parseFloat(input.replace(/[,$]/g, '')) || 0;
            
            if (goal <= 0) {
                showToast('Please enter a valid goal amount', 'error');
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('seasons').doc(currentSeason.id).update({
                    goal: goal
                });
                
                currentSeason.goal = goal;
                const stats = calculateSeasonStats(currentSeason.trades || []);
                updateGoalTracker(stats.totalGross);
                
                showToast(`Goal set to $${goal.toLocaleString()}!`, 'success');
            } catch (e) {
                showToast('Error setting goal: ' + e.message, 'error');
            }
        }
        
        function updateGoalTracker(totalGross) {
            // Check if goal tracker elements exist
            const goalTargetEl = document.getElementById('goal-target');
            if (!goalTargetEl) return; // Goal tracker not in current view
            
            const goal = currentSeason?.goal || 0;
            const earned = totalGross || 0;
            const remaining = Math.max(0, goal - earned);
            const progress = goal > 0 ? Math.min(100, (earned / goal) * 100) : 0;
            
            // Format currency
            const fmtCurrency = (val) => {
                if (Math.abs(val) >= 1000) {
                    return `$${(val / 1000).toFixed(1)}k`;
                }
                return `$${val.toFixed(0)}`;
            };
            
            const fmtCurrencyFull = (val) => `$${val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            // Update display values
            goalTargetEl.textContent = goal > 0 ? fmtCurrency(goal) : '$0';
            
            const earnedEl = document.getElementById('goal-earned');
            if (!earnedEl) return;
            earnedEl.textContent = fmtCurrency(earned);
            earnedEl.style.color = earned >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            const remainingEl = document.getElementById('goal-remaining');
            if (remainingEl) {
                if (earned >= goal && goal > 0) {
                    remainingEl.textContent = '🎉 DONE!';
                    remainingEl.style.color = 'var(--accent-green)';
                } else {
                    remainingEl.textContent = fmtCurrency(remaining);
                    remainingEl.style.color = 'var(--accent-red)';
                }
            }
            
            const goalPctEl = document.getElementById('goal-pct');
            if (goalPctEl) goalPctEl.textContent = `${progress.toFixed(0)}%`;
            
            // Update progress bar
            const fillEl = document.getElementById('goal-progress-fill');
            const textEl = document.getElementById('goal-progress-text');
            
            if (goal > 0 && fillEl) {
                fillEl.style.width = `${Math.min(100, progress)}%`;
                
                if (progress >= 100) {
                    fillEl.style.background = 'linear-gradient(90deg, var(--accent-green), var(--accent-cyan), gold)';
                    if (textEl) { textEl.textContent = `🎉 GOAL ACHIEVED! +${fmtCurrencyFull(earned - goal)} over target!`; textEl.style.color = '#000'; }
                } else if (progress >= 75) {
                    fillEl.style.background = 'linear-gradient(90deg, var(--accent-green), var(--accent-cyan))';
                    if (textEl) textEl.textContent = `🔥 Almost there! ${fmtCurrencyFull(remaining)} to go!`;
                } else if (progress >= 50) {
                    fillEl.style.background = 'linear-gradient(90deg, var(--accent-cyan), var(--accent-purple))';
                    if (textEl) textEl.textContent = `💪 Halfway! ${fmtCurrencyFull(remaining)} remaining`;
                } else if (progress >= 25) {
                    fillEl.style.background = 'linear-gradient(90deg, var(--accent-yellow), var(--accent-cyan))';
                    if (textEl) textEl.textContent = `📈 Making progress! ${fmtCurrencyFull(remaining)} to go`;
                } else {
                    fillEl.style.background = 'linear-gradient(90deg, var(--accent-red), var(--accent-yellow))';
                    if (textEl) textEl.textContent = `🚀 ${fmtCurrencyFull(earned)} earned | ${fmtCurrencyFull(remaining)} to goal`;
                }
            } else if (fillEl) {
                fillEl.style.width = '0%';
                if (textEl) textEl.textContent = 'Set a goal to start tracking!';
            }
            
            // Update breakdown
            const breakdown = document.getElementById('goal-breakdown');
            if (breakdown) {
                if (goal > 0 && currentSeason?.trades?.length > 0) {
                    const avgGross = earned / currentSeason.trades.length;
                    const tradesNeeded = remaining > 0 && avgGross > 0 ? Math.ceil(remaining / avgGross) : 0;
                    
                    breakdown.innerHTML = `
                        Avg P&L per trade: <span style="color: ${avgGross >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${fmtCurrencyFull(avgGross)}</span>
                        ${tradesNeeded > 0 ? ` • Est. <span style="color: var(--accent-cyan); font-weight: 600;">${tradesNeeded} trades</span> to reach goal at current avg` : ''}
                    `;
                } else {
                    breakdown.innerHTML = '';
                }
            }
        }
        
        // Milestone definitions
        const MILESTONES = [
            { pct: 10, icon: '🥉', label: '10%', color: '#cd7f32' },
            { pct: 25, icon: '🥈', label: '25%', color: '#c0c0c0' },
            { pct: 50, icon: '🥇', label: '50%', color: '#ffd700' },
            { pct: 75, icon: '💎', label: '75%', color: '#00d4ff' },
            { pct: 100, icon: '🏆', label: '100%', color: '#f59e0b' },
            { pct: 150, icon: '🔥', label: '150%', color: '#ff6b35' },
            { pct: 200, icon: '⚡', label: '200%', color: '#9d4edd' },
            { pct: 300, icon: '🚀', label: '300%', color: '#4ade80' },
            { pct: 500, icon: '👑', label: '500%', color: '#ef4444' },
            { pct: 1000, icon: '🌟', label: '1000%', color: '#00d4ff' }
        ];
        
        function updateMilestoneTracker(totalPct) {
            const badgesContainer = document.getElementById('milestone-badges');
            const progressFill = document.getElementById('milestone-fill');
            const progressText = document.getElementById('milestone-text');
            
            if (!badgesContainer) return;
            
            // Find achieved and next milestone
            let achievedMilestones = [];
            let nextMilestone = MILESTONES[0];
            let prevMilestone = { pct: 0 };
            
            for (let i = 0; i < MILESTONES.length; i++) {
                if (totalPct >= MILESTONES[i].pct) {
                    achievedMilestones.push(MILESTONES[i]);
                    prevMilestone = MILESTONES[i];
                    nextMilestone = MILESTONES[i + 1] || { pct: MILESTONES[i].pct * 2, icon: '🌌', label: 'Beyond!' };
                } else {
                    nextMilestone = MILESTONES[i];
                    break;
                }
            }
            
            // Render badges
            let badgesHtml = '';
            MILESTONES.forEach(m => {
                const achieved = totalPct >= m.pct;
                const style = achieved 
                    ? `background: ${m.color}20; border: 2px solid ${m.color}; color: ${m.color};`
                    : `background: var(--bg-tertiary); border: 2px solid var(--border-subtle); color: var(--text-muted); opacity: 0.5;`;
                
                badgesHtml += `
                    <div style="padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem; ${style}">
                        <span>${m.icon}</span>
                        <span>${m.label}</span>
                        ${achieved ? '<span style="font-size: 0.6rem;">✓</span>' : ''}
                    </div>
                `;
            });
            badgesContainer.innerHTML = badgesHtml;
            
            // Calculate progress to next milestone
            const range = nextMilestone.pct - prevMilestone.pct;
            const progress = totalPct - prevMilestone.pct;
            const progressPct = Math.min(100, Math.max(0, (progress / range) * 100));
            
            progressFill.style.width = `${progressPct}%`;
            progressFill.style.background = `linear-gradient(90deg, ${prevMilestone.color || 'var(--accent-green)'}, ${nextMilestone.color || 'var(--accent-cyan)'})`;
            
            const remaining = (nextMilestone.pct - totalPct).toFixed(1);
            progressText.innerHTML = totalPct >= 0 
                ? `${totalPct.toFixed(1)}% → ${nextMilestone.icon} ${nextMilestone.label} (${remaining}% to go)`
                : `${totalPct.toFixed(1)}% - Recover to start milestone progress`;
        }
        
        function renderSeasonBracket(season, allSeasons) {
            const container = document.getElementById('season-bracket');
            const trades = season.trades || [];
            
            // Group trades by week
            const weeks = {};
            trades.forEach(t => {
                const date = new Date(t.closed_at || t.created_at);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!weeks[weekKey]) weeks[weekKey] = [];
                weeks[weekKey].push(t);
            });
            
            // Build bracket HTML
            let html = `
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    ${allSeasons.map(s => `
                        <button class="btn btn-sm ${s.id === season.id ? 'btn-primary' : ''}" 
                                onclick="switchSeason('${s.id}')" 
                                style="font-size: 0.75rem;">
                            ${s.name || 'Season'} ${s.id === season.id ? '✓' : ''}
                        </button>
                    `).join('')}
                </div>
                
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent-cyan);">
                    📊 ${season.name || 'Current Season'} 
                    <span style="font-size: 0.8rem; color: var(--text-muted);">
                        (${trades.length} trades)
                    </span>
                </div>
            `;
            
            // Render bracket tree
            const weekKeys = Object.keys(weeks).sort();
            
            if (weekKeys.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        No closed trades in this season yet.<br>
                        <button class="btn btn-primary btn-sm" style="margin-top: 1rem;" onclick="addTradeToSeason()">+ Add Trade</button>
                    </div>
                `;
            } else {
                html += '<div style="display: flex; gap: 2rem; overflow-x: auto; padding: 1rem 0;">';
                
                weekKeys.forEach((weekKey, idx) => {
                    const weekTrades = weeks[weekKey];
                    const weekDate = new Date(weekKey);
                    const weekLabel = `Week ${idx + 1}`;
                    
                    // Calculate week stats
                    let weekR = 0, weekPct = 0, weekWins = 0, weekLosses = 0;
                    weekTrades.forEach(t => {
                        weekR += t.r_multiple || 0;
                        weekPct += t.pct_gain || 0;
                        if ((t.r_multiple || 0) > 0) weekWins++;
                        else if ((t.r_multiple || 0) < 0) weekLosses++;
                    });
                    
                    const weekColor = weekR >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    
                    html += `
                        <div style="min-width: 200px; background: var(--bg-secondary); border-radius: 8px; padding: 0.75rem; border-left: 3px solid ${weekColor};">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                                <span>${weekLabel}</span>
                                <span style="color: ${weekColor};">${weekR >= 0 ? '+' : ''}${weekR.toFixed(1)}R</span>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                                ${weekDate.toLocaleDateString()} | ${weekPct >= 0 ? '+' : ''}${weekPct.toFixed(1)}% | W:${weekWins} L:${weekLosses}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    `;
                    
                    weekTrades.forEach(t => {
                        const tradeColor = (t.r_multiple || 0) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                        const icon = (t.r_multiple || 0) >= 0 ? '✓' : '✕';
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.3rem 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                                <span style="display: flex; align-items: center; gap: 0.3rem;">
                                    <span style="color: ${tradeColor};">${icon}</span>
                                    <span style="font-weight: 500;">${t.symbol}</span>
                                    <span style="color: var(--text-muted);">${t.direction}</span>
                                </span>
                                <span style="display: flex; gap: 0.5rem;">
                                    <span style="color: ${tradeColor};">${(t.r_multiple || 0) >= 0 ? '+' : ''}${(t.r_multiple || 0).toFixed(1)}R</span>
                                    <span style="color: var(--text-muted);">${(t.pct_gain || 0) >= 0 ? '+' : ''}${(t.pct_gain || 0).toFixed(1)}%</span>
                                </span>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                });
                
                html += '</div>';
            }
            
            // Add trade button
            html += `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle);">
                    <button class="btn btn-primary" onclick="addTradeToSeason()">+ Add Closed Trade to Season</button>
                    <button class="btn" style="margin-left: 0.5rem;" onclick="importPendingTrades()">📥 Import from Pending</button>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        async function createNewSeason() {
            const name = prompt('Enter season name (e.g., "January 2026", "Q1 2026"):');
            if (!name) return;
            
            if (!currentUser || !db) {
                showToast('Please sign in first', 'error');
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('seasons').add({
                    name: name,
                    trades: [],
                    created_at: new Date().toISOString(),
                    status: 'active'
                });
                
                showToast(`Season "${name}" created!`, 'success');
                loadSeasons();
            } catch (e) {
                showToast('Error creating season: ' + e.message, 'error');
            }
        }
        
        async function switchSeason(seasonId) {
            if (!currentUser || !db) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).collection('seasons').doc(seasonId).get();
                if (doc.exists) {
                    currentSeason = { id: doc.id, ...doc.data() };
                    const stats = calculateSeasonStats(currentSeason.trades || []);
                    updateSeasonStats(stats);
                    
                    // Re-render with all seasons
                    const snapshot = await db.collection('users').doc(currentUser.uid).collection('seasons').get();
                    let seasons = [];
                    snapshot.forEach(d => seasons.push({ id: d.id, ...d.data() }));
                    seasons.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                    
                    renderSeasonBracket(currentSeason, seasons);
                }
            } catch (e) {
                showToast('Error switching season: ' + e.message, 'error');
            }
        }
        
        async function addTradeToSeason() {
            if (!currentSeason) {
                showToast('Create a season first', 'error');
                return;
            }
            
            // Show modal for adding trade
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'add-season-trade-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 450px;">
                    <div class="modal-header">
                        <div class="modal-title">➕ Add Trade to ${currentSeason.name}</div>
                        <button class="modal-close" onclick="document.getElementById('add-season-trade-modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1rem;">
                        <div class="input-group">
                            <label class="input-label">Symbol</label>
                            <input type="text" id="season-trade-symbol" placeholder="AAPL" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Direction</label>
                            <select id="season-trade-direction" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                                <option value="LONG">LONG</option>
                                <option value="SHORT">SHORT</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <div class="input-group">
                                <label class="input-label">R-Multiple</label>
                                <input type="number" step="0.1" id="season-trade-r" placeholder="1.5" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                            </div>
                            <div class="input-group">
                                <label class="input-label">% Gain</label>
                                <input type="number" step="0.1" id="season-trade-pct" placeholder="2.5" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                            </div>
                            <div class="input-group">
                                <label class="input-label">💰 Gross P&L ($)</label>
                                <input type="number" step="0.01" id="season-trade-gross" placeholder="150.00" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Close Date</label>
                            <input type="date" id="season-trade-date" style="width: 100%; padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);">
                        </div>
                        <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="saveSeasonTrade()">Add Trade</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set default date to today
            document.getElementById('season-trade-date').value = new Date().toISOString().split('T')[0];
        }
        
        async function saveSeasonTrade() {
            const symbol = document.getElementById('season-trade-symbol').value.trim().toUpperCase();
            const direction = document.getElementById('season-trade-direction').value;
            const rMultiple = parseFloat(document.getElementById('season-trade-r').value) || 0;
            const pctGain = parseFloat(document.getElementById('season-trade-pct').value) || 0;
            const closeDate = document.getElementById('season-trade-date').value;
            
            if (!symbol) {
                showToast('Enter a symbol', 'error');
                return;
            }
            
            const grossPnl = parseFloat(document.getElementById('season-trade-gross').value) || 0;
            
            const trade = {
                symbol,
                direction,
                r_multiple: rMultiple,
                pct_gain: pctGain,
                gross_pnl: grossPnl,
                closed_at: closeDate ? new Date(closeDate).toISOString() : new Date().toISOString(),
                created_at: new Date().toISOString()
            };
            
            try {
                const trades = currentSeason.trades || [];
                trades.push(trade);
                
                await db.collection('users').doc(currentUser.uid).collection('seasons').doc(currentSeason.id).update({
                    trades: trades
                });
                
                document.getElementById('add-season-trade-modal').remove();
                showToast(`${symbol} added to season!`, 'success');
                loadSeasons();
            } catch (e) {
                showToast('Error adding trade: ' + e.message, 'error');
            }
        }
        
        async function importPendingTrades() {
            if (!currentSeason || !currentUser || !db) {
                showToast('Create a season and sign in first', 'error');
                return;
            }
            
            try {
                // Get closed trades from trades collection
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('trades').get();
                let closedTrades = [];
                snapshot.forEach(doc => {
                    const t = doc.data();
                    if (t.status === 'closed' && t.pnl !== undefined) {
                        closedTrades.push(t);
                    }
                });
                
                if (closedTrades.length === 0) {
                    showToast('No closed trades to import', 'info');
                    return;
                }
                
                // Add to season
                const seasonTrades = currentSeason.trades || [];
                let imported = 0;
                
                closedTrades.forEach(t => {
                    // Calculate R-multiple from entry/stop
                    const entry = t.entry || 0;
                    const stop = t.stop || 0;
                    const risk = Math.abs(entry - stop);
                    const rMultiple = risk > 0 ? (t.pnl || 0) / risk : 0;
                    
                    // Calculate % gain
                    const pctGain = entry > 0 ? ((t.pnl || 0) / entry) * 100 : 0;
                    
                    seasonTrades.push({
                        symbol: t.symbol,
                        direction: t.direction,
                        r_multiple: rMultiple,
                        pct_gain: pctGain,
                        closed_at: t.closed_at || t.created_at,
                        created_at: new Date().toISOString()
                    });
                    imported++;
                });
                
                await db.collection('users').doc(currentUser.uid).collection('seasons').doc(currentSeason.id).update({
                    trades: seasonTrades
                });
                
                showToast(`Imported ${imported} trades!`, 'success');
                loadSeasons();
            } catch (e) {
                showToast('Error importing: ' + e.message, 'error');
            }
        }
        
        // =====================================================================
        // HISTORY - View past analyses from Firestore
        // =====================================================================
        
        async function loadHistory() {
            const container = document.getElementById('history-list');
            const filter = document.getElementById('history-filter').value;
            
            if (!currentUser || !db) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔒</div>
                        <div class="empty-state-text">Sign in to view analysis history</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Loading history...</div>';
            
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('analyses')
                    .get();
                
                let analyses = [];
                snapshot.forEach(doc => {
                    analyses.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date descending
                analyses.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                
                // Apply filter
                if (filter === 'confirmed') {
                    analyses = analyses.filter(a => a.confirmed);
                } else if (filter === 'long') {
                    analyses = analyses.filter(a => a.algo_signal?.includes('LONG') || a.ai_bias === 'LONG');
                } else if (filter === 'short') {
                    analyses = analyses.filter(a => a.algo_signal?.includes('SHORT') || a.ai_bias === 'SHORT');
                }
                
                if (analyses.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📜</div>
                            <div class="empty-state-text">No analyses found</div>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table class="data-table" style="font-size: 0.75rem;">
                        <thead>
                            <tr>
                                <th>DATE</th>
                                <th>SYMBOL</th>
                                <th>ALGO</th>
                                <th>AI</th>
                                <th>MATCH</th>
                                <th>PRICE</th>
                                <th>ENTRY</th>
                                <th>STOP</th>
                                <th>TARGET</th>
                                <th>CONF%</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                analyses.forEach(a => {
                    const date = a.created_at ? new Date(a.created_at).toLocaleDateString() : '-';
                    const time = a.created_at ? new Date(a.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    const algoColor = a.algo_signal?.includes('LONG') ? 'var(--accent-green)' : 
                                     a.algo_signal?.includes('SHORT') ? 'var(--accent-red)' : 'var(--accent-yellow)';
                    const aiColor = (a.ai_bias === 'LONG' || a.ai_bias === 'BULLISH') ? 'var(--accent-green)' : 
                                   (a.ai_bias === 'SHORT' || a.ai_bias === 'BEARISH') ? 'var(--accent-red)' : 'var(--accent-yellow)';
                    
                    html += `
                        <tr style="${a.confirmed ? 'background: rgba(74, 222, 128, 0.1);' : ''}">
                            <td style="white-space: nowrap;">${date}<br><span style="color: var(--text-muted); font-size: 0.65rem;">${time}</span></td>
                            <td style="font-weight: 600;">${a.symbol}</td>
                            <td><span style="color: ${algoColor};">${a.algo_signal || '-'}</span></td>
                            <td><span style="color: ${aiColor};">${a.ai_bias || '-'}</span></td>
                            <td>${a.confirmed ? '<span style="color: var(--accent-green);">✅</span>' : '<span style="color: var(--text-muted);">-</span>'}</td>
                            <td>$${a.price?.toFixed(2) || '-'}</td>
                            <td>$${a.entry?.toFixed(2) || '-'}</td>
                            <td>$${a.stop?.toFixed(2) || '-'}</td>
                            <td>$${a.target1?.toFixed(2) || '-'}</td>
                            <td>${a.confidence?.toFixed(0) || '-'}%</td>
                            <td>
                                <button class="btn btn-sm" onclick="viewHistoryDetail('${a.id}')" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">📄</button>
                                <button class="btn btn-sm" onclick="deleteHistoryItem('${a.id}')" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; background: var(--accent-red)20; color: var(--accent-red);">🗑️</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                html += `<div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.75rem;">${analyses.length} analyses found</div>`;
                container.innerHTML = html;
                
            } catch (e) {
                console.error('Load history error:', e);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">❌</div>
                        <div class="empty-state-text">Error loading history: ${e.message}</div>
                    </div>
                `;
            }
        }
        
        async function viewHistoryDetail(analysisId) {
            if (!currentUser || !db) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).collection('analyses').doc(analysisId).get();
                if (!doc.exists) {
                    showToast('Analysis not found', 'error');
                    return;
                }
                
                const a = doc.data();
                const date = a.created_at ? new Date(a.created_at).toLocaleString() : '-';
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'history-detail-modal';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <div class="modal-title">📄 ${a.symbol} Analysis - ${date}</div>
                            <button class="modal-close" onclick="document.getElementById('history-detail-modal').remove()">&times;</button>
                        </div>
                        <div style="padding: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div class="card" style="padding: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.25rem;">Algorithm Signal</div>
                                    <div style="font-size: 1rem; color: ${a.algo_signal?.includes('LONG') ? 'var(--accent-green)' : a.algo_signal?.includes('SHORT') ? 'var(--accent-red)' : 'var(--accent-yellow)'};">${a.algo_signal || '-'}</div>
                                </div>
                                <div class="card" style="padding: 0.75rem;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.25rem;">AI Bias</div>
                                    <div style="font-size: 1rem; color: ${(a.ai_bias === 'LONG' || a.ai_bias === 'BULLISH') ? 'var(--accent-green)' : (a.ai_bias === 'SHORT' || a.ai_bias === 'BEARISH') ? 'var(--accent-red)' : 'var(--accent-yellow)'};">${a.ai_bias || '-'}</div>
                                </div>
                            </div>
                            
                            ${a.confirmed ? '<div style="background: var(--accent-green)20; border: 1px solid var(--accent-green); padding: 0.5rem; border-radius: 6px; text-align: center; margin-bottom: 1rem; color: var(--accent-green);">✅ CONFIRMED - Both systems agreed</div>' : ''}
                            
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">PRICE</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem;">$${a.price?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">VAH</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-green);">$${a.vah?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">POC</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-yellow);">$${a.poc?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">VAL</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-red);">$${a.val?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">RSI</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem;">${a.rsi?.toFixed(1) || '-'}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">ENTRY</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-cyan);">$${a.entry?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">STOP</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-red);">$${a.stop?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">TARGET</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--accent-green);">$${a.target1?.toFixed(2) || '-'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">CONFIDENCE</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.9rem;">${a.confidence?.toFixed(0) || '-'}%</div>
                                </div>
                            </div>
                            
                            ${a.ai_commentary ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">AI Commentary:</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px; border-left: 3px solid var(--accent-cyan); white-space: pre-wrap;">${a.ai_commentary}</div>
                                </div>
                            ` : ''}
                            
                            <button class="btn btn-primary btn-block" onclick="document.getElementById('history-detail-modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (e) {
                showToast('Error loading analysis: ' + e.message, 'error');
            }
        }
        
        async function deleteHistoryItem(analysisId) {
            if (!confirm('Delete this analysis from history?')) return;
            if (!currentUser || !db) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('analyses').doc(analysisId).delete();
                showToast('Analysis deleted', 'success');
                loadHistory();
            } catch (e) {
                showToast('Error deleting: ' + e.message, 'error');
            }
        }
        
        async function cancelTrade(tradeId) {
            if (!confirm('Cancel this trade? It will be removed from your journal.')) return;
            
            try {
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).delete();
                    console.log('Trade cancelled:', tradeId);
                } else {
                    // API fallback would go here
                    console.log('Not logged in - cannot cancel');
                }
                loadTrades();
            } catch (e) {
                console.error('Cancel trade error:', e);
                alert('Error cancelling trade');
            }
        }
        
        async function closeTrade(tradeId, result) {
            try {
                if (currentUser && db) {
                    // Get the trade to calculate PnL
                    const tradeDoc = await db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).get();
                    const trade = tradeDoc.data();
                    
                    // Simple PnL calculation based on result
                    const pnl = result === 'win' ? Math.abs(trade.target - trade.entry) : -Math.abs(trade.entry - trade.stop);
                    
                    await db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).update({
                        status: 'closed',
                        pnl: pnl,
                        result: result,
                        closed_at: new Date().toISOString()
                    });
                } else {
                    await fetch(`${API_BASE}/api/trades`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: tradeId, status: 'closed' })
                    });
                }
                loadTrades();
            } catch (e) {
                console.error('Close trade error:', e);
                alert('Error closing trade');
            }
        }
        
        async function updateTrade(symbol, status) {
            try {
                await fetch(`${API_BASE}/api/trades`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, status })
                });
                loadTrades();
            } catch (e) {
                alert('Error updating trade');
            }
        }

        // =====================================================================
        // SETTINGS
        // =====================================================================
        
        async function setFinnhubKey() {
            const key = document.getElementById('finnhub-key').value.trim();
            if (!key) return;
            
            try {
                await fetch(`${API_BASE}/api/set-key?key=${encodeURIComponent(key)}`, { method: 'POST' });
                alert('Finnhub key set successfully');
                checkStatus();
            } catch (e) {
                alert('Error setting key');
            }
        }
        
        async function setOpenAIKey() {
            const key = document.getElementById('openai-key').value.trim();
            if (!key) return;
            
            try {
                await fetch(`${API_BASE}/api/set-openai-key?api_key=${encodeURIComponent(key)}`, { method: 'POST' });
                alert('OpenAI key set successfully');
                checkStatus();
            } catch (e) {
                alert('Error setting key');
            }
        }

        // =====================================================================
        // SOCIAL TRADING - Share Trades with Other Users
        // =====================================================================
        
        async function shareTrade() {
            if (!currentUser) {
                alert('Please sign in to share trades');
                return;
            }
            
            const plan = window.lastAIPlan;
            if (!plan || !plan.parsed) {
                alert('No trade plan to share');
                return;
            }
            
            const sharedTrade = {
                symbol: plan.symbol || document.getElementById('quick-symbol')?.value || 'UNKNOWN',
                bias: plan.parsed.bias,
                entry: plan.parsed.entry,
                stop: plan.parsed.stop,
                target1: plan.parsed.target1 || 0,
                target2: plan.parsed.target2 || 0,
                timeframe: plan.trade_timeframe || 'swing',
                commentary: plan.ai_commentary?.substring(0, 500) || '',
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours
            };
            
            try {
                await db.collection('shared_trades').add(sharedTrade);
                showToast(`Trade shared with community! ${sharedTrade.symbol} ${sharedTrade.bias}`, 'success');
            } catch (e) {
                console.error('Share error:', e);
                showToast('Error sharing trade: ' + e.message, 'error');
            }
        }
        
        async function shareAlert(symbol, level, direction, action, note) {
            if (!currentUser) {
                alert('Please sign in to share trades');
                return;
            }
            
            // Determine bias from action
            let bias = 'LONG';
            if (action === 'SHORT') bias = 'SHORT';
            else if (action === 'LONG') bias = 'LONG';
            else if (action === 'EXIT') bias = 'EXIT';
            else bias = 'ALERT';
            
            const sharedTrade = {
                symbol: symbol,
                bias: bias,
                entry: level,
                stop: 0,
                target1: 0,
                target2: 0,
                timeframe: 'alert',
                commentary: `${direction === 'above' ? '⬆️ Above' : '⬇️ Below'} $${level.toFixed(2)} - ${action}${note ? ': ' + note : ''}`,
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours
            };
            
            try {
                await db.collection('shared_trades').add(sharedTrade);
                showToast(`Alert shared! ${symbol} ${bias} @ $${level.toFixed(2)}`, 'success');
            } catch (e) {
                console.error('Share error:', e);
                showToast('Error sharing: ' + e.message, 'error');
            }
        }
        
        async function loadSharedTrades() {
            if (!currentUser || !db) return [];
            
            try {
                const snapshot = await db.collection('shared_trades')
                    .where('expiresAt', '>', new Date())
                    .orderBy('expiresAt', 'desc')
                    .limit(20)
                    .get();
                
                const trades = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Don't show user's own trades
                    if (data.authorId !== currentUser.uid) {
                        trades.push({ id: doc.id, ...data });
                    }
                });
                
                return trades;
            } catch (e) {
                console.error('Load shared trades error:', e);
                return [];
            }
        }
        
        async function updateSharedTradesBadge() {
            if (!currentUser) return;
            
            const trades = await loadSharedTrades();
            const badge = document.getElementById('shared-trades-count');
            
            if (trades.length > 0) {
                badge.textContent = trades.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        async function showSharedTrades() {
            if (!currentUser) {
                alert('Please sign in to view shared trades');
                return;
            }
            
            const trades = await loadSharedTrades();
            
            const tradeRows = trades.length === 0 
                ? '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">No shared trades available right now</div>'
                : trades.map(t => `
                    <div class="shared-trade-card" style="background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">${t.symbol}</span>
                                <span class="signal ${t.bias === 'LONG' ? 'signal-long' : 'signal-short'}" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                    ${t.bias === 'LONG' ? '🟢 LONG' : '🔴 SHORT'}
                                </span>
                            </div>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">by ${t.authorName}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; font-size: 0.8rem;">
                            <div><span style="color: var(--text-muted);">Entry:</span> <span style="color: var(--accent-cyan);">$${t.entry?.toFixed(2) || 'N/A'}</span></div>
                            <div><span style="color: var(--text-muted);">Stop:</span> <span style="color: var(--accent-red);">$${t.stop?.toFixed(2) || 'N/A'}</span></div>
                            <div><span style="color: var(--text-muted);">Target:</span> <span style="color: var(--accent-green);">$${t.target1?.toFixed(2) || 'N/A'}</span></div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" style="background: var(--accent-green); color: var(--bg-primary); font-size: 0.75rem; padding: 0.4rem 0.75rem;" onclick="addSharedTrade('${t.id}', '${t.symbol}', '${t.bias}', ${t.entry}, ${t.stop}, ${t.target1})">
                                ➕ Add to My Trades
                            </button>
                            <button class="btn btn-sm" style="background: var(--bg-tertiary); color: var(--text-secondary); font-size: 0.75rem; padding: 0.4rem 0.75rem;" onclick="quickAnalyzeSymbol('${t.symbol}')">
                                📊 Analyze
                            </button>
                        </div>
                    </div>
                `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'shared-trades-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>🔔 Shared Trade Ideas</h3>
                        <button class="modal-close" onclick="closeModal('shared-trades-modal')">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Trade ideas shared by other users in the last 24 hours</div>
                        ${tradeRows}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal('shared-trades-modal');
            });
        }
        
        async function addSharedTrade(tradeId, symbol, bias, entry, stop, target) {
            if (!currentUser || !db) return;
            
            const trade = {
                symbol,
                direction: bias,
                entry,
                stop,
                target,
                status: 'pending',
                source: 'shared',
                createdAt: new Date().toISOString()
            };
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('trades').add(trade);
                showToast(`Added ${symbol} ${bias} to your trades!`, 'success');
                closeModal('shared-trades-modal');
                updateSharedTradesBadge();
            } catch (e) {
                showToast('Error adding trade: ' + e.message, 'error');
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        // =====================================================================
        // INIT
        // =====================================================================
        
        checkStatus();
        setInterval(checkStatus, 30000);
        
        // Handle ?tab= URL parameter (e.g. from Trade Desk links)
        const urlTab = new URLSearchParams(window.location.search).get('tab');
        if (urlTab) showSection(urlTab);
        
        // Check for shared trades every 2 minutes
        setInterval(updateSharedTradesBadge, 120000);
    </script>

    <!-- Create Challenge Modal -->
    <div id="create-challenge-modal" class="modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:var(--bg-card); border:1px solid var(--border-default); border-radius:12px; padding:1.5rem; width:90%; max-width:420px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; font-size:1rem; color:var(--text-primary);">🏁 Create Challenge</h3>
                <button class="modal-close" onclick="closeModal('create-challenge-modal')" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;">✕</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                <div><label style="font-size:0.75rem; color:var(--text-muted);">Challenge Name</label><input id="challenge-name" type="text" placeholder="e.g. February R-Sprint" style="width:100%; padding:0.5rem; background:var(--bg-tertiary); border:1px solid var(--border-default); border-radius:6px; color:var(--text-primary);"></div>
                <div><label style="font-size:0.75rem; color:var(--text-muted);">Type</label><select id="challenge-type" style="width:100%; padding:0.5rem; background:var(--bg-tertiary); border:1px solid var(--border-default); border-radius:6px; color:var(--text-primary);"><option value="r-multiple">R-Multiple</option><option value="percentage">Percentage %</option><option value="win-streak">Win Streak</option><option value="profit">Profit $</option></select></div>
                <div><label style="font-size:0.75rem; color:var(--text-muted);">Target</label><input id="challenge-target" type="number" value="10" step="1" style="width:100%; padding:0.5rem; background:var(--bg-tertiary); border:1px solid var(--border-default); border-radius:6px; color:var(--text-primary);"></div>
                <div><label style="font-size:0.75rem; color:var(--text-muted);">Duration (days)</label><select id="challenge-duration" style="width:100%; padding:0.5rem; background:var(--bg-tertiary); border:1px solid var(--border-default); border-radius:6px; color:var(--text-primary);"><option value="7">7 days</option><option value="14">14 days</option><option value="30" selected>30 days</option><option value="90">90 days</option></select></div>
                <div><label style="font-size:0.75rem; color:var(--text-muted);">Buy-in</label><input id="challenge-buyin" type="text" placeholder="Bragging rights" style="width:100%; padding:0.5rem; background:var(--bg-tertiary); border:1px solid var(--border-default); border-radius:6px; color:var(--text-primary);"></div>
                <button class="btn" style="background:var(--accent-green); color:var(--bg-primary); margin-top:0.5rem;" onclick="createChallenge()">Create Challenge</button>
            </div>
        </div>
    </div>

    <!-- Join Challenge Modal -->
    <div id="join-challenge-modal" class="modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:var(--bg-card); border:1px solid var(--border-default); border-radius:12px; padding:1.5rem; width:90%; max-width:360px;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin:0; font-size:1rem; color:var(--text-primary);">🎮 Join Challenge</h3>
                <button class="modal-close" onclick="closeModal('join-challenge-modal')" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;">✕</button>
            </div>
            <div style="display:flex; flex-direction:column; gap:0.75rem;">
                <div><label style="font-size:0.75rem; color:var(--text-muted);">Challenge Code</label><input id="join-challenge-code" type="text" maxlength="6" placeholder="e.g. A3B2C7" style="width:100%; padding:0.5rem; background:var(--bg-tertiary); border:1px solid var(--border-default); border-radius:6px; color:var(--text-primary); text-transform:uppercase; letter-spacing:2px; font-size:1.1rem; text-align:center;"></div>
                <button class="btn" style="background:var(--accent-cyan); color:var(--bg-primary); margin-top:0.5rem;" onclick="joinChallenge()">Join Challenge</button>
            </div>
        </div>
    </div>
</body>
</html>
