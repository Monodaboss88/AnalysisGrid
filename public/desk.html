<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Decision Point ‚Äî Trade Desk</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #06090f;
    --bg-card: #0c1220;
    --bg-card-hover: #111b2e;
    --bg-input: #141f33;
    --border: #1a2640;
    --border-hover: #2a3a5a;
    --text: #e2e8f0;
    --text-secondary: #8892a8;
    --text-muted: #4a5568;
    --green: #10b981;
    --green-dim: rgba(16, 185, 129, 0.08);
    --green-glow: rgba(16, 185, 129, 0.25);
    --red: #ef4444;
    --red-dim: rgba(239, 68, 68, 0.08);
    --blue: #3b82f6;
    --blue-dim: rgba(59, 130, 246, 0.08);
    --blue-glow: rgba(59, 130, 246, 0.2);
    --amber: #f59e0b;
    --amber-dim: rgba(245, 158, 11, 0.08);
    --purple: #8b5cf6;
    --purple-dim: rgba(139, 92, 246, 0.08);
    --cyan: #06b6d4;
    --cyan-dim: rgba(6, 182, 212, 0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Outfit', sans-serif;
    background: 
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1400' height='800' viewBox='0 0 1400 800'%3E%3Crect width='1400' height='800' fill='%230f172a'/%3E%3Cdefs%3E%3ClinearGradient id='glow' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%2300d4ff' stop-opacity='0.25'/%3E%3Cstop offset='100%25' stop-color='%2300d4ff' stop-opacity='0'/%3E%3C/linearGradient%3E%3ClinearGradient id='fade' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%230a1628' stop-opacity='0.6'/%3E%3Cstop offset='15%25' stop-color='%230a1628' stop-opacity='0'/%3E%3Cstop offset='85%25' stop-color='%230a1628' stop-opacity='0'/%3E%3Cstop offset='100%25' stop-color='%230a1628' stop-opacity='0.9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cg stroke='%231e293b' stroke-width='0.5' opacity='0.6'%3E%3Cline x1='0' y1='160' x2='1400' y2='160'/%3E%3Cline x1='0' y1='300' x2='1400' y2='300'/%3E%3Cline x1='0' y1='440' x2='1400' y2='440'/%3E%3Cline x1='0' y1='580' x2='1400' y2='580'/%3E%3Cline x1='200' y1='80' x2='200' y2='720'/%3E%3Cline x1='400' y1='80' x2='400' y2='720'/%3E%3Cline x1='600' y1='80' x2='600' y2='720'/%3E%3Cline x1='800' y1='80' x2='800' y2='720'/%3E%3Cline x1='1000' y1='80' x2='1000' y2='720'/%3E%3Cline x1='1200' y1='80' x2='1200' y2='720'/%3E%3C/g%3E%3Cpath d='M0 650 Q70 640,140 620 T280 580 T380 560 T450 530 T520 550 T600 520 T680 480 T750 440 T820 460 T900 420 T980 380 T1050 340 T1120 360 T1200 310 T1280 260 T1350 220 L1400 200 L1400 800 L0 800 Z' fill='url(%23glow)' opacity='0.4'/%3E%3Cpath d='M0 650 Q70 640,140 620 T280 580 T380 560 T450 530 T520 550 T600 520 T680 480 T750 440 T820 460 T900 420 T980 380 T1050 340 T1120 360 T1200 310 T1280 260 T1350 220 L1400 200' fill='none' stroke='%2300d4ff' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M0 660 Q100 650,200 630 T400 580 T600 540 T800 470 T1000 400 T1200 340 T1400 250' fill='none' stroke='%23f59e0b' stroke-width='1.5' stroke-dasharray='8 4' opacity='0.5'/%3E%3Ccircle cx='520' cy='550' r='3' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='820' cy='460' r='3' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='1120' cy='360' r='3' fill='%23ef4444' opacity='0.7'/%3E%3Ccircle cx='1400' cy='200' r='4' fill='%2300d4ff' opacity='0.9'/%3E%3Ctext x='1370' y='195' fill='%2300d4ff' font-size='11' font-family='monospace' opacity='0.5'%3E$485%3C/text%3E%3Ctext x='15' y='655' fill='%23475569' font-size='10' font-family='monospace' opacity='0.4'%3E$420%3C/text%3E%3Crect width='1400' height='800' fill='url(%23fade)'/%3E%3C/svg%3E"),
        linear-gradient(135deg, #0a1628 0%, #0f1d32 100%);
    background-size: 100% auto, 100% 100%;
    background-position: center top, center center;
    background-repeat: no-repeat, no-repeat;
    background-attachment: fixed, fixed;
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
}

/* ===== HEADER ===== */
.header {
    position: relative;
    z-index: 10;
    padding: 40px 48px 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.brand {
    display: flex;
    align-items: center;
    gap: 16px;
}

.brand-logo {
    position: relative;
    width: 54px;
    height: 54px;
    background: linear-gradient(135deg, #1e3a5f, #0c2340);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    color: #5ebbff;
    letter-spacing: 2px;
    box-shadow: 0 0 35px rgba(59, 130, 246, 0.15), inset 0 1px 0 rgba(255,255,255,0.06);
    border: 1px solid rgba(59, 130, 246, 0.2);
    overflow: hidden;
}

.brand-logo::before {
    content: '';
    position: absolute;
    top: -1px;
    left: -1px;
    right: -1px;
    bottom: -1px;
    border-radius: 14px;
    background: linear-gradient(135deg, rgba(59,130,246,0.3), transparent 60%);
    z-index: 0;
}

.brand-logo::after {
    content: '';
    position: absolute;
    width: 120%;
    height: 120%;
    background: conic-gradient(from 0deg, transparent 0%, rgba(6,182,212,0.15) 10%, transparent 20%);
    animation: logoSpin 8s linear infinite;
    z-index: 0;
}

.brand-logo span {
    position: relative;
    z-index: 1;
}

@keyframes logoSpin {
    to { transform: rotate(360deg); }
}

@keyframes logoPulse {
    0%, 100% { box-shadow: 0 0 35px rgba(59,130,246,0.15), inset 0 1px 0 rgba(255,255,255,0.06); }
    50% { box-shadow: 0 0 45px rgba(59,130,246,0.25), inset 0 1px 0 rgba(255,255,255,0.08); }
}

.brand-logo {
    animation: logoPulse 4s ease-in-out infinite;
}

.brand-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.brand-text .greeting {
    font-size: 11px;
    font-weight: 500;
    color: var(--cyan);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    opacity: 0.7;
}

.brand-text h1 {
    font-family: 'Outfit', sans-serif;
    font-size: 26px;
    font-weight: 800;
    letter-spacing: -0.3px;
    background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    line-height: 1.1;
}

.brand-text .subtitle-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 1px;
}

.brand-text .subtitle-row p {
    font-size: 12px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
}

.brand-text .subtitle-row .divider-dot {
    width: 3px;
    height: 3px;
    border-radius: 50%;
    background: var(--text-muted);
    opacity: 0.5;
}

.brand-text .subtitle-row .desk-date {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    opacity: 0.7;
}

.signal-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
}

.signal-bar .pulse-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    animation: signalPulse 2s ease-in-out infinite;
}

@keyframes signalPulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--green-glow); }
    50% { opacity: 0.4; box-shadow: none; }
}

.signal-bar .signal-text {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.5px;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.market-clock {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.market-clock .time {
    font-size: 20px;
    color: var(--text);
    font-weight: 500;
}

.market-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}

.status-dot.open { background: var(--green); box-shadow: 0 0 8px var(--green-glow); }
.status-dot.closed { background: var(--red); box-shadow: none; animation: none; }
.status-dot.pre { background: var(--amber); box-shadow: 0 0 8px rgba(245, 158, 11, 0.3); }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* ===== QUICK STATS BAR ===== */
.quick-stats {
    position: relative;
    z-index: 10;
    padding: 0 48px;
    margin-bottom: 10px;
}

.stats-strip {
    display: flex;
    gap: 24px;
    padding: 14px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow-x: auto;
}

.stat-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.stat-chip .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
}

.stat-chip .val {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
}

.stat-chip .divider {
    width: 1px;
    height: 20px;
    background: var(--border);
}

/* ===== MAIN CONTENT ===== */
.main {
    position: relative;
    z-index: 10;
    flex: 1;
    padding: 24px 48px 48px;
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.section-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-muted);
    font-weight: 500;
}

/* ===== MODULE CARDS ===== */
.modules-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}

.module-card {
    position: relative;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px 24px;
    cursor: pointer;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 260px;
    text-decoration: none;
    color: inherit;
}

.module-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    opacity: 0;
    transition: opacity 0.35s ease;
}

.module-card:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-hover);
    transform: translateY(-4px);
    box-shadow: 0 20px 60px -15px rgba(0, 0, 0, 0.5);
}

.module-card:hover::before { opacity: 1; }

/* Card accent colors */
.module-card.scanner::before { background: linear-gradient(90deg, var(--blue), var(--cyan)); }
.module-card.scanner:hover { box-shadow: 0 20px 60px -15px rgba(59, 130, 246, 0.15); }

.module-card.trades::before { background: linear-gradient(90deg, var(--green), #34d399); }
.module-card.trades:hover { box-shadow: 0 20px 60px -15px rgba(16, 185, 129, 0.15); }

.module-card.capital::before { background: linear-gradient(90deg, var(--purple), #a78bfa); }
.module-card.capital:hover { box-shadow: 0 20px 60px -15px rgba(139, 92, 246, 0.15); }

.module-card.season::before { background: linear-gradient(90deg, var(--amber), #fbbf24); }
.module-card.season:hover { box-shadow: 0 20px 60px -15px rgba(245, 158, 11, 0.15); }

.module-card.research::before { background: linear-gradient(90deg, #f472b6, #fb923c); }
.module-card.research:hover { box-shadow: 0 20px 60px -15px rgba(244, 114, 182, 0.15); }

.module-card.sustainability::before { background: linear-gradient(90deg, #10b981, #06b6d4); }
.module-card.sustainability:hover { box-shadow: 0 20px 60px -15px rgba(16, 185, 129, 0.15); }

.module-card.charts::before { background: linear-gradient(90deg, var(--cyan), #22d3ee); }
.module-card.charts:hover { box-shadow: 0 20px 60px -15px rgba(6, 182, 212, 0.15); }

.module-card.deep::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
.module-card.deep:hover { box-shadow: 0 20px 60px -15px rgba(99, 102, 241, 0.15); }

.module-card.catalyst::before { background: linear-gradient(90deg, #f97316, #ef4444); }
.module-card.catalyst:hover { box-shadow: 0 20px 60px -15px rgba(249, 115, 22, 0.15); }

.module-card.buffett::before { background: linear-gradient(90deg, #dc2626, #f59e0b); }
.module-card.buffett:hover { box-shadow: 0 20px 60px -15px rgba(220, 38, 38, 0.15); }

.module-card.optflow::before { background: linear-gradient(90deg, #06b6d4, #a855f7); }
.module-card.optflow:hover { box-shadow: 0 20px 60px -15px rgba(6, 182, 212, 0.15); }

.module-card.warroom::before { background: linear-gradient(90deg, #ef4444, #f97316); }
.module-card.warroom:hover { box-shadow: 0 20px 60px -15px rgba(239, 68, 68, 0.15); }

.module-card.cards::before { background: linear-gradient(90deg, #00e676, #448aff); }
.module-card.cards:hover { box-shadow: 0 20px 60px -15px rgba(0, 230, 118, 0.15); }
.cards .module-icon { background: rgba(0,230,118,0.08); }
.cards .meta-pill { background: rgba(0,230,118,0.08); color: #00e676; }

/* Card icon */
.module-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    margin-bottom: 20px;
}

.scanner .module-icon { background: var(--blue-dim); }
.deep .module-icon { background: rgba(99, 102, 241, 0.08); }
.trades .module-icon { background: var(--green-dim); }
.capital .module-icon { background: var(--purple-dim); }
.charts .module-icon { background: var(--cyan-dim); }
.season .module-icon { background: var(--amber-dim); }
.research .module-icon { background: rgba(244, 114, 182, 0.08); }
.sustainability .module-icon { background: rgba(16, 185, 129, 0.08); }
.catalyst .module-icon { background: rgba(249, 115, 22, 0.08); }
.warroom .module-icon { background: rgba(239, 68, 68, 0.08); }

.module-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    letter-spacing: 0.3px;
}

.module-desc {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
    flex: 1;
}

.module-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 20px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
}

.module-meta {
    display: flex;
    gap: 8px;
}

.meta-pill {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    letter-spacing: 0.3px;
}

.scanner .meta-pill { background: var(--blue-dim); color: var(--blue); }
.deep .meta-pill { background: rgba(99, 102, 241, 0.08); color: #818cf8; }
.trades .meta-pill { background: var(--green-dim); color: var(--green); }
.capital .meta-pill { background: var(--purple-dim); color: var(--purple); }
.charts .meta-pill { background: var(--cyan-dim); color: var(--cyan); }
.season .meta-pill { background: var(--amber-dim); color: var(--amber); }
.catalyst .meta-pill { background: rgba(249, 115, 22, 0.08); color: #f97316; }

.module-arrow {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--text-muted);
    transition: all 0.3s ease;
}

.module-card:hover .module-arrow {
    border-color: var(--text-secondary);
    color: var(--text);
    transform: translateX(2px);
}

/* ===== BOTTOM ROW ===== */
.bottom-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.info-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
}

.info-card .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    font-weight: 500;
}

/* Today's Checklist */
.checklist-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    background: var(--bg-input);
    cursor: pointer;
    transition: background 0.2s;
    font-size: 13px;
    color: var(--text-secondary);
}

.check-item:hover { background: rgba(30, 42, 66, 0.8); }

.check-box {
    width: 18px;
    height: 18px;
    border-radius: 5px;
    border: 1.5px solid var(--border-hover);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
    font-size: 10px;
    color: transparent;
}

.check-item.done .check-box {
    background: var(--green);
    border-color: var(--green);
    color: white;
}

.check-item.done {
    color: var(--text-muted);
    text-decoration: line-through;
}

/* Session Notes */
.session-notes {
    width: 100%;
    height: 110px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    padding: 12px 14px;
    resize: none;
    outline: none;
    line-height: 1.6;
    transition: border-color 0.2s;
}

.session-notes:focus { border-color: var(--blue); }
.session-notes::placeholder { color: var(--text-muted); }

.note-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-muted);
}

.note-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}

.note-header-row .card-header { margin-bottom: 0; }

.note-actions {
    display: flex;
    gap: 6px;
}

.note-btn {
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Outfit', sans-serif;
}

.note-btn:hover { background: var(--bg-card-hover); border-color: var(--border-hover); color: var(--text); }
.note-btn.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }

/* Notes Search Overlay */
.notes-search-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.notes-search-overlay.open { display: flex; }

.notes-search-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 560px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.notes-search-header {
    padding: 20px 24px 12px;
    border-bottom: 1px solid var(--border);
}

.notes-search-header h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 16px;
    margin-bottom: 12px;
    color: var(--text);
}

.notes-search-input {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
}

.notes-search-input:focus { border-color: var(--blue); }
.notes-search-input::placeholder { color: var(--text-muted); }

.notes-search-results {
    flex: 1;
    overflow-y: auto;
    padding: 12px 24px 20px;
    max-height: 55vh;
}

.note-result-item {
    padding: 12px 16px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.note-result-item:hover { background: var(--bg-card-hover); border-color: var(--border-hover); }

.note-result-date {
    font-size: 11px;
    color: var(--cyan);
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.note-result-text {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
    white-space: pre-wrap;
    max-height: 60px;
    overflow: hidden;
}

.note-result-text mark {
    background: var(--amber-dim);
    color: var(--amber);
    padding: 0 2px;
    border-radius: 2px;
}

.notes-search-empty {
    text-align: center;
    padding: 32px;
    color: var(--text-muted);
    font-size: 13px;
}

.notes-search-close {
    position: absolute;
    top: 16px;
    right: 20px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
}

.notes-search-close:hover { color: var(--text); }

/* Quick Filter Tabs in Search */
.search-filter-tabs {
    display: flex;
    gap: 4px;
    margin-top: 10px;
}
.search-filter-tab {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
}
.search-filter-tab:hover { color: var(--text-secondary); border-color: var(--border-hover); }
.search-filter-tab.active { background: var(--blue-dim); color: var(--blue); border-color: var(--blue); }

/* ===== EQUITY CURVE ===== */
.equity-section {
    position: relative;
    z-index: 10;
    padding: 0 48px;
    margin-bottom: 4px;
}
.equity-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
}
.equity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.equity-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}
.equity-total {
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    font-weight: 600;
}
.period-filters {
    display: flex;
    gap: 4px;
    background: var(--bg-input);
    border-radius: 8px;
    padding: 3px;
}
.period-btn {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
}
.period-btn:hover { color: var(--text-secondary); }
.period-btn.active {
    background: var(--blue-dim);
    color: var(--blue);
}
.equity-canvas-wrap {
    position: relative;
    width: 100%;
    height: 160px;
}
.equity-canvas-wrap canvas {
    width: 100%;
    height: 100%;
}

/* Week Lookback Notes */
.week-notes-inline {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 8px;
    display: none;
}
.week-notes-inline.open { display: block; }
.week-note-entry {
    padding: 8px 12px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s;
}
.week-note-entry:hover { background: var(--bg-card-hover); border-color: var(--border-hover); }
.week-note-date {
    font-size: 10px;
    color: var(--cyan);
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 3px;
}
.week-note-preview {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.4;
    white-space: pre-wrap;
    max-height: 40px;
    overflow: hidden;
}

/* ===== KEYBOARD SHORTCUTS ===== */
.shortcuts {
    position: relative;
    z-index: 10;
    padding: 0 48px 32px;
    display: flex;
    gap: 16px;
    justify-content: center;
}

.shortcut {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text-muted);
}

.shortcut kbd {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 6px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text-secondary);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1100px) {
    .modules-grid { grid-template-columns: repeat(2, 1fr); }
    .header, .quick-stats, .main, .shortcuts { padding-left: 24px; padding-right: 24px; }
}

@media (max-width: 700px) {
    .modules-grid { grid-template-columns: 1fr; }
    .bottom-row { grid-template-columns: 1fr; }
    .header { flex-direction: column; gap: 16px; }
    .stats-strip { flex-wrap: wrap; }
    .shortcuts { flex-wrap: wrap; }
    .indices-bar { gap: 1rem; }
    .index-item { flex: 1 1 45%; justify-content: center; }
}

/* Market Indices Bar */
.indices-bar {
    display: flex;
    justify-content: center;
    gap: 2rem;
    padding: 10px 16px;
    background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(51,65,85,0.4) 100%);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.index-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.index-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.index-price {
    font-family: 'Space Grotesk', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
}

.index-change {
    font-family: 'Space Grotesk', monospace;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
}

.index-change.positive {
    background: var(--green-dim);
    color: var(--green);
}

.index-change.negative {
    background: var(--red-dim);
    color: var(--red);
}

.index-change.neutral {
    background: rgba(255,255,255,0.05);
    color: var(--text-muted);
}

/* AI Kill Switch */
.kill-switch-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    border: 1px solid rgba(255,255,255,0.08);
}
.kill-switch-wrap.ai-on {
    background: rgba(0,200,120,0.08);
    border-color: rgba(0,200,120,0.2);
}
.kill-switch-wrap.ai-off {
    background: rgba(255,60,60,0.12);
    border-color: rgba(255,60,60,0.3);
    animation: killPulse 2s ease-in-out infinite;
}
@keyframes killPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,60,60,0); }
    50% { box-shadow: 0 0 12px 2px rgba(255,60,60,0.25); }
}
.kill-switch-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}
.kill-switch-wrap.ai-on .kill-switch-label { color: var(--green); }
.kill-switch-wrap.ai-off .kill-switch-label { color: var(--red); }
.kill-switch-toggle {
    position: relative;
    width: 40px;
    height: 22px;
    border-radius: 11px;
    transition: background 0.3s;
}
.kill-switch-wrap.ai-on .kill-switch-toggle { background: var(--green); }
.kill-switch-wrap.ai-off .kill-switch-toggle { background: var(--red); }
.kill-switch-toggle::after {
    content: '';
    position: absolute;
    top: 3px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: white;
    transition: left 0.3s;
}
.kill-switch-wrap.ai-on .kill-switch-toggle::after { left: 21px; }
.kill-switch-wrap.ai-off .kill-switch-toggle::after { left: 3px; }
.kill-switch-icon {
    font-size: 16px;
    line-height: 1;
}
.kill-switch-status {
    font-size: 9px;
    color: var(--text-muted);
    margin-top: 1px;
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="brand">
        <div class="brand-logo"><span>DP</span></div>
        <div class="brand-text">
            <div class="greeting" id="desk-greeting">Good Morning</div>
            <h1>Trade Desk</h1>
            <div class="subtitle-row">
                <p>Decision Point</p>
                <div class="divider-dot"></div>
                <span class="desk-date" id="desk-date">‚Äî</span>
            </div>
            <div class="signal-bar">
                <div class="pulse-dot"></div>
                <span class="signal-text">DECISION POINT ACTIVE</span>
            </div>
        </div>
    </div>
    <div class="header-right">
        <div class="kill-switch-wrap ai-on" id="kill-switch" onclick="toggleKillSwitch()" title="AI Kill Switch ‚Äî Click to toggle">
            <span class="kill-switch-icon" id="kill-switch-icon">ü§ñ</span>
            <div>
                <div class="kill-switch-label" id="kill-switch-label">AI ON</div>
                <div class="kill-switch-status" id="kill-switch-status">Claude + GPT</div>
            </div>
            <div class="kill-switch-toggle"></div>
        </div>
        <div class="market-clock">
            <div class="time" id="clock-time">--:--:--</div>
            <div class="market-status">
                <div class="status-dot" id="status-dot"></div>
                <span id="market-status-text">‚Äî</span>
            </div>
        </div>
    </div>
</div>

<!-- MARKET INDICES -->
<div class="indices-bar" id="indices-bar">
    <div class="index-item">
        <span class="index-label">SPY</span>
        <span class="index-price" id="spy-price">---</span>
        <span class="index-change neutral" id="spy-change">--</span>
    </div>
    <div class="index-item">
        <span class="index-label">QQQ</span>
        <span class="index-price" id="qqq-price">---</span>
        <span class="index-change neutral" id="qqq-change">--</span>
    </div>
    <div class="index-item">
        <span class="index-label">DIA</span>
        <span class="index-price" id="dia-price">---</span>
        <span class="index-change neutral" id="dia-change">--</span>
    </div>
    <div class="index-item">
        <span class="index-label">IWM</span>
        <span class="index-price" id="iwm-price">---</span>
        <span class="index-change neutral" id="iwm-change">--</span>
    </div>
</div>

<!-- QUICK STATS -->
<div class="quick-stats">
    <div class="stats-strip" id="quick-stats-strip">
        <div class="stat-chip" style="position:relative;">
            <span class="label">Today's P&L <span id="pnl-toggle" onclick="togglePnlVisibility(event)" style="cursor:pointer;opacity:0.5;font-size:0.7rem;" title="Hide/Show P&L">üëÅ</span></span>
            <span class="val" id="qs-today-pnl" style="color:var(--text-muted);">‚Äî</span>
        </div>
        <div class="stat-chip"><div class="divider"></div></div>
        <div class="stat-chip">
            <span class="label">Week</span>
            <span class="val" id="qs-week-pnl" style="color:var(--text-muted);">‚Äî</span>
        </div>
        <div class="stat-chip"><div class="divider"></div></div>
        <div class="stat-chip">
            <span class="label">Month</span>
            <span class="val" id="qs-month-pnl" style="color:var(--text-muted);">‚Äî</span>
        </div>
        <div class="stat-chip"><div class="divider"></div></div>
        <div class="stat-chip">
            <span class="label">Win Rate</span>
            <span class="val" id="qs-winrate" style="color:var(--text-muted);">‚Äî</span>
        </div>
        <div class="stat-chip"><div class="divider"></div></div>
        <div class="stat-chip">
            <span class="label">Streak</span>
            <span class="val" id="qs-streak" style="color:var(--text-muted);">‚Äî</span>
        </div>
        <div class="stat-chip"><div class="divider"></div></div>
        <div class="stat-chip">
            <span class="label">Goal Pace</span>
            <span class="val" id="qs-pace" style="color:var(--text-muted);">‚Äî</span>
        </div>
    </div>
</div>

<!-- EQUITY CURVE -->
<div class="equity-section" id="equity-section" style="display:none;">
    <div class="equity-card">
        <div class="equity-header">
            <div class="equity-title">
                üìà Equity Curve
                <span class="equity-total" id="equity-total"></span>
            </div>
            <div class="period-filters">
                <button class="period-btn active" onclick="setEquityPeriod('daily',this)">D</button>
                <button class="period-btn" onclick="setEquityPeriod('weekly',this)">W</button>
                <button class="period-btn" onclick="setEquityPeriod('monthly',this)">M</button>
                <button class="period-btn" onclick="setEquityPeriod('quarterly',this)">Q</button>
                <button class="period-btn" onclick="setEquityPeriod('yearly',this)">Y</button>
            </div>
        </div>
        <div class="equity-canvas-wrap" id="equity-canvas-wrap">
            <canvas id="equity-canvas"></canvas>
        </div>
    </div>
</div>

<!-- MAIN -->
<div class="main">
    <div class="section-label">Modules</div>

    <!-- MODULE CARDS -->
    <div class="modules-grid">

        <!-- Quick Scanner -->
        <div class="module-card scanner" onclick="launchModule('scanner')">
            <div class="module-icon">üì°</div>
            <div class="module-title">Quick Scanner</div>
            <div class="module-desc">
                Fast signal sweep. Compression detection, RSI exhaustion, and volume profile levels across your watchlists. Get in, find setups, get out.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">13 Watchlists</span>
                    <span class="meta-pill">218 Symbols</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Deep Analysis (MTF) -->
        <div class="module-card deep" onclick="launchModule('deep')">
            <div class="module-icon">üî¨</div>
            <div class="module-title">Deep Analysis</div>
            <div class="module-desc">
                Multi-timeframe technical deep dive. Auction structure, absorption zones, 3HER exhaustion, Fibonacci confluence, and composite scoring across all dimensions.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">MTF Scan</span>
                    <span class="meta-pill">4-Dimension</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Charts (TradingView) -->
        <div class="module-card charts" onclick="launchModule('charts')">
            <div class="module-icon">üìà</div>
            <div class="module-title">Charts</div>
            <div class="module-desc">
                TradingView advanced charts. Full candlestick charting with indicators, drawing tools, and multi-timeframe views. Mark your levels and validate setups visually.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">TradingView</span>
                    <span class="meta-pill">Live Data</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Trades -->
        <div class="module-card trades" onclick="launchModule('trades')">
            <div class="module-icon">üìä</div>
            <div class="module-title">Trades</div>
            <div class="module-desc">
                Trade journal and execution log. Track entries, exits, contracts, and setups. Full P&L history with performance analytics and pattern recognition.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill" id="trades-count">0 Trades</span>
                    <span class="meta-pill" id="trades-today">Today: ‚Äî</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Capital Growth Engine -->
        <div class="module-card capital" onclick="launchModule('capital')">
            <div class="module-icon">üéØ</div>
            <div class="module-title">Capital Engine</div>
            <div class="module-desc">
                Goal-driven growth tracker. Reverse-engineer profit targets into daily requirements. Pace tracking, reality checks, and compounding math.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill" id="capital-goal">Goal: ‚Äî</span>
                    <span class="meta-pill" id="capital-pace">Pace: ‚Äî</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Seasons -->
        <div class="module-card season" onclick="launchModule('season')">
            <div class="module-icon">üèÜ</div>
            <div class="module-title">Seasons</div>
            <div class="module-desc">
                Season-based performance tracking. Create bracket seasons, set R-multiple goals, track win rates, and compete in trading challenges with other traders.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill" id="season-month">Feb</span>
                    <span class="meta-pill" id="season-quarter">Q1</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Run Sustainability -->
        <div class="module-card sustainability" onclick="launchModule('sustainability')">
            <div class="module-icon">üîã</div>
            <div class="module-title">Run Sustainability</div>
            <div class="module-desc">
                Evaluate whether a 100%+ stock run can continue. Analyzes cycle position, momentum exhaustion, volume health, and fundamental backing to score sustainability.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">Polygon + Finnhub</span>
                    <span class="meta-pill">Scoring Engine</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Research Builder -->
        <div class="module-card research" onclick="launchModule('research')">
            <div class="module-icon">‚õèÔ∏è</div>
            <div class="module-title">Research Builder</div>
            <div class="module-desc">
                Picks &amp; Shovels supply chain analysis. Map any industry's infrastructure layer, pull live fundamentals &amp; performance, and generate investor-grade visual reports.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">Finnhub + Polygon</span>
                    <span class="meta-pill" id="research-reports">Reports</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Catalyst Scanner -->
        <div class="module-card catalyst" onclick="launchModule('catalyst')">
            <div class="module-icon">‚ö°</div>
            <div class="module-title">Catalyst Scanner</div>
            <div class="module-desc">
                Volatility outlier detection. Find every significant price move using œÉ thresholds, compare volatility profiles across tickers, and surface the news catalysts behind each move.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">Polygon.io</span>
                    <span class="meta-pill">œÉ Analysis</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Buffett Blood Scanner -->
        <div class="module-card buffett" onclick="launchModule('buffett')">
            <div class="module-icon">ü©∏</div>
            <div class="module-title">Buffett Blood Scanner</div>
            <div class="module-desc">
                Value discovery engine. Find fundamentally strong companies at distressed prices ‚Äî Buffett-style fundamental scoring meets blood-in-the-streets crash detection.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">Fundamentals</span>
                    <span class="meta-pill">Value Model</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Options Flow Scanner -->
        <div class="module-card optflow" onclick="launchModule('optflow')">
            <div class="module-icon">üì°</div>
            <div class="module-title">Options Flow Scanner</div>
            <div class="module-desc">
                Real-time options flow analysis. Greeks, IV, unusual volume, OI walls, max pain, expected move ‚Äî powered by Polygon Options API.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">Polygon.io</span>
                    <span class="meta-pill">Greeks ¬∑ IV ¬∑ Flow</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- War Room -->
        <div class="module-card warroom" onclick="launchModule('warroom')">
            <div class="module-icon">‚öîÔ∏è</div>
            <div class="module-title">Daily War Room</div>
            <div class="module-desc">
                Pre-market extension DNA. 30-60 day intraday analysis ‚Äî exhaustion thresholds, volume profiles, regime detection, and multi-ticker correlation.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">Polygon.io</span>
                    <span class="meta-pill">Fade ¬∑ Extension ¬∑ DNA</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Trading Cards -->
        <div class="module-card cards" onclick="launchModule('cards')">
            <div class="module-icon">üÉè</div>
            <div class="module-title">Trading Cards</div>
            <div class="module-desc">
                Unified Execution + Thesis cards. All 7 scanners consolidated into two visual cards ‚Äî entry zones, price ladder, consensus votes, risk parameters, and AI reasoning.
            </div>
            <div class="module-footer">
                <div class="module-meta">
                    <span class="meta-pill">7 Scanners</span>
                    <span class="meta-pill">Exec ¬∑ Thesis</span>
                </div>
                <div class="module-arrow">‚Üí</div>
            </div>
        </div>
    </div>

    <!-- BOTTOM ROW -->
    <div class="bottom-row">

        <!-- Pre-Market Checklist -->
        <div class="info-card">
            <div class="card-header">‚úÖ Pre-Market Checklist</div>
            <div class="checklist-items" id="checklist">
                <div class="check-item" onclick="toggleCheck(this)" data-key="check-levels">
                    <div class="check-box">‚úì</div>
                    <span>Review key levels (VAH / POC / VAL)</span>
                </div>
                <div class="check-item" onclick="toggleCheck(this)" data-key="check-scanner">
                    <div class="check-box">‚úì</div>
                    <span>Run scanner ‚Äî identify top setups</span>
                </div>
                <div class="check-item" onclick="toggleCheck(this)" data-key="check-news">
                    <div class="check-box">‚úì</div>
                    <span>Check earnings calendar & macro events</span>
                </div>
                <div class="check-item" onclick="toggleCheck(this)" data-key="check-risk">
                    <div class="check-box">‚úì</div>
                    <span>Set position size & risk limits</span>
                </div>
                <div class="check-item" onclick="toggleCheck(this)" data-key="check-mindset">
                    <div class="check-box">‚úì</div>
                    <span>Clear head ‚Äî rules over impulse</span>
                </div>
            </div>
            <!-- Mental State Check -->
            <div id="mental-state-bar" onclick="runMentalCheck()" style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.75rem; padding: 0.75rem; background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <span id="mental-emoji" style="font-size: 1.5rem;">üü¢</span>
                <div style="flex: 1;">
                    <div id="mental-label" style="font-weight: 600; font-size: 0.85rem; color: #10b981;">MENTAL STATE: GREEN</div>
                    <div style="font-size: 0.75rem; color: #9ca3af;">Click to run mental check</div>
                </div>
                <span style="font-size: 0.75rem; color: #6b7280;">üß†</span>
            </div>
        </div>

        <!-- Session Notes -->
        <div class="info-card">
            <div class="note-header-row">
                <div class="card-header">üìù Session Notes</div>
                <div class="note-actions">
                    <button class="note-btn" id="week-lookback-btn" onclick="toggleWeekLookback()">üìÖ Week</button>
                    <button class="note-btn" onclick="openNotesSearch()">üîç Search</button>
                    <button class="note-btn" onclick="showRecentNotes()">üìÖ History</button>
                </div>
            </div>
            <textarea class="session-notes" id="session-notes" placeholder="Pre-market thesis, key observations, what you're watching today..."></textarea>
            <div class="note-footer">
                <span id="note-save-status">‚Äî</span>
                <span id="note-date"></span>
            </div>
            <div class="week-notes-inline" id="week-notes-inline"></div>
        </div>
    </div>
</div>

<!-- NOTES SEARCH OVERLAY -->
<div class="notes-search-overlay" id="notes-search-overlay" onclick="if(event.target===this)closeNotesSearch()">
    <div class="notes-search-panel" style="position:relative;">
        <button class="notes-search-close" onclick="closeNotesSearch()">‚úï</button>
        <div class="notes-search-header">
            <h3 id="notes-panel-title">üîç Search Notes</h3>
            <input class="notes-search-input" id="notes-search-input" placeholder="Search your notes... (e.g. CRM, thesis, breakout)" oninput="searchNotesDebounced()">
            <div class="search-filter-tabs" id="search-filter-tabs">
                <button class="search-filter-tab active" onclick="setSearchFilter('all',this)">All Time</button>
                <button class="search-filter-tab" onclick="setSearchFilter('week',this)">This Week</button>
                <button class="search-filter-tab" onclick="setSearchFilter('month',this)">This Month</button>
                <button class="search-filter-tab" onclick="setSearchFilter('quarter',this)">This Quarter</button>
            </div>
        </div>
        <div class="notes-search-results" id="notes-search-results">
            <div class="notes-search-empty">Type to search across all your session notes</div>
        </div>
    </div>
</div>

<!-- QUICK CARD GENERATOR -->
<div class="quick-stats" id="quick-card-section">
    <div class="stats-strip" style="justify-content:center;gap:10px;padding:10px 20px">
        <span style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:500">üÉè Quick Card</span>
        <input type="text" id="desk-card-input" placeholder="Ticker..." maxlength="10"
            style="width:120px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;padding:6px 10px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;font-weight:500;letter-spacing:1px;text-transform:uppercase;outline:none"
            onkeydown="if(event.key==='Enter')generateDeskCard()">
        <select id="desk-card-tf" style="background:var(--bg-input);border:1px solid var(--border);border-radius:6px;padding:6px 8px;color:var(--text-secondary);font-size:11px;outline:none;cursor:pointer">
            <option value="swing">Swing</option>
            <option value="daytrade">Day Trade</option>
            <option value="scalp">Scalp</option>
            <option value="position">Position</option>
        </select>
        <button onclick="generateDeskCard()" id="desk-card-btn"
            style="background:linear-gradient(135deg,#00e676,#00c853);color:#000;border:none;border-radius:6px;padding:6px 16px;font-weight:700;font-size:12px;cursor:pointer;transition:transform 0.1s"
            onmousedown="this.style.transform='scale(0.97)'" onmouseup="this.style.transform=''">
            Generate
        </button>
        <span id="desk-card-status" style="font-size:11px;color:var(--text-muted);min-width:80px"></span>
    </div>
</div>

<!-- CARD SLIDE PANEL -->
<div id="card-slide-panel" style="display:none;position:fixed;top:0;right:0;width:520px;height:100vh;background:var(--bg);border-left:1px solid var(--border);z-index:9999;overflow-y:auto;box-shadow:-8px 0 40px rgba(0,0,0,0.5);transition:transform 0.3s ease">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:1">
        <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:16px">üÉè</span>
            <span id="card-panel-title" style="font-weight:700;font-size:14px">Trading Card</span>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
            <button onclick="openCardFullPage()" title="Open full page" style="background:var(--bg-input);border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text-secondary);font-size:11px;cursor:pointer">‚Üó Full</button>
            <button onclick="toggleCardView()" id="card-view-btn" title="Toggle view" style="background:var(--bg-input);border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text-secondary);font-size:11px;cursor:pointer">Both</button>
            <button onclick="closeCardPanel()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:0 4px">‚úï</button>
        </div>
    </div>
    <div id="card-panel-body" style="padding:16px 20px"></div>
</div>

<!-- KEYBOARD SHORTCUTS -->
<div class="shortcuts">
    <div class="shortcut"><kbd>1</kbd> Scanner</div>
    <div class="shortcut"><kbd>2</kbd> Deep Analysis</div>
    <div class="shortcut"><kbd>3</kbd> Charts</div>
    <div class="shortcut"><kbd>4</kbd> Trades</div>
    <div class="shortcut"><kbd>5</kbd> Capital</div>
    <div class="shortcut"><kbd>6</kbd> Season</div>
    <div class="shortcut"><kbd>7</kbd> Catalyst</div>
    <div class="shortcut"><kbd>8</kbd> Buffett</div>
    <div class="shortcut"><kbd>9</kbd> Options Flow</div>
    <div class="shortcut"><kbd>0</kbd> War Room</div>
    <div class="shortcut"><kbd>C</kbd> Quick Card</div>
</div>

<script>
// ===== FIREBASE =====
const firebaseConfig = {
    apiKey: "AIzaSyB4oBeoFzFV2oS5ZxEvQ4TIRRVJFC3nl-w",
    authDomain: "analysis-grid.firebaseapp.com",
    projectId: "analysis-grid",
    storageBucket: "analysis-grid.firebasestorage.app",
    messagingSenderId: "633207767657",
    appId: "1:633207767657:web:e623871eca352a268b58f8"
};

let db = null;
let currentUser = null;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
} catch(e) {
    console.warn('Firebase init failed:', e);
}

// ===== AUTH =====
function initAuth() {
    const auth = firebase.auth();
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            console.log('Trade Desk auth:', user.uid);
            loadChecklist();
            loadNotes();
            loadQuickStats();
            loadMentalState();
        } else {
            // Try anonymous sign-in
            auth.signInAnonymously().catch(err => {
                console.warn('Anonymous auth failed:', err);
                currentUser = { uid: 'local_user' };
                loadChecklist();
                loadNotes();
                loadQuickStats();
                loadMentalState();
            });
        }
    });
}
initAuth();

// ===== MODULE PATHS =====
const MODULE_PATHS = {
    scanner: '/simple.html',
    deep: '/index',
    charts: '/charts',
    trades: '/simple.html?openTrades=true',
    capital: '/growth',
    season: '/index?tab=journal',
    research: '/research',
    sustainability: '/sustainability',
    catalyst: '/catalyst',
    buffett: '/buffett',
    optflow: '/options',
    warroom: '/warroom',
    cards: '/cards'
};

function launchModule(mod) {
    const path = MODULE_PATHS[mod];
    if (path) {
        window.location.href = path;
    }
}

function showComingSoon() {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(4px);';
    overlay.innerHTML = `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:40px 48px;text-align:center;max-width:380px;">
        <div style="font-size:48px;margin-bottom:16px;">üöß</div>
        <h3 style="font-family:'Space Grotesk',sans-serif;font-size:20px;margin-bottom:8px;">Coming Soon</h3>
        <p style="color:var(--text-secondary);font-size:14px;margin-bottom:24px;">Season tracking is under development.<br>Stay tuned!</p>
        <button onclick="this.closest('div').parentElement.remove()" style="background:var(--blue);color:white;border:none;padding:10px 28px;border-radius:8px;cursor:pointer;font-size:14px;font-family:'Outfit',sans-serif;">Got it</button>
    </div>`;
    document.body.appendChild(overlay);
    overlay.addEventListener('click', (e) => { if(e.target === overlay) overlay.remove(); });
}

// ===== P&L VISIBILITY TOGGLE =====
let pnlHidden = localStorage.getItem('sef-pnl-hidden') === 'true';
function applyPnlVisibility() {
    const ids = ['qs-today-pnl','qs-week-pnl','qs-month-pnl'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (pnlHidden) {
                el.dataset.realValue = el.textContent;
                el.textContent = '‚Ä¢‚Ä¢‚Ä¢';
                el.style.color = '#4b5563';
            } else if (el.dataset.realValue) {
                el.textContent = el.dataset.realValue;
                delete el.dataset.realValue;
            }
        }
    });
    const toggle = document.getElementById('pnl-toggle');
    if (toggle) toggle.textContent = pnlHidden ? 'üëÅ‚Äçüó®' : 'üëÅ';
}
function togglePnlVisibility(e) {
    e.stopPropagation();
    pnlHidden = !pnlHidden;
    localStorage.setItem('sef-pnl-hidden', pnlHidden);
    applyPnlVisibility();
}
// Apply on load
setTimeout(applyPnlVisibility, 500);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
    switch(e.key) {
        case '1': launchModule('scanner'); break;
        case '2': launchModule('deep'); break;
        case '3': launchModule('charts'); break;
        case '4': launchModule('trades'); break;
        case '5': launchModule('capital'); break;
        case '6': launchModule('season'); break;
        case '7': launchModule('catalyst'); break;
        case '8': launchModule('buffett'); break;
        case '9': launchModule('optflow'); break;
        case '0': launchModule('warroom'); break;
        case 'c': case 'C': document.getElementById('desk-card-input').focus(); break;
    }
});

// ===== CLOCK & MARKET STATUS =====
function updateClock() {
    const now = new Date();
    const et = now.toLocaleString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
    document.getElementById('clock-time').textContent = et;
    
    const etHour = parseInt(now.toLocaleString('en-US', { timeZone: 'America/New_York', hour: 'numeric', hour12: false }));
    const etMin = parseInt(now.toLocaleString('en-US', { timeZone: 'America/New_York', minute: 'numeric' }));
    const totalMin = etHour * 60 + etMin;
    const day = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' })).getDay();
    
    const dot = document.getElementById('status-dot');
    const statusText = document.getElementById('market-status-text');
    
    if (day === 0 || day === 6) {
        dot.className = 'status-dot closed';
        statusText.textContent = 'Weekend';
        statusText.style.color = 'var(--text-muted)';
    } else if (totalMin >= 570 && totalMin < 960) { // 9:30 - 16:00
        dot.className = 'status-dot open';
        statusText.textContent = 'Market Open';
        statusText.style.color = 'var(--green)';
    } else if (totalMin >= 240 && totalMin < 570) { // 4:00 - 9:30
        dot.className = 'status-dot pre';
        statusText.textContent = 'Pre-Market';
        statusText.style.color = 'var(--amber)';
    } else if (totalMin >= 960 && totalMin < 1200) { // 16:00 - 20:00
        dot.className = 'status-dot pre';
        statusText.textContent = 'After Hours';
        statusText.style.color = 'var(--amber)';
    } else {
        dot.className = 'status-dot closed';
        statusText.textContent = 'Market Closed';
        statusText.style.color = 'var(--text-muted)';
    }
}

setInterval(updateClock, 1000);
updateClock();

// ===== DESK GREETING & DATE =====
function updateDeskGreeting() {
    const now = new Date();
    const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
    const etDate = new Date(etStr);
    const h = etDate.getHours();
    let greet = 'Good Evening';
    if (h < 12) greet = 'Good Morning';
    else if (h < 17) greet = 'Good Afternoon';
    const el = document.getElementById('desk-greeting');
    if (el) el.textContent = greet;

    const dateEl = document.getElementById('desk-date');
    if (dateEl) {
        dateEl.textContent = etDate.toLocaleDateString('en-US', { 
            weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', timeZone: 'America/New_York' 
        });
    }
}
updateDeskGreeting();
setInterval(updateDeskGreeting, 60000);

// ===== MARKET INDICES =====
const API_BASE = window.location.origin;

async function fetchIndices() {
    const indices = ['SPY', 'QQQ', 'DIA', 'IWM'];
    for (const symbol of indices) {
        try {
            const response = await fetch(`${API_BASE}/api/quote/${symbol}`);
            if (response.ok) {
                const data = await response.json();
                const priceEl = document.getElementById(`${symbol.toLowerCase()}-price`);
                const changeEl = document.getElementById(`${symbol.toLowerCase()}-change`);
                if (!priceEl || !changeEl || !data) continue;
                const price = data.c || data.price || data.current;
                const prevClose = data.pc || data.previousClose || data.prev_close;
                if (price) {
                    priceEl.textContent = `$${price.toFixed(2)}`;
                    if (prevClose) {
                        const change = price - prevClose;
                        const changePct = ((change / prevClose) * 100).toFixed(2);
                        const isPositive = change >= 0;
                        changeEl.textContent = `${isPositive ? '+' : ''}${changePct}%`;
                        changeEl.className = `index-change ${isPositive ? 'positive' : 'negative'}`;
                    }
                }
            }
        } catch (err) {
            console.log(`Failed to fetch ${symbol}:`, err);
        }
    }
}

fetchIndices();
setInterval(fetchIndices, 30000);

// ===== DATE DISPLAY =====
const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const now = new Date();
document.getElementById('note-date').textContent = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
document.getElementById('season-month').textContent = months[now.getMonth()];
document.getElementById('season-quarter').textContent = `Q${Math.floor(now.getMonth() / 3) + 1}`;

// ===== CHECKLIST =====
function loadChecklist() {
    const today = new Date().toISOString().split('T')[0];
    const saved = JSON.parse(localStorage.getItem('sef-checklist') || '{}');
    
    // Reset if not today
    if (saved.date !== today) {
        localStorage.setItem('sef-checklist', JSON.stringify({ date: today, items: {} }));
        return;
    }
    
    document.querySelectorAll('.check-item').forEach(item => {
        const key = item.dataset.key;
        if (saved.items && saved.items[key]) {
            item.classList.add('done');
        }
    });
}

function toggleCheck(el) {
    el.classList.toggle('done');
    saveChecklist();
}

function saveChecklist() {
    const today = new Date().toISOString().split('T')[0];
    const items = {};
    document.querySelectorAll('.check-item').forEach(item => {
        items[item.dataset.key] = item.classList.contains('done');
    });
    localStorage.setItem('sef-checklist', JSON.stringify({ date: today, items }));
    
    // Also save to Firebase (user-scoped)
    if (db && currentUser) {
        db.doc(`users/${currentUser.uid}/trade_desk/checklist`).set({ date: today, items }).catch(() => {});
    }
}

// loadChecklist called from initAuth

// ===== MENTAL STATE CHECK =====
const MENTAL_CHECK_QUESTIONS = [
    { id: "sleep", question: "Did you get 7+ hours of quality sleep?", red_if: false },
    { id: "revenge", question: "Are you trying to recover losses from yesterday?", red_if: true },
    { id: "fomo", question: "Are you feeling FOMO about missing moves?", red_if: true },
    { id: "distracted", question: "Are you distracted or multitasking?", red_if: true },
    { id: "plan", question: "Do you have a clear plan with defined R:R?", red_if: false },
    { id: "stressed", question: "Are you stressed about money/life situations?", red_if: true },
    { id: "forcing", question: "Do you feel like you MUST take a trade today?", red_if: true },
    { id: "prepared", question: "Have you done your pre-market prep?", red_if: false }
];

function runMentalCheck() {
    const modal = document.createElement('div');
    modal.id = 'mental-check-modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000;';
    
    let questionsHtml = MENTAL_CHECK_QUESTIONS.map((q, i) => `
        <div style="padding:0.75rem 1rem;background:#0f172a;border-radius:8px;margin-bottom:0.6rem;border:1px solid #1e293b;">
            <div style="margin-bottom:0.6rem;font-size:0.9rem;color:#e2e8f0;">${i + 1}. ${q.question}</div>
            <div style="display:flex;gap:0.75rem;">
                <button class="mental-answer" data-q="${q.id}" data-val="true"
                    onclick="selectMentalAnswer('${q.id}',true,this)"
                    style="flex:1;padding:0.4rem;border-radius:6px;border:1px solid #1e293b;background:#1e293b;color:#9ca3af;cursor:pointer;font-size:0.85rem;">Yes</button>
                <button class="mental-answer" data-q="${q.id}" data-val="false"
                    onclick="selectMentalAnswer('${q.id}',false,this)"
                    style="flex:1;padding:0.4rem;border-radius:6px;border:1px solid #1e293b;background:#1e293b;color:#9ca3af;cursor:pointer;font-size:0.85rem;">No</button>
            </div>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div style="background:#0a0e17;border:1px solid #1e293b;border-radius:12px;padding:1.5rem;max-width:480px;width:90%;max-height:80vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                <h3 style="margin:0;color:#00d4ff;font-size:1rem;">üß† Mental State Check</h3>
                <button onclick="document.getElementById('mental-check-modal').remove()" style="background:none;border:none;font-size:1.4rem;cursor:pointer;color:#6b7280;">√ó</button>
            </div>
            <p style="color:#6b7280;margin-bottom:1.25rem;font-size:0.8rem;">Answer honestly. This protects your capital from emotional trading.</p>
            <div id="mental-questions">${questionsHtml}</div>
            <button onclick="submitMentalCheck()" style="width:100%;margin-top:0.75rem;padding:0.6rem;background:#00d4ff;color:#0a0e17;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.9rem;">Submit Check</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    window.mentalAnswers = {};
}

function selectMentalAnswer(questionId, value, btn) {
    window.mentalAnswers[questionId] = value;
    const container = btn.parentElement;
    container.querySelectorAll('.mental-answer').forEach(b => {
        b.style.background = '#1e293b';
        b.style.borderColor = '#1e293b';
        b.style.color = '#9ca3af';
    });
    btn.style.background = value ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)';
    btn.style.borderColor = value ? '#10b981' : '#ef4444';
    btn.style.color = value ? '#10b981' : '#ef4444';
}

async function submitMentalCheck() {
    const answers = window.mentalAnswers || {};
    if (Object.keys(answers).length < MENTAL_CHECK_QUESTIONS.length) {
        alert('Please answer all questions');
        return;
    }
    
    let redFlags = 0;
    MENTAL_CHECK_QUESTIONS.forEach(q => {
        if (answers[q.id] === q.red_if) redFlags++;
    });
    
    let state, description;
    if (redFlags === 0) {
        state = 'GREEN'; description = 'Clear, patient, process-focused';
    } else if (redFlags <= 2) {
        state = 'YELLOW'; description = 'Caution ‚Äî some concerns. Reduce size.';
    } else {
        state = 'RED'; description = 'Do not trade today. Step away.';
    }
    
    // Save to Firestore
    if (db && currentUser) {
        try {
            await db.doc(`users/${currentUser.uid}/trade_desk/mental_state`).set({
                state, answers, redFlags, description,
                checked_at: new Date().toISOString()
            });
        } catch (e) { console.log('Mental check save error:', e); }
    }
    
    // Update the bar display
    updateMentalBar(state, description);
    
    // Close modal
    document.getElementById('mental-check-modal').remove();
}

function updateMentalBar(state, description) {
    const bar = document.getElementById('mental-state-bar');
    const emoji = document.getElementById('mental-emoji');
    const label = document.getElementById('mental-label');
    if (!bar) return;
    
    const colors = {
        GREEN:  { bg: 'rgba(16,185,129,0.08)', border: 'rgba(16,185,129,0.2)', text: '#10b981', icon: 'üü¢' },
        YELLOW: { bg: 'rgba(245,158,11,0.08)', border: 'rgba(245,158,11,0.2)', text: '#f59e0b', icon: 'üü°' },
        RED:    { bg: 'rgba(239,68,68,0.08)',   border: 'rgba(239,68,68,0.2)',   text: '#ef4444', icon: 'üî¥' }
    };
    const c = colors[state] || colors.GREEN;
    bar.style.background = c.bg;
    bar.style.borderColor = c.border;
    emoji.textContent = c.icon;
    label.textContent = `MENTAL STATE: ${state}`;
    label.style.color = c.text;
}

async function loadMentalState() {
    if (!db || !currentUser) return;
    try {
        const doc = await db.doc(`users/${currentUser.uid}/trade_desk/mental_state`).get();
        if (doc.exists) {
            const data = doc.data();
            // Only show today's check
            const checkedDate = (data.checked_at || '').split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            if (checkedDate === today) {
                updateMentalBar(data.state, data.description);
            }
        }
    } catch (e) { console.log('Load mental state error:', e); }
}

// ===== SESSION NOTES (Permanent Daily Docs) =====
let noteTimeout = null;
let searchTimeout = null;
let notesCache = []; // cached notes for search
const notesArea = document.getElementById('session-notes');
const noteStatus = document.getElementById('note-save-status');

function getTodayKey() {
    return new Date().toISOString().split('T')[0]; // e.g. 2026-02-14
}

function getNotesDocPath(dateKey) {
    return `users/${currentUser.uid}/trade_desk/notes_${dateKey}`;
}

function loadNotes() {
    const today = getTodayKey();
    // Fast: load from localStorage
    const saved = JSON.parse(localStorage.getItem('sef-session-notes') || '{}');
    if (saved.date === today && saved.text) {
        notesArea.value = saved.text;
    }

    // Then hydrate from Firebase (daily doc)
    if (db && currentUser) {
        db.doc(getNotesDocPath(today)).get().then(doc => {
            if (doc.exists && doc.data().text) {
                // Use Firebase version if it's longer (more complete)
                if (!notesArea.value || doc.data().text.length > notesArea.value.length) {
                    notesArea.value = doc.data().text;
                    noteStatus.textContent = '‚òÅÔ∏è loaded';
                }
            }
        }).catch(() => {});

        // Migrate old single-doc notes if they exist
        db.doc(`users/${currentUser.uid}/trade_desk/notes`).get().then(doc => {
            if (doc.exists && doc.data().date && doc.data().text) {
                const oldDate = doc.data().date;
                const oldText = doc.data().text;
                // Save old note to its proper daily doc
                db.doc(`users/${currentUser.uid}/trade_desk/notes_${oldDate}`).set(
                    { date: oldDate, text: oldText, updated: new Date().toISOString() },
                    { merge: true }
                ).then(() => {
                    // Delete old format doc after migration
                    db.doc(`users/${currentUser.uid}/trade_desk/notes`).delete().catch(() => {});
                }).catch(() => {});
            }
        }).catch(() => {});
    }
}

notesArea.addEventListener('input', () => {
    const today = getTodayKey();
    localStorage.setItem('sef-session-notes', JSON.stringify({ date: today, text: notesArea.value }));
    noteStatus.textContent = '‚úèÔ∏è typing...';

    if (noteTimeout) clearTimeout(noteTimeout);
    noteTimeout = setTimeout(() => {
        if (db && currentUser) {
            db.doc(getNotesDocPath(today)).set({
                date: today,
                text: notesArea.value,
                updated: new Date().toISOString()
            }).then(() => { noteStatus.textContent = '‚òÅÔ∏è saved'; })
              .catch(() => { noteStatus.textContent = 'üíæ local only'; });
        } else {
            noteStatus.textContent = 'üíæ saved locally';
        }
    }, 1500);
});

// ===== NOTES SEARCH & HISTORY =====
async function fetchAllNotes() {
    if (notesCache.length > 0) return notesCache;
    if (!db || !currentUser) return [];

    try {
        const snap = await db.collection(`users/${currentUser.uid}/trade_desk`)
            .where(firebase.firestore.FieldPath.documentId(), '>=', 'notes_')
            .where(firebase.firestore.FieldPath.documentId(), '<=', 'notes_\uf8ff')
            .orderBy(firebase.firestore.FieldPath.documentId(), 'desc')
            .get();

        notesCache = [];
        snap.forEach(doc => {
            const d = doc.data();
            if (d.text && d.text.trim()) {
                notesCache.push({ id: doc.id, date: d.date || doc.id.replace('notes_',''), text: d.text });
            }
        });
        return notesCache;
    } catch(e) {
        console.error('Error fetching notes:', e);
        return [];
    }
}

function openNotesSearch() {
    document.getElementById('notes-search-overlay').classList.add('open');
    document.getElementById('notes-panel-title').textContent = 'üîç Search Notes';
    document.getElementById('notes-search-input').value = '';
    document.getElementById('notes-search-input').style.display = '';
    document.getElementById('notes-search-results').innerHTML = '<div class="notes-search-empty">Type to search across all your session notes</div>';
    setTimeout(() => document.getElementById('notes-search-input').focus(), 100);
}

async function showRecentNotes() {
    document.getElementById('notes-search-overlay').classList.add('open');
    document.getElementById('notes-panel-title').textContent = 'üìÖ Notes History';
    document.getElementById('notes-search-input').value = '';
    document.getElementById('notes-search-input').style.display = '';
    document.getElementById('notes-search-results').innerHTML = '<div class="notes-search-empty">Loading notes...</div>';

    notesCache = []; // force refresh
    const notes = await fetchAllNotes();
    if (notes.length === 0) {
        document.getElementById('notes-search-results').innerHTML = '<div class="notes-search-empty">No saved notes yet. Start writing today!</div>';
        return;
    }
    renderNoteResults(notes);
    setTimeout(() => document.getElementById('notes-search-input').focus(), 100);
}

function closeNotesSearch() {
    document.getElementById('notes-search-overlay').classList.remove('open');
}

function searchNotesDebounced() {
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 300);
}

async function performSearch() {
    const query = document.getElementById('notes-search-input').value.trim().toLowerCase();
    if (!query) {
        document.getElementById('notes-search-results').innerHTML = '<div class="notes-search-empty">Type to search across all your session notes</div>';
        return;
    }

    const allNotes = await fetchAllNotes();
    const cutoff = getFilterDateCutoff(searchFilter);
    const filtered = cutoff ? allNotes.filter(n => n.date >= cutoff) : allNotes;
    const terms = query.split(/\s+/);
    const matches = filtered.filter(n => {
        const text = n.text.toLowerCase();
        return terms.every(t => text.includes(t));
    });

    if (matches.length === 0) {
        const scope = searchFilter === 'all' ? '' : ` (${searchFilter} filter)`;
        document.getElementById('notes-search-results').innerHTML = `<div class="notes-search-empty">No notes matching "${query}"${scope}</div>`;
        return;
    }

    renderNoteResults(matches, query);
}

function renderNoteResults(notes, highlightQuery) {
    const container = document.getElementById('notes-search-results');
    container.innerHTML = '';

    notes.forEach(note => {
        const item = document.createElement('div');
        item.className = 'note-result-item';

        // Format date nicely
        const dateParts = note.date.split('-');
        const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const niceDate = `${dayNames[dateObj.getDay()]}, ${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateParts[0]}`;

        const isToday = note.date === getTodayKey();
        const dateLabel = isToday ? `üìå TODAY ‚Äî ${niceDate}` : niceDate;

        let displayText = note.text;
        // Truncate for preview
        if (displayText.length > 200 && !highlightQuery) {
            displayText = displayText.substring(0, 200) + '...';
        }

        // Highlight search terms
        if (highlightQuery) {
            const terms = highlightQuery.toLowerCase().split(/\s+/);
            // Find the first match position for context window
            const lowerText = note.text.toLowerCase();
            let firstIdx = lowerText.indexOf(terms[0]);
            if (firstIdx > 80) {
                displayText = '...' + note.text.substring(firstIdx - 40, firstIdx + 200) + (firstIdx + 200 < note.text.length ? '...' : '');
            } else {
                displayText = note.text.substring(0, 250) + (note.text.length > 250 ? '...' : '');
            }
            // Highlight each term
            terms.forEach(term => {
                const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                displayText = displayText.replace(new RegExp(`(${escaped})`, 'gi'), '<mark>$1</mark>');
            });
        }

        item.innerHTML = `<div class="note-result-date">${dateLabel}</div><div class="note-result-text">${highlightQuery ? displayText : escapeHtml(displayText)}</div>`;

        // Click to load that day's note into the editor
        item.addEventListener('click', () => {
            notesArea.value = note.text;
            const today = getTodayKey();
            localStorage.setItem('sef-session-notes', JSON.stringify({ date: today, text: note.text }));
            noteStatus.textContent = `üëÅ viewing ${note.date}`;
            closeNotesSearch();
        });

        container.appendChild(item);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Invalidate cache when user types new notes (so search picks up changes)
notesArea.addEventListener('input', function cacheInvalidator() {
    notesCache = [];
});

// loadNotes called from initAuth

// ===== EQUITY CURVE =====
let equityPeriod = 'daily';
let equityEntries = [];

function setEquityPeriod(period, btn) {
    equityPeriod = period;
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    drawEquityCurve();
}

function aggregateEntries(entries, period) {
    if (!entries.length) return [];
    const sorted = [...entries].sort((a, b) => a.date.localeCompare(b.date));

    if (period === 'daily') {
        const byDay = {};
        sorted.forEach(e => { byDay[e.date] = (byDay[e.date] || 0) + e.pnl; });
        return Object.entries(byDay).map(([date, pnl]) => ({ date, pnl }));
    }

    const groups = {};
    sorted.forEach(e => {
        let key;
        const d = new Date(e.date + 'T12:00:00');
        if (period === 'weekly') {
            const s = new Date(d); s.setDate(d.getDate() - d.getDay());
            key = s.toISOString().split('T')[0];
        } else if (period === 'monthly') {
            key = e.date.substring(0, 7);
        } else if (period === 'quarterly') {
            key = `${d.getFullYear()}-Q${Math.floor(d.getMonth() / 3) + 1}`;
        } else if (period === 'yearly') {
            key = e.date.substring(0, 4);
        }
        groups[key] = (groups[key] || 0) + e.pnl;
    });
    return Object.entries(groups).map(([date, pnl]) => ({ date, pnl }));
}

function drawEquityCurve() {
    const section = document.getElementById('equity-section');
    const canvas = document.getElementById('equity-canvas');
    if (!canvas || !equityEntries.length) {
        if (section) section.style.display = 'none';
        return;
    }

    section.style.display = '';
    const ctx = canvas.getContext('2d');
    const wrap = document.getElementById('equity-canvas-wrap');
    const dpr = window.devicePixelRatio || 1;
    const w = wrap.clientWidth;
    const h = wrap.clientHeight;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    ctx.scale(dpr, dpr);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';

    const agg = aggregateEntries(equityEntries, equityPeriod);
    if (agg.length === 0) return;

    // Build cumulative equity
    let cumulative = 0;
    const points = agg.map(e => { cumulative += e.pnl; return { date: e.date, value: cumulative }; });

    // Update total display
    const totalEl = document.getElementById('equity-total');
    const total = points[points.length - 1].value;
    const pfx = total >= 0 ? '+' : '';
    totalEl.textContent = `${pfx}$${Math.abs(total).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
    totalEl.style.color = total >= 0 ? 'var(--green)' : 'var(--red)';

    // Chart dimensions
    const pad = { top: 12, right: 12, bottom: 28, left: 56 };
    const chartW = w - pad.left - pad.right;
    const chartH = h - pad.top - pad.bottom;

    const vals = points.map(p => p.value);
    let minVal = Math.min(0, ...vals);
    let maxVal = Math.max(0, ...vals);
    if (minVal === maxVal) { minVal -= 100; maxVal += 100; }
    const range = maxVal - minVal;
    minVal -= range * 0.1;
    maxVal += range * 0.1;

    const xScale = (i) => pad.left + (i / (points.length - 1 || 1)) * chartW;
    const yScale = (v) => pad.top + chartH - ((v - minVal) / (maxVal - minVal)) * chartH;

    ctx.clearRect(0, 0, w, h);

    // Grid lines
    const gridLines = 4;
    ctx.strokeStyle = 'rgba(30, 42, 66, 0.5)';
    ctx.lineWidth = 0.5;
    ctx.font = '10px "DM Mono", monospace';
    ctx.fillStyle = '#4a5568';
    ctx.textAlign = 'right';

    for (let i = 0; i <= gridLines; i++) {
        const val = minVal + (maxVal - minVal) * (i / gridLines);
        const y = yScale(val);
        ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
        const lbl = val >= 0 ? `+$${Math.abs(val).toFixed(0)}` : `-$${Math.abs(val).toFixed(0)}`;
        ctx.fillText(lbl, pad.left - 6, y + 3);
    }

    // Zero line
    if (minVal < 0 && maxVal > 0) {
        const zeroY = yScale(0);
        ctx.strokeStyle = 'rgba(100, 116, 139, 0.4)';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath(); ctx.moveTo(pad.left, zeroY); ctx.lineTo(w - pad.right, zeroY); ctx.stroke();
        ctx.setLineDash([]);
    }

    // X-axis labels
    ctx.fillStyle = '#4a5568';
    ctx.textAlign = 'center';
    ctx.font = '9px "DM Mono", monospace';
    const labelCount = Math.min(points.length, 6);
    for (let i = 0; i < labelCount; i++) {
        const idx = Math.floor(i * (points.length - 1) / (labelCount - 1 || 1));
        let label = points[idx].date;
        if (equityPeriod === 'daily') label = label.substring(5);
        ctx.fillText(label, xScale(idx), h - 6);
    }

    // Gradient fill
    const gradient = ctx.createLinearGradient(0, pad.top, 0, h - pad.bottom);
    if (total >= 0) {
        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.15)');
        gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');
    } else {
        gradient.addColorStop(0, 'rgba(239, 68, 68, 0)');
        gradient.addColorStop(1, 'rgba(239, 68, 68, 0.15)');
    }
    ctx.beginPath();
    ctx.moveTo(xScale(0), yScale(0));
    points.forEach((p, i) => ctx.lineTo(xScale(i), yScale(p.value)));
    ctx.lineTo(xScale(points.length - 1), yScale(0));
    ctx.closePath();
    ctx.fillStyle = gradient;
    ctx.fill();

    // Line
    ctx.beginPath();
    ctx.moveTo(xScale(0), yScale(points[0].value));
    points.forEach((p, i) => ctx.lineTo(xScale(i), yScale(p.value)));
    ctx.strokeStyle = total >= 0 ? '#10b981' : '#ef4444';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.stroke();

    // Dots (if <= 30 data points)
    if (points.length <= 30) {
        points.forEach((p, i) => {
            ctx.beginPath();
            ctx.arc(xScale(i), yScale(p.value), 3, 0, Math.PI * 2);
            ctx.fillStyle = p.value >= 0 ? '#10b981' : '#ef4444';
            ctx.fill();
        });
    }

    // End dot with glow
    const last = points[points.length - 1];
    ctx.beginPath();
    ctx.arc(xScale(points.length - 1), yScale(last.value), 4, 0, Math.PI * 2);
    ctx.fillStyle = last.value >= 0 ? '#10b981' : '#ef4444';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(xScale(points.length - 1), yScale(last.value), 6, 0, Math.PI * 2);
    ctx.strokeStyle = last.value >= 0 ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();
}

// Redraw on resize
window.addEventListener('resize', () => { if (equityEntries.length) drawEquityCurve(); });

// ===== WEEK LOOKBACK =====
let weekLookbackOpen = false;

async function toggleWeekLookback() {
    const container = document.getElementById('week-notes-inline');
    const btn = document.getElementById('week-lookback-btn');
    weekLookbackOpen = !weekLookbackOpen;

    if (!weekLookbackOpen) {
        container.classList.remove('open');
        btn.classList.remove('active');
        return;
    }

    btn.classList.add('active');
    container.innerHTML = '<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:12px;">Loading week notes...</div>';
    container.classList.add('open');

    const allNotes = await fetchAllNotes();
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(today.getDate() - 7);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];
    const todayStr = getTodayKey();

    const weekNotes = allNotes.filter(n => n.date >= weekAgoStr && n.date !== todayStr);

    if (weekNotes.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:12px;color:var(--text-muted);font-size:12px;">No notes from the past 7 days</div>';
        return;
    }

    container.innerHTML = '';
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    weekNotes.forEach(note => {
        const parts = note.date.split('-');
        const d = new Date(parts[0], parts[1] - 1, parts[2]);
        const niceDate = `${dayNames[d.getDay()]}, ${monthNames[d.getMonth()]} ${d.getDate()}`;

        const entry = document.createElement('div');
        entry.className = 'week-note-entry';
        const preview = note.text.length > 120 ? note.text.substring(0, 120) + '...' : note.text;
        entry.innerHTML = `<div class="week-note-date">${niceDate}</div><div class="week-note-preview">${escapeHtml(preview)}</div>`;
        entry.addEventListener('click', () => {
            notesArea.value = note.text;
            noteStatus.textContent = `üëÅ viewing ${note.date}`;
        });
        container.appendChild(entry);
    });
}

// ===== SEARCH FILTER =====
let searchFilter = 'all';

function setSearchFilter(filter, btn) {
    searchFilter = filter;
    document.querySelectorAll('.search-filter-tab').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    performSearch();
}

function getFilterDateCutoff(filter) {
    const now = new Date();
    if (filter === 'week') {
        const d = new Date(now); d.setDate(now.getDate() - 7);
        return d.toISOString().split('T')[0];
    }
    if (filter === 'month') {
        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;
    }
    if (filter === 'quarter') {
        const qStart = Math.floor(now.getMonth() / 3) * 3;
        return `${now.getFullYear()}-${String(qStart + 1).padStart(2, '0')}-01`;
    }
    return null; // all time
}

// ===== PULL QUICK STATS FROM CAPITAL ENGINE =====
async function loadQuickStats() {
    // Try localStorage first
    let state = null;
    const saved = localStorage.getItem('capital-growth-engine');
    if (saved) {
        try { state = JSON.parse(saved); } catch(e) {}
    }
    
    // Try Firebase if no local data
    if ((!state || !state.entries || state.entries.length === 0) && db && currentUser) {
        try {
            const doc = await db.doc(`users/${currentUser.uid}/capital_growth/state`).get();
            if (doc.exists) {
                state = doc.data();
                if (state.entries_json) {
                    state.entries = JSON.parse(state.entries_json);
                }
            }
        } catch(e) {}
    }
    
    if (!state || !state.entries || state.entries.length === 0) return;
    
    const entries = state.entries;
    const today = new Date().toISOString().split('T')[0];
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const weekStr = weekStart.toISOString().split('T')[0];
    const nowLocal = new Date();
    const monthStr = `${nowLocal.getFullYear()}-${String(nowLocal.getMonth()+1).padStart(2,'0')}-01`;
    
    const fmt = (n) => {
        const prefix = n >= 0 ? '+' : '';
        return prefix + '$' + Math.abs(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };
    const color = (n) => n >= 0 ? 'var(--green)' : 'var(--red)';
    
    // Today
    const todayPnl = entries.filter(e => e.date === today).reduce((s,e) => s + e.pnl, 0);
    const todayEntries = entries.filter(e => e.date === today);
    if (todayEntries.length > 0) {
        const el = document.getElementById('qs-today-pnl');
        el.textContent = fmt(todayPnl);
        el.style.color = color(todayPnl);
    }
    
    // Week
    const weekPnl = entries.filter(e => e.date >= weekStr).reduce((s,e) => s + e.pnl, 0);
    const weekEntries = entries.filter(e => e.date >= weekStr);
    if (weekEntries.length > 0) {
        const el = document.getElementById('qs-week-pnl');
        el.textContent = fmt(weekPnl);
        el.style.color = color(weekPnl);
    }
    
    // Month
    const monthPnl = entries.filter(e => e.date >= monthStr).reduce((s,e) => s + e.pnl, 0);
    const monthEntries = entries.filter(e => e.date >= monthStr);
    if (monthEntries.length > 0) {
        const el = document.getElementById('qs-month-pnl');
        el.textContent = fmt(monthPnl);
        el.style.color = color(monthPnl);
    }
    
    // Win rate
    const wins = entries.filter(e => e.pnl > 0).length;
    const wr = entries.length > 0 ? Math.round(wins / entries.length * 100) : 0;
    document.getElementById('qs-winrate').textContent = `${wr}%`;
    document.getElementById('qs-winrate').style.color = wr >= 55 ? 'var(--green)' : wr >= 45 ? 'var(--amber)' : 'var(--red)';
    
    // Streak
    const sorted = [...entries].sort((a,b) => b.date.localeCompare(a.date));
    let streak = 0;
    if (sorted.length > 0) {
        const dir = sorted[0].pnl >= 0 ? 1 : -1;
        for (const e of sorted) {
            if ((dir === 1 && e.pnl >= 0) || (dir === -1 && e.pnl < 0)) streak++;
            else break;
        }
        streak *= dir;
    }
    const streakEl = document.getElementById('qs-streak');
    streakEl.textContent = streak > 0 ? `${streak}üî•` : `${Math.abs(streak)}`;
    streakEl.style.color = streak > 0 ? 'var(--green)' : streak < 0 ? 'var(--red)' : 'var(--text-muted)';
    
    // Trade count for card
    document.getElementById('trades-count').textContent = `${entries.length} Trades`;
    if (todayEntries.length > 0) {
        document.getElementById('trades-today').textContent = `Today: ${fmt(todayPnl)}`;
        document.getElementById('trades-today').style.color = color(todayPnl);
    }
    
    // Capital goal pace
    if (state.goalProfit) {
        document.getElementById('capital-goal').textContent = `Goal: $${state.goalProfit.toLocaleString()}`;
        
        const goalEntries = entries.filter(e => {
            const tf = state.goalTimeframe || 'month';
            if (tf === 'month') return e.date >= monthStr;
            if (tf === 'week') return e.date >= weekStr;
            return true;
        });
        const earned = goalEntries.reduce((s,e) => s + e.pnl, 0);
        const pct = Math.round(earned / state.goalProfit * 100);
        document.getElementById('capital-pace').textContent = `${pct}% done`;
        
        const paceEl = document.getElementById('qs-pace');
        paceEl.textContent = `${pct}%`;
        paceEl.style.color = pct >= 100 ? 'var(--green)' : pct >= 50 ? 'var(--cyan)' : 'var(--amber)';
    }
    
    // Reapply P&L hidden state after data loads
    if (pnlHidden) applyPnlVisibility();

    // Draw equity curve
    equityEntries = entries;
    drawEquityCurve();
}

// loadQuickStats called from initAuth

// ===== QUICK CARD GENERATOR =====
let cardPanelView = 'both'; // both, thesis, execution
let lastCardSymbol = '';

async function generateDeskCard() {
    const input = document.getElementById('desk-card-input');
    const sym = input.value.trim().toUpperCase();
    if (!sym) { input.focus(); return; }

    const tf = document.getElementById('desk-card-tf').value;
    const btn = document.getElementById('desk-card-btn');
    const status = document.getElementById('desk-card-status');
    const panel = document.getElementById('card-slide-panel');
    const body = document.getElementById('card-panel-body');
    const title = document.getElementById('card-panel-title');

    btn.disabled = true;
    btn.textContent = '...';
    status.textContent = 'Scanning 7 endpoints...';
    status.style.color = 'var(--amber)';

    // Open panel immediately with loading state
    panel.style.display = 'block';
    title.textContent = `${sym} ‚Äî Loading...`;
    body.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 0;gap:16px">
        <div style="width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:#00e676;border-radius:50%;animation:spin 0.8s linear infinite"></div>
        <div style="font-size:12px;color:var(--text-muted)" id="card-load-phase">Phase 1: Parallel scanner fetch</div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>`;

    // Simulate phase updates
    const phases = ['Phase 1: Parallel scanner fetch', 'Simple Scanner + Volume Profile...', 'MTF + Order Flow...', 'Options Flow + War Room...', 'Phase 2: AI Trade Plan', 'Parsing & reconciling...'];
    let phase = 0;
    const phaseTimer = setInterval(() => {
        const el = document.getElementById('card-load-phase');
        if (el) el.textContent = phases[Math.min(++phase, phases.length - 1)];
    }, 4000);

    try {
        const t0 = performance.now();
        const res = await fetch(`${API_BASE}/api/card/${sym}/both?trade_tf=${tf}`);
        clearInterval(phaseTimer);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();
        const elapsed = ((performance.now() - t0) / 1000).toFixed(1);

        // Extract body content
        const match = html.match(/<body>([\s\S]*?)<\/body>/);
        body.innerHTML = match ? match[1] : html;

        // Scale cards to fit panel
        body.querySelectorAll('.card').forEach(c => {
            c.style.width = '100%';
            c.style.maxWidth = '480px';
            c.style.margin = '0 auto 16px';
        });

        lastCardSymbol = sym;
        title.textContent = `${sym} ‚Äî ${elapsed}s`;
        status.textContent = `‚úì ${sym} ready`;
        status.style.color = 'var(--green)';
        applyCardView();

    } catch (err) {
        clearInterval(phaseTimer);
        body.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red)">Error: ${err.message}</div>`;
        status.textContent = 'Error';
        status.style.color = 'var(--red)';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generate';
    }
}

function closeCardPanel() {
    document.getElementById('card-slide-panel').style.display = 'none';
}

function toggleCardView() {
    const views = ['both', 'thesis', 'execution'];
    const idx = views.indexOf(cardPanelView);
    cardPanelView = views[(idx + 1) % views.length];
    document.getElementById('card-view-btn').textContent = cardPanelView.charAt(0).toUpperCase() + cardPanelView.slice(1);
    applyCardView();
}

function applyCardView() {
    const cards = document.querySelectorAll('#card-panel-body .card');
    cards.forEach((card, i) => {
        if (cardPanelView === 'both') card.style.display = '';
        else if (cardPanelView === 'thesis') card.style.display = i === 0 ? '' : 'none';
        else if (cardPanelView === 'execution') card.style.display = i === 1 ? '' : 'none';
    });
}

function openCardFullPage() {
    if (lastCardSymbol) {
        const tf = document.getElementById('desk-card-tf').value;
        window.open(`/cards?symbol=${lastCardSymbol}&tf=${tf}`, '_blank');
    } else {
        window.open('/cards', '_blank');
    }
}

// Close panel on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeCardPanel();
    if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        toggleKillSwitch();
    }
});

// ===== AI KILL SWITCH =====
let aiKilled = false;

async function checkKillSwitch() {
    try {
        const res = await fetch(`${API_BASE}/api/config/ai-kill-switch`);
        if (res.ok) {
            const data = await res.json();
            aiKilled = data.killed;
            updateKillSwitchUI();
        }
    } catch (e) {
        console.warn('Kill switch check failed:', e);
    }
}

async function toggleKillSwitch() {
    const wrap = document.getElementById('kill-switch');
    wrap.style.opacity = '0.5';
    wrap.style.pointerEvents = 'none';
    
    try {
        const res = await fetch(`${API_BASE}/api/config/ai-kill-switch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                killed: !aiKilled,
                reason: aiKilled ? 'Re-enabled from Trade Desk' : 'Killed from Trade Desk'
            })
        });
        if (res.ok) {
            const data = await res.json();
            aiKilled = data.killed;
            updateKillSwitchUI();
            
            // Flash confirmation
            wrap.style.transform = 'scale(1.05)';
            setTimeout(() => wrap.style.transform = '', 200);
        }
    } catch (e) {
        console.error('Kill switch toggle failed:', e);
    } finally {
        wrap.style.opacity = '1';
        wrap.style.pointerEvents = 'auto';
    }
}

function updateKillSwitchUI() {
    const wrap = document.getElementById('kill-switch');
    const icon = document.getElementById('kill-switch-icon');
    const label = document.getElementById('kill-switch-label');
    const status = document.getElementById('kill-switch-status');
    
    if (aiKilled) {
        wrap.className = 'kill-switch-wrap ai-off';
        icon.textContent = 'üö´';
        label.textContent = 'AI OFF';
        status.textContent = 'Rules Only';
        wrap.title = 'AI KILLED ‚Äî Using deterministic rules. Click to re-enable. (Ctrl+K)';
    } else {
        wrap.className = 'kill-switch-wrap ai-on';
        icon.textContent = 'ü§ñ';
        label.textContent = 'AI ON';
        status.textContent = 'Claude + GPT';
        wrap.title = 'AI Active ‚Äî Click to kill switch. (Ctrl+K)';
    }
}

// Check on load
checkKillSwitch();
// Poll every 30s in case changed from another client
setInterval(checkKillSwitch, 30000);
</script>
</body>
</html>
