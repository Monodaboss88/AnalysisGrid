<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Decision Point ‚Äî Capital Growth</title>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-primary: #0a0e17;
    --bg-card: #111827;
    --bg-card-alt: #0f1525;
    --bg-input: #1a2236;
    --border: #1e2a42;
    --border-focus: #3b82f6;
    --text-primary: #e2e8f0;
    --text-secondary: #8892a8;
    --text-muted: #4a5568;
    --green: #10b981;
    --green-dim: #065f46;
    --green-glow: rgba(16, 185, 129, 0.15);
    --red: #ef4444;
    --red-dim: #7f1d1d;
    --blue: #3b82f6;
    --blue-dim: #1e3a5f;
    --amber: #f59e0b;
    --amber-dim: #78350f;
    --purple: #8b5cf6;
    --purple-dim: #4c1d95;
    --cyan: #06b6d4;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Outfit', sans-serif;
    background: 
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1400' height='800' viewBox='0 0 1400 800'%3E%3Crect width='1400' height='800' fill='%230f172a'/%3E%3Cdefs%3E%3ClinearGradient id='fade' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%230a0e17' stop-opacity='0.6'/%3E%3Cstop offset='15%25' stop-color='%230a0e17' stop-opacity='0'/%3E%3Cstop offset='85%25' stop-color='%230a0e17' stop-opacity='0'/%3E%3Cstop offset='100%25' stop-color='%230a0e17' stop-opacity='0.9'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cg stroke='%231e293b' stroke-width='0.5' opacity='0.6'%3E%3Cline x1='0' y1='160' x2='1400' y2='160'/%3E%3Cline x1='0' y1='300' x2='1400' y2='300'/%3E%3Cline x1='0' y1='440' x2='1400' y2='440'/%3E%3Cline x1='0' y1='580' x2='1400' y2='580'/%3E%3Cline x1='200' y1='80' x2='200' y2='720'/%3E%3Cline x1='400' y1='80' x2='400' y2='720'/%3E%3Cline x1='600' y1='80' x2='600' y2='720'/%3E%3Cline x1='800' y1='80' x2='800' y2='720'/%3E%3Cline x1='1000' y1='80' x2='1000' y2='720'/%3E%3Cline x1='1200' y1='80' x2='1200' y2='720'/%3E%3C/g%3E%3Crect width='1400' height='800' fill='url(%23fade)'/%3E%3C/svg%3E"),
        linear-gradient(135deg, #0a0e17 0%, #0f1d32 100%);
    background-size: 100% auto, 100% 100%;
    background-position: center top, center center;
    background-repeat: no-repeat, no-repeat;
    background-attachment: fixed, fixed;
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
}

.app { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 24px; }

/* Header */
.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
}
.header-left { display: flex; align-items: center; gap: 16px; }
.logo {
    width: 44px; height: 44px;
    background: linear-gradient(135deg, var(--green), var(--cyan));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 20px; color: #0a0e17;
}
.header h1 { font-size: 22px; font-weight: 600; letter-spacing: -0.5px; }
.header p { color: var(--text-secondary); font-size: 13px; margin-top: 2px; }

.header-right { display: flex; gap: 10px; }
.period-btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 8px 16px;
    border-radius: 8px;
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}
.period-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
.period-btn.active { background: var(--blue); border-color: var(--blue); color: white; }

/* Stat Cards Row */
.stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 14px;
    margin-bottom: 28px;
}
.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
}
.stat-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
}
.stat-card.green::after { background: var(--green); }
.stat-card.blue::after { background: var(--blue); }
.stat-card.amber::after { background: var(--amber); }
.stat-card.purple::after { background: var(--purple); }
.stat-card.cyan::after { background: var(--cyan); }

.stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}
.stat-value {
    font-family: 'DM Mono', monospace;
    font-size: 24px;
    font-weight: 500;
}
.stat-sub {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    margin-top: 4px;
}
.positive { color: var(--green); }
.negative { color: var(--red); }
.neutral { color: var(--text-secondary); }

/* Main Grid */
.main-grid {
    display: grid;
    grid-template-columns: 380px minmax(0, 1fr);
    gap: 20px;
}

/* Left Panel - Entry + Projector */
.left-panel { display: flex; flex-direction: column; gap: 20px; min-width: 0; overflow: hidden; }

.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 22px;
    min-width: 0;
    overflow: hidden;
}
.card-title {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-secondary);
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.card-title .icon { font-size: 16px; }

/* Daily Entry */
.entry-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 12px;
}
.input-group { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
.input-group label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
}
.input-group input, .input-group select {
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--text-primary);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    padding: 10px 12px;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}
.input-group input:focus, .input-group select:focus { border-color: var(--border-focus); }
.input-group input::placeholder { color: var(--text-muted); }

.full-width { grid-column: 1 / -1; }

.btn-add {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--green), #059669);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 4px;
}
.btn-add:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3); }

/* Goal Engineer */
.goal-section-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text-muted);
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid rgba(30, 42, 66, 0.5);
}
.goal-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
}
.goal-breakdown {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 16px;
}
.goal-break-box {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 6px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.goal-break-box::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
}
.goal-break-box.daily::before { background: var(--green); }
.goal-break-box.weekly::before { background: var(--blue); }
.goal-break-box.monthly::before { background: var(--purple); }
.goal-period { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
.goal-dollar { font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 500; }
.goal-pct { font-family: 'DM Mono', monospace; font-size: 11px; margin-top: 3px; }
.goal-break-box.daily .goal-dollar { color: var(--green); }
.goal-break-box.daily .goal-pct { color: #6ee7b7; }
.goal-break-box.weekly .goal-dollar { color: var(--blue); }
.goal-break-box.weekly .goal-pct { color: #93c5fd; }
.goal-break-box.monthly .goal-dollar { color: var(--purple); }
.goal-break-box.monthly .goal-pct { color: #c4b5fd; }

/* Pace tracker */
.goal-pace {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 16px;
}
.pace-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.pace-left { font-size: 11px; color: var(--text-secondary); }
.pace-status { font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 500; }
.pace-bar {
    height: 8px;
    background: rgba(30, 42, 66, 0.8);
    border-radius: 4px;
    position: relative;
    overflow: visible;
}
.pace-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--green), var(--cyan));
    transition: width 0.4s ease;
    max-width: 100%;
}
.pace-target {
    position: absolute;
    top: -3px;
    bottom: -3px;
    width: 2px;
    background: var(--amber);
    border-radius: 1px;
    transition: left 0.4s ease;
}
.pace-labels { display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; }
.pace-earned { color: var(--green); font-family: 'DM Mono', monospace; }
.pace-remaining { color: var(--text-secondary); font-family: 'DM Mono', monospace; }

/* Reality check */
.goal-reality {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}
.goal-reality-box {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 6px;
    text-align: center;
    min-width: 0;
}
.gr-label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 4px; }
.gr-value { font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 500; }
.gr-sub { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text-muted); margin-top: 2px; }

/* Right Panel - Log + Chart */
.right-panel { display: flex; flex-direction: column; gap: 20px; }

/* Chart area */
.chart-container {
    height: 220px;
    position: relative;
    margin-bottom: 8px;
}
.chart-canvas { width: 100%; height: 100%; }

/* Log table */
.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}
.log-header .card-title { margin-bottom: 0; }
.log-filter {
    display: flex; gap: 6px;
}
.filter-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 4px 10px;
    border-radius: 6px;
    font-family: 'Outfit', sans-serif;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
}
.filter-btn:hover { color: var(--text-secondary); border-color: var(--text-secondary); }
.filter-btn.active { background: var(--bg-input); color: var(--text-primary); border-color: var(--border-focus); }

.log-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.log-table thead th {
    text-align: left;
    padding: 8px 12px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    font-weight: 500;
}
.log-table tbody tr {
    border-bottom: 1px solid rgba(30, 42, 66, 0.5);
    transition: background 0.15s;
}
.log-table tbody tr:hover { background: rgba(59, 130, 246, 0.05); }
.log-table td {
    padding: 10px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
}
.log-table .date-col { color: var(--text-secondary); font-family: 'Outfit', sans-serif; }
.log-table .note-col { color: var(--text-muted); font-family: 'Outfit', sans-serif; font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 3px; }

.tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.tag.win { background: var(--green-dim); color: var(--green); }
.tag.loss { background: var(--red-dim); color: var(--red); }

.delete-btn {
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.15s;
}
.delete-btn:hover { color: var(--red); background: var(--red-dim); }

/* Streak + Win Rate row */
.metrics-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 0;
}
.metric-box {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    text-align: center;
}
.metric-box .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
    margin-bottom: 4px;
}
.metric-box .value {
    font-family: 'DM Mono', monospace;
    font-size: 18px;
    font-weight: 500;
}

/* Small win appreciation banner */
.appreciation-banner {
    background: linear-gradient(135deg, var(--green-dim), rgba(6, 95, 70, 0.3));
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 10px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    margin-top: 16px;
    animation: fadeIn 0.3s ease;
}
.appreciation-banner .emoji { font-size: 28px; flex-shrink: 0; }
.appreciation-banner .text { font-size: 13px; color: var(--green); line-height: 1.5; }
.appreciation-banner .text strong { color: #6ee7b7; }

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 14px;
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* Responsive */
@media (max-width: 1100px) {
    .main-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 700px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .entry-row { grid-template-columns: 1fr; }
    .goal-inputs { grid-template-columns: 1fr; }
    .goal-breakdown { grid-template-columns: repeat(3, 1fr); }
    .goal-reality { grid-template-columns: repeat(3, 1fr); }
    .metrics-row { grid-template-columns: repeat(2, 1fr); }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Ticker dropdown */
.ticker-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg-input);
    border: 1px solid var(--border-focus);
    border-top: none;
    border-radius: 0 0 8px 8px;
    z-index: 100;
}
.ticker-dropdown .ticker-item {
    padding: 8px 12px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    color: var(--text-primary);
    display: flex;
    justify-content: space-between;
    transition: background 0.1s;
}
.ticker-dropdown .ticker-item:hover { background: rgba(59, 130, 246, 0.1); }
.ticker-dropdown .ticker-item .ticker-sym { font-weight: 500; }
.ticker-dropdown .ticker-item .ticker-cat { font-size: 10px; color: var(--text-muted); }
.ticker-dropdown .ticker-section {
    padding: 4px 12px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    background: rgba(30, 42, 66, 0.5);
    position: sticky;
    top: 0;
}

/* Entry tags in log */
.entry-meta {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-wrap: wrap;
}
.meta-tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.3px;
}
.meta-tag.ticker { background: var(--blue-dim); color: var(--blue); }
.meta-tag.contracts { background: var(--purple-dim); color: var(--purple); }
.meta-tag.type { background: var(--amber-dim); color: var(--amber); }
</style>
</head>
<body>
<div class="app">

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">G</div>
            <div>
                <h1>Capital Growth Engine</h1>
                <p>Track the math. Appreciate the compound. <span id="sync-status" style="font-size:11px;margin-left:6px;">‚è≥ connecting...</span></p>
            </div>
        </div>
        <div class="header-right">
            <a href="/desk" style="background: linear-gradient(135deg, #1e1b4b, #3730a3); border: 1px solid #6366f1; color: #e2e8f0; padding: 8px 16px; border-radius: 8px; font-family: 'Outfit', sans-serif; font-size: 13px; cursor: pointer; text-decoration: none; transition: all 0.2s;">üè† Trade Desk</a>
            <a href="/simple.html" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; font-family: 'Outfit', sans-serif; font-size: 13px; cursor: pointer; text-decoration: none; transition: all 0.2s;">üéØ Scanner</a>
            <button class="period-btn active" onclick="setPeriod('week')">Week</button>
            <button class="period-btn" onclick="setPeriod('month')">Month</button>
            <button class="period-btn" onclick="setPeriod('year')">Year</button>
            <button class="period-btn" onclick="setPeriod('all')">All</button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card green">
            <div class="stat-label">Net P&L</div>
            <div class="stat-value" id="stat-pnl">$0.00</div>
            <div class="stat-sub neutral" id="stat-pnl-pct">0.00% total</div>
            <div class="stat-sub neutral" id="stat-avg-daily-pct" style="margin-top:2px;">Avg: 0.00%/day</div>
        </div>
        <div class="stat-card blue">
            <div class="stat-label">Starting Capital</div>
            <div class="stat-value" id="stat-capital">$0.00</div>
            <div class="stat-sub neutral" id="stat-current">Current: $0.00</div>
        </div>
        <div class="stat-card amber">
            <div class="stat-label">Trade Days</div>
            <div class="stat-value" id="stat-days">0</div>
            <div class="stat-sub neutral" id="stat-avg-day">Avg/day: $0.00</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-label">Best Day</div>
            <div class="stat-value positive" id="stat-best">$0.00</div>
            <div class="stat-sub neutral" id="stat-best-date">‚Äî</div>
        </div>
        <div class="stat-card cyan">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value" id="stat-winrate">0%</div>
            <div class="stat-sub neutral" id="stat-record">0W ‚Äî 0L</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">

        <!-- Left Panel -->
        <div class="left-panel">

            <!-- Daily Entry -->
            <div class="card">
                <div class="card-title"><span class="icon">üìù</span> Log Daily P&L</div>
                <div class="entry-row">
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="entry-date">
                    </div>
                    <div class="input-group">
                        <label>P&L ($)</label>
                        <input type="number" id="entry-pnl" placeholder="+350 or -120" step="0.01">
                    </div>
                </div>
                <div class="entry-row">
                    <div class="input-group">
                        <label>Contracts</label>
                        <select id="entry-contracts">
                            <option value="">‚Äî</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Ticker</label>
                        <div style="position:relative;">
                            <input type="text" id="entry-ticker" placeholder="Search..." autocomplete="off" oninput="filterTickers(this.value)" onfocus="showTickerDropdown()" onblur="hideTickerDropdown()" list="">
                            <div id="ticker-dropdown" class="ticker-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                </div>
                <div class="entry-row">
                    <div class="input-group">
                        <label>Type</label>
                        <select id="entry-type">
                            <option value="">‚Äî</option>
                            <option value="Calls">Calls</option>
                            <option value="Puts">Puts</option>
                            <option value="Shares">Shares</option>
                            <option value="Spread">Spread</option>
                            <option value="Iron Condor">Iron Condor</option>
                            <option value="Straddle">Straddle</option>
                            <option value="Scalp">Scalp</option>
                            <option value="Swing">Swing</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Note (optional)</label>
                        <input type="text" id="entry-note" placeholder="e.g. caught VAL bounce">
                    </div>
                </div>
                <button class="btn-add" onclick="addEntry()">Log Entry</button>
            </div>

            <!-- Goal Engineer -->
            <div class="card">
                <div class="card-title"><span class="icon">üéØ</span> Goal Engineer</div>
                
                <div class="goal-section-label">Define Your Target</div>
                <div class="goal-inputs">
                    <div class="input-group">
                        <label>Profit Goal ($)</label>
                        <input type="number" id="goal-profit" placeholder="5000" value="5000" oninput="updateGoalEngineer()">
                    </div>
                    <div class="input-group">
                        <label>Timeframe</label>
                        <select id="goal-timeframe" oninput="updateGoalEngineer()">
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                </div>

                <div class="goal-section-label">What You Need</div>
                <div class="goal-breakdown">
                    <div class="goal-break-box daily">
                        <div class="goal-period">Daily</div>
                        <div class="goal-dollar" id="goal-daily-dollar">$0.00</div>
                        <div class="goal-pct" id="goal-daily-pct">0.00%</div>
                    </div>
                    <div class="goal-break-box weekly">
                        <div class="goal-period">Weekly</div>
                        <div class="goal-dollar" id="goal-weekly-dollar">$0.00</div>
                        <div class="goal-pct" id="goal-weekly-pct">0.00%</div>
                    </div>
                    <div class="goal-break-box monthly">
                        <div class="goal-period">Monthly</div>
                        <div class="goal-dollar" id="goal-monthly-dollar">$0.00</div>
                        <div class="goal-pct" id="goal-monthly-pct">0.00%</div>
                    </div>
                </div>

                <!-- Pace Tracker -->
                <div class="goal-section-label">Pace Tracker</div>
                <div class="goal-pace">
                    <div class="pace-header">
                        <span class="pace-left" id="goal-pace-days">0 of 0 days</span>
                        <span class="pace-status" id="goal-pace-status">‚Äî</span>
                    </div>
                    <div class="pace-bar">
                        <div class="pace-fill" id="goal-pace-fill" style="width:0%"></div>
                        <div class="pace-target" id="goal-pace-target" style="left:0%"></div>
                    </div>
                    <div class="pace-labels">
                        <span class="pace-earned" id="goal-pace-earned">$0 earned</span>
                        <span class="pace-remaining" id="goal-pace-remaining">$0 remaining</span>
                    </div>
                </div>

                <!-- Reality Check -->
                <div class="goal-section-label">Reality Check</div>
                <div class="goal-reality">
                    <div class="goal-reality-box">
                        <div class="gr-label">Your Avg Day</div>
                        <div class="gr-value" id="goal-avg-day">$0.00</div>
                        <div class="gr-sub" id="goal-avg-vs">‚Äî</div>
                    </div>
                    <div class="goal-reality-box">
                        <div class="gr-label">Adjusted Target</div>
                        <div class="gr-value" id="goal-adjusted">$0.00</div>
                        <div class="gr-sub">per remaining day</div>
                    </div>
                    <div class="goal-reality-box">
                        <div class="gr-label">On Track For</div>
                        <div class="gr-value" id="goal-projected">$0.00</div>
                        <div class="gr-sub">at current pace</div>
                    </div>
                </div>
            </div>

            <!-- Capital Setup -->
            <div class="card">
                <div class="card-title"><span class="icon">‚öôÔ∏è</span> Starting Capital</div>
                <div class="entry-row">
                    <div class="input-group">
                        <label>Amount</label>
                        <input type="number" id="setup-capital" placeholder="10000" step="0.01">
                    </div>
                    <div class="input-group" style="justify-content: flex-end;">
                        <label>&nbsp;</label>
                        <button class="btn-add" style="background: var(--blue); padding: 10px 16px;" onclick="setCapital()">Set</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">

            <!-- Equity Chart -->
            <div class="card">
                <div class="card-title"><span class="icon">üìà</span> Equity Curve</div>
                <div class="chart-container">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <!-- Metrics Row -->
            <div class="card">
                <div class="metrics-row">
                    <div class="metric-box">
                        <div class="label">Win Streak</div>
                        <div class="value positive" id="m-streak">0</div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Avg Win</div>
                        <div class="value positive" id="m-avg-win">$0</div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Avg Loss</div>
                        <div class="value negative" id="m-avg-loss">$0</div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Profit Factor</div>
                        <div class="value" id="m-profit-factor" style="color: var(--cyan)">0.0</div>
                    </div>
                </div>
            </div>

            <!-- Trade Log -->
            <div class="card" style="flex: 1;">
                <div class="log-header">
                    <div class="card-title" style="margin-bottom: 0;"><span class="icon">üìã</span> Daily Log</div>
                    <div class="log-filter">
                        <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
                        <button class="filter-btn" onclick="setFilter('wins', this)">Wins</button>
                        <button class="filter-btn" onclick="setFilter('losses', this)">Losses</button>
                    </div>
                </div>
                <div id="log-body">
                    <div class="empty-state">No entries yet. Log your first day above.</div>
                </div>

                <!-- Appreciation banner -->
                <div id="appreciation-banner" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// ========== TICKER LIST ==========
const TICKERS = {
    'Mag 7': ['AAPL','MSFT','GOOGL','AMZN','NVDA','META','TSLA'],
    'Active Options': ['AMD','CRM','NFLX','SHOP','SQ','COIN','PLTR','SNAP','UBER','BA','DIS','PYPL','BABA','NIO','SOFI','RIVN','LCID','INTC','MU','QCOM'],
    'ETFs': ['SPY','QQQ','IWM','DIA','TLT','GLD','SLV','XLF','XLE','XLK','XLV','XLI','XLP','XLU','XLRE','SMH','SOXX','ARKK','HYG','EEM','VIX','UVXY','SQQQ','TQQQ'],
    'Dow 30': ['UNH','GS','HD','AMGN','MCD','CAT','V','CRM','TRV','AXP','JPM','IBM','WMT','JNJ','PG','CVX','MRK','KO','DOW','MMM'],
    'Recents': [] // populated from entries
};

let tickerDropdownVisible = false;

function getRecentTickers() {
    const tickers = {};
    for (const e of state.entries) {
        if (e.ticker) tickers[e.ticker] = (tickers[e.ticker] || 0) + 1;
    }
    return Object.entries(tickers)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 10)
        .map(([t]) => t);
}

function showTickerDropdown() {
    tickerDropdownVisible = true;
    filterTickers(document.getElementById('entry-ticker').value);
}

function hideTickerDropdown() {
    setTimeout(() => {
        tickerDropdownVisible = false;
        document.getElementById('ticker-dropdown').style.display = 'none';
    }, 200);
}

function filterTickers(query) {
    const dropdown = document.getElementById('ticker-dropdown');
    if (!tickerDropdownVisible) { dropdown.style.display = 'none'; return; }
    
    query = query.toUpperCase().trim();
    let html = '';
    
    // Add recents
    const recents = getRecentTickers();
    if (recents.length > 0 && (!query || recents.some(t => t.includes(query)))) {
        const filtered = query ? recents.filter(t => t.includes(query)) : recents;
        if (filtered.length > 0) {
            html += '<div class="ticker-section">Recent</div>';
            for (const t of filtered) {
                html += `<div class="ticker-item" onmousedown="selectTicker('${t}')"><span class="ticker-sym">${t}</span><span class="ticker-cat">recent</span></div>`;
            }
        }
    }
    
    // Add categorized tickers
    for (const [cat, tickers] of Object.entries(TICKERS)) {
        if (cat === 'Recents') continue;
        const filtered = query ? tickers.filter(t => t.includes(query)) : tickers;
        if (filtered.length > 0) {
            html += `<div class="ticker-section">${cat}</div>`;
            for (const t of filtered.slice(0, query ? 20 : 8)) {
                html += `<div class="ticker-item" onmousedown="selectTicker('${t}')"><span class="ticker-sym">${t}</span><span class="ticker-cat">${cat.toLowerCase()}</span></div>`;
            }
        }
    }
    
    // Allow custom ticker if typed and not found
    if (query.length >= 1 && !html.includes(`>${query}<`)) {
        html = `<div class="ticker-item" onmousedown="selectTicker('${query}')"><span class="ticker-sym">${query}</span><span class="ticker-cat">custom</span></div>` + html;
    }
    
    if (!html) {
        dropdown.style.display = 'none';
        return;
    }
    
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
}

function selectTicker(ticker) {
    document.getElementById('entry-ticker').value = ticker;
    document.getElementById('ticker-dropdown').style.display = 'none';
    tickerDropdownVisible = false;
}

// Close dropdown on outside click
document.addEventListener('click', (e) => {
    if (!e.target.closest('#entry-ticker') && !e.target.closest('#ticker-dropdown')) {
        document.getElementById('ticker-dropdown').style.display = 'none';
        tickerDropdownVisible = false;
    }
});

// ========== FIREBASE ==========
const firebaseConfig = {
    apiKey: "AIzaSyB4oBeoFzFV2oS5ZxEvQ4TIRRVJFC3nl-w",
    authDomain: "analysis-grid.firebaseapp.com",
    projectId: "analysis-grid",
    storageBucket: "analysis-grid.firebasestorage.app",
    messagingSenderId: "633207767657",
    appId: "1:633207767657:web:e623871eca352a268b58f8"
};

let db = null;
let auth = null;
let currentUser = null;
let firebaseReady = false;

function getFirebaseDoc() {
    if (currentUser) return `users/${currentUser.uid}/capital_growth/state`;
    return null;
}

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    firebaseReady = true;
    
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
            console.log('‚úÖ Logged in as:', user.email || `anonymous (${user.uid.slice(0,8)})`);
            setSyncStatus('‚òÅÔ∏è authenticated', 'var(--green)');
            // Re-load from Firebase now that we're authed
            loadState();
        } else {
            // Try anonymous sign-in
            auth.signInAnonymously().catch(e => {
                console.warn('Anonymous auth failed, using local fallback:', e.message);
                let localUid = localStorage.getItem('localUserUid');
                if (!localUid) {
                    localUid = 'local_' + Math.random().toString(36).slice(2, 10);
                    localStorage.setItem('localUserUid', localUid);
                }
                currentUser = { uid: localUid, _isLocal: true };
                setSyncStatus('üíæ local only', 'var(--text-muted)');
            });
        }
    });
} catch(e) {
    console.warn('Firebase init failed, using localStorage only:', e);
}

function setSyncStatus(status, color) {
    const el = document.getElementById('sync-status');
    if (el) {
        el.textContent = status;
        el.style.color = color || 'var(--text-muted)';
    }
}

// ========== STATE ==========
let state = {
    capital: 0,
    entries: [],
    period: 'week',
    filter: 'all'
};

// Load: try Firebase first, fall back to localStorage
async function loadState() {
    // Always load localStorage first (instant)
    const saved = localStorage.getItem('capital-growth-engine');
    if (saved) {
        try { state = JSON.parse(saved); } catch(e) {}
    }
    
    // Apply state to UI immediately
    applyStateToUI();
    
    // Then try Firebase (async)
    const fbDoc = getFirebaseDoc();
    if (firebaseReady && db && fbDoc && currentUser && !currentUser._isLocal) {
        try {
            setSyncStatus('‚è≥ syncing...', 'var(--amber)');
            const doc = await db.doc(fbDoc).get();
            if (doc.exists) {
                const fbState = doc.data();
                // Firebase data has entries as JSON string (Firestore has 1MB doc limit)
                if (fbState.entries_json) {
                    fbState.entries = JSON.parse(fbState.entries_json);
                    delete fbState.entries_json;
                }
                
                // Merge: use whichever has more entries (most up to date)
                const localEntries = state.entries ? state.entries.length : 0;
                const fbEntries = fbState.entries ? fbState.entries.length : 0;
                
                if (fbEntries > localEntries) {
                    state = fbState;
                    localStorage.setItem('capital-growth-engine', JSON.stringify(state));
                    applyStateToUI();
                    refreshAll();
                    setSyncStatus('‚òÅÔ∏è loaded from cloud', 'var(--green)');
                } else if (localEntries > fbEntries) {
                    // Local is newer, push to Firebase
                    await saveToFirebase();
                    setSyncStatus('‚òÅÔ∏è synced', 'var(--green)');
                } else {
                    setSyncStatus('‚òÅÔ∏è synced', 'var(--green)');
                }
            } else {
                // No Firebase data yet, push local up
                if (state.entries.length > 0 || state.capital > 0) {
                    await saveToFirebase();
                }
                setSyncStatus('‚òÅÔ∏è synced', 'var(--green)');
            }
        } catch(e) {
            console.warn('Firebase load failed:', e);
            setSyncStatus('‚ö†Ô∏è offline (local)', 'var(--amber)');
        }
    } else {
        setSyncStatus('üíæ local only', 'var(--text-muted)');
    }
}

function applyStateToUI() {
    document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
    if (state.capital) {
        document.getElementById('setup-capital').value = state.capital;
    }
    if (state.goalProfit) {
        document.getElementById('goal-profit').value = state.goalProfit;
    }
    if (state.goalTimeframe) {
        document.getElementById('goal-timeframe').value = state.goalTimeframe;
    }
}

// Save: localStorage immediately, Firebase in background
let saveTimeout = null;
function saveState() {
    localStorage.setItem('capital-growth-engine', JSON.stringify(state));
    
    // Debounce Firebase writes (wait 1.5s after last change)
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        saveToFirebase();
    }, 1500);
}

async function saveToFirebase() {
    const fbDoc = getFirebaseDoc();
    if (!firebaseReady || !db || !fbDoc || !currentUser || currentUser._isLocal) return;
    
    try {
        setSyncStatus('‚è≥ saving...', 'var(--amber)');
        
        // Store entries as JSON string to avoid Firestore array limits
        const docData = {
            capital: state.capital || 0,
            period: state.period || 'week',
            filter: state.filter || 'all',
            goalProfit: state.goalProfit || 0,
            goalTimeframe: state.goalTimeframe || 'month',
            entries_json: JSON.stringify(state.entries || []),
            entry_count: (state.entries || []).length,
            last_updated: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.doc(fbDoc).set(docData);
        setSyncStatus('‚òÅÔ∏è synced', 'var(--green)');
    } catch(e) {
        console.warn('Firebase save failed:', e);
        setSyncStatus('‚ö†Ô∏è save failed', 'var(--red)');
        // Data is safe in localStorage, will retry next save
    }
}

// ========== ENTRY MANAGEMENT ==========
function addEntry() {
    const date = document.getElementById('entry-date').value;
    const pnl = parseFloat(document.getElementById('entry-pnl').value);
    const contracts = document.getElementById('entry-contracts').value;
    const ticker = document.getElementById('entry-ticker').value.toUpperCase().trim();
    const type = document.getElementById('entry-type').value;
    const note = document.getElementById('entry-note').value.trim();

    if (!date || isNaN(pnl)) {
        shakeElement(document.getElementById('entry-pnl'));
        return;
    }

    state.entries.push({ date, pnl, contracts, ticker, type, note, id: Date.now() });
    state.entries.sort((a, b) => a.date.localeCompare(b.date));
    saveState();
    
    // Clear inputs (keep date for fast multi-entry)
    document.getElementById('entry-pnl').value = '';
    document.getElementById('entry-contracts').value = '';
    document.getElementById('entry-ticker').value = '';
    document.getElementById('entry-type').value = '';
    document.getElementById('entry-note').value = '';
    
    refreshAll();
}

function deleteEntry(id) {
    state.entries = state.entries.filter(e => e.id !== id);
    saveState();
    refreshAll();
}

function setCapital() {
    const val = parseFloat(document.getElementById('setup-capital').value);
    if (isNaN(val) || val <= 0) return;
    state.capital = val;
    saveState();
    refreshAll();
}

function shakeElement(el) {
    el.style.borderColor = 'var(--red)';
    el.style.animation = 'none';
    el.offsetHeight;
    el.style.animation = 'shake 0.4s ease';
    setTimeout(() => { el.style.borderColor = ''; }, 1500);
}

// ========== PERIOD FILTERING ==========
function setPeriod(p) {
    state.period = p;
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    refreshAll();
}

function setFilter(f, btn) {
    state.filter = f;
    document.querySelectorAll('.log-filter .filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    refreshAll();
}

function getFilteredEntries() {
    const now = new Date();
    let start;
    
    switch(state.period) {
        case 'week':
            start = new Date(now);
            start.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
            start.setHours(0,0,0,0);
            break;
        case 'month':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case 'year':
            start = new Date(now.getFullYear(), 0, 1);
            break;
        case 'all':
        default:
            start = new Date('2000-01-01');
    }
    
    const startStr = start.toISOString().split('T')[0];
    return state.entries.filter(e => e.date >= startStr);
}

// ========== STATS CALCULATION ==========
function refreshAll() {
    const entries = getFilteredEntries();
    const allEntries = state.entries;
    
    // Net P&L
    const netPnl = entries.reduce((sum, e) => sum + e.pnl, 0);
    const pnlPct = state.capital > 0 ? (netPnl / state.capital * 100) : 0;
    const currentCapital = state.capital + allEntries.reduce((sum, e) => sum + e.pnl, 0);
    
    const pnlEl = document.getElementById('stat-pnl');
    pnlEl.textContent = formatMoney(netPnl);
    pnlEl.className = `stat-value ${netPnl >= 0 ? 'positive' : 'negative'}`;
    
    const pctEl = document.getElementById('stat-pnl-pct');
    pctEl.textContent = `${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}% total`;
    pctEl.className = `stat-sub ${pnlPct >= 0 ? 'positive' : 'negative'}`;
    
    // Avg daily percentage
    const avgDailyPct = entries.length > 0 && state.capital > 0 
        ? (pnlPct / entries.length) 
        : 0;
    const avgDailyPctEl = document.getElementById('stat-avg-daily-pct');
    avgDailyPctEl.textContent = `Avg: ${avgDailyPct >= 0 ? '+' : ''}${avgDailyPct.toFixed(2)}%/day`;
    avgDailyPctEl.className = `stat-sub ${avgDailyPct >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('stat-capital').textContent = formatMoney(state.capital);
    document.getElementById('stat-current').textContent = `Current: ${formatMoney(currentCapital)}`;
    
    // Trade days
    const days = entries.length;
    const avgDay = days > 0 ? netPnl / days : 0;
    document.getElementById('stat-days').textContent = days;
    const avgDayEl = document.getElementById('stat-avg-day');
    avgDayEl.textContent = `Avg/day: ${formatMoney(avgDay)}`;
    avgDayEl.className = `stat-sub ${avgDay >= 0 ? 'positive' : 'negative'}`;
    
    // Best day
    if (entries.length > 0) {
        const best = entries.reduce((max, e) => e.pnl > max.pnl ? e : max, entries[0]);
        document.getElementById('stat-best').textContent = formatMoney(best.pnl);
        document.getElementById('stat-best-date').textContent = formatDate(best.date);
    } else {
        document.getElementById('stat-best').textContent = '$0.00';
        document.getElementById('stat-best-date').textContent = '‚Äî';
    }
    
    // Win rate
    const wins = entries.filter(e => e.pnl > 0).length;
    const losses = entries.filter(e => e.pnl < 0).length;
    const winrate = days > 0 ? (wins / days * 100) : 0;
    document.getElementById('stat-winrate').textContent = `${winrate.toFixed(0)}%`;
    document.getElementById('stat-record').textContent = `${wins}W ‚Äî ${losses}L`;
    
    // Metrics
    const winAmounts = entries.filter(e => e.pnl > 0).map(e => e.pnl);
    const lossAmounts = entries.filter(e => e.pnl < 0).map(e => e.pnl);
    const avgWin = winAmounts.length > 0 ? winAmounts.reduce((a,b) => a+b, 0) / winAmounts.length : 0;
    const avgLoss = lossAmounts.length > 0 ? lossAmounts.reduce((a,b) => a+b, 0) / lossAmounts.length : 0;
    const totalWins = winAmounts.reduce((a,b) => a+b, 0);
    const totalLosses = Math.abs(lossAmounts.reduce((a,b) => a+b, 0));
    const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? 999 : 0;
    
    // Current streak
    let streak = 0;
    const sorted = [...entries].sort((a,b) => b.date.localeCompare(a.date));
    if (sorted.length > 0) {
        const dir = sorted[0].pnl >= 0 ? 'win' : 'loss';
        for (const e of sorted) {
            if ((dir === 'win' && e.pnl >= 0) || (dir === 'loss' && e.pnl < 0)) {
                streak++;
            } else break;
        }
        if (dir === 'loss') streak = -streak;
    }
    
    const streakEl = document.getElementById('m-streak');
    streakEl.textContent = streak > 0 ? `${streak}üî•` : `${Math.abs(streak)}`;
    streakEl.className = `value ${streak >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('m-avg-win').textContent = formatMoney(avgWin);
    document.getElementById('m-avg-loss').textContent = formatMoney(avgLoss);
    document.getElementById('m-profit-factor').textContent = profitFactor >= 999 ? '‚àû' : profitFactor.toFixed(1);
    
    // Goal Engineer
    updateGoalEngineer();
    
    // Log table
    renderLog(entries);
    
    // Chart
    renderChart(entries);
    
    // Appreciation
    updateAppreciation(entries, netPnl, streak, winrate);
}

// ========== GOAL ENGINEER ==========
function getTradingDaysInPeriod(timeframe) {
    const now = new Date();
    let totalDays, elapsed;
    
    switch(timeframe) {
        case 'week': {
            totalDays = 5;
            const dow = now.getDay(); // 0=Sun, 6=Sat
            elapsed = dow === 0 ? 0 : dow === 6 ? 5 : dow; // Mon=1 ... Fri=5
            break;
        }
        case 'month': {
            totalDays = 21;
            // Approximate elapsed trading days this month
            const dayOfMonth = now.getDate();
            elapsed = Math.round(dayOfMonth * 21 / new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate());
            break;
        }
        case 'quarter': {
            totalDays = 63;
            const qMonth = now.getMonth() % 3; // 0,1,2 within quarter
            const monthProgress = now.getDate() / new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            elapsed = Math.round((qMonth + monthProgress) * 21);
            break;
        }
        case 'year': {
            totalDays = 252;
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const dayOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
            elapsed = Math.round(dayOfYear * 252 / 365);
            break;
        }
        default:
            totalDays = 21; elapsed = 0;
    }
    
    return { totalDays, elapsed, remaining: Math.max(1, totalDays - elapsed) };
}

function getGoalPeriodEntries(timeframe) {
    const now = new Date();
    let start;
    
    switch(timeframe) {
        case 'week': {
            start = new Date(now);
            start.setDate(now.getDate() - now.getDay());
            start.setHours(0,0,0,0);
            break;
        }
        case 'month':
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            break;
        case 'quarter': {
            const qStart = Math.floor(now.getMonth() / 3) * 3;
            start = new Date(now.getFullYear(), qStart, 1);
            break;
        }
        case 'year':
            start = new Date(now.getFullYear(), 0, 1);
            break;
        default:
            start = new Date(now.getFullYear(), now.getMonth(), 1);
    }
    
    const startStr = start.toISOString().split('T')[0];
    return state.entries.filter(e => e.date >= startStr);
}

function updateGoalEngineer() {
    const profitGoal = parseFloat(document.getElementById('goal-profit').value) || 0;
    const timeframe = document.getElementById('goal-timeframe').value;
    const capital = state.capital || 0;
    
    const { totalDays, elapsed, remaining } = getTradingDaysInPeriod(timeframe);
    const periodEntries = getGoalPeriodEntries(timeframe);
    const earnedSoFar = periodEntries.reduce((sum, e) => sum + e.pnl, 0);
    
    // === WHAT YOU NEED ===
    const dailyTarget = totalDays > 0 ? profitGoal / totalDays : 0;
    const weeklyTarget = dailyTarget * 5;
    const monthlyTarget = dailyTarget * 21;
    
    const dailyPct = capital > 0 ? (dailyTarget / capital * 100) : 0;
    const weeklyPct = capital > 0 ? (weeklyTarget / capital * 100) : 0;
    const monthlyPct = capital > 0 ? (monthlyTarget / capital * 100) : 0;
    
    document.getElementById('goal-daily-dollar').textContent = formatMoney(dailyTarget);
    document.getElementById('goal-daily-pct').textContent = `${dailyPct.toFixed(2)}%`;
    document.getElementById('goal-weekly-dollar').textContent = formatMoney(weeklyTarget);
    document.getElementById('goal-weekly-pct').textContent = `${weeklyPct.toFixed(2)}%`;
    document.getElementById('goal-monthly-dollar').textContent = formatMoney(monthlyTarget);
    document.getElementById('goal-monthly-pct').textContent = `${monthlyPct.toFixed(2)}%`;
    
    // === PACE TRACKER ===
    const loggedDays = periodEntries.length;
    const progressPct = profitGoal > 0 ? Math.max(0, (earnedSoFar / profitGoal) * 100) : 0;
    const expectedPct = totalDays > 0 ? (elapsed / totalDays) * 100 : 0;
    
    const aheadOfPace = progressPct >= expectedPct;
    const remainingToGoal = profitGoal - earnedSoFar;
    
    document.getElementById('goal-pace-days').textContent = `${loggedDays} of ${totalDays} days logged`;
    
    const statusEl = document.getElementById('goal-pace-status');
    if (loggedDays === 0) {
        statusEl.textContent = '‚Äî';
        statusEl.style.color = 'var(--text-muted)';
    } else if (earnedSoFar >= profitGoal) {
        statusEl.textContent = '‚úì Goal hit!';
        statusEl.style.color = 'var(--green)';
    } else if (aheadOfPace) {
        statusEl.textContent = '‚Üë Ahead of pace';
        statusEl.style.color = 'var(--green)';
    } else {
        statusEl.textContent = '‚Üì Behind pace';
        statusEl.style.color = 'var(--amber)';
    }
    
    document.getElementById('goal-pace-fill').style.width = `${Math.min(100, progressPct)}%`;
    document.getElementById('goal-pace-target').style.left = `${Math.min(100, expectedPct)}%`;
    
    document.getElementById('goal-pace-earned').textContent = `${formatMoney(earnedSoFar)} earned`;
    document.getElementById('goal-pace-remaining').textContent = remainingToGoal > 0 
        ? `${formatMoney(remainingToGoal)} remaining` 
        : `${formatMoney(Math.abs(remainingToGoal))} surplus!`;
    
    // === REALITY CHECK ===
    const avgDay = loggedDays > 0 ? earnedSoFar / loggedDays : 0;
    const adjustedDaily = remaining > 0 ? remainingToGoal / remaining : 0;
    const projectedTotal = loggedDays > 0 ? avgDay * totalDays : 0;
    
    const avgDayEl = document.getElementById('goal-avg-day');
    avgDayEl.textContent = formatMoney(avgDay);
    avgDayEl.style.color = avgDay >= dailyTarget ? 'var(--green)' : 'var(--amber)';
    
    const avgVsEl = document.getElementById('goal-avg-vs');
    if (loggedDays > 0) {
        avgVsEl.textContent = `vs ${formatMoney(dailyTarget)} needed`;
    } else {
        avgVsEl.textContent = '‚Äî';
    }
    
    const adjustedEl = document.getElementById('goal-adjusted');
    if (earnedSoFar >= profitGoal) {
        adjustedEl.textContent = '$0.00';
        adjustedEl.style.color = 'var(--green)';
    } else if (adjustedDaily > dailyTarget * 2) {
        adjustedEl.textContent = formatMoney(adjustedDaily);
        adjustedEl.style.color = 'var(--red)';
    } else {
        adjustedEl.textContent = formatMoney(adjustedDaily);
        adjustedEl.style.color = adjustedDaily <= dailyTarget ? 'var(--green)' : 'var(--cyan)';
    }
    
    const projectedEl = document.getElementById('goal-projected');
    projectedEl.textContent = formatMoney(projectedTotal);
    if (loggedDays > 0) {
        projectedEl.style.color = projectedTotal >= profitGoal ? 'var(--green)' : 'var(--amber)';
    } else {
        projectedEl.style.color = 'var(--text-muted)';
    }
    
    // Save goal to state
    state.goalProfit = profitGoal;
    state.goalTimeframe = timeframe;
    saveState();
}

// ========== LOG RENDERING ==========
function renderLog(entries) {
    const container = document.getElementById('log-body');
    
    let filtered = [...entries];
    if (state.filter === 'wins') filtered = filtered.filter(e => e.pnl > 0);
    if (state.filter === 'losses') filtered = filtered.filter(e => e.pnl < 0);
    
    filtered.sort((a, b) => b.date.localeCompare(a.date));
    
    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No entries yet. Log your first day above.</div>';
        return;
    }
    
    // Running balance
    const allSorted = [...state.entries].sort((a,b) => a.date.localeCompare(b.date));
    const balanceMap = {};
    let running = state.capital;
    for (const e of allSorted) {
        running += e.pnl;
        balanceMap[e.id] = running;
    }
    
    let html = `<table class="log-table">
        <thead><tr>
            <th>Date</th>
            <th>P&L</th>
            <th>Details</th>
            <th>Balance</th>
            <th></th>
        </tr></thead><tbody>`;
    
    for (const e of filtered) {
        const isWin = e.pnl >= 0;
        const bal = balanceMap[e.id] || 0;
        
        // Build detail tags
        let details = '<div class="entry-meta">';
        if (e.contracts) details += `<span class="meta-tag contracts">${e.contracts}x</span>`;
        if (e.ticker) details += `<span class="meta-tag ticker">${e.ticker}</span>`;
        if (e.type) details += `<span class="meta-tag type">${e.type}</span>`;
        details += '</div>';
        if (e.note) details += `<div class="note-col" title="${e.note}">${e.note}</div>`;
        
        html += `<tr>
            <td class="date-col">${formatDate(e.date)}</td>
            <td><span class="tag ${isWin ? 'win' : 'loss'}">${isWin ? 'WIN' : 'LOSS'}</span> 
                <span class="${isWin ? 'positive' : 'negative'}">${formatMoney(e.pnl)}</span></td>
            <td>${details}</td>
            <td>${formatMoney(bal)}</td>
            <td><button class="delete-btn" onclick="deleteEntry(${e.id})">‚úï</button></td>
        </tr>`;
    }
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// ========== EQUITY CHART (Canvas) ==========
function renderChart(entries) {
    const canvas = document.getElementById('equityChart');
    const ctx = canvas.getContext('2d');
    
    // Hi-DPI
    const rect = canvas.parentElement.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr, dpr);
    
    const w = rect.width;
    const h = rect.height;
    const pad = { top: 20, right: 60, bottom: 30, left: 10 };
    
    ctx.clearRect(0, 0, w, h);
    
    if (entries.length < 2) {
        ctx.fillStyle = '#4a5568';
        ctx.font = '13px Outfit';
        ctx.textAlign = 'center';
        ctx.fillText('Add at least 2 entries to see the curve', w/2, h/2);
        return;
    }
    
    // Build equity curve
    const sorted = [...entries].sort((a,b) => a.date.localeCompare(b.date));
    let balance = state.capital;
    const points = [{ date: 'Start', value: balance }];
    for (const e of sorted) {
        balance += e.pnl;
        points.push({ date: e.date, value: balance });
    }
    
    const values = points.map(p => p.value);
    const minVal = Math.min(...values) * 0.995;
    const maxVal = Math.max(...values) * 1.005;
    const range = maxVal - minVal || 1;
    
    const chartW = w - pad.left - pad.right;
    const chartH = h - pad.top - pad.bottom;
    
    // Grid lines
    ctx.strokeStyle = 'rgba(30, 42, 66, 0.5)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = pad.top + (chartH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(w - pad.right, y);
        ctx.stroke();
        
        const val = maxVal - (range / 4) * i;
        ctx.fillStyle = '#4a5568';
        ctx.font = '10px DM Mono';
        ctx.textAlign = 'right';
        ctx.fillText(formatMoneyShort(val), w - 8, y + 3);
    }
    
    // Plot line
    const getX = (i) => pad.left + (i / (points.length - 1)) * chartW;
    const getY = (v) => pad.top + ((maxVal - v) / range) * chartH;
    
    // Gradient fill
    const gradient = ctx.createLinearGradient(0, pad.top, 0, h - pad.bottom);
    const lastVal = points[points.length - 1].value;
    const isUp = lastVal >= state.capital;
    
    if (isUp) {
        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.15)');
        gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
    } else {
        gradient.addColorStop(0, 'rgba(239, 68, 68, 0.0)');
        gradient.addColorStop(1, 'rgba(239, 68, 68, 0.15)');
    }
    
    ctx.beginPath();
    ctx.moveTo(getX(0), getY(points[0].value));
    for (let i = 1; i < points.length; i++) {
        ctx.lineTo(getX(i), getY(points[i].value));
    }
    ctx.lineTo(getX(points.length - 1), h - pad.bottom);
    ctx.lineTo(getX(0), h - pad.bottom);
    ctx.closePath();
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Line
    ctx.beginPath();
    ctx.moveTo(getX(0), getY(points[0].value));
    for (let i = 1; i < points.length; i++) {
        ctx.lineTo(getX(i), getY(points[i].value));
    }
    ctx.strokeStyle = isUp ? '#10b981' : '#ef4444';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Dots
    for (let i = 0; i < points.length; i++) {
        ctx.beginPath();
        ctx.arc(getX(i), getY(points[i].value), 3, 0, Math.PI * 2);
        ctx.fillStyle = isUp ? '#10b981' : '#ef4444';
        ctx.fill();
    }
    
    // Starting capital line
    const capY = getY(state.capital);
    ctx.setLineDash([4, 4]);
    ctx.strokeStyle = 'rgba(59, 130, 246, 0.4)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad.left, capY);
    ctx.lineTo(w - pad.right, capY);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Date labels
    ctx.fillStyle = '#4a5568';
    ctx.font = '10px Outfit';
    ctx.textAlign = 'center';
    const step = Math.max(1, Math.floor(points.length / 6));
    for (let i = 0; i < points.length; i += step) {
        const dateStr = points[i].date === 'Start' ? 'Start' : formatDateShort(points[i].date);
        ctx.fillText(dateStr, getX(i), h - 8);
    }
}

// ========== APPRECIATION ==========
function updateAppreciation(entries, netPnl, streak, winrate) {
    const banner = document.getElementById('appreciation-banner');
    
    if (entries.length === 0) {
        banner.style.display = 'none';
        return;
    }
    
    let emoji = '';
    let text = '';
    
    if (streak >= 5) {
        emoji = 'üî•';
        text = `<strong>${streak}-day win streak!</strong> Consistency compounds. At this pace, discipline is doing the heavy lifting.`;
    } else if (streak >= 3) {
        emoji = '‚ú®';
        text = `<strong>${streak} wins in a row.</strong> Momentum building. Small daily wins become big monthly numbers.`;
    } else if (netPnl > 0 && entries.length >= 5) {
        const dailyAvg = netPnl / entries.length;
        const projected252 = dailyAvg * 252;
        emoji = 'üìä';
        text = `Averaging <strong>${formatMoney(dailyAvg)}/day</strong>. Projected over 252 trading days, that's <strong>${formatMoney(projected252)}</strong> ‚Äî the math doesn't lie.`;
    } else if (winrate >= 60 && entries.length >= 5) {
        emoji = 'üéØ';
        text = `<strong>${winrate.toFixed(0)}% win rate</strong> across ${entries.length} days. Edge confirmed. Keep executing the system.`;
    } else if (netPnl > 0) {
        emoji = 'üí∞';
        text = `<strong>${formatMoney(netPnl)} net positive.</strong> Every green day is proof the system works. Protect the capital, let the math compound.`;
    } else if (netPnl < 0 && entries.length >= 3) {
        emoji = 'üõ°Ô∏è';
        text = `Drawdowns are part of the game. <strong>${formatMoney(Math.abs(netPnl))}</strong> is recoverable. Focus on process over outcome ‚Äî the edge is still there.`;
    } else {
        banner.style.display = 'none';
        return;
    }
    
    banner.style.display = 'flex';
    banner.className = 'appreciation-banner';
    banner.innerHTML = `<div class="emoji">${emoji}</div><div class="text">${text}</div>`;
}

// ========== FORMATTERS ==========
function formatMoney(n) {
    const abs = Math.abs(n);
    const formatted = abs >= 1000 
        ? abs.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        : abs.toFixed(2);
    return `${n < 0 ? '-' : ''}$${formatted}`;
}

function formatMoneyShort(n) {
    if (Math.abs(n) >= 1000000) return `$${(n/1000000).toFixed(1)}M`;
    if (Math.abs(n) >= 1000) return `$${(n/1000).toFixed(1)}K`;
    return `$${n.toFixed(0)}`;
}

function formatDate(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatDateShort(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    return `${d.getMonth()+1}/${d.getDate()}`;
}

// ========== INIT ==========
(async function init() {
    await loadState();
    refreshAll();
})();

// Resize handler for chart
window.addEventListener('resize', () => {
    const entries = getFilteredEntries();
    renderChart(entries);
});
</script>
</body>
</html>
