<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.E.F. Simple Scanner | Find Trades Fast</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs for Authentication and Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #12171f;
            --bg-hover: #1a2332;
            --text-white: #ffffff;
            --text-gray: #8b95a5;
            --green: #00ff88;
            --red: #ff4757;
            --yellow: #ffc800;
            --cyan: #00f5d4;
            --purple: #9d4edd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-white);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 0;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--cyan), var(--green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-gray);
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .full-suite-link {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            color: var(--text-gray);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            transition: all 0.2s;
        }

        .full-suite-link:hover {
            color: var(--cyan);
            border-color: var(--cyan);
            background: rgba(0,245,212,0.1);
        }

        .header-links {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .logout-link {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-link:hover {
            color: var(--red);
            border-color: var(--red);
            background: rgba(255,71,87,0.1);
        }

        /* Scanner Card */
        .scanner-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Two-Path Layout */
        .path-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .path-container {
                grid-template-columns: 1fr;
            }
        }

        .path-box {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            min-height: 320px;
        }

        .path-box:hover {
            border-color: rgba(0,245,212,0.3);
        }

        .path-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--cyan);
        }

        .path-box .symbol-search {
            margin-bottom: 1rem;
        }

        .path-box .universe-grid {
            margin-bottom: 1rem;
        }

        .path-box .scan-types {
            margin-bottom: 1rem;
        }

        .path-action-btn {
            margin-top: auto;
            padding: 0.9rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .path-action-btn.analyze {
            background: linear-gradient(135deg, var(--cyan), #00d4aa);
            color: var(--bg-dark);
        }

        .path-action-btn.analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,245,212,0.4);
        }

        .path-action-btn.scan {
            background: linear-gradient(135deg, var(--green), #00cc66);
            color: var(--bg-dark);
        }

        .path-action-btn.scan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,255,136,0.4);
        }

        .path-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .scanner-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--cyan);
        }

        /* Quick Universe Buttons */
        .universe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .universe-btn {
            background: var(--bg-hover);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-white);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .universe-btn:hover {
            background: rgba(0,245,212,0.2);
            border-color: var(--cyan);
        }

        .universe-btn.active {
            background: rgba(0,255,136,0.2);
            border-color: var(--green);
        }

        /* Scan Type Pills */
        .scan-types {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scan-pill {
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.2);
            background: transparent;
            color: var(--text-white);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .scan-pill.long {
            border-color: rgba(0,255,136,0.5);
        }

        .scan-pill.long.active {
            background: rgba(0,255,136,0.3);
            border-color: var(--green);
        }

        .scan-pill.short {
            border-color: rgba(255,71,87,0.5);
        }

        .scan-pill.short.active {
            background: rgba(255,71,87,0.3);
            border-color: var(--red);
        }

        .scan-pill.entry {
            border-color: rgba(157,78,221,0.5);
        }

        .scan-pill.entry.active {
            background: rgba(157,78,221,0.3);
            border-color: var(--purple);
        }

        .scan-pill.volume {
            border-color: rgba(255,150,50,0.5);
        }

        .scan-pill.volume.active {
            background: rgba(255,150,50,0.3);
            border-color: #ff9632;
        }

        .scan-pill.squeeze {
            border-color: rgba(255,200,0,0.5);
        }

        .scan-pill.squeeze.active {
            background: rgba(255,200,0,0.3);
            border-color: var(--yellow);
        }

        .scan-pill.extension {
            border-color: rgba(0,245,212,0.5);
        }

        .scan-pill.extension.active {
            background: rgba(0,245,212,0.3);
            border-color: var(--cyan);
        }

        .scan-pill.levels {
            border-color: rgba(100,150,255,0.5);
        }

        .scan-pill.levels.active {
            background: rgba(100,150,255,0.3);
            border-color: #6496ff;
        }

        .scan-pill.aplus {
            border-color: rgba(255,215,0,0.5);
        }

        .scan-pill.aplus.active {
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,180,0,0.3));
            border-color: gold;
        }

        .scan-pill.all {
            border-color: rgba(255,255,255,0.4);
        }

        .scan-pill.all.active {
            background: linear-gradient(135deg, rgba(0,245,212,0.3), rgba(0,255,136,0.3));
            border-color: var(--cyan);
        }

        /* Level Toggle */
        .level-toggle {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .level-btn {
            flex: 1;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            background: var(--bg-hover);
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .level-btn .level-desc {
            display: block;
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-gray);
            margin-top: 0.25rem;
        }

        .level-btn:hover {
            border-color: rgba(255,255,255,0.3);
        }

        .level-btn.active {
            border-color: var(--cyan);
            background: rgba(0,245,212,0.15);
        }

        .level-btn.active .level-desc {
            color: var(--cyan);
        }

        #pro-btn.active {
            border-color: var(--yellow);
            background: linear-gradient(135deg, rgba(255,200,0,0.15), rgba(255,150,50,0.15));
        }

        #pro-btn.active .level-desc {
            color: var(--yellow);
        }

        /* Big Scan Button */
        .scan-btn {
            width: 100%;
            padding: 1rem 2rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .scan-btn:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-color: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .scan-btn:active {
            transform: translateY(0);
            background: rgba(255,255,255,0.08);
        }

        .scan-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin-top: 1rem;
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--green));
            width: 0%;
            transition: width 0.3s;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--cyan);
            font-weight: 600;
        }

        /* Results Section */
        .results-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: var(--bg-hover);
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-tab.active {
            background: var(--cyan);
            color: var(--bg-dark);
        }

        .score-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .score-filter-group {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .score-filter-group label {
            font-size: 0.8rem;
            color: var(--text-gray);
            font-weight: 500;
        }

        .score-select {
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            background: var(--bg-hover);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-white);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .score-select:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .sort-toggle {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            background: var(--bg-hover);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-gray);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-toggle.active {
            background: var(--purple);
            color: white;
            border-color: var(--purple);
        }

        /* Result Cards */
        .result-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .result-item {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1rem;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .result-item:hover {
            border-color: var(--cyan);
            transform: translateX(4px);
        }

        .result-symbol {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
        }

        .result-signal {
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        .result-signal.long { color: var(--green); }
        .result-signal.short { color: var(--red); }
        .result-signal.neutral { color: var(--yellow); }

        .result-badges {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .badge {
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .badge.confidence {
            background: rgba(0,245,212,0.2);
            color: var(--cyan);
        }

        .badge.rvol-high {
            background: rgba(255,59,92,0.3);
            color: var(--red);
        }

        .badge.rvol-good {
            background: rgba(0,245,212,0.2);
            color: var(--cyan);
        }

        .badge.rvol-low {
            background: rgba(255,200,0,0.2);
            color: var(--yellow);
        }

        .badge.squeeze-score {
            background: rgba(255,200,0,0.3);
            color: var(--yellow);
            font-weight: 600;
        }

        .badge.score-high {
            background: rgba(0,255,136,0.3);
            color: var(--green);
            font-weight: 700;
        }

        .badge.score-med {
            background: rgba(0,245,212,0.2);
            color: var(--cyan);
            font-weight: 600;
        }

        .badge.score-low {
            background: rgba(139,149,165,0.2);
            color: var(--text-gray);
        }

        .result-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--green), var(--cyan));
            color: var(--bg-dark);
        }

        .action-btn.secondary {
            background: var(--bg-card);
            color: var(--text-white);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        /* AI Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(0,245,212,0.3);
            margin: auto;
        }

        .modal.wide {
            max-width: 95vw;
            width: 1100px;
            max-height: 90vh;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1rem 1.5rem;
        }

        .level-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .level-label {
            color: var(--text-gray);
        }

        .level-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
        }

        .level-value.green { color: var(--green); }
        .level-value.red { color: var(--red); }
        .level-value.cyan { color: var(--cyan); }

        .score-display {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }

        .score-box {
            text-align: center;
            padding: 1rem 2rem;
            border-radius: 12px;
        }

        .score-box.bull {
            background: rgba(0,255,136,0.1);
            border: 1px solid var(--green);
        }

        .score-box.bear {
            background: rgba(255,71,87,0.1);
            border: 1px solid var(--red);
        }

        .score-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 800;
        }

        .score-label {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 0.25rem;
        }

        .ai-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .ai-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            border: 2px solid var(--purple);
            border-radius: 12px;
            background: rgba(157,78,221,0.2);
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-btn:hover {
            background: rgba(157,78,221,0.4);
        }

        .ai-response {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-hover);
            border-radius: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 0.5rem;
        }

        .modal-footer .action-btn {
            flex: 1;
        }

        /* Rule Plan Styles */
        .rule-plan-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .plan-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-hover);
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .plan-header.no-trade {
            background: rgba(139,149,165,0.1);
            border: 1px solid var(--text-gray);
        }

        .direction-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
            color: var(--bg-dark);
        }

        .plan-symbol {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .plan-confidence {
            font-size: 1.1rem;
            color: var(--cyan);
            font-weight: 600;
        }

        .plan-size {
            font-weight: 700;
            margin-left: auto;
        }

        .plan-levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .level-card {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .level-card.entry {
            border: 1px solid var(--cyan);
        }

        .level-card.stop {
            border: 1px solid var(--red);
        }

        .level-card.target {
            border: 1px solid var(--green);
        }

        .level-card .level-label {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }

        .level-card .level-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .level-card .level-subtext {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 0.25rem;
        }

        .plan-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .plan-section {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 1rem;
        }

        .plan-section h4 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--text-white);
        }

        .plan-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plan-section li {
            padding: 0.4rem 0;
            font-size: 0.9rem;
            color: var(--text-gray);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .plan-section li:last-child {
            border-bottom: none;
        }

        .reasons-section {
            border-left: 3px solid var(--green);
        }

        .caution-section {
            border-left: 3px solid var(--yellow);
        }

        .invalidation-section {
            border-left: 3px solid var(--red);
        }

        .ai-explanation {
            border-left: 3px solid var(--purple);
            grid-column: 1 / -1;
        }

        .ai-explanation p {
            color: var(--text-gray);
            line-height: 1.6;
        }

        .plan-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .outcome-tracker {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .outcome-label {
            font-weight: 600;
            color: var(--text-gray);
        }

        .outcome-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .outcome-btn.win {
            background: rgba(0,255,136,0.2);
            color: var(--green);
            border: 1px solid var(--green);
        }

        .outcome-btn.win:hover {
            background: rgba(0,255,136,0.3);
        }

        .outcome-btn.loss {
            background: rgba(255,71,87,0.2);
            color: var(--red);
            border: 1px solid var(--red);
        }

        .outcome-btn.loss:hover {
            background: rgba(255,71,87,0.3);
        }

        .outcome-btn.skip {
            background: rgba(139,149,165,0.2);
            color: var(--text-gray);
            border: 1px solid var(--text-gray);
        }

        .outcome-recorded {
            color: var(--green);
            font-weight: 600;
        }

        /* Report Toast Notification */
        .report-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--green);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--green);
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .report-toast button {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.2rem;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Auto-report toggle */
        .auto-report-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .auto-report-toggle input {
            width: 16px;
            height: 16px;
            accent-color: var(--green);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-gray);
        }

        .empty-state .emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--cyan);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--bg-hover);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            animation: slideUp 0.3s ease;
        }

        .toast.success {
            background: var(--green);
            color: var(--bg-dark);
        }

        .toast.error {
            background: var(--red);
            color: white;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 { font-size: 1.8rem; }
            .result-item { grid-template-columns: 1fr; gap: 0.75rem; }
            .result-badges { flex-direction: row; align-items: center; }
            .result-actions { flex-direction: row; }
            .score-display { flex-direction: column; }
            .symbol-search { flex-direction: column; }
            .symbol-search input { text-align: center; }
        }

        /* Single Symbol Search */
        .symbol-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .symbol-search input {
            flex: 1;
            padding: 0.875rem 1rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: var(--bg-hover);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-white);
            outline: none;
            transition: all 0.2s;
        }

        .symbol-search input:focus {
            border-color: var(--cyan);
            background: rgba(0,245,212,0.05);
        }

        .symbol-search input::placeholder {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-transform: none;
            letter-spacing: 0;
            color: var(--text-gray);
            font-weight: 400;
        }

        .quick-analyze-btn {
            padding: 0.875rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--cyan);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .quick-analyze-btn:hover {
            background: var(--green);
            transform: translateY(-1px);
        }

        /* Timeframe Toggle */
        .timeframe-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-hover);
            border-radius: 8px;
            padding: 0.25rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tf-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-gray);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tf-btn:hover {
            color: var(--text-white);
        }

        .tf-btn.active {
            background: var(--cyan);
            color: var(--bg-dark);
        }

        /* VP Period buttons */
        .vp-period-toggle {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 0.25rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .vp-btn {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: 6px;
            background: transparent;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.5;
        }

        .vp-btn:hover {
            opacity: 0.8;
        }

        .vp-btn.active {
            background: rgba(157,78,221,0.3);
            opacity: 1;
        }

        .divider-text {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.8rem;
            margin: 1rem 0;
            position: relative;
        }

        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: rgba(255,255,255,0.1);
        }

        .divider-text::before { left: 0; }
        .divider-text::after { right: 0; }

        /* AI Cards Grid System */
        .ai-card-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .ai-preset-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .ai-preset-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--bg-hover);
            color: var(--text-gray);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-preset-btn:hover {
            border-color: var(--cyan);
            color: var(--text-white);
        }

        .ai-preset-btn.active {
            background: var(--cyan);
            color: var(--bg-dark);
            border-color: var(--cyan);
        }

        .ai-cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 900px) {
            .ai-cards-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .ai-cards-grid { grid-template-columns: 1fr; }
        }

        .ai-card {
            background: var(--bg-hover);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: all 0.3s;
            display: none;
        }

        .ai-card.visible {
            display: block;
        }

        .ai-card.full-width {
            grid-column: span 4;
        }

        @media (max-width: 900px) {
            .ai-card.full-width { grid-column: span 2; }
        }

        @media (max-width: 600px) {
            .ai-card.full-width { grid-column: span 1; }
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .ai-card-icon {
            font-size: 1rem;
        }

        .ai-card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
        }

        .ai-card-body {
            padding: 0.75rem;
        }

        .ai-card.bias .ai-card-body {
            text-align: center;
            padding: 0.5rem;
        }

        .bias-direction {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .bias-direction.long { color: var(--green); }
        .bias-direction.short { color: var(--red); }
        .bias-direction.wait { color: var(--yellow); }

        .bias-prob {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .bias-scores {
            display: flex;
            gap: 0.4rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .mini-score {
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            text-align: center;
        }

        .mini-score.bull {
            background: rgba(0,255,136,0.15);
            border: 1px solid var(--green);
        }

        .mini-score.bear {
            background: rgba(255,71,87,0.15);
            border: 1px solid var(--red);
        }

        .mini-score-num {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 800;
        }

        .mini-score-label {
            font-size: 0.55rem;
            color: var(--text-gray);
            text-transform: uppercase;
        }

        .level-row-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .level-row-card:last-child {
            border-bottom: none;
        }

        .level-name {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .level-price {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .level-price.green { color: var(--green); }
        .level-price.red { color: var(--red); }
        .level-price.cyan { color: var(--cyan); }

        .rr-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
        }

        .rr-label {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .rr-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--cyan);
        }

        .reasoning-text {
            line-height: 1.5;
            font-size: 0.85rem;
            color: var(--text-white);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .invalid-text {
            color: var(--red);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .size-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--cyan);
            text-align: center;
        }

        .ev-positive { color: var(--green); }
        .ev-negative { color: var(--red); }

        /* Side-by-side layout for Analysis + AI */
        .side-by-side-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .side-by-side-container {
                grid-template-columns: 1fr;
            }
        }

        .analysis-panel {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ai-panel {
            min-width: 0;
        }

        /* Account Settings Bar */
        .account-settings {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            background: rgba(0,245,212,0.05);
            border: 1px solid rgba(0,245,212,0.2);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .account-settings label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .account-settings input,
        .account-settings select {
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--bg-dark);
            color: var(--text-white);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            width: 100px;
        }

        .account-settings input:focus,
        .account-settings select:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .size-card-body {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .size-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .size-row:last-child {
            border-bottom: none;
        }

        .size-label {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .size-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--cyan);
        }

        .size-value.highlight {
            color: var(--green);
            font-size: 1.1rem;
        }

        /* Trade Tracker Styles */
        .trades-btn {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trades-btn:hover {
            color: var(--green);
            border-color: var(--green);
            background: rgba(0,255,136,0.1);
        }

        .log-trade-btn {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid var(--green);
            border-radius: 6px;
            background: rgba(0,255,136,0.15);
            color: var(--green);
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-trade-btn:hover {
            background: rgba(0,255,136,0.3);
        }

        .log-trade-btn.logged {
            background: rgba(0,255,136,0.3);
            border-color: var(--green);
            cursor: default;
        }

        .stats-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            padding: 1rem;
            background: var(--bg-hover);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 0.5rem 1rem;
            min-width: 70px;
        }

        .stat-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-gray);
            text-transform: uppercase;
        }

        .trade-card {
            background: var(--bg-hover);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .trade-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .trade-symbol {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .trade-direction {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .trade-direction.long {
            background: rgba(0,255,136,0.2);
            color: var(--green);
        }

        .trade-direction.short {
            background: rgba(255,71,87,0.2);
            color: var(--red);
        }

        .trade-levels {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }

        .trade-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .trade-action-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--bg-dark);
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-action-btn:hover {
            border-color: var(--cyan);
        }

        .trade-action-btn.win {
            border-color: var(--green);
            color: var(--green);
        }

        .trade-action-btn.loss {
            border-color: var(--red);
            color: var(--red);
        }

        .trade-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        .trade-pnl.positive { color: var(--green); }
        .trade-pnl.negative { color: var(--red); }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--cyan);
            margin: 1rem 0 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-trades {
            text-align: center;
            padding: 2rem;
            color: var(--text-gray);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ðŸŽ¯ Simple Scanner</h1>
            <p>Find high-probability trades in seconds</p>
            <div class="header-links">
                <a href="/" class="full-suite-link">âš¡ Full Suite</a>
                <button class="trades-btn" onclick="openTradeTracker()">ðŸ“’ My Trades</button>
                <button class="logout-link" onclick="logout()">ðŸšª Logout</button>
            </div>
        </header>

        <!-- Scanner Card -->
        <div class="scanner-card">
            <!-- Shared Settings Row -->
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                <!-- Timeframe Toggle -->
                <div class="timeframe-toggle" style="margin: 0;">
                    <button class="tf-btn" data-tf="5MIN" onclick="setTimeframe('5MIN')">5m</button>
                    <button class="tf-btn" data-tf="15MIN" onclick="setTimeframe('15MIN')">15m</button>
                    <button class="tf-btn" data-tf="30MIN" onclick="setTimeframe('30MIN')">30m</button>
                    <button class="tf-btn active" data-tf="1HR" onclick="setTimeframe('1HR')">1hr</button>
                    <button class="tf-btn" data-tf="2HR" onclick="setTimeframe('2HR')">2hr</button>
                    <button class="tf-btn" data-tf="4HR" onclick="setTimeframe('4HR')">4hr</button>
                </div>
                
                <!-- VP Period Toggle (for investors) -->
                <div class="vp-period-toggle" style="margin: 0; display: flex; gap: 0.25rem;">
                    <button class="vp-btn" data-period="day" onclick="selectVPPeriod('day')" title="1 day lookback">ðŸ“…</button>
                    <button class="vp-btn active" data-period="swing" onclick="selectVPPeriod('swing')" title="5 days lookback">ðŸ“Š</button>
                    <button class="vp-btn" data-period="position" onclick="selectVPPeriod('position')" title="20 days lookback">ðŸ“ˆ</button>
                    <button class="vp-btn" data-period="investment" onclick="selectVPPeriod('investment')" title="3-9 months lookback">ðŸ’¼</button>
                </div>
                
                <!-- Skill Level Toggle -->
                <div class="level-toggle" style="margin: 0; flex: 0 0 auto;">
                    <button class="level-btn active" id="beginner-btn" onclick="setLevel('beginner')" style="padding: 0.5rem 1rem;">
                        ðŸŒ± Beginner
                    </button>
                    <button class="level-btn" id="pro-btn" onclick="setLevel('pro')" style="padding: 0.5rem 1rem;">
                        ðŸ”¥ Pro
                    </button>
                </div>
            </div>
            
            <!-- Two Paths -->
            <div class="path-container">
                <!-- Path 1: Analyze One -->
                <div class="path-box">
                    <div class="path-title">ðŸŽ¯ Analyze One Ticker</div>
                    <div class="symbol-search">
                        <input type="text" id="single-symbol" placeholder="Enter symbol (e.g., AAPL)" maxlength="5" onkeypress="if(event.key==='Enter') quickAnalyze()">
                    </div>
                    <button class="path-action-btn analyze" onclick="quickAnalyze()">ANALYZE</button>
                </div>
                
                <!-- Path 2: Scan Universe -->
                <div class="path-box">
                    <div class="path-title">ðŸ” Scan Universe</div>
                    
                    <div class="universe-grid">
                        <button class="universe-btn" onclick="selectUniverse('tech')">ðŸ’» Tech</button>
                        <button class="universe-btn" onclick="selectUniverse('mega')">ðŸ¢ Mega</button>
                        <button class="universe-btn" onclick="selectUniverse('etfs')">ðŸ“ˆ ETFs</button>
                        <button class="universe-btn" onclick="selectUniverse('meme')">ðŸš€ Meme</button>
                        <button class="universe-btn" onclick="selectUniverse('all')">ðŸŒ All</button>
                    </div>
                    
                    <!-- Beginner Scans -->
                    <div class="scan-types" id="beginner-scans">
                        <button class="scan-pill long" onclick="toggleScan(this, 'bullish')">ðŸŸ¢ Longs</button>
                        <button class="scan-pill short" onclick="toggleScan(this, 'bearish')">ðŸ”´ Shorts</button>
                        <button class="scan-pill entry" onclick="toggleScan(this, 'entry')">ðŸŽ¯ Entry</button>
                        <button class="scan-pill volume" onclick="toggleScan(this, 'highVolume')">ðŸ”¥ Volume</button>
                        <button class="scan-pill squeeze" onclick="toggleScan(this, 'squeeze')">ðŸŽ° Squeeze</button>
                        <button class="scan-pill all" onclick="toggleAllScans('beginner')">ðŸŒ All</button>
                    </div>
                    
                    <!-- Pro Scans (hidden by default) -->
                    <div class="scan-types" id="pro-scans" style="display: none;">
                        <button class="scan-pill long" onclick="toggleScan(this, 'bullish')">ðŸŸ¢ Longs</button>
                        <button class="scan-pill short" onclick="toggleScan(this, 'bearish')">ðŸ”´ Shorts</button>
                        <button class="scan-pill entry" onclick="toggleScan(this, 'entry')">ðŸŽ¯ Entry</button>
                        <button class="scan-pill volume" onclick="toggleScan(this, 'highVolume')">ðŸ”¥ Volume</button>
                        <button class="scan-pill squeeze" onclick="toggleScan(this, 'squeeze')">ðŸŽ° Squeeze</button>
                        <button class="scan-pill extension" onclick="toggleScan(this, 'extension')">ðŸš€ Ext Snap</button>
                        <button class="scan-pill levels" onclick="toggleScan(this, 'atLevels')">ðŸ“ Levels</button>
                        <button class="scan-pill aplus" onclick="toggleScan(this, 'aPlus')">ðŸ’Ž A+</button>
                        <button class="scan-pill all" onclick="toggleAllScans('pro')">ðŸŒ All</button>
                    </div>
                    
                    <button class="path-action-btn scan" onclick="runScan()">SCAN</button>
                </div>
            </div>

            <div class="progress-container" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Scanning...</div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="results-card" id="results-card">
            <div class="results-header">
                <div class="results-count" id="results-count">0 Results</div>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterResults('all')">All</button>
                    <button class="filter-tab" onclick="filterResults('long')">ðŸŸ¢ Longs</button>
                    <button class="filter-tab" onclick="filterResults('short')">ðŸ”´ Shorts</button>
                </div>
            </div>
            <div class="score-controls">
                <div class="score-filter-group">
                    <label>Min Score:</label>
                    <select class="score-select" id="min-score-filter" onchange="applyFilters()">
                        <option value="0">All</option>
                        <option value="50">50+</option>
                        <option value="60">60+</option>
                        <option value="70">70+ â­</option>
                        <option value="80">80+ ðŸ”¥</option>
                    </select>
                </div>
                <div class="score-filter-group">
                    <label>Sort:</label>
                    <select class="score-select" id="sort-by" onchange="applyFilters()">
                        <option value="score">ðŸ“Š Score (Highâ†’Low)</option>
                        <option value="confidence">ðŸ’¯ Confidence</option>
                        <option value="rvol">ðŸ“ˆ Volume</option>
                        <option value="symbol">ðŸ”¤ Symbol</option>
                    </select>
                </div>
                <div class="auto-report-toggle">
                    <input type="checkbox" id="auto-report-toggle" checked onchange="autoReportEnabled = this.checked">
                    <label for="auto-report-toggle">ðŸ“ Auto-reports</label>
                </div>
            </div>
            
            <div class="result-list" id="result-list">
                <!-- Results go here -->
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        const API_BASE = 'https://analysisgrid-production.up.railway.app';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4oBeoFzFV2oS5ZxEvQ4TIRRVJFC3nl-w",
            authDomain: "analysis-grid.firebaseapp.com",
            projectId: "analysis-grid",
            storageBucket: "analysis-grid.firebasestorage.app",
            messagingSenderId: "633207767657",
            appId: "1:633207767657:web:e623871eca352a268b58f8"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        window.currentUser = null;
        
        // Listen for auth state
        window.auth.onAuthStateChanged((user) => {
            window.currentUser = user;
            if (user) {
                console.log('âœ… Logged in as:', user.email);
            }
        });
        
        // Stock universes
        const UNIVERSES = {
            tech: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA', 'AMD', 'INTC', 'CRM', 
                   'ORCL', 'ADBE', 'NFLX', 'PYPL', 'SQ', 'SHOP', 'SNOW', 'NET', 'DDOG', 'MDB'],
            mega: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA', 'BRK.B', 'UNH', 'JNJ',
                   'V', 'JPM', 'WMT', 'PG', 'MA', 'HD', 'DIS', 'BAC', 'XOM', 'PFE'],
            etfs: ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLK', 'XLE', 'GLD', 'TLT', 'SMH',
                   'ARKK', 'SOXX', 'XBI', 'VXX', 'SQQQ', 'TQQQ'],
            meme: ['GME', 'AMC', 'PLTR', 'SOFI', 'RIVN', 'LCID', 'NIO', 'HOOD', 'COIN', 'MARA',
                   'RIOT', 'DKNG', 'SPCE', 'TLRY'],
            all: []
        };
        
        // Combine all for 'all'
        UNIVERSES.all = [...new Set([...UNIVERSES.tech, ...UNIVERSES.mega, ...UNIVERSES.etfs, ...UNIVERSES.meme])];
        
        let selectedUniverse = 'tech';
        let selectedScans = { bullish: false, bearish: false, entry: false, highVolume: false, squeeze: false, extension: false, atLevels: false, aPlus: false };
        let allResults = [];
        let currentDirectionFilter = 'all';
        let minScoreFilter = 0;
        let sortBy = 'score';
        let currentLevel = 'beginner';
        let selectedTimeframe = '1HR';
        let selectedVPPeriod = 'swing';  // 'day', 'swing', 'position', 'investment'
        
        // VP Period descriptions
        const VP_PERIODS = {
            day: { label: 'ðŸ“… Day', desc: '1 day - Intraday traders' },
            swing: { label: 'ðŸ“Š Swing', desc: '5 days - Swing traders (default)' },
            position: { label: 'ðŸ“ˆ Position', desc: '20 days - Position traders' },
            investment: { label: 'ðŸ’¼ Investment', desc: '3-9 months - Long-term investors' }
        };
        
        function selectVPPeriod(period) {
            selectedVPPeriod = period;
            document.querySelectorAll('.vp-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.vp-btn[data-period="${period}"]`)?.classList.add('active');
        }
        
        // Account settings functions
        function getAccountSize() {
            return localStorage.getItem('accountSize') || '10000';
        }
        
        function saveAccountSize(value) {
            const cleaned = value.replace(/[^0-9.]/g, '');
            localStorage.setItem('accountSize', cleaned);
            updateOneRDisplay();
        }
        
        function getRiskPercent() {
            return parseFloat(localStorage.getItem('riskPercent') || '1');
        }
        
        function saveRiskPercent(value) {
            localStorage.setItem('riskPercent', value);
            updateOneRDisplay();
        }
        
        function calculateOneR() {
            const account = parseFloat(getAccountSize()) || 10000;
            const riskPct = getRiskPercent() / 100;
            return account * riskPct;
        }
        
        function updateOneRDisplay() {
            const display = document.querySelector('.account-settings span');
            if (display) {
                display.textContent = `1R = $${calculateOneR().toFixed(0)}`;
            }
        }
        
        function calculatePositionSize(rMultiple, entryPrice, stopPrice) {
            const oneR = calculateOneR();
            const riskDollars = oneR * rMultiple;
            const riskPerShare = Math.abs(entryPrice - stopPrice);
            const shares = riskPerShare > 0 ? Math.floor(riskDollars / riskPerShare) : 0;
            return { riskDollars, shares, riskPerShare };
        }
        
        function setTimeframe(tf) {
            selectedTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tf === tf);
            });
        }
        
        // Quick analyze single symbol
        async function quickAnalyze() {
            const input = document.getElementById('single-symbol');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                showToast('Enter a symbol to analyze', 'error');
                return;
            }
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal wide">
                    <div class="modal-header">
                        <div class="modal-title">ðŸ“Š ${symbol} <span style="font-size: 0.7rem; color: var(--text-gray);">${currentLevel.toUpperCase()} MODE</span></div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="loading"><div class="spinner"></div>Analyzing ${symbol}...</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            try {
                // Fetch both analysis and AI in parallel
                const [data, aiData] = await Promise.all([
                    fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=false`),
                    fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`)
                ]);
                
                // Also fetch entry signals for Pro mode
                let entrySignals = [];
                if (currentLevel === 'pro') {
                    try {
                        const entryData = await fetchJson(`${API_BASE}/api/entry-scan/scan/${symbol}?resolution=60&days=5`);
                        entrySignals = entryData.signals || [];
                    } catch (e) { console.log('No entry signals'); }
                }
                
                const direction = data.signal?.includes('LONG') ? 'long' : data.signal?.includes('SHORT') ? 'short' : 'neutral';
                const dirEmoji = direction === 'long' ? 'ðŸŸ¢' : direction === 'short' ? 'ðŸ”´' : 'ðŸŸ¡';
                const dirColor = direction === 'long' ? 'green' : direction === 'short' ? 'red' : 'cyan';
                
                // RVOL badge - ensure we show at least 0.1x (avoid 0.0x display)
                const rvol = Math.max(data.rvol || 1.0, 0.01);
                let rvolBadge = '';
                if (rvol >= 2.0) {
                    rvolBadge = `<span style="background: rgba(255,59,92,0.3); color: var(--red); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 700;">ðŸ”¥ ${rvol.toFixed(1)}x Vol</span>`;
                } else if (rvol >= 1.5) {
                    rvolBadge = `<span style="background: rgba(0,245,212,0.2); color: var(--cyan); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 700;">ðŸ“ˆ ${rvol.toFixed(1)}x Vol</span>`;
                } else if (rvol < 0.5) {
                    rvolBadge = `<span style="background: rgba(255,200,0,0.2); color: var(--yellow); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">âš ï¸ ${rvol < 0.1 ? '<0.1' : rvol.toFixed(1)}x Vol</span>`;
                }
                
                // Pro mode badges
                let proBadges = '';
                if (currentLevel === 'pro') {
                    // Extension snap-back
                    if (data.extension?.hottest_setup) {
                        const ext = data.extension.hottest_setup;
                        proBadges += `<div style="background: rgba(157,78,221,0.2); border: 1px solid var(--purple); border-radius: 8px; padding: 8px; margin: 8px 0;">
                            <div style="font-weight: 700; color: var(--purple);">ðŸš€ Extension Snap: ${ext.trigger}</div>
                            <div style="font-size: 0.85rem; color: var(--text-gray);">${ext.candles} candles ${ext.direction} ${ext.level.toUpperCase()} â†’ <span style="color: var(--green);">${ext.snap_back_prob}% snap-back</span></div>
                        </div>`;
                    }
                    
                    // At key level
                    const price = data.current_price;
                    const threshold = 0.005;
                    let atLevel = null;
                    if (data.vah && Math.abs(price - data.vah) / data.vah < threshold) atLevel = { name: 'VAH', value: data.vah };
                    else if (data.val && Math.abs(price - data.val) / data.val < threshold) atLevel = { name: 'VAL', value: data.val };
                    else if (data.poc && Math.abs(price - data.poc) / data.poc < threshold) atLevel = { name: 'POC', value: data.poc };
                    
                    if (atLevel) {
                        proBadges += `<div style="background: rgba(100,150,255,0.2); border: 1px solid #6496ff; border-radius: 8px; padding: 8px; margin: 8px 0;">
                            <div style="font-weight: 700; color: #6496ff;">ðŸ“ At Key Level: ${atLevel.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-gray);">Price at $${atLevel.value?.toFixed(2)} - watch for breakout or rejection</div>
                        </div>`;
                    }
                    
                    // Entry signals
                    if (entrySignals.length > 0) {
                        const sig = entrySignals[0];
                        const sigColor = sig.direction === 'long' ? 'var(--green)' : 'var(--red)';
                        proBadges += `<div style="background: rgba(0,255,136,0.1); border: 1px solid ${sigColor}; border-radius: 8px; padding: 8px; margin: 8px 0;">
                            <div style="font-weight: 700; color: ${sigColor};">ðŸŽ¯ Entry Signal: ${sig.entry_type.replace(/_/g, ' ').toUpperCase()}</div>
                            <div style="font-size: 0.85rem; color: var(--text-gray);">${sig.direction.toUpperCase()} @ $${sig.entry_price?.toFixed(2)} | Conf: ${sig.confidence}%</div>
                        </div>`;
                    }
                    
                    // Squeeze check (RSI between 40-60)
                    if (data.rsi && data.rsi >= 40 && data.rsi <= 60 && rvol < 1.0) {
                        proBadges += `<div style="background: rgba(255,200,0,0.2); border: 1px solid var(--yellow); border-radius: 8px; padding: 8px; margin: 8px 0;">
                            <div style="font-weight: 700; color: var(--yellow);">ðŸŽ° Squeeze Setup</div>
                            <div style="font-size: 0.85rem; color: var(--text-gray);">Low volume + neutral RSI â†’ coiling for move</div>
                        </div>`;
                    }
                }
                
                // Parse AI for cards
                const aiText = aiData.ai_commentary || '';
                const parsed = parseAIResponse(aiText, data);
                const aiCardsHTML = buildAICardsHTML(parsed, symbol);
                
                modal.querySelector('.modal-body').innerHTML = `
                    <div class="account-settings">
                        <label>
                            ðŸ’° Account:
                            <input type="text" id="account-size-input" value="${getAccountSize()}" onchange="saveAccountSize(this.value)" placeholder="$10,000">
                        </label>
                        <label>
                            ðŸ“Š Risk:
                            <select id="risk-percent-input" onchange="saveRiskPercent(this.value)">
                                <option value="0.5" ${getRiskPercent() == 0.5 ? 'selected' : ''}>0.5%</option>
                                <option value="1" ${getRiskPercent() == 1 ? 'selected' : ''}>1%</option>
                                <option value="1.5" ${getRiskPercent() == 1.5 ? 'selected' : ''}>1.5%</option>
                                <option value="2" ${getRiskPercent() == 2 ? 'selected' : ''}>2%</option>
                            </select>
                        </label>
                        <span style="color: var(--cyan); font-weight: 600;">1R = $${calculateOneR().toFixed(0)}</span>
                    </div>
                    <div class="side-by-side-container">
                        <!-- LEFT: Analysis Data -->
                        <div class="analysis-panel">
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <div style="font-size: 2.5rem; margin-bottom: 0.25rem;">${dirEmoji}</div>
                                <div style="font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--${dirColor});">${data.signal || 'NEUTRAL'}</div>
                                <div style="margin-top: 0.5rem;">${rvolBadge}</div>
                            </div>
                            
                            ${proBadges}
                            
                            <div class="score-display" style="margin: 1rem 0;">
                                <div class="score-box bull" style="padding: 0.5rem 1rem;">
                                    <div class="score-number" style="color: var(--green); font-size: 1.5rem;">${data.bull_score || 0}</div>
                                    <div class="score-label">Bull</div>
                                </div>
                                <div class="score-box bear" style="padding: 0.5rem 1rem;">
                                    <div class="score-number" style="color: var(--red); font-size: 1.5rem;">${data.bear_score || 0}</div>
                                    <div class="score-label">Bear</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <div class="level-row">
                                    <span class="level-label">Confidence</span>
                                    <span class="level-value cyan">${data.confidence?.toFixed(0) || 0}%</span>
                                </div>
                                <div class="level-row">
                                    <span class="level-label">Current Price</span>
                                    <span class="level-value">$${data.current_price?.toFixed(2) || '-'}</span>
                                </div>
                                ${data.vah ? `
                                <div class="level-row">
                                    <span class="level-label">VAH (Resistance)</span>
                                    <span class="level-value red">$${data.vah?.toFixed(2)}</span>
                                </div>
                                ` : ''}
                                ${data.poc ? `
                                <div class="level-row">
                                    <span class="level-label">POC (Fair Value)</span>
                                    <span class="level-value cyan">$${data.poc?.toFixed(2)}</span>
                                </div>
                                ` : ''}
                                ${data.val ? `
                                <div class="level-row">
                                    <span class="level-label">VAL (Support)</span>
                                    <span class="level-value green">$${data.val?.toFixed(2)}</span>
                                </div>
                                ` : ''}
                                ${data.rsi ? `
                                <div class="level-row">
                                    <span class="level-label">RSI (14)</span>
                                    <span class="level-value ${data.rsi > 70 ? 'red' : data.rsi < 30 ? 'green' : 'cyan'}">${data.rsi?.toFixed(1)} ${data.rsi > 70 ? 'âš ï¸ OB' : data.rsi < 30 ? 'âš ï¸ OS' : ''}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- RIGHT: AI Cards -->
                        <div class="ai-panel">
                            ${aiCardsHTML}
                        </div>
                    </div>
                `;
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
                
                // Add footer
                const modalEl = modal.querySelector('.modal');
                const footer = document.createElement('div');
                footer.className = 'modal-footer';
                footer.innerHTML = `<button class="action-btn secondary" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Close</button>`;
                modalEl.appendChild(footer);
                
            } catch (e) {
                modal.querySelector('.modal-body').innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">âŒ</div>
                        <p>Could not analyze ${symbol}. Check the symbol and try again.</p>
                    </div>
                `;
            }
        }
        
        async function loadAIForSymbol(btn, symbol) {
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;display:inline-block;margin-right:8px;"></div> Loading AI...';
            btn.disabled = true;
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`);
                
                const aiText = data.ai_commentary || '';
                const parsed = parseAIResponse(aiText, data);
                
                const responseDiv = document.getElementById('ai-response-quick');
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = buildAICardsHTML(parsed, symbol);
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
                
                btn.innerHTML = 'âœ… AI Loaded';
                btn.style.background = 'rgba(0,255,136,0.2)';
                btn.style.borderColor = 'var(--green)';
            } catch (e) {
                btn.innerHTML = 'âŒ Error loading AI';
                btn.disabled = false;
            }
        }
        
        function toggleAllScans(level) {
            const container = document.getElementById(level === 'beginner' ? 'beginner-scans' : 'pro-scans');
            const allBtn = container.querySelector('.scan-pill.all');
            const isActive = allBtn.classList.contains('active');
            
            // Get scan types for this level
            const beginnerScans = ['bullish', 'bearish', 'entry', 'highVolume'];
            const proScans = ['bullish', 'bearish', 'entry', 'highVolume', 'squeeze', 'extension', 'atLevels', 'aPlus'];
            const scans = level === 'beginner' ? beginnerScans : proScans;
            
            // Toggle all scans
            scans.forEach(scan => {
                selectedScans[scan] = !isActive;
            });
            
            // Update button states
            container.querySelectorAll('.scan-pill:not(.all)').forEach(btn => {
                btn.classList.toggle('active', !isActive);
            });
            allBtn.classList.toggle('active');
        }
        
        function setLevel(level) {
            currentLevel = level;
            
            // Update buttons
            document.getElementById('beginner-btn').classList.toggle('active', level === 'beginner');
            document.getElementById('pro-btn').classList.toggle('active', level === 'pro');
            
            // Show/hide scan types
            document.getElementById('beginner-scans').style.display = level === 'beginner' ? 'flex' : 'none';
            document.getElementById('pro-scans').style.display = level === 'pro' ? 'flex' : 'none';
            
            // Reset all scan selections when switching levels
            selectedScans = { bullish: false, bearish: false, entry: false, highVolume: false, squeeze: false, extension: false, atLevels: false, aPlus: false };
            document.querySelectorAll('.scan-pill').forEach(btn => btn.classList.remove('active'));
        }
        
        function selectUniverse(universe) {
            selectedUniverse = universe;
            document.querySelectorAll('.universe-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function toggleScan(btn, type) {
            btn.classList.toggle('active');
            selectedScans[type] = btn.classList.contains('active');
        }
        
        async function fetchJson(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }
        
        async function runScan() {
            const symbols = UNIVERSES[selectedUniverse];
            if (!symbols.length) {
                showToast('Select a universe first!', 'error');
                return;
            }
            
            // Check if any scan type is selected
            const hasSelection = Object.values(selectedScans).some(v => v);
            if (!hasSelection) {
                showToast('Select at least one scan type!', 'error');
                return;
            }
            
            // Reset
            allResults = [];
            document.getElementById('results-card').style.display = 'block';
            document.getElementById('result-list').innerHTML = '<div class="loading"><div class="spinner"></div>Scanning...</div>';
            
            // Show progress
            const progress = document.getElementById('progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            progress.style.display = 'block';
            progressFill.style.width = '0%';
            
            document.querySelector('.path-action-btn.scan').disabled = true;
            
            let completed = 0;
            const total = symbols.length;
            
            // Scan in batches
            const BATCH_SIZE = 5;
            
            for (let i = 0; i < symbols.length; i += BATCH_SIZE) {
                const batch = symbols.slice(i, i + BATCH_SIZE);
                
                const promises = batch.map(async (symbol) => {
                    try {
                        // Always fetch base analysis data if any scan needs it
                        const needsAnalysis = selectedScans.bullish || selectedScans.bearish || selectedScans.highVolume || selectedScans.atLevels || selectedScans.aPlus || selectedScans.extension || selectedScans.squeeze;
                        let data = null;
                        
                        if (needsAnalysis) {
                            data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=false`);
                        }
                        
                        // ðŸŸ¢ BULLISH SCAN
                        if (selectedScans.bullish && data?.signal?.includes('LONG')) {
                            if (!selectedScans.aPlus || data.confidence >= 80) {
                                allResults.push({
                                    symbol,
                                    signal: data.signal,
                                    signal_type: 'long_setup',
                                    direction: 'long',
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    vwap: data.vwap,
                                    rsi: data.rsi,
                                    type: 'bullish'
                                });
                            }
                        }
                        
                        // ðŸ”´ BEARISH SCAN
                        if (selectedScans.bearish && data?.signal?.includes('SHORT')) {
                            if (!selectedScans.aPlus || data.confidence >= 80) {
                                allResults.push({
                                    symbol,
                                    signal: data.signal,
                                    signal_type: 'short_setup',
                                    direction: 'short',
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    vwap: data.vwap,
                                    rsi: data.rsi,
                                    type: 'bearish'
                                });
                            }
                        }
                        
                        // ðŸ”¥ HIGH VOLUME SCAN (RVOL >= 2.0)
                        if (selectedScans.highVolume && data && (data.rvol || 1.0) >= 2.0) {
                            const direction = data.signal?.includes('LONG') ? 'long' : data.signal?.includes('SHORT') ? 'short' : 'neutral';
                            // Avoid duplicates if already added by bullish/bearish
                            const alreadyAdded = allResults.some(r => r.symbol === symbol && (r.type === 'bullish' || r.type === 'bearish'));
                            if (!alreadyAdded) {
                                allResults.push({
                                    symbol,
                                    signal: `ðŸ”¥ HIGH VOLUME ${data.rvol?.toFixed(1)}x`,
                                    direction,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    type: 'highVolume'
                                });
                            }
                        }
                        
                        // ðŸ“ AT KEY LEVELS (price within 0.5% of VAH, POC, or VAL)
                        if (selectedScans.atLevels && data) {
                            const price = data.current_price;
                            const threshold = 0.005; // 0.5%
                            let levelHit = null;
                            
                            // Determine actual direction from bull/bear scores
                            const isBullish = (data.bull_score || 0) > (data.bear_score || 0);
                            const isBearish = (data.bear_score || 0) > (data.bull_score || 0);
                            
                            if (data.vah && Math.abs(price - data.vah) / data.vah < threshold) {
                                // At VAH: typically short if bearish scores, but respect actual scores
                                levelHit = { level: 'VAH', value: data.vah, direction: isBullish ? 'long' : 'short' };
                            } else if (data.val && Math.abs(price - data.val) / data.val < threshold) {
                                // At VAL: typically long if bullish scores, but respect actual scores
                                levelHit = { level: 'VAL', value: data.val, direction: isBullish ? 'long' : 'short' };
                            } else if (data.poc && Math.abs(price - data.poc) / data.poc < threshold) {
                                // At POC: use bull/bear scores to determine
                                levelHit = { level: 'POC', value: data.poc, direction: isBullish ? 'long' : (isBearish ? 'short' : 'neutral') };
                            }
                            
                            if (levelHit) {
                                allResults.push({
                                    symbol,
                                    signal: `ðŸ“ AT ${levelHit.level} ($${levelHit.value?.toFixed(2)})`,
                                    direction: levelHit.direction,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    type: 'atLevels'
                                });
                            }
                        }
                        
                        // ðŸŽ¯ ENTRY SIGNALS
                        if (selectedScans.entry) {
                            try {
                                const tfResolution = {'5MIN': 5, '15MIN': 15, '30MIN': 30, '1HR': 60, '2HR': 120, '4HR': 240}[selectedTimeframe] || 60;
                                const entryData = await fetchJson(`${API_BASE}/api/entry-scan/scan/${symbol}?resolution=${tfResolution}&days=5&mtf_filter=true`);
                                if (entryData.signals?.length > 0) {
                                    for (const sig of entryData.signals) {
                                        const isLongEntry = sig.direction === 'long';
                                        const isShortEntry = sig.direction === 'short';
                                        
                                        const addLong = selectedScans.bullish && isLongEntry;
                                        const addShort = selectedScans.bearish && isShortEntry;
                                        const addAll = !selectedScans.bullish && !selectedScans.bearish;
                                        
                                        if ((addLong || addShort || addAll) && (!selectedScans.aPlus || sig.confidence >= 80)) {
                                            allResults.push({
                                                symbol,
                                                signal: sig.entry_type.replace(/_/g, ' ').toUpperCase(),
                                                signal_type: sig.entry_type,  // Raw type for AI (e.g. "failed_breakout")
                                                direction: sig.direction,
                                                confidence: sig.confidence || 0,
                                                entry_price: sig.entry_price,
                                                stop_price: sig.stop_price,
                                                target_1: sig.target_1,
                                                rr_ratio: sig.rr_ratio,
                                                rvol: entryData.rvol || 1.0,
                                                current_price: entryData.current_price,
                                                vah: entryData.levels?.vah,
                                                poc: entryData.levels?.poc,
                                                val: entryData.levels?.val,
                                                type: 'entry'
                                            });
                                            break;
                                        }
                                    }
                                }
                            } catch (e) {}
                        }
                        
                        // ðŸŽ° SQUEEZE SCAN (uses data from analyze endpoint)
                        if (selectedScans.squeeze && data) {
                            // Calculate squeeze score based on multiple factors
                            let squeezeScore = 0;
                            let squeezeFactors = [];
                            
                            // Factor 1: Low relative volume (coiling = less activity)
                            const rvol = data.rvol || 1.0;
                            if (rvol < 0.5) { squeezeScore += 30; squeezeFactors.push('Very low vol'); }
                            else if (rvol < 0.8) { squeezeScore += 20; squeezeFactors.push('Low vol'); }
                            else if (rvol < 1.0) { squeezeScore += 10; squeezeFactors.push('Below avg vol'); }
                            
                            // Factor 2: Neutral RSI (not overbought/oversold = balanced)
                            const rsi = data.rsi || 50;
                            if (rsi >= 45 && rsi <= 55) { squeezeScore += 25; squeezeFactors.push('RSI coiling'); }
                            else if (rsi >= 40 && rsi <= 60) { squeezeScore += 15; squeezeFactors.push('RSI neutral'); }
                            
                            // Factor 3: Inside value area (consolidating in fair value)
                            const price = data.current_price;
                            const vah = data.vah || price * 1.01;
                            const val = data.val || price * 0.99;
                            const poc = data.poc || price;
                            const valueRange = vah - val;
                            const distFromPoc = Math.abs(price - poc);
                            
                            if (price >= val && price <= vah) {
                                squeezeScore += 20;
                                squeezeFactors.push('In value');
                                // Bonus if very close to POC (true center)
                                if (valueRange > 0 && distFromPoc / valueRange < 0.15) {
                                    squeezeScore += 15;
                                    squeezeFactors.push('At POC');
                                }
                            }
                            
                            // Factor 4: Tight range (VAH-VAL spread is small vs price)
                            if (valueRange > 0 && valueRange / price < 0.015) {
                                squeezeScore += 20;
                                squeezeFactors.push('Tight range');
                            } else if (valueRange > 0 && valueRange / price < 0.025) {
                                squeezeScore += 10;
                                squeezeFactors.push('Narrow range');
                            }
                            
                            // Factor 5: Volume trend decreasing
                            if (data.volume_trend === 'decreasing') {
                                squeezeScore += 10;
                                squeezeFactors.push('Vol fading');
                            }
                            
                            // Require minimum score of 50 to qualify as squeeze
                            if (squeezeScore >= 50) {
                                // Determine likely breakout direction
                                const bullScore = data.bull_score || 0;
                                const bearScore = data.bear_score || 0;
                                let bias = 'neutral';
                                if (bullScore > bearScore + 10) bias = 'long';
                                else if (bearScore > bullScore + 10) bias = 'short';
                                
                                // Calculate confidence based on squeeze score
                                const confidence = Math.min(90, squeezeScore);
                                
                                allResults.push({
                                    symbol,
                                    signal: `ðŸŽ° SQUEEZE ${squeezeScore >= 70 ? '(TIGHT)' : ''} - ${squeezeFactors.slice(0, 2).join(', ')}`,
                                    direction: bias,
                                    confidence: confidence,
                                    squeeze_score: squeezeScore,
                                    bull_score: bullScore,
                                    bear_score: bearScore,
                                    rvol: rvol,
                                    current_price: price,
                                    vah: vah,
                                    poc: poc,
                                    val: val,
                                    type: 'squeeze'
                                });
                            }
                        }
                        
                        // ðŸš€ EXTENSION SNAP (uses data from analyze endpoint)
                        if (selectedScans.extension && data?.extension?.hottest_setup) {
                            const ext = data.extension.hottest_setup;
                            if (ext.snap_back_prob >= 65) {
                                // Snap direction is opposite of extension
                                const snapDirection = ext.direction === 'above' ? 'short' : 'long';
                                allResults.push({
                                    symbol,
                                    signal: `ðŸš€ ${ext.trigger} - ${ext.candles} candles ${ext.direction} ${ext.level.toUpperCase()}`,
                                    direction: snapDirection,
                                    confidence: ext.snap_back_prob,
                                    probability: ext.snap_back_prob,
                                    candles: ext.candles,
                                    trigger: ext.trigger,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    type: 'extension'
                                });
                            }
                        }
                        
                    } catch (e) {}
                    
                    completed++;
                    progressFill.style.width = `${(completed / total) * 100}%`;
                    progressText.textContent = `Scanning ${completed}/${total}...`;
                });
                
                await Promise.all(promises);
                if (i + BATCH_SIZE < symbols.length) {
                    await new Promise(r => setTimeout(r, 600));
                }
            }
            
            // Done
            progressText.textContent = 'âœ… Scan complete!';
            progressFill.style.width = '100%';
            document.querySelector('.path-action-btn.scan').disabled = false;
            
            // Sort by confidence
            allResults.sort((a, b) => b.confidence - a.confidence);
            
            // Auto-generate report for top results (background)
            if (allResults.length > 0 && autoReportEnabled) {
                generateAutoReport(allResults);
            }
            
            displayResults();
        }
        
        // Auto-report toggle state
        let autoReportEnabled = true;
        
        async function generateAutoReport(results) {
            console.log('ðŸ“ generateAutoReport called with', results.length, 'results');
            console.log('ðŸ“ window.db:', window.db);
            console.log('ðŸ“ window.currentUser:', window.currentUser?.email);
            
            // Save reports directly to Firestore from frontend (bypasses backend service account issue)
            if (!window.db) {
                console.warn('âŒ Firestore not available for reports');
                return;
            }
            
            if (!window.currentUser) {
                console.warn('âŒ User not logged in - reports not saved');
                return;
            }
            
            try {
                const dateStr = new Date().toISOString().split('T')[0];
                const timestamp = new Date().toISOString();
                let savedCount = 0;
                
                // Sort by score and take top performers
                const sorted = [...results].sort((a, b) => {
                    const aScore = Math.max(a.bull_score || 0, a.bear_score || 0);
                    const bScore = Math.max(b.bull_score || 0, b.bear_score || 0);
                    return bScore - aScore;
                });
                
                console.log('ðŸ“ Top result:', sorted[0]?.symbol, 'score:', Math.max(sorted[0]?.bull_score || 0, sorted[0]?.bear_score || 0));
                
                // Save top 10 with score >= 55
                for (const result of sorted.slice(0, 10)) {
                    const maxScore = Math.max(result.bull_score || 0, result.bear_score || 0);
                    if (maxScore < 55) continue;
                    
                    const direction = (result.bull_score || 0) > (result.bear_score || 0) ? 'LONG' : 'SHORT';
                    const report = {
                        symbol: result.symbol,
                        date: dateStr,
                        created_at: timestamp,
                        type: 'scan_analysis',
                        direction: direction,
                        bull_score: result.bull_score || 0,
                        bear_score: result.bear_score || 0,
                        confidence: result.confidence || 0,
                        price: result.current_price || result.price || 0,
                        vah: result.vah || 0,
                        poc: result.poc || 0,
                        val: result.val || 0,
                        vwap: result.vwap || 0,
                        rsi: result.rsi || 50,
                        rvol: result.rvol || 1,
                        notes: result.notes || [],
                        timeframe: document.getElementById('timeframe')?.value || '1HR',
                        user_id: window.currentUser?.uid || 'anonymous'
                    };
                    
                    await window.db.collection('reports').add(report);
                    savedCount++;
                }
                
                if (savedCount > 0) {
                    console.log(`ðŸ“ Saved ${savedCount} reports to Firestore`);
                    showReportNotification({ count: savedCount });
                }
            } catch (e) {
                console.warn('Auto-report save failed:', e);
            }
        }
        
        function showReportNotification(data) {
            // Create subtle toast notification
            const toast = document.createElement('div');
            toast.className = 'report-toast';
            toast.innerHTML = `
                <span>ðŸ“ ${data.count || 0} reports saved to Firestore</span>
                <button onclick="this.parentElement.remove()">Ã—</button>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => toast.remove(), 5000);
        }
        
        function displayResults(filter = 'all') {
            const list = document.getElementById('result-list');
            const count = document.getElementById('results-count');
            currentDirectionFilter = filter;
            
            // Get filter values
            minScoreFilter = parseInt(document.getElementById('min-score-filter')?.value || 0);
            sortBy = document.getElementById('sort-by')?.value || 'score';
            
            // Filter by direction
            let filtered = allResults;
            if (filter === 'long') {
                filtered = allResults.filter(r => r.direction === 'long');
            } else if (filter === 'short') {
                filtered = allResults.filter(r => r.direction === 'short');
            }
            
            // Filter by minimum score
            if (minScoreFilter > 0) {
                filtered = filtered.filter(r => {
                    const maxScore = Math.max(r.bull_score || 0, r.bear_score || 0);
                    return maxScore >= minScoreFilter;
                });
            }
            
            // Sort results
            if (sortBy === 'score') {
                filtered.sort((a, b) => {
                    const aMax = Math.max(a.bull_score || 0, a.bear_score || 0);
                    const bMax = Math.max(b.bull_score || 0, b.bear_score || 0);
                    return bMax - aMax;
                });
            } else if (sortBy === 'confidence') {
                filtered.sort((a, b) => b.confidence - a.confidence);
            } else if (sortBy === 'rvol') {
                filtered.sort((a, b) => (b.rvol || 0) - (a.rvol || 0));
            } else if (sortBy === 'symbol') {
                filtered.sort((a, b) => a.symbol.localeCompare(b.symbol));
            }
            
            count.textContent = `${filtered.length} Results`;
            
            // Update filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase().includes(filter) || (filter === 'all' && tab.textContent === 'All'));
            });
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ðŸ”</div>
                        <p>No signals found. Try a different universe or scan type.</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(r => {
                const dirClass = r.direction === 'long' ? 'long' : r.direction === 'short' ? 'short' : 'neutral';
                const emoji = r.direction === 'long' ? 'ðŸŸ¢' : r.direction === 'short' ? 'ðŸ”´' : 'ðŸŸ¡';
                
                // RVOL badge
                let rvolBadge = '';
                if (r.rvol >= 2.0) {
                    rvolBadge = `<span class="badge rvol-high">ðŸ”¥ ${r.rvol.toFixed(1)}x Vol</span>`;
                } else if (r.rvol >= 1.5) {
                    rvolBadge = `<span class="badge rvol-good">ðŸ“ˆ ${r.rvol.toFixed(1)}x Vol</span>`;
                } else if (r.rvol <= 0.5 && r.type !== 'squeeze') {
                    rvolBadge = `<span class="badge rvol-low">âš ï¸ ${r.rvol.toFixed(1)}x Vol</span>`;
                }
                
                // Squeeze score badge (only for squeeze type)
                let squeezeBadge = '';
                if (r.type === 'squeeze' && r.squeeze_score) {
                    const intensity = r.squeeze_score >= 80 ? 'ðŸ”¥' : r.squeeze_score >= 70 ? 'ðŸ’ª' : 'ðŸŽ¯';
                    squeezeBadge = `<span class="badge squeeze-score">${intensity} ${r.squeeze_score}pt Squeeze</span>`;
                }
                
                // Score badge showing bull/bear score
                const bullScore = r.bull_score || 0;
                const bearScore = r.bear_score || 0;
                const maxScore = Math.max(bullScore, bearScore);
                let scoreColor = maxScore >= 70 ? 'score-high' : maxScore >= 50 ? 'score-med' : 'score-low';
                let scoreLabel = bullScore > bearScore ? `ðŸ‚ ${maxScore}` : bearScore > bullScore ? `ðŸ» ${maxScore}` : `âš–ï¸ ${maxScore}`;
                
                return `
                    <div class="result-item" onclick="showDetails('${r.symbol}', ${JSON.stringify(r).replace(/"/g, '&quot;')})">
                        <div>
                            <div class="result-symbol">${emoji} ${r.symbol}</div>
                            <div class="result-signal ${dirClass}">${r.signal}</div>
                        </div>
                        <div class="result-badges">
                            <span class="badge ${scoreColor}">${scoreLabel}</span>
                            <span class="badge confidence">${r.confidence.toFixed(0)}%</span>
                            ${squeezeBadge}
                            ${rvolBadge}
                        </div>
                        <div class="result-actions">
                            <button class="action-btn primary" onclick="event.stopPropagation(); showDetails('${r.symbol}', ${JSON.stringify(r).replace(/"/g, '&quot;')})">ðŸ“Š Details</button>
                            <button class="action-btn secondary" onclick="event.stopPropagation(); getAIPlan('${r.symbol}', '${r.direction}', '${r.signal_type || ''}')">ðŸ¤– AI Plan</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterResults(filter) {
            displayResults(filter);
        }
        
        function applyFilters() {
            displayResults(currentDirectionFilter);
        }
        
        async function showDetails(symbol, data) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Determine CURRENT TREND from bull/bear scores
            const bullScore = data.bull_score || 0;
            const bearScore = data.bear_score || 0;
            let trendEmoji, trendColor, trendText;
            if (bullScore > bearScore + 5) {
                trendEmoji = 'ðŸŸ¢';
                trendColor = 'green';
                trendText = 'BULLISH';
            } else if (bearScore > bullScore + 5) {
                trendEmoji = 'ðŸ”´';
                trendColor = 'red';
                trendText = 'BEARISH';
            } else {
                trendEmoji = 'ðŸŸ¡';
                trendColor = 'yellow';
                trendText = 'NEUTRAL';
            }
            
            // Determine TRADE SETUP from multiple sources:
            // 1. Explicit direction from scan
            // 2. Entry/stop relationship (if stop > entry = SHORT, if stop < entry = LONG)
            // 3. Signal text analysis
            let setupEmoji, setupColor, setupText, hasConflict = false;
            
            // Check entry/stop relationship for direction
            let inferredDirection = data.direction;
            if (!inferredDirection && data.entry_price && data.stop_price) {
                inferredDirection = data.stop_price > data.entry_price ? 'short' : 'long';
            }
            // Also check signal text for hints
            if (!inferredDirection && data.signal) {
                const sigLower = data.signal.toLowerCase();
                if (sigLower.includes('rejection') || sigLower.includes('short') || sigLower.includes('bear')) {
                    inferredDirection = 'short';
                } else if (sigLower.includes('bounce') || sigLower.includes('long') || sigLower.includes('bull')) {
                    inferredDirection = 'long';
                }
            }
            
            if (inferredDirection === 'short') {
                setupEmoji = 'ðŸ”´';
                setupColor = 'red';
                setupText = 'SHORT';
                // Check if trend conflicts with setup OR if trend is neutral but we have a directional trade
                if (bullScore > bearScore + 5) {
                    hasConflict = true;
                } else if (trendText === 'NEUTRAL') {
                    hasConflict = true; // Show hybrid for neutral trend with directional setup
                }
            } else if (inferredDirection === 'long') {
                setupEmoji = 'ðŸŸ¢';
                setupColor = 'green';
                setupText = 'LONG';
                if (bearScore > bullScore + 5) {
                    hasConflict = true;
                } else if (trendText === 'NEUTRAL') {
                    hasConflict = true; // Show hybrid for neutral trend with directional setup
                }
            } else {
                setupEmoji = trendEmoji;
                setupColor = trendColor;
                setupText = trendText;
            }
            
            // Build hybrid bias display
            let biasHTML = '';
            if (hasConflict) {
                // Determine trade type label based on context
                let tradeTypeLabel = setupText;
                if (trendText === 'BULLISH' && setupText === 'SHORT') {
                    tradeTypeLabel = 'SHORT (Pullback)';
                } else if (trendText === 'BEARISH' && setupText === 'LONG') {
                    tradeTypeLabel = 'LONG (Bounce)';
                } else if (trendText === 'NEUTRAL') {
                    tradeTypeLabel = setupText + ' ENTRY';
                }
                
                // Show BOTH trend and setup
                biasHTML = `
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; flex: 1;">
                            <div style="font-size: 0.7rem; color: var(--text-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Current Trend</div>
                            <div style="font-size: 1.5rem;">${trendEmoji}</div>
                            <div style="font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--${trendColor});">${trendText}</div>
                        </div>
                        <div style="display: flex; align-items: center; color: var(--text-gray);">â†’</div>
                        <div style="text-align: center; padding: 0.75rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid var(--${setupColor}); border-radius: 8px; flex: 1;">
                            <div style="font-size: 0.7rem; color: var(--${setupColor}); text-transform: uppercase; margin-bottom: 0.25rem;">Trade Setup</div>
                            <div style="font-size: 1.5rem;">${setupEmoji}</div>
                            <div style="font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--${setupColor});">${tradeTypeLabel}</div>
                        </div>
                    </div>
                    ${trendText !== 'NEUTRAL' ? `
                    <div style="background: rgba(255,200,0,0.15); border: 1px solid var(--yellow); border-radius: 8px; padding: 0.5rem; margin-bottom: 1rem; text-align: center; font-size: 0.8rem;">
                        âš ï¸ <strong>Counter-Trend Trade</strong> - ${trendText} trend but ${setupText.toLowerCase()} setup
                    </div>
                    ` : ''}
                `;
            } else {
                // Normal display when trend matches setup (or no conflict)
                // Add clear direction label
                let dirLabel = '';
                if (inferredDirection === 'short') {
                    dirLabel = `<div style="background: rgba(255,71,87,0.2); color: var(--red); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; margin-top: 0.5rem;">â¬‡ï¸ SHORT TRADE</div>`;
                } else if (inferredDirection === 'long') {
                    dirLabel = `<div style="background: rgba(0,255,136,0.2); color: var(--green); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; margin-top: 0.5rem;">â¬†ï¸ LONG TRADE</div>`;
                }
                
                biasHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.25rem;">${setupEmoji}</div>
                        <div style="font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--${setupColor});">${data.signal || setupText}</div>
                        ${dirLabel}
                    </div>
                `;
            }
            
            // RVOL badge - ensure we show at least 0.1x (avoid 0.0x display)
            const rvol = Math.max(data.rvol || 1.0, 0.01);
            let rvolBadge = '';
            if (rvol >= 2.0) {
                rvolBadge = `<span style="background: rgba(255,59,92,0.3); color: var(--red); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 700;">ðŸ”¥ ${rvol.toFixed(1)}x Vol</span>`;
            } else if (rvol >= 1.5) {
                rvolBadge = `<span style="background: rgba(0,245,212,0.2); color: var(--cyan); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 700;">ðŸ“ˆ ${rvol.toFixed(1)}x Vol</span>`;
            } else if (rvol < 0.5) {
                rvolBadge = `<span style="background: rgba(255,200,0,0.2); color: var(--yellow); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">âš ï¸ ${rvol < 0.1 ? '<0.1' : rvol.toFixed(1)}x Vol</span>`;
            }
            
            modal.innerHTML = `
                <div class="modal wide">
                    <div class="modal-header">
                        <div class="modal-title">${setupEmoji} ${symbol} <span style="font-size: 0.7rem; color: var(--text-gray);">${currentLevel.toUpperCase()} MODE</span></div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="account-settings">
                            <label>
                                ðŸ’° Account:
                                <input type="text" id="account-size-input" value="${getAccountSize()}" onchange="saveAccountSize(this.value)" placeholder="$10,000">
                            </label>
                            <label>
                                ðŸ“Š Risk:
                                <select id="risk-percent-input" onchange="saveRiskPercent(this.value)">
                                    <option value="0.5" ${getRiskPercent() == 0.5 ? 'selected' : ''}>0.5%</option>
                                    <option value="1" ${getRiskPercent() == 1 ? 'selected' : ''}>1%</option>
                                    <option value="1.5" ${getRiskPercent() == 1.5 ? 'selected' : ''}>1.5%</option>
                                    <option value="2" ${getRiskPercent() == 2 ? 'selected' : ''}>2%</option>
                                </select>
                            </label>
                            <span style="color: var(--cyan); font-weight: 600;">1R = $${calculateOneR().toFixed(0)}</span>
                        </div>
                        <div class="side-by-side-container">
                            <!-- LEFT: Analysis Data -->
                            <div class="analysis-panel">
                                ${biasHTML}
                                <div style="text-align: center; margin-bottom: 0.5rem;">${rvolBadge}</div>
                                
                                <div class="score-display" style="margin: 1rem 0;">
                                    <div class="score-box bull" style="padding: 0.5rem 1rem;">
                                        <div class="score-number" style="color: var(--green); font-size: 1.5rem;">${bullScore}</div>
                                        <div class="score-label">Bull</div>
                                    </div>
                                    <div class="score-box bear" style="padding: 0.5rem 1rem;">
                                        <div class="score-number" style="color: var(--red); font-size: 1.5rem;">${bearScore}</div>
                                        <div class="score-label">Bear</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 1rem;">
                                    <div class="level-row">
                                        <span class="level-label">Confidence</span>
                                        <span class="level-value cyan">${data.confidence?.toFixed(0) || 0}%</span>
                                    </div>
                                    <div class="level-row">
                                        <span class="level-label">Current Price</span>
                                        <span class="level-value">$${data.current_price?.toFixed(2) || '-'}</span>
                                    </div>
                                    ${data.vah ? `
                                    <div class="level-row">
                                        <span class="level-label">VAH (Resistance)</span>
                                        <span class="level-value red">$${data.vah?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                    ${data.poc ? `
                                    <div class="level-row">
                                        <span class="level-label">POC (Fair Value)</span>
                                        <span class="level-value cyan">$${data.poc?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                    ${data.val ? `
                                    <div class="level-row">
                                        <span class="level-label">VAL (Support)</span>
                                        <span class="level-value green">$${data.val?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                    ${data.rsi ? `
                                    <div class="level-row">
                                        <span class="level-label">RSI (14)</span>
                                        <span class="level-value ${data.rsi > 70 ? 'red' : data.rsi < 30 ? 'green' : 'cyan'}">${data.rsi?.toFixed(1)} ${data.rsi > 70 ? 'âš ï¸ OB' : data.rsi < 30 ? 'âš ï¸ OS' : ''}</span>
                                    </div>
                                    ` : ''}
                                    ${data.entry_price ? `
                                    <div class="level-row">
                                        <span class="level-label">Entry Price</span>
                                        <span class="level-value cyan">$${data.entry_price?.toFixed(2)}</span>
                                    </div>
                                    <div class="level-row">
                                        <span class="level-label">Stop Loss</span>
                                        <span class="level-value red">$${data.stop_price?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- RIGHT: AI Cards -->
                            <div class="ai-panel">
                                <div class="loading"><div class="spinner"></div>Loading AI analysis...</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="action-btn secondary" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').appendChild(modal);
            
            // Auto-load AI analysis - pass scanner context so AI knows the setup
            try {
                // Build entry_signal from scan data so AI respects the detected setup
                let entrySignal = '';
                if (inferredDirection && data.signal) {
                    // Format: "signal_type:direction" e.g. "vah_touch_rejection:short"
                    const signalType = data.signal.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
                    entrySignal = `${signalType}:${inferredDirection}`;
                } else if (inferredDirection) {
                    entrySignal = `entry:${inferredDirection}`;
                }
                
                let aiUrl = `${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`;
                if (entrySignal) {
                    aiUrl += `&entry_signal=${encodeURIComponent(entrySignal)}`;
                }
                
                const aiData = await fetchJson(aiUrl);
                const aiText = aiData.ai_commentary || '';
                const parsed = parseAIResponse(aiText, aiData);
                
                modal.querySelector('.ai-panel').innerHTML = buildAICardsHTML(parsed, symbol);
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
            } catch (e) {
                modal.querySelector('.ai-panel').innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 2rem;">
                        <div style="font-size: 2rem;">âŒ</div>
                        <p>Could not load AI analysis</p>
                    </div>
                `;
            }
        }
        
        async function loadAIExplanation(btn, symbol, direction) {
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;display:inline-block;margin-right:8px;"></div> Loading AI...';
            btn.disabled = true;
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`);
                
                const aiText = data.ai_commentary || '';
                const parsed = parseAIResponse(aiText, data);
                
                const responseDiv = document.getElementById(`ai-response-${symbol}`);
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = buildAICardsHTML(parsed, symbol);
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
                
                btn.innerHTML = 'âœ… AI Loaded';
                btn.style.background = 'rgba(0,255,136,0.2)';
                btn.style.borderColor = 'var(--green)';
            } catch (e) {
                btn.innerHTML = 'âŒ Error loading AI';
                btn.disabled = false;
            }
        }
        
        async function getAIPlan(symbol, direction, signalType = '') {
            // Get the scanner data for this symbol from allResults
            const scanData = allResults.find(r => r.symbol === symbol);
            if (!scanData) {
                alert('No scanner data found for ' + symbol);
                return;
            }
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal wide">
                    <div class="modal-header">
                        <div class="modal-title">ðŸ“ ${symbol} Rule-Based Trade Plan</div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="loading"><div class="spinner"></div>Generating trade plan from YOUR rules...</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            try {
                // Fetch past reports for this symbol from Firestore to give AI context
                let pastReports = [];
                if (window.db && window.currentUser) {
                    try {
                        const snapshot = await window.db.collection('reports')
                            .where('symbol', '==', scanData.symbol)
                            .where('user_id', '==', window.currentUser.uid)
                            .orderBy('created_at', 'desc')
                            .limit(5)
                            .get();
                        
                        pastReports = snapshot.docs.map(doc => doc.data());
                        console.log(`ðŸ“š Found ${pastReports.length} past reports for ${scanData.symbol}`);
                    } catch (e) {
                        console.warn('Could not fetch past reports:', e);
                    }
                }
                
                // Call the rule engine API with past report context
                const response = await fetch(`${API_BASE}/api/rules/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: scanData.symbol,
                        current_price: scanData.current_price,
                        vah: scanData.vah,
                        poc: scanData.poc,
                        val: scanData.val,
                        vwap: scanData.vwap || scanData.poc,
                        bull_score: scanData.bull_score || 0,
                        bear_score: scanData.bear_score || 0,
                        rsi: scanData.rsi || 50,
                        rvol: scanData.rvol || 1.0,
                        confidence: scanData.confidence || 50,
                        past_reports: pastReports  // Send past reports for AI context
                    })
                });
                
                if (!response.ok) throw new Error('Failed to generate plan');
                const plan = await response.json();
                
                // Build the plan display
                modal.querySelector('.modal-body').innerHTML = buildRulePlanHTML(plan);
                
            } catch (e) {
                // Fallback to old AI method
                console.warn('Rule engine error, falling back to AI:', e);
                try {
                    const entrySignal = signalType ? `${signalType.toLowerCase().replace(/ /g, '_')}:${direction}` : '';
                    let url = `${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`;
                    if (entrySignal) url += `&entry_signal=${encodeURIComponent(entrySignal)}`;
                    const data = await fetchJson(url);
                    
                    const aiText = data.ai_commentary || '';
                    const parsed = parseAIResponse(aiText, data);
                    
                    modal.querySelector('.modal-body').innerHTML = buildAICardsHTML(parsed, symbol);
                } catch (e2) {
                    modal.querySelector('.modal-body').innerHTML = `
                        <div class="empty-state">
                            <div class="emoji">âŒ</div>
                            <p>Error loading plan: ${e.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        function buildRulePlanHTML(plan) {
            const dirEmoji = plan.direction === 'LONG' ? 'ðŸŸ¢' : plan.direction === 'SHORT' ? 'ðŸ”´' : 'âšª';
            const dirColor = plan.direction === 'LONG' ? 'var(--green)' : plan.direction === 'SHORT' ? 'var(--red)' : 'var(--text-gray)';
            
            if (plan.direction === 'NO_TRADE') {
                return `
                    <div class="rule-plan-container">
                        <div class="plan-header no-trade">
                            <span class="direction-badge" style="background: var(--text-gray)">âšª NO TRADE</span>
                            <span class="plan-symbol">${plan.symbol}</span>
                        </div>
                        <div class="plan-section caution-section">
                            <h4>âš ï¸ Why No Trade</h4>
                            <ul>${plan.caution_flags.map(f => `<li>${f}</li>`).join('')}</ul>
                        </div>
                        <div class="plan-section">
                            <p style="color: var(--text-gray)">${plan.invalidation}</p>
                        </div>
                        <div class="plan-section ai-explanation">
                            <h4>ðŸ¤– AI Notes</h4>
                            <p>${plan.explanation}</p>
                        </div>
                    </div>
                `;
            }
            
            const sizeLabel = plan.position_size_pct >= 1 ? 'FULL SIZE' : plan.position_size_pct >= 0.5 ? 'HALF SIZE' : 'REDUCED';
            const sizeColor = plan.position_size_pct >= 1 ? 'var(--green)' : 'var(--yellow)';
            
            return `
                <div class="rule-plan-container">
                    <div class="plan-header">
                        <span class="direction-badge" style="background: ${dirColor}">${dirEmoji} ${plan.direction}</span>
                        <span class="plan-symbol">${plan.symbol}</span>
                        <span class="plan-confidence">${plan.confidence.toFixed(0)}% Score</span>
                        <span class="plan-size" style="color: ${sizeColor}">${sizeLabel}</span>
                    </div>
                    
                    <div class="plan-levels-grid">
                        <div class="level-card entry">
                            <div class="level-label">Entry Zone</div>
                            <div class="level-value">$${plan.entry_zone_low.toFixed(2)} - $${plan.entry_zone_high.toFixed(2)}</div>
                        </div>
                        <div class="level-card stop">
                            <div class="level-label">ðŸ›‘ Stop Loss</div>
                            <div class="level-value">$${plan.stop_loss.toFixed(2)}</div>
                            <div class="level-subtext">Risk: $${plan.risk_per_share.toFixed(2)}/share</div>
                        </div>
                        <div class="level-card target">
                            <div class="level-label">ðŸŽ¯ Target 1</div>
                            <div class="level-value">$${plan.target_1.toFixed(2)}</div>
                            <div class="level-subtext">${plan.risk_reward_t1.toFixed(1)}R</div>
                        </div>
                        <div class="level-card target">
                            <div class="level-label">ðŸŽ¯ Target 2</div>
                            <div class="level-value">$${plan.target_2.toFixed(2)}</div>
                            <div class="level-subtext">${plan.risk_reward_t2.toFixed(1)}R</div>
                        </div>
                    </div>
                    
                    <div class="plan-sections">
                        <div class="plan-section reasons-section">
                            <h4>âœ… Entry Reasons</h4>
                            <ul>${plan.entry_reasons.map(r => `<li>${r}</li>`).join('')}</ul>
                        </div>
                        
                        ${plan.caution_flags.length > 0 ? `
                        <div class="plan-section caution-section">
                            <h4>âš ï¸ Watch For</h4>
                            <ul>${plan.caution_flags.map(f => `<li>${f}</li>`).join('')}</ul>
                        </div>
                        ` : ''}
                        
                        <div class="plan-section invalidation-section">
                            <h4>ðŸš« Invalidation</h4>
                            <p>${plan.invalidation}</p>
                        </div>
                        
                        <div class="plan-section ai-explanation">
                            <h4>ðŸ¤– AI Context</h4>
                            <p>${plan.explanation}</p>
                        </div>
                    </div>
                    
                    <div class="plan-actions">
                        <div class="outcome-tracker" data-plan-id="${plan.plan_id}">
                            <span class="outcome-label">ðŸ“Š Record Outcome:</span>
                            <button class="outcome-btn win" onclick="recordOutcome(${plan.plan_id}, 'WIN_T1', this)">âœ… T1 Hit</button>
                            <button class="outcome-btn win" onclick="recordOutcome(${plan.plan_id}, 'WIN_T2', this)">ðŸŽ¯ T2 Hit</button>
                            <button class="outcome-btn loss" onclick="recordOutcome(${plan.plan_id}, 'LOSS', this)">âŒ Stopped</button>
                            <button class="outcome-btn skip" onclick="recordOutcome(${plan.plan_id}, 'SKIPPED', this)">â­ï¸ Skipped</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function recordOutcome(planId, outcome, btn) {
            try {
                btn.disabled = true;
                btn.textContent = '...';
                
                const response = await fetch(`${API_BASE}/api/rules/outcome`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_id: planId,
                        outcome: outcome
                    })
                });
                
                if (response.ok) {
                    // Update all buttons in this tracker
                    const tracker = btn.closest('.outcome-tracker');
                    tracker.innerHTML = `<span class="outcome-recorded">âœ… Outcome recorded: ${outcome}</span>`;
                } else {
                    throw new Error('Failed to record');
                }
            } catch (e) {
                btn.disabled = false;
                btn.textContent = 'Error';
                console.error('Failed to record outcome:', e);
            }
        }
        
        // Parse AI response into structured data
        function parseAIResponse(text, data) {
            const parsed = {
                bias: { direction: 'WAIT', probability: '50%', bullScore: data.bull_score || 0, bearScore: data.bear_score || 0 },
                levels: { entry: '-', stop: '-', risk: '-' },
                targets: { t1: '-', t2: '-' },
                rr: { t1rr: '-', t2rr: '-' },
                ev: { value: '-', breakeven: '-', verdict: 'NEUTRAL' },
                size: '-',
                invalid: '-',
                reasoning: '',
                alerts: []
            };
            
            // Parse TRADE BIAS
            const biasMatch = text.match(/TRADE BIAS:\s*(LONG|SHORT|WAIT)[^\d]*(\d+%)?/i);
            if (biasMatch) {
                parsed.bias.direction = biasMatch[1].toUpperCase();
                parsed.bias.probability = biasMatch[2] || '50%';
            }
            
            // Parse ENTRY
            const entryMatch = text.match(/ENTRY:\s*\$?([\d,.]+)/i);
            if (entryMatch) parsed.levels.entry = '$' + entryMatch[1];
            
            // Parse STOP
            const stopMatch = text.match(/STOP:\s*\$?([\d,.]+)/i);
            if (stopMatch) parsed.levels.stop = '$' + stopMatch[1];
            
            // Parse RISK
            const riskMatch = text.match(/RISK:\s*\$?([\d,.]+)/i);
            if (riskMatch) parsed.levels.risk = '$' + riskMatch[1];
            
            // Parse T1
            const t1Match = text.match(/T1:\s*\$?([\d,.]+)/i);
            if (t1Match) parsed.targets.t1 = '$' + t1Match[1];
            
            // Parse T2
            const t2Match = text.match(/T2:\s*\$?([\d,.]+)/i);
            if (t2Match) parsed.targets.t2 = '$' + t2Match[1];
            
            // Parse R:R
            const t1rrMatch = text.match(/T1[=\s]*([\d.]+):1/i);
            if (t1rrMatch) parsed.rr.t1rr = t1rrMatch[1] + ':1';
            
            const t2rrMatch = text.match(/T2[=\s]*([\d.]+):1/i);
            if (t2rrMatch) parsed.rr.t2rr = t2rrMatch[1] + ':1';
            
            // Parse EV
            const evMatch = text.match(/EV[:\s=]+([+-]?\$?[\d,.]+)/i);
            if (evMatch) {
                parsed.ev.value = evMatch[1];
                parsed.ev.verdict = evMatch[1].includes('-') ? 'NEGATIVE' : 'POSITIVE';
            }
            
            const breakevenMatch = text.match(/breakeven[:\s]*([\d.]+%?)/i);
            if (breakevenMatch) parsed.ev.breakeven = breakevenMatch[1];
            
            // Parse SIZE
            const sizeMatch = text.match(/SIZE:\s*([\d.]+\s*R)/i);
            if (sizeMatch) parsed.size = sizeMatch[1];
            
            // Parse INVALID IF
            const invalidMatch = text.match(/INVALID IF:\s*([^\n]+)/i);
            if (invalidMatch) parsed.invalid = invalidMatch[1].trim();
            
            // Parse REASONING
            const reasonMatch = text.match(/REASONING:\s*([^\n]+(?:\n(?![ðŸŽ¯ðŸ“ðŸŽªðŸ’¹ðŸ“ŠâŒâ°])[^\n]+)*)/i);
            if (reasonMatch) parsed.reasoning = reasonMatch[1].trim();
            
            // Parse ALERTS
            const alertMatches = text.matchAll(/ðŸ””\s*\$?([\d,.]+)\s*\(([^)]+)\)/g);
            for (const m of alertMatches) {
                parsed.alerts.push({ price: '$' + m[1], label: m[2] });
            }
            
            return parsed;
        }
        
        // Build the card HTML
        // Store AI parsed data for trade logging
        const aiParsedData = {};
        
        function buildAICardsHTML(parsed, symbol) {
            // Store for later use by log button
            aiParsedData[symbol] = parsed;
            
            const biasClass = parsed.bias.direction.toLowerCase();
            
            return `
                <div class="ai-card-container">
                    <!-- Cards Grid -->
                    <div class="ai-cards-grid">
                        <!-- BIAS Card -->
                        <div class="ai-card bias visible" data-card="bias">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">ðŸŽ¯</span>
                                <span class="ai-card-title">Trade Bias</span>
                            </div>
                            <div class="ai-card-body">
                                <div class="bias-direction ${biasClass}">${parsed.bias.direction}</div>
                                <div class="bias-prob">${parsed.bias.probability} confidence</div>
                                <div class="bias-scores">
                                    <div class="mini-score bull">
                                        <div class="mini-score-num" style="color: var(--green);">${parsed.bias.bullScore}</div>
                                        <div class="mini-score-label">Bull</div>
                                    </div>
                                    <div class="mini-score bear">
                                        <div class="mini-score-num" style="color: var(--red);">${parsed.bias.bearScore}</div>
                                        <div class="mini-score-label">Bear</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- LEVELS Card -->
                        <div class="ai-card levels visible" data-card="levels">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">ðŸ“</span>
                                <span class="ai-card-title">Entry & Stop</span>
                            </div>
                            <div class="ai-card-body">
                                <div class="level-row-card">
                                    <span class="level-name">Entry</span>
                                    <span class="level-price green">${parsed.levels.entry}</span>
                                </div>
                                <div class="level-row-card">
                                    <span class="level-name">Stop</span>
                                    <span class="level-price red">${parsed.levels.stop}</span>
                                </div>
                                <div class="level-row-card">
                                    <span class="level-name">Risk</span>
                                    <span class="level-price cyan">${parsed.levels.risk}</span>
                                </div>
                                <button class="log-trade-btn" onclick="logTradeFromAI('${symbol}')" id="log-btn-${symbol}">
                                    ðŸ“’ Log This Trade
                                </button>
                            </div>
                        </div>
                        
                        <!-- TARGETS Card -->
                        <div class="ai-card targets visible" data-card="targets">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">ðŸŽª</span>
                                <span class="ai-card-title">Targets</span>
                            </div>
                            <div class="ai-card-body">
                                <div class="level-row-card">
                                    <span class="level-name">T1 (Scale)</span>
                                    <span class="level-price green">${parsed.targets.t1}</span>
                                </div>
                                <div class="level-row-card">
                                    <span class="level-name">T2 (Full)</span>
                                    <span class="level-price green">${parsed.targets.t2}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SIZE Card -->
                        <div class="ai-card size visible" data-card="size">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">ðŸ“Š</span>
                                <span class="ai-card-title">Position Size</span>
                            </div>
                            <div class="ai-card-body">
                                ${(() => {
                                    const rMatch = parsed.size.match(/([\d.]+)/);
                                    const rMultiple = rMatch ? parseFloat(rMatch[1]) : 1;
                                    const entryNum = parseFloat(parsed.levels.entry.replace(/[$,]/g, '')) || 0;
                                    const stopNum = parseFloat(parsed.levels.stop.replace(/[$,]/g, '')) || 0;
                                    const pos = calculatePositionSize(rMultiple, entryNum, stopNum);
                                    const riskLabel = rMultiple < 1 ? 'Reduced' : rMultiple > 1 ? 'Aggressive' : 'Normal';
                                    
                                    return `
                                        <div class="size-card-body">
                                            <div class="size-row">
                                                <span class="size-label">AI Says</span>
                                                <span class="size-value">${parsed.size} (${riskLabel})</span>
                                            </div>
                                            <div class="size-row">
                                                <span class="size-label">Your Risk</span>
                                                <span class="size-value highlight">$${pos.riskDollars.toFixed(0)}</span>
                                            </div>
                                            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 0.5rem;">
                                                <div class="size-row">
                                                    <span class="size-label">ðŸ“ˆ Stocks</span>
                                                    <span class="size-value">${pos.shares > 0 ? pos.shares + ' shares' : '-'}</span>
                                                </div>
                                                <div class="size-row">
                                                    <span class="size-label">ðŸŽ° Options</span>
                                                    <span class="size-value">$${pos.riskDollars.toFixed(0)} max</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                })()}
                            </div>
                        </div>
                        
                        <!-- Show All Button -->
                        <div class="ai-card visible" data-card="toggle" style="display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,245,212,0.1); border-color: var(--cyan);" onclick="toggleAllCards(this)">
                            <div style="text-align: center; padding: 1rem;">
                                <div style="font-size: 1.5rem;">ðŸ“Š</div>
                                <div style="font-family: 'Orbitron', sans-serif; font-size: 0.75rem; color: var(--cyan); margin-top: 0.25rem;">SHOW ALL</div>
                            </div>
                        </div>
                        
                        <!-- R:R Card -->
                        <div class="ai-card rr" data-card="rr">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">ðŸ’¹</span>
                                <span class="ai-card-title">Risk / Reward</span>
                            </div>
                            <div class="ai-card-body">
                                <div class="rr-row">
                                    <span class="rr-label">T1 R:R</span>
                                    <span class="rr-value">${parsed.rr.t1rr}</span>
                                </div>
                                <div class="rr-row">
                                    <span class="rr-label">T2 R:R</span>
                                    <span class="rr-value">${parsed.rr.t2rr}</span>
                                </div>
                                <div class="rr-row" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.5rem; padding-top: 0.5rem;">
                                    <span class="rr-label">EV</span>
                                    <span class="rr-value ${parsed.ev.verdict === 'POSITIVE' ? 'ev-positive' : 'ev-negative'}">${parsed.ev.value}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- INVALID Card -->
                        <div class="ai-card invalid" data-card="invalid">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">âŒ</span>
                                <span class="ai-card-title">Invalid If</span>
                            </div>
                            <div class="ai-card-body">
                                <div class="invalid-text">${parsed.invalid}</div>
                            </div>
                        </div>
                        
                        <!-- REASONING Card -->
                        <div class="ai-card reasoning full-width" data-card="reasoning">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">ðŸ’¡</span>
                                <span class="ai-card-title">Reasoning</span>
                            </div>
                            <div class="ai-card-body">
                                <div class="reasoning-text">${parsed.reasoning || 'No reasoning provided.'}</div>
                            </div>
                        </div>
                        
                        <!-- ALERTS Card (only if WAIT or has alerts) -->
                        ${parsed.alerts.length > 0 || parsed.bias.direction === 'WAIT' ? `
                        <div class="ai-card alerts full-width" data-card="alerts">
                            <div class="ai-card-header">
                                <span class="ai-card-icon">â°</span>
                                <span class="ai-card-title">Set Alerts</span>
                            </div>
                            <div class="ai-card-body">
                                ${parsed.alerts.length > 0 ? parsed.alerts.map(a => `
                                    <div class="alert-item">
                                        <span>ðŸ””</span>
                                        <span class="level-price cyan">${a.price}</span>
                                        <span class="level-name">(${a.label})</span>
                                    </div>
                                `).join('') : '<div class="alert-item">No specific alerts suggested.</div>'}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Default visible cards
        const DEFAULT_CARDS = ['bias', 'levels', 'targets', 'size', 'toggle'];
        const ALL_CARDS = ['bias', 'levels', 'targets', 'size', 'rr', 'invalid', 'reasoning', 'alerts'];
        
        function setAIPreset(preset) {
            // Show default 4 cards on load
            document.querySelectorAll('.ai-card').forEach(card => {
                const cardType = card.dataset.card;
                card.classList.toggle('visible', DEFAULT_CARDS.includes(cardType));
            });
        }
        
        function toggleAllCards(btn) {
            const isExpanded = btn.dataset.expanded === 'true';
            
            if (isExpanded) {
                // Collapse - show only default 4
                document.querySelectorAll('.ai-card').forEach(card => {
                    const cardType = card.dataset.card;
                    card.classList.toggle('visible', DEFAULT_CARDS.includes(cardType));
                });
                btn.innerHTML = `<div style="text-align: center; padding: 1rem;"><div style="font-size: 1.5rem;">ðŸ“Š</div><div style="font-family: 'Orbitron', sans-serif; font-size: 0.75rem; color: var(--cyan); margin-top: 0.25rem;">SHOW ALL</div></div>`;
                btn.dataset.expanded = 'false';
            } else {
                // Expand - show all cards
                document.querySelectorAll('.ai-card').forEach(card => {
                    const cardType = card.dataset.card;
                    if (cardType !== 'toggle') {
                        card.classList.add('visible');
                    }
                });
                btn.innerHTML = `<div style="text-align: center; padding: 1rem;"><div style="font-size: 1.5rem;">ðŸ“‰</div><div style="font-family: 'Orbitron', sans-serif; font-size: 0.75rem; color: var(--yellow); margin-top: 0.25rem;">SHOW LESS</div></div>`;
                btn.style.borderColor = 'var(--yellow)';
                btn.style.background = 'rgba(255,200,0,0.1)';
                btn.dataset.expanded = 'true';
            }
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ==================== TRADE TRACKER ====================
        
        function getUserId() {
            return localStorage.getItem('userUid') || 'anonymous';
        }
        
        async function logTradeFromAI(symbol) {
            const parsed = aiParsedData[symbol];
            if (!parsed) {
                showToast('No AI data found for ' + symbol, 'error');
                return;
            }
            
            const direction = parsed.bias.direction;
            const btn = document.getElementById(`log-btn-${symbol}`);
            if (btn) {
                btn.innerHTML = 'â³ Logging...';
                btn.disabled = true;
            }
            
            try {
                // Parse numeric values from parsed data
                const entryNum = parseFloat(parsed.levels?.entry?.replace(/[$,]/g, '')) || 0;
                const stopNum = parseFloat(parsed.levels?.stop?.replace(/[$,]/g, '')) || 0;
                const t1Num = parseFloat(parsed.targets?.t1?.replace(/[$,]/g, '')) || 0;
                const t2Num = parseFloat(parsed.targets?.t2?.replace(/[$,]/g, '')) || 0;
                const confNum = parseFloat(parsed.bias?.probability?.replace('%', '')) || 50;
                
                // Get position size info
                const rMatch = parsed.size?.match(/([\d.]+)/);
                const rMultiple = rMatch ? parseFloat(rMatch[1]) : 1;
                const oneR = calculateOneR();
                const riskAmount = oneR * rMultiple;
                
                const tradeData = {
                    user_id: getUserId(),
                    symbol: symbol.toUpperCase(),
                    direction: direction === 'WAIT' ? 'LONG' : direction.toUpperCase(),
                    timeframe: selectedTimeframe,
                    entry_price: entryNum,
                    stop_loss: stopNum,
                    target1: t1Num,
                    target2: t2Num,
                    confidence: confNum,
                    bull_score: parsed.bias?.bullScore || 0,
                    bear_score: parsed.bias?.bearScore || 0,
                    setup_grade: parsed.bias?.direction === 'WAIT' ? 'B' : 'A',
                    risk_amount: riskAmount,
                    notes: `Logged from Simple Scanner - ${selectedTimeframe}`
                };
                
                const res = await fetch(`${API_BASE}/api/journal/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tradeData)
                });
                
                if (!res.ok) throw new Error('Failed to log trade');
                
                const result = await res.json();
                
                if (btn) {
                    btn.innerHTML = 'âœ… Logged!';
                    btn.classList.add('logged');
                }
                
                showToast(`Trade logged: ${symbol} ${direction}`, 'success');
                
            } catch (e) {
                console.error('Failed to log trade:', e);
                if (btn) {
                    btn.innerHTML = 'âŒ Error';
                    btn.disabled = false;
                }
                showToast('Failed to log trade', 'error');
            }
        }
        
        async function openTradeTracker() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal wide">
                    <div class="modal-header">
                        <div class="modal-title">ðŸ“’ My Trades</div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="loading"><div class="spinner"></div>Loading trades...</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            try {
                const userId = getUserId();
                
                // Fetch stats and trades in parallel
                const [statsRes, tradesRes] = await Promise.all([
                    fetch(`${API_BASE}/api/journal/stats?user_id=${userId}`),
                    fetch(`${API_BASE}/api/journal/?user_id=${userId}&days=90`)
                ]);
                
                const stats = await statsRes.json();
                const tradesData = await tradesRes.json();
                const trades = tradesData.trades || [];
                
                // Separate trades by status
                const openTrades = trades.filter(t => t.status === 'OPEN');
                const plannedTrades = trades.filter(t => t.status === 'PLANNED');
                const closedTrades = trades.filter(t => ['WIN', 'LOSS', 'BREAKEVEN'].includes(t.status));
                
                modal.querySelector('.modal-body').innerHTML = `
                    <!-- Stats Bar -->
                    <div class="stats-bar">
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--cyan);">${stats.total_trades || 0}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--green);">${stats.wins || 0}</div>
                            <div class="stat-label">Wins</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--red);">${stats.losses || 0}</div>
                            <div class="stat-label">Losses</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--yellow);">${stats.open_trades || 0}</div>
                            <div class="stat-label">Open</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: ${stats.win_rate >= 50 ? 'var(--green)' : 'var(--red)'};">${stats.win_rate || 0}%</div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: ${stats.avg_r >= 0 ? 'var(--green)' : 'var(--red)'};">${stats.avg_r || 0}R</div>
                            <div class="stat-label">Avg R</div>
                        </div>
                    </div>
                    
                    <!-- Planned Trades -->
                    ${plannedTrades.length > 0 ? `
                        <div class="section-title">ðŸ“‹ Planned (${plannedTrades.length})</div>
                        ${plannedTrades.map(t => renderTradeCard(t)).join('')}
                    ` : ''}
                    
                    <!-- Open Trades -->
                    ${openTrades.length > 0 ? `
                        <div class="section-title">â³ Open (${openTrades.length})</div>
                        ${openTrades.map(t => renderTradeCard(t)).join('')}
                    ` : ''}
                    
                    <!-- Closed Trades -->
                    ${closedTrades.length > 0 ? `
                        <div class="section-title">âœ… Closed (${closedTrades.length})</div>
                        ${closedTrades.slice(0, 10).map(t => renderTradeCard(t)).join('')}
                        ${closedTrades.length > 10 ? `<div style="text-align: center; color: var(--text-gray); padding: 0.5rem;">+ ${closedTrades.length - 10} more...</div>` : ''}
                    ` : ''}
                    
                    ${trades.length === 0 ? `
                        <div class="empty-trades">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“’</div>
                            <p>No trades logged yet.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Analyze a symbol and click "Log This Trade" to start tracking!</p>
                        </div>
                    ` : ''}
                `;
                
                // Add footer
                modal.querySelector('.modal').innerHTML += `
                    <div class="modal-footer">
                        <button class="action-btn secondary" onclick="exportTrades()" style="flex: 1;">ðŸ“¤ Export CSV</button>
                        <button class="action-btn secondary" onclick="this.closest('.modal-overlay').remove()" style="flex: 1;">Close</button>
                    </div>
                `;
                
            } catch (e) {
                console.error('Failed to load trades:', e);
                modal.querySelector('.modal-body').innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">âŒ</div>
                        <p>Failed to load trades: ${e.message}</p>
                    </div>
                `;
            }
        }
        
        function renderTradeCard(trade) {
            const dirClass = trade.direction === 'LONG' ? 'long' : 'short';
            const dirEmoji = trade.direction === 'LONG' ? 'ðŸŸ¢' : 'ðŸ”´';
            const date = new Date(trade.logged_at).toLocaleDateString();
            
            let pnlHtml = '';
            if (trade.pnl_r !== null && trade.pnl_r !== undefined) {
                const pnlClass = trade.pnl_r >= 0 ? 'positive' : 'negative';
                const pnlSign = trade.pnl_r >= 0 ? '+' : '';
                pnlHtml = `<span class="trade-pnl ${pnlClass}">${pnlSign}${trade.pnl_r}R</span>`;
            }
            
            let actionsHtml = '';
            if (trade.status === 'PLANNED') {
                actionsHtml = `
                    <button class="trade-action-btn" onclick="openTrade(${trade.id})">â–¶ï¸ Open</button>
                    <button class="trade-action-btn" onclick="cancelTrade(${trade.id})">ðŸ—‘ï¸ Cancel</button>
                `;
            } else if (trade.status === 'OPEN') {
                actionsHtml = `
                    <button class="trade-action-btn win" onclick="closeTrade(${trade.id}, 'hit_target1')">âœ… T1 Hit</button>
                    <button class="trade-action-btn win" onclick="closeTrade(${trade.id}, 'hit_target2')">âœ… T2 Hit</button>
                    <button class="trade-action-btn loss" onclick="closeTrade(${trade.id}, 'hit_stop')">âŒ Stopped</button>
                `;
            } else {
                // Closed trade - show status
                const statusEmoji = trade.status === 'WIN' ? 'âœ…' : trade.status === 'LOSS' ? 'âŒ' : 'âž–';
                actionsHtml = `<span style="color: var(--text-gray);">${statusEmoji} ${trade.exit_reason || trade.status}</span>`;
            }
            
            return `
                <div class="trade-card">
                    <div class="trade-card-header">
                        <div>
                            <span class="trade-symbol">${trade.symbol}</span>
                            <span class="trade-direction ${dirClass}">${dirEmoji} ${trade.direction}</span>
                        </div>
                        <div style="text-align: right;">
                            ${pnlHtml}
                            <div style="font-size: 0.75rem; color: var(--text-gray);">${date}</div>
                        </div>
                    </div>
                    <div class="trade-levels">
                        <span>Entry: $${trade.entry_price?.toFixed(2)}</span>
                        <span>Stop: $${trade.stop_loss?.toFixed(2)}</span>
                        <span>T1: $${trade.target1?.toFixed(2)}</span>
                    </div>
                    <div class="trade-actions">
                        ${actionsHtml}
                    </div>
                </div>
            `;
        }
        
        async function openTrade(tradeId) {
            const price = prompt('Enter actual entry price:');
            if (!price) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/journal/${tradeId}/open?actual_entry=${price}`, { method: 'POST' });
                if (res.ok) {
                    showToast('Trade opened!', 'success');
                    openTradeTracker(); // Refresh
                }
            } catch (e) {
                showToast('Failed to open trade', 'error');
            }
        }
        
        async function closeTrade(tradeId, reason) {
            const price = prompt('Enter exit price:');
            if (!price) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/journal/${tradeId}/close?actual_exit=${price}&exit_reason=${reason}`, { method: 'POST' });
                if (res.ok) {
                    showToast('Trade closed!', 'success');
                    openTradeTracker(); // Refresh
                }
            } catch (e) {
                showToast('Failed to close trade', 'error');
            }
        }
        
        async function cancelTrade(tradeId) {
            if (!confirm('Cancel this trade?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/journal/${tradeId}/cancel`, { method: 'POST' });
                if (res.ok) {
                    showToast('Trade cancelled', 'success');
                    openTradeTracker(); // Refresh
                }
            } catch (e) {
                showToast('Failed to cancel trade', 'error');
            }
        }
        
        async function exportTrades() {
            const userId = getUserId();
            try {
                const res = await fetch(`${API_BASE}/api/journal/export?user_id=${userId}&format=csv`);
                const data = await res.json();
                
                if (data.csv) {
                    const blob = new Blob([data.csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    showToast('Exported!', 'success');
                }
            } catch (e) {
                showToast('Export failed', 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userUid');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
