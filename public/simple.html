<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.E.F. Simple Scanner | Find Trades Fast</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs for Authentication and Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- TradingView Widget Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <style>
        :root {
            /* Light Theme */
            --bg-dark: #f5f7fa;
            --bg-card: #ffffff;
            --bg-hover: #f9fafb;
            --text-white: #222222;
            --text-gray: #6b7280;
            --text-muted: #9ca3af;
            --green: #16a34a;
            --red: #dc2626;
            --yellow: #d97706;
            --cyan: #0891b2;
            --purple: #7c3aed;
            --border-light: #e5e5e5;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: 
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1400' height='800' viewBox='0 0 1400 800'%3E%3Cdefs%3E%3ClinearGradient id='fadeOut' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='white' stop-opacity='0'/%3E%3Cstop offset='30%25' stop-color='white' stop-opacity='1'/%3E%3Cstop offset='70%25' stop-color='white' stop-opacity='1'/%3E%3Cstop offset='100%25' stop-color='white' stop-opacity='0'/%3E%3C/linearGradient%3E%3Cmask id='fadeMask'%3E%3Crect width='1400' height='800' fill='url(%23fadeOut)'/%3E%3C/mask%3E%3C/defs%3E%3Cg opacity='0.12' mask='url(%23fadeMask)'%3E%3C!-- Grid lines --%3E%3Cg stroke='%231e293b' stroke-width='0.5' opacity='0.5'%3E%3Cline x1='0' y1='200' x2='1400' y2='200'/%3E%3Cline x1='0' y1='350' x2='1400' y2='350'/%3E%3Cline x1='0' y1='500' x2='1400' y2='500'/%3E%3Cline x1='0' y1='650' x2='1400' y2='650'/%3E%3C/g%3E%3C!-- Uptrend with dips - 25 candles --%3E%3Cg stroke='%231e293b' stroke-width='1.5'%3E%3C!-- Candle 1 - start low --%3E%3Cline x1='60' y1='680' x2='60' y2='720'/%3E%3Crect x='50' y='690' width='20' height='25' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 2 --%3E%3Cline x1='115' y1='660' x2='115' y2='700'/%3E%3Crect x='105' y='670' width='20' height='22' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 3 --%3E%3Cline x1='170' y1='630' x2='170' y2='680'/%3E%3Crect x='160' y='640' width='20' height='28' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 4 - small dip --%3E%3Cline x1='225' y1='620' x2='225' y2='670'/%3E%3Crect x='215' y='635' width='20' height='25' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 5 --%3E%3Cline x1='280' y1='600' x2='280' y2='650'/%3E%3Crect x='270' y='610' width='20' height='30' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 6 --%3E%3Cline x1='335' y1='570' x2='335' y2='620'/%3E%3Crect x='325' y='580' width='20' height='28' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 7 --%3E%3Cline x1='390' y1='540' x2='390' y2='595'/%3E%3Crect x='380' y='550' width='20' height='32' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 8 - dip 1 start --%3E%3Cline x1='445' y1='530' x2='445' y2='590'/%3E%3Crect x='435' y='545' width='20' height='35' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 9 - dip continues --%3E%3Cline x1='500' y1='550' x2='500' y2='610'/%3E%3Crect x='490' y='560' width='20' height='38' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 10 - dip bottom --%3E%3Cline x1='555' y1='570' x2='555' y2='620'/%3E%3Crect x='545' y='580' width='20' height='30' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 11 - recovery --%3E%3Cline x1='610' y1='540' x2='610' y2='600'/%3E%3Crect x='600' y='550' width='20' height='35' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 12 --%3E%3Cline x1='665' y1='500' x2='665' y2='560'/%3E%3Crect x='655' y='510' width='20' height='38' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 13 --%3E%3Cline x1='720' y1='460' x2='720' y2='520'/%3E%3Crect x='710' y='470' width='20' height='36' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 14 --%3E%3Cline x1='775' y1='420' x2='775' y2='480'/%3E%3Crect x='765' y='430' width='20' height='35' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 15 - small pullback --%3E%3Cline x1='830' y1='410' x2='830' y2='465'/%3E%3Crect x='820' y='425' width='20' height='30' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 16 --%3E%3Cline x1='885' y1='380' x2='885' y2='440'/%3E%3Crect x='875' y='390' width='20' height='38' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 17 --%3E%3Cline x1='940' y1='340' x2='940' y2='400'/%3E%3Crect x='930' y='350' width='20' height='36' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 18 - dip 2 --%3E%3Cline x1='995' y1='330' x2='995' y2='390'/%3E%3Crect x='985' y='345' width='20' height='35' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 19 - dip 2 continues --%3E%3Cline x1='1050' y1='350' x2='1050' y2='405'/%3E%3Crect x='1040' y='360' width='20' height='32' fill='%23e63946' stroke='%23e63946'/%3E%3C!-- Candle 20 - recovery --%3E%3Cline x1='1105' y1='310' x2='1105' y2='375'/%3E%3Crect x='1095' y='320' width='20' height='40' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 21 --%3E%3Cline x1='1160' y1='270' x2='1160' y2='335'/%3E%3Crect x='1150' y='280' width='20' height='40' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 22 --%3E%3Cline x1='1215' y1='230' x2='1215' y2='295'/%3E%3Crect x='1205' y='240' width='20' height='40' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 23 --%3E%3Cline x1='1270' y1='190' x2='1270' y2='260'/%3E%3Crect x='1260' y='200' width='20' height='42' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C!-- Candle 24 --%3E%3Cline x1='1325' y1='150' x2='1325' y2='220'/%3E%3Crect x='1315' y='160' width='20' height='45' fill='%2300cc6a' stroke='%2300cc6a'/%3E%3C/g%3E%3C!-- Moving average --%3E%3Cpath d='M 60 700 Q 200 650, 350 580 T 550 590 T 750 450 T 950 370 T 1100 340 T 1325 180' fill='none' stroke='%2300d4ff' stroke-width='3' opacity='0.6'/%3E%3C/g%3E%3C/svg%3E"),
                linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            background-size: 100% auto, 100% 100%;
            background-position: center center, center center;
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed, fixed;
            color: var(--text-white);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 1rem;
            background: #fff;
            border: 1px solid var(--border-light);
            border-top: 4px solid #1e293b;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin: -1rem -1rem 0 -1rem;
            margin-bottom: 2in;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--green), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-gray);
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .full-suite-link {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            color: #374151;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: #fff;
            transition: all 0.2s;
        }

        .full-suite-link:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .full-suite-link.primary {
            background: linear-gradient(135deg, var(--green), #22c55e);
            color: #fff;
            border: none;
        }

        .header-links {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .logout-link {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #374151;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-link:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        /* Scanner Card */
        .scanner-card {
            background: #fff;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
            border-top: 4px solid #1e293b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        /* Two-Path Layout */
        .path-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5in;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .path-container {
                grid-template-columns: 1fr;
            }
        }

        .path-box {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-light);
            border-top: 4px solid #1e293b;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .path-box:hover {
            border-color: #d1d5db;
            border-top-color: #334155;
        }

        .path-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #dc2626;
        }

        .path-title.green {
            color: var(--green);
        }

        .path-box .symbol-search {
            margin-bottom: 1rem;
        }

        .path-box .universe-grid {
            margin-bottom: 1rem;
        }

        .path-box .scan-types {
            margin-bottom: 1rem;
        }

        .path-action-btn {
            margin-top: auto;
            padding: 0.9rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .path-action-btn.analyze {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: #fff;
        }

        .path-action-btn.analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .path-action-btn.scan {
            background: linear-gradient(135deg, #22c55e, #4ade80);
            color: #fff;
        }

        .path-action-btn.scan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .path-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Toggle Switch for Rules vs GPT */
        .toggle-switch input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        .toggle-switch input:not(:checked) + .toggle-slider {
            background-color: #6c5ce7;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .scanner-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--cyan);
        }

        /* Quick Universe Buttons */
        .universe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .universe-btn {
            background: #f9fafb;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .universe-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .universe-btn.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        /* Scan Type Pills */
        .scan-types {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scan-pill {
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            border: 2px solid var(--border-light);
            background: #fff;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .scan-pill.long {
            border-color: var(--green);
            color: var(--green);
        }

        .scan-pill.long.active {
            background: var(--green);
            border-color: var(--green);
            color: #fff;
        }

        .scan-pill.short {
            border-color: var(--red);
            color: var(--red);
        }

        .scan-pill.short.active {
            background: var(--red);
            border-color: var(--red);
            color: #fff;
        }

        .scan-pill.entry {
            border-color: var(--green);
            color: var(--green);
        }

        .scan-pill.entry.active {
            background: linear-gradient(135deg, var(--green), #22c55e);
            border-color: transparent;
            color: #fff;
        }

        .scan-pill.volume {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .scan-pill.volume.active {
            background: linear-gradient(135deg, var(--yellow), #f59e0b);
            border-color: transparent;
            color: #fff;
        }

        .scan-pill.squeeze {
            border-color: var(--purple);
            color: var(--purple);
        }

        .scan-pill.squeeze.active {
            background: linear-gradient(135deg, var(--purple), #8b5cf6);
            border-color: transparent;
            color: #fff;
        }

        .scan-pill.extension {
            border-color: rgba(0,245,212,0.5);
        }

        .scan-pill.extension.active {
            background: rgba(0,245,212,0.3);
            border-color: var(--cyan);
        }

        .scan-pill.compression {
            border-color: rgba(186,85,211,0.5);
        }

        .scan-pill.compression.active {
            background: rgba(186,85,211,0.3);
            border-color: #ba55d3;
        }

        .scan-pill.levels {
            border-color: rgba(100,150,255,0.5);
        }

        .scan-pill.levels.active {
            background: rgba(100,150,255,0.3);
            border-color: #6496ff;
        }

        .scan-pill.aplus {
            border-color: rgba(255,215,0,0.5);
        }

        .scan-pill.aplus.active {
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,180,0,0.3));
            border-color: gold;
        }

        .scan-pill.capitulation {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        .scan-pill.capitulation.active {
            background: linear-gradient(135deg, var(--cyan), #06b6d4);
            border-color: transparent;
            color: #fff;
        }

        @keyframes pulse-cap {
            0%, 100% { box-shadow: 0 0 5px rgba(220,20,60,0.5); }
            50% { box-shadow: 0 0 15px rgba(220,20,60,0.8); }
        }

        .scan-pill.all {
            border-color: #374151;
            color: #374151;
        }

        .scan-pill.all.active {
            background: linear-gradient(135deg, #374151, #4b5563);
            border-color: transparent;
            color: #fff;
        }

        /* Level Toggle */
        .level-toggle {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .level-btn {
            flex: 1;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            background: #fff;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .level-btn .level-desc {
            display: block;
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-gray);
            margin-top: 0.25rem;
        }

        .level-btn:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .level-btn.active {
            border-color: var(--green);
            background: var(--green);
            color: #fff;
        }

        .level-btn.active .level-desc {
            color: rgba(255,255,255,0.9);
        }

        #pro-btn.active {
            border-color: var(--yellow);
            background: linear-gradient(135deg, #f59e0b, var(--yellow));
            color: #fff;
        }

        #pro-btn.active .level-desc {
            color: rgba(255,255,255,0.9);
        }

        /* Big Scan Button */
        .scan-btn {
            width: 100%;
            padding: 1rem 2rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #22c55e, #4ade80);
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .scan-btn:active {
            transform: translateY(0);
        }

        .scan-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin-top: 1rem;
        }

        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), #34d399);
            width: 0%;
            transition: width 0.3s;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            color: var(--green);
            font-weight: 600;
        }

        /* Results Section - Option 2 Style (Light Cards) */
        .results-card {
            background: #f8f8f8;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e5e5e5;
            display: none;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .results-count {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: #222;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #e5e5e5;
            color: #6b7280;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-tab:hover {
            background: #f3f4f6;
        }

        .filter-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .score-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .score-filter-group {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .score-filter-group label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }

        .score-select {
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #e5e5e5;
            color: #374151;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .score-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .sort-toggle {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #e5e5e5;
            color: #6b7280;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-toggle.active {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        /* Result Cards - Option 2 Grid Style */
        .result-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .result-item {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e5e5;
        }

        .result-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59,130,246,0.15);
            transform: translateY(-2px);
        }

        .result-item.long { border-top: 4px solid #16a34a; }
        .result-item.short { border-top: 4px solid #dc2626; }
        .result-item.neutral { border-top: 4px solid #d97706; }

        .result-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .result-symbol {
            font-family: 'Inter', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #111;
        }

        .result-score-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
        }
        .result-score-badge.high { background: #dcfce7; color: #16a34a; }
        .result-score-badge.med { background: #fef3c7; color: #d97706; }
        .result-score-badge.low { background: #f3f4f6; color: #6b7280; }

        .result-signal {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .result-signal.long { color: #16a34a; }
        .result-signal.short { color: #dc2626; }
        .result-signal.neutral { color: #d97706; }

        .result-metrics {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            padding-top: 0.5rem;
            border-top: 1px solid #f3f4f6;
        }

        .result-metric {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }

        .result-metric .label {
            font-size: 0.65rem;
            color: #9ca3af;
            text-transform: uppercase;
        }

        .result-metric .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
        }
        .result-metric .value.green { color: #16a34a; }
        .result-metric .value.red { color: #dc2626; }
        .result-metric .value.yellow { color: #d97706; }

        .result-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge.confidence {
            background: #ecfeff;
            color: #0891b2;
        }

        /* CONFLUENCE BADGES */
        .badge.confluence-multi {
            background: linear-gradient(135deg, #dc2626, #f97316);
            color: #fff;
            font-weight: 700;
            animation: pulse-badge 1.5s infinite;
        }

        .badge.confluence-double {
            background: #dcfce7;
            color: #16a34a;
            font-weight: 600;
        }

        .badge.scan-type {
            background: #f3f4f6;
            color: #6b7280;
            font-size: 0.65rem;
        }

        .scan-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        /* Multi-signal result highlighting */
        .result-item.multi-signal {
            border: 2px solid #f97316;
            background: linear-gradient(135deg, #fff7ed, #fff);
        }

        .result-item.double-confluence {
            border: 2px solid #16a34a;
            background: linear-gradient(135deg, #f0fdf4, #fff);
        }

        .badge.rvol-high {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge.rvol-good {
            background: #ecfeff;
            color: #0891b2;
        }

        .badge.rvol-low {
            background: #fef3c7;
            color: #d97706;
        }

        .badge.squeeze-score {
            background: #fef3c7;
            color: #92400e;
            font-weight: 600;
        }

        /* Result Action Button */
        .result-action-btn {
            width: 100%;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            background: #3b82f6;
            color: white;
        }

        .result-action-btn:hover {
            background: #2563eb;
        }

        /* Enhanced Squeeze Tiers */
        .badge.squeeze-forming {
            background: rgba(255,200,0,0.2);
            color: var(--yellow);
            font-weight: 500;
        }

        .badge.squeeze-active {
            background: rgba(255,165,0,0.3);
            color: #ffa500;
            font-weight: 600;
        }

        .badge.squeeze-extreme {
            background: rgba(255,69,0,0.4);
            color: #ff4500;
            font-weight: 700;
            animation: pulse-badge 1.5s infinite;
        }

        .badge.compression-score {
            background: rgba(186,85,211,0.3);
            color: #ba55d3;
            font-weight: 600;
        }

        .badge.capitulation-score {
            background: rgba(220,20,60,0.3);
            color: #dc143c;
            font-weight: 700;
        }

        .badge.capitulation-exhaustion {
            background: rgba(0,255,136,0.3);
            color: var(--green);
            font-weight: 700;
            animation: pulse-badge 1.5s infinite;
        }

        /* Fibonacci position badges */
        .badge.fib-golden {
            background: rgba(255,215,0,0.3);
            color: #ffd700;
            font-weight: 700;
        }

        .badge.fib-good {
            background: rgba(0,255,136,0.2);
            color: var(--green);
        }

        .badge.fib-warning {
            background: rgba(255,165,0,0.3);
            color: #ffa500;
        }

        .badge.fib-neutral {
            background: rgba(108,117,125,0.3);
            color: #adb5bd;
        }

        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .badge.score-high {
            background: rgba(0,255,136,0.3);
            color: var(--green);
            font-weight: 700;
        }

        .badge.score-med {
            background: rgba(0,245,212,0.2);
            color: var(--cyan);
            font-weight: 600;
        }

        .badge.score-low {
            background: rgba(139,149,165,0.2);
            color: var(--text-gray);
        }

        .result-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--green), #22c55e);
            color: #fff;
        }

        .action-btn.secondary {
            background: #fff;
            color: #374151;
            border: 1px solid var(--border-light);
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        /* AI Modal - Option 2 Light Theme */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal {
            background: #f8f8f8;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            margin: auto;
        }

        .modal.wide {
            max-width: 98vw;
            width: 980px;
            max-height: 95vh;
        }
        
        .modal.wide .modal-body {
            padding: 1.25rem 1.5rem;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
        }

        .modal-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #222;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 1rem 1.5rem;
        }

        .level-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .level-label {
            color: #6b7280;
        }

        .level-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
        }

        .level-value.green { color: #16a34a; }
        .level-value.red { color: #dc2626; }
        .level-value.cyan { color: #0891b2; }

        .score-display {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }

        .score-box {
            text-align: center;
            padding: 1rem 2rem;
            border-radius: 12px;
        }

        .score-box.bull {
            background: #dcfce7;
            border: 1px solid #16a34a;
        }

        .score-box.bear {
            background: #fee2e2;
            border: 1px solid #dc2626;
        }

        .score-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 800;
        }

        .score-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .ai-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e5e5;
        }

        .ai-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            border: 2px solid #7c3aed;
            border-radius: 12px;
            background: rgba(124,58,237,0.1);
            color: #7c3aed;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-btn:hover {
            background: rgba(124,58,237,0.2);
        }

        .ai-response {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #374151;
            border: 1px solid #e5e5e5;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e5e5;
            display: flex;
            gap: 0.5rem;
            background: #fff;
        }

        .modal-footer .action-btn {
            flex: 1;
        }

        /* Rule Plan Styles - Option 2 Light Theme */
        .rule-plan-container {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .plan-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: #fff;
            border-radius: 12px;
            flex-wrap: wrap;
            border: 1px solid #e5e5e5;
        }

        .plan-header.no-trade {
            background: #f9fafb;
            border: 1px solid #d1d5db;
        }

        .direction-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            color: #fff;
        }

        .plan-symbol {
            font-family: 'Inter', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: #111;
        }

        .plan-confidence {
            font-size: 1.1rem;
            color: #0891b2;
            font-weight: 600;
        }

        .plan-size {
            font-weight: 700;
            margin-left: auto;
            color: #374151;
        }

        .plan-levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .level-card {
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #e5e5e5;
        }

        .level-card.entry {
            border-left: 4px solid #0891b2;
        }

        .level-card.stop {
            border-left: 4px solid #dc2626;
        }

        .level-card.target {
            border-left: 4px solid #16a34a;
        }

        .level-card .level-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .level-card .level-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: #374151;
        }

        .level-card .level-subtext {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .plan-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .plan-section {
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e5e5;
        }

        .plan-section h4 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: #374151;
        }

        .plan-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plan-section li {
            padding: 0.4rem 0;
            font-size: 0.9rem;
            color: #6b7280;
            border-bottom: 1px solid #f3f4f6;
        }

        .plan-section li:last-child {
            border-bottom: none;
        }

        .reasons-section {
            border-left: 4px solid #16a34a;
        }

        .caution-section {
            border-left: 4px solid #d97706;
        }

        .invalidation-section {
            border-left: 4px solid #dc2626;
        }

        .ai-explanation {
            border-left: 4px solid #7c3aed;
            grid-column: 1 / -1;
            max-height: 300px;
            overflow-y: auto;
        }

        .ai-explanation p {
            color: #6b7280;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Price Ladder for NO_TRADE */
        .plan-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: #0891b2;
            margin-left: auto;
        }

        .price-ladder-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #e5e5e5;
        }

        .ladder-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .ladder-row {
            display: grid;
            grid-template-columns: 100px 1fr 150px;
            align-items: center;
            gap: 0.75rem;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
        }

        .ladder-price {
            font-weight: 600;
            text-align: right;
        }

        .ladder-bar {
            color: #d1d5db;
            opacity: 0.5;
            letter-spacing: -2px;
        }

        .ladder-label {
            font-size: 0.85rem;
        }

        .level-vah {
            color: #16a34a;
        }
        .level-vah .ladder-bar {
            color: #16a34a;
        }

        .level-vwap {
            color: #0891b2;
        }
        .level-vwap .ladder-bar {
            color: #0891b2;
        }

        .level-poc {
            color: #d97706;
        }
        .level-poc .ladder-bar {
            color: #d97706;
        }

        .level-price {
            background: #f3f4f6;
            color: #111;
            font-weight: 700;
        }
        .level-price .ladder-bar {
            color: #374151;
            opacity: 1;
        }

        .level-val {
            color: #dc2626;
        }
        .level-val .ladder-bar {
            color: #dc2626;
        }

        .watch-triggers {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e5e5;
        }

        .watch-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .long-watch {
            background: #dcfce7;
            border: 1px solid #86efac;
        }

        .short-watch {
            background: #fee2e2;
            border: 1px solid #fca5a5;
        }

        .watch-icon {
            font-size: 1.2rem;
        }

        .watch-text {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .watch-text strong {
            color: #374151;
        }

        /* TradingView Chart Section */
        .tradingview-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .tv-header h4 {
            margin: 0;
            color: #0891b2;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tv-link-btn {
            padding: 0.6rem 1.2rem;
            background: #ecfeff;
            border: 1px solid #0891b2;
            border-radius: 8px;
            color: #0891b2;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .tv-link-btn:hover {
            background: #cffafe;
            transform: translateY(-1px);
        }

        .tradingview-widget-container {
            border-radius: 8px;
            overflow: hidden;
            height: 600px;
            background: #131722;
            border: 1px solid #e5e5e5;
        }

        .tradingview-widget-container iframe {
            border-radius: 8px;
        }

        .plan-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e5e5;
        }

        .outcome-tracker {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .outcome-label {
            font-weight: 600;
            color: #6b7280;
        }

        .outcome-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .outcome-btn.win {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #16a34a;
        }

        .outcome-btn.win:hover {
            background: #bbf7d0;
        }

        .outcome-btn.loss {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .outcome-btn.loss:hover {
            background: #fecaca;
        }

        .outcome-btn.skip {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .outcome-recorded {
            color: #16a34a;
            font-weight: 600;
        }

        /* Position Calculator Styles */
        .position-calc-section {
            background: linear-gradient(135deg, #ecfeff, #faf5ff);
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .calc-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .calc-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .calc-input-group label {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .calc-input-group input,
        .calc-input-group select {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: #374151;
            font-family: 'JetBrains Mono', monospace;
            width: 100px;
        }

        .calc-result {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            text-align: center;
        }

        .calc-result label {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .calc-result span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: #0891b2;
            font-weight: 700;
        }

        .calc-output {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .calc-shares, .calc-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .shares-label, .options-label {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .shares-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #16a34a;
        }

        .options-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: #d97706;
        }

        .log-trade-btn {
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
            transition: transform 0.2s;
        }

        .log-trade-btn:hover {
            background: #2563eb;
            transform: scale(1.02);
        }

        .log-trade-btn:disabled {
            background: #93c5fd;
            cursor: not-allowed;
        }

        .full-report-btn {
            background: #7c3aed;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
        }

        .full-report-btn:hover {
            background: #6d28d9;
            transform: scale(1.02);
        }

        /* Report Toast Notification */
        .report-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #16a34a;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #16a34a;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .report-toast button {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.2rem;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Auto-report toggle */
        .auto-report-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .auto-report-toggle input {
            width: 16px;
            height: 16px;
            accent-color: #16a34a;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            background: #fff;
            border-radius: 12px;
            border: 1px dashed #e5e5e5;
        }

        .empty-state .emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: #9ca3af;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: #3b82f6;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e5e5;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== OPTION 2: CLEAN CARDS LIGHT THEME ========== */
        /* v2.0 - Force light theme with high specificity */
        
        /* Modal Header */
        .modal .modal-header-new,
        .modal-body .modal-header-new,
        .modal-header-new {
            background: #fff !important;
            padding: 1.25rem 1.5rem !important;
            border-bottom: 1px solid #eee !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        .modal-header-new .header-left,
        .header-left {
            display: flex;
            align-items: baseline;
            gap: 1rem;
            background: transparent !important;
        }
        .modal-header-new .symbol-display,
        .symbol-display {
            font-size: 1.2rem;
            font-weight: 700;
            color: #222 !important;
            letter-spacing: 0.3px;
            font-family: 'Inter', sans-serif;
            background: transparent !important;
        }
        .modal-header-new .price-main,
        .price-main {
            font-family: 'Inter', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: #111 !important;
            background: transparent !important;
        }
        .change-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
        }
        .change-badge.up { color: #16a34a !important; background: rgba(22,163,74,0.1) !important; }
        .change-badge.down { color: #dc2626 !important; background: rgba(220,38,38,0.1) !important; }
        .ohlc-bar {
            display: flex;
            gap: 1.25rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: #666 !important;
            background: transparent !important;
        }
        .ohlc-bar span { color: #444 !important; font-weight: 600; }
        .ohlc-bar .val {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 400;
            color: #666 !important;
        }
        
        .modal-body-new { 
            padding: 1.25rem 1.5rem !important; 
            background: #f8f8f8 !important;
        }
        
        /* Earnings Banner */
        .modal .earnings-banner,
        .earnings-banner {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #fffbeb !important;
            border: 1px solid #fde68a !important;
            border-left: 4px solid #f59e0b !important;
            border-radius: 8px;
            margin-bottom: 1.25rem;
            font-size: 0.85rem;
            color: #92400e !important;
        }
        .earnings-banner .icon { font-size: 1.1rem; }
        .earnings-banner .text { color: #92400e !important; font-weight: 600; }
        .earnings-banner .date { color: #b45309 !important; }
        .earnings-banner .note { color: #a3a3a3 !important; margin-left: auto; font-size: 0.75rem; }
        
        /* Order Flow Card */
        .modal .flow-card,
        .flow-card {
            background: #fff !important;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            border: 1px solid #e5e5e5 !important;
        }
        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .flow-title {
            font-weight: 600;
            font-size: 0.8rem;
            color: #3b82f6 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .flow-bias {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .flow-bias.neutral { background: #f3f4f6 !important; color: #6b7280 !important; }
        .flow-bias.bullish { background: #dcfce7 !important; color: #16a34a !important; }
        .flow-bias.bearish { background: #fee2e2 !important; color: #dc2626 !important; }
        .flow-metrics {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .flow-metric {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        .flow-metric .label {
            font-size: 0.7rem;
            color: #9ca3af !important;
            text-transform: uppercase;
        }
        .flow-metric .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .flow-metric .value.green { color: #16a34a !important; }
        .flow-metric .value.red { color: #dc2626 !important; }
        .flow-metric .value.yellow { color: #d97706 !important; }
        .flow-metric .value.default { color: #374151 !important; }
        
        /* Dual Setup Cards */
        .setups-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .modal .setup-card,
        .setup-card {
            background: #fff !important;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #e5e5e5 !important;
        }
        .setup-card.long { border-top: 4px solid #16a34a !important; }
        .setup-card.short { border-top: 4px solid #dc2626 !important; }
        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f3f4f6 !important;
            background: transparent !important;
        }
        .setup-title {
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent !important;
        }
        .setup-card.long .setup-title { color: #16a34a !important; }
        .setup-card.short .setup-title { color: #dc2626 !important; }
        .setup-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        .setup-card.long .setup-badge { background: #dcfce7 !important; color: #16a34a !important; }
        .setup-card.short .setup-badge { background: #fee2e2 !important; color: #dc2626 !important; }
        .setup-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            font-size: 0.85rem;
            background: transparent !important;
        }
        .setup-row .label { color: #9ca3af !important; }
        .setup-row .value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        .setup-row .value.green { color: #16a34a !important; }
        .setup-row .value.red { color: #dc2626 !important; }
        .setup-row .value.cyan { color: #0891b2 !important; }
        .setup-row .value.yellow { color: #d97706 !important; }
        .setup-row .value.default { color: #374151 !important; }
        .setup-agg {
            background: linear-gradient(90deg, #fef3c7 0%, #fffbeb 100%) !important;
            margin: 0.75rem -0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .setup-agg .label { color: #92400e !important; font-weight: 600; font-size: 0.8rem; }
        .setup-agg .value { 
            color: #92400e !important; 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 600;
        }
        .setup-triggers {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #e5e5e5 !important;
            background: transparent !important;
        }
        .trigger {
            display: flex;
            gap: 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 0.35rem;
        }
        .trigger.valid { color: #16a34a !important; }
        .trigger.invalid { color: #9ca3af !important; }
        .trigger .icon { font-size: 0.9rem; }
        
        /* Verdict Card */
        .modal .verdict-card,
        .verdict-card {
            background: #fff !important;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            border: 1px solid #e5e5e5 !important;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .verdict-card.long-preferred { border-left: 4px solid #16a34a !important; }
        .verdict-card.short-preferred { border-left: 4px solid #dc2626 !important; }
        .verdict-icon { font-size: 1.5rem; }
        .verdict-dir { font-weight: 700; font-size: 1.1rem; }
        .verdict-card.long-preferred .verdict-dir { color: #16a34a !important; }
        .verdict-card.short-preferred .verdict-dir { color: #dc2626 !important; }
        .verdict-text { flex: 1; color: #6b7280 !important; font-size: 0.9rem; }
        .verdict-key {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #0891b2 !important;
            background: #ecfeff !important;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-weight: 500;
        }
        
        /* Bookmap Card */
        .modal .bookmap-card,
        .bookmap-card {
            background: #fff !important;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            border: 1px solid #e5e5e5 !important;
        }
        .bookmap-title {
            color: #7c3aed !important;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        .bookmap-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            background: transparent !important;
        }
        .bookmap-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 0.35rem;
            flex-shrink: 0;
        }
        .bookmap-dot.green { background: #16a34a !important; }
        .bookmap-dot.red { background: #dc2626 !important; }
        .bookmap-text { color: #6b7280 !important; }
        
        /* Options Strategy Card */
        .modal .options-card,
        .options-card {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%) !important;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            border: 1px solid #fde68a !important;
        }
        .options-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .options-title {
            font-weight: 700;
            color: #92400e !important;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .options-leverage {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: #a16207 !important;
        }
        .options-legs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .options-leg {
            background: rgba(255,255,255,0.7) !important;
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }
        .options-leg.primary { border-left: 3px solid #16a34a !important; }
        .options-leg.hedge { border-left: 3px solid #dc2626 !important; }
        .leg-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        .leg-type { font-weight: 700; font-size: 0.85rem; }
        .options-leg.primary .leg-type { color: #16a34a !important; }
        .options-leg.hedge .leg-type { color: #dc2626 !important; }
        .leg-strike {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: #374151 !important;
        }
        .leg-details { font-size: 0.75rem; color: #a16207 !important; }
        .options-scenarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .scenario {
            background: rgba(255,255,255,0.5) !important;
            border-radius: 8px;
            padding: 0.75rem;
        }
        .scenario-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .scenario.correct .scenario-label { color: #16a34a !important; }
        .scenario.wrong .scenario-label { color: #dc2626 !important; }
        .scenario.chop .scenario-label { color: #d97706 !important; }
        .scenario-text { font-size: 0.8rem; color: #78716c !important; }
        .options-flip {
            background: rgba(255,255,255,0.6) !important;
            border-radius: 6px;
            padding: 0.6rem 0.75rem;
            font-size: 0.8rem;
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }
        .options-flip .icon { color: #d97706 !important; font-size: 1rem; }
        .options-flip .text { color: #78716c !important; }
        
        /* Action Bar */
        .modal .action-bar,
        .action-bar {
            background: #fff !important;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e5e5e5 !important;
        }
        .action-info {
            display: flex;
            gap: 2rem;
            font-size: 0.85rem;
        }
        .action-item {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }
        .action-item .label { color: #9ca3af !important; font-size: 0.7rem; text-transform: uppercase; }
        .action-item .value { 
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 600;
            color: #374151 !important;
        }
        .log-btn {
            background: #3b82f6 !important;
            color: #fff !important;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        .log-btn:hover { 
            background: #2563eb !important; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }
        .log-btn:disabled {
            background: #93c5fd !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Responsive for Option 2 */
        @media (max-width: 768px) {
            .setups-grid { grid-template-columns: 1fr; }
            .options-legs { grid-template-columns: 1fr; }
            .options-scenarios { grid-template-columns: 1fr; }
            .flow-metrics { gap: 1rem; }
            .action-bar { flex-direction: column; gap: 1rem; }
            .action-info { width: 100%; justify-content: space-around; }
            .verdict-card { flex-direction: column; text-align: center; }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            animation: slideUp 0.3s ease;
        }

        .toast.success {
            background: var(--green);
            color: var(--bg-dark);
        }

        .toast.error {
            background: var(--red);
            color: white;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 { font-size: 1.8rem; }
            .result-item { grid-template-columns: 1fr; gap: 0.75rem; }
            .result-badges { flex-direction: row; align-items: center; }
            .result-actions { flex-direction: row; }
            .score-display { flex-direction: column; }
            .symbol-search { flex-direction: column; }
            .symbol-search input { text-align: center; }
        }

        /* Single Symbol Search */
        .symbol-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .symbol-search input {
            flex: 1;
            padding: 0.875rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: #f9fafb;
            border: 1px solid var(--border-light);
            border-radius: 10px;
            color: #222;
            outline: none;
            transition: all 0.2s;
        }

        .symbol-search input:focus {
            border-color: var(--green);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .symbol-search input::placeholder {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            text-transform: none;
            letter-spacing: 0;
            color: #9ca3af;
            font-weight: 400;
        }

        .quick-analyze-btn {
            padding: 0.875rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #10b981, #34d399);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .quick-analyze-btn:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }

        /* Timeframe Toggle */
        .timeframe-toggle {
            display: flex;
            gap: 0.25rem;
            background: #fff;
            border-radius: 10px;
            padding: 4px;
            border: 1px solid var(--border-light);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .tf-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 7px;
            background: transparent;
            color: var(--text-gray);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tf-btn:hover {
            color: #374151;
            background: #f3f4f6;
        }

        .tf-btn.active {
            background: var(--green);
            color: #fff;
        }

        /* VP Period buttons */
        .vp-period-toggle {
            background: #fff;
            border-radius: 10px;
            padding: 6px 10px;
            border: 1px solid var(--border-light);
            display: flex;
            gap: 0.5rem;
        }

        .vp-btn {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: 6px;
            background: #f3f4f6;
            color: var(--text-gray);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vp-btn:hover {
            background: #e5e7eb;
        }

        .vp-btn.active {
            background: var(--cyan);
            color: #fff;
        }

        .divider-text {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.8rem;
            margin: 1rem 0;
            position: relative;
        }

        .divider-text::before,
        .divider-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: var(--border-light);
        }

        .divider-text::before { left: 0; }
        .divider-text::after { right: 0; }

        /* AI Cards Grid System */
        .ai-card-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .ai-preset-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .ai-preset-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--bg-hover);
            color: var(--text-gray);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-preset-btn:hover {
            border-color: var(--cyan);
            color: var(--text-white);
        }

        .ai-preset-btn.active {
            background: var(--cyan);
            color: var(--bg-dark);
            border-color: var(--cyan);
        }

        .ai-cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 900px) {
            .ai-cards-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .ai-cards-grid { grid-template-columns: 1fr; }
        }

        .ai-card {
            background: var(--bg-hover);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: all 0.3s;
            display: none;
        }

        .ai-card.visible {
            display: block;
        }

        .ai-card.full-width {
            grid-column: span 4;
        }

        @media (max-width: 900px) {
            .ai-card.full-width { grid-column: span 2; }
        }

        @media (max-width: 600px) {
            .ai-card.full-width { grid-column: span 1; }
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .ai-card-icon {
            font-size: 1rem;
        }

        .ai-card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
        }

        .ai-card-body {
            padding: 0.75rem;
        }

        .ai-card.bias .ai-card-body {
            text-align: center;
            padding: 0.5rem;
        }

        .bias-direction {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .bias-direction.long { color: var(--green); }
        .bias-direction.short { color: var(--red); }
        .bias-direction.wait { color: var(--yellow); }

        .bias-prob {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .bias-scores {
            display: flex;
            gap: 0.4rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .mini-score {
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            text-align: center;
        }

        .mini-score.bull {
            background: rgba(0,255,136,0.15);
            border: 1px solid var(--green);
        }

        .mini-score.bear {
            background: rgba(255,71,87,0.15);
            border: 1px solid var(--red);
        }

        .mini-score-num {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 800;
        }

        .mini-score-label {
            font-size: 0.55rem;
            color: var(--text-gray);
            text-transform: uppercase;
        }

        .level-row-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .level-row-card:last-child {
            border-bottom: none;
        }

        .level-name {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .level-price {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .level-price.green { color: var(--green); }
        .level-price.red { color: var(--red); }
        .level-price.cyan { color: var(--cyan); }

        .rr-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
        }

        .rr-label {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .rr-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--cyan);
        }

        .reasoning-text {
            line-height: 1.5;
            font-size: 0.85rem;
            color: var(--text-white);
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.85rem;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .invalid-text {
            color: var(--red);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .size-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--cyan);
            text-align: center;
        }

        .ev-positive { color: var(--green); }
        .ev-negative { color: var(--red); }

        /* Side-by-side layout for Analysis + AI */
        .side-by-side-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .side-by-side-container {
                grid-template-columns: 1fr;
            }
        }

        .analysis-panel {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ai-panel {
            min-width: 0;
        }

        /* Account Settings Bar */
        .account-settings {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            background: rgba(0,245,212,0.05);
            border: 1px solid rgba(0,245,212,0.2);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .account-settings label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .account-settings input,
        .account-settings select {
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--bg-dark);
            color: var(--text-white);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            width: 100px;
        }

        .account-settings input:focus,
        .account-settings select:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .size-card-body {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .size-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .size-row:last-child {
            border-bottom: none;
        }

        .size-label {
            color: var(--text-gray);
            font-size: 0.8rem;
        }

        .size-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--cyan);
        }

        .size-value.highlight {
            color: var(--green);
            font-size: 1.1rem;
        }

        /* Trade Tracker Styles */
        .trades-btn {
            display: inline-block;
            padding: 0.6rem 1.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-gray);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trades-btn:hover {
            color: var(--green);
            border-color: var(--green);
            background: rgba(0,255,136,0.1);
        }

        .log-trade-btn {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.5rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid var(--green);
            border-radius: 6px;
            background: rgba(0,255,136,0.15);
            color: var(--green);
            cursor: pointer;
            transition: all 0.2s;
        }

        .log-trade-btn:hover {
            background: rgba(0,255,136,0.3);
        }

        .log-trade-btn.logged {
            background: rgba(0,255,136,0.3);
            border-color: var(--green);
            cursor: default;
        }

        .stats-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            padding: 1rem;
            background: var(--bg-hover);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 0.5rem 1rem;
            min-width: 70px;
        }

        .stat-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-gray);
            text-transform: uppercase;
        }

        .trade-card {
            background: var(--bg-hover);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .trade-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .trade-symbol {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .trade-direction {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .trade-direction.long {
            background: rgba(0,255,136,0.2);
            color: var(--green);
        }

        .trade-direction.short {
            background: rgba(255,71,87,0.2);
            color: var(--red);
        }

        .trade-levels {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }

        .trade-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .trade-action-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: var(--bg-dark);
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-action-btn:hover {
            border-color: var(--cyan);
        }

        .trade-action-btn.win {
            border-color: var(--green);
            color: var(--green);
        }

        .trade-action-btn.loss {
            border-color: var(--red);
            color: var(--red);
        }

        .trade-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        .trade-pnl.positive { color: var(--green); }
        .trade-pnl.negative { color: var(--red); }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--cyan);
            margin: 1rem 0 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .empty-trades {
            text-align: center;
            padding: 2rem;
            color: var(--text-gray);
        }

        /* Market Indices Bar */
        .indices-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .index-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #fff;
        }

        .index-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .index-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
        }

        .index-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }

        .index-change.positive {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .index-change.negative {
            background: rgba(255, 77, 77, 0.2);
            color: #ff4d4d;
        }

        .index-change.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        @media (max-width: 600px) {
            .indices-bar {
                gap: 1rem;
            }
            .index-item {
                flex: 1 1 45%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>ðŸŽ¯ Simple Scanner</h1>
            <p>Find high-probability trades in seconds</p>
            <div class="header-links">
                <a href="/" class="full-suite-link primary">âš¡ Full Suite</a>
                <button class="full-suite-link" onclick="openTradeTracker()">ðŸ“’ My Trades</button>
                <button class="full-suite-link" onclick="logout()">ðŸšª Logout</button>
            </div>
        </header>

        <!-- Market Indices Bar -->
        <div class="indices-bar" id="indices-bar">
            <div class="index-item" id="spy-index">
                <span class="index-label">SPY</span>
                <span class="index-price" id="spy-price">---</span>
                <span class="index-change neutral" id="spy-change">--</span>
            </div>
            <div class="index-item" id="qqq-index">
                <span class="index-label">QQQ</span>
                <span class="index-price" id="qqq-price">---</span>
                <span class="index-change neutral" id="qqq-change">--</span>
            </div>
            <div class="index-item" id="dia-index">
                <span class="index-label">DIA</span>
                <span class="index-price" id="dia-price">---</span>
                <span class="index-change neutral" id="dia-change">--</span>
            </div>
            <div class="index-item" id="iwm-index">
                <span class="index-label">IWM</span>
                <span class="index-price" id="iwm-price">---</span>
                <span class="index-change neutral" id="iwm-change">--</span>
            </div>
        </div>

        <!-- Scanner Card -->
        <div class="scanner-card">
            <!-- Shared Settings Row -->
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                <!-- Timeframe Toggle -->
                <div class="timeframe-toggle" style="margin: 0;">
                    <button class="tf-btn" data-tf="5MIN" onclick="setTimeframe('5MIN')">5m</button>
                    <button class="tf-btn" data-tf="15MIN" onclick="setTimeframe('15MIN')">15m</button>
                    <button class="tf-btn" data-tf="30MIN" onclick="setTimeframe('30MIN')">30m</button>
                    <button class="tf-btn active" data-tf="1HR" onclick="setTimeframe('1HR')">1hr</button>
                    <button class="tf-btn" data-tf="2HR" onclick="setTimeframe('2HR')">2hr</button>
                    <button class="tf-btn" data-tf="4HR" onclick="setTimeframe('4HR')">4hr</button>
                </div>
                
                <!-- VP Period Toggle (for investors) -->
                <div class="vp-period-toggle" style="margin: 0; display: flex; gap: 0.25rem;">
                    <button class="vp-btn" data-period="day" onclick="selectVPPeriod('day')" title="1 day lookback">ðŸ“…</button>
                    <button class="vp-btn active" data-period="swing" onclick="selectVPPeriod('swing')" title="5 days lookback">ðŸ“Š</button>
                    <button class="vp-btn" data-period="position" onclick="selectVPPeriod('position')" title="20 days lookback">ðŸ“ˆ</button>
                    <button class="vp-btn" data-period="investment" onclick="selectVPPeriod('investment')" title="3-9 months lookback">ðŸ’¼</button>
                </div>
                
                <!-- Skill Level Toggle -->
                <div class="level-toggle" style="margin: 0; flex: 0 0 auto;">
                    <button class="level-btn active" id="beginner-btn" onclick="setLevel('beginner')" style="padding: 0.5rem 1rem;">
                        ðŸŒ± Beginner
                    </button>
                    <button class="level-btn" id="pro-btn" onclick="setLevel('pro')" style="padding: 0.5rem 1rem;">
                        ðŸ”¥ Pro
                    </button>
                </div>
            </div>
            
            <!-- Two Paths -->
            <div class="path-container">
                <!-- Path 1: Analyze One -->
                <div class="path-box">
                    <div class="path-title">ðŸŽ¯ Analyze One Ticker</div>
                    <div class="symbol-search">
                        <input type="text" id="single-symbol" placeholder="Enter symbol (e.g., AAPL)" maxlength="5" onkeypress="if(event.key==='Enter') quickAnalyze()">
                    </div>
                    <div class="analysis-toggle" style="display:flex; align-items:center; justify-content:center; gap:8px; margin:10px 0;">
                        <span id="gpt-label" style="font-size:12px; color:#9ca3af;">GPT</span>
                        <label class="toggle-switch" style="position:relative; display:inline-block; width:44px; height:24px;">
                            <input type="checkbox" id="use-rules-toggle" checked style="opacity:0; width:0; height:0;" onchange="updateToggleLabels()">
                            <span class="toggle-slider" style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#16a34a; transition:.3s; border-radius:12px;"></span>
                        </label>
                        <span id="rules-label" style="font-size:12px; color:#16a34a; font-weight:600;">Rules (Free)</span>
                    </div>
                    <button class="path-action-btn analyze" onclick="quickAnalyze()">ANALYZE</button>
                </div>
                
                <!-- Path 2: Scan Universe -->
                <div class="path-box">
                    <div class="path-title green">ðŸ” Scan Universe</div>
                    
                    <div class="universe-grid">
                        <button class="universe-btn" onclick="toggleUniverse(this, 'tech')">ðŸ’» Tech</button>
                        <button class="universe-btn" onclick="toggleUniverse(this, 'mega')">ðŸ¢ Mega</button>
                        <button class="universe-btn" onclick="toggleUniverse(this, 'etfs')">ðŸ“ˆ ETFs</button>
                        <button class="universe-btn" onclick="toggleUniverse(this, 'meme')">ðŸš€ Meme</button>
                        <button class="universe-btn" onclick="toggleUniverse(this, 'all')">ðŸŒ All</button>
                    </div>
                    
                    <!-- Beginner Scans -->
                    <div class="scan-types" id="beginner-scans">
                        <button class="scan-pill long" onclick="toggleScan(this, 'bullish')">ðŸŸ¢ Longs</button>
                        <button class="scan-pill short" onclick="toggleScan(this, 'bearish')">ðŸ”´ Shorts</button>
                        <button class="scan-pill entry" onclick="toggleScan(this, 'entry')">ðŸŽ¯ Entry</button>
                        <button class="scan-pill volume" onclick="toggleScan(this, 'highVolume')">ðŸ”¥ Volume</button>
                        <button class="scan-pill squeeze" onclick="toggleScan(this, 'squeeze')">ðŸŽ° Squeeze</button>
                        <button class="scan-pill capitulation" onclick="toggleScan(this, 'capitulation')">ðŸ’€ Capit</button>
                        <button class="scan-pill all" onclick="toggleAllScans('beginner')">ðŸŒ All</button>
                    </div>
                    
                    <!-- Pro Scans (hidden by default) -->
                    <div class="scan-types" id="pro-scans" style="display: none;">
                        <button class="scan-pill long" onclick="toggleScan(this, 'bullish')">ðŸŸ¢ Longs</button>
                        <button class="scan-pill short" onclick="toggleScan(this, 'bearish')">ðŸ”´ Shorts</button>
                        <button class="scan-pill entry" onclick="toggleScan(this, 'entry')">ðŸŽ¯ Entry</button>
                        <button class="scan-pill volume" onclick="toggleScan(this, 'highVolume')">ðŸ”¥ Volume</button>
                        <button class="scan-pill squeeze" onclick="toggleScan(this, 'squeeze')">ðŸŽ° Squeeze</button>
                        <button class="scan-pill extension" onclick="toggleScan(this, 'extension')">ðŸš€ Ext Snap</button>
                        <button class="scan-pill compression" onclick="toggleScan(this, 'compression')">ðŸˆ Compress</button>
                        <button class="scan-pill levels" onclick="toggleScan(this, 'atLevels')">ðŸ“ Levels</button>
                        <button class="scan-pill aplus" onclick="toggleScan(this, 'aPlus')">ðŸ’Ž A+</button>
                        <button class="scan-pill capitulation" onclick="toggleScan(this, 'capitulation')">ðŸ’€ Capit</button>
                        <button class="scan-pill all" onclick="toggleAllScans('pro')">ðŸŒ All</button>
                    </div>
                    
                    <button class="path-action-btn scan" onclick="runScan()">SCAN</button>
                </div>
            </div>

            <div class="progress-container" id="progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Scanning...</div>
            </div>
        </div>

        <!-- Results Card -->
        <div class="results-card" id="results-card">
            <div class="results-header">
                <div class="results-count" id="results-count">0 Results</div>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterResults('all')">All</button>
                    <button class="filter-tab" onclick="filterResults('long')">ðŸŸ¢ Longs</button>
                    <button class="filter-tab" onclick="filterResults('short')">ðŸ”´ Shorts</button>
                </div>
            </div>
            <div class="score-controls">
                <div class="score-filter-group">
                    <label>Min Score:</label>
                    <select class="score-select" id="min-score-filter" onchange="applyFilters()">
                        <option value="0">All</option>
                        <option value="50">50+</option>
                        <option value="60">60+</option>
                        <option value="70">70+ â­</option>
                        <option value="80">80+ ðŸ”¥</option>
                    </select>
                </div>
                <div class="score-filter-group">
                    <label>Sort:</label>
                    <select class="score-select" id="sort-by" onchange="applyFilters()">
                        <option value="confluence">ðŸ”¥ Confluence (Multi-Signal)</option>
                        <option value="score">ðŸ“Š Score (Highâ†’Low)</option>
                        <option value="confidence">ðŸ’¯ Confidence</option>
                        <option value="rvol">ðŸ“ˆ Volume</option>
                        <option value="symbol">ðŸ”¤ Symbol</option>
                    </select>
                </div>
                <div class="auto-report-toggle">
                    <input type="checkbox" id="auto-report-toggle" checked onchange="autoReportEnabled = this.checked">
                    <label for="auto-report-toggle">ðŸ“ Auto-reports</label>
                </div>
            </div>
            
            <div class="result-list" id="result-list">
                <!-- Results go here -->
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        const API_BASE = 'https://analysisgrid-production.up.railway.app';
        
        // Fetch and display market indices
        async function fetchIndices() {
            const indices = ['SPY', 'QQQ', 'DIA', 'IWM'];
            
            for (const symbol of indices) {
                try {
                    const response = await fetch(`${API_BASE}/api/quote/${symbol}`);
                    if (response.ok) {
                        const data = await response.json();
                        updateIndexDisplay(symbol.toLowerCase(), data);
                    }
                } catch (err) {
                    console.log(`Failed to fetch ${symbol}:`, err);
                }
            }
        }

        function updateIndexDisplay(symbol, data) {
            const priceEl = document.getElementById(`${symbol}-price`);
            const changeEl = document.getElementById(`${symbol}-change`);
            
            if (!priceEl || !changeEl || !data) return;
            
            const price = data.c || data.price || data.current;
            const prevClose = data.pc || data.previousClose || data.prev_close;
            
            if (price) {
                priceEl.textContent = `$${price.toFixed(2)}`;
                
                if (prevClose) {
                    const change = price - prevClose;
                    const changePct = ((change / prevClose) * 100).toFixed(2);
                    const isPositive = change >= 0;
                    
                    changeEl.textContent = `${isPositive ? '+' : ''}${changePct}%`;
                    changeEl.className = `index-change ${isPositive ? 'positive' : 'negative'}`;
                }
            }
        }

        // Fetch indices on load and refresh every 30 seconds
        fetchIndices();
        setInterval(fetchIndices, 30000);

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB4oBeoFzFV2oS5ZxEvQ4TIRRVJFC3nl-w",
            authDomain: "analysis-grid.firebaseapp.com",
            projectId: "analysis-grid",
            storageBucket: "analysis-grid.firebasestorage.app",
            messagingSenderId: "633207767657",
            appId: "1:633207767657:web:e623871eca352a268b58f8"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        window.currentUser = null;
        
        // Listen for auth state
        window.auth.onAuthStateChanged((user) => {
            window.currentUser = user;
            if (user) {
                console.log('âœ… Logged in as:', user.email);
            }
        });
        
        // Stock universes - Updated with top options volume stocks
        const UNIVERSES = {
            tech: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA', 'AMD', 'INTC', 'CRM', 
                   'ORCL', 'ADBE', 'NFLX', 'PYPL', 'SQ', 'SHOP', 'SNOW', 'NET', 'DDOG', 'MDB',
                   'AVGO', 'MU', 'PLTR', 'APP'],
            mega: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA', 'BRK.B', 'UNH', 'JNJ',
                   'V', 'JPM', 'WMT', 'PG', 'MA', 'HD', 'DIS', 'BAC', 'XOM', 'PFE', 'AVGO'],
            etfs: ['SPY', 'QQQ', 'IWM', 'DIA', 'XLF', 'XLK', 'XLE', 'GLD', 'SLV', 'TLT', 'SMH',
                   'ARKK', 'SOXX', 'XBI', 'VXX', 'SQQQ', 'TQQQ', 'IBIT'],
            meme: ['GME', 'AMC', 'PLTR', 'SOFI', 'RIVN', 'LCID', 'NIO', 'HOOD', 'COIN', 'MARA',
                   'RIOT', 'DKNG', 'SPCE', 'TLRY', 'MSTR'],
            all: []
        };
        
        // Combine all for 'all'
        UNIVERSES.all = [...new Set([...UNIVERSES.tech, ...UNIVERSES.mega, ...UNIVERSES.etfs, ...UNIVERSES.meme])];
        
        let selectedUniverses = { tech: false, mega: false, etfs: false, meme: false, all: false };
        let selectedScans = { bullish: false, bearish: false, entry: false, highVolume: false, squeeze: false, extension: false, compression: false, atLevels: false, aPlus: false, capitulation: false };
        let allResults = [];
        let currentDirectionFilter = 'all';
        let minScoreFilter = 0;
        let sortBy = 'score';
        let currentLevel = 'beginner';
        let selectedTimeframe = '1HR';
        let selectedVPPeriod = 'swing';  // 'day', 'swing', 'position', 'investment'
        
        // VP Period descriptions
        const VP_PERIODS = {
            day: { label: 'ðŸ“… Day', desc: '1 day - Intraday traders' },
            swing: { label: 'ðŸ“Š Swing', desc: '5 days - Swing traders (default)' },
            position: { label: 'ðŸ“ˆ Position', desc: '20 days - Position traders' },
            investment: { label: 'ðŸ’¼ Investment', desc: '3-9 months - Long-term investors' }
        };
        
        function selectVPPeriod(period) {
            selectedVPPeriod = period;
            document.querySelectorAll('.vp-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.vp-btn[data-period="${period}"]`)?.classList.add('active');
        }
        
        // Account settings functions
        function getAccountSize() {
            return localStorage.getItem('accountSize') || '10000';
        }
        
        function saveAccountSize(value) {
            const cleaned = value.replace(/[^0-9.]/g, '');
            localStorage.setItem('accountSize', cleaned);
            updateOneRDisplay();
        }
        
        function getRiskPercent() {
            return parseFloat(localStorage.getItem('riskPercent') || '1');
        }
        
        function saveRiskPercent(value) {
            localStorage.setItem('riskPercent', value);
            updateOneRDisplay();
        }
        
        function calculateOneR() {
            const account = parseFloat(getAccountSize()) || 10000;
            const riskPct = getRiskPercent() / 100;
            return account * riskPct;
        }
        
        function updateOneRDisplay() {
            const display = document.querySelector('.account-settings span');
            if (display) {
                display.textContent = `1R = $${calculateOneR().toFixed(0)}`;
            }
        }
        
        function calculatePositionSize(rMultiple, entryPrice, stopPrice) {
            const oneR = calculateOneR();
            const riskDollars = oneR * rMultiple;
            const riskPerShare = Math.abs(entryPrice - stopPrice);
            const shares = riskPerShare > 0 ? Math.floor(riskDollars / riskPerShare) : 0;
            return { riskDollars, shares, riskPerShare };
        }
        
        function setTimeframe(tf) {
            selectedTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tf === tf);
            });
        }
        
        // Toggle label updater
        function updateToggleLabels() {
            const isRules = document.getElementById('use-rules-toggle').checked;
            const gptLabel = document.getElementById('gpt-label');
            const rulesLabel = document.getElementById('rules-label');
            const slider = document.querySelector('#use-rules-toggle + .toggle-slider');
            if (isRules) {
                gptLabel.style.color = '#9ca3af';
                gptLabel.style.fontWeight = 'normal';
                rulesLabel.style.color = '#16a34a';
                rulesLabel.style.fontWeight = '600';
                if (slider) slider.style.backgroundColor = '#16a34a';
            } else {
                gptLabel.style.color = '#2563eb';
                gptLabel.style.fontWeight = '600';
                rulesLabel.style.color = '#9ca3af';
                rulesLabel.style.fontWeight = 'normal';
                if (slider) slider.style.backgroundColor = '#2563eb';
            }
        }
        
        // Quick analyze single symbol - Shows AI Trade Plan with Order Flow
        async function quickAnalyze() {
            const input = document.getElementById('single-symbol');
            const symbol = input.value.trim().toUpperCase();
            
            if (!symbol) {
                showToast('Enter a symbol to analyze', 'error');
                return;
            }
            
            // Check toggle: checked = Rules, unchecked = GPT
            const useRules = document.getElementById('use-rules-toggle').checked;
            
            // Show loading modal IMMEDIATELY so user sees feedback right away
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="trade-plan-modal" style="background: #f8f8f8; max-width: 980px; margin: 2rem auto; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.08); font-family: 'Inter', -apple-system, sans-serif;">
                    <div class="trade-plan-content" style="padding: 0; background: #f8f8f8;">
                        <div style="background: #fff; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
                            <div style="color: #222; font-weight: 600;">ðŸ“ Analyzing ${symbol}...</div>
                            <button style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer;" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                        </div>
                        <div class="loading" style="padding: 3rem;"><div class="spinner"></div>${useRules ? 'Generating trade plan from YOUR rules...' : 'ðŸ¤– Generating AI trade plan (GPT)...'}</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            try {
                // Fetch basic analysis data first (both paths need this)
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}`);
                
                // Store scan result for potential reuse by getAIPlan
                const scanResult = {
                    symbol: symbol,
                    signal: data.signal || 'NEUTRAL',
                    signal_type: data.signal_type || 'manual',
                    direction: data.signal?.includes('LONG') ? 'long' : data.signal?.includes('SHORT') ? 'short' : 'neutral',
                    confidence: data.confidence || 50,
                    bull_score: data.bull_score || 0,
                    bear_score: data.bear_score || 0,
                    rvol: data.rvol || 1.0,
                    current_price: data.current_price,
                    vah: data.vah,
                    poc: data.poc,
                    val: data.val,
                    vwap: data.vwap,
                    rsi: data.rsi,
                    order_flow: data.order_flow || null,
                    day_open: data.day_open,
                    day_high: data.day_high,
                    day_low: data.day_low,
                    prev_close: data.prev_close,
                    fib_position: data.fib_position || null,
                                fib_zone: data.fib_zone || null,
                                fib_quality: data.fib_quality || null,
                                fib_trend: data.fib_trend || null,
                                fib_levels: data.fib_levels || null,
                                fib_confluence: data.fib_confluence || null,
                    fib_zone: data.fib_zone || null,
                    fib_quality: data.fib_quality || null,
                    fib_trend: data.fib_trend || null,
                    fib_levels: data.fib_levels || null,
                    fib_confluence: data.fib_confluence || null,
                    type: 'manual'
                };
                
                const existingIndex = allResults.findIndex(r => r.symbol === symbol);
                if (existingIndex >= 0) {
                    allResults[existingIndex] = scanResult;
                } else {
                    allResults.push(scanResult);
                }
                
                if (useRules) {
                    // RULES PATH: deterministic, free, no GPT cost
                    const loadingDiv = modal.querySelector('.loading');
                    if (loadingDiv) loadingDiv.innerHTML = '<div class="spinner"></div>Generating trade plan from YOUR rules...';
                    getAIPlan(symbol, scanResult.direction, '', modal);
                } else {
                    // GPT PATH: call MTF AI endpoint
                    const loadingDiv = modal.querySelector('.loading');
                    if (loadingDiv) loadingDiv.innerHTML = '<div class="spinner"></div>ðŸ¤– AI analyzing multi-timeframe data...';
                    getGPTPlan(symbol, data, modal);
                }
                
            } catch (e) {
                console.error('Failed to analyze:', e);
                // Show error in the existing modal
                modal.querySelector('.trade-plan-content').innerHTML = `
                    <div style="background: #fff; border-radius: 12px; margin: 1rem; padding: 2rem; text-align: center; border: 1px solid #e5e5e5;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                        <h3 style="color: #222; margin: 0 0 0.5rem 0; font-weight: 600;">Could Not Analyze ${symbol}</h3>
                        <p style="color: #6b7280; margin: 0 0 1rem 0;">${e.message}</p>
                        <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 1rem; padding: 0.5rem 1.5rem; background: #2563eb; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Close</button>
                    </div>
                `;
            }
        }
        
        async function getGPTPlan(symbol, scanData, existingModal) {
            // GPT PATH: Call the MTF AI endpoint for full AI-generated trade plan
            const modal = existingModal;
            try {
                const response = await fetch(`${API_BASE}/api/analyze/live/mtf/${symbol}/ai?trade_tf=${selectedTimeframe}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ detail: 'AI request failed' }));
                    throw new Error(err.detail || `API error ${response.status}`);
                }
                
                const data = await response.json();
                
                // Store the AI plan data for logging
                window.lastGPTPlan = data;
                
                if (data.ai_commentary) {
                    // Parse entry/stop/targets from AI commentary
                    const entryMatch = data.ai_commentary.match(/ENTRY(?:\s*ZONE)?[:\s]*\$?([\d.]+)\s*-?\s*\$?([\d.]+)?/i);
                    const stopMatch = data.ai_commentary.match(/STOP(?:\s*LOSS)?[:\s]*\$?([\d.]+)/i);
                    const t1Match = data.ai_commentary.match(/TARGET\s*1[:\s]*\$?([\d.]+)/i);
                    const t2Match = data.ai_commentary.match(/TARGET\s*2[:\s]*\$?([\d.]+)/i);
                    const biasMatch = data.ai_commentary.match(/(?:TRADE\s*)?BIAS[:\s]*(LONG|SHORT|NO\s*TRADE)/i);
                    
                    const parsed = {
                        bias: biasMatch ? biasMatch[1].replace(/\s+/g, '') : 'NOTRADE',
                        entry: entryMatch ? parseFloat(entryMatch[1]) : 0,
                        stop: stopMatch ? parseFloat(stopMatch[1]) : 0,
                        target1: t1Match ? parseFloat(t1Match[1]) : 0,
                        target2: t2Match ? parseFloat(t2Match[1]) : 0
                    };
                    
                    window.lastGPTPlan.parsed = parsed;
                    
                    const isLong = parsed.bias === 'LONG';
                    const isShort = parsed.bias === 'SHORT';
                    const isNoTrade = !isLong && !isShort;
                    const dirColor = isLong ? '#16a34a' : isShort ? '#dc2626' : '#6b7280';
                    const dirEmoji = isLong ? 'ðŸŸ¢' : isShort ? 'ðŸ”´' : 'âšª';
                    const currentPrice = data.current_price || scanData?.current_price || 0;
                    
                    // Build GPT plan display
                    let planHTML = `
                        <div style="background: #fff; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.1rem; font-weight: 700; color: #222;">${symbol}</span>
                                <span style="font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 4px; background: ${dirColor}20; color: ${dirColor}; font-weight: 600;">${dirEmoji} ${parsed.bias}</span>
                                <span style="font-size: 0.7rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: #dbeafe; color: #2563eb; font-weight: 500;">ðŸ¤– GPT</span>
                            </div>
                            <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer;">Ã—</button>
                        </div>
                        
                        <div style="padding: 1rem 1.5rem;">
                            ${parsed.entry > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                                <div style="background: #fff; border-radius: 8px; padding: 0.75rem; text-align: center; border: 1px solid #e5e5e5;">
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Entry</div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 600; color: #374151;">$${parsed.entry.toFixed(2)}</div>
                                </div>
                                <div style="background: #fff; border-radius: 8px; padding: 0.75rem; text-align: center; border: 1px solid #fee2e2;">
                                    <div style="font-size: 0.65rem; color: #dc2626; text-transform: uppercase;">Stop</div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 600; color: #dc2626;">$${parsed.stop.toFixed(2)}</div>
                                </div>
                                <div style="background: #fff; border-radius: 8px; padding: 0.75rem; text-align: center; border: 1px solid #dcfce7;">
                                    <div style="font-size: 0.65rem; color: #16a34a; text-transform: uppercase;">Target 1</div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 600; color: #16a34a;">$${parsed.target1.toFixed(2)}</div>
                                </div>
                                <div style="background: #fff; border-radius: 8px; padding: 0.75rem; text-align: center; border: 1px solid #dcfce7;">
                                    <div style="font-size: 0.65rem; color: #16a34a; text-transform: uppercase;">Target 2</div>
                                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 600; color: #16a34a;">$${parsed.target2 > 0 ? parsed.target2.toFixed(2) : 'â€”'}</div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="background: #fff; border-radius: 8px; padding: 1rem; border: 1px solid #e5e5e5; border-left: 3px solid #2563eb; margin-bottom: 1rem;">
                                <div style="font-size: 0.7rem; color: #2563eb; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">ðŸ¤– AI Analysis</div>
                                <div style="font-size: 0.85rem; color: #374151; line-height: 1.6; white-space: pre-wrap;">${data.ai_commentary}</div>
                            </div>
                            
                            ${parsed.entry > 0 && !isNoTrade ? `
                            <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                                <button style="background: #3b82f6; color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;" onclick="logGPTTrade('${symbol}', this)">
                                    ðŸ“’ Log Trade
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    modal.querySelector('.trade-plan-content').innerHTML = planHTML;
                } else {
                    throw new Error('No AI commentary in response');
                }
                
            } catch (e) {
                console.warn('GPT plan error:', e);
                modal.querySelector('.trade-plan-content').innerHTML = `
                    <div style="background: #fff; border-radius: 12px; margin: 1rem; padding: 2rem; text-align: center; border: 1px solid #e5e5e5;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                        <h3 style="color: #222; margin: 0 0 0.5rem 0; font-weight: 600;">GPT Plan Failed</h3>
                        <p style="color: #6b7280; margin: 0 0 1rem 0;">${e.message}</p>
                        <p style="color: #9ca3af; font-size: 0.85rem;">Try switching to Rules (Free) mode for a deterministic plan.</p>
                        <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 1rem; padding: 0.5rem 1.5rem; background: #2563eb; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Close</button>
                    </div>
                `;
            }
        }
        
        async function logGPTTrade(symbol, btn) {
            // Log a trade from the GPT plan path
            if (!window.lastGPTPlan || !window.lastGPTPlan.parsed) {
                showToast('No GPT plan data to log', 'error');
                return;
            }
            const parsed = window.lastGPTPlan.parsed;
            const scanData = allResults.find(r => r.symbol === symbol);
            
            btn.innerHTML = 'â³ Logging...';
            btn.disabled = true;
            
            try {
                const tradeData = {
                    user_id: getUserId(),
                    symbol: symbol.toUpperCase(),
                    direction: parsed.bias === 'NOTRADE' ? 'LONG' : parsed.bias.toUpperCase(),
                    timeframe: selectedTimeframe,
                    entry_price: parsed.entry,
                    stop_loss: parsed.stop,
                    target1: parsed.target1,
                    target2: parsed.target2,
                    confidence: 50,
                    setup_grade: 'B',
                    notes: 'Logged from Simple Scanner GPT mode',
                    // Fib data from scan
                    fib_zone: scanData?.fib_zone || null,
                    fib_quality: scanData?.fib_quality || null,
                    fib_trend: scanData?.fib_trend || null,
                    fib_position: scanData?.fib_position || null
                };
                
                const res = await fetch(`${API_BASE}/api/journal/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tradeData)
                });
                
                if (!res.ok) throw new Error('Failed to log trade');
                
                btn.innerHTML = 'âœ… Logged!';
                btn.style.background = 'rgba(34,197,94,0.2)';
                btn.style.color = '#16a34a';
                showToast(`Trade logged: ${symbol} ${parsed.bias}`, 'success');
            } catch (e) {
                console.error('Failed to log GPT trade:', e);
                btn.innerHTML = 'âŒ Error';
                btn.disabled = false;
                showToast('Failed to log trade', 'error');
            }
        }
        
        async function loadAIForSymbol(btn, symbol) {
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;display:inline-block;margin-right:8px;"></div> Loading AI...';
            btn.disabled = true;
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`);
                
                const aiText = data.ai_commentary || '';
                const parsed = parseAIResponse(aiText, data);
                
                const responseDiv = document.getElementById('ai-response-quick');
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = buildAICardsHTML(parsed, symbol, data);
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
                
                btn.innerHTML = 'âœ… AI Loaded';
                btn.style.background = 'rgba(0,255,136,0.2)';
                btn.style.borderColor = 'var(--green)';
            } catch (e) {
                btn.innerHTML = 'âŒ Error loading AI';
                btn.disabled = false;
            }
        }
        
        function toggleAllScans(level) {
            const container = document.getElementById(level === 'beginner' ? 'beginner-scans' : 'pro-scans');
            const allBtn = container.querySelector('.scan-pill.all');
            const isActive = allBtn.classList.contains('active');
            
            // Get scan types for this level
            const beginnerScans = ['bullish', 'bearish', 'entry', 'highVolume', 'capitulation'];
            const proScans = ['bullish', 'bearish', 'entry', 'highVolume', 'squeeze', 'extension', 'atLevels', 'aPlus', 'capitulation'];
            const scans = level === 'beginner' ? beginnerScans : proScans;
            
            // Toggle all scans
            scans.forEach(scan => {
                selectedScans[scan] = !isActive;
            });
            
            // Update button states
            container.querySelectorAll('.scan-pill:not(.all)').forEach(btn => {
                btn.classList.toggle('active', !isActive);
            });
            allBtn.classList.toggle('active');
        }
        
        function setLevel(level) {
            currentLevel = level;
            
            // Update buttons
            document.getElementById('beginner-btn').classList.toggle('active', level === 'beginner');
            document.getElementById('pro-btn').classList.toggle('active', level === 'pro');
            
            // Show/hide scan types
            document.getElementById('beginner-scans').style.display = level === 'beginner' ? 'flex' : 'none';
            document.getElementById('pro-scans').style.display = level === 'pro' ? 'flex' : 'none';
            
            // Reset all scan selections when switching levels
            selectedScans = { bullish: false, bearish: false, entry: false, highVolume: false, squeeze: false, extension: false, atLevels: false, aPlus: false, capitulation: false };
            document.querySelectorAll('.scan-pill').forEach(btn => btn.classList.remove('active'));
        }
        
        /**
         * Smart A+ Quality Filter
         * Requires MULTIPLE confirmations, not just high confidence
         * 
         * Criteria varies by scan type:
         * - Bullish/Bearish: confidence >= 80 AND score >= 60 AND RVOL >= 1.2
         * - Entry: confidence >= 80 AND RVOL >= 1.2
         * - Squeeze: tier must be ACTIVE or EXTREME (score >= 70)
         * - Capitulation: must be CLIMAX or EXHAUSTION
         * - Extension: snap probability >= 75%
         */
        function isAPlusQuality(result, scanType) {
            if (!selectedScans.aPlus) return true;  // A+ filter not active
            
            const confidence = result.confidence || 0;
            const rvol = result.rvol || 1.0;
            const bullScore = result.bull_score || 0;
            const bearScore = result.bear_score || 0;
            const maxScore = Math.max(bullScore, bearScore);
            
            switch(scanType) {
                case 'bullish':
                case 'bearish':
                    // High confidence + strong score + volume confirmation
                    return confidence >= 80 && maxScore >= 60 && rvol >= 1.2;
                    
                case 'entry':
                    // High confidence + volume confirmation
                    return confidence >= 75 && rvol >= 1.2;
                    
                case 'squeeze':
                    // Must be ACTIVE tier or higher (score >= 60)
                    return (result.squeeze_score || 0) >= 60;
                    
                case 'capitulation':
                    // Must be CLIMAX or EXHAUSTION (tradeable levels)
                    return result.capitulation_level === 'CLIMAX' || result.capitulation_level === 'EXHAUSTION';
                    
                case 'extension':
                    // HIGH_PROB tier or better (prob >= 70)
                    return (result.probability || result.confidence || 0) >= 70;
                    
                case 'compression':
                    // A tier or better (score >= 80)
                    return (result.confidence || 0) >= 80;
                    
                case 'highVolume':
                    // Already filtered by RVOL >= 2.0, just need direction confidence
                    return confidence >= 65 && maxScore >= 50;
                    
                case 'atLevels':
                    // At key level + directional conviction
                    return maxScore >= 60 && rvol >= 1.0;
                    
                default:
                    return confidence >= 80;
            }
        }
        
        function toggleUniverse(btn, universe) {
            // If 'all' is clicked, toggle it and deselect others
            if (universe === 'all') {
                const isActive = !selectedUniverses.all;
                selectedUniverses = { tech: false, mega: false, etfs: false, meme: false, all: isActive };
                document.querySelectorAll('.universe-btn').forEach(b => b.classList.remove('active'));
                if (isActive) btn.classList.add('active');
            } else {
                // Toggle the clicked universe
                selectedUniverses[universe] = !selectedUniverses[universe];
                btn.classList.toggle('active');
                // Deselect 'all' if any individual is selected
                selectedUniverses.all = false;
                document.querySelector('.universe-btn:last-child')?.classList.remove('active');
            }
        }
        
        function getSelectedSymbols() {
            // Combine all selected universes
            let symbols = [];
            if (selectedUniverses.all) {
                return UNIVERSES.all;
            }
            if (selectedUniverses.tech) symbols = [...symbols, ...UNIVERSES.tech];
            if (selectedUniverses.mega) symbols = [...symbols, ...UNIVERSES.mega];
            if (selectedUniverses.etfs) symbols = [...symbols, ...UNIVERSES.etfs];
            if (selectedUniverses.meme) symbols = [...symbols, ...UNIVERSES.meme];
            // Remove duplicates
            return [...new Set(symbols)];
        }
        
        function toggleScan(btn, type) {
            btn.classList.toggle('active');
            selectedScans[type] = btn.classList.contains('active');
        }
        
        async function fetchJson(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }
        
        async function runScan() {
            const symbols = getSelectedSymbols();
            if (!symbols.length) {
                showToast('Select at least one universe!', 'error');
                return;
            }
            
            // Check if any scan type is selected
            const hasSelection = Object.values(selectedScans).some(v => v);
            if (!hasSelection) {
                showToast('Select at least one scan type!', 'error');
                return;
            }
            
            // Reset
            allResults = [];
            document.getElementById('results-card').style.display = 'block';
            document.getElementById('result-list').innerHTML = '<div class="loading"><div class="spinner"></div>Scanning...</div>';
            
            // Show progress
            const progress = document.getElementById('progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            progress.style.display = 'block';
            progressFill.style.width = '0%';
            
            document.querySelector('.path-action-btn.scan').disabled = true;
            
            let completed = 0;
            const total = symbols.length;
            
            // Scan in batches - OPTIMIZED: larger batches, shorter delay
            const BATCH_SIZE = 10;
            
            for (let i = 0; i < symbols.length; i += BATCH_SIZE) {
                const batch = symbols.slice(i, i + BATCH_SIZE);
                
                const promises = batch.map(async (symbol) => {
                    try {
                        // OPTIMIZED: Launch all API calls in parallel per symbol
                        const needsAnalysis = selectedScans.bullish || selectedScans.bearish || selectedScans.highVolume || selectedScans.atLevels || selectedScans.aPlus || selectedScans.extension || selectedScans.squeeze;
                        
                        const apiCalls = [];
                        
                        // Base analysis (if needed)
                        if (needsAnalysis) {
                            apiCalls.push(
                                fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=false`)
                                    .then(d => ({ type: 'analyze', data: d }))
                                    .catch(e => ({ type: 'analyze', data: null, error: e }))
                            );
                        }
                        
                        // Entry scan (if needed)
                        if (selectedScans.entry) {
                            const tfResolution = {'5MIN': 5, '15MIN': 15, '30MIN': 30, '1HR': 60, '2HR': 120, '4HR': 240}[selectedTimeframe] || 60;
                            apiCalls.push(
                                fetchJson(`${API_BASE}/api/entry-scan/scan/${symbol}?resolution=${tfResolution}&days=5&mtf_filter=true`)
                                    .then(d => ({ type: 'entry', data: d }))
                                    .catch(e => ({ type: 'entry', data: null, error: e }))
                            );
                        }
                        
                        // Squeeze scan (if needed)
                        if (selectedScans.squeeze) {
                            apiCalls.push(
                                fetchJson(`${API_BASE}/api/squeeze/${symbol}`)
                                    .then(d => ({ type: 'squeeze', data: d }))
                                    .catch(e => ({ type: 'squeeze', data: null, error: e }))
                            );
                        }
                        
                        // Compression scan (if needed)
                        if (selectedScans.compression) {
                            apiCalls.push(
                                fetchJson(`${API_BASE}/api/compression/quick/${symbol}`)
                                    .then(d => ({ type: 'compression', data: d }))
                                    .catch(e => ({ type: 'compression', data: null, error: e }))
                            );
                        }
                        
                        // Capitulation scan (if needed)
                        if (selectedScans.capitulation) {
                            apiCalls.push(
                                fetchJson(`${API_BASE}/api/capitulation/${symbol}`)
                                    .then(d => ({ type: 'capitulation', data: d }))
                                    .catch(e => ({ type: 'capitulation', data: null, error: e }))
                            );
                        }
                        
                        // Wait for all API calls in parallel
                        const results = await Promise.all(apiCalls);
                        
                        // Extract data from parallel results
                        let data = null;
                        let entryData = null;
                        let squeezeData = null;
                        let compData = null;
                        let capData = null;
                        
                        for (const result of results) {
                            if (result.type === 'analyze' && result.data) data = result.data;
                            if (result.type === 'entry' && result.data) entryData = result.data;
                            if (result.type === 'squeeze' && result.data) squeezeData = result.data;
                            if (result.type === 'compression' && result.data) compData = result.data;
                            if (result.type === 'capitulation' && result.data) capData = result.data;
                        }
                        
                        // DEBUG: Log analysis results
                        if (data) console.log(`[SCAN] ${symbol}: signal=${data?.signal}, bull=${data?.bull_score}, bear=${data?.bear_score}, conf=${data?.confidence}`);
                        
                        // ðŸŸ¢ BULLISH SCAN
                        if (selectedScans.bullish && data?.signal?.includes('LONG')) {
                            console.log(`âœ… ${symbol} MATCHED LONG filter`);
                            const result = {
                                symbol,
                                signal: data.signal,
                                signal_type: 'long_setup',
                                direction: 'long',
                                confidence: data.confidence || 0,
                                bull_score: data.bull_score || 0,
                                bear_score: data.bear_score || 0,
                                rvol: data.rvol || 1.0,
                                current_price: data.current_price,
                                vah: data.vah,
                                poc: data.poc,
                                val: data.val,
                                vwap: data.vwap,
                                rsi: data.rsi,
                                order_flow: data.order_flow || null,
                                day_open: data.day_open,
                                day_high: data.day_high,
                                day_low: data.day_low,
                                prev_close: data.prev_close,
                                fib_position: data.fib_position || null,
                                fib_zone: data.fib_zone || null,
                                fib_quality: data.fib_quality || null,
                                fib_trend: data.fib_trend || null,
                                fib_levels: data.fib_levels || null,
                                fib_confluence: data.fib_confluence || null,
                                type: 'bullish'
                            };
                            if (isAPlusQuality(result, 'bullish')) {
                                allResults.push(result);
                            }
                        }
                        
                        // ðŸ”´ BEARISH SCAN
                        if (selectedScans.bearish && data?.signal?.includes('SHORT')) {
                            const result = {
                                symbol,
                                signal: data.signal,
                                signal_type: 'short_setup',
                                direction: 'short',
                                confidence: data.confidence || 0,
                                bull_score: data.bull_score || 0,
                                bear_score: data.bear_score || 0,
                                rvol: data.rvol || 1.0,
                                current_price: data.current_price,
                                vah: data.vah,
                                poc: data.poc,
                                val: data.val,
                                vwap: data.vwap,
                                rsi: data.rsi,
                                order_flow: data.order_flow || null,
                                day_open: data.day_open,
                                day_high: data.day_high,
                                day_low: data.day_low,
                                prev_close: data.prev_close,
                                fib_position: data.fib_position || null,
                                fib_zone: data.fib_zone || null,
                                fib_quality: data.fib_quality || null,
                                fib_trend: data.fib_trend || null,
                                fib_levels: data.fib_levels || null,
                                fib_confluence: data.fib_confluence || null,
                                type: 'bearish'
                            };
                            if (isAPlusQuality(result, 'bearish')) {
                                allResults.push(result);
                            }
                        }
                        
                        // ðŸ”¥ HIGH VOLUME SCAN (RVOL >= 2.0)
                        if (selectedScans.highVolume && data && (data.rvol || 1.0) >= 2.0) {
                            const direction = data.signal?.includes('LONG') ? 'long' : data.signal?.includes('SHORT') ? 'short' : 'neutral';
                            // Avoid duplicates if already added by bullish/bearish
                            const alreadyAdded = allResults.some(r => r.symbol === symbol && (r.type === 'bullish' || r.type === 'bearish'));
                            if (!alreadyAdded) {
                                allResults.push({
                                    symbol,
                                    signal: `ðŸ”¥ HIGH VOLUME ${data.rvol?.toFixed(1)}x`,
                                    direction,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    order_flow: data.order_flow || null,
                                    day_open: data.day_open,
                                    day_high: data.day_high,
                                    day_low: data.day_low,
                                    prev_close: data.prev_close,
                                    fib_position: data.fib_position || null,
                                fib_zone: data.fib_zone || null,
                                fib_quality: data.fib_quality || null,
                                fib_trend: data.fib_trend || null,
                                fib_levels: data.fib_levels || null,
                                fib_confluence: data.fib_confluence || null,
                                    type: 'highVolume'
                                });
                            }
                        }
                        
                        // ðŸ“ AT KEY LEVELS (price within 0.5% of VAH, POC, or VAL)
                        if (selectedScans.atLevels && data) {
                            const price = data.current_price;
                            const threshold = 0.005; // 0.5%
                            let levelHit = null;
                            
                            // Determine actual direction from bull/bear scores
                            const isBullish = (data.bull_score || 0) > (data.bear_score || 0);
                            const isBearish = (data.bear_score || 0) > (data.bull_score || 0);
                            
                            if (data.vah && Math.abs(price - data.vah) / data.vah < threshold) {
                                // At VAH: typically short if bearish scores, but respect actual scores
                                levelHit = { level: 'VAH', value: data.vah, direction: isBullish ? 'long' : 'short' };
                            } else if (data.val && Math.abs(price - data.val) / data.val < threshold) {
                                // At VAL: typically long if bullish scores, but respect actual scores
                                levelHit = { level: 'VAL', value: data.val, direction: isBullish ? 'long' : 'short' };
                            } else if (data.poc && Math.abs(price - data.poc) / data.poc < threshold) {
                                // At POC: use bull/bear scores to determine
                                levelHit = { level: 'POC', value: data.poc, direction: isBullish ? 'long' : (isBearish ? 'short' : 'neutral') };
                            }
                            
                            if (levelHit) {
                                allResults.push({
                                    symbol,
                                    signal: `ðŸ“ AT ${levelHit.level} ($${levelHit.value?.toFixed(2)})`,
                                    direction: levelHit.direction,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    order_flow: data.order_flow || null,
                                    day_open: data.day_open,
                                    day_high: data.day_high,
                                    day_low: data.day_low,
                                    prev_close: data.prev_close,
                                    fib_position: data.fib_position || null,
                                fib_zone: data.fib_zone || null,
                                fib_quality: data.fib_quality || null,
                                fib_trend: data.fib_trend || null,
                                fib_levels: data.fib_levels || null,
                                fib_confluence: data.fib_confluence || null,
                                    type: 'atLevels'
                                });
                            }
                        }
                        
                        // ðŸŽ¯ ENTRY SIGNALS (using pre-fetched data)
                        if (selectedScans.entry && entryData) {
                            try {
                                if (entryData.signals?.length > 0) {
                                    for (const sig of entryData.signals) {
                                        const isLongEntry = sig.direction === 'long';
                                        const isShortEntry = sig.direction === 'short';
                                        
                                        const addLong = selectedScans.bullish && isLongEntry;
                                        const addShort = selectedScans.bearish && isShortEntry;
                                        const addAll = !selectedScans.bullish && !selectedScans.bearish;
                                        
                                        if (addLong || addShort || addAll) {
                                            const result = {
                                                symbol,
                                                signal: sig.entry_type.replace(/_/g, ' ').toUpperCase(),
                                                signal_type: sig.entry_type,  // Raw type for AI (e.g. "failed_breakout")
                                                direction: sig.direction,
                                                confidence: sig.confidence || 0,
                                                entry_price: sig.entry_price,
                                                stop_price: sig.stop_price,
                                                target_1: sig.target_1,
                                                rr_ratio: sig.rr_ratio,
                                                rvol: entryData.rvol || 1.0,
                                                bull_score: isLongEntry ? (sig.confidence || 0) : 0,
                                                bear_score: isShortEntry ? (sig.confidence || 0) : 0,
                                                current_price: entryData.current_price,
                                                vah: entryData.levels?.vah,
                                                poc: entryData.levels?.poc,
                                                val: entryData.levels?.val,
                                                fib_position: data?.fib_position || null,
                                        fib_zone: data?.fib_zone || null,
                                        fib_quality: data?.fib_quality || null,
                                        fib_trend: data?.fib_trend || null,
                                        fib_levels: data?.fib_levels || null,
                                        fib_confluence: data?.fib_confluence || null,
                                                type: 'entry'
                                            };
                                            if (isAPlusQuality(result, 'entry')) {
                                                allResults.push(result);
                                            }
                                            break;
                                        }
                                    }
                                }
                            } catch (e) {}
                        }
                        
                        // ðŸŽ° ENHANCED SQUEEZE SCAN (using pre-fetched data)
                        if (selectedScans.squeeze && squeezeData) {
                            try {
                                if (squeezeData && !squeezeData.error && squeezeData.tier !== 'NONE') {
                                    // Tier-based emoji and label
                                    let tierLabel = '';
                                    let tierEmoji = 'ðŸŽ°';
                                    if (squeezeData.tier === 'EXTREME') {
                                        tierLabel = 'ðŸ”¥ EXTREME';
                                        tierEmoji = 'ðŸ’¥';
                                    } else if (squeezeData.tier === 'ACTIVE') {
                                        tierLabel = 'ACTIVE';
                                        tierEmoji = 'ðŸŽ¯';
                                    } else {
                                        tierLabel = 'FORMING';
                                    }
                                    
                                    // Build signal string with top factors
                                    const factors = squeezeData.factors || [];
                                    let signalText = `${tierEmoji} SQUEEZE ${tierLabel}`;
                                    if (squeezeData.ttm_squeeze) signalText += ' [TTM]';
                                    if (factors.length > 0) signalText += ` - ${factors.slice(0, 2).join(', ')}`;
                                    
                                    // Direction bias indicator
                                    let directionHint = '';
                                    if (squeezeData.direction_bias === 'long' && squeezeData.bias_score >= 30) {
                                        directionHint = ' â¬†ï¸';
                                    } else if (squeezeData.direction_bias === 'short' && squeezeData.bias_score >= 30) {
                                        directionHint = ' â¬‡ï¸';
                                    }
                                    
                                    const result = {
                                        symbol,
                                        signal: signalText + directionHint,
                                        direction: squeezeData.direction_bias || 'neutral',
                                        confidence: squeezeData.score || 0,
                                        squeeze_score: squeezeData.score,
                                        squeeze_tier: squeezeData.tier,
                                        ttm_squeeze: squeezeData.ttm_squeeze,
                                        squeeze_duration: squeezeData.squeeze_duration,
                                        atr_compression: squeezeData.atr_compression,
                                        adx: squeezeData.adx,
                                        direction_bias: squeezeData.direction_bias,
                                        bias_score: squeezeData.bias_score,
                                        price_drift: squeezeData.price_drift,
                                        volume_bias: squeezeData.volume_bias,
                                        rsi: squeezeData.rsi,
                                        rvol: squeezeData.rvol,
                                        bull_score: squeezeData.score || 0,
                                        bear_score: 0,
                                        current_price: squeezeData.current_price,
                                        upper_band: squeezeData.upper_band,
                                        lower_band: squeezeData.lower_band,
                                        atr: squeezeData.atr,
                                        factors: factors,
                                        fib_position: data?.fib_position || null,
                                        fib_zone: data?.fib_zone || null,
                                        fib_quality: data?.fib_quality || null,
                                        fib_trend: data?.fib_trend || null,
                                        fib_levels: data?.fib_levels || null,
                                        fib_confluence: data?.fib_confluence || null,
                                        type: 'squeeze'
                                    };
                                    if (isAPlusQuality(result, 'squeeze')) {
                                        allResults.push(result);
                                    }
                                }
                            } catch (e) {
                                console.log(`Squeeze scan error for ${symbol}:`, e);
                            }
                        }
                        
                        // ðŸš€ EXTENSION SNAP (uses data from analyze endpoint)
                        if (selectedScans.extension && data?.extension?.hottest_setup) {
                            const ext = data.extension.hottest_setup;
                            if (ext.snap_back_prob >= 60) {
                                // Snap direction is opposite of extension
                                const snapDirection = ext.direction === 'above' ? 'short' : 'long';
                                const result = {
                                    symbol,
                                    signal: `ðŸš€ ${ext.trigger} - ${ext.candles} candles ${ext.direction} ${ext.level.toUpperCase()}`,
                                    direction: snapDirection,
                                    confidence: ext.snap_back_prob,
                                    probability: ext.snap_back_prob,
                                    candles: ext.candles,
                                    trigger: ext.trigger,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    rvol: data.rvol || 1.0,
                                    current_price: data.current_price,
                                    vah: data.vah,
                                    poc: data.poc,
                                    val: data.val,
                                    order_flow: data.order_flow || null,
                                    day_open: data.day_open,
                                    day_high: data.day_high,
                                    day_low: data.day_low,
                                    prev_close: data.prev_close,
                                    fib_position: data.fib_position || null,
                                fib_zone: data.fib_zone || null,
                                fib_quality: data.fib_quality || null,
                                fib_trend: data.fib_trend || null,
                                fib_levels: data.fib_levels || null,
                                fib_confluence: data.fib_confluence || null,
                                    type: 'extension'
                                };
                                if (isAPlusQuality(result, 'extension')) {
                                    allResults.push(result);
                                }
                            }
                        }
                        
                        // ðŸˆ COMPRESSION REVERSAL (using pre-fetched data)
                        if (selectedScans.compression && compData) {
                            try {
                                if (compData.tradeable) {
                                    allResults.push({
                                        symbol,
                                        signal: `ðŸˆ ${compData.quality} COMPRESS - RSI ${compData.rsi}`,
                                        direction: 'long',  // Compression reversals are always long from VAL
                                        confidence: compData.score || 0,
                                        compression: compData.compression,
                                        at_val: compData.at_val,
                                        reversal_candle: compData.reversal_candle,
                                        bull_score: 0,
                                        bear_score: 0,
                                        rvol: data?.rvol || 1.0,
                                        current_price: compData.price,
                                        vah: data?.vah,
                                        poc: compData.poc,
                                        val: compData.val,
                                        fib_position: data?.fib_position || null,
                                        fib_zone: data?.fib_zone || null,
                                        fib_quality: data?.fib_quality || null,
                                        fib_trend: data?.fib_trend || null,
                                        fib_levels: data?.fib_levels || null,
                                        fib_confluence: data?.fib_confluence || null,
                                        type: 'compression'
                                    });
                                }
                            } catch (e) {}
                        }
                        
                        // ðŸ’€ CAPITULATION SCAN (using pre-fetched data)
                        if (selectedScans.capitulation && capData) {
                            try {
                                // Show all CLIMAX/EXHAUSTION, plus DEVELOPING if score >= 50
                                const isTradeable = capData.tradeable;  // CLIMAX or EXHAUSTION
                                const isDeveloping = capData.level === 'DEVELOPING' && capData.score >= 50;
                                if (isTradeable || isDeveloping) {
                                    const levelEmoji = capData.level === 'EXHAUSTION' ? 'ðŸŸ¢' : capData.level === 'CLIMAX' ? 'ðŸ”´' : 'ðŸŸ¡';
                                    const result = {
                                        symbol,
                                        signal: `ðŸ’€ ${levelEmoji} ${capData.level} - Down ${capData.decline_pct?.toFixed(1)}%`,
                                        direction: 'long',  // Capitulation = buying the dip
                                        confidence: capData.score || 0,
                                        capitulation_level: capData.level,
                                        decline_pct: capData.decline_pct,
                                        rsi: capData.rsi,
                                        volume_exhaustion: capData.volume_exhaustion,
                                        rsi_divergence: capData.rsi_divergence,
                                        reversal_candle: capData.reversal_candle,
                                        bull_score: capData.score || 0,
                                        bear_score: 0,
                                        rvol: capData.rvol || 1.0,
                                        current_price: capData.price,
                                        entry_zone: capData.entry_zone,
                                        stop_loss: capData.stop_loss,
                                        target_1: capData.target_1,
                                        target_2: capData.target_2,
                                        fib_position: data?.fib_position || null,
                                        fib_zone: data?.fib_zone || null,
                                        fib_quality: data?.fib_quality || null,
                                        fib_trend: data?.fib_trend || null,
                                        fib_levels: data?.fib_levels || null,
                                        fib_confluence: data?.fib_confluence || null,
                                        type: 'capitulation'
                                    };
                                    if (isAPlusQuality(result, 'capitulation')) {
                                        allResults.push(result);
                                    }
                                }
                            } catch (e) {}
                        }
                        
                    } catch (e) {
                        console.error(`âŒ ERROR scanning ${symbol}:`, e);
                    }
                    
                    completed++;
                    progressFill.style.width = `${(completed / total) * 100}%`;
                    progressText.textContent = `Scanning ${completed}/${total}...`;
                });
                
                await Promise.all(promises);
                // Shorter delay between batches (300ms instead of 600ms)
                if (i + BATCH_SIZE < symbols.length) {
                    await new Promise(r => setTimeout(r, 300));
                }
            }
            
            // Done
            progressText.textContent = 'âœ… Scan complete!';
            progressFill.style.width = '100%';
            document.querySelector('.path-action-btn.scan').disabled = false;
            
            // ==========================================
            // CONFLUENCE GROUPING - Same symbol + same direction = higher rank
            // ==========================================
            const grouped = {};
            allResults.forEach(r => {
                const key = `${r.symbol}_${r.direction}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        ...r,
                        scans: [r.type],
                        confluenceCount: 1
                    };
                } else {
                    // Add this scan type to the list
                    if (!grouped[key].scans.includes(r.type)) {
                        grouped[key].scans.push(r.type);
                        grouped[key].confluenceCount++;
                    }
                    // Take the highest confidence/scores
                    grouped[key].confidence = Math.max(grouped[key].confidence || 0, r.confidence || 0);
                    grouped[key].bull_score = Math.max(grouped[key].bull_score || 0, r.bull_score || 0);
                    grouped[key].bear_score = Math.max(grouped[key].bear_score || 0, r.bear_score || 0);
                    grouped[key].rvol = Math.max(grouped[key].rvol || 0, r.rvol || 0);
                    // Keep squeeze/capitulation data if present
                    if (r.squeeze_score) grouped[key].squeeze_score = Math.max(grouped[key].squeeze_score || 0, r.squeeze_score);
                    if (r.capitulation_level) grouped[key].capitulation_level = r.capitulation_level;
                    if (r.extension_pct) grouped[key].extension_pct = r.extension_pct;
                }
            });
            
            // Convert back to array
            allResults = Object.values(grouped);
            
            // Sort by confluence count FIRST, then by confidence
            allResults.sort((a, b) => {
                // Multi-signal stocks rise to top
                if (b.confluenceCount !== a.confluenceCount) {
                    return b.confluenceCount - a.confluenceCount;
                }
                // Then by confidence
                return (b.confidence || 0) - (a.confidence || 0);
            });
            
            // Auto-generate report for top results (background)
            if (allResults.length > 0 && autoReportEnabled) {
                generateAutoReport(allResults);
            }
            
            displayResults();
        }
        
        // Auto-report toggle state
        let autoReportEnabled = true;
        
        async function generateAutoReport(results) {
            console.log('ðŸ“ generateAutoReport called with', results.length, 'results');
            console.log('ðŸ“ window.db:', window.db);
            console.log('ðŸ“ window.currentUser:', window.currentUser?.email);
            
            // Save reports directly to Firestore from frontend (bypasses backend service account issue)
            if (!window.db) {
                console.warn('âŒ Firestore not available for reports');
                return;
            }
            
            if (!window.currentUser) {
                console.warn('âŒ User not logged in - reports not saved');
                return;
            }
            
            try {
                const dateStr = new Date().toISOString().split('T')[0];
                const timestamp = new Date().toISOString();
                let savedCount = 0;
                
                // Sort by score and take top performers
                const sorted = [...results].sort((a, b) => {
                    const aScore = Math.max(a.bull_score || 0, a.bear_score || 0);
                    const bScore = Math.max(b.bull_score || 0, b.bear_score || 0);
                    return bScore - aScore;
                });
                
                console.log('ðŸ“ Top result:', sorted[0]?.symbol, 'score:', Math.max(sorted[0]?.bull_score || 0, sorted[0]?.bear_score || 0));
                
                // Save top 10 with score >= 55
                for (const result of sorted.slice(0, 10)) {
                    const maxScore = Math.max(result.bull_score || 0, result.bear_score || 0);
                    if (maxScore < 55) continue;
                    
                    const direction = (result.bull_score || 0) > (result.bear_score || 0) ? 'LONG' : 'SHORT';
                    const report = {
                        symbol: result.symbol,
                        date: dateStr,
                        created_at: timestamp,
                        type: 'scan_analysis',
                        direction: direction,
                        bull_score: result.bull_score || 0,
                        bear_score: result.bear_score || 0,
                        confidence: result.confidence || 0,
                        price: result.current_price || result.price || 0,
                        vah: result.vah || 0,
                        poc: result.poc || 0,
                        val: result.val || 0,
                        vwap: result.vwap || 0,
                        rsi: result.rsi || 50,
                        rvol: result.rvol || 1,
                        notes: result.notes || [],
                        timeframe: document.getElementById('timeframe')?.value || '1HR',
                        user_id: window.currentUser?.uid || 'anonymous'
                    };
                    
                    await window.db.collection('reports').add(report);
                    savedCount++;
                }
                
                if (savedCount > 0) {
                    console.log(`ðŸ“ Saved ${savedCount} reports to Firestore`);
                    showReportNotification({ count: savedCount });
                }
            } catch (e) {
                console.warn('Auto-report save failed:', e);
            }
        }
        
        function showReportNotification(data) {
            // Create subtle toast notification
            const toast = document.createElement('div');
            toast.className = 'report-toast';
            toast.innerHTML = `
                <span>ðŸ“ ${data.count || 0} reports saved to Firestore</span>
                <button onclick="this.parentElement.remove()">Ã—</button>
            `;
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => toast.remove(), 5000);
        }
        
        function displayResults(filter = 'all') {
            const list = document.getElementById('result-list');
            const count = document.getElementById('results-count');
            currentDirectionFilter = filter;
            
            // Get filter values
            minScoreFilter = parseInt(document.getElementById('min-score-filter')?.value || 0);
            sortBy = document.getElementById('sort-by')?.value || 'score';
            
            // Filter by direction
            let filtered = allResults;
            if (filter === 'long') {
                filtered = allResults.filter(r => r.direction === 'long');
            } else if (filter === 'short') {
                filtered = allResults.filter(r => r.direction === 'short');
            }
            
            // Filter by minimum score
            if (minScoreFilter > 0) {
                filtered = filtered.filter(r => {
                    const maxScore = Math.max(r.bull_score || 0, r.bear_score || 0);
                    return maxScore >= minScoreFilter;
                });
            }
            
            // Sort results
            if (sortBy === 'confluence') {
                // Sort by confluence count first, then confidence
                filtered.sort((a, b) => {
                    if ((b.confluenceCount || 1) !== (a.confluenceCount || 1)) {
                        return (b.confluenceCount || 1) - (a.confluenceCount || 1);
                    }
                    return (b.confidence || 0) - (a.confidence || 0);
                });
            } else if (sortBy === 'score') {
                filtered.sort((a, b) => {
                    const aMax = Math.max(a.bull_score || 0, a.bear_score || 0);
                    const bMax = Math.max(b.bull_score || 0, b.bear_score || 0);
                    return bMax - aMax;
                });
            } else if (sortBy === 'confidence') {
                filtered.sort((a, b) => b.confidence - a.confidence);
            } else if (sortBy === 'rvol') {
                filtered.sort((a, b) => (b.rvol || 0) - (a.rvol || 0));
            } else if (sortBy === 'symbol') {
                filtered.sort((a, b) => a.symbol.localeCompare(b.symbol));
            }
            
            count.textContent = `${filtered.length} Results`;
            
            // Update filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase().includes(filter) || (filter === 'all' && tab.textContent === 'All'));
            });
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ðŸ”</div>
                        <p>No signals found. Try a different universe or scan type.</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filtered.map(r => {
                const bullScore = r.bull_score || 0;
                const bearScore = r.bear_score || 0;
                const maxScore = Math.max(bullScore, bearScore);
                
                // Direction should be explicit from scan, not recalculated from scores
                // This prevents confusion when extension/capitulation direction differs from bull/bear scores
                const isLong = r.direction === 'long';
                const isShort = r.direction === 'short';
                
                // Emoji: green/red for tradeable, yellow arrow for low score or neutral
                let emoji, dirClass;
                if (isLong) {
                    emoji = 'ðŸŸ¢';
                    dirClass = 'long';
                } else if (isShort) {
                    emoji = 'ðŸ”´';
                    dirClass = 'short';
                } else if (maxScore < 50) {
                    // Neutral with low score
                    emoji = bullScore > bearScore ? 'ðŸ”¼' : bearScore > bullScore ? 'ðŸ”½' : 'ðŸŸ¡';
                    dirClass = 'neutral';
                } else {
                    // Neutral but has scores - show direction hint
                    emoji = bullScore > bearScore ? 'ðŸŸ¢' : bearScore > bullScore ? 'ðŸ”´' : 'ðŸŸ¡';
                    dirClass = bullScore > bearScore ? 'long' : bearScore > bullScore ? 'short' : 'neutral';
                }
                
                // RVOL badge
                let rvolBadge = '';
                if (r.rvol >= 2.0) {
                    rvolBadge = `<span class="badge rvol-high">ðŸ”¥ ${r.rvol.toFixed(1)}x Vol</span>`;
                } else if (r.rvol >= 1.5) {
                    rvolBadge = `<span class="badge rvol-good">ðŸ“ˆ ${r.rvol.toFixed(1)}x Vol</span>`;
                } else if (r.rvol <= 0.5 && r.type !== 'squeeze') {
                    rvolBadge = `<span class="badge rvol-low">âš ï¸ ${r.rvol.toFixed(1)}x Vol</span>`;
                }
                
                // Squeeze score badge (only for squeeze type) - ENHANCED
                let squeezeBadge = '';
                if (r.type === 'squeeze' && r.squeeze_score) {
                    // Tier-based emoji
                    let tierEmoji = 'ðŸŽ¯';
                    let tierClass = 'squeeze-forming';
                    if (r.squeeze_tier === 'EXTREME') {
                        tierEmoji = 'ðŸ’¥';
                        tierClass = 'squeeze-extreme';
                    } else if (r.squeeze_tier === 'ACTIVE') {
                        tierEmoji = 'ðŸŽ¯';
                        tierClass = 'squeeze-active';
                    } else {
                        tierEmoji = 'ðŸŽ°';
                    }
                    
                    // TTM indicator
                    const ttmLabel = r.ttm_squeeze ? ' [TTM]' : '';
                    
                    // Duration if in squeeze
                    const durationLabel = r.squeeze_duration > 0 ? ` ${r.squeeze_duration}d` : '';
                    
                    // Direction bias
                    let biasLabel = '';
                    if (r.bias_score >= 30) {
                        if (r.direction_bias === 'long') biasLabel = ' â¬†ï¸';
                        else if (r.direction_bias === 'short') biasLabel = ' â¬‡ï¸';
                    }
                    
                    squeezeBadge = `<span class="badge ${tierClass}">${tierEmoji} ${r.squeeze_score}pt${ttmLabel}${durationLabel}${biasLabel}</span>`;
                }
                
                // Compression badge (only for compression type)
                let compressionBadge = '';
                if (r.type === 'compression') {
                    const atVal = r.at_val ? 'âœ… At VAL' : 'ðŸ“ Near VAL';
                    const candle = r.reversal_candle ? 'ðŸ•¯ï¸' : '';
                    compressionBadge = `<span class="badge compression-score">${atVal} ${candle}</span>`;
                }
                
                // Capitulation badge (only for capitulation type)
                let capitulationBadge = '';
                if (r.type === 'capitulation') {
                    const levelClass = r.capitulation_level === 'EXHAUSTION' ? 'capitulation-exhaustion' : 'capitulation-score';
                    const signals = [];
                    if (r.volume_exhaustion) signals.push('Vol Dry');
                    if (r.rsi_divergence) signals.push('Div');
                    if (r.reversal_candle) signals.push('ðŸ•¯ï¸');
                    const signalStr = signals.length > 0 ? signals.join(' ') : `RSI ${r.rsi?.toFixed(0)}`;
                    capitulationBadge = `<span class="badge ${levelClass}">ðŸ’€ ${signalStr}</span>`;
                }
                
                // Score badge styling (bullScore, bearScore, maxScore already defined above)
                let scoreColor = maxScore >= 70 ? 'score-high' : maxScore >= 50 ? 'score-med' : 'score-low';
                let scoreLabel = bullScore > bearScore ? `ðŸ‚ ${maxScore.toFixed(0)}` : bearScore > bullScore ? `ðŸ» ${maxScore.toFixed(0)}` : `âš–ï¸ ${maxScore.toFixed(0)}`;
                
                // CONFLUENCE BADGES - Show how many scans triggered
                let confluenceBadge = '';
                let scanBadges = '';
                const confluenceCount = r.confluenceCount || 1;
                const scans = r.scans || [r.type];
                
                if (confluenceCount >= 3) {
                    confluenceBadge = `<span class="badge confluence-multi">ðŸ”¥ ${confluenceCount}x MULTI-SIGNAL</span>`;
                } else if (confluenceCount === 2) {
                    confluenceBadge = `<span class="badge confluence-double">âš¡ 2x CONFLUENCE</span>`;
                }
                
                // Show individual scan type badges
                const scanEmojis = {
                    'bullish': 'ðŸŸ¢ Bull',
                    'bearish': 'ðŸ”´ Bear',
                    'entry': 'ðŸŽ¯ Entry',
                    'squeeze': 'ðŸ’¥ Squeeze',
                    'extension': 'ðŸ“ Ext',
                    'compression': 'ðŸ—œï¸ Comp',
                    'capitulation': 'ðŸ’€ Cap',
                    'highVolume': 'ðŸ”¥ Vol',
                    'atLevels': 'ðŸ“ Levels'
                };
                
                if (confluenceCount > 1) {
                    scanBadges = scans.map(s => `<span class="badge scan-type">${scanEmojis[s] || s}</span>`).join('');
                }
                
                // Score badge class for new style
                let scoreBadgeClass = maxScore >= 70 ? 'high' : maxScore >= 50 ? 'med' : 'low';
                
                // Fib position badge - show if available
                let fibBadge = '';
                if (r.fib_position) {
                    // Determine color based on fib position text
                    let fibClass = 'fib-neutral';
                    const fibText = r.fib_position.toLowerCase();
                    if (fibText.includes('golden zone') || fibText.includes('best')) {
                        fibClass = 'fib-golden';
                    } else if (fibText.includes('strong') || fibText.includes('healthy')) {
                        fibClass = 'fib-good';
                    } else if (fibText.includes('broken') || fibText.includes('reversing') || fibText.includes('extended')) {
                        fibClass = 'fib-warning';
                    }
                    // Shorten the display text
                    let shortFib = r.fib_position.replace(/\(.*\)/g, '').trim();
                    if (shortFib.length > 30) shortFib = shortFib.substring(0, 30) + '...';
                    fibBadge = `<span class="badge ${fibClass}" title="${r.fib_position}">ðŸ“ ${shortFib}</span>`;
                }
                
                return `
                    <div class="result-item ${dirClass} ${confluenceCount >= 3 ? 'multi-signal' : confluenceCount === 2 ? 'double-confluence' : ''}" onclick="getAIPlan('${r.symbol}', '${r.direction}', '${r.signal_type || ''}')">
                        <div class="result-top">
                            <div>
                                <div class="result-symbol">${emoji} ${r.symbol}</div>
                                <div class="result-signal ${dirClass}">${r.signal}</div>
                            </div>
                            <span class="result-score-badge ${scoreBadgeClass}">${scoreLabel}</span>
                        </div>
                        
                        <div class="result-metrics">
                            <div class="result-metric">
                                <span class="label">Confidence</span>
                                <span class="value">${r.confidence.toFixed(0)}%</span>
                            </div>
                            <div class="result-metric">
                                <span class="label">Bull / Bear</span>
                                <span class="value ${bullScore > bearScore ? 'green' : bearScore > bullScore ? 'red' : ''}">${bullScore.toFixed(0)} / ${bearScore.toFixed(0)}</span>
                            </div>
                            ${r.rvol ? `<div class="result-metric">
                                <span class="label">RVOL</span>
                                <span class="value ${r.rvol >= 2 ? 'red' : r.rvol >= 1.5 ? 'yellow' : ''}">${r.rvol.toFixed(1)}x</span>
                            </div>` : ''}
                        </div>
                        
                        <div class="result-badges">
                            ${confluenceBadge}
                            ${scanBadges ? scanBadges : ''}
                            ${fibBadge}
                            ${squeezeBadge}
                            ${compressionBadge}
                            ${capitulationBadge}
                        </div>
                        
                        <button class="result-action-btn" onclick="event.stopPropagation(); getAIPlan('${r.symbol}', '${r.direction}', '${r.signal_type || ''}')">ðŸ“ Get Trade Plan</button>
                    </div>
                `;
            }).join('');
        }
        
        function filterResults(filter) {
            displayResults(filter);
        }
        
        function applyFilters() {
            displayResults(currentDirectionFilter);
        }
        
        async function showDetails(symbol, data) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            // Determine CURRENT TREND from bull/bear scores
            const bullScore = data.bull_score || 0;
            const bearScore = data.bear_score || 0;
            let trendEmoji, trendColor, trendText;
            if (bullScore > bearScore + 5) {
                trendEmoji = 'ðŸŸ¢';
                trendColor = 'green';
                trendText = 'BULLISH';
            } else if (bearScore > bullScore + 5) {
                trendEmoji = 'ðŸ”´';
                trendColor = 'red';
                trendText = 'BEARISH';
            } else {
                trendEmoji = 'ðŸŸ¡';
                trendColor = 'yellow';
                trendText = 'NEUTRAL';
            }
            
            // Determine TRADE SETUP from multiple sources:
            // 1. Explicit direction from scan
            // 2. Entry/stop relationship (if stop > entry = SHORT, if stop < entry = LONG)
            // 3. Signal text analysis
            let setupEmoji, setupColor, setupText, hasConflict = false;
            
            // Check entry/stop relationship for direction
            let inferredDirection = data.direction;
            if (!inferredDirection && data.entry_price && data.stop_price) {
                inferredDirection = data.stop_price > data.entry_price ? 'short' : 'long';
            }
            // Also check signal text for hints
            if (!inferredDirection && data.signal) {
                const sigLower = data.signal.toLowerCase();
                if (sigLower.includes('rejection') || sigLower.includes('short') || sigLower.includes('bear')) {
                    inferredDirection = 'short';
                } else if (sigLower.includes('bounce') || sigLower.includes('long') || sigLower.includes('bull')) {
                    inferredDirection = 'long';
                }
            }
            
            if (inferredDirection === 'short') {
                setupEmoji = 'ðŸ”´';
                setupColor = 'red';
                setupText = 'SHORT';
                // Check if trend conflicts with setup OR if trend is neutral but we have a directional trade
                if (bullScore > bearScore + 5) {
                    hasConflict = true;
                } else if (trendText === 'NEUTRAL') {
                    hasConflict = true; // Show hybrid for neutral trend with directional setup
                }
            } else if (inferredDirection === 'long') {
                setupEmoji = 'ðŸŸ¢';
                setupColor = 'green';
                setupText = 'LONG';
                if (bearScore > bullScore + 5) {
                    hasConflict = true;
                } else if (trendText === 'NEUTRAL') {
                    hasConflict = true; // Show hybrid for neutral trend with directional setup
                }
            } else {
                setupEmoji = trendEmoji;
                setupColor = trendColor;
                setupText = trendText;
            }
            
            // Build hybrid bias display
            let biasHTML = '';
            if (hasConflict) {
                // Determine trade type label based on context
                let tradeTypeLabel = setupText;
                if (trendText === 'BULLISH' && setupText === 'SHORT') {
                    tradeTypeLabel = 'SHORT (Pullback)';
                } else if (trendText === 'BEARISH' && setupText === 'LONG') {
                    tradeTypeLabel = 'LONG (Bounce)';
                } else if (trendText === 'NEUTRAL') {
                    tradeTypeLabel = setupText + ' ENTRY';
                }
                
                // Show BOTH trend and setup
                biasHTML = `
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; flex: 1;">
                            <div style="font-size: 0.7rem; color: var(--text-gray); text-transform: uppercase; margin-bottom: 0.25rem;">Current Trend</div>
                            <div style="font-size: 1.5rem;">${trendEmoji}</div>
                            <div style="font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--${trendColor});">${trendText}</div>
                        </div>
                        <div style="display: flex; align-items: center; color: var(--text-gray);">â†’</div>
                        <div style="text-align: center; padding: 0.75rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid var(--${setupColor}); border-radius: 8px; flex: 1;">
                            <div style="font-size: 0.7rem; color: var(--${setupColor}); text-transform: uppercase; margin-bottom: 0.25rem;">Trade Setup</div>
                            <div style="font-size: 1.5rem;">${setupEmoji}</div>
                            <div style="font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: var(--${setupColor});">${tradeTypeLabel}</div>
                        </div>
                    </div>
                    ${trendText !== 'NEUTRAL' ? `
                    <div style="background: rgba(255,200,0,0.15); border: 1px solid var(--yellow); border-radius: 8px; padding: 0.5rem; margin-bottom: 1rem; text-align: center; font-size: 0.8rem;">
                        âš ï¸ <strong>Counter-Trend Trade</strong> - ${trendText} trend but ${setupText.toLowerCase()} setup
                    </div>
                    ` : ''}
                `;
            } else {
                // Normal display when trend matches setup (or no conflict)
                // Add clear direction label
                let dirLabel = '';
                if (inferredDirection === 'short') {
                    dirLabel = `<div style="background: rgba(255,71,87,0.2); color: var(--red); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; margin-top: 0.5rem;">â¬‡ï¸ SHORT TRADE</div>`;
                } else if (inferredDirection === 'long') {
                    dirLabel = `<div style="background: rgba(0,255,136,0.2); color: var(--green); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; margin-top: 0.5rem;">â¬†ï¸ LONG TRADE</div>`;
                }
                
                biasHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.25rem;">${setupEmoji}</div>
                        <div style="font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--${setupColor});">${data.signal || setupText}</div>
                        ${dirLabel}
                    </div>
                `;
            }
            
            // RVOL badge - ensure we show at least 0.1x (avoid 0.0x display)
            const rvol = Math.max(data.rvol || 1.0, 0.01);
            let rvolBadge = '';
            if (rvol >= 2.0) {
                rvolBadge = `<span style="background: rgba(255,59,92,0.3); color: var(--red); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 700;">ðŸ”¥ ${rvol.toFixed(1)}x Vol</span>`;
            } else if (rvol >= 1.5) {
                rvolBadge = `<span style="background: rgba(0,245,212,0.2); color: var(--cyan); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: 700;">ðŸ“ˆ ${rvol.toFixed(1)}x Vol</span>`;
            } else if (rvol < 0.5) {
                rvolBadge = `<span style="background: rgba(255,200,0,0.2); color: var(--yellow); padding: 4px 8px; border-radius: 6px; font-size: 0.85rem;">âš ï¸ ${rvol < 0.1 ? '<0.1' : rvol.toFixed(1)}x Vol</span>`;
            }
            
            modal.innerHTML = `
                <div class="modal wide">
                    <div class="modal-header">
                        <div class="modal-title">${setupEmoji} ${symbol} <span style="font-size: 0.7rem; color: var(--text-gray);">${currentLevel.toUpperCase()} MODE</span></div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="account-settings">
                            <label>
                                ðŸ’° Account:
                                <input type="text" id="account-size-input" value="${getAccountSize()}" onchange="saveAccountSize(this.value)" placeholder="$10,000">
                            </label>
                            <label>
                                ðŸ“Š Risk:
                                <select id="risk-percent-input" onchange="saveRiskPercent(this.value)">
                                    <option value="0.5" ${getRiskPercent() == 0.5 ? 'selected' : ''}>0.5%</option>
                                    <option value="1" ${getRiskPercent() == 1 ? 'selected' : ''}>1%</option>
                                    <option value="1.5" ${getRiskPercent() == 1.5 ? 'selected' : ''}>1.5%</option>
                                    <option value="2" ${getRiskPercent() == 2 ? 'selected' : ''}>2%</option>
                                </select>
                            </label>
                            <span style="color: var(--cyan); font-weight: 600;">1R = $${calculateOneR().toFixed(0)}</span>
                        </div>
                        <div class="side-by-side-container">
                            <!-- LEFT: Analysis Data -->
                            <div class="analysis-panel">
                                ${biasHTML}
                                <div style="text-align: center; margin-bottom: 0.5rem;">${rvolBadge}</div>
                                
                                <div class="score-display" style="margin: 1rem 0;">
                                    <div class="score-box bull" style="padding: 0.5rem 1rem;">
                                        <div class="score-number" style="color: var(--green); font-size: 1.5rem;">${bullScore}</div>
                                        <div class="score-label">Bull</div>
                                    </div>
                                    <div class="score-box bear" style="padding: 0.5rem 1rem;">
                                        <div class="score-number" style="color: var(--red); font-size: 1.5rem;">${bearScore}</div>
                                        <div class="score-label">Bear</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 1rem;">
                                    <div class="level-row">
                                        <span class="level-label">Confidence</span>
                                        <span class="level-value cyan">${data.confidence?.toFixed(0) || 0}%</span>
                                    </div>
                                    <div class="level-row">
                                        <span class="level-label">Current Price</span>
                                        <span class="level-value">$${data.current_price?.toFixed(2) || '-'}</span>
                                    </div>
                                    ${data.vah ? `
                                    <div class="level-row">
                                        <span class="level-label">VAH (Resistance)</span>
                                        <span class="level-value red">$${data.vah?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                    ${data.poc ? `
                                    <div class="level-row">
                                        <span class="level-label">POC (Fair Value)</span>
                                        <span class="level-value cyan">$${data.poc?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                    ${data.val ? `
                                    <div class="level-row">
                                        <span class="level-label">VAL (Support)</span>
                                        <span class="level-value green">$${data.val?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                    ${data.rsi ? `
                                    <div class="level-row">
                                        <span class="level-label">RSI (14)</span>
                                        <span class="level-value ${data.rsi > 70 ? 'red' : data.rsi < 30 ? 'green' : 'cyan'}">${data.rsi?.toFixed(1)} ${data.rsi > 70 ? 'âš ï¸ OB' : data.rsi < 30 ? 'âš ï¸ OS' : ''}</span>
                                    </div>
                                    ` : ''}
                                    ${data.entry_price ? `
                                    <div class="level-row">
                                        <span class="level-label">Entry Price</span>
                                        <span class="level-value cyan">$${data.entry_price?.toFixed(2)}</span>
                                    </div>
                                    <div class="level-row">
                                        <span class="level-label">Stop Loss</span>
                                        <span class="level-value red">$${data.stop_price?.toFixed(2)}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- RIGHT: AI Cards -->
                            <div class="ai-panel">
                                <div class="loading"><div class="spinner"></div>Loading AI analysis...</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="action-btn secondary" style="flex:1;" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').appendChild(modal);
            
            // Auto-load AI analysis - pass scanner context so AI knows the setup
            try {
                // Build entry_signal from scan data so AI respects the detected setup
                let entrySignal = '';
                if (inferredDirection && data.signal) {
                    // Format: "signal_type:direction" e.g. "vah_touch_rejection:short"
                    const signalType = data.signal.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
                    entrySignal = `${signalType}:${inferredDirection}`;
                } else if (inferredDirection) {
                    entrySignal = `entry:${inferredDirection}`;
                }
                
                let aiUrl = `${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`;
                if (entrySignal) {
                    aiUrl += `&entry_signal=${encodeURIComponent(entrySignal)}`;
                }
                
                const aiData = await fetchJson(aiUrl);
                const aiText = aiData.ai_commentary || '';
                const parsed = parseAIResponse(aiText, aiData);
                
                modal.querySelector('.ai-panel').innerHTML = buildAICardsHTML(parsed, symbol, aiData);
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
            } catch (e) {
                modal.querySelector('.ai-panel').innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 2rem;">
                        <div style="font-size: 2rem;">âŒ</div>
                        <p>Could not load AI analysis</p>
                    </div>
                `;
            }
        }
        
        async function loadAIExplanation(btn, symbol, direction) {
            btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;display:inline-block;margin-right:8px;"></div> Loading AI...';
            btn.disabled = true;
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`);
                
                const aiText = data.ai_commentary || '';
                const parsed = parseAIResponse(aiText, data);
                
                const responseDiv = document.getElementById(`ai-response-${symbol}`);
                responseDiv.style.display = 'block';
                responseDiv.innerHTML = buildAICardsHTML(parsed, symbol, data);
                
                // Apply beginner preset by default
                setTimeout(() => setAIPreset('beginner'), 50);
                
                btn.innerHTML = 'âœ… AI Loaded';
                btn.style.background = 'rgba(0,255,136,0.2)';
                btn.style.borderColor = 'var(--green)';
            } catch (e) {
                btn.innerHTML = 'âŒ Error loading AI';
                btn.disabled = false;
            }
        }
        
        async function getAIPlan(symbol, direction, signalType = '', existingModal = null) {
            // Get the scanner data for this symbol from allResults
            const scanData = allResults.find(r => r.symbol === symbol);
            if (!scanData) {
                alert('No scanner data found for ' + symbol);
                return;
            }
            
            // Reuse existing modal if passed (from quickAnalyze), otherwise create new one
            let modal = existingModal;
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="trade-plan-modal" style="background: #f8f8f8; max-width: 980px; margin: 2rem auto; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 24px rgba(0,0,0,0.08); font-family: 'Inter', -apple-system, sans-serif;">
                        <div class="trade-plan-content" style="padding: 0; background: #f8f8f8;">
                            <div style="background: #fff; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
                                <div style="color: #222; font-weight: 600;">ðŸ“ Loading ${symbol} Trade Plan...</div>
                                <button style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer;" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                            </div>
                            <div class="loading" style="padding: 3rem;"><div class="spinner"></div>Generating trade plan from YOUR rules...</div>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            }
            
            try {
                // Fetch past reports for this symbol from Firestore to give AI context
                let pastReports = [];
                if (window.db && window.currentUser) {
                    try {
                        const snapshot = await window.db.collection('reports')
                            .where('symbol', '==', scanData.symbol)
                            .where('user_id', '==', window.currentUser.uid)
                            .orderBy('created_at', 'desc')
                            .limit(5)
                            .get();
                        
                        pastReports = snapshot.docs.map(doc => doc.data());
                        console.log(`ðŸ“š Found ${pastReports.length} past reports for ${scanData.symbol}`);
                    } catch (e) {
                        console.warn('Could not fetch past reports:', e);
                    }
                }
                
                // Call the rule engine API with past report context
                // Ensure required VP levels are present
                const reqPrice = scanData.current_price || 0;
                const reqVah = scanData.vah || reqPrice * 1.01;  // Default 1% above if missing
                const reqPoc = scanData.poc || reqPrice;
                const reqVal = scanData.val || reqPrice * 0.99;  // Default 1% below if missing
                
                const response = await fetch(`${API_BASE}/api/rules/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: scanData.symbol,
                        current_price: reqPrice,
                        vah: reqVah,
                        poc: reqPoc,
                        val: reqVal,
                        vwap: scanData.vwap || reqPoc,
                        bull_score: scanData.bull_score || 0,
                        bear_score: scanData.bear_score || 0,
                        rsi: scanData.rsi || 50,
                        rvol: scanData.rvol || 1.0,
                        confidence: scanData.confidence || 50,
                        past_reports: pastReports,
                        // EXPLICIT direction from scan (extension, capitulation, etc.)
                        scan_direction: scanData.direction || null,
                        // Squeeze data (if present)
                        squeeze_score: scanData.squeeze_score || null,
                        squeeze_tier: scanData.squeeze_tier || null,
                        ttm_squeeze: scanData.ttm_squeeze || null,
                        squeeze_duration: scanData.squeeze_duration || null,
                        atr_compression: scanData.atr_compression || null,
                        adx: scanData.adx || null,
                        direction_bias: scanData.direction_bias || null,
                        bias_score: scanData.bias_score || null,
                        price_drift: scanData.price_drift || null,
                        volume_bias: scanData.volume_bias || null,
                        scan_type: scanData.type || null,
                        timeframe: selectedTimeframe || '1HR',
                        // Fibonacci data
                        fib_zone: scanData.fib_zone || null,
                        fib_quality: scanData.fib_quality || null,
                        fib_trend: scanData.fib_trend || null,
                        fib_position: scanData.fib_position || null,
                        fib_confluence: scanData.fib_confluence || null,
                        fib_levels: scanData.fib_levels || null
                    })
                });
                
                if (!response.ok) {
                    const errText = await response.text();
                    console.error('Rule engine API error:', response.status, errText);
                    throw new Error(`API error ${response.status}: ${errText.substring(0, 100)}`);
                }
                const plan = await response.json();
                
                // Merge scanner levels into plan (in case backend doesn't return them)
                plan.current_price = plan.current_price || scanData.current_price;
                plan.vah = plan.vah || scanData.vah;
                plan.poc = plan.poc || scanData.poc;
                plan.val = plan.val || scanData.val;
                plan.vwap = plan.vwap || scanData.vwap;
                plan.rsi = scanData.rsi || 50;
                // Handle rvol: 0 or near-0 means no data (weekend/after hours), treat as 1.0
                const rawRvol = scanData.rvol || 0;
                plan.rvol = rawRvol < 0.01 ? 1.0 : rawRvol;
                
                // Merge order flow data from scan results into plan
                const orderFlow = scanData.order_flow;
                if (orderFlow) {
                    plan.flow_bias = orderFlow.flow_bias || plan.flow_bias;
                    plan.buy_pct = orderFlow.buy_pressure ?? plan.buy_pct;
                    plan.sell_pct = orderFlow.sell_pressure ?? plan.sell_pct;
                    plan.flow_bars = orderFlow.total_bars_analyzed ?? plan.flow_bars;
                    plan.hi_volume_bars = orderFlow.high_volume_bars ?? plan.hi_volume_bars;
                    const buys = orderFlow.buy_candles || 0;
                    const sells = orderFlow.sell_candles || 0;
                    plan.gr_ratio = `${buys}/${sells}`;
                    plan.momentum = orderFlow.momentum || plan.momentum;
                }
                // Store OHLC from scan data
                plan.open = scanData.day_open || plan.open;
                plan.high = scanData.day_high || plan.high;
                plan.low = scanData.day_low || plan.low;
                plan.prev_close = scanData.prev_close || plan.prev_close;
                
                // Build the plan display
                modal.querySelector('.trade-plan-content').innerHTML = buildRulePlanHTML(plan);
                
            } catch (e) {
                // Show light-themed error message
                console.warn('Rule engine error:', e);
                modal.querySelector('.trade-plan-content').innerHTML = `
                    <div style="background: #fff; border-radius: 12px; margin: 1rem; padding: 2rem; text-align: center; border: 1px solid #e5e5e5;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                        <h3 style="color: #222; margin: 0 0 0.5rem 0; font-weight: 600;">Could Not Generate Trade Plan</h3>
                        <p style="color: #6b7280; margin: 0 0 1rem 0;">The rule engine encountered an issue. Please try again.</p>
                        <p style="color: #9ca3af; font-size: 0.875rem;">Error: ${e.message}</p>
                        <button onclick="this.closest('.modal-overlay').remove()" style="margin-top: 1rem; padding: 0.5rem 1.5rem; background: #2563eb; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Close</button>
                    </div>
                `;
            }
        }
        
        function buildRulePlanHTML(plan) {
            const isLong = plan.direction === 'LONG';
            const isShort = plan.direction === 'SHORT';
            const isNoTrade = plan.direction === 'NO_TRADE';
            
            const currentPrice = plan.current_price || plan.entry_price || 0;
            const prevClose = plan.prev_close || currentPrice;
            const change = currentPrice - prevClose;
            const changePct = prevClose > 0 ? (change / prevClose * 100) : 0;
            const isUp = change >= 0;
            
            // OHLC values
            const ohlcOpen = plan.open || currentPrice;
            const ohlcHigh = plan.high || currentPrice;
            const ohlcLow = plan.low || currentPrice;
            
            // Risk calculation
            const storedAccount = localStorage.getItem('accountSize') || '25000';
            const storedRisk = localStorage.getItem('riskPct') || '1.5';
            const riskDollars = parseFloat(storedAccount) * parseFloat(storedRisk) / 100;
            const shares = plan.risk_per_share > 0 ? Math.floor(riskDollars / plan.risk_per_share) : 0;
            
            // Key level (prefer POC or entry)
            const keyLevel = plan.poc || plan.entry_price || currentPrice;
            
            // Earnings info (if available) - show for 0+ days (upcoming earnings within 14 days)
            const hasUpcomingEarnings = plan.earnings_days !== null && plan.earnings_days !== undefined && plan.earnings_days >= 0 && plan.earnings_days <= 14;
            const earningsText = plan.earnings_days === 0 ? 'Earnings TODAY' : `Earnings in ${plan.earnings_days} days`;
            const earningsHTML = hasUpcomingEarnings ? `
                <div class="earnings-banner" style="background: #fffbeb; border: 1px solid #fde68a; border-left: 4px solid #f59e0b; color: #92400e; display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <span class="icon">ðŸ“…</span>
                    <span class="text" style="color: #92400e; font-weight: 600;">${earningsText}</span>
                    <span class="date" style="color: #b45309;">(${plan.earnings_date || 'TBD'})</span>
                    <span class="note" style="color: #a3a3a3; margin-left: auto; font-size: 0.75rem;">Watch IV levels â€” compression may be IV buildup</span>
                </div>
            ` : '';
            
            // Order Flow card (if we have flow data)
            const flowBias = plan.flow_bias || 'NEUTRAL';
            const flowBiasClass = flowBias === 'BULLISH' ? 'bullish' : flowBias === 'BEARISH' ? 'bearish' : 'neutral';
            const flowBiasBg = flowBias === 'BULLISH' ? '#dcfce7' : flowBias === 'BEARISH' ? '#fee2e2' : '#f3f4f6';
            const flowBiasColor = flowBias === 'BULLISH' ? '#16a34a' : flowBias === 'BEARISH' ? '#dc2626' : '#6b7280';
            const buyPct = plan.buy_pct || 50;
            const sellPct = plan.sell_pct || 50;
            const bars = plan.flow_bars || 30;
            const hiVol = plan.hi_volume_bars || 0;
            const grRatio = plan.gr_ratio || '1/1';
            const momentum = plan.momentum || 'MIXED';
            const momClass = momentum.includes('BUY') ? 'green' : momentum.includes('SELL') ? 'red' : 'default';
            const momColor = momentum.includes('BUY') ? '#16a34a' : momentum.includes('SELL') ? '#dc2626' : '#374151';
            
            const flowCardHTML = `
                <div class="flow-card" style="background: #fff; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; border: 1px solid #e5e5e5;">
                    <div class="flow-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span class="flow-title" style="font-weight: 600; font-size: 0.8rem; color: #3b82f6; text-transform: uppercase; letter-spacing: 0.5px;">ðŸ“Š Order Flow Analysis</span>
                        <span class="flow-bias" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600; font-size: 0.8rem; background: ${flowBiasBg}; color: ${flowBiasColor};">${flowBias}</span>
                    </div>
                    <div class="flow-metrics" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;">
                        <div class="flow-metric" style="display: flex; flex-direction: column; gap: 0.15rem; text-align: center;">
                            <span class="label" style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Buy %</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; color: #16a34a;">${buyPct.toFixed(1)}%</span>
                        </div>
                        <div class="flow-metric" style="display: flex; flex-direction: column; gap: 0.15rem; text-align: center;">
                            <span class="label" style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Sell %</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; color: #dc2626;">${sellPct.toFixed(1)}%</span>
                        </div>
                        <div class="flow-metric" style="display: flex; flex-direction: column; gap: 0.15rem; text-align: center;">
                            <span class="label" style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Bars</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; color: #374151;">${bars}</span>
                        </div>
                        <div class="flow-metric" style="display: flex; flex-direction: column; gap: 0.15rem; text-align: center;">
                            <span class="label" style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Hi-Volume</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; color: #d97706;">${hiVol}</span>
                        </div>
                        <div class="flow-metric" style="display: flex; flex-direction: column; gap: 0.15rem; text-align: center;">
                            <span class="label" style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">G/R Ratio</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; color: #374151;">${grRatio}</span>
                        </div>
                        <div class="flow-metric" style="display: flex; flex-direction: column; gap: 0.15rem; text-align: center;">
                            <span class="label" style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Momentum</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 600; color: ${momColor};">${momentum}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Build LONG setup card
            const longProb = plan.long_prob || (isLong ? plan.confidence : Math.max(30, 100 - (plan.confidence || 50))) || 50;
            const longEntryLow = isLong ? plan.entry_zone_low : (plan.poc || currentPrice * 0.99);
            const longEntryHigh = isLong ? plan.entry_zone_high : (plan.vah || currentPrice);
            const longStop = isLong ? plan.stop_loss : (plan.val || currentPrice * 0.98);
            const longT1 = isLong ? plan.target_1 : (plan.vah || currentPrice * 1.02);
            const longT2 = isLong ? plan.target_2 : (currentPrice * 1.03);
            // R:R from entry zone midpoint (conservative), not current price
            const longEntryMid = (longEntryLow + longEntryHigh) / 2;
            const longRiskPerShare = longEntryMid - longStop;  // positive when entry > stop
            const longRewardPerShare = longT1 - longEntryMid;  // positive when target > entry
            const longRR = (longRiskPerShare > 0 && longRewardPerShare > 0) ? (longRewardPerShare / longRiskPerShare).toFixed(1) : '0.0';
            const longEV = longRiskPerShare > 0 ? ((longProb/100) * longRewardPerShare - (1-longProb/100) * longRiskPerShare).toFixed(2) : '0.00';
            const longScore = Math.round(longProb);
            const longGrade = longScore >= 70 ? 'A' : longScore >= 55 ? 'B' : longScore >= 40 ? 'C' : 'D';
            // Aggressive long: only valid if price is above stop (won't be instantly stopped)
            const longAggValid = currentPrice > longStop;
            
            // Determine if price is IN the long entry zone
            const longInEntryZone = currentPrice >= longEntryLow && currentPrice <= longEntryHigh;
            
            // Determine if aggressive long is PRACTICAL (beyond just valid)
            // Aggressive is practical if: outside entry zone + (strong momentum OR near key level OR high confidence)
            const nearKeyLevel = plan.poc && Math.abs(currentPrice - plan.poc) / currentPrice < 0.01;  // within 1% of POC
            const strongBullMomentum = flowBias === 'BULLISH' || (plan.bull_score || 0) > (plan.bear_score || 0) + 15;
            const highConfidence = longProb >= 65;
            const longAggPractical = longAggValid && !longInEntryZone && (strongBullMomentum || nearKeyLevel || highConfidence);
            
            // Highlight logic for LONG: entry zone if in zone, aggressive if practical, neither if just valid
            const longHighlightAgg = longAggPractical;
            const longHighlightEntry = longInEntryZone;
            
            // Build SHORT setup card
            const shortProb = plan.short_prob || (isShort ? plan.confidence : Math.max(30, 100 - (plan.confidence || 50))) || 50;
            const shortEntryLow = isShort ? plan.entry_zone_low : (plan.poc || currentPrice);
            const shortEntryHigh = isShort ? plan.entry_zone_high : (plan.vah || currentPrice * 1.01);
            const shortStop = isShort ? plan.stop_loss : (plan.vah || currentPrice * 1.02);
            const shortT1 = isShort ? plan.target_1 : (plan.val || currentPrice * 0.98);
            const shortT2 = isShort ? plan.target_2 : (currentPrice * 0.97);
            // R:R from entry zone midpoint (conservative), not current price
            const shortEntryMid = (shortEntryLow + shortEntryHigh) / 2;
            const shortRiskPerShare = shortStop - shortEntryMid;  // positive when stop > entry
            const shortRewardPerShare = shortEntryMid - shortT1;  // positive when entry > target
            const shortRR = (shortRiskPerShare > 0 && shortRewardPerShare > 0) ? (shortRewardPerShare / shortRiskPerShare).toFixed(1) : '0.0';
            const shortEV = shortRiskPerShare > 0 ? ((shortProb/100) * shortRewardPerShare - (1-shortProb/100) * shortRiskPerShare).toFixed(2) : '0.00';
            const shortScore = Math.round(shortProb);
            const shortGrade = shortScore >= 70 ? 'A' : shortScore >= 55 ? 'B' : shortScore >= 40 ? 'C' : 'D';
            // Aggressive short: only valid if price is below stop (won't be instantly stopped)
            const shortAggValid = currentPrice < shortStop;
            
            // Determine if price is IN the short entry zone
            const shortInEntryZone = currentPrice >= shortEntryLow && currentPrice <= shortEntryHigh;
            
            // Determine if aggressive short is PRACTICAL (beyond just valid)
            const strongBearMomentum = flowBias === 'BEARISH' || (plan.bear_score || 0) > (plan.bull_score || 0) + 15;
            const highConfidenceShort = shortProb >= 65;
            const shortAggPractical = shortAggValid && !shortInEntryZone && (strongBearMomentum || nearKeyLevel || highConfidenceShort);
            
            // Highlight logic for SHORT: entry zone if in zone, aggressive if practical, neither if just valid
            const shortHighlightAgg = shortAggPractical;
            const shortHighlightEntry = shortInEntryZone;
            
            // Determine if we should hide weak setups (when score gap > 40 points or score < 30)
            const scoreGap = Math.abs(longScore - shortScore);
            const showLongSetup = scoreGap < 40 || longScore >= 30 || isLong;  // Always show if it's the primary direction
            const showShortSetup = scoreGap < 40 || shortScore >= 30 || isShort;  // Always show if it's the primary direction
            
            // Triggers
            const longTriggerValid = plan.entry_reasons && plan.entry_reasons.length > 0 && isLong
                ? plan.entry_reasons[0]
                : `Break above POC $${(plan.poc || currentPrice).toFixed(2)} with increasing volume`;
            const longTriggerInvalid = isLong && plan.invalidation 
                ? plan.invalidation 
                : `Break below $${longStop.toFixed(2)} invalidates`;
            const shortTriggerValid = plan.entry_reasons && plan.entry_reasons.length > 0 && isShort
                ? plan.entry_reasons[0]
                : `Fail below VAH $${(plan.vah || currentPrice).toFixed(2)} with bearish candle`;
            const shortTriggerInvalid = isShort && plan.invalidation 
                ? plan.invalidation 
                : `Close above $${shortStop.toFixed(2)} invalidates`;
            
            const setupsHTML = `
                <div class="setups-grid" style="display: grid; grid-template-columns: ${showLongSetup && showShortSetup ? '1fr 1fr' : '1fr'}; gap: 1rem; margin-bottom: 1.25rem;">
                    <!-- Long Setup -->
                    ${showLongSetup ? `
                    <div class="setup-card long" style="background: #fff; border-radius: 12px; padding: 1.25rem; border: 1px solid #e5e5e5; border-top: 4px solid #16a34a;">
                        <div class="setup-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                            <span class="setup-title" style="font-weight: 700; font-size: 0.9rem; color: #16a34a; display: flex; align-items: center; gap: 0.5rem;">
                                <span>â–²</span>
                                LONG SETUP
                            </span>
                            <span class="setup-badge" style="font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600; background: #dcfce7; color: #16a34a;">${longGrade} | ${longScore.toFixed(0)}/100</span>
                        </div>
                        
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Probability</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #0891b2;">${(longProb-5).toFixed(0)}-${(longProb+5).toFixed(0)}%</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem; ${longHighlightEntry ? 'background: linear-gradient(90deg, #dcfce7 0%, #f0fdf4 100%); margin: 0 -0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; border-left: 3px solid #16a34a;' : ''}">
                            <span class="label" style="color: ${longHighlightEntry ? '#166534' : '#9ca3af'}; font-weight: ${longHighlightEntry ? '600' : '400'};">ðŸ“ Entry Zone ${longHighlightEntry ? '(IN ZONE)' : ''}</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: ${longHighlightEntry ? '600' : '500'}; color: #16a34a;">$${longEntryLow.toFixed(2)} - $${longEntryHigh.toFixed(2)}</span>
                        </div>
                        
                        <div class="setup-agg" style="background: ${longHighlightAgg ? 'linear-gradient(90deg, #fef3c7 0%, #fffbeb 100%)' : longAggValid ? 'linear-gradient(90deg, #f9fafb 0%, #f3f4f6 100%)' : 'linear-gradient(90deg, #fafafa 0%, #f5f5f5 100%)'}; margin: 0.75rem -0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; ${longHighlightAgg ? 'border-left: 3px solid #f59e0b;' : ''}">
                            <span class="label" style="color: ${longHighlightAgg ? '#92400e' : longAggValid ? '#6b7280' : '#9ca3af'}; font-weight: ${longHighlightAgg ? '700' : '600'}; font-size: 0.8rem;">${longHighlightAgg ? 'âš¡ Aggressive Entry (PRACTICAL)' : longAggValid ? 'âš¡ Aggressive Entry' : 'â¸ Aggressive Entry'}</span>
                            <span class="value" style="color: ${longHighlightAgg ? '#92400e' : longAggValid ? '#6b7280' : '#9ca3af'}; font-family: 'JetBrains Mono', monospace; font-weight: ${longHighlightAgg ? '700' : '600'}; font-size: ${longAggValid ? '0.85rem' : '0.75rem'};">${longAggValid ? '$' + currentPrice.toFixed(2) + ' NOW' : 'WAIT â€” below stop'}</span>
                        </div>
                        
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Stop Loss</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #dc2626;">$${longStop.toFixed(2)}</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Target 1</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #16a34a;">$${longT1.toFixed(2)}</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Target 2</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #16a34a;">$${longT2.toFixed(2)}</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Risk:Reward</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #d97706;">${longRR}:1</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Expected Value</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #0891b2;">$${longEV}</span>
                        </div>
                        
                        <div class="setup-triggers" style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed #e5e5e5;">
                            <div class="trigger valid" style="display: flex; gap: 0.5rem; font-size: 0.8rem; margin-bottom: 0.35rem; color: #16a34a;">
                                <span class="icon">âœ“</span>
                                <span>${longTriggerValid}</span>
                            </div>
                            <div class="trigger invalid" style="display: flex; gap: 0.5rem; font-size: 0.8rem; margin-bottom: 0.35rem; color: #9ca3af;">
                                <span class="icon">âœ—</span>
                                <span>${longTriggerInvalid}</span>
                            </div>
                        </div>
                    </div>` : ''}
                    
                    <!-- Short Setup -->
                    ${showShortSetup ? `
                    <div class="setup-card short" style="background: #fff; border-radius: 12px; padding: 1.25rem; border: 1px solid #e5e5e5; border-top: 4px solid #dc2626;">
                        <div class="setup-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6;">
                            <span class="setup-title" style="font-weight: 700; font-size: 0.9rem; color: #dc2626; display: flex; align-items: center; gap: 0.5rem;">
                                <span>â–¼</span>
                                SHORT SETUP
                            </span>
                            <span class="setup-badge" style="font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600; background: #fee2e2; color: #dc2626;">${shortGrade} | ${shortScore.toFixed(0)}/100</span>
                        </div>
                        
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Probability</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #0891b2;">${(shortProb-5).toFixed(0)}-${(shortProb+5).toFixed(0)}%</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem; ${shortHighlightEntry ? 'background: linear-gradient(90deg, #fee2e2 0%, #fef2f2 100%); margin: 0 -0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; border-left: 3px solid #dc2626;' : ''}">
                            <span class="label" style="color: ${shortHighlightEntry ? '#991b1b' : '#9ca3af'}; font-weight: ${shortHighlightEntry ? '600' : '400'};">ðŸ“ Entry Zone ${shortHighlightEntry ? '(IN ZONE)' : ''}</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: ${shortHighlightEntry ? '600' : '500'}; color: #dc2626;">$${shortEntryLow.toFixed(2)} - $${shortEntryHigh.toFixed(2)}</span>
                        </div>
                        
                        <div class="setup-agg" style="background: ${shortHighlightAgg ? 'linear-gradient(90deg, #fef3c7 0%, #fffbeb 100%)' : shortAggValid ? 'linear-gradient(90deg, #f9fafb 0%, #f3f4f6 100%)' : 'linear-gradient(90deg, #fafafa 0%, #f5f5f5 100%)'}; margin: 0.75rem -0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; ${shortHighlightAgg ? 'border-left: 3px solid #f59e0b;' : ''}">
                            <span class="label" style="color: ${shortHighlightAgg ? '#92400e' : shortAggValid ? '#6b7280' : '#9ca3af'}; font-weight: ${shortHighlightAgg ? '700' : '600'}; font-size: 0.8rem;">${shortHighlightAgg ? 'âš¡ Aggressive Entry (PRACTICAL)' : shortAggValid ? 'âš¡ Aggressive Entry' : 'â¸ Aggressive Entry'}</span>
                            <span class="value" style="color: ${shortHighlightAgg ? '#92400e' : shortAggValid ? '#6b7280' : '#9ca3af'}; font-family: 'JetBrains Mono', monospace; font-weight: ${shortHighlightAgg ? '700' : '600'}; font-size: ${shortAggValid ? '0.85rem' : '0.75rem'};">${shortAggValid ? '$' + currentPrice.toFixed(2) + ' NOW' : 'WAIT â€” above stop'}</span>
                        </div>
                        
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Stop Loss</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #dc2626;">$${shortStop.toFixed(2)}</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Target 1</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #16a34a;">$${shortT1.toFixed(2)}</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Target 2</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #16a34a;">$${shortT2.toFixed(2)}</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Risk:Reward</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #d97706;">${shortRR}:1</span>
                        </div>
                        <div class="setup-row" style="display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem;">
                            <span class="label" style="color: #9ca3af;">Expected Value</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: #0891b2;">$${shortEV}</span>
                        </div>
                        
                        <div class="setup-triggers" style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px dashed #e5e5e5;">
                            <div class="trigger valid" style="display: flex; gap: 0.5rem; font-size: 0.8rem; margin-bottom: 0.35rem; color: #16a34a;">
                                <span class="icon">âœ“</span>
                                <span>${shortTriggerValid}</span>
                            </div>
                            <div class="trigger invalid" style="display: flex; gap: 0.5rem; font-size: 0.8rem; margin-bottom: 0.35rem; color: #9ca3af;">
                                <span class="icon">âœ—</span>
                                <span>${shortTriggerInvalid}</span>
                            </div>
                        </div>
                    </div>` : ''}
                    
                    <!-- No Setup Message for hidden low-score setups -->
                    ${!showLongSetup && !isLong ? `
                        <div class="setup-card no-setup" style="background: #fafafa; border-radius: 12px; padding: 2rem; border: 1px solid #e5e5e5; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 0.75rem;">
                            <div style="font-size: 2.5rem; opacity: 0.3;">ðŸš«</div>
                            <div style="font-weight: 600; color: #9ca3af; font-size: 0.9rem;">LONG Setup Not Advisable</div>
                            <div style="color: #d1d5db; font-size: 0.8rem;">Score too low (${longScore}/100)</div>
                        </div>
                    ` : ''}
                    ${!showShortSetup && !isShort ? `
                        <div class="setup-card no-setup" style="background: #fafafa; border-radius: 12px; padding: 2rem; border: 1px solid #e5e5e5; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 0.75rem;">
                            <div style="font-size: 2.5rem; opacity: 0.3;">ðŸš«</div>
                            <div style="font-weight: 600; color: #9ca3af; font-size: 0.9rem;">SHORT Setup Not Advisable</div>
                            <div style="color: #d1d5db; font-size: 0.8rem;">Score too low (${shortScore}/100)</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Verdict card
            const preferredDir = isLong ? 'LONG' : isShort ? 'SHORT' : 'NEUTRAL';
            const verdictClass = isLong ? 'long-preferred' : isShort ? 'short-preferred' : '';
            const verdictText = plan.explanation || 'Based on volume profile and price action analysis';
            const verdictBorderColor = isLong ? '#16a34a' : isShort ? '#dc2626' : '#6b7280';
            const verdictDirColor = isLong ? '#16a34a' : isShort ? '#dc2626' : '#6b7280';
            const verdictHTML = `
                <div class="verdict-card ${verdictClass}" style="background: #fff; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; border: 1px solid #e5e5e5; border-left: 4px solid ${verdictBorderColor}; display: flex; align-items: center; gap: 1rem;">
                    <span class="verdict-icon" style="font-size: 1.5rem;">âš–ï¸</span>
                    <span class="verdict-dir" style="font-weight: 700; font-size: 1.1rem; color: ${verdictDirColor};">${preferredDir}</span>
                    <span class="verdict-text" style="flex: 1; color: #6b7280; font-size: 0.9rem;">Preferred direction â€” ${verdictText.substring(0, 100)}${verdictText.length > 100 ? '...' : ''}</span>
                    <span class="verdict-key" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #0891b2; background: #ecfeff; padding: 0.35rem 0.75rem; border-radius: 6px; font-weight: 500;">Key: $${keyLevel.toFixed(2)}</span>
                </div>
            `;
            
            // Fib context card (if fib data available in plan)
            const fibZone = plan.fib_zone || null;
            const fibQuality = plan.fib_quality || null;
            const fibTrend = plan.fib_trend || null;
            const fibPosition = plan.fib_position || null;
            const fibUsedStop = plan.fib_used_for_stop || false;
            const fibUsedTarget = plan.fib_used_for_target || false;
            const fibConfluence = plan.fib_confluence || [];
            
            let fibCardHTML = '';
            if (fibZone || fibPosition) {
                const zoneColors = {
                    'golden_zone': { bg: '#fef3c7', border: '#f59e0b', text: '#92400e', label: 'ðŸ† GOLDEN ZONE' },
                    'pullback_zone': { bg: '#dcfce7', border: '#16a34a', text: '#166534', label: 'ðŸ“ Pullback Zone' },
                    'shallow_pullback': { bg: '#e0f2fe', border: '#0ea5e9', text: '#0c4a6e', label: 'ðŸ“ Shallow Pullback' },
                    'strong_trend': { bg: '#ede9fe', border: '#7c3aed', text: '#5b21b6', label: 'ðŸ’ª Strong Trend' },
                    'extended': { bg: '#fee2e2', border: '#dc2626', text: '#991b1b', label: 'âš ï¸ Extended' },
                    'broken': { bg: '#fef2f2', border: '#ef4444', text: '#991b1b', label: 'ðŸš¨ Trend Broken' },
                };
                const zc = zoneColors[fibZone] || { bg: '#f3f4f6', border: '#9ca3af', text: '#374151', label: 'ðŸ“ Fib' };
                
                let fibDetails = [];
                if (fibQuality) fibDetails.push(`Quality: <strong>${fibQuality}</strong>`);
                if (fibTrend) fibDetails.push(`Trend: <strong>${fibTrend}</strong>`);
                if (fibUsedStop) fibDetails.push('âœ… Fib-enhanced stop');
                if (fibUsedTarget) fibDetails.push('âœ… Fib-enhanced target');
                if (fibConfluence.length > 0) fibDetails.push(`ðŸŽ¯ ${fibConfluence.slice(0,2).join('; ')}`);
                
                fibCardHTML = `
                    <div style="background: ${zc.bg}; border: 1px solid ${zc.border}; border-left: 4px solid ${zc.border}; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        <span style="font-weight: 700; color: ${zc.text}; font-size: 0.85rem;">${zc.label}</span>
                        <span style="color: ${zc.text}; font-size: 0.8rem; opacity: 0.85;">${fibPosition || ''}</span>
                        ${fibDetails.length > 0 ? `<div style="width: 100%; display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.75rem; color: ${zc.text}; opacity: 0.8; margin-top: 0.25rem;">${fibDetails.map(d => `<span>${d}</span>`).join('')}</div>` : ''}
                    </div>
                `;
            }
            
            // Bookmap card - use caution flags and real levels
            const cautionItems = (plan.caution_flags && plan.caution_flags.length > 0)
                ? plan.caution_flags.map(f => `
                    <div class="bookmap-row" style="display: flex; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span class="bookmap-dot" style="width: 10px; height: 10px; border-radius: 50%; margin-top: 0.35rem; flex-shrink: 0; background: #d97706;"></span>
                        <span class="bookmap-text" style="color: #6b7280;">${f}</span>
                    </div>
                `).join('')
                : '';
            const bookmapHTML = `
                <div class="bookmap-card" style="background: #fff; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; border: 1px solid #e5e5e5;">
                    <div class="bookmap-title" style="color: #7c3aed; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; font-weight: 600;">ðŸ” Bookmap Checklist</div>
                    <div class="bookmap-row" style="display: flex; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span class="bookmap-dot green" style="width: 10px; height: 10px; border-radius: 50%; margin-top: 0.35rem; flex-shrink: 0; background: #16a34a;"></span>
                        <span class="bookmap-text" style="color: #6b7280;"><strong style="color: #374151;">LONG:</strong> Look for absorption at $${(plan.val || currentPrice * 0.99).toFixed(2)} VAL (buyers absorbing sellers), delta flip positive at POC $${(plan.poc || currentPrice).toFixed(2)}</span>
                    </div>
                    <div class="bookmap-row" style="display: flex; gap: 0.75rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                        <span class="bookmap-dot red" style="width: 10px; height: 10px; border-radius: 50%; margin-top: 0.35rem; flex-shrink: 0; background: #dc2626;"></span>
                        <span class="bookmap-text" style="color: #6b7280;"><strong style="color: #374151;">SHORT:</strong> Look for rejection at $${(plan.vah || currentPrice * 1.01).toFixed(2)} VAH (sellers absorbing buyers), delta flip negative</span>
                    </div>
                    ${cautionItems}
                </div>
            `;
            
            // Options strategy card - SMART recommendations based on real data
            const optionsDir = isLong ? 'LONG' : 'SHORT';
            const primaryType = isLong ? 'CALL' : 'PUT';
            const hedgeType = isLong ? 'PUT' : 'CALL';
            
            // === SMART STRIKE SELECTION ===
            // Use OI walls as targets/support, pick strikes near current price
            const strikeIncrement = currentPrice > 100 ? 5 : currentPrice > 20 ? 1 : 0.5;
            const nearestStrike = (v) => Math.round(v / strikeIncrement) * strikeIncrement;
            
            // Primary strike: near ATM or slightly ITM for higher delta
            const primaryStrike = isLong 
                ? nearestStrike(currentPrice - strikeIncrement)  // Slightly ITM call 
                : nearestStrike(currentPrice + strikeIncrement); // Slightly ITM put
            // Hedge strike: OTM protection
            const hedgeStrike = isLong 
                ? (plan.put_wall && plan.put_wall < currentPrice ? nearestStrike(plan.put_wall) : nearestStrike(plan.stop_loss || currentPrice * 0.97))
                : (plan.call_wall && plan.call_wall > currentPrice ? nearestStrike(plan.call_wall) : nearestStrike(plan.stop_loss || currentPrice * 1.03));
            
            // === SMART DTE SELECTION ===
            const realDTE = plan.dte || 0;
            const realExpDate = plan.nearest_expiration || '';
            const avgIV = plan.avg_iv || 0;
            const expectedMove = plan.expected_move || 0;
            const dteReason = plan.dte_reason || '';
            
            // DTE recommendation based on trade type and IV
            let primaryDTELabel, hedgeDTELabel, primaryDTEDays, hedgeDTEDays;
            if (realDTE > 0) {
                // Use real expiration data from smart backend selection
                primaryDTEDays = realDTE;
                hedgeDTEDays = Math.max(5, Math.floor(realDTE * 0.5));
                primaryDTELabel = `${realDTE}d (${realExpDate})`;
                hedgeDTELabel = `~${hedgeDTEDays}d (shorter exp)`;
            } else {
                // Fallback defaults based on trade confidence
                primaryDTEDays = plan.confidence >= 70 ? 21 : plan.confidence >= 50 ? 30 : 45;
                hedgeDTEDays = Math.max(7, Math.floor(primaryDTEDays * 0.5));
                primaryDTELabel = `~${primaryDTEDays}d recommended`;
                hedgeDTELabel = `~${hedgeDTEDays}d recommended`;
            }
            
            // === SMART POSITION SIZING based on IV ===
            let primaryAlloc, hedgeAlloc, sizeNote;
            if (avgIV > 100) {
                // Extreme IV: likely earnings imminent
                primaryAlloc = '50-55%';
                hedgeAlloc = '45-50%';
                sizeNote = 'ðŸš¨ EXTREME IV (>100%) â€” Likely EARNINGS THIS WEEK. Exit before announcement or accept 30-50% IV crush. Consider 0.33x position size.';
            } else if (avgIV > 60) {
                // High IV: smaller primary, bigger hedge (premiums expensive)
                primaryAlloc = '50-55%';
                hedgeAlloc = '45-50%';
                sizeNote = 'âš¡ High IV â€” reduce size, wider hedge';
            } else if (avgIV > 35) {
                // Normal IV
                primaryAlloc = '65-70%';
                hedgeAlloc = '30-35%';
                sizeNote = '';
            } else if (avgIV > 0) {
                // Low IV: can lean heavier on primary (cheap premiums)
                primaryAlloc = '70-80%';
                hedgeAlloc = '20-30%';
                sizeNote = 'ðŸ’¡ Low IV â€” premiums cheap, can size up';
            } else {
                primaryAlloc = '65-70%';
                hedgeAlloc = '30-35%';
                sizeNote = '';
            }
            
            // === DATA DISPLAY ===
            const optSentiment = plan.options_sentiment || 'N/A';
            const optPCRatio = plan.pc_ratio ? plan.pc_ratio.toFixed(2) : 'N/A';
            const optIV = avgIV ? avgIV.toFixed(1) + '%' : 'N/A';
            const optCallWall = plan.call_wall ? '$' + plan.call_wall.toFixed(2) : 'N/A';
            const optPutWall = plan.put_wall ? '$' + plan.put_wall.toFixed(2) : 'N/A';
            const optExpMove = expectedMove ? 'Â±$' + expectedMove.toFixed(2) : 'N/A';
            
            // IV rank label
            let ivLabel = '';
            if (avgIV > 60) ivLabel = '<span style="color:#dc2626;font-weight:700;">HIGH</span>';
            else if (avgIV > 35) ivLabel = '<span style="color:#d97706;font-weight:600;">NORMAL</span>';
            else if (avgIV > 0) ivLabel = '<span style="color:#16a34a;font-weight:600;">LOW</span>';
            
            const optionsMetaHTML = (plan.pc_ratio || avgIV || realDTE) ? `
                    <div class="options-meta" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem; background: rgba(255,255,255,0.5); border-radius: 8px; padding: 0.75rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #a16207; text-transform: uppercase;">Sentiment</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${optSentiment === 'BULLISH' ? '#16a34a' : optSentiment === 'BEARISH' ? '#dc2626' : '#78716c'}; font-size: 0.85rem;">${optSentiment}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #a16207; text-transform: uppercase;">P/C Ratio</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${plan.pc_ratio < 0.7 ? '#16a34a' : plan.pc_ratio > 1.3 ? '#dc2626' : '#374151'}; font-size: 0.85rem;">${optPCRatio}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #a16207; text-transform: uppercase;">IV ${ivLabel}</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151; font-size: 0.85rem;">${optIV}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #a16207; text-transform: uppercase;">Exp Move</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151; font-size: 0.85rem;">${optExpMove}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #a16207; text-transform: uppercase;">Walls</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151; font-size: 0.75rem;">C:${optCallWall} P:${optPutWall}</div>
                        </div>
                    </div>
            ` : '';
            
            const optionsHTML = `
                <div class="options-card" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #fde68a; margin-bottom: 1.25rem;">
                    <div class="options-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span class="options-title" style="font-weight: 700; font-size: 0.9rem; color: #92400e; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ðŸŽ°</span>
                            HEDGED ${optionsDir} (${primaryType} + ${hedgeType} Hedge)
                        </span>
                        <span class="options-leverage" style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #a16207;">2:1 favoring ${primaryType}</span>
                    </div>
                    
                    ${optionsMetaHTML}
                    ${dteReason ? `<div style="background: rgba(255,255,255,0.5); border-radius: 6px; padding: 0.4rem 0.75rem; margin-bottom: 0.5rem; font-size: 0.75rem; color: #78716c; display: flex; align-items: center; gap: 0.4rem;">
                        <span style="color: #a16207;">ðŸŽ¯</span> <strong style="color: #92400e;">DTE Logic:</strong> ${dteReason}
                    </div>` : ''}
                    ${sizeNote ? `<div style="background: rgba(255,255,255,0.6); border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; font-size: 0.8rem; color: #92400e; font-weight: 500;">${sizeNote}</div>` : ''}
                    
                    <div class="options-legs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="options-leg primary" style="background: rgba(255,255,255,0.7); border-radius: 8px; padding: 0.75rem 1rem; border-left: 3px solid #16a34a;">
                            <div class="leg-header" style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span class="leg-type" style="font-weight: 700; font-size: 0.85rem; color: #16a34a;">ðŸ’š ${primaryType} (Primary)</span>
                                <span class="leg-strike" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151;">$${primaryStrike.toFixed(2)}</span>
                            </div>
                            <div class="leg-details" style="font-size: 0.75rem; color: #a16207;">${primaryDTELabel} | ${primaryAlloc} of position</div>
                            <div style="font-size: 0.7rem; color: #78716c; margin-top: 0.25rem;">Near ATM for higher delta</div>
                        </div>
                        <div class="options-leg hedge" style="background: rgba(255,255,255,0.7); border-radius: 8px; padding: 0.75rem 1rem; border-left: 3px solid #dc2626;">
                            <div class="leg-header" style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                <span class="leg-type" style="font-weight: 700; font-size: 0.85rem; color: #dc2626;">ðŸ›¡ï¸ ${hedgeType} (Hedge)</span>
                                <span class="leg-strike" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151;">$${hedgeStrike.toFixed(2)}</span>
                            </div>
                            <div class="leg-details" style="font-size: 0.75rem; color: #a16207;">${hedgeDTELabel} | ${hedgeAlloc} of position</div>
                            <div style="font-size: 0.7rem; color: #78716c; margin-top: 0.25rem;">OTM protection at ${isLong ? 'support' : 'resistance'}</div>
                        </div>
                    </div>
                    
                    ${expectedMove ? `
                    <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 0.6rem 0.75rem; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.75rem; color: #78716c;">Expected Move by expiry:</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151; font-size: 0.85rem;">$${(currentPrice - expectedMove).toFixed(2)} â€” $${(currentPrice + expectedMove).toFixed(2)}</span>
                    </div>
                    ` : ''}
                    
                    <div class="options-scenarios" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                        <div class="scenario correct" style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 0.75rem;">
                            <div class="scenario-label" style="font-size: 0.7rem; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem; color: #16a34a;">âœ“ If Correct</div>
                            <div class="scenario-text" style="font-size: 0.8rem; color: #78716c;">${primaryType} gains 2-3x, ${hedgeType.toLowerCase()} expires worthless. ${avgIV > 50 ? 'Sell early â€” high IV crushes fast.' : 'Net profitable.'}</div>
                        </div>
                        <div class="scenario wrong" style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 0.75rem;">
                            <div class="scenario-label" style="font-size: 0.7rem; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem; color: #dc2626;">âœ— If Wrong</div>
                            <div class="scenario-text" style="font-size: 0.8rem; color: #78716c;">${hedgeType} gains offset most/all ${primaryType.toLowerCase()} losses. ${avgIV > 50 ? 'Close quickly - IV crush accelerates decay on BOTH legs.' : 'Limited downside.'}</div>
                        </div>
                        <div class="scenario chop" style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 0.75rem;">
                            <div class="scenario-label" style="font-size: 0.7rem; text-transform: uppercase; font-weight: 600; margin-bottom: 0.25rem; color: #d97706;">â†” If Chop</div>
                            <div class="scenario-text" style="font-size: 0.8rem; color: #78716c;">Both decay from theta. ${primaryDTEDays > 21 ? 'Longer DTE gives time â€” cut at 50% loss.' : 'Short DTE â€” cut quickly to minimize theta burn.'}</div>
                        </div>
                    </div>
                    
                    <div class="options-flip" style="background: rgba(255,255,255,0.6); border-radius: 6px; padding: 0.6rem 0.75rem; font-size: 0.8rem; display: flex; gap: 0.5rem; align-items: flex-start;">
                        <span class="icon" style="color: #d97706; font-size: 1rem;">âš ï¸</span>
                        <span class="text" style="color: #78716c;"><strong>FLIP SIGNAL:</strong> If ${hedgeType.toLowerCase()} becomes profitable = ${isLong ? 'bearish' : 'bullish'} momentum confirmed. Close ${primaryType.toLowerCase()} position, add to ${hedgeType.toLowerCase()} OR flip bias to ${isLong ? 'short' : 'long'}.</span>
                    </div>
                </div>
            `;
            
            // Action bar
            const actionBarHTML = `
                <div class="action-bar" style="background: #fff; border-radius: 12px; padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e5e5e5;">
                    <div class="action-info" style="display: flex; gap: 2rem; font-size: 0.85rem;">
                        <div class="action-item" style="display: flex; flex-direction: column; gap: 0.1rem;">
                            <span class="label" style="color: #9ca3af; font-size: 0.7rem; text-transform: uppercase;">Risk</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151;">$${riskDollars.toFixed(0)}</span>
                        </div>
                        <div class="action-item" style="display: flex; flex-direction: column; gap: 0.1rem;">
                            <span class="label" style="color: #9ca3af; font-size: 0.7rem; text-transform: uppercase;">Shares</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151;">${shares}</span>
                        </div>
                        <div class="action-item" style="display: flex; flex-direction: column; gap: 0.1rem;">
                            <span class="label" style="color: #9ca3af; font-size: 0.7rem; text-transform: uppercase;">Key Level</span>
                            <span class="value" style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: #374151;">$${keyLevel.toFixed(2)}</span>
                        </div>
                    </div>
                    <button class="log-btn" style="background: #3b82f6; color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" onclick="logTrade('${plan.symbol}', '${plan.direction}', ${plan.entry_price}, ${plan.stop_loss}, ${plan.target_1}, ${plan.target_2}, ${plan.plan_id}, this)">
                        <span>ðŸ“’</span>
                        Log Trade
                    </button>
                </div>
            `;
            
            // NO_TRADE case - simplified display
            if (isNoTrade) {
                return `
                    <div class="header" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 1.5rem; border-radius: 16px 16px 0 0; margin-bottom: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1rem; font-weight: 600; color: #94a3b8; letter-spacing: 1px;">${plan.symbol}</span>
                                    <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${isUp ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${isUp ? '#4ade80' : '#f87171'}; font-weight: 600;">${isUp ? 'â–²' : 'â–¼'} ${Math.abs(changePct).toFixed(2)}%</span>
                                </div>
                                <div style="display: flex; align-items: baseline; gap: 0.75rem;">
                                    <span style="font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; color: #fff; letter-spacing: -1px;">$${currentPrice.toFixed(2)}</span>
                                    <span style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: ${isUp ? '#4ade80' : '#f87171'}; font-weight: 500;">${isUp ? '+' : ''}${change.toFixed(2)}</span>
                                </div>
                            </div>
                            <button onclick="this.closest('.modal-overlay').remove()" style="background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; font-size: 1.25rem; color: #94a3b8; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
                        </div>
                        <div style="display: flex; gap: 1.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Open</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #e2e8f0; font-weight: 500;">$${ohlcOpen.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">High</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #4ade80; font-weight: 500;">$${ohlcHigh.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Low</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #f87171; font-weight: 500;">$${ohlcLow.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Prev Close</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #e2e8f0; font-weight: 500;">$${prevClose.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="body" style="padding: 1rem 1.5rem 1.25rem 1.5rem; background: #f8f8f8;">
                        <div class="flow-card" style="background: #fff; border-radius: 12px; padding: 1.25rem; border: 1px solid #e5e5e5; border-left: 4px solid #6b7280; margin-bottom: 1rem;">
                            <div class="flow-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span class="flow-title" style="font-weight: 700; font-size: 1rem; color: #374151;">âšª NO TRADE</span>
                                <span class="flow-bias neutral" style="padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; background: #f3f4f6; color: #6b7280;">WAIT</span>
                            </div>
                            <p style="color: #6b7280; margin-top: 0.75rem;">${plan.explanation || 'Conditions not met for entry'}</p>
                        </div>
                        
                        ${setupsHTML}
                        
                        <div class="bookmap-card" style="background: #fff; border-radius: 12px; padding: 1.25rem; border: 1px solid #e5e5e5;">
                            <div class="bookmap-title" style="font-weight: 700; font-size: 0.95rem; color: #374151; margin-bottom: 0.75rem;">ðŸ“‹ WATCH CONDITIONS</div>
                            ${plan.caution_flags && plan.caution_flags.length > 0 ? plan.caution_flags.map(f => `
                                <div class="bookmap-row" style="display: flex; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                    <span class="bookmap-dot" style="width: 8px; height: 8px; border-radius: 50%; margin-top: 0.4rem; flex-shrink: 0; background: #d97706;"></span>
                                    <span class="bookmap-text" style="color: #4b5563;">${f}</span>
                                </div>
                            `).join('') : '<p style="color: #9ca3af;">Monitor for setup development</p>'}
                        </div>
                    </div>
                `;
            }
            
            // Full trade plan
            return `
                <div class="header" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 1.5rem; border-radius: 16px 16px 0 0; margin-bottom: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1rem; font-weight: 600; color: #94a3b8; letter-spacing: 1px;">${plan.symbol}</span>
                                <span style="font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: ${isUp ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${isUp ? '#4ade80' : '#f87171'}; font-weight: 600;">${isUp ? 'â–²' : 'â–¼'} ${Math.abs(changePct).toFixed(2)}%</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 0.75rem;">
                                <span style="font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; color: #fff; letter-spacing: -1px;">$${currentPrice.toFixed(2)}</span>
                                <span style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: ${isUp ? '#4ade80' : '#f87171'}; font-weight: 500;">${isUp ? '+' : ''}${change.toFixed(2)}</span>
                            </div>
                        </div>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; font-size: 1.25rem; color: #94a3b8; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                    <div style="display: flex; gap: 1.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Open</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #e2e8f0; font-weight: 500;">$${ohlcOpen.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">High</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #4ade80; font-weight: 500;">$${ohlcHigh.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Low</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #f87171; font-weight: 500;">$${ohlcLow.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.65rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Prev Close</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: #e2e8f0; font-weight: 500;">$${prevClose.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="body" style="padding: 1rem 1.5rem 1.25rem 1.5rem; background: #f8f8f8;">
                    ${earningsHTML}
                    ${flowCardHTML}
                    ${setupsHTML}
                    ${verdictHTML}
                    ${fibCardHTML}
                    ${bookmapHTML}
                    ${optionsHTML}
                    ${actionBarHTML}
                </div>
            `;
        }
        
        function updatePositionCalc(symbol, entryPrice, riskPerShare) {
            const account = parseFloat(document.getElementById('calc-account').value) || 25000;
            const riskPct = parseFloat(document.getElementById('calc-risk').value) || 1.5;
            
            // Save to localStorage
            localStorage.setItem('accountSize', account);
            localStorage.setItem('riskPct', riskPct);
            
            const riskDollars = account * riskPct / 100;
            const shares = Math.floor(riskDollars / riskPerShare);
            
            document.getElementById('calc-risk-dollars').textContent = '$' + riskDollars.toFixed(0);
            document.getElementById('calc-shares').textContent = shares + ' shares';
            document.getElementById('calc-options').textContent = '$' + riskDollars.toFixed(0) + ' max';
        }
        
        async function logTrade(symbol, direction, entry, stop, t1, t2, planId, btn) {
            if (!window.db || !window.currentUser) {
                alert('Please log in to save trades');
                return;
            }
            
            try {
                const account = parseFloat(localStorage.getItem('accountSize')) || 25000;
                const riskPct = parseFloat(localStorage.getItem('riskPct')) || 1.5;
                const riskPerShare = Math.abs(entry - stop);
                const riskDollars = account * riskPct / 100;
                const shares = riskPerShare > 0 ? Math.floor(riskDollars / riskPerShare) : 0;
                
                await window.db.collection('users').doc(window.currentUser.uid).collection('trades').add({
                    symbol: symbol,
                    direction: direction,
                    entry: entry,
                    stop: stop,
                    target1: t1,
                    target2: t2,
                    shares: shares,
                    riskPct: riskPct,
                    accountSize: account,
                    planId: planId,
                    status: 'open',
                    created_at: new Date().toISOString(),
                    // Fib context from scan
                    fib_zone: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_zone || null; })(),
                    fib_quality: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_quality || null; })(),
                    fib_trend: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_trend || null; })(),
                    fib_position: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_position || null; })()
                });
                
                // Update button
                if (btn) {
                    btn.innerHTML = 'âœ… Trade Logged';
                    btn.disabled = true;
                    btn.style.background = 'rgba(0,255,136,0.2)';
                }
            } catch (e) {
                console.error('Error logging trade:', e);
                alert('Error logging trade');
            }
        }
        
        function buildOptionsSection(optionsData, currentPrice) {
            if (!optionsData || optionsData.error || !optionsData.data || optionsData.data.length === 0) {
                console.log('Options data issue:', optionsData);
                return '*Options data not available for this symbol.*';
            }
            
            let section = '';
            const nearest = optionsData.data[0];
            
            // Check if nearest has data
            if (nearest.error) {
                return `*Options data error: ${nearest.error}*`;
            }
            
            const pcRatio = nearest.pc_ratio || 0;
            const sentiment = pcRatio > 1 ? 'ðŸ”´ Bearish (put heavy)' : pcRatio < 0.7 ? 'ðŸŸ¢ Bullish (call heavy)' : 'ðŸŸ¡ Neutral';
            
            // Sentiment Overview - like META report
            section += `### Sentiment Overview (${nearest.expiration} Expiry)\n`;
            section += `| Metric | Value | Interpretation |\n`;
            section += `|--------|-------|----------------|\n`;
            section += `| Put/Call Volume Ratio | ${pcRatio.toFixed(2)} | ${sentiment} |\n`;
            section += `| Total Call Volume | ${(nearest.total_call_volume || 0).toLocaleString()} | ${nearest.total_call_volume > nearest.total_put_volume ? 'Heavy activity' : 'Moderate'} |\n`;
            section += `| Total Put Volume | ${(nearest.total_put_volume || 0).toLocaleString()} | ${nearest.total_put_volume > nearest.total_call_volume ? 'Heavy hedging' : 'Moderate hedging'} |\n`;
            section += `| Max Call OI Strike | $${(nearest.max_call_oi_strike || 0).toFixed(2)} | Resistance / Target |\n`;
            section += `| Max Put OI Strike | $${(nearest.max_put_oi_strike || 0).toFixed(2)} | Support / Floor |\n\n`;
            
            // Implied Volatility & Expected Move - like META
            const avgIV = ((nearest.avg_call_iv || 0) + (nearest.avg_put_iv || 0)) / 2;
            section += `### Implied Volatility & Expected Move\n`;
            section += `| Expiration | ATM IV | Expected Move | Range |\n`;
            section += `|------------|--------|---------------|-------|\n`;
            
            // Calculate for each expiration we have
            optionsData.data.forEach(exp => {
                if (exp.error) return;
                const expAvgIV = ((exp.avg_call_iv || 0) + (exp.avg_put_iv || 0)) / 2;
                const daysToExp = Math.max(1, Math.ceil((new Date(exp.expiration) - new Date()) / (1000 * 60 * 60 * 24)));
                const expectedMove = currentPrice * (expAvgIV / 100) * Math.sqrt(daysToExp / 365);
                const pctMove = (expectedMove / currentPrice * 100).toFixed(1);
                section += `| ${exp.expiration} (${daysToExp}d) | ${expAvgIV.toFixed(1)}% | Â±$${expectedMove.toFixed(2)} (${pctMove}%) | $${(currentPrice - expectedMove).toFixed(2)} - $${(currentPrice + expectedMove).toFixed(2)} |\n`;
            });
            section += '\n';
            
            // Highest Volume Options Activity - Calls
            if (nearest.top_calls && nearest.top_calls.length > 0) {
                section += `### Highest Volume Calls (Bullish Bets)\n`;
                section += `| Strike | Premium | Volume | Open Interest | IV |\n`;
                section += `|--------|---------|--------|---------------|----|\n`;
                nearest.top_calls.forEach(c => {
                    const iv = ((c.impliedVolatility || 0) * 100).toFixed(1);
                    const strike = typeof c.strike === 'number' ? c.strike.toFixed(2) : c.strike;
                    const last = typeof c.lastPrice === 'number' ? c.lastPrice.toFixed(2) : (c.lastPrice || 0);
                    section += `| $${strike} | $${last} | ${(c.volume || 0).toLocaleString()} | ${(c.openInterest || 0).toLocaleString()} | ${iv}% |\n`;
                });
                section += '\n';
            }
            
            // Highest Volume Options Activity - Puts
            if (nearest.top_puts && nearest.top_puts.length > 0) {
                section += `### Highest Volume Puts (Hedges/Bearish Bets)\n`;
                section += `| Strike | Premium | Volume | Open Interest | IV |\n`;
                section += `|--------|---------|--------|---------------|----|\n`;
                nearest.top_puts.forEach(p => {
                    const iv = ((p.impliedVolatility || 0) * 100).toFixed(1);
                    const strike = typeof p.strike === 'number' ? p.strike.toFixed(2) : p.strike;
                    const last = typeof p.lastPrice === 'number' ? p.lastPrice.toFixed(2) : (p.lastPrice || 0);
                    section += `| $${strike} | $${last} | ${(p.volume || 0).toLocaleString()} | ${(p.openInterest || 0).toLocaleString()} | ${iv}% |\n`;
                });
                section += '\n';
            }
            
            // Key Options Levels - like META
            section += `### Key Options Levels\n`;
            section += `| Level | Type | Significance |\n`;
            section += `|-------|------|---------------|\n`;
            section += `| $${(nearest.max_call_oi_strike || 0).toFixed(2)} | Call Wall | Major upside target |\n`;
            const midPoint = ((nearest.max_call_oi_strike || currentPrice) + (nearest.max_put_oi_strike || currentPrice)) / 2;
            section += `| $${midPoint.toFixed(2)} | Max Pain Zone | Likely pin / magnet |\n`;
            section += `| $${(nearest.max_put_oi_strike || 0).toFixed(2)} | Put Wall | Strong support |\n\n`;
            
            const source = optionsData.source === 'tradier' ? 'Tradier (real-time)' : 'Yahoo Finance (15-20 min delay)';
            section += `*Source: ${source}*`;
            
            return section;
        }
        
        async function generateFullReport(symbol) {
            showToast(`Generating full report for ${symbol}...`, 'info');
            
            try {
                // Fetch comprehensive data including options
                const [analysisData, aiData, optionsData] = await Promise.all([
                    fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=false`),
                    fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${selectedTimeframe}&vp_period=${selectedVPPeriod}&with_ai=true`),
                    fetchJson(`${API_BASE}/api/options/${symbol}`).catch(() => null)
                ]);
                
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                const price = analysisData.current_price || 0;
                const vah = analysisData.vah || 0;
                const poc = analysisData.poc || 0;
                const val = analysisData.val || 0;
                const vwap = analysisData.vwap || 0;
                const rsi = analysisData.rsi || 50;
                const rvol = analysisData.rvol || 1.0;
                const bullScore = analysisData.bull_score || 0;
                const bearScore = analysisData.bear_score || 0;
                const signal = analysisData.signal || 'NEUTRAL';
                const confidence = analysisData.confidence || 50;
                
                // Determine bias
                let bias = 'Neutral';
                if (bullScore > bearScore + 15) bias = 'Bullish';
                else if (bearScore > bullScore + 15) bias = 'Bearish';
                else if (bullScore > bearScore) bias = 'Slight Bullish';
                else if (bearScore > bullScore) bias = 'Slight Bearish';
                
                // Calculate trade levels
                const atr = (vah - val) / 4 || price * 0.02;
                const stopLong = val * 0.995;
                const stopShort = vah * 1.005;
                const t1Long = price + (price - stopLong);
                const t2Long = price + 2 * (price - stopLong);
                const t1Short = price - (stopShort - price);
                const t2Short = price - 2 * (stopShort - price);
                
                // Build markdown report
                const report = `# ${symbol} Analysis Report
**Generated:** ${dateStr} | **Analyst:** Automated Scanner System

---

## Executive Summary

**Current Price:** $${price.toFixed(2)}  
**Signal:** ${signal}  
**Bias:** ${bias}  
**Confidence:** ${confidence.toFixed(0)}%

${aiData.ai_commentary ? aiData.ai_commentary.substring(0, 500) + '...' : 'Analysis generated from volume profile and technical indicators.'}

---

## Price & Technical Analysis

### Current Snapshot
| Metric | Value |
|--------|-------|
| Price | $${price.toFixed(2)} |
| Bull Score | ${bullScore.toFixed(0)} |
| Bear Score | ${bearScore.toFixed(0)} |
| RVOL | ${rvol.toFixed(2)}x |
| RSI (14) | ${rsi.toFixed(1)} ${rsi > 70 ? 'âš ï¸ Overbought' : rsi < 30 ? 'âš ï¸ Oversold' : ''} |

### Volume Profile Levels (${selectedTimeframe})
| Level | Price | Distance |
|-------|-------|----------|
| VAH | $${vah.toFixed(2)} | ${((vah - price) / price * 100).toFixed(1)}% |
| POC | $${poc.toFixed(2)} | ${((poc - price) / price * 100).toFixed(1)}% |
| VAL | $${val.toFixed(2)} | ${((val - price) / price * 100).toFixed(1)}% |
| VWAP | $${vwap.toFixed(2)} | ${((vwap - price) / price * 100).toFixed(1)}% |

---

## Signal Analysis

### Scoring Breakdown
| Factor | Score | Notes |
|--------|-------|-------|
| Bull Score | ${bullScore.toFixed(0)} | ${bullScore > bearScore ? 'âœ… Leading' : ''} |
| Bear Score | ${bearScore.toFixed(0)} | ${bearScore > bullScore ? 'âœ… Leading' : ''} |
| Gap | ${Math.abs(bullScore - bearScore).toFixed(0)} | ${Math.abs(bullScore - bearScore) >= 15 ? 'âœ… Clear signal' : 'âš ï¸ Mixed'} |

### Position Analysis
- Price vs POC: ${price > poc ? 'âœ… Above (Bullish)' : 'ðŸ”´ Below (Bearish)'}
- Price vs VWAP: ${price > vwap ? 'âœ… Above (Bullish)' : 'ðŸ”´ Below (Bearish)'}
- Price vs VAH: ${price >= vah ? 'âš ï¸ At/Above resistance' : 'âœ… Below resistance'}
- Price vs VAL: ${price <= val ? 'âš ï¸ At/Below support' : 'âœ… Above support'}

---

## Trade Setups

### Long Setup
| Parameter | Value |
|-----------|-------|
| Entry Zone | $${val.toFixed(2)} - $${poc.toFixed(2)} |
| Stop Loss | $${stopLong.toFixed(2)} |
| Target 1 | $${t1Long.toFixed(2)} (1R) |
| Target 2 | $${t2Long.toFixed(2)} (2R) |
| Risk/Share | $${(price - stopLong).toFixed(2)} |

### Short Setup
| Parameter | Value |
|-----------|-------|
| Entry Zone | $${poc.toFixed(2)} - $${vah.toFixed(2)} |
| Stop Loss | $${stopShort.toFixed(2)} |
| Target 1 | $${t1Short.toFixed(2)} (1R) |
| Target 2 | $${t2Short.toFixed(2)} (2R) |
| Risk/Share | $${(stopShort - price).toFixed(2)} |

---

## Key Notes

${analysisData.notes ? analysisData.notes.map(n => '- ' + n).join('\\n') : '- No additional notes'}

---

## AI Analysis

${aiData.ai_commentary || 'AI analysis not available.'}

---

## Options Analysis

${buildOptionsSection(optionsData, price)}

---

*Report generated by Simple Scanner v2.0*  
*Timeframe: ${selectedTimeframe} | VP Period: ${selectedVPPeriod}*
`;
                
                // Create download
                const blob = new Blob([report], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${symbol}_Analysis_${now.toISOString().split('T')[0]}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast(`ðŸ“„ Report downloaded: ${symbol}_Analysis.md`, 'success');
                
            } catch (e) {
                console.error('Failed to generate report:', e);
                showToast('Failed to generate report', 'error');
            }
        }
        
        async function recordOutcome(planId, outcome, btn) {
            try {
                btn.disabled = true;
                btn.textContent = '...';
                
                const response = await fetch(`${API_BASE}/api/rules/outcome`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_id: planId,
                        outcome: outcome
                    })
                });
                
                if (response.ok) {
                    // Update all buttons in this tracker
                    const tracker = btn.closest('.outcome-tracker');
                    tracker.innerHTML = `<span class="outcome-recorded">âœ… Outcome recorded: ${outcome}</span>`;
                } else {
                    throw new Error('Failed to record');
                }
            } catch (e) {
                btn.disabled = false;
                btn.textContent = 'Error';
                console.error('Failed to record outcome:', e);
            }
        }
        
        // Parse AI response into structured data
        function parseAIResponse(text, data) {
            // Helper to extract setup from section
            function extractSetup(section) {
                const setup = {
                    grade: '-',
                    conviction: '-',
                    probability: '-',
                    entry: '-',
                    aggressive: '-',
                    stop: '-',
                    t1: '-',
                    t2: '-',
                    rr: '-',
                    ev: '-',
                    trigger: '-',
                    invalid: '-',
                    why: '-'
                };
                
                // Grade
                const gradeMatch = section.match(/GRADE:\s*([A-F][+]?)/i);
                if (gradeMatch) setup.grade = gradeMatch[1];
                
                // Conviction
                const convMatch = section.match(/CONVICTION:\s*(\d+)\/10/i);
                if (convMatch) setup.conviction = convMatch[1] + '/10';
                
                // Probability
                const probMatch = section.match(/PROBABILITY:\s*([\d-]+%)/i);
                if (probMatch) setup.probability = probMatch[1];
                
                // Entry zone (conservative)
                const entryMatch = section.match(/ENTRY:\s*\$?([\d,.]+)(?:\s*-\s*\$?([\d,.]+))?/i);
                if (entryMatch) {
                    if (entryMatch[2]) {
                        setup.entry = '$' + entryMatch[1] + ' - $' + entryMatch[2];
                    } else {
                        setup.entry = '$' + entryMatch[1];
                    }
                }
                
                // Aggressive entry
                const aggMatch = section.match(/AGGRESSIVE:\s*\$?([\d,.]+)\s*(?:NOW)?/i);
                if (aggMatch) setup.aggressive = '$' + aggMatch[1] + ' NOW';
                
                // Stop
                const stopMatch = section.match(/STOP:\s*\$?([\d,.]+)/i);
                if (stopMatch) setup.stop = '$' + stopMatch[1];
                
                // T1 / T2
                const t1Match = section.match(/T1:\s*\$?([\d,.]+)/i);
                if (t1Match) setup.t1 = '$' + t1Match[1];
                
                const t2Match = section.match(/T2:\s*\$?([\d,.]+)/i);
                if (t2Match) setup.t2 = '$' + t2Match[1];
                
                // R:R
                const rrMatch = section.match(/R:R:\s*([\d.]+:1)/i);
                if (rrMatch) setup.rr = rrMatch[1];
                
                // EV
                const evMatch = section.match(/EV[:\s]+([+-]?\$?[\d,.]+)/i);
                if (evMatch) setup.ev = evMatch[1].replace('/100', '');
                
                // Trigger
                const trigMatch = section.match(/TRIGGER:\s*([^\n]+)/i);
                if (trigMatch) setup.trigger = trigMatch[1].trim();
                
                // Invalid
                const invMatch = section.match(/INVALID:\s*([^\n]+)/i);
                if (invMatch) setup.invalid = invMatch[1].trim();
                
                // Why
                const whyMatch = section.match(/WHY[:\s]+([^\n]+)/i);
                if (whyMatch) setup.why = whyMatch[1].trim();
                
                return setup;
            }
            
            const parsed = {
                bias: { direction: 'WAIT', probability: '50%', bullScore: data.bull_score || 0, bearScore: data.bear_score || 0 },
                levels: { entry: '-', stop: '-', risk: '-' },
                targets: { t1: '-', t2: '-' },
                rr: { t1rr: '-', t2rr: '-' },
                ev: { value: '-', breakeven: '-', verdict: 'NEUTRAL' },
                size: '-',
                invalid: '-',
                reasoning: '',
                alerts: [],
                longSetup: null,
                shortSetup: null,
                keyLevel: null,
                verdict: null
            };
            
            // Find the LONG and SHORT sections by splitting on keywords
            // First, check if we have dual format (both LONG and SHORT explicitly)
            const hasLongSetup = /LONG\s*SETUP/i.test(text);
            const hasShortSetup = /SHORT\s*SETUP/i.test(text);
            
            if (hasLongSetup && hasShortSetup) {
                // Find section boundaries - look for GRADE: after each header
                const longIdx = text.search(/LONG\s*SETUP/i);
                const shortIdx = text.search(/SHORT\s*SETUP/i);
                const verdictIdx = text.search(/VERDICT:/i);
                
                // Determine which comes first
                let longSection = '';
                let shortSection = '';
                
                if (longIdx < shortIdx) {
                    // LONG is first
                    longSection = text.substring(longIdx, shortIdx);
                    shortSection = text.substring(shortIdx, verdictIdx > 0 ? verdictIdx : text.length);
                } else {
                    // SHORT is first
                    shortSection = text.substring(shortIdx, longIdx);
                    longSection = text.substring(longIdx, verdictIdx > 0 ? verdictIdx : text.length);
                }
                
                if (longSection) parsed.longSetup = extractSetup(longSection);
                if (shortSection) parsed.shortSetup = extractSetup(shortSection);
            }
            
            // Parse VERDICT
            const verdictMatch = text.match(/VERDICT:\s*(LONG|SHORT)\s*preferred\s*(?:because\s*)?([^\n]*)/i);
            if (verdictMatch) {
                parsed.bias.direction = verdictMatch[1].toUpperCase();
                parsed.verdict = verdictMatch[2] ? verdictMatch[2].trim() : '';
            }
            
            // Parse KEY LEVEL
            const keyLevelMatch = text.match(/KEY LEVEL:\s*\$?([\d,.]+)/i);
            if (keyLevelMatch) {
                parsed.keyLevel = '$' + keyLevelMatch[1];
                parsed.alerts.push({ price: '$' + keyLevelMatch[1], label: 'Key Decision Level' });
            }
            
            // Parse BOOKMAP ORDER FLOW section
            parsed.bookmap = { long: null, short: null };
            const bookmapSection = text.match(/BOOKMAP[^:]*CHECKLIST[^:]*:[\s\S]*?(?=ðŸŽ°|$)/i);
            if (bookmapSection) {
                const bmText = bookmapSection[0];
                const bookmapLongMatch = bmText.match(/LONG:\s*Look for ([^\n]+)/i);
                if (bookmapLongMatch) {
                    parsed.bookmap.long = bookmapLongMatch[1].trim();
                }
                const bookmapShortMatch = bmText.match(/SHORT:\s*Look for ([^\n]+)/i);
                if (bookmapShortMatch) {
                    parsed.bookmap.short = bookmapShortMatch[1].trim();
                }
            }
            
            // Parse OPTIONS STRATEGY section
            parsed.options = null;
            const optionsSection = text.match(/ðŸŽ° OPTIONS STRATEGY:[\s\S]*$/i);
            if (optionsSection) {
                const optText = optionsSection[0];
                parsed.options = {
                    strategy: '',
                    bias: '',
                    leverage: '',
                    primary: { type: '', strike: '', expiry: '', delta: '', allocation: '', timing: '' },
                    hedge: { type: '', strike: '', expiry: '', delta: '', allocation: '', timing: '' },
                    scenarios: { correct: '', wrong: '', chop: '' },
                    management: { profit: '', cutLoss: '', roll: '', flipSignal: '' },
                    edge: ''
                };
                
                // Strategy name
                const stratMatch = optText.match(/OPTIONS STRATEGY:\s*([^\n]+)/i);
                if (stratMatch) parsed.options.strategy = stratMatch[1].trim();
                
                // Bias and leverage
                const biasLevMatch = optText.match(/Bias:\s*(\w+)\s*\|\s*Leverage:\s*([^\n]+)/i);
                if (biasLevMatch) {
                    parsed.options.bias = biasLevMatch[1];
                    parsed.options.leverage = biasLevMatch[2].trim();
                }
                
                // Primary leg
                const primaryMatch = optText.match(/PRIMARY LEG \((\w+)\):[\s\S]*?Strike:\s*\$?([\d.]+)[\s\S]*?Expiry:\s*([^\n]+)[\s\S]*?Delta:\s*([^\n]+)[\s\S]*?Size:\s*([^\n]+)[\s\S]*?Entry:\s*([^\n]+)/i);
                if (primaryMatch) {
                    parsed.options.primary = {
                        type: primaryMatch[1],
                        strike: '$' + primaryMatch[2],
                        expiry: primaryMatch[3].trim(),
                        delta: primaryMatch[4].trim(),
                        allocation: primaryMatch[5].trim(),
                        timing: primaryMatch[6].trim()
                    };
                }
                
                // Hedge leg
                const hedgeMatch = optText.match(/HEDGE LEG \((\w+)\):[\s\S]*?Strike:\s*\$?([\d.]+)[\s\S]*?Expiry:\s*([^\n]+)[\s\S]*?Delta:\s*([^\n]+)[\s\S]*?Size:\s*([^\n]+)[\s\S]*?Entry:\s*([^\n]+)/i);
                if (hedgeMatch) {
                    parsed.options.hedge = {
                        type: hedgeMatch[1],
                        strike: '$' + hedgeMatch[2],
                        expiry: hedgeMatch[3].trim(),
                        delta: hedgeMatch[4].trim(),
                        allocation: hedgeMatch[5].trim(),
                        timing: hedgeMatch[6].trim()
                    };
                }
                
                // Scenarios
                const correctMatch = optText.match(/If (?:bullish|bearish) correct:\s*([^\n]+)/i);
                if (correctMatch) parsed.options.scenarios.correct = correctMatch[1].trim();
                
                const wrongMatch = optText.match(/If wrong:\s*([^\n]+)/i);
                if (wrongMatch) parsed.options.scenarios.wrong = wrongMatch[1].trim();
                
                const chopMatch = optText.match(/If chop:\s*([^\n]+)/i);
                if (chopMatch) parsed.options.scenarios.chop = chopMatch[1].trim();
                
                // Management
                const profitMatch = optText.match(/Take Profit:\s*([^\n]+)/i);
                if (profitMatch) parsed.options.management.profit = profitMatch[1].trim();
                
                const cutMatch = optText.match(/Cut Loss:\s*([^\n]+)/i);
                if (cutMatch) parsed.options.management.cutLoss = cutMatch[1].trim();
                
                const rollMatch = optText.match(/Roll:\s*([^\n]+)/i);
                if (rollMatch) parsed.options.management.roll = rollMatch[1].trim();
                
                const flipMatch = optText.match(/FLIP SIGNAL:\s*([^\n]+)/i);
                if (flipMatch) parsed.options.management.flipSignal = flipMatch[1].trim();
                
                // Edge
                const edgeMatch = optText.match(/EDGE:\s*([^\n]+)/i);
                if (edgeMatch) parsed.options.edge = edgeMatch[1].trim();
            }
            
            // Parse EARNINGS warning (handle emoji encoding issues)
            parsed.earnings = null;
            const earningsToday = text.match(/EARNINGS TODAY([^\n]*)/i);
            const earningsWarning = text.match(/EARNINGS in (\d+) days \(([^)]+)\)[^\n]*IV ELEVATED/i);
            const earningsWatch = text.match(/EARNINGS in (\d+) days \(([^)]+)\)[^\n]*watch IV/i);
            const earningsInfo = text.match(/EARNINGS:\s*(\d{4}-\d{2}-\d{2})\s*\((\d+) days\)/i);
            
            if (earningsToday) {
                parsed.earnings = {
                    days: 0,
                    date: 'TODAY',
                    warning: 'EARNINGS TODAY' + (earningsToday[1] || ''),
                    severity: 'high'
                };
            } else if (earningsWarning) {
                parsed.earnings = {
                    days: parseInt(earningsWarning[1]),
                    date: earningsWarning[2],
                    warning: `EARNINGS in ${earningsWarning[1]} days`,
                    severity: 'high'
                };
            } else if (earningsWatch) {
                parsed.earnings = {
                    days: parseInt(earningsWatch[1]),
                    date: earningsWatch[2],
                    warning: `EARNINGS in ${earningsWatch[1]} days`,
                    severity: 'medium'
                };
            } else if (earningsInfo) {
                const days = parseInt(earningsInfo[2]);
                parsed.earnings = {
                    days: days,
                    date: earningsInfo[1],
                    warning: days <= 14 ? `EARNINGS in ${days} days` : `Next earnings: ${earningsInfo[1]}`,
                    severity: days <= 3 ? 'high' : days <= 14 ? 'medium' : 'low'
                };
            }
            
            // Fallback to old format if no dual setups found
            if (!parsed.longSetup && !parsed.shortSetup) {
                // Parse old TRADE BIAS format
                const biasMatch = text.match(/TRADE BIAS:\s*(LONG|SHORT|WAIT)[^\d]*(\d+%)?/i);
                if (biasMatch) {
                    parsed.bias.direction = biasMatch[1].toUpperCase();
                    parsed.bias.probability = biasMatch[2] || '50%';
                }
                
                // Parse single-direction data into levels/targets
                const entryMatch = text.match(/ENTRY:\s*\$?([\d,.]+)/i);
                if (entryMatch) parsed.levels.entry = '$' + entryMatch[1];
                
                const stopMatch = text.match(/STOP:\s*\$?([\d,.]+)/i);
                if (stopMatch) parsed.levels.stop = '$' + stopMatch[1];
                
                const t1Match = text.match(/T1:\s*\$?([\d,.]+)/i);
                if (t1Match) parsed.targets.t1 = '$' + t1Match[1];
                
                const t2Match = text.match(/T2:\s*\$?([\d,.]+)/i);
                if (t2Match) parsed.targets.t2 = '$' + t2Match[1];
                
                const rrMatch = text.match(/R:R:\s*([\d.]+):1/i);
                if (rrMatch) parsed.rr.t1rr = rrMatch[1] + ':1';
                
                const evMatch = text.match(/EV[:\s=]+([+-]?\$?[\d,.]+)/i);
                if (evMatch) {
                    parsed.ev.value = evMatch[1];
                    parsed.ev.verdict = evMatch[1].includes('-') ? 'NEGATIVE' : 'POSITIVE';
                }
                
                const invalidMatch = text.match(/INVALID(?:\s*IF)?:\s*([^\n]+)/i);
                if (invalidMatch) parsed.invalid = invalidMatch[1].trim();
                
                const reasonMatch = text.match(/(?:WHY|REASONING)[:\s]+([^\n]+)/i);
                if (reasonMatch) parsed.reasoning = reasonMatch[1].trim();
            } else {
                // Populate legacy fields from preferred direction for backward compatibility
                const preferred = parsed.bias.direction === 'SHORT' ? parsed.shortSetup : parsed.longSetup;
                if (preferred) {
                    parsed.levels.entry = preferred.entry;
                    parsed.levels.stop = preferred.stop;
                    parsed.targets.t1 = preferred.t1;
                    parsed.targets.t2 = preferred.t2;
                    parsed.rr.t1rr = preferred.rr;
                    parsed.ev.value = preferred.ev;
                    parsed.invalid = preferred.invalid;
                    parsed.reasoning = preferred.why;
                    parsed.bias.probability = preferred.probability;
                    
                    // Calculate risk
                    const entryNum = parseFloat(preferred.entry.replace(/[$,\s-]/g, '')) || 0;
                    const stopNum = parseFloat(preferred.stop.replace(/[$,]/g, '')) || 0;
                    if (entryNum && stopNum) {
                        parsed.levels.risk = '$' + Math.abs(entryNum - stopNum).toFixed(2);
                    }
                }
            }
            
            return parsed;
        }
        
        // Build the card HTML
        // Store AI parsed data for trade logging
        const aiParsedData = {};;
        
        function buildAICardsHTML(parsed, symbol, priceData = {}) {
            // Store for later use by log button
            aiParsedData[symbol] = parsed;
            
            const biasClass = parsed.bias.direction.toLowerCase();
            
            // Price bar at top
            const currentPrice = priceData.current_price || 0;
            const openPrice = priceData.day_open || priceData.open || 0;
            const highPrice = priceData.day_high || priceData.high || 0;
            const lowPrice = priceData.day_low || priceData.low || 0;
            const prevClose = priceData.prev_close || 0;
            const change = currentPrice - prevClose;
            const changePct = prevClose > 0 ? ((change / prevClose) * 100) : 0;
            const changeColor = change >= 0 ? 'var(--green)' : 'var(--red)';
            const changeIcon = change >= 0 ? 'â–²' : 'â–¼';
            
            const priceBarHTML = currentPrice > 0 ? `
                <!-- Price Bar - Compact -->
                <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.4rem 0.75rem; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">
                            <span style="font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">$${currentPrice.toFixed(2)}</span>
                            <span style="font-size: 0.75rem; color: ${changeColor}; font-weight: 600;">${changeIcon} ${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%)</span>
                        </div>
                        <div style="display: flex; gap: 0.75rem; font-size: 0.85rem;">
                            <div><span style="color: var(--text-muted);">O:</span> <span style="color: var(--text-secondary);">$${openPrice.toFixed(2)}</span></div>
                            <div><span style="color: var(--text-muted);">H:</span> <span style="color: var(--green);">$${highPrice.toFixed(2)}</span></div>
                            <div><span style="color: var(--text-muted);">L:</span> <span style="color: var(--red);">$${lowPrice.toFixed(2)}</span></div>
                            <div><span style="color: var(--text-muted);">PC:</span> <span style="color: var(--text-secondary);">$${prevClose.toFixed(2)}</span></div>
                        </div>
                    </div>
                </div>
            ` : '';
            
            // Earnings Warning Banner
            const earningsHTML = parsed.earnings ? `
                <!-- Earnings Warning -->
                <div style="background: ${parsed.earnings.severity === 'high' ? 'rgba(255,68,68,0.15)' : parsed.earnings.severity === 'medium' ? 'rgba(255,193,7,0.15)' : 'rgba(100,100,100,0.15)'}; border: 1px solid ${parsed.earnings.severity === 'high' ? 'rgba(255,68,68,0.5)' : parsed.earnings.severity === 'medium' ? 'rgba(255,193,7,0.4)' : 'rgba(150,150,150,0.3)'}; border-radius: 6px; padding: 0.4rem 0.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1rem;">${parsed.earnings.severity === 'high' ? 'ðŸš¨' : 'ðŸ“…'}</span>
                    <span style="font-size: 0.85rem; font-weight: 600; color: ${parsed.earnings.severity === 'high' ? 'var(--red)' : parsed.earnings.severity === 'medium' ? 'var(--yellow)' : 'var(--text-secondary)'};">${parsed.earnings.warning}</span>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">(${parsed.earnings.date})</span>
                    ${parsed.earnings.severity === 'high' ? `<span style="font-size: 0.75rem; color: var(--red); margin-left: auto;">âš ï¸ IV elevated - compression may be pre-earnings buildup</span>` : ''}
                    ${parsed.earnings.severity === 'medium' ? `<span style="font-size: 0.75rem; color: var(--yellow); margin-left: auto;">Watch IV levels</span>` : ''}
                </div>
            ` : '';
            
            // Order Flow Analysis - COMPACT single row
            const orderFlow = priceData.order_flow;
            const orderFlowHTML = orderFlow ? `
                <!-- Order Flow - Compact Single Row -->
                <div style="background: rgba(0,191,255,0.08); border: 1px solid rgba(0,191,255,0.3); border-radius: 8px; padding: 0.4rem 0.75rem; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.85rem; flex-wrap: wrap;">
                        <span style="font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: #00bfff;">ðŸ“Š ORDER FLOW</span>
                        <span style="padding: 0.1rem 0.4rem; border-radius: 4px; background: ${orderFlow.flow_bias === 'BULLISH' ? 'rgba(0,255,136,0.2)' : orderFlow.flow_bias === 'BEARISH' ? 'rgba(255,68,68,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${orderFlow.flow_bias === 'BULLISH' ? 'var(--green)' : orderFlow.flow_bias === 'BEARISH' ? 'var(--red)' : 'var(--text-secondary)'}; font-weight: 600;">${orderFlow.flow_bias}</span>
                        <span><span style="color: var(--text-muted);">Buy:</span> <span style="color: var(--green);">${orderFlow.buy_pressure}%</span></span>
                        <span><span style="color: var(--text-muted);">Sell:</span> <span style="color: var(--red);">${orderFlow.sell_pressure}%</span></span>
                        <span><span style="color: var(--text-muted);">Bars:</span> <span style="color: var(--cyan);">${orderFlow.total_bars_analyzed}</span></span>
                        <span><span style="color: var(--text-muted);">HiVol:</span> <span style="color: var(--yellow);">${orderFlow.high_volume_bars}</span></span>
                        <span><span style="color: var(--text-muted);">G/R:</span> <span style="color: var(--green);">${orderFlow.buy_candles}</span>/<span style="color: var(--red);">${orderFlow.sell_candles}</span></span>
                        <span><span style="color: var(--text-muted);">Vol:</span> <span style="color: ${orderFlow.volume_spike ? 'var(--yellow)' : 'var(--text-secondary)'};">${orderFlow.volume_ratio}x</span></span>
                        ${orderFlow.momentum ? `<span style="color: ${orderFlow.momentum.includes('BUY') ? 'var(--green)' : orderFlow.momentum.includes('SELL') ? 'var(--red)' : 'var(--text-secondary)'};">Mom: ${orderFlow.momentum}</span>` : ''}
                    </div>
                </div>
            ` : '';
            
            // Build dual-setup HTML if both setups available - COMPACT
            const dualSetupsHTML = (parsed.longSetup && parsed.shortSetup) ? `
                <!-- Dual Direction Setups - Compact -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <!-- LONG Setup -->
                    <div style="background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; padding: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.4rem;">
                            <span style="font-size: 1rem;">ðŸŸ¢</span>
                            <span style="font-family: 'Orbitron', sans-serif; font-weight: 600; font-size: 0.9rem; color: var(--green);">LONG SETUP</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted); margin-left: auto;">${parsed.longSetup.grade} | ${parsed.longSetup.conviction}</span>
                        </div>
                        <div style="font-size: 0.85rem; display: grid; gap: 0.15rem;">
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">Prob:</span><span style="color: var(--cyan);">${parsed.longSetup.probability}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">Entry:</span><span style="color: var(--green);">${parsed.longSetup.entry}</span></div>
                            ${parsed.longSetup.aggressive && parsed.longSetup.aggressive !== '-' ? `<div style="display: flex; justify-content: space-between; background: rgba(255,193,7,0.15); padding: 0.1rem 0.2rem; border-radius: 3px;"><span style="color: var(--yellow);">âš¡ Agg:</span><span style="color: var(--yellow);">${parsed.longSetup.aggressive}</span></div>` : ''}
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">Stop:</span><span style="color: var(--red);">${parsed.longSetup.stop}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">T1/T2:</span><span style="color: var(--green);">${parsed.longSetup.t1} / ${parsed.longSetup.t2}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">R:R:</span><span style="color: var(--yellow);">${parsed.longSetup.rr}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">EV:</span><span style="color: var(--cyan);">${parsed.longSetup.ev}</span></div>
                        </div>
                        <div style="border-top: 1px dashed rgba(0,255,136,0.2); padding-top: 0.3rem; margin-top: 0.3rem; font-size: 0.75rem;">
                            <div style="color: var(--green); margin-bottom: 0.1rem;">âœ… ${parsed.longSetup.trigger}</div>
                            <div style="color: var(--red);">âŒ ${parsed.longSetup.invalid}</div>
                        </div>
                    </div>
                    
                    <!-- SHORT Setup -->
                    <div style="background: rgba(255,68,68,0.08); border: 1px solid rgba(255,68,68,0.3); border-radius: 8px; padding: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.4rem;">
                            <span style="font-size: 1rem;">ðŸ”´</span>
                            <span style="font-family: 'Orbitron', sans-serif; font-weight: 600; font-size: 0.9rem; color: var(--red);">SHORT SETUP</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted); margin-left: auto;">${parsed.shortSetup.grade} | ${parsed.shortSetup.conviction}</span>
                        </div>
                        <div style="font-size: 0.85rem; display: grid; gap: 0.15rem;">
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">Prob:</span><span style="color: var(--cyan);">${parsed.shortSetup.probability}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">Entry:</span><span style="color: var(--green);">${parsed.shortSetup.entry}</span></div>
                            ${parsed.shortSetup.aggressive && parsed.shortSetup.aggressive !== '-' ? `<div style="display: flex; justify-content: space-between; background: rgba(255,193,7,0.15); padding: 0.1rem 0.2rem; border-radius: 3px;"><span style="color: var(--yellow);">âš¡ Agg:</span><span style="color: var(--yellow);">${parsed.shortSetup.aggressive}</span></div>` : ''}
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">Stop:</span><span style="color: var(--red);">${parsed.shortSetup.stop}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">T1/T2:</span><span style="color: var(--green);">${parsed.shortSetup.t1} / ${parsed.shortSetup.t2}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">R:R:</span><span style="color: var(--yellow);">${parsed.shortSetup.rr}</span></div>
                            <div style="display: flex; justify-content: space-between;"><span style="color: var(--text-muted);">EV:</span><span style="color: var(--cyan);">${parsed.shortSetup.ev}</span></div>
                        </div>
                        <div style="border-top: 1px dashed rgba(255,68,68,0.2); padding-top: 0.3rem; margin-top: 0.3rem; font-size: 0.75rem;">
                            <div style="color: var(--green); margin-bottom: 0.1rem;">âœ… ${parsed.shortSetup.trigger}</div>
                            <div style="color: var(--red);">âŒ ${parsed.shortSetup.invalid}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Verdict - Compact -->
                ${parsed.verdict || parsed.keyLevel ? `
                <div style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 6px; padding: 0.4rem 0.6rem; margin-bottom: 0.5rem; text-align: center;">
                    <span style="font-size: 0.9rem; color: var(--yellow);">âš–ï¸</span>
                    <span style="font-size: 0.9rem; color: ${parsed.bias.direction === 'LONG' ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">${parsed.bias.direction}</span>
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">preferred ${parsed.verdict ? '- ' + parsed.verdict.substring(0, 60) + (parsed.verdict.length > 60 ? '...' : '') : ''}</span>
                    ${parsed.keyLevel ? `<span style="font-size: 0.8rem; color: var(--cyan); margin-left: 0.5rem;">âš ï¸ Key: ${parsed.keyLevel}</span>` : ''}
                </div>
                ` : ''}
                
                <!-- Bookmap - Compact -->
                ${parsed.bookmap && (parsed.bookmap.long || parsed.bookmap.short) ? `
                <div style="background: rgba(138,43,226,0.1); border: 1px solid rgba(138,43,226,0.3); border-radius: 6px; padding: 0.4rem 0.6rem; margin-bottom: 0.5rem; font-size: 0.8rem;">
                    <span style="font-family: 'Orbitron', sans-serif; font-size: 0.85rem; color: #8a2be2;">ðŸ“Š BOOKMAP:</span>
                    ${parsed.bookmap.long ? `<span style="color: var(--green); margin-left: 0.5rem;">ðŸŸ¢ ${parsed.bookmap.long.substring(0, 50)}...</span>` : ''}
                    ${parsed.bookmap.short ? `<span style="color: var(--red); margin-left: 0.5rem;">ðŸ”´ ${parsed.bookmap.short.substring(0, 50)}...</span>` : ''}
                </div>
                ` : ''}
                
                <!-- Options Strategy - Compact -->
                ${parsed.options && parsed.options.strategy ? `
                <div style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.4); border-radius: 8px; padding: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                        <span style="font-size: 1rem;">ðŸŽ°</span>
                        <span style="font-family: 'Orbitron', sans-serif; font-size: 0.9rem; color: var(--yellow);">OPTIONS: ${parsed.options.strategy}</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: auto;">${parsed.options.leverage}</span>
                    </div>
                    
                    <!-- Legs in 2 columns -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.4rem; font-size: 0.85rem;">
                        <div style="background: rgba(0,255,136,0.1); border-radius: 4px; padding: 0.3rem;">
                            <div style="color: var(--green); font-weight: 600; margin-bottom: 0.2rem;">ðŸ’š ${parsed.options.primary.type} ${parsed.options.primary.strike}</div>
                            <div style="color: var(--text-muted);">${parsed.options.primary.expiry.split('(')[0]} | ${parsed.options.primary.allocation}</div>
                        </div>
                        <div style="background: rgba(255,68,68,0.1); border-radius: 4px; padding: 0.3rem;">
                            <div style="color: var(--red); font-weight: 600; margin-bottom: 0.2rem;">ðŸ›¡ï¸ ${parsed.options.hedge.type} ${parsed.options.hedge.strike}</div>
                            <div style="color: var(--text-muted);">${parsed.options.hedge.expiry.split('(')[0]} | ${parsed.options.hedge.allocation}</div>
                        </div>
                    </div>
                    
                    <!-- Scenarios inline -->
                    <div style="font-size: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.3rem;">
                        <span style="color: var(--green);">âœ… Correct: ${parsed.options.scenarios.correct.substring(0, 40)}...</span>
                        <span style="color: var(--red);">âŒ Wrong: ${parsed.options.scenarios.wrong.substring(0, 35)}...</span>
                    </div>
                    
                    <!-- Management inline -->
                    <div style="font-size: 0.75rem; border-top: 1px dashed rgba(255,193,7,0.3); padding-top: 0.3rem;">
                        <span style="color: var(--yellow);">âš ï¸ FLIP: ${parsed.options.management.flipSignal}</span>
                    </div>
                </div>
                ` : ''}
            ` : '';
            
            return `
                <div class="ai-card-container">
                    ${priceBarHTML}
                    ${earningsHTML}
                    ${orderFlowHTML}
                    ${dualSetupsHTML}
                    
                    <!-- Action Bar (Compact) -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; padding: 0.5rem 0.75rem; background: rgba(0,0,0,0.3); border-radius: 6px; margin-top: 0.3rem;">
                        ${(() => {
                            const rMatch = parsed.size.match(/([\d.]+)/);
                            const rMultiple = rMatch ? parseFloat(rMatch[1]) : 1;
                            const entryNum = parseFloat(parsed.levels.entry.replace(/[$,]/g, '')) || 0;
                            const stopNum = parseFloat(parsed.levels.stop.replace(/[$,]/g, '')) || 0;
                            const pos = calculatePositionSize(rMultiple, entryNum, stopNum);
                            return `<span style="font-size: 0.85rem; color: var(--text-secondary);">ðŸ“Š ${parsed.size} Â· Risk $${pos.riskDollars.toFixed(0)} Â· ${pos.shares} shares</span>`;
                        })()}
                        ${parsed.alerts.length > 0 ? `<span style="font-size: 0.85rem; color: var(--cyan);">â° ${parsed.alerts.map(a => a.price).join(', ')}</span>` : ''}
                        <button class="log-trade-btn" onclick="logTradeFromAI('${symbol}')" id="log-btn-${symbol}" style="margin-left: auto; padding: 0.4rem 0.75rem; font-size: 0.85rem;">ðŸ“’ Log Trade</button>
                    </div>
                </div>
            `;
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ==================== TRADE TRACKER ====================
        
        function getUserId() {
            return localStorage.getItem('userUid') || 'anonymous';
        }
        
        async function logTradeFromAI(symbol) {
            const parsed = aiParsedData[symbol];
            if (!parsed) {
                showToast('No AI data found for ' + symbol, 'error');
                return;
            }
            
            const direction = parsed.bias.direction;
            const btn = document.getElementById(`log-btn-${symbol}`);
            if (btn) {
                btn.innerHTML = 'â³ Logging...';
                btn.disabled = true;
            }
            
            try {
                // Parse numeric values from parsed data
                const entryNum = parseFloat(parsed.levels?.entry?.replace(/[$,]/g, '')) || 0;
                const stopNum = parseFloat(parsed.levels?.stop?.replace(/[$,]/g, '')) || 0;
                const t1Num = parseFloat(parsed.targets?.t1?.replace(/[$,]/g, '')) || 0;
                const t2Num = parseFloat(parsed.targets?.t2?.replace(/[$,]/g, '')) || 0;
                const confNum = parseFloat(parsed.bias?.probability?.replace('%', '')) || 50;
                
                // Get position size info
                const rMatch = parsed.size?.match(/([\d.]+)/);
                const rMultiple = rMatch ? parseFloat(rMatch[1]) : 1;
                const oneR = calculateOneR();
                const riskAmount = oneR * rMultiple;
                
                const tradeData = {
                    user_id: getUserId(),
                    symbol: symbol.toUpperCase(),
                    direction: direction === 'WAIT' ? 'LONG' : direction.toUpperCase(),
                    timeframe: selectedTimeframe,
                    entry_price: entryNum,
                    stop_loss: stopNum,
                    target1: t1Num,
                    target2: t2Num,
                    confidence: confNum,
                    bull_score: parsed.bias?.bullScore || 0,
                    bear_score: parsed.bias?.bearScore || 0,
                    setup_grade: parsed.bias?.direction === 'WAIT' ? 'B' : 'A',
                    risk_amount: riskAmount,
                    notes: `Logged from Simple Scanner - ${selectedTimeframe}`,
                    // Fib context from scan data
                    fib_zone: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_zone || null; })(),
                    fib_quality: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_quality || null; })(),
                    fib_trend: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_trend || null; })(),
                    fib_position: (() => { const s = allResults.find(r => r.symbol === symbol); return s?.fib_position || null; })()
                };
                
                const res = await fetch(`${API_BASE}/api/journal/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tradeData)
                });
                
                if (!res.ok) throw new Error('Failed to log trade');
                
                const result = await res.json();
                
                if (btn) {
                    btn.innerHTML = 'âœ… Logged!';
                    btn.classList.add('logged');
                }
                
                showToast(`Trade logged: ${symbol} ${direction}`, 'success');
                
            } catch (e) {
                console.error('Failed to log trade:', e);
                if (btn) {
                    btn.innerHTML = 'âŒ Error';
                    btn.disabled = false;
                }
                showToast('Failed to log trade', 'error');
            }
        }
        
        async function openTradeTracker() {
            if (!window.db || !window.currentUser) {
                alert('Please log in to view trades');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal wide">
                    <div class="modal-header">
                        <div class="modal-title">ðŸ“’ My Trades</div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="loading"><div class="spinner"></div>Loading trades...</div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            try {
                // Fetch trades from Firestore
                const snapshot = await window.db.collection('users')
                    .doc(window.currentUser.uid)
                    .collection('trades')
                    .orderBy('created_at', 'desc')
                    .limit(50)
                    .get();
                
                const trades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Separate trades by status
                const openTrades = trades.filter(t => t.status === 'open');
                const closedTrades = trades.filter(t => ['win', 'loss', 'breakeven', 'WIN', 'LOSS', 'BREAKEVEN'].includes(t.status));
                
                // Calculate stats
                const wins = closedTrades.filter(t => t.status?.toUpperCase() === 'WIN').length;
                const losses = closedTrades.filter(t => t.status?.toUpperCase() === 'LOSS').length;
                const winRate = closedTrades.length > 0 ? Math.round(wins / closedTrades.length * 100) : 0;
                
                modal.querySelector('.modal-body').innerHTML = `
                    <!-- Stats Bar -->
                    <div class="stats-bar">
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--cyan);">${trades.length}</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--green);">${wins}</div>
                            <div class="stat-label">Wins</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--red);">${losses}</div>
                            <div class="stat-label">Losses</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: var(--yellow);">${openTrades.length}</div>
                            <div class="stat-label">Open</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" style="color: ${winRate >= 50 ? 'var(--green)' : 'var(--red)'};">${winRate}%</div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                    </div>
                    
                    <!-- Open Trades -->
                    ${openTrades.length > 0 ? `
                        <div class="section-title">â³ Open (${openTrades.length})</div>
                        ${openTrades.map(t => renderFirestoreTradeCard(t)).join('')}
                    ` : ''}
                    
                    <!-- Closed Trades -->
                    ${closedTrades.length > 0 ? `
                        <div class="section-title">âœ… Closed (${closedTrades.length})</div>
                        ${closedTrades.slice(0, 10).map(t => renderFirestoreTradeCard(t)).join('')}
                        ${closedTrades.length > 10 ? `<div style="text-align: center; color: var(--text-gray); padding: 0.5rem;">+ ${closedTrades.length - 10} more...</div>` : ''}
                    ` : ''}
                    
                    ${trades.length === 0 ? `
                        <div class="empty-trades">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“’</div>
                            <p>No trades logged yet.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Analyze a symbol and click "Log This Trade" to start tracking!</p>
                        </div>
                    ` : ''}
                `;
                
            } catch (e) {
                console.error('Failed to load trades:', e);
                modal.querySelector('.modal-body').innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">âŒ</div>
                        <p>Failed to load trades: ${e.message}</p>
                    </div>
                `;
            }
        }
        
        function renderFirestoreTradeCard(trade) {
            const dirClass = trade.direction?.toUpperCase() === 'LONG' ? 'long' : 'short';
            const dirEmoji = trade.direction?.toUpperCase() === 'LONG' ? 'ðŸŸ¢' : 'ðŸ”´';
            const date = trade.created_at ? new Date(trade.created_at).toLocaleDateString() : 'Unknown';
            
            const entry = trade.entry || 0;
            const stop = trade.stop || 0;
            const t1 = trade.target1 || 0;
            const t2 = trade.target2 || 0;
            
            let actionsHtml = '';
            if (trade.status === 'open') {
                actionsHtml = `
                    <button class="trade-action-btn win" onclick="closeFirestoreTrade('${trade.id}', 'WIN', 'T1 Hit')">âœ… T1 Hit</button>
                    <button class="trade-action-btn win" onclick="closeFirestoreTrade('${trade.id}', 'WIN', 'T2 Hit')">ðŸŽ¯ T2 Hit</button>
                    <button class="trade-action-btn loss" onclick="closeFirestoreTrade('${trade.id}', 'LOSS', 'Stopped')">âŒ Stopped</button>
                    <button class="trade-action-btn" onclick="closeFirestoreTrade('${trade.id}', 'BREAKEVEN', 'Breakeven')">âž– B/E</button>
                `;
            } else {
                const statusEmoji = trade.status?.toUpperCase() === 'WIN' ? 'âœ…' : trade.status?.toUpperCase() === 'LOSS' ? 'âŒ' : 'âž–';
                actionsHtml = `<span style="color: var(--text-gray);">${statusEmoji} ${trade.exit_reason || trade.status}</span>`;
            }
            
            return `
                <div class="trade-card">
                    <div class="trade-card-header">
                        <div>
                            <span class="trade-symbol">${trade.symbol}</span>
                            <span class="trade-direction ${dirClass}">${dirEmoji} ${trade.direction?.toUpperCase()}</span>
                            <span style="color: var(--text-gray); font-size: 0.8rem; margin-left: 0.5rem;">${trade.shares || 0} shares</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: var(--text-gray);">${date}</div>
                        </div>
                    </div>
                    <div class="trade-levels">
                        <span>Entry: $${entry.toFixed(2)}</span>
                        <span>Stop: $${stop.toFixed(2)}</span>
                        <span>T1: $${t1.toFixed(2)}</span>
                        <span>T2: $${t2.toFixed(2)}</span>
                    </div>
                    <div class="trade-actions">
                        ${actionsHtml}
                    </div>
                </div>
            `;
        }
        
        async function closeFirestoreTrade(tradeId, status, reason) {
            if (!window.db || !window.currentUser) return;
            
            try {
                await window.db.collection('users')
                    .doc(window.currentUser.uid)
                    .collection('trades')
                    .doc(tradeId)
                    .update({
                        status: status,
                        exit_reason: reason,
                        closed_at: new Date().toISOString()
                    });
                
                // Refresh the modal
                document.querySelector('.modal-overlay')?.remove();
                openTradeTracker();
            } catch (e) {
                console.error('Failed to close trade:', e);
                alert('Failed to update trade');
            }
        }
        
        function renderTradeCard(trade) {
            const dirClass = trade.direction === 'LONG' ? 'long' : 'short';
            const dirEmoji = trade.direction === 'LONG' ? 'ðŸŸ¢' : 'ðŸ”´';
            const date = new Date(trade.logged_at).toLocaleDateString();
            
            let pnlHtml = '';
            if (trade.pnl_r !== null && trade.pnl_r !== undefined) {
                const pnlClass = trade.pnl_r >= 0 ? 'positive' : 'negative';
                const pnlSign = trade.pnl_r >= 0 ? '+' : '';
                pnlHtml = `<span class="trade-pnl ${pnlClass}">${pnlSign}${trade.pnl_r}R</span>`;
            }
            
            let actionsHtml = '';
            if (trade.status === 'PLANNED') {
                actionsHtml = `
                    <button class="trade-action-btn" onclick="openTrade(${trade.id})">â–¶ï¸ Open</button>
                    <button class="trade-action-btn" onclick="cancelTrade(${trade.id})">ðŸ—‘ï¸ Cancel</button>
                `;
            } else if (trade.status === 'OPEN') {
                actionsHtml = `
                    <button class="trade-action-btn win" onclick="closeTrade(${trade.id}, 'hit_target1')">âœ… T1 Hit</button>
                    <button class="trade-action-btn win" onclick="closeTrade(${trade.id}, 'hit_target2')">âœ… T2 Hit</button>
                    <button class="trade-action-btn loss" onclick="closeTrade(${trade.id}, 'hit_stop')">âŒ Stopped</button>
                `;
            } else {
                // Closed trade - show status
                const statusEmoji = trade.status === 'WIN' ? 'âœ…' : trade.status === 'LOSS' ? 'âŒ' : 'âž–';
                actionsHtml = `<span style="color: var(--text-gray);">${statusEmoji} ${trade.exit_reason || trade.status}</span>`;
            }
            
            return `
                <div class="trade-card">
                    <div class="trade-card-header">
                        <div>
                            <span class="trade-symbol">${trade.symbol}</span>
                            <span class="trade-direction ${dirClass}">${dirEmoji} ${trade.direction}</span>
                        </div>
                        <div style="text-align: right;">
                            ${pnlHtml}
                            <div style="font-size: 0.75rem; color: var(--text-gray);">${date}</div>
                        </div>
                    </div>
                    <div class="trade-levels">
                        <span>Entry: $${trade.entry_price?.toFixed(2)}</span>
                        <span>Stop: $${trade.stop_loss?.toFixed(2)}</span>
                        <span>T1: $${trade.target1?.toFixed(2)}</span>
                    </div>
                    <div class="trade-actions">
                        ${actionsHtml}
                    </div>
                </div>
            `;
        }
        
        async function openTrade(tradeId) {
            const price = prompt('Enter actual entry price:');
            if (!price) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/journal/${tradeId}/open?actual_entry=${price}`, { method: 'POST' });
                if (res.ok) {
                    showToast('Trade opened!', 'success');
                    openTradeTracker(); // Refresh
                }
            } catch (e) {
                showToast('Failed to open trade', 'error');
            }
        }
        
        async function closeTrade(tradeId, reason) {
            const price = prompt('Enter exit price:');
            if (!price) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/journal/${tradeId}/close?actual_exit=${price}&exit_reason=${reason}`, { method: 'POST' });
                if (res.ok) {
                    showToast('Trade closed!', 'success');
                    openTradeTracker(); // Refresh
                }
            } catch (e) {
                showToast('Failed to close trade', 'error');
            }
        }
        
        async function cancelTrade(tradeId) {
            if (!confirm('Cancel this trade?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/journal/${tradeId}/cancel`, { method: 'POST' });
                if (res.ok) {
                    showToast('Trade cancelled', 'success');
                    openTradeTracker(); // Refresh
                }
            } catch (e) {
                showToast('Failed to cancel trade', 'error');
            }
        }
        
        async function exportTrades() {
            const userId = getUserId();
            try {
                const res = await fetch(`${API_BASE}/api/journal/export?user_id=${userId}&format=csv`);
                const data = await res.json();
                
                if (data.csv) {
                    const blob = new Blob([data.csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    showToast('Exported!', 'success');
                }
            } catch (e) {
                showToast('Export failed', 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userUid');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
