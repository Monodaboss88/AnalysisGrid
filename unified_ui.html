<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTF Auction Scanner</title>
    <!-- Inline SVG favicon to avoid 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            color: #1e293b;
            min-height: 100vh;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            padding: 1rem 2rem;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.3);
        }
        
        header h1 {
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .status-connected { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: #fff; font-weight: 600; }
        .status-disconnected { background: linear-gradient(135deg, #dc2626 0%, #f87171 100%); color: #fff; }
        
        /* Navigation */
        nav {
            background: #fff;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        nav button {
            background: transparent;
            border: none;
            color: #64748b;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        nav button:hover { color: #059669; background: #f0fdf4; }
        nav button.active { color: #fff; background: linear-gradient(135deg, #059669 0%, #10b981 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        
        /* Main content */
        main {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* Cards */
        .card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.15);
        }
        
        .card h2 {
            color: #059669;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .card h3 {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        
        @media (max-width: 900px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
        
        /* Form elements */
        input, select {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            color: #1e293b;
            padding: 0.75rem;
            border-radius: 10px;
            width: 100%;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
            background: #fff;
        }
        
        label {
            display: block;
            color: #888;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5); }
        
        .btn-success { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: #fff; font-weight: 600; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #f43f5e 100%); color: #fff; font-weight: 600; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: #fff; font-weight: 600; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); color: #fff; }
        
        /* Signal badges */
        .signal {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .signal-long { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: #fff; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4); }
        .signal-short { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: #fff; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4); }
        .signal-yellow { background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: #fff; box-shadow: 0 2px 10px rgba(245, 158, 11, 0.4); }
        .signal-neutral { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); color: #fff; }
        
        /* Results table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th,
        .results-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .results-table th {
            color: #059669;
            font-size: 0.85rem;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .results-table tr:hover {
            background: #f0fdf4;
        }
        
        /* Score bars */
        .score-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        
        .score-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .score-fill.bull { background: linear-gradient(90deg, #059669, #34d399); box-shadow: 0 0 10px rgba(52, 211, 153, 0.5); }
        .score-fill.bear { background: linear-gradient(90deg, #dc2626, #f87171); box-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }
        
        /* Output display */
        .output {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Watchlist pills */
        .watchlist-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .watchlist-pill {
            background: #f0fdf4;
            border: 1px solid #86efac;
            color: #166534;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .watchlist-pill:hover { border-color: #059669; background: #dcfce7; }
        .watchlist-pill.active { background: #059669; color: #fff; border-color: #059669; }
        
        /* Alert/Trade cards */
        .item-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-card .details { flex: 1; }
        .item-card .symbol { font-weight: 600; color: #00d4ff; }
        .item-card .meta { color: #666; font-size: 0.85rem; margin-top: 0.25rem; }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Quick stats */
        .stat-box {
            text-align: center;
            padding: 1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #00d4ff;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        /* MTF Grid */
        .mtf-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .mtf-card {
            background: #1a1a25;
            border: 1px solid #252530;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .mtf-card .tf-label {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .mtf-card .signal-display {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Entry Diagram Styles */
        .entry-diagram-container {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #2a2a3e;
        }
        
        .entry-diagram-container h4 {
            color: #4ade80;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .entry-diagram-container svg {
            width: 100%;
            max-width: 300px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .diagram-description {
            color: #aaa;
            font-size: 0.85rem;
            margin-top: 0.75rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>üéØ MTF Auction Scanner</h1>
        <div id="status-badge" class="status-badge status-disconnected">
            Checking...
        </div>
    </header>
    
    <nav>
        <button class="active" onclick="showSection('scanner')">üìä Scanner</button>
        <button onclick="showSection('rangewatcher')">üìà Range Watcher</button>
        <button onclick="showSection('watchlists')">üìã Watchlists</button>
        <button onclick="showSection('alerts')">üö® Alerts</button>
        <button onclick="showSection('trades')">üìà Trades</button>
        <button onclick="showSection('settings')">‚öôÔ∏è Settings</button>
    </nav>
    
    <main>
        <!-- SCANNER SECTION -->
        <section id="scanner" class="section active">
            <div class="grid-2">
                <!-- Quick Analyze -->
                <div class="card">
                    <h2>‚ö° Quick Analyze (Live Data)</h2>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" id="quick-symbol" placeholder="Symbol (e.g., META)" style="flex: 1;">
                        <select id="quick-tf" style="width: 120px;">
                            <option value="30MIN">30min</option>
                            <option value="1HR" selected>1hr</option>
                            <option value="2HR">2hr</option>
                            <option value="4HR">4hr</option>
                        </select>
                        <button class="btn btn-primary" onclick="quickAnalyze()">Analyze</button>
                    </div>
                </div>
                
                <!-- Manual Input -->
                <div class="card">
                    <h2>‚úèÔ∏è Manual Chart Input</h2>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                        Enter values from your charting platform
                    </p>
                    <button class="btn btn-secondary" onclick="showManualInput()" style="width: 100%;">
                        Open Input Form
                    </button>
                </div>
            </div>
            
            <!-- Results Display -->
            <div class="card" id="results-card" style="display: none;">
                <h2>üìä Analysis Results</h2>
                <div id="results-container"></div>
            </div>
            
            <!-- MTF Results -->
            <div class="card" id="mtf-results-card" style="display: none;">
                <h2>üîÑ Multi-Timeframe Analysis</h2>
                <div id="mtf-results-container"></div>
            </div>
        </section>
        
        <!-- RANGE WATCHER SECTION -->
        <section id="rangewatcher" class="section">
            <div class="grid-2">
                <!-- Single Symbol Analysis -->
                <div class="card">
                    <h2>üìà Structure Analysis</h2>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                        Multi-period HH/HL/LH/LL swing structure analysis
                    </p>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" id="range-symbol" placeholder="Symbol (e.g., AAPL)" style="flex: 1;">
                        <button class="btn btn-primary" onclick="analyzeRange()">Analyze</button>
                    </div>
                </div>
                
                <!-- Compression Scanner -->
                <div class="card">
                    <h2>‚ö° Compression Scanner</h2>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
                        Find stocks with tight ranges (breakout candidates)
                    </p>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="compression-symbols" placeholder="AAPL,TSLA,META,NVDA" style="flex: 1;">
                        <button class="btn btn-primary" onclick="scanCompression()">Scan</button>
                    </div>
                </div>
            </div>
            
            <!-- Range Analysis Results -->
            <div id="range-results-card" class="card" style="display: none;">
                <h2>üìä Range Analysis Results</h2>
                <div id="range-results-container"></div>
            </div>
            
            <!-- Compression Scan Results -->
            <div id="compression-results-card" class="card" style="display: none;">
                <h2>‚ö° Compression Scan Results</h2>
                <div id="compression-results-container"></div>
            </div>
        </section>
        
        <!-- WATCHLISTS SECTION -->
        <section id="watchlists" class="section">
            <div class="card">
                <h2>üìã Watchlists</h2>
                <div id="watchlist-pills" class="watchlist-pills"></div>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <select id="scan-tf" style="width: 120px;">
                        <option value="30MIN">30min</option>
                        <option value="1HR" selected>1hr</option>
                        <option value="2HR">2hr</option>
                        <option value="4HR">4hr</option>
                    </select>
                    <button class="btn btn-primary" onclick="scanWatchlist()">
                        Scan Selected Watchlist
                    </button>
                </div>
                <div id="watchlist-symbols" style="color: #666; font-size: 0.9rem;"></div>
            </div>
            
            <div class="card" id="scan-results-card" style="display: none;">
                <h2>üîç Scan Results</h2>
                <div id="scan-results-container"></div>
            </div>
        </section>
        
        <!-- ALERTS SECTION -->
        <section id="alerts" class="section">
            <div class="grid-2">
                <div class="card">
                    <h2>‚ûï Create Alert</h2>
                    <label>Symbol</label>
                    <input type="text" id="alert-symbol" placeholder="META">
                    
                    <label>Price Level</label>
                    <input type="number" id="alert-level" placeholder="615.00" step="0.01">
                    
                    <div class="grid-2">
                        <div>
                            <label>Direction</label>
                            <select id="alert-direction">
                                <option value="below">Below (Break Down)</option>
                                <option value="above">Above (Break Up)</option>
                            </select>
                        </div>
                        <div>
                            <label>Action</label>
                            <select id="alert-action">
                                <option value="SHORT">SHORT Trigger</option>
                                <option value="LONG">LONG Trigger</option>
                                <option value="EXIT">EXIT Signal</option>
                                <option value="ALERT">Alert Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <label>Note (optional)</label>
                    <input type="text" id="alert-note" placeholder="Break of support">
                    
                    <button class="btn btn-primary" onclick="createAlert()" style="width: 100%; margin-top: 0.5rem;">
                        Create Alert
                    </button>
                </div>
                
                <div class="card">
                    <h2>üö® Active Alerts</h2>
                    <div id="alerts-list"></div>
                </div>
            </div>
        </section>
        
        <!-- TRADES SECTION -->
        <section id="trades" class="section">
            <div class="card">
                <h2>üìä Trade Statistics</h2>
                <div id="trade-stats" class="grid-4"></div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h2>‚ûï Log Trade Setup</h2>
                    <div class="grid-2">
                        <div>
                            <label>Symbol</label>
                            <input type="text" id="trade-symbol" placeholder="META">
                        </div>
                        <div>
                            <label>Direction</label>
                            <select id="trade-direction">
                                <option value="LONG">LONG</option>
                                <option value="SHORT">SHORT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-3">
                        <div>
                            <label>Entry</label>
                            <input type="number" id="trade-entry" step="0.01">
                        </div>
                        <div>
                            <label>Stop</label>
                            <input type="number" id="trade-stop" step="0.01">
                        </div>
                        <div>
                            <label>Target</label>
                            <input type="number" id="trade-target" step="0.01">
                        </div>
                    </div>
                    
                    <label>Notes</label>
                    <input type="text" id="trade-notes" placeholder="Setup notes">
                    
                    <button class="btn btn-primary" onclick="logTrade()" style="width: 100%; margin-top: 0.5rem;">
                        Log Trade
                    </button>
                </div>
                
                <div class="card">
                    <h2>üìã Pending Trades</h2>
                    <div id="trades-list"></div>
                </div>
            </div>
        </section>
        
        <!-- SETTINGS SECTION -->
        <section id="settings" class="section">
            <div class="card">
                <h2>üîë Finnhub API Key</h2>
                <p style="color: #666; margin-bottom: 1rem;">
                    Get your free API key from <a href="https://finnhub.io" target="_blank" style="color: #00d4ff;">finnhub.io</a>
                </p>
                <div style="display: flex; gap: 1rem;">
                    <input type="password" id="api-key" placeholder="Your Finnhub API key" style="flex: 1;">
                    <button class="btn btn-primary" onclick="setApiKey()">Save Key</button>
                </div>
            </div>
            
            <div class="card">
                <h2>üìä System Status</h2>
                <div id="system-status"></div>
            </div>
        </section>
    </main>
    
    <!-- Manual Input Modal -->
    <div id="manual-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; padding: 2rem; overflow-y: auto;">
        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>‚úèÔ∏è Manual Chart Input</h2>
                <button onclick="hideManualInput()" style="background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <div class="grid-2">
                <div>
                    <label>Symbol</label>
                    <input type="text" id="manual-symbol" placeholder="META">
                </div>
                <div>
                    <label>Timeframe</label>
                    <select id="manual-tf">
                        <option value="30MIN">30min</option>
                        <option value="1HR">1hr</option>
                        <option value="2HR" selected>2hr</option>
                        <option value="4HR">4hr</option>
                    </select>
                </div>
            </div>
            
            <label>Current Price</label>
            <input type="number" id="manual-price" step="0.01" placeholder="619.28">
            
            <div class="grid-3">
                <div>
                    <label>VAH</label>
                    <input type="number" id="manual-vah" step="0.01" placeholder="667.72">
                </div>
                <div>
                    <label>POC</label>
                    <input type="number" id="manual-poc" step="0.01" placeholder="660.40">
                </div>
                <div>
                    <label>VAL</label>
                    <input type="number" id="manual-val" step="0.01" placeholder="647.22">
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <label>VWAP</label>
                    <input type="number" id="manual-vwap" step="0.01" placeholder="619.63">
                </div>
                <div>
                    <label>RSI</label>
                    <input type="number" id="manual-rsi" step="0.01" placeholder="33.58">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="analyzeManual()" style="width: 100%; margin-top: 1rem;">
                Analyze
            </button>
        </div>
    </div>

    <script>
        // API Configuration - change this when deploying
        // Local: '' (empty) or 'http://localhost:8000'
        // Cloud: 'https://your-cloud-run-url.run.app'
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? '' 
            : 'https://web-production-c71d2.up.railway.app';  // Railway cloud API
        
        let selectedWatchlist = null;
        let enableAI = true;  // Enable ChatGPT commentary by default

        // =====================================================================
        // UTIL
        // =====================================================================

        function asNumber(value) {
            const n = Number(value);
            return Number.isFinite(n) ? n : null;
        }

        function fmtFixed(value, digits = 0, fallback = '‚Äî') {
            const n = asNumber(value);
            return n === null ? fallback : n.toFixed(digits);
        }

        function fmtPercent(value, digits = 0, fallback = '‚Äî') {
            const n = asNumber(value);
            return n === null ? fallback : `${n.toFixed(digits)}%`;
        }

        function fmtMoney(value, digits = 2, fallback = '‚Äî') {
            const n = asNumber(value);
            return n === null ? fallback : `$${n.toFixed(digits)}`;
        }

        async function fetchJson(url, options) {
            const res = await fetch(url, options);
            let data = null;
            try {
                data = await res.json();
            } catch {
                // ignore
            }

            if (!res.ok) {
                const message = (data && (data.detail || data.message)) || res.statusText || 'Request failed';
                throw new Error(message);
            }
            return data;
        }
        
        // =====================================================================
        // ENTRY DIAGRAMS - Visual representation of each entry setup
        // =====================================================================
        
        const ENTRY_DIAGRAMS = {
            // VAL Touch + Rejection (Long)
            'val_touch_rejection': {
                title: 'VAL Touch + Rejection',
                direction: 'LONG',
                description: 'First touch of VAL with rejection candle ‚Üí Target POC/VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="75" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="45" x2="150" y2="45" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="48" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="105" x2="150" y2="105" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="108" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 80 35 L 85 55 L 80 80 L 90 100" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="100" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="109" text-anchor="middle" fill="#00ff88" font-size="8" font-weight="bold">ENTRY</text>
                    <line x1="50" y1="125" x2="150" y2="125" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="128" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="75" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="100" y="67" text-anchor="middle" fill="#00ff88" font-size="8">T1</text>
                    <path d="M 95 100 L 100 80" stroke="#00ff88" stroke-width="2" marker-end="url(#arrowG)"/>
                    <defs><marker id="arrowG" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#00ff88"/></marker></defs>
                </svg>`
            },
            
            // POC Reclaim (Long)
            'poc_reclaim': {
                title: 'POC Reclaim',
                direction: 'LONG',
                description: 'Price dips below POC then reclaims ‚Üí Enter on reclaim, target VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="75" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="45" x2="150" y2="45" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="48" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="105" x2="150" y2="105" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="108" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 70 55 L 75 75 L 80 90 L 90 85 L 95 75" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="70" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="79" text-anchor="middle" fill="#00ff88" font-size="7" font-weight="bold">ENTRY RECLAIM</text>
                    <line x1="50" y1="125" x2="150" y2="125" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="128" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="45" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="100" y="37" text-anchor="middle" fill="#00ff88" font-size="8">T1</text>
                    <path d="M 100 68 L 100 52" stroke="#00ff88" stroke-width="2" marker-end="url(#arrowG2)"/>
                    <defs><marker id="arrowG2" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#00ff88"/></marker></defs>
                </svg>`
            },
            
            // Failed Breakdown (Long - Bear Trap)
            'failed_breakdown': {
                title: 'Failed Breakdown (Bear Trap)',
                direction: 'LONG',
                description: 'Price breaks VAL then quickly reverses back ‚Üí Bears trapped = fuel for longs',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="75" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="45" x2="150" y2="45" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="48" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="105" x2="150" y2="105" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="108" fill="#ff6b6b" font-size="9">VAL</text>
                    <rect x="50" y="105" width="100" height="25" fill="#ff6b6b" fill-opacity="0.2"/><text x="100" y="120" text-anchor="middle" fill="#ff6b6b" font-size="7">TRAP ZONE</text>
                    <path d="M 70 75 L 75 95 L 85 115 L 95 125 L 105 120 L 110 105 L 115 90" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="98" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="107" text-anchor="middle" fill="#00ff88" font-size="7" font-weight="bold">ENTRY RECLAIM</text>
                    <line x1="50" y1="140" x2="150" y2="140" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="143" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="45" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="100" y="37" text-anchor="middle" fill="#00ff88" font-size="8">T1</text>
                    <path d="M 118 88 L 108 52" stroke="#00ff88" stroke-width="2" marker-end="url(#arrowG3)"/>
                    <defs><marker id="arrowG3" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#00ff88"/></marker></defs>
                </svg>`
            },
            
            // VAH Touch + Rejection (Short)
            'vah_touch_rejection': {
                title: 'VAH Touch + Rejection',
                direction: 'SHORT',
                description: 'First touch of VAH with rejection candle ‚Üí Target POC/VAL',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="90" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="60" x2="150" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="63" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="93" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 80 135 L 85 110 L 80 80 L 90 65" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="55" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="64" text-anchor="middle" fill="#ff6b6b" font-size="8" font-weight="bold">ENTRY</text>
                    <line x1="50" y1="40" x2="150" y2="40" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="43" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="90" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="102" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text>
                    <path d="M 95 67 L 100 84" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowR)"/>
                    <defs><marker id="arrowR" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs>
                </svg>`
            },
            
            // POC Rejection (Short)
            'poc_rejection': {
                title: 'POC Rejection',
                direction: 'SHORT',
                description: 'Price rallies to POC from below, fails to hold ‚Üí Short on rejection',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="90" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="60" x2="150" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="63" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="93" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 70 140 L 80 115 L 90 95 L 100 85 L 105 95" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="85" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="94" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">ENTRY REJECT</text>
                    <line x1="50" y1="50" x2="150" y2="50" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="53" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="120" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="132" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text>
                    <path d="M 108 97 L 105 114" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowR2)"/>
                    <defs><marker id="arrowR2" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs>
                </svg>`
            },
            
            // Failed Breakout (Short - Bull Trap)
            'failed_breakout': {
                title: 'Failed Breakout (Bull Trap)',
                direction: 'SHORT',
                description: 'Price breaks VAH then quickly reverses back ‚Üí Bulls trapped = fuel for shorts',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="90" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="60" x2="150" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="63" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="93" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text>
                    <rect x="50" y="35" width="100" height="25" fill="#00ff88" fill-opacity="0.2"/><text x="100" y="50" text-anchor="middle" fill="#00ff88" font-size="7">TRAP ZONE</text>
                    <path d="M 70 100 L 80 75 L 90 50 L 100 35 L 110 40 L 115 60 L 120 80" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="55" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="64" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">ENTRY ON FAIL</text>
                    <line x1="50" y1="25" x2="150" y2="25" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="28" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="120" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="132" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text>
                    <path d="M 123 82 L 110 114" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowR3)"/>
                    <defs><marker id="arrowR3" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs>
                </svg>`
            },
            
            // Breakout Retest Long
            'breakout_retest_long': {
                title: 'Breakout + Retest (Long)',
                direction: 'LONG',
                description: 'Clean break above VAH, enter on retest of broken level ‚Üí Target 1x extension',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="45" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="100" cy="105" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <rect x="80" y="45" width="40" height="60" fill="#5a3d3d"/>
                    <line x1="80" y1="45" x2="80" y2="105" stroke="#ff6b6b" stroke-width="2"/>
                    <line x1="120" y1="45" x2="120" y2="105" stroke="#ff6b6b" stroke-width="2"/>
                    <line x1="50" y1="50" x2="150" y2="50" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="53" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="75" x2="150" y2="75" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="78" fill="#ffcc00" font-size="8">LVN</text>
                    <line x1="50" y1="100" x2="150" y2="100" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="103" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 75 85 L 80 65 L 90 45 L 100 30 L 108 35 L 112 50 L 116 40" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="45" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="54" text-anchor="middle" fill="#00ff88" font-size="7" font-weight="bold">ENTRY RETEST</text>
                    <line x1="50" y1="65" x2="150" y2="65" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="68" fill="#ff0000" font-size="8">STOP</text>
                    <line x1="50" y1="20" x2="150" y2="20" stroke="#66ccff" stroke-width="1"/>
                    <circle cx="100" cy="20" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="100" y="14" text-anchor="middle" fill="#00ff88" font-size="7">T1 +1x</text>
                    <defs><marker id="arrowG4" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#00ff88"/></marker></defs>
                </svg>`
            },
            
            // Breakout Retest Short
            'breakout_retest_short': {
                title: 'Breakout + Retest (Short)',
                direction: 'SHORT',
                description: 'Clean break below VAL, enter on retest of broken level ‚Üí Target 1x extension',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="55" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="100" cy="115" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <rect x="80" y="55" width="40" height="60" fill="#5a3d3d"/>
                    <line x1="80" y1="55" x2="80" y2="115" stroke="#ff6b6b" stroke-width="2"/>
                    <line x1="120" y1="55" x2="120" y2="115" stroke="#ff6b6b" stroke-width="2"/>
                    <line x1="50" y1="60" x2="150" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="63" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="85" x2="150" y2="85" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="88" fill="#ffcc00" font-size="8">LVN</text>
                    <line x1="50" y1="110" x2="150" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="113" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 75 75 L 80 95 L 90 115 L 100 135 L 108 130 L 112 115 L 118 125" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="105" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="114" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">ENTRY RETEST</text>
                    <line x1="50" y1="95" x2="150" y2="95" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="98" fill="#ff0000" font-size="8">STOP</text>
                    <line x1="50" y1="160" x2="150" y2="160" stroke="#ff9966" stroke-width="1"/>
                    <circle cx="100" cy="160" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="172" text-anchor="middle" fill="#ff6b6b" font-size="7">T1 +1x</text>
                    <defs><marker id="arrowR4" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs>
                </svg>`
            },
            
            // LVN Rejection Long
            'lvn_rejection_long': {
                title: 'LVN Speed Zone (Long)',
                direction: 'LONG',
                description: 'Price enters LVN from below, rejected back ‚Üí Trade rejection back to HVN',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="45" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="100" cy="115" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <rect x="80" y="45" width="40" height="70" fill="#5a3d3d"/>
                    <rect x="50" y="60" width="100" height="35" fill="#ffcc00" fill-opacity="0.15"/><text x="155" y="82" fill="#ffcc00" font-size="7">LVN</text>
                    <line x1="50" y1="50" x2="150" y2="50" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="53" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="80" x2="150" y2="80" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/>
                    <line x1="50" y1="110" x2="150" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="113" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 75 130 L 80 110 L 90 85 L 95 75 L 100 85 L 105 100" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="100" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="109" text-anchor="middle" fill="#00ff88" font-size="7" font-weight="bold">LONG REJECT</text>
                    <line x1="50" y1="65" x2="150" y2="65" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="68" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="140" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="100" y="152" text-anchor="middle" fill="#00ff88" font-size="8">T1</text>
                </svg>`
            },
            
            // LVN Rejection Short
            'lvn_rejection_short': {
                title: 'LVN Speed Zone (Short)',
                direction: 'SHORT',
                description: 'Price enters LVN from above, rejected back ‚Üí Trade rejection back to HVN',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="55" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="100" cy="125" rx="40" ry="18" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <rect x="80" y="55" width="40" height="70" fill="#5a3d3d"/>
                    <rect x="50" y="75" width="100" height="35" fill="#ffcc00" fill-opacity="0.15"/><text x="155" y="97" fill="#ffcc00" font-size="7">LVN</text>
                    <line x1="50" y1="60" x2="150" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="63" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="90" x2="150" y2="90" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/>
                    <line x1="50" y1="120" x2="150" y2="120" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="123" fill="#ff6b6b" font-size="9">VAL</text>
                    <path d="M 75 40 L 80 60 L 90 85 L 95 95 L 100 85 L 105 70" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="78" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="87" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">SHORT REJECT</text>
                    <line x1="50" y1="105" x2="150" y2="105" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="108" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="30" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="22" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text>
                </svg>`
            },
            
            // Volume Break Long
            'volume_break_long': {
                title: 'Volume Confirmation Break (Long)',
                direction: 'LONG',
                description: 'Breakout with 2x+ avg volume ‚Üí Confirms conviction, no retest needed',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="90" cy="55" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="90" cy="115" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <rect x="75" y="55" width="30" height="60" fill="#5a3d3d"/>
                    <line x1="45" y1="60" x2="135" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="140" y="63" fill="#00ff88" font-size="8">VAH</text>
                    <line x1="45" y1="85" x2="135" y2="85" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="140" y="88" fill="#ffcc00" font-size="8">POC</text>
                    <line x1="45" y1="110" x2="135" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="140" y="113" fill="#ff6b6b" font-size="8">VAL</text>
                    <path d="M 65 105 L 70 85 L 80 60 L 90 40 L 100 25" stroke="#fff" stroke-width="2.5" fill="none"/>
                    <rect x="155" y="130" width="8" height="20" fill="#4a9eff" opacity="0.5"/>
                    <rect x="165" y="115" width="8" height="35" fill="#4a9eff" opacity="0.6"/>
                    <rect x="175" y="85" width="8" height="65" fill="#00ff88" opacity="0.9"/>
                    <text x="170" y="160" text-anchor="middle" fill="#aaa" font-size="6">VOL</text>
                    <rect x="45" y="50" width="90" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="90" y="59" text-anchor="middle" fill="#00ff88" font-size="6" font-weight="bold">ENTRY W/ VOLUME</text>
                    <line x1="45" y1="75" x2="135" y2="75" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="140" y="78" fill="#ff0000" font-size="7">STOP</text>
                    <circle cx="90" cy="20" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="90" y="12" text-anchor="middle" fill="#00ff88" font-size="7">T1</text>
                </svg>`
            },
            
            // Volume Break Short
            'volume_break_short': {
                title: 'Volume Confirmation Break (Short)',
                direction: 'SHORT',
                description: 'Breakdown with 2x+ avg volume ‚Üí Confirms conviction, no retest needed',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="90" cy="55" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="90" cy="115" rx="35" ry="16" fill="#5a3d3d" stroke="#ff6b6b" stroke-width="2"/>
                    <rect x="75" y="55" width="30" height="60" fill="#5a3d3d"/>
                    <line x1="45" y1="60" x2="135" y2="60" stroke="#00ff88" stroke-width="1.5"/><text x="140" y="63" fill="#00ff88" font-size="8">VAH</text>
                    <line x1="45" y1="85" x2="135" y2="85" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="140" y="88" fill="#ffcc00" font-size="8">POC</text>
                    <line x1="45" y1="110" x2="135" y2="110" stroke="#ff6b6b" stroke-width="1.5"/><text x="140" y="113" fill="#ff6b6b" font-size="8">VAL</text>
                    <path d="M 65 65 L 70 85 L 80 110 L 90 130 L 100 150" stroke="#fff" stroke-width="2.5" fill="none"/>
                    <rect x="155" y="130" width="8" height="20" fill="#4a9eff" opacity="0.5"/>
                    <rect x="165" y="115" width="8" height="35" fill="#4a9eff" opacity="0.6"/>
                    <rect x="175" y="85" width="8" height="65" fill="#ff6b6b" opacity="0.9"/>
                    <text x="170" y="160" text-anchor="middle" fill="#aaa" font-size="6">VOL</text>
                    <rect x="45" y="105" width="90" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="90" y="114" text-anchor="middle" fill="#ff6b6b" font-size="6" font-weight="bold">ENTRY W/ VOLUME</text>
                    <line x1="45" y1="95" x2="135" y2="95" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="140" y="98" fill="#ff0000" font-size="7">STOP</text>
                    <circle cx="90" cy="160" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="90" y="172" text-anchor="middle" fill="#ff6b6b" font-size="7">T1</text>
                </svg>`
            },
            
            // MR types (Mean Reversion)
            'long_mr': {
                title: 'Mean Reversion Long',
                direction: 'LONG',
                description: 'Extended 1.5+ ATR below value ‚Üí Fade back to POC/VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="60" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="35" x2="150" y2="35" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="38" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="60" x2="150" y2="60" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="63" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="85" x2="150" y2="85" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="88" fill="#ff6b6b" font-size="9">VAL</text>
                    <rect x="50" y="110" width="100" height="30" fill="#4ade80" fill-opacity="0.15"/><text x="100" y="128" text-anchor="middle" fill="#4ade80" font-size="8">EXTENDED 1.5+ ATR</text>
                    <path d="M 70 50 L 75 70 L 85 95 L 95 115 L 100 125 L 108 120 L 112 100" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="115" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="124" text-anchor="middle" fill="#00ff88" font-size="7" font-weight="bold">MR LONG</text>
                    <line x1="50" y1="145" x2="150" y2="145" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="148" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="60" r="6" fill="none" stroke="#00ff88" stroke-width="2"/><text x="100" y="52" text-anchor="middle" fill="#00ff88" font-size="8">T1</text>
                    <path d="M 115 98 L 105 68" stroke="#00ff88" stroke-width="2" marker-end="url(#arrowMR)"/>
                    <defs><marker id="arrowMR" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#00ff88"/></marker></defs>
                </svg>`
            },
            
            'short_mr': {
                title: 'Mean Reversion Short',
                direction: 'SHORT',
                description: 'Extended 1.5+ ATR above value ‚Üí Fade back to POC/VAL',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="100" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="75" x2="150" y2="75" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="78" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="100" x2="150" y2="100" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="103" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="125" x2="150" y2="125" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="128" fill="#ff6b6b" font-size="9">VAL</text>
                    <rect x="50" y="30" width="100" height="30" fill="#f87171" fill-opacity="0.15"/><text x="100" y="48" text-anchor="middle" fill="#f87171" font-size="8">EXTENDED 1.5+ ATR</text>
                    <path d="M 70 115 L 75 90 L 85 65 L 95 45 L 100 35 L 108 40 L 112 60" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="38" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="47" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">MR SHORT</text>
                    <line x1="50" y1="20" x2="150" y2="20" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="23" fill="#ff0000" font-size="8">STOP</text>
                    <circle cx="100" cy="100" r="6" fill="none" stroke="#ff6b6b" stroke-width="2"/><text x="100" y="112" text-anchor="middle" fill="#ff6b6b" font-size="8">T1</text>
                    <path d="M 115 62 L 105 92" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowMRS)"/>
                    <defs><marker id="arrowMRS" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#ff6b6b"/></marker></defs>
                </svg>`
            },
            
            // Trend types
            'long_trend': {
                title: 'Trend Continuation Long',
                direction: 'LONG',
                description: 'Holding above value area ‚Üí Trend continuation, buy dips to VAH',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="120" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="95" x2="150" y2="95" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="98" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="120" x2="150" y2="120" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="123" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="145" x2="150" y2="145" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="148" fill="#ff6b6b" font-size="9">VAL</text>
                    <rect x="50" y="30" width="100" height="60" fill="#00ff88" fill-opacity="0.1"/><text x="100" y="55" text-anchor="middle" fill="#00ff88" font-size="8">ABOVE VALUE</text>
                    <path d="M 60 130 L 70 105 L 85 75 L 95 55 L 105 45 L 115 55 L 120 70 L 130 50 L 140 35" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="60" width="100" height="12" fill="#00ff88" fill-opacity="0.3" stroke="#00ff88"/><text x="100" y="69" text-anchor="middle" fill="#00ff88" font-size="7" font-weight="bold">BUY DIPS</text>
                    <line x1="50" y1="85" x2="150" y2="85" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="88" fill="#ff0000" font-size="8">STOP</text>
                    <text x="100" y="25" text-anchor="middle" fill="#00ff88" font-size="9">‚Üë TREND ‚Üë</text>
                </svg>`
            },
            
            'short_trend': {
                title: 'Trend Continuation Short',
                direction: 'SHORT',
                description: 'Holding below value area ‚Üí Trend continuation, sell rips to VAL',
                svg: `<svg viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="180" fill="#1a1a2e"/>
                    <ellipse cx="100" cy="50" rx="50" ry="30" fill="#3d5a80" stroke="#4a9eff" stroke-width="2"/>
                    <line x1="50" y1="25" x2="150" y2="25" stroke="#00ff88" stroke-width="1.5"/><text x="155" y="28" fill="#00ff88" font-size="9">VAH</text>
                    <line x1="50" y1="50" x2="150" y2="50" stroke="#ffcc00" stroke-width="1.5" stroke-dasharray="4,2"/><text x="155" y="53" fill="#ffcc00" font-size="9">POC</text>
                    <line x1="50" y1="75" x2="150" y2="75" stroke="#ff6b6b" stroke-width="1.5"/><text x="155" y="78" fill="#ff6b6b" font-size="9">VAL</text>
                    <rect x="50" y="90" width="100" height="60" fill="#ff6b6b" fill-opacity="0.1"/><text x="100" y="125" text-anchor="middle" fill="#ff6b6b" font-size="8">BELOW VALUE</text>
                    <path d="M 60 40 L 70 65 L 85 95 L 95 115 L 105 125 L 115 115 L 120 100 L 130 120 L 140 140" stroke="#fff" stroke-width="2" fill="none"/>
                    <rect x="50" y="100" width="100" height="12" fill="#ff6b6b" fill-opacity="0.3" stroke="#ff6b6b"/><text x="100" y="109" text-anchor="middle" fill="#ff6b6b" font-size="7" font-weight="bold">SELL RIPS</text>
                    <line x1="50" y1="85" x2="150" y2="85" stroke="#ff0000" stroke-width="1" stroke-dasharray="3,3"/><text x="155" y="88" fill="#ff0000" font-size="8">STOP</text>
                    <text x="100" y="165" text-anchor="middle" fill="#ff6b6b" font-size="9">‚Üì TREND ‚Üì</text>
                </svg>`
            }
        };
        
        // Get diagram HTML for an entry type
        function getEntryDiagram(signalType, entrySignal) {
            // Try to match from entry_signal first (e.g., "failed_breakout:short")
            let key = null;
            if (entrySignal) {
                const parts = entrySignal.split(':');
                key = parts[0].toLowerCase();
            }
            
            // If not found, try signal_type (e.g., "LONG_MR", "SHORT_TREND")
            if (!key || !ENTRY_DIAGRAMS[key]) {
                if (signalType) {
                    key = signalType.toLowerCase();
                }
            }
            
            const diagram = ENTRY_DIAGRAMS[key];
            if (!diagram) return '';
            
            const dirColor = diagram.direction === 'LONG' ? '#4ade80' : '#f87171';
            
            return `
                <div class="entry-diagram-container">
                    <h4>
                        <span style="font-size: 1.2rem;">üìä</span>
                        ${diagram.title}
                        <span style="color: ${dirColor}; font-size: 0.85rem; margin-left: auto;">${diagram.direction}</span>
                    </h4>
                    ${diagram.svg}
                    <div class="diagram-description">${diagram.description}</div>
                </div>
            `;
        }
        
        // =====================================================================
        // NAVIGATION
        // =====================================================================
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for section
            if (sectionId === 'watchlists') loadWatchlists();
            if (sectionId === 'alerts') loadAlerts();
            if (sectionId === 'trades') loadTrades();
            if (sectionId === 'settings') loadStatus();
        }
        
        // =====================================================================
        // RANGE WATCHER
        // =====================================================================
        
        async function analyzeRange() {
            const symbol = document.getElementById('range-symbol').value.toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            showRangeResults('<div class="loading"></div> Analyzing structure...');
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/analyze/${symbol}`);
                displayRangeResult(data);
            } catch (e) {
                showRangeResults(`<p style="color: #f87171;">Error: ${e.message}</p>`);
            }
        }
        
        async function scanCompression() {
            const symbols = document.getElementById('compression-symbols').value.toUpperCase();
            if (!symbols) return alert('Enter symbols (comma-separated)');
            
            showCompressionResults('<div class="loading"></div> Scanning for compression...');
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/compression-scan?symbols=${symbols}`);
                displayCompressionResults(data);
            } catch (e) {
                showCompressionResults(`<p style="color: #f87171;">Error: ${e.message}</p>`);
            }
        }
        
        function showRangeResults(html) {
            document.getElementById('range-results-card').style.display = 'block';
            document.getElementById('range-results-container').innerHTML = html;
        }
        
        function showCompressionResults(html) {
            document.getElementById('compression-results-card').style.display = 'block';
            document.getElementById('compression-results-container').innerHTML = html;
        }
        
        function displayRangeResult(data) {
            const trendColors = {
                'STRONG_UPTREND': '#22c55e',
                'UPTREND': '#4ade80',
                'WEAK_UPTREND': '#86efac',
                'RANGE': '#fbbf24',
                'WEAK_DOWNTREND': '#fca5a5',
                'DOWNTREND': '#f87171',
                'STRONG_DOWNTREND': '#dc2626'
            };
            
            const trendColor = trendColors[data.trend_structure] || '#888';
            
            // Build period cards
            let periodCards = '';
            for (const [period, p] of Object.entries(data.periods)) {
                const structColor = p.structure.includes('HH') || p.structure.includes('HL') ? '#4ade80' : 
                                   p.structure.includes('LH') || p.structure.includes('LL') ? '#f87171' : '#888';
                periodCards += `
                    <div style="background: #f8fafc; padding: 0.75rem; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="font-weight: 600; color: #059669;">${period}D</div>
                        <div style="color: ${structColor}; font-size: 1.1rem; font-weight: 600;">${p.structure}</div>
                        <div style="color: #666; font-size: 0.8rem;">${fmtPercent(p.range_pct, 1)} range</div>
                        <div style="color: #888; font-size: 0.75rem;">${fmtPercent(p.position_in_range * 100, 0)} pos</div>
                    </div>
                `;
            }
            
            const html = `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 2rem;">${data.trend_emoji}</span>
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: ${trendColor};">${data.trend_structure}</div>
                        <div style="color: #666;">${data.symbol} ‚Ä¢ Strength: ${fmtFixed(data.trend_strength, 0)}</div>
                    </div>
                    <div style="margin-left: auto; text-align: right;">
                        <div style="font-size: 1.25rem; font-weight: 600;">$${fmtFixed(data.current_price, 2)}</div>
                        <div style="color: #666;">${data.range_state}</div>
                    </div>
                </div>
                
                <h3 style="color: #059669; margin-bottom: 0.75rem;">Period Structure</h3>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                    ${periodCards}
                </div>
                
                <div class="grid-2" style="gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border: 1px solid #86efac;">
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">üìà Resistance Levels</h4>
                        ${data.resistance_levels.slice(0, 3).map(l => 
                            `<div style="display: flex; justify-content: space-between; color: #333;"><span>$${fmtFixed(l.price, 2)}</span><span style="color: #666;">${l.description}</span></div>`
                        ).join('')}
                        ${data.breakout_watch ? `<div style="margin-top: 0.5rem; color: #059669; font-weight: 600;">‚ö° Breakout: $${fmtFixed(data.breakout_watch, 2)}</div>` : ''}
                    </div>
                    <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; border: 1px solid #fca5a5;">
                        <h4 style="color: #dc2626; margin-bottom: 0.5rem;">üìâ Support Levels</h4>
                        ${data.support_levels.slice(0, 3).map(l => 
                            `<div style="display: flex; justify-content: space-between; color: #333;"><span>$${fmtFixed(l.price, 2)}</span><span style="color: #666;">${l.description}</span></div>`
                        ).join('')}
                        ${data.breakdown_watch ? `<div style="margin-top: 0.5rem; color: #dc2626; font-weight: 600;">‚ö° Breakdown: $${fmtFixed(data.breakdown_watch, 2)}</div>` : ''}
                    </div>
                </div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h4 style="color: #059669; margin-bottom: 0.5rem;">üìù Analysis Notes</h4>
                    ${data.notes.map(n => `<div style="color: #333; margin-bottom: 0.25rem;">‚Ä¢ ${n}</div>`).join('')}
                </div>
            `;
            
            showRangeResults(html);
        }
        
        function displayCompressionResults(data) {
            if (!data.most_compressed || data.most_compressed.length === 0) {
                showCompressionResults('<p style="color: #666;">No compression found in the given symbols.</p>');
                return;
            }
            
            let rows = data.most_compressed.map(r => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 0.75rem; font-weight: 600;">${r.symbol}</td>
                    <td style="padding: 0.75rem; color: ${r.compression_ratio < 0.5 ? '#dc2626' : '#666'};">
                        ${fmtPercent(r.compression_ratio * 100, 0)}
                    </td>
                    <td style="padding: 0.75rem;">${r.range_state}</td>
                    <td style="padding: 0.75rem; color: ${r.bias === 'BULLISH' ? '#22c55e' : r.bias === 'BEARISH' ? '#dc2626' : '#666'};">
                        ${r.trend} ${r.bias === 'BULLISH' ? 'üü¢' : r.bias === 'BEARISH' ? 'üî¥' : 'üü°'}
                    </td>
                    <td style="padding: 0.75rem; color: #059669;">$${fmtFixed(r.breakout_watch || 0, 2)}</td>
                    <td style="padding: 0.75rem; color: #dc2626;">$${fmtFixed(r.breakdown_watch || 0, 2)}</td>
                    <td style="padding: 0.75rem;">
                        <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="document.getElementById('range-symbol').value='${r.symbol}'; analyzeRange();">
                            Analyze
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const html = `
                <p style="color: #666; margin-bottom: 1rem;">Found ${data.count} symbols. Most compressed setups (potential breakouts):</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 0.75rem; text-align: left;">Symbol</th>
                            <th style="padding: 0.75rem; text-align: left;">Compression</th>
                            <th style="padding: 0.75rem; text-align: left;">State</th>
                            <th style="padding: 0.75rem; text-align: left;">Trend</th>
                            <th style="padding: 0.75rem; text-align: left;">Breakout</th>
                            <th style="padding: 0.75rem; text-align: left;">Breakdown</th>
                            <th style="padding: 0.75rem; text-align: left;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
            
            showCompressionResults(html);
        }
        
        // =====================================================================
        // STATUS
        // =====================================================================
        
        async function checkStatus() {
            try {
                const data = await fetchJson(`${API_BASE}/api/status`);
                
                const badge = document.getElementById('status-badge');
                if (data.finnhub_connected) {
                    badge.className = 'status-badge status-connected';
                    badge.textContent = '‚úÖ Connected';
                } else {
                    badge.className = 'status-badge status-disconnected';
                    badge.textContent = '‚ö†Ô∏è No API Key';
                }
            } catch (e) {
                document.getElementById('status-badge').textContent = '‚ùå Server Error';
            }
        }
        
        async function loadStatus() {
            try {
                const data = await fetchJson(`${API_BASE}/api/status`);
                
                document.getElementById('system-status').innerHTML = `
                    <div class="grid-4">
                        <div class="stat-box">
                            <div class="stat-value">${data.finnhub_connected ? '‚úÖ' : '‚ùå'}</div>
                            <div class="stat-label">Finnhub</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.watchlists}</div>
                            <div class="stat-label">Watchlists</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.total_symbols}</div>
                            <div class="stat-label">Symbols</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${data.active_alerts}</div>
                            <div class="stat-label">Alerts</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                document.getElementById('system-status').innerHTML = '<p style="color: #f87171;">Error loading status</p>';
            }
        }
        
        async function setApiKey() {
            const key = document.getElementById('api-key').value;
            if (!key) return alert('Please enter API key');
            
            try {
                await fetchJson(`${API_BASE}/api/set-key?key=${encodeURIComponent(key)}`, {
                    method: 'POST'
                });
                alert('API key saved!');
                checkStatus();
            } catch (e) {
                alert('Error saving key');
            }
        }
        
        // =====================================================================
        // SCANNER
        // =====================================================================
        
        async function quickAnalyze() {
            const symbol = document.getElementById('quick-symbol').value.toUpperCase();
            const tf = document.getElementById('quick-tf').value;
            
            if (!symbol) return alert('Enter a symbol');
            
            showResults('<div class="loading"></div> Analyzing...');
            
            try {
                const aiParam = enableAI ? '&with_ai=true' : '';
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}${aiParam}`);
                displayResult(data);
            } catch (e) {
                showResults(`<p style="color: #f87171;">Error: ${e.message}</p>`);
            }
        }
        
        async function quickMTF() {
            const symbol = document.getElementById('quick-symbol').value.toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            showMTFResults('<div class="loading"></div> Running MTF analysis...');
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/mtf/${symbol}`);
                displayMTFResult(data);
            } catch (e) {
                showMTFResults(`<p style="color: #f87171;">Error: ${e.message}</p>`);
            }
        }
        
        function showResults(html) {
            document.getElementById('results-card').style.display = 'block';
            document.getElementById('results-container').innerHTML = html;
        }
        
        function showMTFResults(html) {
            document.getElementById('mtf-results-card').style.display = 'block';
            document.getElementById('mtf-results-container').innerHTML = html;
        }
        
        function displayResult(data) {
            const signalClass = {
                'LONG_SETUP': 'signal-long',
                'SHORT_SETUP': 'signal-short',
                'YELLOW': 'signal-yellow',
                'NEUTRAL': 'signal-neutral'
            }[data.signal] || 'signal-neutral';
            
            const html = `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 2rem;">${data.signal_emoji}</span>
                    <div>
                        <div class="signal ${signalClass}">${data.signal}</div>
                        <div style="color: #888; margin-top: 0.25rem;">${data.symbol} ‚Ä¢ ${data.timeframe}</div>
                    </div>
                    <div style="margin-left: auto; text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: 600;">${fmtPercent(data.confidence, 0)}</div>
                        <div style="color: #888;">confidence</div>
                    </div>
                </div>
                
                <div class="grid-2" style="margin-bottom: 1.5rem;">
                    <div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #4ade80;">Bull</span>
                            <span>${fmtFixed(data.bull_score, 0)}</span>
                        </div>
                        <div class="score-bar"><div class="score-fill bull" style="width: ${data.bull_score}%"></div></div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #f87171;">Bear</span>
                            <span>${fmtFixed(data.bear_score, 0)}</span>
                        </div>
                        <div class="score-bar"><div class="score-fill bear" style="width: ${data.bear_score}%"></div></div>
                    </div>
                </div>
                
                <div class="grid-3" style="margin-bottom: 1rem;">
                    <div class="stat-box" style="background: #1a1a25; border-radius: 8px;">
                        <div style="color: #4ade80; font-size: 1.25rem;">${fmtPercent(data.high_prob, 0)}</div>
                        <div style="color: #666; font-size: 0.8rem;">HIGH Prob</div>
                    </div>
                    <div class="stat-box" style="background: #1a1a25; border-radius: 8px;">
                        <div style="color: #f87171; font-size: 1.25rem;">${fmtPercent(data.low_prob, 0)}</div>
                        <div style="color: #666; font-size: 0.8rem;">LOW Prob</div>
                    </div>
                    <div class="stat-box" style="background: #1a1a25; border-radius: 8px;">
                        <div style="color: #00d4ff; font-size: 1.25rem;">${data.position}</div>
                        <div style="color: #666; font-size: 0.8rem;">Position</div>
                    </div>
                </div>
                
                <div style="background: #0a0a0f; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #888; margin-bottom: 0.5rem;">Notes</h3>
                    ${data.notes.map(n => `<div style="color: #ccc; margin-bottom: 0.25rem;">‚Ä¢ ${n}</div>`).join('')}
                </div>
                
                ${data.ai_commentary ? `
                <div style="background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #2a4a2a;">
                    <h3 style="color: #4ade80; margin-bottom: 0.5rem;">ü§ñ AI Trade Plan</h3>
                    <div style="color: #ccc; line-height: 1.6; white-space: pre-line;">${data.ai_commentary}</div>
                </div>
                ` : ''}
                
                ${getEntryDiagram(data.signal_type, data.entry_signal)}
                
                <button class="btn btn-primary" onclick="logToJournal()" style="width: 100%; margin-top: 1rem; background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);">
                    üìì Log to Trade Journal
                </button>
            `;
            
            // Store current result for journal logging
            window.currentResult = data;
            
            showResults(html);
        }
        
        function displayMTFResult(data) {
            const signalClass = {
                'LONG_SETUP': 'signal-long',
                'SHORT_SETUP': 'signal-short',
                'YELLOW': 'signal-yellow',
                'NEUTRAL': 'signal-neutral'
            }[data.dominant_signal] || 'signal-neutral';
            
            let tfCards = '';
            for (const [tf, r] of Object.entries(data.timeframes)) {
                const tfSignalClass = {
                    'LONG_SETUP': 'signal-long',
                    'SHORT_SETUP': 'signal-short',
                    'YELLOW': 'signal-yellow',
                    'NEUTRAL': 'signal-neutral'
                }[r.signal] || 'signal-neutral';
                
                tfCards += `
                    <div class="mtf-card">
                        <div class="tf-label">${tf}</div>
                        <div class="signal-display">${r.signal_emoji}</div>
                        <div class="signal ${tfSignalClass}" style="font-size: 0.75rem;">${r.signal}</div>
                        <div style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">
                            B:${fmtFixed(r.bull_score, 0)} / R:${fmtFixed(r.bear_score, 0)}
                        </div>
                    </div>
                `;
            }
            
            const html = `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <span style="font-size: 2.5rem;">${data.signal_emoji}</span>
                    <div>
                        <div class="signal ${signalClass}" style="font-size: 1.1rem;">${data.dominant_signal}</div>
                        <div style="color: #888; margin-top: 0.25rem;">${data.symbol} ‚Ä¢ ${fmtFixed(data.confluence_pct, 0)}% confluence</div>
                    </div>
                    <div style="margin-left: auto; text-align: right;">
                        <div style="color: #4ade80;">HIGH: ${fmtPercent(data.high_prob, 0)}</div>
                        <div style="color: #f87171;">LOW: ${fmtPercent(data.low_prob, 0)}</div>
                    </div>
                </div>
                
                <div class="mtf-grid" style="margin-bottom: 1.5rem;">
                    ${tfCards}
                </div>
                
                <div style="background: #0a0a0f; padding: 1rem; border-radius: 8px;">
                    <h3 style="color: #888; margin-bottom: 0.5rem;">Analysis Notes</h3>
                    ${data.notes.map(n => `<div style="color: #ccc; margin-bottom: 0.25rem;">‚Ä¢ ${n}</div>`).join('')}
                </div>
            `;
            
            showMTFResults(html);
        }
        
        // =====================================================================
        // MANUAL INPUT
        // =====================================================================
        
        function showManualInput() {
            document.getElementById('manual-modal').style.display = 'block';
        }
        
        function hideManualInput() {
            document.getElementById('manual-modal').style.display = 'none';
        }
        
        async function analyzeManual() {
            const data = {
                symbol: document.getElementById('manual-symbol').value.toUpperCase(),
                price: parseFloat(document.getElementById('manual-price').value),
                vah: parseFloat(document.getElementById('manual-vah').value),
                poc: parseFloat(document.getElementById('manual-poc').value),
                val: parseFloat(document.getElementById('manual-val').value),
                vwap: parseFloat(document.getElementById('manual-vwap').value),
                rsi: parseFloat(document.getElementById('manual-rsi').value),
                timeframe: document.getElementById('manual-tf').value
            };
            
            if (!data.symbol || !data.price) return alert('Fill in required fields');
            
            hideManualInput();
            showResults('<div class="loading"></div> Analyzing...');
            
            try {
                const result = await fetchJson(`${API_BASE}/api/analyze/manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                displayResult(result);
            } catch (e) {
                showResults(`<p style="color: #f87171;">Error: ${e.message}</p>`);
            }
        }
        
        // =====================================================================
        // TRADE JOURNAL
        // =====================================================================
        
        async function logToJournal() {
            const data = window.currentResult;
            if (!data) {
                alert('No analysis to log. Run a scan first.');
                return;
            }
            
            // Parse AI commentary for entry levels (best effort)
            let entryPrice = data.current_price || data.price || 0;
            let stopLoss = data.val || entryPrice * 0.98;  // Default 2% stop
            let target1 = data.vah || entryPrice * 1.03;   // Default 3% target
            let target2 = data.vah ? data.vah * 1.02 : entryPrice * 1.05;
            
            // Determine direction from signal
            let direction = "LONG";
            if (data.signal === "SHORT_SETUP" || data.signal === "RED") {
                direction = "SHORT";
                stopLoss = data.vah || entryPrice * 1.02;
                target1 = data.val || entryPrice * 0.97;
                target2 = data.val ? data.val * 0.98 : entryPrice * 0.95;
            }
            
            // Extract setup grade from AI commentary if present
            let setupGrade = "";
            if (data.ai_commentary) {
                const gradeMatch = data.ai_commentary.match(/SETUP STRENGTH[:\s]*([A-F][+]?)/i);
                if (gradeMatch) setupGrade = gradeMatch[1];
            }
            
            const journalEntry = {
                symbol: data.symbol,
                direction: direction,
                timeframe: data.timeframe,
                entry_price: entryPrice,
                stop_loss: stopLoss,
                target1: target1,
                target2: target2,
                signal: data.signal,
                confidence: data.confidence,
                bull_score: data.bull_score || 0,
                bear_score: data.bear_score || 0,
                ai_commentary: data.ai_commentary || "",
                setup_grade: setupGrade,
                vah: data.vah || 0,
                poc: data.poc || 0,
                val: data.val || 0,
                vwap: data.vwap || 0,
                rsi: data.rsi || 0,
                notes: data.notes ? data.notes.join("; ") : ""
            };
            
            try {
                const result = await fetch(`${API_BASE}/api/journal/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(journalEntry)
                });
                
                const response = await result.json();
                
                if (response.status === 'logged') {
                    alert(`‚úÖ Trade logged!\n\nID: ${response.id}\n${response.symbol} ${response.direction}\nEntry: $${response.entry.toFixed(2)}\nStop: $${response.stop.toFixed(2)}\nT1: $${response.target1.toFixed(2)}\nR:R = ${response.risk_reward_t1}:1`);
                } else {
                    alert('Error logging trade: ' + JSON.stringify(response));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
        
        // =====================================================================
        // WATCHLISTS
        // =====================================================================
        
        async function loadWatchlists() {
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                
                const pills = data.watchlists.map(w => `
                    <div class="watchlist-pill ${selectedWatchlist === w.name ? 'active' : ''}" 
                         onclick="selectWatchlist('${w.name}')">
                        ${w.name} (${w.symbol_count})
                    </div>
                `).join('');
                
                document.getElementById('watchlist-pills').innerHTML = pills;
                
                if (selectedWatchlist) {
                    const selected = data.watchlists.find(w => w.name === selectedWatchlist);
                    if (selected) {
                        document.getElementById('watchlist-symbols').textContent = 
                            selected.symbols.join(', ');
                    }
                }
            } catch (e) {
                console.error('Error loading watchlists:', e);
            }
        }
        
        function selectWatchlist(name) {
            selectedWatchlist = name;
            loadWatchlists();
        }
        
        async function scanWatchlist() {
            if (!selectedWatchlist) return alert('Select a watchlist first');
            
            const tf = document.getElementById('scan-tf').value;
            const wl = encodeURIComponent(selectedWatchlist);
            
            document.getElementById('scan-results-card').style.display = 'block';
            document.getElementById('scan-results-container').innerHTML = 
                '<div class="loading"></div> Scanning... (this may take a minute)';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists/${wl}/scan?timeframe=${encodeURIComponent(tf)}`);
                
                let rows = data.results.map(r => {
                    const signalClass = {
                        'LONG_SETUP': 'signal-long',
                        'SHORT_SETUP': 'signal-short',
                        'YELLOW': 'signal-yellow',
                        'NEUTRAL': 'signal-neutral'
                    }[r.signal] || 'signal-neutral';
                    
                    return `
                        <tr>
                            <td><strong>${r.symbol}</strong></td>
                            <td><span class="signal ${signalClass}">${r.signal_emoji} ${r.signal}</span></td>
                            <td>${fmtFixed(r.bull_score, 0)}</td>
                            <td>${fmtFixed(r.bear_score, 0)}</td>
                            <td>${fmtPercent(r.confidence, 0)}</td>
                            <td>${r.position}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('scan-results-container').innerHTML = `
                    <p style="color: #888; margin-bottom: 1rem;">
                        ${data.count} symbols ‚Ä¢ ${data.timeframe} ‚Ä¢ ${data.timestamp}
                    </p>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Bull</th>
                                <th>Bear</th>
                                <th>Conf</th>
                                <th>Position</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                document.getElementById('scan-results-container').innerHTML = 
                    `<p style="color: #f87171;">Error: ${e.message}</p>`;
            }
        }
        
        // =====================================================================
        // ALERTS
        // =====================================================================
        
        async function loadAlerts() {
            try {
                const data = await fetchJson(`${API_BASE}/api/alerts`);
                
                if (data.count === 0) {
                    document.getElementById('alerts-list').innerHTML = 
                        '<p style="color: #666;">No active alerts</p>';
                    return;
                }
                
                const html = data.alerts.map(a => `
                    <div class="item-card">
                        <div class="details">
                            <div class="symbol">${a.symbol}</div>
                            <div class="meta">
                                ${a.direction.toUpperCase()} ${fmtMoney(a.level, 2)} ‚Üí ${a.action}
                                ${a.note ? ` ‚Ä¢ ${a.note}` : ''}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteAlert('${a.symbol}', ${a.level})" style="padding: 0.5rem 1rem;">
                            ‚úï
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('alerts-list').innerHTML = html;
            } catch (e) {
                console.error('Error loading alerts:', e);
            }
        }
        
        async function createAlert() {
            const data = {
                symbol: document.getElementById('alert-symbol').value.toUpperCase(),
                level: parseFloat(document.getElementById('alert-level').value),
                direction: document.getElementById('alert-direction').value,
                action: document.getElementById('alert-action').value,
                note: document.getElementById('alert-note').value
            };
            
            if (!data.symbol || !data.level) return alert('Fill in required fields');
            
            try {
                await fetch(`${API_BASE}/api/alerts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                // Clear form
                document.getElementById('alert-symbol').value = '';
                document.getElementById('alert-level').value = '';
                document.getElementById('alert-note').value = '';
                
                loadAlerts();
            } catch (e) {
                alert('Error creating alert');
            }
        }
        
        async function deleteAlert(symbol, level) {
            try {
                await fetch(`${API_BASE}/api/alerts?symbol=${symbol}&level=${level}`, {
                    method: 'DELETE'
                });
                loadAlerts();
            } catch (e) {
                alert('Error deleting alert');
            }
        }
        
        // =====================================================================
        // TRADES
        // =====================================================================
        
        async function loadTrades() {
            // Load stats
            try {
                const stats = await fetchJson(`${API_BASE}/api/trades/stats`);
                
                document.getElementById('trade-stats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-value">${stats.total_trades}</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #4ade80;">${stats.wins}</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" style="color: #f87171;">${stats.losses}</div>
                        <div class="stat-label">Losses</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${fmtPercent(stats.win_rate, 0)}</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                `;
            } catch (e) {
                console.error('Error loading stats:', e);
            }
            
            // Load pending trades
            try {
                const trades = await fetchJson(`${API_BASE}/api/trades?status=pending`);
                
                if (trades.count === 0) {
                    document.getElementById('trades-list').innerHTML = 
                        '<p style="color: #666;">No pending trades</p>';
                    return;
                }
                
                const html = trades.trades.map(t => `
                    <div class="item-card">
                        <div class="details">
                            <div class="symbol">${t.symbol} ${t.direction}</div>
                            <div class="meta">
                                Entry: ${fmtMoney(t.entry_price, 2)} ‚Ä¢ Stop: ${fmtMoney(t.stop_loss, 2)} ‚Ä¢ Target: ${fmtMoney(t.target_1, 2)}
                                <br>R:R: ${t.rr_ratio}:1 ‚Ä¢ ${t.signal}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="updateTrade('${t.symbol}', 'WIN')" style="padding: 0.5rem;">‚úì</button>
                            <button class="btn btn-danger" onclick="updateTrade('${t.symbol}', 'LOSS')" style="padding: 0.5rem;">‚úï</button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('trades-list').innerHTML = html;
            } catch (e) {
                console.error('Error loading trades:', e);
            }
        }
        
        async function logTrade() {
            const data = {
                symbol: document.getElementById('trade-symbol').value.toUpperCase(),
                timeframe: '1HR',
                direction: document.getElementById('trade-direction').value,
                entry: parseFloat(document.getElementById('trade-entry').value),
                stop: parseFloat(document.getElementById('trade-stop').value),
                target: parseFloat(document.getElementById('trade-target').value),
                notes: document.getElementById('trade-notes').value
            };
            
            if (!data.symbol || !data.entry) return alert('Fill in required fields');
            
            try {
                await fetch(`${API_BASE}/api/trades`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                // Clear form
                document.getElementById('trade-symbol').value = '';
                document.getElementById('trade-entry').value = '';
                document.getElementById('trade-stop').value = '';
                document.getElementById('trade-target').value = '';
                document.getElementById('trade-notes').value = '';
                
                loadTrades();
            } catch (e) {
                alert('Error logging trade');
            }
        }
        
        async function updateTrade(symbol, status) {
            try {
                await fetch(`${API_BASE}/api/trades`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, status })
                });
                loadTrades();
            } catch (e) {
                alert('Error updating trade');
            }
        }
        
        // =====================================================================
        // INIT
        // =====================================================================
        
        checkStatus();
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
