<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.E.F. STRATEGIC EDGE FLOW | MTF Auction Scanner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs for Authentication and Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            /* Core palette */
            --bg-primary: #0a0e17;
            --bg-secondary: #0f1419;
            --bg-tertiary: #151c28;
            --bg-card: #12171f;
            --bg-elevated: #1a2332;
            
            /* Text */
            --text-primary: #e8edf5;
            --text-secondary: #8b95a5;
            --text-muted: #4a5568;
            
            /* Accent colors */
            --accent-cyan: #00f5d4;
            --accent-cyan-glow: rgba(0, 245, 212, 0.3);
            --accent-green: #4ade80;
            --accent-green-glow: rgba(74, 222, 128, 0.3);
            --accent-red: #ff3b5c;
            --accent-red-glow: rgba(255, 59, 92, 0.3);
            --accent-yellow: #ffc800;
            --accent-yellow-glow: rgba(255, 200, 0, 0.3);
            --accent-purple: #9d4edd;
            
            /* Borders */
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-default: rgba(255, 255, 255, 0.1);
            
            /* Gradients */
            --gradient-card: linear-gradient(135deg, rgba(20, 30, 48, 0.8) 0%, rgba(15, 20, 30, 0.9) 100%);
            --gradient-green: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            --gradient-red: linear-gradient(135deg, #ff3b5c 0%, #ff6b6b 100%);
            --gradient-yellow: linear-gradient(135deg, #ffc800 0%, #ffaa00 100%);
            --gradient-cyan: linear-gradient(135deg, #00f5d4 0%, #00b8d4 100%);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow-cyan: 0 0 30px rgba(0, 245, 212, 0.2);
            --shadow-glow-green: 0 0 30px rgba(0, 255, 136, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(0, 245, 212, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(157, 78, 221, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 255, 136, 0.02) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* Grid lines background effect */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        /* ===== HEADER ===== */
        header {
            position: relative;
            z-index: 100;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1.25rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-cyan);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-glow-cyan);
        }

        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .logo-text span {
            color: var(--accent-cyan);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .market-clock {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clock-time {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .market-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .market-status.closed {
            background: rgba(255, 59, 92, 0.1);
            border-color: rgba(255, 59, 92, 0.3);
            color: var(--accent-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        .market-status.closed .status-dot {
            background: var(--accent-red);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .connection-badge.connected {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
        }

        .connection-badge.disconnected {
            background: rgba(255, 59, 92, 0.1);
            border: 1px solid rgba(255, 59, 92, 0.3);
            color: var(--accent-red);
        }

        /* ===== NOTIFICATION BELL ===== */
        .notification-bell {
            position: relative;
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
            transition: transform 0.2s ease;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent-red);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .modal-close:hover {
            color: var(--accent-red);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* ===== NAVIGATION ===== */
        nav {
            position: relative;
            z-index: 100;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 1.5rem;
            display: flex;
            gap: 0.25rem;
        }

        nav button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            position: relative;
            border-bottom: 2px solid transparent;
        }

        nav button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        nav button.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
            background: rgba(0, 245, 212, 0.05);
        }

        nav button .nav-icon {
            font-size: 1rem;
        }

        /* ===== MAIN CONTENT ===== */
        main {
            position: relative;
            z-index: 10;
            padding: 1.5rem;
            min-height: calc(100vh - 120px);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 245, 212, 0.2);
            box-shadow: var(--shadow-md), 0 0 40px rgba(0, 245, 212, 0.05);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .card-title-icon.cyan { background: rgba(0, 245, 212, 0.15); }
        .card-title-icon.green { background: rgba(0, 255, 136, 0.15); }
        .card-title-icon.yellow { background: rgba(255, 200, 0, 0.15); }
        .card-title-icon.red { background: rgba(255, 59, 92, 0.15); }
        .card-title-icon.purple { background: rgba(157, 78, 221, 0.15); }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* ===== GRID LAYOUTS ===== */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        /* ===== DASHBOARD STATS ===== */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 900px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.cyan::before { background: var(--gradient-cyan); }
        .stat-card.green::before { background: var(--gradient-green); }
        .stat-card.yellow::before { background: var(--gradient-yellow); }
        .stat-card.red::before { background: var(--gradient-red); }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.cyan { color: var(--accent-cyan); }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive { color: var(--accent-green); }
        .stat-change.negative { color: var(--accent-red); }

        /* ===== FORM ELEMENTS ===== */
        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        input, select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 245, 212, 0.1);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b95a5' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .btn-primary {
            background: #1a2a2a;
            color: #00f5d4;
            border: 1px solid #00f5d4;
            border-radius: 6px;
            box-shadow: none;
        }

        .btn-primary:hover {
            background: #1f3333;
            box-shadow: 0 0 10px rgba(0, 245, 212, 0.2);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-cyan);
        }

        .btn-success {
            background: var(--gradient-green);
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .btn-danger {
            background: var(--gradient-red);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 59, 92, 0.3);
        }

        .btn-warning {
            background: var(--gradient-yellow);
            color: var(--bg-primary);
            box-shadow: 0 4px 15px rgba(255, 200, 0, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 0.95rem;
        }

        .btn-block {
            width: 100%;
        }

        /* ===== ACTION BUTTONS (Clean Dark Style) ===== */
        .action-btn {
            width: auto;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .action-btn-dark {
            background: #1e2433;
            border: 1px solid #2a3244;
            border-right: 3px solid #3b82f6;
        }

        .action-btn-dark:hover {
            background: #252d3f;
            border-color: #3b82f6;
        }

        .action-btn-primary {
            background: #0d9488;
            border: 1px solid #14b8a6;
            border-right: 3px solid #2dd4bf;
        }

        .action-btn-primary:hover {
            background: #0f766e;
            border-color: #2dd4bf;
        }

        .action-btn-icon {
            font-size: 0.75rem;
        }

        .action-btn-text {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .action-btn-primary .action-btn-text {
            color: white;
        }

        .action-btn-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .trade-tf-btn {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trade-tf-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .trade-tf-btn.selected {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }

        /* ===== FILTER BUTTONS ===== */
        .filter-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
            font-weight: 600;
        }

        /* ===== SCAN RESULT ROWS ===== */
        .scan-result-row {
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .scan-result-row:hover {
            background: var(--bg-tertiary);
        }
        .scan-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-cyan);
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* ===== UNIVERSE BUTTONS ===== */
        .universe-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.7rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .universe-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        /* ===== SIGNAL BADGES ===== */
        .signal {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .signal-long {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .signal-short {
            background: rgba(255, 59, 92, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(255, 59, 92, 0.3);
            box-shadow: 0 0 20px rgba(255, 59, 92, 0.1);
        }

        .signal-yellow {
            background: rgba(255, 200, 0, 0.15);
            color: var(--accent-yellow);
            border: 1px solid rgba(255, 200, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 200, 0, 0.1);
        }

        .signal-neutral {
            background: rgba(139, 149, 165, 0.15);
            color: var(--text-secondary);
            border: 1px solid rgba(139, 149, 165, 0.3);
        }

        /* ===== SCORE BARS ===== */
        .score-container {
            margin: 1rem 0;
        }

        .score-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .score-label {
            width: 60px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .score-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
        }

        .score-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .score-fill.bull {
            background: var(--gradient-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .score-fill.bear {
            background: var(--gradient-red);
            box-shadow: 0 0 10px rgba(255, 59, 92, 0.5);
        }

        .score-value {
            width: 50px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ===== DATA TABLE ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-primary);
        }

        .data-table td {
            padding: 0.875rem 1rem;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table tr:hover td {
            background: rgba(0, 245, 212, 0.03);
        }

        .data-table .symbol-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .data-table .number-cell {
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== WATCHLIST PILLS ===== */
        .watchlist-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .watchlist-pill {
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .watchlist-pill:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .watchlist-pill.active {
            background: rgba(0, 245, 212, 0.15);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* ===== ITEM CARDS (Alerts/Trades) ===== */
        .item-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .item-card:hover {
            border-color: var(--border-default);
            background: var(--bg-tertiary);
        }

        .item-card .details {
            flex: 1;
        }

        .item-card .symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 0.95rem;
        }

        .item-card .meta {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .item-card .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ===== MTF GRID ===== */
        .mtf-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .mtf-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .mtf-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .mtf-card:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
        }

        .mtf-card .tf-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
        }

        .mtf-card .signal-display {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .mtf-card .signal-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .mtf-card .signal-text.long { color: var(--accent-green); }
        .mtf-card .signal-text.short { color: var(--accent-red); }
        .mtf-card .signal-text.yellow { color: var(--accent-yellow); }
        .mtf-card .signal-text.neutral { color: var(--text-muted); }

        .mtf-card .confidence {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* ===== QUICK ANALYZE ROW ===== */
        .analyze-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .analyze-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }

        .analyze-row .btn {
            height: 44px;
        }

        /* ===== RESULTS DISPLAY ===== */
        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .results-symbol {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .results-symbol h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            color: var(--accent-cyan);
        }

        .results-symbol .price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        @media (max-width: 768px) {
            .level-grid { grid-template-columns: repeat(2, 1fr); }
        }

        .level-box {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .level-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .level-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .level-value.vah { color: var(--accent-red); }
        .level-value.poc { color: var(--accent-yellow); }
        .level-value.val { color: var(--accent-green); }
        .level-value.vwap { color: var(--accent-cyan); }

        /* ===== LOADING STATE ===== */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 3rem;
            color: var(--text-muted);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 0.9rem;
        }

        /* ===== RANGE WATCHER SPECIFIC ===== */
        .range-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .range-table th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-subtle);
        }

        .range-table td {
            padding: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .structure-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .structure-badge.bullish {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
        }

        .structure-badge.bearish {
            background: rgba(255, 59, 92, 0.15);
            color: var(--accent-red);
        }

        .structure-badge.neutral {
            background: rgba(139, 149, 165, 0.15);
            color: var(--text-muted);
        }

        /* ===== POSITION GAUGE ===== */
        .position-gauge {
            height: 6px;
            background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow), var(--accent-green));
            border-radius: 3px;
            position: relative;
            margin: 0.5rem 0;
        }

        .position-marker {
            position: absolute;
            top: -4px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* ===== SETTINGS SECTION ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .settings-grid { grid-template-columns: 1fr; }
        }

        .api-key-input {
            display: flex;
            gap: 0.5rem;
        }

        .api-key-input input {
            flex: 1;
        }

        /* ===== WORKFLOW SECTION ===== */
        .workflow-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .workflow-stat {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
        }

        .workflow-stat .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }

        .workflow-stat .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .mental-state-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .mental-state-indicator.green {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .mental-state-indicator.yellow {
            background: rgba(255, 200, 0, 0.1);
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .mental-state-indicator.red {
            background: rgba(255, 59, 92, 0.1);
            border: 1px solid rgba(255, 59, 92, 0.3);
        }

        .mental-state-text {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .mental-state-indicator.green .mental-state-text { color: var(--accent-green); }
        .mental-state-indicator.yellow .mental-state-text { color: var(--accent-yellow); }
        .mental-state-indicator.red .mental-state-text { color: var(--accent-red); }

        /* ===== FOOTER ===== */
        footer {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
        }

        footer span {
            color: var(--accent-cyan);
        }

        /* ===== HIDDEN BY DEFAULT ===== */
        .hidden {
            display: none !important;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--bg-tertiary);
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="logo-section">
            <div class="logo">
                <div class="logo-text"><span>S.E.F.</span> STRATEGIC EDGE FLOW</div>
            </div>
        </div>
        
        <div class="header-center">
            <div class="market-clock">
                <span>Market:</span>
                <span class="clock-time" id="market-time">--:--:--</span>
            </div>
            <div class="market-status" id="market-status">
                <div class="status-dot"></div>
                <span>CHECKING...</span>
            </div>
        </div>
        
        <div class="header-right">
            <!-- Shared Trades Notification Bell -->
            <button class="notification-bell" id="shared-trades-bell" onclick="showSharedTrades()" title="Shared Trade Ideas">
                üîî
                <span class="notification-badge" id="shared-trades-count" style="display: none;">0</span>
            </button>
            
            <div class="user-info" id="user-info" style="display: none; margin-right: 1rem; font-size: 0.8rem;">
                <span id="user-tier" style="background: var(--accent-cyan); color: var(--bg-primary); padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600; margin-right: 0.5rem;">FREE</span>
                <span id="user-name" style="color: var(--text-secondary);"></span>
                <button onclick="logout()" style="margin-left: 0.75rem; background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Logout</button>
            </div>
            <div class="connection-badge disconnected" id="connection-badge">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav>
        <button class="active" onclick="showSection('scanner')">
            <span class="nav-icon">üìä</span>
            Scanner
        </button>
        <button onclick="showSection('rangewatcher')">
            <span class="nav-icon">üìà</span>
            Range Watcher
        </button>
        <button onclick="showSection('workflow')">
            <span class="nav-icon">üß†</span>
            Workflow
        </button>
        <button onclick="showSection('watchlists')">
            <span class="nav-icon">üìã</span>
            Watchlists
        </button>
        <button onclick="showSection('alerts')">
            <span class="nav-icon">üö®</span>
            Alerts
        </button>
        <button onclick="showSection('trades')">
            <span class="nav-icon">üíπ</span>
            Trades
        </button>
        <button onclick="showSection('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            Settings
        </button>
    </nav>

    <!-- MAIN CONTENT -->
    <main>
        <!-- ===== SCANNER SECTION ===== -->
        <section id="scanner" class="section active">
            <!-- Quick Stats Row -->
            <div class="stats-row" id="quick-stats">
                <div class="stat-card cyan">
                    <div class="stat-label">Data Source</div>
                    <div class="stat-value cyan" id="stat-source">--</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Active Alerts</div>
                    <div class="stat-value" id="stat-alerts">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">Pending Trades</div>
                    <div class="stat-value" id="stat-trades">0</div>
                </div>
                <div class="stat-card purple" style="--before-color: var(--accent-purple);">
                    <div class="stat-label">Watchlists</div>
                    <div class="stat-value" id="stat-watchlists">0</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Quick Analyze Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">‚ö°</div>
                            <div>
                                Quick Analyze
                                <div class="card-subtitle">Real-time data analysis</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analyze-row">
                        <div class="input-group">
                            <label class="input-label">Symbol</label>
                            <input type="text" id="quick-symbol" placeholder="META, AAPL, NVDA...">
                        </div>
                        <div class="input-group" style="width: 140px;">
                            <label class="input-label">Timeframe</label>
                            <select id="quick-tf">
                                <option value="30MIN">30 min</option>
                                <option value="1HR" selected>1 hour</option>
                                <option value="2HR">2 hour</option>
                                <option value="4HR">4 hour</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="quickAnalyze()">
                            <span style="display: inline-block; width: 8px; height: 8px; background: #00f5d4; border-radius: 50%; margin-right: 6px;"></span>ANALYZE
                        </button>
                    </div>
                    
                    <div class="action-btn-container">
                        <button class="action-btn action-btn-dark" onclick="quickMTF()">
                            <span class="action-btn-icon">üìä</span>
                            <span class="action-btn-text">FULL MTF ANALYSIS</span>
                        </button>
                        <button class="action-btn action-btn-primary" onclick="fullAnalysis()">
                            <span class="action-btn-icon">üéØ</span>
                            <span class="action-btn-text">COMPLETE ANALYSIS</span>
                        </button>
                    </div>
                </div>

                <!-- Manual Input Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon purple">‚úèÔ∏è</div>
                            <div>
                                Manual Chart Input
                                <div class="card-subtitle">Enter values from your charting platform</div>
                            </div>
                        </div>
                    </div>
                    
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                        Input values directly from TradingView, ToS, or any charting platform for instant analysis.
                    </p>
                    
                    <button class="btn btn-secondary btn-block" onclick="showManualInput()">
                        Open Input Form
                    </button>
                </div>
            </div>

            <!-- Results Display -->
            <div class="card hidden" id="results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon green">üìä</div>
                        <div>Analysis Results</div>
                    </div>
                </div>
                <div id="results-container"></div>
            </div>

            <!-- MTF Results -->
            <div class="card hidden" id="mtf-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon cyan">üîÑ</div>
                        <div>Multi-Timeframe Analysis</div>
                    </div>
                </div>
                <div id="mtf-results-container"></div>
            </div>
            
            <!-- Full Analysis Results -->
            <div class="card hidden" id="full-analysis-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));">üß†</div>
                        <div>Complete Analysis</div>
                    </div>
                </div>
                <div id="full-analysis-container"></div>
            </div>
        </section>

        <!-- ===== RANGE WATCHER SECTION ===== -->
        <section id="rangewatcher" class="section">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">üìà</div>
                            <div>
                                Structure Analysis
                                <div class="card-subtitle">Multi-period HH/HL/LH/LL swing detection</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analyze-row">
                        <div class="input-group">
                            <label class="input-label">Symbol</label>
                            <input type="text" id="range-symbol" placeholder="AAPL, SPY, META...">
                        </div>
                        <button class="btn btn-primary" onclick="analyzeRange()">Analyze</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon yellow">‚ö°</div>
                            <div>
                                Compression Scanner
                                <div class="card-subtitle">Find breakout candidates</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analyze-row">
                        <div class="input-group">
                            <label class="input-label">Symbols (comma separated)</label>
                            <input type="text" id="compression-symbols" placeholder="AAPL, TSLA, META, NVDA">
                        </div>
                        <button class="btn btn-warning" onclick="scanCompression()">Scan</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">üü¢</div>
                            <div>
                                Bullish Scanner
                                <div class="card-subtitle">Find LONG setups across symbols</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                        <button class="universe-btn" onclick="loadUniverse('mag7', 'bullish')">Mag 7</button>
                        <button class="universe-btn" onclick="loadUniverse('tech20', 'bullish')">Tech 20</button>
                        <button class="universe-btn" onclick="loadUniverse('sp50', 'bullish')">S&P Top 50</button>
                        <button class="universe-btn" onclick="loadUniverse('etfs', 'bullish')">ETFs</button>
                        <button class="universe-btn" onclick="loadUniverse('meme', 'bullish')">Meme/Retail</button>
                    </div>
                    
                    <div class="analyze-row">
                        <div class="input-group">
                            <label class="input-label">Symbols (comma separated)</label>
                            <input type="text" id="bullish-symbols" placeholder="AAPL, TSLA, META, NVDA, SPY">
                        </div>
                        <div class="input-group" style="width: 120px;">
                            <label class="input-label">Timeframe</label>
                            <select id="bullish-tf">
                                <option value="1HR" selected>1 hour</option>
                                <option value="4HR">4 hour</option>
                                <option value="1D">Daily</option>
                            </select>
                        </div>
                        <button class="btn" style="background: #1a2a1a; color: var(--accent-green); border: 1px solid var(--accent-green);" onclick="scanBullish()">
                            <span style="display: inline-block; width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; margin-right: 6px;"></span>SCAN LONGS
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon red">üî¥</div>
                            <div>
                                Bearish Scanner
                                <div class="card-subtitle">Find SHORT setups across symbols</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                        <button class="universe-btn" onclick="loadUniverse('mag7', 'bearish')">Mag 7</button>
                        <button class="universe-btn" onclick="loadUniverse('tech20', 'bearish')">Tech 20</button>
                        <button class="universe-btn" onclick="loadUniverse('sp50', 'bearish')">S&P Top 50</button>
                        <button class="universe-btn" onclick="loadUniverse('etfs', 'bearish')">ETFs</button>
                        <button class="universe-btn" onclick="loadUniverse('meme', 'bearish')">Meme/Retail</button>
                    </div>
                    
                    <div class="analyze-row">
                        <div class="input-group">
                            <label class="input-label">Symbols (comma separated)</label>
                            <input type="text" id="bearish-symbols" placeholder="AAPL, TSLA, META, NVDA, SPY">
                        </div>
                        <div class="input-group" style="width: 120px;">
                            <label class="input-label">Timeframe</label>
                            <select id="bearish-tf">
                                <option value="1HR" selected>1 hour</option>
                                <option value="4HR">4 hour</option>
                                <option value="1D">Daily</option>
                            </select>
                        </div>
                        <button class="btn" style="background: #2a1a1a; color: var(--accent-red); border: 1px solid var(--accent-red);" onclick="scanBearish()">
                            <span style="display: inline-block; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; margin-right: 6px;"></span>SCAN SHORTS
                        </button>
                    </div>
                </div>
            </div>

            <div class="card hidden" id="range-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon green">üìä</div>
                        <div>Range Analysis Results</div>
                    </div>
                </div>
                <div id="range-results-container"></div>
            </div>

            <div class="card hidden" id="compression-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon yellow">‚ö°</div>
                        <div>Compression Scan Results</div>
                    </div>
                </div>
                <div id="compression-results-container"></div>
            </div>
            
            <div class="card hidden" id="bullish-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon green">üü¢</div>
                        <div>Bullish Scan Results</div>
                    </div>
                </div>
                <div id="bullish-results-container"></div>
            </div>
            
            <div class="card hidden" id="bearish-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon red">üî¥</div>
                        <div>Bearish Scan Results</div>
                    </div>
                </div>
                <div id="bearish-results-container"></div>
            </div>
        </section>

        <!-- ===== WORKFLOW SECTION ===== -->
        <section id="workflow" class="section">
            <div class="mental-state-indicator green" id="mental-state-display">
                <span style="font-size: 2rem;">üü¢</span>
                <div>
                    <div class="mental-state-text">MENTAL STATE: GREEN</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Clear, patient, process-focused</div>
                </div>
            </div>

            <div class="workflow-status">
                <div class="workflow-stat">
                    <div class="value" id="wf-trades">0/4</div>
                    <div class="label">Trades Today</div>
                </div>
                <div class="workflow-stat">
                    <div class="value" style="color: var(--accent-green);" id="wf-pnl">+0.0R</div>
                    <div class="label">Daily P&L</div>
                </div>
                <div class="workflow-stat">
                    <div class="value" id="wf-consec">0</div>
                    <div class="label">Consecutive Losses</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">üß†</div>
                            <div>Mental State Check</div>
                        </div>
                    </div>
                    
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                        Answer honestly before trading. This protects your capital.
                    </p>
                    
                    <button class="btn btn-primary btn-block" onclick="runMentalCheck()">
                        Start Mental Check
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">‚úÖ</div>
                            <div>Pre-Trade Gate Check</div>
                        </div>
                    </div>
                    
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                        Verify all gates pass before taking any trade.
                    </p>
                    
                    <button class="btn btn-success btn-block" onclick="runPreTradeCheck()">
                        Run Gate Check
                    </button>
                </div>
            </div>

            <div class="card hidden" id="workflow-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon cyan">üìã</div>
                        <div>Gate Check Results</div>
                    </div>
                </div>
                <div id="workflow-results-container"></div>
            </div>
        </section>

        <!-- ===== WATCHLISTS SECTION ===== -->
        <section id="watchlists" class="section">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">üìã</div>
                            <div>My Watchlists</div>
                        </div>
                    </div>
                    
                    <div id="watchlist-pills" class="watchlist-pills"></div>
                    
                    <div id="watchlist-symbols" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 1rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px;"></div>
                    
                    <div class="analyze-row" style="margin-top: 1rem;">
                        <div class="input-group" style="width: 140px;">
                            <label class="input-label">Timeframe</label>
                            <select id="scan-tf">
                                <option value="30MIN">30 min</option>
                                <option value="1HR" selected>1 hour</option>
                                <option value="2HR">2 hour</option>
                                <option value="4HR">4 hour</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="scanWatchlist()">
                            <span style="display: inline-block; width: 8px; height: 8px; background: #00f5d4; border-radius: 50%; margin-right: 6px;"></span>SCAN
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">‚ûï</div>
                            <div>Manage Watchlists</div>
                        </div>
                    </div>
                    
                    <!-- Create New Watchlist -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Create New Watchlist</div>
                        <div class="analyze-row">
                            <div class="input-group" style="flex: 1;">
                                <input type="text" id="new-watchlist-name" placeholder="My Favorites">
                            </div>
                            <button class="btn btn-secondary" onclick="createWatchlist()">Create</button>
                        </div>
                    </div>
                    
                    <!-- Add Symbol to Watchlist -->
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Add Symbol</div>
                        <div class="analyze-row">
                            <div class="input-group" style="flex: 1;">
                                <input type="text" id="add-symbol-input" placeholder="AAPL, META, NVDA">
                            </div>
                            <button class="btn btn-secondary" onclick="addSymbolToWatchlist()">+ Add</button>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">Adds to: <span id="add-to-watchlist-name" style="color: var(--accent-cyan);">-</span></div>
                    </div>
                    
                    <!-- Remove Symbol -->
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Remove Symbol</div>
                        <div class="analyze-row">
                            <div class="input-group" style="flex: 1;">
                                <input type="text" id="remove-symbol-input" placeholder="AAPL">
                            </div>
                            <button class="btn btn-secondary" style="border-color: var(--accent-red); color: var(--accent-red);" onclick="removeSymbolFromWatchlist()">‚àí Remove</button>
                        </div>
                    </div>
                    
                    <!-- Delete Watchlist -->
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle);">
                        <button class="btn btn-block" style="background: rgba(255, 59, 92, 0.1); border: 1px solid var(--accent-red); color: var(--accent-red);" onclick="deleteWatchlist()">
                            üóëÔ∏è Delete Selected Watchlist
                        </button>
                    </div>
                </div>
            </div>

            <div class="card hidden" id="scan-results-card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-title-icon green">üîç</div>
                        <div>Scan Results</div>
                    </div>
                </div>
                
                <!-- Filter Controls -->
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Signal:</span>
                        <button class="filter-btn active" data-filter="all" onclick="filterScanResults('all')">All</button>
                        <button class="filter-btn" data-filter="GREEN" onclick="filterScanResults('GREEN')" style="border-color: var(--accent-green);">üü¢</button>
                        <button class="filter-btn" data-filter="YELLOW" onclick="filterScanResults('YELLOW')" style="border-color: var(--accent-yellow);">üü°</button>
                        <button class="filter-btn" data-filter="RED" onclick="filterScanResults('RED')" style="border-color: var(--accent-red);">üî¥</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Min Conf:</span>
                        <select id="min-confidence-filter" onchange="filterScanResults()" style="padding: 0.3rem 0.5rem; font-size: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 4px; color: var(--text-primary);">
                            <option value="0">0%</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                        </select>
                    </div>
                    <div id="scan-filter-count" style="font-size: 0.7rem; color: var(--text-muted); margin-left: auto;"></div>
                </div>
                
                <div id="scan-results-container"></div>
            </div>
        </section>

        <!-- ===== ALERTS SECTION ===== -->
        <section id="alerts" class="section">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">‚ûï</div>
                            <div>Create Alert</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Symbol</label>
                        <input type="text" id="alert-symbol" placeholder="META">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Price Level</label>
                        <input type="number" id="alert-level" placeholder="615.00" step="0.01">
                    </div>
                    
                    <div class="grid-2" style="gap: 1rem;">
                        <div class="input-group">
                            <label class="input-label">Direction</label>
                            <select id="alert-direction">
                                <option value="below">Below (Break Down)</option>
                                <option value="above">Above (Break Up)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Action</label>
                            <select id="alert-action">
                                <option value="SHORT">SHORT Trigger</option>
                                <option value="LONG">LONG Trigger</option>
                                <option value="EXIT">EXIT Signal</option>
                                <option value="ALERT">Alert Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Note (optional)</label>
                        <input type="text" id="alert-note" placeholder="Break of support">
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="createAlert()">
                        Create Alert
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon red">üö®</div>
                            <div>Active Alerts</div>
                        </div>
                    </div>
                    
                    <div id="alerts-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîî</div>
                            <div class="empty-state-text">No active alerts</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== TRADES SECTION ===== -->
        <section id="trades" class="section">
            <div class="stats-row" id="trade-stats">
                <div class="stat-card cyan">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="ts-total">0</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Wins</div>
                    <div class="stat-value green" id="ts-wins">0</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Losses</div>
                    <div class="stat-value red" id="ts-losses">0</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value yellow" id="ts-winrate">0%</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">‚ûï</div>
                            <div>Log Trade</div>
                        </div>
                    </div>
                    
                    <div class="grid-2" style="gap: 1rem;">
                        <div class="input-group">
                            <label class="input-label">Symbol</label>
                            <input type="text" id="trade-symbol" placeholder="META">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Direction</label>
                            <select id="trade-direction">
                                <option value="LONG">LONG</option>
                                <option value="SHORT">SHORT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-3" style="gap: 1rem;">
                        <div class="input-group">
                            <label class="input-label">Entry</label>
                            <input type="number" id="trade-entry" placeholder="620.00" step="0.01">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Stop</label>
                            <input type="number" id="trade-stop" placeholder="615.00" step="0.01">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Target</label>
                            <input type="number" id="trade-target" placeholder="635.00" step="0.01">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Notes</label>
                        <input type="text" id="trade-notes" placeholder="Setup notes...">
                    </div>
                    
                    <button class="btn btn-success btn-block" onclick="logTrade()">
                        Log Trade
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">üìà</div>
                            <div>Pending Trades</div>
                        </div>
                    </div>
                    
                    <div id="trades-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">No pending trades</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== SETTINGS SECTION ===== -->
        <section id="settings" class="section">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon cyan">üîë</div>
                            <div>API Configuration</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Finnhub API Key</label>
                        <div class="api-key-input">
                            <input type="password" id="finnhub-key" placeholder="Enter Finnhub API key">
                            <button class="btn btn-primary" onclick="setFinnhubKey()">Set</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">OpenAI API Key (for AI Commentary)</label>
                        <div class="api-key-input">
                            <input type="password" id="openai-key" placeholder="Enter OpenAI API key">
                            <button class="btn btn-primary" onclick="setOpenAIKey()">Set</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon green">üì°</div>
                            <div>Connection Status</div>
                        </div>
                    </div>
                    
                    <div id="connection-details" style="font-size: 0.85rem; color: var(--text-secondary);">
                        <p>Checking connection status...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer>
        <span>SEF</span> Trading Terminal v2.0 ‚Ä¢ Built for Rob's Trading Systems ‚Ä¢ 
        <span id="footer-time"></span>
    </footer>

    <!-- ===== JAVASCRIPT ===== -->
    <script>
        const API_BASE = 'https://web-production-c71d2.up.railway.app';
        let selectedWatchlist = 'mag7_tech';
        
        // =====================================================================
        // FIREBASE CONFIG - Replace with your Firebase project config
        // =====================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB4oBeoFzFV2oS5ZxEvQ4TIRRVJFC3nl-w",
            authDomain: "analysis-grid.firebaseapp.com",
            projectId: "analysis-grid",
            storageBucket: "analysis-grid.firebasestorage.app",
            messagingSenderId: "633207767657",
            appId: "1:633207767657:web:e623871eca352a268b58f8",
            measurementId: "G-DNWVRX4990"
        };
        
        // Initialize Firebase
        let auth = null;
        let db = null;  // Firestore
        let currentUser = null;
        let authToken = null;
        
        // Set to false to disable auth requirement (for testing)
        const AUTH_REQUIRED = false;
        
        if (firebaseConfig.apiKey !== "YOUR_FIREBASE_API_KEY") {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();  // Initialize Firestore
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    authToken = await user.getIdToken();
                    localStorage.setItem('authToken', authToken);
                    showUserInfo(user);
                    loadSubscriptionStatus();
                    updateSharedTradesBadge(); // Check for shared trades
                } else if (AUTH_REQUIRED) {
                    // Redirect to login
                    window.location.href = 'login.html';
                }
            });
        } else {
            console.log('üîì Auth not configured - running in open mode');
        }
        
        function showUserInfo(user) {
            const el = document.getElementById('user-info');
            if (el) {
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
            }
        }
        
        async function loadSubscriptionStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/payments/subscription`, {
                    headers: { 'uid': currentUser.uid }
                });
                const data = await res.json();
                
                const tierEl = document.getElementById('user-tier');
                if (tierEl) {
                    tierEl.textContent = data.tier.toUpperCase();
                    if (data.tier === 'premium') tierEl.style.background = 'var(--accent-purple)';
                    else if (data.tier === 'pro') tierEl.style.background = 'var(--accent-cyan)';
                    else if (data.tier === 'basic') tierEl.style.background = 'var(--accent-green)';
                    else tierEl.style.background = 'var(--text-muted)';
                }
            } catch (e) {
                console.log('Subscription check skipped');
            }
        }
        
        function logout() {
            if (auth) {
                auth.signOut();
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userUid');
            window.location.href = 'login.html';
        }
        
        // Get auth headers for API calls
        function getAuthHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (currentUser) {
                headers['Authorization'] = `Bearer ${authToken}`;
                headers['uid'] = currentUser.uid;
            }
            return headers;
        }
        
        // Get user ID query param for Firestore storage
        function getUserParam() {
            return currentUser ? `user_id=${currentUser.uid}` : '';
        }
        
        // Build URL with user param
        function withUser(url) {
            if (!currentUser) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}user_id=${currentUser.uid}`;
        }

        // =====================================================================
        // UTILITY FUNCTIONS
        // =====================================================================
        
        function fmtMoney(val, decimals = 2) {
            return '$' + Number(val).toFixed(decimals);
        }
        
        function fmtPercent(val, decimals = 1) {
            return (Number(val) * 100).toFixed(decimals) + '%';
        }
        
        async function fetchJson(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }
        
        function showToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const colors = {
                success: 'var(--accent-green)',
                error: 'var(--accent-red)',
                info: 'var(--accent-cyan)'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                padding: 0.75rem 1.25rem;
                background: var(--bg-elevated);
                border: 1px solid ${colors[type] || colors.info};
                border-left: 3px solid ${colors[type] || colors.info};
                border-radius: 6px;
                color: var(--text-primary);
                font-size: 0.85rem;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            // Show selected
            document.getElementById(sectionId).classList.add('active');
            // Update nav
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            event.target.closest('button').classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'watchlists') loadWatchlists();
            if (sectionId === 'alerts') loadAlerts();
            if (sectionId === 'trades') loadTrades();
            if (sectionId === 'workflow') loadWorkflowStatus();
        }

        function getSignalClass(signal) {
            if (signal.includes('LONG')) return 'signal-long';
            if (signal.includes('SHORT')) return 'signal-short';
            // Everything else (YELLOW, NEUTRAL, etc.) is treated as YELLOW
            return 'signal-yellow';
        }

        function getSignalEmoji(signal) {
            if (signal.includes('LONG')) return 'üü¢';
            if (signal.includes('SHORT')) return 'üî¥';
            // Everything else shows as YELLOW (stoplight system)
            return 'üü°';
        }
        
        function getLeanArrow(bullScore, bearScore) {
            // Show directional lean for YELLOW/NEUTRAL signals
            const diff = (bullScore || 0) - (bearScore || 0);
            if (diff > 5) {
                return '<span style="color: var(--accent-green); font-weight: bold; margin-left: 4px;">‚Üë</span>';
            } else if (diff < -5) {
                return '<span style="color: var(--accent-red); font-weight: bold; margin-left: 4px;">‚Üì</span>';
            }
            return '<span style="color: var(--text-muted); font-weight: bold; margin-left: 4px;">‚Üí</span>';
        }
        
        function getSignalWithLean(signal, bullScore, bearScore) {
            const emoji = getSignalEmoji(signal);
            const signalClass = getSignalClass(signal);
            
            // Normalize signal name - treat NEUTRAL as YELLOW
            let displaySignal = signal;
            if (signal === 'NEUTRAL' || (!signal.includes('LONG') && !signal.includes('SHORT') && !signal.includes('YELLOW'))) {
                displaySignal = 'YELLOW';
            }
            
            // For YELLOW signals, add lean arrow
            if (!signal.includes('LONG') && !signal.includes('SHORT')) {
                const arrow = getLeanArrow(bullScore, bearScore);
                return `<span class="signal ${signalClass}">${emoji} ${displaySignal}${arrow}</span>`;
            }
            
            return `<span class="signal ${signalClass}">${emoji} ${displaySignal}</span>`;
        }

        // =====================================================================
        // CLOCK & STATUS
        // =====================================================================
        
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
            document.getElementById('market-time').textContent = timeStr;
            document.getElementById('footer-time').textContent = now.toLocaleString();
            
            // Check if market is open (simplified - EST 9:30-16:00)
            const hour = now.getHours();
            const isOpen = hour >= 9 && hour < 16;
            const statusEl = document.getElementById('market-status');
            
            if (isOpen) {
                statusEl.classList.remove('closed');
                statusEl.innerHTML = '<div class="status-dot"></div><span>MARKET OPEN</span>';
            } else {
                statusEl.classList.add('closed');
                statusEl.innerHTML = '<div class="status-dot"></div><span>MARKET CLOSED</span>';
            }
        }
        
        setInterval(updateClock, 1000);
        updateClock();

        async function checkStatus() {
            try {
                const data = await fetchJson(`${API_BASE}/api/status`);
                
                const badge = document.getElementById('connection-badge');
                if (data.finnhub_connected || data.polygon_connected || data.alpaca_connected) {
                    badge.className = 'connection-badge connected';
                    badge.innerHTML = '<div class="status-dot"></div><span>Connected</span>';
                } else {
                    badge.className = 'connection-badge disconnected';
                    badge.innerHTML = '<div class="status-dot"></div><span>Disconnected</span>';
                }
                
                // Update stats
                document.getElementById('stat-source').textContent = data.data_source || 'None';
                document.getElementById('stat-alerts').textContent = data.active_alerts || 0;
                document.getElementById('stat-trades').textContent = data.pending_trades || 0;
                document.getElementById('stat-watchlists').textContent = data.watchlists || 0;
                
                // Update connection details
                document.getElementById('connection-details').innerHTML = `
                    <p><strong>Data Source:</strong> ${data.data_source || 'None'}</p>
                    <p><strong>Finnhub:</strong> ${data.finnhub_connected ? '‚úÖ Connected' : '‚ùå Not connected'}</p>
                    <p><strong>ChatGPT:</strong> ${data.chatgpt_enabled ? '‚úÖ Enabled' : '‚ùå Not enabled'}</p>
                    <p><strong>Watchlists:</strong> ${data.watchlists} lists, ${data.total_symbols} symbols</p>
                `;
                
            } catch (e) {
                console.error('Status check failed:', e);
                document.getElementById('connection-badge').className = 'connection-badge disconnected';
                document.getElementById('connection-badge').innerHTML = '<div class="status-dot"></div><span>Offline</span>';
            }
        }

        // =====================================================================
        // SCANNER
        // =====================================================================
        
        async function quickAnalyze() {
            const symbol = document.getElementById('quick-symbol').value.trim().toUpperCase();
            const tf = document.getElementById('quick-tf').value;
            
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('results-card');
            const container = document.getElementById('results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Analyzing...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}`);
                
                container.innerHTML = `
                    <div class="results-header">
                        <div class="results-symbol">
                            <h3>${data.symbol}</h3>
                            <span class="price">${fmtMoney(data.current_price || 0)}</span>
                            ${getSignalWithLean(data.signal, data.bull_score, data.bear_score)}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Confidence</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: 700;">${data.confidence?.toFixed(0) || 0}%</div>
                        </div>
                    </div>
                    
                    <div class="level-grid">
                        <div class="level-box">
                            <div class="level-label">VAH</div>
                            <div class="level-value vah">${fmtMoney(data.vah)}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">POC</div>
                            <div class="level-value poc">${fmtMoney(data.poc)}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">VAL</div>
                            <div class="level-value val">${fmtMoney(data.val)}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">VWAP</div>
                            <div class="level-value vwap">${fmtMoney(data.vwap)}</div>
                        </div>
                    </div>
                    
                    <div class="score-container">
                        <div class="score-row">
                            <span class="score-label">Bull</span>
                            <div class="score-bar">
                                <div class="score-fill bull" style="width: ${data.bull_score || 0}%"></div>
                            </div>
                            <span class="score-value" style="color: var(--accent-green);">${data.bull_score?.toFixed(0) || 0}</span>
                        </div>
                        <div class="score-row">
                            <span class="score-label">Bear</span>
                            <div class="score-bar">
                                <div class="score-fill bear" style="width: ${data.bear_score || 0}%"></div>
                            </div>
                            <span class="score-value" style="color: var(--accent-red);">${data.bear_score?.toFixed(0) || 0}</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                        <div class="level-box">
                            <div class="level-label">Position</div>
                            <div style="font-size: 0.85rem; color: var(--text-primary);">${data.position || '-'}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">RSI</div>
                            <div style="font-family: 'JetBrains Mono'; color: var(--text-primary);">${data.rsi?.toFixed(1) || '-'}</div>
                        </div>
                        <div class="level-box">
                            <div class="level-label">VWAP Zone</div>
                            <div style="font-size: 0.85rem; color: var(--text-primary);">${data.vwap_zone || '-'}</div>
                        </div>
                    </div>
                    
                    ${data.notes && data.notes.length > 0 ? `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Notes</div>
                            ${data.notes.map(n => `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">‚Ä¢ ${n}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="getAICommentary('${data.symbol}', '${tf}')">
                            ü§ñ Get AI Trade Plan
                        </button>
                    </div>
                    
                    <div id="ai-commentary-container"></div>
                `;
                
                // Store current result for potential use
                window.currentResult = data;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function getAICommentary(symbol, timeframe) {
            const container = document.getElementById('ai-commentary-container');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Getting AI trade plan with MTF confluence...</div>';
            
            // Map timeframe to trade_tf for MTF endpoint
            const tfMap = {
                '5min': 'intraday',
                '15min': 'intraday', 
                '1h': 'swing',
                '4h': 'position',
                '1d': 'longterm'
            };
            const tradeTF = tfMap[timeframe] || 'swing';
            
            try {
                // Use MTF endpoint for consistent AI analysis across all views
                const response = await fetch(`${API_BASE}/api/analyze/live/mtf/${symbol}/ai?trade_tf=${tradeTF}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'AI request failed');
                }
                
                const data = await response.json();
                
                // Store for Log Trade / Set Alerts
                window.lastAIPlan = data;
                
                if (data.ai_commentary) {
                    // Parse for buttons
                    const entryMatch = data.ai_commentary.match(/ENTRY(?:\s*ZONE)?[:\s]*\$?([\d.]+)/i);
                    const stopMatch = data.ai_commentary.match(/STOP(?:\s*LOSS)?[:\s]*\$?([\d.]+)/i);
                    const biasMatch = data.ai_commentary.match(/(?:TRADE\s*)?BIAS[:\s]*(LONG|SHORT|NO\s*TRADE)/i);
                    
                    const parsed = {
                        bias: biasMatch ? biasMatch[1].replace(/\s+/g, '') : 'NOTRADE',
                        entry: entryMatch ? parseFloat(entryMatch[1]) : 0,
                        stop: stopMatch ? parseFloat(stopMatch[1]) : 0
                    };
                    window.lastAIPlan.parsed = parsed;
                    
                    const showButtons = parsed.bias !== 'NOTRADE' && parsed.entry > 0;
                    
                    container.innerHTML = `
                        <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 245, 212, 0.05) 100%); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.25rem;">ü§ñ</span>
                                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--accent-green);">AI TRADE PLAN (MTF)</span>
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${data.high_prob?.toFixed(0) || 50}% High / ${data.low_prob?.toFixed(0) || 50}% Low</div>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-primary); line-height: 1.7; white-space: pre-line;">${data.ai_commentary}</div>
                            ${showButtons ? `
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); flex-wrap: wrap;">
                                <button class="btn" style="background: var(--accent-green); color: var(--bg-primary);" onclick="logAITrade()">üìã Log Trade</button>
                                <button class="btn" style="background: var(--accent-purple); color: white;" onclick="setAIAlerts()">üîî Set Alerts</button>
                                <button class="btn" style="background: var(--accent-cyan); color: var(--bg-primary);" onclick="shareTrade()">üì§ Share Trade</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem;">No AI commentary available. Check if OpenAI API key is set.</div>';
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function fullAnalysis() {
            const symbol = document.getElementById('quick-symbol').value.trim().toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('full-analysis-card');
            const container = document.getElementById('full-analysis-container');
            
            // Hide other result cards
            document.getElementById('results-card').classList.add('hidden');
            document.getElementById('mtf-results-card').classList.add('hidden');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Running complete analysis (MTF + Range + AI)...</div>';
            
            try {
                // Fetch MTF and Range data in parallel
                const [mtfData, rangeData] = await Promise.all([
                    fetchJson(`${API_BASE}/api/analyze/live/mtf/${symbol}`),
                    fetchJson(`${API_BASE}/api/range/analyze/${symbol}/ai`)
                ]);
                
                // Build MTF cards
                const tfCards = Object.entries(mtfData.timeframes || {}).map(([tf, result]) => `
                    <div class="mtf-card">
                        <div class="tf-label">${tf}</div>
                        <div class="signal-display">${getSignalEmoji(result.signal)}</div>
                        <div class="signal-text ${result.signal.toLowerCase().includes('long') ? 'long' : result.signal.toLowerCase().includes('short') ? 'short' : 'yellow'}">${result.signal}</div>
                        <div class="confidence">${result.confidence?.toFixed(0) || 0}%</div>
                    </div>
                `).join('');
                
                // Build period rows for range
                const periodRows = Object.entries(rangeData.periods || {}).map(([period, p]) => `
                    <tr>
                        <td>${period}D</td>
                        <td>${fmtMoney(p.high)}</td>
                        <td>${fmtMoney(p.low)}</td>
                        <td>${p.range_pct?.toFixed(1)}%</td>
                        <td>
                            <span class="structure-badge ${p.structure?.includes('HH') || p.structure?.includes('HL') ? 'bullish' : p.structure?.includes('LH') || p.structure?.includes('LL') ? 'bearish' : 'neutral'}">
                                ${p.structure || '-'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                // Format AI context
                const formattedContext = rangeData.ai_context
                    ? rangeData.ai_context
                        .replace(/‚Ä¢/g, '<span style="color: var(--accent-cyan);">‚Ä¢</span>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary);">$1</strong>')
                        .replace(/\n/g, '<br>')
                    : 'AI context not available';
                
                container.innerHTML = `
                    <!-- Header -->
                    <div class="results-header" style="margin-bottom: 1.5rem;">
                        <div class="results-symbol">
                            <h2 style="font-size: 2rem; margin: 0;">${mtfData.symbol}</h2>
                            ${getSignalWithLean(mtfData.dominant_signal, mtfData.weighted_bull, mtfData.weighted_bear)}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--text-muted);">MTF Confluence</div>
                            <div style="font-family: 'Orbitron', monospace; font-size: 2rem; font-weight: 700; color: ${mtfData.confluence_pct > 70 ? 'var(--accent-green)' : mtfData.confluence_pct > 50 ? 'var(--accent-yellow)' : 'var(--text-muted)'};">${mtfData.confluence_pct?.toFixed(0) || 0}%</div>
                        </div>
                    </div>
                    
                    <!-- MTF Grid -->
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-cyan); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">üìä Multi-Timeframe Signals</div>
                        <div class="mtf-grid">${tfCards}</div>
                        
                        <div style="display: flex; justify-content: space-around; margin-top: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">High Scenario</div>
                                <div style="font-family: 'JetBrains Mono'; font-size: 1.25rem; color: var(--accent-green);">${(mtfData.high_prob || 0).toFixed(0)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Low Scenario</div>
                                <div style="font-family: 'JetBrains Mono'; font-size: 1.25rem; color: var(--accent-red);">${(mtfData.low_prob || 0).toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Range Structure -->
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-purple); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">üìà Range Structure</div>
                        
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div style="flex: 1; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Current Price</div>
                                <div style="font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: 700;">${fmtMoney(rangeData.current_price)}</div>
                            </div>
                            <div style="flex: 1; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Trend</div>
                                <div style="font-size: 1.25rem;">${rangeData.trend_emoji} ${rangeData.trend_structure}</div>
                            </div>
                            <div style="flex: 1; padding: 1rem; background: var(--bg-primary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Range State</div>
                                <div style="font-size: 0.9rem; color: ${rangeData.range_state?.includes('COMPRESSION') ? 'var(--accent-yellow)' : 'var(--text-secondary)'};">${rangeData.range_state}</div>
                            </div>
                        </div>
                        
                        <table class="range-table" style="font-size: 0.85rem;">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Range</th>
                                    <th>Structure</th>
                                </tr>
                            </thead>
                            <tbody>${periodRows}</tbody>
                        </table>
                    </div>
                    
                    <!-- Key Levels -->
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 0.8rem; color: var(--accent-yellow); text-transform: uppercase; font-weight: 600; margin-bottom: 0.75rem; letter-spacing: 1px;">üéØ Key Levels</div>
                        <div class="grid-2">
                            <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--accent-red); text-transform: uppercase; margin-bottom: 0.5rem;">Resistance</div>
                                ${(rangeData.resistance_levels || []).slice(0, 3).map(r => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                        <span style="color: var(--accent-red);">${fmtMoney(r.price)}</span>
                                        <span style="color: var(--text-muted);">${r.description}</span>
                                    </div>
                                `).join('')}
                                ${rangeData.breakout_watch ? `
                                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">Breakout Watch:</span>
                                        <span style="font-family: 'JetBrains Mono'; color: var(--accent-green);"> ${fmtMoney(rangeData.breakout_watch)}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--accent-green); text-transform: uppercase; margin-bottom: 0.5rem;">Support</div>
                                ${(rangeData.support_levels || []).slice(0, 3).map(s => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                        <span style="color: var(--accent-green);">${fmtMoney(s.price)}</span>
                                        <span style="color: var(--text-muted);">${s.description}</span>
                                    </div>
                                `).join('')}
                                ${rangeData.breakdown_watch ? `
                                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">Breakdown Watch:</span>
                                        <span style="font-family: 'JetBrains Mono'; color: var(--accent-red);"> ${fmtMoney(rangeData.breakdown_watch)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Context -->
                    <div style="padding: 1.25rem; background: linear-gradient(135deg, rgba(0,255,200,0.05), rgba(100,100,255,0.05)); border: 1px solid var(--border-color); border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 1.25rem;">üß†</span>
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px;">AI Technical Context</span>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;">
                            ${formattedContext}
                        </div>
                        <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
                            ‚ö†Ô∏è Technical observations only - not trade advice
                        </div>
                    </div>
                    
                    <!-- Trade Planning -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--accent-cyan); margin-bottom: 0.75rem; text-transform: uppercase; font-weight: 600;">Ready to Trade? Get AI Trade Plan</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="trade-tf-btn" data-tf="intraday" onclick="selectTradeTF(this, '${mtfData.symbol}')">üìÖ Same Day</button>
                            <button class="trade-tf-btn" data-tf="swing" onclick="selectTradeTF(this, '${mtfData.symbol}')">üìä 3-5 Days</button>
                            <button class="trade-tf-btn" data-tf="position" onclick="selectTradeTF(this, '${mtfData.symbol}')">üìà 2 Weeks</button>
                            <button class="trade-tf-btn" data-tf="longterm" onclick="selectTradeTF(this, '${mtfData.symbol}')">üéØ 30+ Days</button>
                        </div>
                    </div>
                    
                    <div id="full-ai-container" style="margin-top: 1rem;"></div>
                    
                    <!-- TradingView Link -->
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <a href="https://www.tradingview.com/chart/?symbol=${mtfData.symbol}" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                            üì∫ Open in TradingView
                        </a>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function quickMTF() {
            const symbol = document.getElementById('quick-symbol').value.trim().toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('mtf-results-card');
            const container = document.getElementById('mtf-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Running MTF analysis...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/analyze/live/mtf/${symbol}`);
                
                const tfCards = Object.entries(data.timeframes || {}).map(([tf, result]) => `
                    <div class="mtf-card">
                        <div class="tf-label">${tf}</div>
                        <div class="signal-display">${getSignalEmoji(result.signal)}</div>
                        <div class="signal-text ${result.signal.toLowerCase().includes('long') ? 'long' : result.signal.toLowerCase().includes('short') ? 'short' : result.signal.toLowerCase().includes('yellow') ? 'yellow' : 'neutral'}">${result.signal}</div>
                        <div class="confidence">${result.confidence?.toFixed(0) || 0}% confidence</div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="results-header">
                        <div class="results-symbol">
                            <h3>${data.symbol}</h3>
                            ${getSignalWithLean(data.dominant_signal, data.weighted_bull, data.weighted_bear)}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Confluence</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 1.5rem; font-weight: 700;">${data.confluence?.toFixed(0) || 0}%</div>
                        </div>
                    </div>
                    
                    <div class="mtf-grid">${tfCards}</div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; display: flex; justify-content: space-around;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">High Scenario</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 1.25rem; color: var(--accent-green);">${(data.high_prob || 0).toFixed(0)}%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Low Scenario</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 1.25rem; color: var(--accent-red);">${(data.low_prob || 0).toFixed(0)}%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Neutral</div>
                            <div style="font-family: 'JetBrains Mono'; font-size: 1.25rem; color: var(--accent-yellow);">${(100 - (data.high_prob || 0) - (data.low_prob || 0)).toFixed(0)}%</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--accent-cyan); margin-bottom: 0.75rem; text-transform: uppercase; font-weight: 600;">Select Trade Timeframe for AI Analysis</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="trade-tf-btn" data-tf="intraday" onclick="selectTradeTF(this, '${data.symbol}')">üìÖ Same Day</button>
                            <button class="trade-tf-btn" data-tf="swing" onclick="selectTradeTF(this, '${data.symbol}')">üìä 3-5 Days</button>
                            <button class="trade-tf-btn" data-tf="position" onclick="selectTradeTF(this, '${data.symbol}')">üìà 2 Weeks</button>
                            <button class="trade-tf-btn" data-tf="longterm" onclick="selectTradeTF(this, '${data.symbol}')">üéØ 30+ Days</button>
                        </div>
                    </div>
                    
                    <div id="mtf-ai-container" style="margin-top: 1rem;"></div>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }

        function selectTradeTF(btn, symbol) {
            console.log('selectTradeTF called with symbol:', symbol);
            
            // Update button styles
            document.querySelectorAll('.trade-tf-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Get selected timeframe and call AI
            const tradeTF = btn.getAttribute('data-tf');
            console.log('Trade TF:', tradeTF);
            getMTFAICommentary(symbol, tradeTF);
        }

        async function getMTFAICommentary(symbol, tradeTF = 'swing') {
            console.log('getMTFAICommentary called:', symbol, tradeTF);
            
            // Try both possible container IDs (MTF view and Full Analysis view)
            let container = document.getElementById('mtf-ai-container') || document.getElementById('full-ai-container');
            
            console.log('Container found:', container ? container.id : 'NONE');
            
            if (!container) {
                console.error('No AI container found');
                return;
            }
            
            const tfLabels = {
                'intraday': 'Same Day (Intraday)',
                'swing': '3-5 Day Swing',
                'position': '2 Week Position',
                'longterm': '30+ Day Setup'
            };
            
            container.innerHTML = `<div class="loading-spinner" style="margin: 1rem auto;"></div><div style="text-align: center; color: var(--text-muted);">Generating ${tfLabels[tradeTF]} AI trade plan...</div>`;
            
            try {
                // Use the new MTF AI endpoint with trade timeframe
                const response = await fetch(`${API_BASE}/api/analyze/live/mtf/${symbol}/ai?trade_tf=${tradeTF}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'AI request failed');
                }
                
                const data = await response.json();
                
                // Store the AI plan data for logging
                window.lastAIPlan = data;
                
                if (data.ai_commentary) {
                    // Parse entry/stop/targets from AI commentary (handle emojis and various formats)
                    const entryMatch = data.ai_commentary.match(/ENTRY(?:\s*ZONE)?[:\s]*\$?([\d.]+)\s*-?\s*\$?([\d.]+)?/i);
                    const stopMatch = data.ai_commentary.match(/STOP(?:\s*LOSS)?[:\s]*\$?([\d.]+)/i);
                    const t1Match = data.ai_commentary.match(/TARGET\s*1[:\s]*\$?([\d.]+)/i);
                    const t2Match = data.ai_commentary.match(/TARGET\s*2[:\s]*\$?([\d.]+)/i);
                    const biasMatch = data.ai_commentary.match(/(?:TRADE\s*)?BIAS[:\s]*(LONG|SHORT|NO\s*TRADE)/i);
                    
                    const parsed = {
                        bias: biasMatch ? biasMatch[1].replace(/\s+/g, '') : 'NOTRADE',
                        entry: entryMatch ? parseFloat(entryMatch[1]) : 0,
                        stop: stopMatch ? parseFloat(stopMatch[1]) : 0,
                        target1: t1Match ? parseFloat(t1Match[1]) : 0,
                        target2: t2Match ? parseFloat(t2Match[1]) : 0
                    };
                    
                    window.lastAIPlan.parsed = parsed;
                    console.log('Parsed AI Plan:', parsed);
                    
                    const showButtons = parsed.bias !== 'NOTRADE' && parsed.entry > 0;
                    
                    container.innerHTML = `
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; border-left: 3px solid var(--accent-cyan);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.75rem; color: var(--accent-cyan); font-weight: 600;">ü§ñ ${data.trade_timeframe || 'MTF'} AI TRADE PLAN</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${data.high_prob?.toFixed(0)}% High / ${data.low_prob?.toFixed(0)}% Low</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">PRICE</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--text-primary);">$${data.current_price?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">VAH</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-green);">$${data.vah?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">POC</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-yellow);">$${data.poc?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">VAL</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-red);">$${data.val?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">RSI</div>
                                    <div style="font-family: 'JetBrains Mono'; font-size: 0.85rem; color: ${data.rsi < 30 ? 'var(--accent-green)' : data.rsi > 70 ? 'var(--accent-red)' : 'var(--text-primary)'};">${data.rsi?.toFixed(1) || '50.0'}</div>
                                </div>
                            </div>
                            
                            <div style="white-space: pre-wrap; font-size: 0.85rem; line-height: 1.6; color: var(--text-primary);">${data.ai_commentary}</div>
                            
                            ${showButtons ? `
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); flex-wrap: wrap;">
                                <button class="btn" style="background: var(--accent-green); color: var(--bg-primary);" onclick="logAITrade()">üìã Log Trade</button>
                                <button class="btn" style="background: var(--accent-purple); color: white;" onclick="setAIAlerts()">üîî Set Alerts</button>
                                <button class="btn" style="background: var(--accent-cyan); color: var(--bg-primary);" onclick="shareTrade()">üì§ Share Trade</button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    console.log('‚úÖ AI container innerHTML SET - check if visible');
                    console.log('Container element:', container);
                    console.log('Container offsetHeight:', container.offsetHeight);
                } else {
                    container.innerHTML = '<div style="color: var(--accent-yellow); padding: 0.5rem;">No AI commentary available. Check if OpenAI API key is set.</div>';
                    console.log('‚ö†Ô∏è No AI commentary in response');
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 0.5rem;">AI Error: ${e.message}</div>`;
            }
        }
        
        async function logAITrade() {
            if (!window.lastAIPlan || !window.lastAIPlan.parsed) {
                alert('No trade plan to log');
                return;
            }
            
            const plan = window.lastAIPlan;
            const parsed = plan.parsed;
            
            try {
                const tradeData = {
                    symbol: plan.symbol.toUpperCase(),
                    direction: parsed.bias,
                    timeframe: plan.trade_timeframe || 'SWING',
                    entry: parsed.entry,
                    stop: parsed.stop,
                    target: parsed.target1,
                    target2: parsed.target2,
                    signal: plan.dominant_signal || '',
                    confidence: plan.confluence_pct || plan.confluence || 0,
                    ai_commentary: plan.ai_commentary || '',
                    vah: plan.vah || 0,
                    poc: plan.poc || 0,
                    val: plan.val || 0,
                    rsi: plan.rsi || 0,
                    notes: `AI Trade Plan - ${plan.trade_timeframe || 'SWING'}`,
                    status: 'pending',
                    pnl: 0,
                    created_at: new Date().toISOString()
                };
                
                console.log('Logging trade to Firestore:', tradeData);
                console.log('currentUser:', currentUser?.uid);
                console.log('db available:', !!db);
                
                // Use Firestore if logged in
                if (currentUser && db) {
                    try {
                        const docRef = await db.collection('users').doc(currentUser.uid).collection('trades').add(tradeData);
                        console.log('‚úÖ Trade saved with ID:', docRef.id);
                        alert(`‚úÖ Trade logged! ID: ${docRef.id}`);
                        loadTrades();
                    } catch (fsErr) {
                        console.error('Firestore write error:', fsErr);
                        alert(`‚ùå Firestore error: ${fsErr.message}`);
                    }
                } else {
                    console.log('Not logged in - using API fallback');
                    // Fallback to API
                    const response = await fetch(`${API_BASE}/api/journal/log`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tradeData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ Trade logged! ID: ${result.id}`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }
            } catch (e) {
                console.error('Log trade error:', e);
                alert(`‚ùå Error logging trade: ${e.message}`);
            }
        }
        
        async function setAIAlerts() {
            if (!window.lastAIPlan || !window.lastAIPlan.parsed) {
                alert('No trade plan for alerts');
                return;
            }
            
            const plan = window.lastAIPlan;
            const parsed = plan.parsed;
            
            try {
                const symbol = plan.symbol.toUpperCase();
                const is_long = parsed.bias.toUpperCase() === 'LONG';
                const tf = plan.trade_timeframe || 'SWING';
                let alertsCreated = 0;
                
                // Use Firestore if logged in
                if (currentUser && db) {
                    const alertsRef = db.collection('users').doc(currentUser.uid).collection('alerts');
                    const now = new Date().toISOString();
                    
                    // Entry alert
                    if (parsed.entry > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.entry,
                            direction: is_long ? 'below' : 'above',
                            action: is_long ? 'LONG' : 'SHORT',
                            note: `üìç ${tf} Entry Zone`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    // Stop loss alert
                    if (parsed.stop > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.stop,
                            direction: is_long ? 'below' : 'above',
                            action: 'EXIT',
                            note: `üõë ${tf} Stop Loss`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    // Target 1 alert
                    if (parsed.target1 > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.target1,
                            direction: is_long ? 'above' : 'below',
                            action: 'ALERT',
                            note: `üéØ ${tf} Target 1`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    // Target 2 alert
                    if (parsed.target2 > 0) {
                        await alertsRef.add({
                            symbol: symbol,
                            level: parsed.target2,
                            direction: is_long ? 'above' : 'below',
                            action: 'ALERT',
                            note: `üéØ ${tf} Target 2`,
                            created_at: now,
                            triggered: false
                        });
                        alertsCreated++;
                    }
                    
                    alert(`üîî ${alertsCreated} Alerts set!\n‚Ä¢ Entry: $${parsed.entry.toFixed(2)}\n‚Ä¢ Stop: $${parsed.stop.toFixed(2)}\n‚Ä¢ T1: $${parsed.target1.toFixed(2)}\n‚Ä¢ T2: $${parsed.target2.toFixed(2)}`);
                    loadAlerts();
                } else {
                    // Fallback to API
                    const payload = {
                        symbol: symbol,
                        direction: parsed.bias,
                        entry: parsed.entry,
                        stop: parsed.stop,
                        target1: parsed.target1,
                        target2: parsed.target2,
                        trade_timeframe: tf
                    };
                    
                    const response = await fetch(`${API_BASE}/api/alerts/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`üîî ${result.alerts_created} Alerts set!\n‚Ä¢ Entry: $${parsed.entry.toFixed(2)}\n‚Ä¢ Stop: $${parsed.stop.toFixed(2)}\n‚Ä¢ T1: $${parsed.target1.toFixed(2)}\n‚Ä¢ T2: $${parsed.target2.toFixed(2)}`);
                        loadAlerts();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                }
            } catch (e) {
                console.error('Set alerts error:', e);
                alert(`‚ùå Error setting alerts: ${e.message}`);
            }
        }

        function showManualInput() {
            alert('Manual input form - implement modal or expand card');
        }

        // =====================================================================
        // RANGE WATCHER
        // =====================================================================
        
        async function analyzeRange() {
            const symbol = document.getElementById('range-symbol').value.trim().toUpperCase();
            if (!symbol) return alert('Enter a symbol');
            
            const card = document.getElementById('range-results-card');
            const container = document.getElementById('range-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Analyzing structure...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/analyze/${symbol}`);
                
                const periodRows = Object.entries(data.periods || {}).map(([period, p]) => `
                    <tr>
                        <td>${period}D</td>
                        <td>${fmtMoney(p.high)}</td>
                        <td>${fmtMoney(p.low)}</td>
                        <td>${p.range_pct?.toFixed(1)}%</td>
                        <td>
                            <div class="position-gauge">
                                <div class="position-marker" style="left: ${(p.position_in_range * 100).toFixed(0)}%"></div>
                            </div>
                        </td>
                        <td>
                            <span class="structure-badge ${p.structure?.includes('HH') || p.structure?.includes('HL') ? 'bullish' : p.structure?.includes('LH') || p.structure?.includes('LL') ? 'bearish' : 'neutral'}">
                                ${p.structure || '-'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div class="results-header">
                        <div class="results-symbol">
                            <h3>${data.symbol}</h3>
                            <span class="price">${fmtMoney(data.current_price)}</span>
                        </div>
                        <div style="text-align: right;">
                            <div class="signal ${data.trend_bias === 'BULLISH' ? 'signal-long' : data.trend_bias === 'BEARISH' ? 'signal-short' : 'signal-yellow'}">
                                ${data.trend_emoji || ''} ${data.trend_structure}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
                                Strength: ${data.trend_strength?.toFixed(0) || 0}
                            </div>
                        </div>
                    </div>
                    
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>High</th>
                                <th>Low</th>
                                <th>Range</th>
                                <th>Position</th>
                                <th>Structure</th>
                            </tr>
                        </thead>
                        <tbody>${periodRows}</tbody>
                    </table>
                    
                    <div class="grid-2" style="margin-top: 1.5rem;">
                        <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Resistance Levels</div>
                            ${(data.resistance_levels || []).slice(0, 3).map(r => `
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--accent-red); margin-bottom: 0.25rem;">
                                    <span>${fmtMoney(r.price)}</span>
                                    <span style="color: var(--text-muted);">${r.description}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Support Levels</div>
                            ${(data.support_levels || []).slice(0, 3).map(s => `
                                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--accent-green); margin-bottom: 0.25rem;">
                                    <span>${fmtMoney(s.price)}</span>
                                    <span style="color: var(--text-muted);">${s.description}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${data.notes && data.notes.length > 0 ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">Notes</div>
                            ${data.notes.map(n => `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">‚Ä¢ ${n}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-primary" onclick="getRangeAIContext('${data.symbol}')">
                            üß† Get AI Technical Context
                        </button>
                    </div>
                    
                    <div id="range-ai-container" style="margin-top: 1rem;"></div>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function getRangeAIContext(symbol) {
            const container = document.getElementById('range-ai-container');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Generating AI technical context...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/analyze/${symbol}/ai`);
                
                if (data.ai_context) {
                    // Convert markdown-style bullets to HTML
                    const formattedContext = data.ai_context
                        .replace(/‚Ä¢/g, '<span style="color: var(--accent-cyan);">‚Ä¢</span>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: var(--text-primary);">$1</strong>')
                        .replace(/\n/g, '<br>');
                    
                    container.innerHTML = `
                        <div style="padding: 1.25rem; background: linear-gradient(135deg, rgba(0,255,200,0.05), rgba(100,100,255,0.05)); border: 1px solid var(--border-color); border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.25rem;">üß†</span>
                                <span style="font-size: 0.9rem; font-weight: 600; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 1px;">AI Technical Context</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;">
                                ${formattedContext}
                            </div>
                            <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
                                ‚ö†Ô∏è Technical observations only - not trade advice
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem;">AI context not available</div>';
                }
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">AI Error: ${e.message}</div>`;
            }
        }
        
        async function scanCompression() {
            const symbols = document.getElementById('compression-symbols').value.trim();
            if (!symbols) return alert('Enter symbols');
            
            const card = document.getElementById('compression-results-card');
            const container = document.getElementById('compression-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Scanning for compression...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/range/compression-scan?symbols=${encodeURIComponent(symbols)}`);
                
                const rows = (data.most_compressed || []).map(r => `
                    <tr>
                        <td class="symbol-cell">${r.symbol}</td>
                        <td class="number-cell">${(r.compression_ratio * 100).toFixed(0)}%</td>
                        <td>${r.range_state}</td>
                        <td>
                            <span class="structure-badge ${r.bias === 'BULLISH' ? 'bullish' : r.bias === 'BEARISH' ? 'bearish' : 'neutral'}">
                                ${r.trend}
                            </span>
                        </td>
                        <td class="number-cell">${r.breakout_watch ? fmtMoney(r.breakout_watch) : '-'}</td>
                        <td class="number-cell">${r.breakdown_watch ? fmtMoney(r.breakdown_watch) : '-'}</td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Compression</th>
                                <th>Range State</th>
                                <th>Trend</th>
                                <th>Breakout</th>
                                <th>Breakdown</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function scanBullish() {
            const symbols = document.getElementById('bullish-symbols').value.trim();
            const tf = document.getElementById('bullish-tf').value;
            if (!symbols) return alert('Enter symbols to scan - use the quick-load buttons above!');
            
            const card = document.getElementById('bullish-results-card');
            const container = document.getElementById('bullish-results-container');
            
            card.classList.remove('hidden');
            const symbolList = symbols.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            container.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Scanning ${symbolList.length} symbols for LONG setups...<div id="bullish-progress" style="margin-top: 0.5rem; font-size: 0.8rem;">0/${symbolList.length}</div></div>`;
            
            try {
                const results = [];
                let scanned = 0;
                let skipped = 0;
                const BATCH_SIZE = 8; // Process 8 symbols in parallel
                
                // Process in batches for speed
                for (let i = 0; i < symbolList.length; i += BATCH_SIZE) {
                    const batch = symbolList.slice(i, i + BATCH_SIZE);
                    
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&with_ai=false`);
                            
                            // Include bullish signals OR strong yellow with clear bullish lean
                            const isBullish = data.signal && data.signal.includes('LONG');
                            const scoreGap = (data.bull_score || 0) - (data.bear_score || 0);
                            const isBullishLean = scoreGap >= 15 && data.bull_score >= 45;
                            
                            if (isBullish || isBullishLean) {
                                return {
                                    symbol,
                                    signal: data.signal,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    position: data.position || '-',
                                    vwap_zone: data.vwap_zone || '-'
                                };
                            }
                            return null;
                        } catch (e) {
                            skipped++;
                            return null;
                        }
                    });
                    
                    const batchResults = await Promise.all(batchPromises);
                    batchResults.forEach(r => { if (r) results.push(r); });
                    
                    scanned += batch.length;
                    document.getElementById('bullish-progress').textContent = `${scanned}/${symbolList.length}${skipped ? ` (${skipped} skipped)` : ''}`;
                }
                
                // Sort by confidence descending
                results.sort((a, b) => b.confidence - a.confidence);
                
                if (results.length === 0) {
                    container.innerHTML = `<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No bullish setups found in ${symbolList.length} symbols scanned</div>`;
                    return;
                }
                
                const rows = results.map(r => `
                    <tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor: pointer;">
                        <td class="symbol-cell">${r.symbol}</td>
                        <td>${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}</td>
                        <td class="number-cell">${r.confidence.toFixed(0)}%</td>
                        <td>${r.position}</td>
                        <td>${r.vwap_zone}</td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div style="color: var(--accent-green); font-size: 0.85rem; margin-bottom: 0.75rem;">Found ${results.length} bullish setup(s) in ${symbolList.length} scanned - click row to analyze</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Position</th>
                                <th>VWAP Zone</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        async function scanBearish() {
            const symbols = document.getElementById('bearish-symbols').value.trim();
            const tf = document.getElementById('bearish-tf').value;
            if (!symbols) return alert('Enter symbols to scan - use the quick-load buttons above!');
            
            const card = document.getElementById('bearish-results-card');
            const container = document.getElementById('bearish-results-container');
            
            card.classList.remove('hidden');
            const symbolList = symbols.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            container.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Scanning ${symbolList.length} symbols for SHORT setups...<div id="bearish-progress" style="margin-top: 0.5rem; font-size: 0.8rem;">0/${symbolList.length}</div></div>`;
            
            try {
                const results = [];
                let scanned = 0;
                let skipped = 0;
                const BATCH_SIZE = 8; // Process 8 symbols in parallel
                
                // Process in batches for speed
                for (let i = 0; i < symbolList.length; i += BATCH_SIZE) {
                    const batch = symbolList.slice(i, i + BATCH_SIZE);
                    
                    const batchPromises = batch.map(async (symbol) => {
                        try {
                            const data = await fetchJson(`${API_BASE}/api/analyze/live/${symbol}?timeframe=${tf}&with_ai=false`);
                            
                            // Include bearish signals OR strong yellow with clear bearish lean
                            const isBearish = data.signal && data.signal.includes('SHORT');
                            const scoreGap = (data.bear_score || 0) - (data.bull_score || 0);
                            const isBearishLean = scoreGap >= 15 && data.bear_score >= 45;
                            
                            if (isBearish || isBearishLean) {
                                return {
                                    symbol,
                                    signal: data.signal,
                                    confidence: data.confidence || 0,
                                    bull_score: data.bull_score || 0,
                                    bear_score: data.bear_score || 0,
                                    position: data.position || '-',
                                    vwap_zone: data.vwap_zone || '-'
                                };
                            }
                            return null;
                        } catch (e) {
                            skipped++;
                            return null;
                        }
                    });
                    
                    const batchResults = await Promise.all(batchPromises);
                    batchResults.forEach(r => { if (r) results.push(r); });
                    
                    scanned += batch.length;
                    document.getElementById('bearish-progress').textContent = `${scanned}/${symbolList.length}${skipped ? ` (${skipped} skipped)` : ''}`;
                }
                
                // Sort by confidence descending
                results.sort((a, b) => b.confidence - a.confidence);
                
                if (results.length === 0) {
                    container.innerHTML = `<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No bearish setups found in ${symbolList.length} symbols scanned</div>`;
                    return;
                }
                
                const rows = results.map(r => `
                    <tr onclick="quickAnalyzeSymbol('${r.symbol}')" style="cursor: pointer;">
                        <td class="symbol-cell">${r.symbol}</td>
                        <td>${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}</td>
                        <td class="number-cell">${r.confidence.toFixed(0)}%</td>
                        <td>${r.position}</td>
                        <td>${r.vwap_zone}</td>
                    </tr>
                `).join('');
                
                container.innerHTML = `
                    <div style="color: var(--accent-red); font-size: 0.85rem; margin-bottom: 0.75rem;">Found ${results.length} bearish setup(s) in ${symbolList.length} scanned - click row to analyze</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Position</th>
                                <th>VWAP Zone</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        // Pre-built stock universes
        const STOCK_UNIVERSES = {
            mag7: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA'],
            tech20: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'AMD', 'INTC', 'CRM', 
                     'ORCL', 'ADBE', 'NFLX', 'AVGO', 'CSCO', 'IBM', 'QCOM', 'TXN', 'NOW', 'SNOW'],
            sp50: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'BRK.B', 'UNH', 'JNJ',
                   'XOM', 'JPM', 'V', 'PG', 'MA', 'HD', 'CVX', 'MRK', 'ABBV', 'LLY',
                   'PFE', 'KO', 'PEP', 'COST', 'AVGO', 'TMO', 'MCD', 'WMT', 'CSCO', 'ABT',
                   'ACN', 'DHR', 'NEE', 'VZ', 'ADBE', 'TXN', 'CRM', 'NKE', 'BMY', 'CMCSA',
                   'UPS', 'PM', 'ORCL', 'RTX', 'HON', 'QCOM', 'T', 'IBM', 'LOW', 'SPGI'],
            etfs: ['SPY', 'QQQ', 'IWM', 'DIA', 'VTI', 'XLF', 'XLK', 'XLE', 'XLV', 'XLI',
                   'XLP', 'XLY', 'XLB', 'XLU', 'XLRE', 'GLD', 'SLV', 'TLT', 'HYG', 'SMH',
                   'ARKK', 'SOXX', 'XBI', 'KRE', 'EEM', 'VXX', 'SQQQ', 'TQQQ'],
            meme: ['GME', 'AMC', 'BBBY', 'BB', 'NOK', 'PLTR', 'SOFI', 'RIVN', 'LCID', 'NIO',
                   'HOOD', 'COIN', 'MARA', 'RIOT', 'DKNG', 'WISH', 'CLOV', 'SPCE', 'TLRY', 'SNDL']
        };
        
        function loadUniverse(universe, scannerType) {
            const symbols = STOCK_UNIVERSES[universe] || [];
            const inputId = scannerType === 'bullish' ? 'bullish-symbols' : 'bearish-symbols';
            document.getElementById(inputId).value = symbols.join(', ');
            showToast(`Loaded ${symbols.length} symbols from ${universe.toUpperCase()}`, 'info');
        }
        
        function quickAnalyzeSymbol(symbol) {
            // Switch to Scanner tab and run analysis
            document.getElementById('quick-symbol').value = symbol;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('scanner').classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelector('nav button').classList.add('active');
            quickAnalyze();
        }

        // =====================================================================
        // WORKFLOW
        // =====================================================================
        
        async function loadWorkflowStatus() {
            try {
                const data = await fetchJson(`${API_BASE}/api/workflow/status`);
                
                document.getElementById('wf-trades').textContent = `${data.trades || 0}/4`;
                document.getElementById('wf-pnl').textContent = `${data.total_r >= 0 ? '+' : ''}${data.total_r?.toFixed(1) || 0}R`;
                document.getElementById('wf-pnl').style.color = data.total_r >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                document.getElementById('wf-consec').textContent = data.consecutive_losses || 0;
                
                const stateDisplay = document.getElementById('mental-state-display');
                const state = data.mental_state || 'GREEN';
                stateDisplay.className = `mental-state-indicator ${state.toLowerCase()}`;
                stateDisplay.innerHTML = `
                    <span style="font-size: 2rem;">${state === 'GREEN' ? 'üü¢' : state === 'YELLOW' ? 'üü°' : 'üî¥'}</span>
                    <div>
                        <div class="mental-state-text">MENTAL STATE: ${state}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${data.mental_state_description || ''}</div>
                    </div>
                `;
            } catch (e) {
                console.error('Workflow status error:', e);
            }
        }
        
        function runMentalCheck() {
            alert('Mental state check - implement modal dialog');
        }
        
        async function runPreTradeCheck() {
            const card = document.getElementById('workflow-results-card');
            const container = document.getElementById('workflow-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Running gate checks...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/workflow/pre-trade-check?signal=LONG_SETUP&confidence=70`);
                
                const gateResults = (data.results || []).map(g => `
                    <div class="item-card">
                        <div class="details">
                            <div class="symbol">${g.passed ? '‚úÖ' : '‚ùå'} ${g.gate}</div>
                            <div class="meta">${g.message}</div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; margin-bottom: 1rem; border-radius: 10px; ${data.approved ? 'background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3);' : 'background: rgba(255, 59, 92, 0.1); border: 1px solid rgba(255, 59, 92, 0.3);'}">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${data.approved ? '‚úÖ' : '‚õî'}</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: ${data.approved ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${data.approved ? 'TRADE APPROVED' : 'TRADE BLOCKED'}
                        </div>
                        ${data.approved ? `<div style="color: var(--text-muted); margin-top: 0.25rem;">Position size: ${(data.position_size_multiplier * 100).toFixed(0)}%</div>` : ''}
                    </div>
                    ${gateResults}
                `;
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }

        // =====================================================================
        // WATCHLISTS
        // =====================================================================
        
        async function loadWatchlists() {
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists`);
                
                const pills = (data.watchlists || []).map(w => `
                    <div class="watchlist-pill ${w.name === selectedWatchlist ? 'active' : ''}" 
                         onclick="selectWatchlist('${w.name}')">
                        ${w.name} (${w.symbol_count})
                    </div>
                `).join('');
                
                document.getElementById('watchlist-pills').innerHTML = pills || '<span style="color: var(--text-muted);">No watchlists yet. Create one!</span>';
                
                // Show symbols for selected watchlist
                const selected = (data.watchlists || []).find(w => w.name === selectedWatchlist);
                if (selected) {
                    document.getElementById('watchlist-symbols').innerHTML = 
                        `<strong>Symbols:</strong> ${selected.symbols.join(', ') || '<em>Empty</em>'}`;
                    document.getElementById('add-to-watchlist-name').textContent = selectedWatchlist;
                } else {
                    document.getElementById('watchlist-symbols').innerHTML = '<em>Select a watchlist</em>';
                    document.getElementById('add-to-watchlist-name').textContent = '-';
                }
            } catch (e) {
                console.error('Watchlists error:', e);
                document.getElementById('watchlist-pills').innerHTML = '<span style="color: var(--accent-red);">Error loading watchlists</span>';
            }
        }
        
        function selectWatchlist(name) {
            selectedWatchlist = name;
            loadWatchlists();
        }
        
        async function createWatchlist() {
            const name = document.getElementById('new-watchlist-name').value.trim();
            if (!name) {
                alert('Please enter a watchlist name');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, symbols: [] })
                });
                
                document.getElementById('new-watchlist-name').value = '';
                selectedWatchlist = name;
                loadWatchlists();
                showToast(`Watchlist "${name}" created!`, 'success');
            } catch (e) {
                showToast('Error creating watchlist: ' + e.message, 'error');
            }
        }
        
        async function addSymbolToWatchlist() {
            if (!selectedWatchlist) {
                alert('Please select a watchlist first');
                return;
            }
            
            const input = document.getElementById('add-symbol-input').value.trim().toUpperCase();
            if (!input) {
                alert('Please enter symbol(s) to add');
                return;
            }
            
            // Support comma-separated symbols
            const symbols = input.split(',').map(s => s.trim()).filter(s => s);
            
            try {
                for (const symbol of symbols) {
                    await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}/symbols`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol })
                    });
                }
                
                document.getElementById('add-symbol-input').value = '';
                loadWatchlists();
                showToast(`Added ${symbols.join(', ')} to ${selectedWatchlist}`, 'success');
            } catch (e) {
                showToast('Error adding symbol: ' + e.message, 'error');
            }
        }
        
        async function addToWatchlistQuick(symbol) {
            if (!selectedWatchlist) {
                showToast('Select a watchlist first', 'error');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}/symbols`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                
                loadWatchlists();
                showToast(`Added ${symbol} to ${selectedWatchlist}`, 'success');
            } catch (e) {
                showToast('Error adding symbol: ' + e.message, 'error');
            }
        }
        
        async function removeSymbolFromWatchlist() {
            if (!selectedWatchlist) {
                alert('Please select a watchlist first');
                return;
            }
            
            const symbol = document.getElementById('remove-symbol-input').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a symbol to remove');
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}/symbols/${symbol}`, {
                    method: 'DELETE'
                });
                
                document.getElementById('remove-symbol-input').value = '';
                loadWatchlists();
                showToast(`Removed ${symbol} from ${selectedWatchlist}`, 'success');
            } catch (e) {
                showToast('Error removing symbol: ' + e.message, 'error');
            }
        }
        
        async function deleteWatchlist() {
            if (!selectedWatchlist) {
                alert('Please select a watchlist first');
                return;
            }
            
            if (!confirm(`Delete watchlist "${selectedWatchlist}"? This cannot be undone.`)) {
                return;
            }
            
            try {
                await fetch(`${API_BASE}/api/watchlists/${selectedWatchlist}`, {
                    method: 'DELETE'
                });
                
                showToast(`Watchlist "${selectedWatchlist}" deleted`, 'success');
                selectedWatchlist = 'default';
                loadWatchlists();
            } catch (e) {
                showToast('Error deleting watchlist: ' + e.message, 'error');
            }
        }
        
        async function scanWatchlist() {
            const tf = document.getElementById('scan-tf').value;
            const card = document.getElementById('scan-results-card');
            const container = document.getElementById('scan-results-container');
            
            card.classList.remove('hidden');
            container.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div>Scanning watchlist...</div>';
            
            try {
                const data = await fetchJson(`${API_BASE}/api/watchlists/${selectedWatchlist}/scan?timeframe=${tf}`);
                
                // Store results for filtering
                window.scanResults = data.results || [];
                window.currentSignalFilter = 'all';
                
                // Reset filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                document.getElementById('min-confidence-filter').value = '0';
                
                renderScanResults();
            } catch (e) {
                container.innerHTML = `<div style="color: var(--accent-red); padding: 1rem;">Error: ${e.message}</div>`;
            }
        }
        
        function filterScanResults(signalFilter) {
            // Update signal filter if provided
            if (signalFilter) {
                window.currentSignalFilter = signalFilter;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === signalFilter);
                });
            }
            renderScanResults();
        }
        
        function renderScanResults() {
            const container = document.getElementById('scan-results-container');
            const results = window.scanResults || [];
            const signalFilter = window.currentSignalFilter || 'all';
            const minConfidence = parseInt(document.getElementById('min-confidence-filter').value) || 0;
            
            // Apply filters
            const filtered = results.filter(r => {
                // Signal filter
                if (signalFilter !== 'all') {
                    const signalType = r.signal?.includes('LONG') ? 'GREEN' : 
                                      r.signal?.includes('SHORT') ? 'RED' : 'YELLOW';
                    if (signalType !== signalFilter) return false;
                }
                // Confidence filter
                if ((r.confidence || 0) < minConfidence) return false;
                return true;
            });
            
            // Update count
            document.getElementById('scan-filter-count').textContent = `${filtered.length} of ${results.length} shown`;
            
            if (filtered.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No results match filters</div>';
                return;
            }
            
            const rows = filtered.map(r => `
                <tr class="scan-result-row" data-symbol="${r.symbol}" onclick="selectScanResult(this, '${r.symbol}')">
                    <td><input type="checkbox" class="scan-checkbox" data-symbol="${r.symbol}" onclick="event.stopPropagation(); updateSelectedCount()"></td>
                    <td class="symbol-cell">${r.symbol}</td>
                    <td>
                        ${getSignalWithLean(r.signal, r.bull_score, r.bear_score)}
                    </td>
                    <td class="number-cell">${r.confidence?.toFixed(0) || 0}%</td>
                    <td>${r.position || '-'}</td>
                    <td style="display: flex; gap: 0.25rem;">
                        <button class="btn btn-sm" onclick="event.stopPropagation(); runAIOnSymbol('${r.symbol}')" title="AI Analysis" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                            ü§ñ
                        </button>
                        <button class="btn btn-sm" onclick="event.stopPropagation(); addToWatchlistQuick('${r.symbol}')" title="Add to Watchlist" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                            ‚ûï
                        </button>
                    </td>
                </tr>
            `).join('');
            
            container.innerHTML = `
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center;">
                    <button class="btn btn-sm" onclick="selectAllScanResults()" style="font-size: 0.7rem;">Select All</button>
                    <button class="btn btn-sm" onclick="deselectAllScanResults()" style="font-size: 0.7rem;">Clear</button>
                    <button class="btn btn-primary btn-sm" onclick="runAIOnSelected()" style="font-size: 0.7rem;">
                        ü§ñ AI Analyze Selected (<span id="selected-count">0</span>)
                    </button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Symbol</th>
                            <th>Signal</th>
                            <th>Confidence</th>
                            <th>Position</th>
                            <th style="width: 70px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
            updateSelectedCount();
        }
        
        function selectScanResult(row, symbol) {
            const checkbox = row.querySelector('.scan-checkbox');
            checkbox.checked = !checkbox.checked;
            updateSelectedCount();
        }
        
        function selectAllScanResults() {
            document.querySelectorAll('.scan-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        function deselectAllScanResults() {
            document.querySelectorAll('.scan-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = document.querySelectorAll('.scan-checkbox:checked').length;
            const countEl = document.getElementById('selected-count');
            if (countEl) countEl.textContent = count;
        }
        
        async function runAIOnSymbol(symbol) {
            // Switch to Analyze tab and run AI
            showSection('analyze');
            document.getElementById('quick-symbol').value = symbol;
            
            // Run MTF analysis with AI
            showToast(`Running AI analysis on ${symbol}...`, 'info');
            await analyzeSymbol();
        }
        
        async function runAIOnSelected() {
            const checked = document.querySelectorAll('.scan-checkbox:checked');
            if (checked.length === 0) {
                showToast('Select at least one symbol', 'error');
                return;
            }
            
            const symbols = Array.from(checked).map(cb => cb.dataset.symbol);
            
            if (symbols.length === 1) {
                // Single symbol - just run normal analysis
                await runAIOnSymbol(symbols[0]);
                return;
            }
            
            // Multiple symbols - show batch results modal
            await runBatchAIAnalysis(symbols);
        }
        
        async function runBatchAIAnalysis(symbols) {
            // Create modal for batch results
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'batch-ai-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
                    <div class="modal-header">
                        <div class="modal-title">ü§ñ Batch AI Analysis (${symbols.length} symbols)</div>
                        <button class="modal-close" onclick="closeBatchModal()">&times;</button>
                    </div>
                    <div id="batch-ai-results" style="padding: 1rem;">
                        <div class="loading-overlay"><div class="loading-spinner"></div>Analyzing ${symbols.join(', ')}...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const resultsContainer = document.getElementById('batch-ai-results');
            let resultsHtml = '';
            
            // Analyze each symbol sequentially
            for (let i = 0; i < symbols.length; i++) {
                const symbol = symbols[i];
                resultsContainer.innerHTML = `<div class="loading-overlay"><div class="loading-spinner"></div>Analyzing ${symbol} (${i + 1}/${symbols.length})...</div>` + resultsHtml;
                
                try {
                    const tf = document.getElementById('scan-tf').value || '1HR';
                    const data = await fetchJson(`${API_BASE}/api/mtf_auction/${symbol}?timeframe=${tf}`);
                    
                    const signalColor = data.signal?.includes('LONG') ? 'var(--accent-green)' : 
                                       data.signal?.includes('SHORT') ? 'var(--accent-red)' : 'var(--accent-yellow)';
                    
                    resultsHtml = `
                        <div class="card" style="margin-bottom: 1rem; background: var(--bg-primary);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <div style="font-size: 1.1rem; font-weight: 600;">${symbol}</div>
                                <div style="padding: 0.3rem 0.75rem; background: ${signalColor}20; border: 1px solid ${signalColor}; border-radius: 6px; color: ${signalColor}; font-size: 0.8rem;">
                                    ${data.signal || 'WAIT'}
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; font-size: 0.75rem; margin-bottom: 0.75rem;">
                                <div><span style="color: var(--text-muted);">Entry:</span> $${data.entry?.toFixed(2) || '-'}</div>
                                <div><span style="color: var(--text-muted);">Stop:</span> $${data.stop?.toFixed(2) || '-'}</div>
                                <div><span style="color: var(--text-muted);">T1:</span> $${data.target1?.toFixed(2) || '-'}</div>
                                <div><span style="color: var(--text-muted);">Conf:</span> ${data.confidence?.toFixed(0) || 0}%</div>
                            </div>
                            ${data.ai_commentary ? `
                                <div style="font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px; border-left: 3px solid var(--accent-cyan);">
                                    ${data.ai_commentary.substring(0, 300)}${data.ai_commentary.length > 300 ? '...' : ''}
                                </div>
                            ` : ''}
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm" onclick="closeBatchModal(); runAIOnSymbol('${symbol}')" style="font-size: 0.7rem;">View Full Analysis</button>
                                <button class="btn btn-sm" onclick="quickLogTrade('${symbol}', '${data.signal}', ${data.entry || 0}, ${data.stop || 0})" style="font-size: 0.7rem;">üìù Log Trade</button>
                            </div>
                        </div>
                    ` + resultsHtml;
                    
                } catch (e) {
                    resultsHtml = `
                        <div class="card" style="margin-bottom: 1rem; background: var(--bg-primary); border-color: var(--accent-red);">
                            <div style="font-size: 1.1rem; font-weight: 600;">${symbol}</div>
                            <div style="color: var(--accent-red); font-size: 0.8rem;">Error: ${e.message}</div>
                        </div>
                    ` + resultsHtml;
                }
            }
            
            resultsContainer.innerHTML = resultsHtml;
        }
        
        function closeBatchModal() {
            document.getElementById('batch-ai-modal')?.remove();
        }
        
        function quickLogTrade(symbol, signal, entry, stop) {
            // Quick log a trade from batch results
            showSection('journal');
            document.getElementById('trade-symbol').value = symbol;
            document.getElementById('trade-direction').value = signal?.includes('LONG') ? 'LONG' : 'SHORT';
            document.getElementById('trade-entry').value = entry?.toFixed(2) || '';
            document.getElementById('trade-stop').value = stop?.toFixed(2) || '';
            closeBatchModal();
            showToast(`Trade form filled for ${symbol}`, 'success');
        }

        // =====================================================================
        // ALERTS - Using Firestore for authenticated users
        // =====================================================================
        
        async function loadAlerts() {
            try {
                let alerts = [];
                
                // Use Firestore if user is logged in
                if (currentUser && db) {
                    const snapshot = await db.collection('users').doc(currentUser.uid).collection('alerts').get();
                    snapshot.forEach(doc => {
                        alerts.push({ id: doc.id, ...doc.data() });
                    });
                } else {
                    // Fallback to API
                    const data = await fetchJson(`${API_BASE}/api/alerts`);
                    alerts = data.alerts || [];
                }
                
                if (alerts.length === 0) {
                    document.getElementById('alerts-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîî</div>
                            <div class="empty-state-text">No active alerts</div>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table" style="font-size: 0.75rem;">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">SYMBOL</th>
                                    <th style="width: 50px;">DIR</th>
                                    <th style="width: 80px;">LEVEL</th>
                                    <th style="width: 80px;">ACTION</th>
                                    <th>NOTE</th>
                                    <th style="width: 40px;"></th>
                                    <th style="width: 40px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                alerts.forEach(a => {
                    const dirColor = (a.direction || '').toLowerCase() === 'above' ? 'var(--accent-green)' : 'var(--accent-red)';
                    const dirIcon = (a.direction || '').toLowerCase() === 'above' ? '‚Üë' : '‚Üì';
                    const alertId = a.id || `${a.symbol}_${a.level}`;
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                            <td style="font-weight: 600; color: var(--accent-cyan);">${a.symbol}</td>
                            <td style="color: ${dirColor};">${dirIcon} ${(a.direction || '').toUpperCase().slice(0,3)}</td>
                            <td style="font-family: 'JetBrains Mono'; color: var(--text-primary);">${fmtMoney(a.level)}</td>
                            <td style="font-size: 0.7rem; color: var(--text-secondary);">${a.action || '-'}</td>
                            <td style="font-size: 0.7rem; color: var(--text-muted); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${a.note || ''}">${a.note || '-'}</td>
                            <td>
                                <button style="background: var(--bg-tertiary); border: 1px solid var(--accent-cyan); color: var(--accent-cyan); width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;" onclick="shareAlert('${a.symbol}', ${a.level}, '${a.direction}', '${a.action}', '${(a.note || '').replace(/'/g, "\\'")}')">üì§</button>
                            </td>
                            <td>
                                <button style="background: var(--accent-red); border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;" onclick="deleteAlert('${alertId}')">‚úï</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>
                    <div style="padding: 0.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem; border-top: 1px solid var(--border-subtle);">
                        ${alerts.length} active alert${alerts.length !== 1 ? 's' : ''} ${currentUser ? '(synced)' : '(local)'}
                    </div>
                `;
                
                document.getElementById('alerts-list').innerHTML = html;
            } catch (e) {
                console.error('Alerts error:', e);
            }
        }
        
        async function createAlert() {
            const data = {
                symbol: document.getElementById('alert-symbol').value.toUpperCase(),
                level: parseFloat(document.getElementById('alert-level').value),
                direction: document.getElementById('alert-direction').value,
                action: document.getElementById('alert-action').value,
                note: document.getElementById('alert-note').value,
                created_at: new Date().toISOString(),
                triggered: false
            };
            
            if (!data.symbol || !data.level) return alert('Fill in required fields');
            
            try {
                // Use Firestore if logged in
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('alerts').add(data);
                } else {
                    // Fallback to API
                    await fetch(`${API_BASE}/api/alerts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                document.getElementById('alert-symbol').value = '';
                document.getElementById('alert-level').value = '';
                document.getElementById('alert-note').value = '';
                
                loadAlerts();
            } catch (e) {
                console.error('Create alert error:', e);
                alert('Error creating alert');
            }
        }
        
        async function deleteAlert(alertId) {
            try {
                // Use Firestore if logged in
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('alerts').doc(alertId).delete();
                } else {
                    // Fallback - alertId might be "symbol_level" format
                    const [symbol, level] = alertId.split('_');
                    await fetch(`${API_BASE}/api/alerts?symbol=${symbol}&level=${level}`, { method: 'DELETE' });
                }
                loadAlerts();
            } catch (e) {
                console.error('Delete alert error:', e);
                alert('Error deleting alert');
            }
        }

        // =====================================================================
        // TRADES - Using Firestore for authenticated users
        // =====================================================================
        
        async function loadTrades() {
            try {
                let stats = { total: 0, wins: 0, losses: 0, win_rate: 0 };
                let trades = [];
                
                console.log('loadTrades - currentUser:', currentUser?.uid, 'db:', !!db);
                
                // Use Firestore if logged in
                if (currentUser && db) {
                    try {
                        // Simple query without orderBy to avoid index requirement
                        const snapshot = await db.collection('users').doc(currentUser.uid)
                            .collection('trades')
                            .get();
                        
                        snapshot.forEach(doc => {
                            trades.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Sort in JavaScript instead
                        trades.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                        
                        console.log('Loaded trades from Firestore:', trades.length, trades);
                    } catch (fsError) {
                        console.error('Firestore trades error:', fsError);
                    }
                    
                    // Calculate stats from trades
                    const closed = trades.filter(t => t.status === 'closed');
                    const wins = closed.filter(t => t.pnl > 0);
                    const losses = closed.filter(t => t.pnl < 0);
                    stats = {
                        total: closed.length,
                        wins: wins.length,
                        losses: losses.length,
                        win_rate: closed.length > 0 ? (wins.length / closed.length * 100) : 0
                    };
                } else {
                    // Fallback to API
                    const statsData = await fetchJson(`${API_BASE}/api/trades/stats`);
                    stats = statsData;
                    const tradesData = await fetchJson(`${API_BASE}/api/trades?status=pending`);
                    trades = tradesData.trades || [];
                }
                
                document.getElementById('ts-total').textContent = stats.total || stats.total_trades || 0;
                document.getElementById('ts-wins').textContent = stats.wins || 0;
                document.getElementById('ts-losses').textContent = stats.losses || 0;
                document.getElementById('ts-winrate').textContent = fmtPercent(stats.win_rate || 0, 0);
                
                // Filter to pending trades for display
                const pendingTrades = trades.filter(t => t.status === 'pending' || !t.status);
                
                if (pendingTrades.length === 0) {
                    document.getElementById('trades-list').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">No pending trades</div>
                        </div>
                    `;
                    return;
                }
                
                const html = pendingTrades.map(t => `
                    <div class="item-card">
                        <div class="details">
                            <div class="symbol">${t.symbol} ${t.direction}</div>
                            <div class="meta">
                                Entry: ${fmtMoney(t.entry || t.entry_price)} ‚Ä¢ Stop: ${fmtMoney(t.stop || t.stop_loss)} ‚Ä¢ Target: ${fmtMoney(t.target || t.target_1)}
                            </div>
                        </div>
                        <div class="actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="closeTrade('${t.id}', 'win')" title="Mark as Win">‚úì</button>
                            <button class="btn btn-danger btn-sm" onclick="closeTrade('${t.id}', 'loss')" title="Mark as Loss">‚úï</button>
                            <button class="btn btn-sm" style="background: var(--text-muted); color: white;" onclick="cancelTrade('${t.id}')" title="Cancel/Remove">üö´</button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('trades-list').innerHTML = html;
            } catch (e) {
                console.error('Trades error:', e);
            }
        }
        
        async function logTrade() {
            const data = {
                symbol: document.getElementById('trade-symbol').value.toUpperCase(),
                timeframe: '1HR',
                direction: document.getElementById('trade-direction').value,
                entry: parseFloat(document.getElementById('trade-entry').value),
                stop: parseFloat(document.getElementById('trade-stop').value),
                target: parseFloat(document.getElementById('trade-target').value),
                notes: document.getElementById('trade-notes').value,
                status: 'pending',
                pnl: 0,
                created_at: new Date().toISOString()
            };
            
            if (!data.symbol || !data.entry) return alert('Fill in required fields');
            
            try {
                // Use Firestore if logged in
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('trades').add(data);
                } else {
                    // Fallback to API
                    await fetch(`${API_BASE}/api/trades`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                
                document.getElementById('trade-symbol').value = '';
                document.getElementById('trade-entry').value = '';
                document.getElementById('trade-stop').value = '';
                document.getElementById('trade-target').value = '';
                document.getElementById('trade-notes').value = '';
                
                loadTrades();
            } catch (e) {
                alert('Error logging trade');
            }
        }
        
        async function cancelTrade(tradeId) {
            if (!confirm('Cancel this trade? It will be removed from your journal.')) return;
            
            try {
                if (currentUser && db) {
                    await db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).delete();
                    console.log('Trade cancelled:', tradeId);
                } else {
                    // API fallback would go here
                    console.log('Not logged in - cannot cancel');
                }
                loadTrades();
            } catch (e) {
                console.error('Cancel trade error:', e);
                alert('Error cancelling trade');
            }
        }
        
        async function closeTrade(tradeId, result) {
            try {
                if (currentUser && db) {
                    // Get the trade to calculate PnL
                    const tradeDoc = await db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).get();
                    const trade = tradeDoc.data();
                    
                    // Simple PnL calculation based on result
                    const pnl = result === 'win' ? Math.abs(trade.target - trade.entry) : -Math.abs(trade.entry - trade.stop);
                    
                    await db.collection('users').doc(currentUser.uid).collection('trades').doc(tradeId).update({
                        status: 'closed',
                        pnl: pnl,
                        result: result,
                        closed_at: new Date().toISOString()
                    });
                } else {
                    await fetch(`${API_BASE}/api/trades`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbol: tradeId, status: 'closed' })
                    });
                }
                loadTrades();
            } catch (e) {
                console.error('Close trade error:', e);
                alert('Error closing trade');
            }
        }
        
        async function updateTrade(symbol, status) {
            try {
                await fetch(`${API_BASE}/api/trades`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, status })
                });
                loadTrades();
            } catch (e) {
                alert('Error updating trade');
            }
        }

        // =====================================================================
        // SETTINGS
        // =====================================================================
        
        async function setFinnhubKey() {
            const key = document.getElementById('finnhub-key').value.trim();
            if (!key) return;
            
            try {
                await fetch(`${API_BASE}/api/set-key?key=${encodeURIComponent(key)}`, { method: 'POST' });
                alert('Finnhub key set successfully');
                checkStatus();
            } catch (e) {
                alert('Error setting key');
            }
        }
        
        async function setOpenAIKey() {
            const key = document.getElementById('openai-key').value.trim();
            if (!key) return;
            
            try {
                await fetch(`${API_BASE}/api/set-openai-key?api_key=${encodeURIComponent(key)}`, { method: 'POST' });
                alert('OpenAI key set successfully');
                checkStatus();
            } catch (e) {
                alert('Error setting key');
            }
        }

        // =====================================================================
        // SOCIAL TRADING - Share Trades with Other Users
        // =====================================================================
        
        async function shareTrade() {
            if (!currentUser) {
                alert('Please sign in to share trades');
                return;
            }
            
            const plan = window.lastAIPlan;
            if (!plan || !plan.parsed) {
                alert('No trade plan to share');
                return;
            }
            
            const sharedTrade = {
                symbol: plan.symbol || document.getElementById('quick-symbol')?.value || 'UNKNOWN',
                bias: plan.parsed.bias,
                entry: plan.parsed.entry,
                stop: plan.parsed.stop,
                target1: plan.parsed.target1 || 0,
                target2: plan.parsed.target2 || 0,
                timeframe: plan.trade_timeframe || 'swing',
                commentary: plan.ai_commentary?.substring(0, 500) || '',
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours
            };
            
            try {
                await db.collection('shared_trades').add(sharedTrade);
                showToast(`Trade shared with community! ${sharedTrade.symbol} ${sharedTrade.bias}`, 'success');
            } catch (e) {
                console.error('Share error:', e);
                showToast('Error sharing trade: ' + e.message, 'error');
            }
        }
        
        async function shareAlert(symbol, level, direction, action, note) {
            if (!currentUser) {
                alert('Please sign in to share trades');
                return;
            }
            
            // Determine bias from action
            let bias = 'LONG';
            if (action === 'SHORT') bias = 'SHORT';
            else if (action === 'LONG') bias = 'LONG';
            else if (action === 'EXIT') bias = 'EXIT';
            else bias = 'ALERT';
            
            const sharedTrade = {
                symbol: symbol,
                bias: bias,
                entry: level,
                stop: 0,
                target1: 0,
                target2: 0,
                timeframe: 'alert',
                commentary: `${direction === 'above' ? '‚¨ÜÔ∏è Above' : '‚¨áÔ∏è Below'} $${level.toFixed(2)} - ${action}${note ? ': ' + note : ''}`,
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Trader',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours
            };
            
            try {
                await db.collection('shared_trades').add(sharedTrade);
                showToast(`Alert shared! ${symbol} ${bias} @ $${level.toFixed(2)}`, 'success');
            } catch (e) {
                console.error('Share error:', e);
                showToast('Error sharing: ' + e.message, 'error');
            }
        }
        
        async function loadSharedTrades() {
            if (!currentUser || !db) return [];
            
            try {
                const snapshot = await db.collection('shared_trades')
                    .where('expiresAt', '>', new Date())
                    .orderBy('expiresAt', 'desc')
                    .limit(20)
                    .get();
                
                const trades = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Don't show user's own trades
                    if (data.authorId !== currentUser.uid) {
                        trades.push({ id: doc.id, ...data });
                    }
                });
                
                return trades;
            } catch (e) {
                console.error('Load shared trades error:', e);
                return [];
            }
        }
        
        async function updateSharedTradesBadge() {
            if (!currentUser) return;
            
            const trades = await loadSharedTrades();
            const badge = document.getElementById('shared-trades-count');
            
            if (trades.length > 0) {
                badge.textContent = trades.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        async function showSharedTrades() {
            if (!currentUser) {
                alert('Please sign in to view shared trades');
                return;
            }
            
            const trades = await loadSharedTrades();
            
            const tradeRows = trades.length === 0 
                ? '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">No shared trades available right now</div>'
                : trades.map(t => `
                    <div class="shared-trade-card" style="background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">${t.symbol}</span>
                                <span class="signal ${t.bias === 'LONG' ? 'signal-long' : 'signal-short'}" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;">
                                    ${t.bias === 'LONG' ? 'üü¢ LONG' : 'üî¥ SHORT'}
                                </span>
                            </div>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">by ${t.authorName}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; font-size: 0.8rem;">
                            <div><span style="color: var(--text-muted);">Entry:</span> <span style="color: var(--accent-cyan);">$${t.entry?.toFixed(2) || 'N/A'}</span></div>
                            <div><span style="color: var(--text-muted);">Stop:</span> <span style="color: var(--accent-red);">$${t.stop?.toFixed(2) || 'N/A'}</span></div>
                            <div><span style="color: var(--text-muted);">Target:</span> <span style="color: var(--accent-green);">$${t.target1?.toFixed(2) || 'N/A'}</span></div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" style="background: var(--accent-green); color: var(--bg-primary); font-size: 0.75rem; padding: 0.4rem 0.75rem;" onclick="addSharedTrade('${t.id}', '${t.symbol}', '${t.bias}', ${t.entry}, ${t.stop}, ${t.target1})">
                                ‚ûï Add to My Trades
                            </button>
                            <button class="btn btn-sm" style="background: var(--bg-tertiary); color: var(--text-secondary); font-size: 0.75rem; padding: 0.4rem 0.75rem;" onclick="quickAnalyzeSymbol('${t.symbol}')">
                                üìä Analyze
                            </button>
                        </div>
                    </div>
                `).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'shared-trades-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üîî Shared Trade Ideas</h3>
                        <button class="modal-close" onclick="closeModal('shared-trades-modal')">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">Trade ideas shared by other users in the last 24 hours</div>
                        ${tradeRows}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal('shared-trades-modal');
            });
        }
        
        async function addSharedTrade(tradeId, symbol, bias, entry, stop, target) {
            if (!currentUser || !db) return;
            
            const trade = {
                symbol,
                direction: bias,
                entry,
                stop,
                target,
                status: 'pending',
                source: 'shared',
                createdAt: new Date().toISOString()
            };
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('trades').add(trade);
                showToast(`Added ${symbol} ${bias} to your trades!`, 'success');
                closeModal('shared-trades-modal');
                updateSharedTradesBadge();
            } catch (e) {
                showToast('Error adding trade: ' + e.message, 'error');
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        // =====================================================================
        // INIT
        // =====================================================================
        
        checkStatus();
        setInterval(checkStatus, 30000);
        
        // Check for shared trades every 2 minutes
        setInterval(updateSharedTradesBadge, 120000);
    </script>
</body>
</html>
